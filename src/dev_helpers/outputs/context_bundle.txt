================================================================
PROJECT CONTEXT BUNDLE: D&D CAMPAIGN MANAGER
================================================================
INSTRUCTIONS FOR AI:
- This is the entire source code for a React/Vite app.
- Maintain architectural consistency at all costs.
- Reuse existing hooks, UI components, and Supabase patterns.
- Do not suggest new libraries or 'from-scratch' rewrites.
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageLibrary.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: main.jsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import { HashRouter } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import App from '@/app/App';
import '@/app/styles/global.css';
import 'leaflet/dist/leaflet.css';

const validateEnv = () => {
	const required = ['VITE_SUPABASE_URL', 'VITE_SUPABASE_ANON_KEY'];
	const missing = required.filter((key) => !import.meta.env[key]);
	if (missing.length > 0) {
		console.error('Missing required environment variables:', missing);
	}
};
validateEnv();

// CHANGED: Aggressive Caching Configuration
const queryClient = new QueryClient({
	defaultOptions: {
		queries: {
			// Data is considered fresh for 1 hour
			staleTime: 1000 * 60 * 60,
			// Keep unused data in memory for 24 hours
			cacheTime: 1000 * 60 * 60 * 24,
			refetchOnWindowFocus: false,
			refetchOnMount: false, // Don't refetch just because component remounted
			retry: 1,
		},
	},
});

ReactDOM.createRoot(document.getElementById('root')).render(
	<React.StrictMode>
		<QueryClientProvider client={queryClient}>
			<HashRouter>
				<App />
			</HashRouter>
		</QueryClientProvider>
	</React.StrictMode>
);

--- END OF main.jsx ---

--- FILE: todo.md ---
### 2025-01-04

- [x] Convert the mentions tab from the sessions to use the same badges as the connections from entities
- [x] Convert the character page to be more D&D reminiscent
- [x] Update the dashboard landing page to have a cards of the party
- [x] Integrate the story arcs into the timeline
- [ ] Create icon for the story arcs
- [ ] Update the campaign cards to use player portraits + background
- [ ] Fix issue where the theme is light if it has been set to dark on the campaign page when first accessing

--- END OF todo.md ---

--- FILE: app\App.jsx ---
import { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { TooltipProvider } from '@/features/smart-tooltip/TooltipContext';
import { CampaignProvider, useCampaign } from '@/features/campaign/CampaignContext';
import ErrorBoundary from '@/shared/components/ErrorBoundary';
import { AppRoutes } from './AppRoutes';

function AppContent() {
	const { campaignId } = useCampaign();
	const queryClient = useQueryClient();

	// 1. Set global texture
	useEffect(() => {
		const texturePath = `${import.meta.env.BASE_URL}images/background_texture.webp`;
		document.documentElement.style.setProperty('--bg-texture', `url('${texturePath}')`);
	}, []);

	// 2. Set Default App Title
	useEffect(() => {
		document.title = 'D&D Campaign Manager';
	}, []);

	// 3. Clear cache when campaign changes
	useEffect(() => {
		if (campaignId) {
			queryClient.invalidateQueries({
				predicate: (query) => {
					const key = query.queryKey[0];
					return ['entities', 'entry', 'timeline', 'graph', 'entityIndex', 'globalSearch'].includes(key);
				},
			});
		}
	}, [campaignId, queryClient]);

	return (
		<TooltipProvider>
			<AppRoutes />
		</TooltipProvider>
	);
}

export default function App() {
	return (
		<ErrorBoundary>
			<CampaignProvider>
				<AppContent />
			</CampaignProvider>
		</ErrorBoundary>
	);
}

--- END OF app\App.jsx ---

--- FILE: app\AppRoutes.jsx ---
import { Routes, Route, Navigate } from 'react-router-dom';
import { Suspense, lazy } from 'react';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { RouteLoading } from './components/RouteLoading';

const CampaignSelect = lazy(() => import('@/features/campaign/components/CampaignSelect'));
const MainLayout = lazy(() => import('@/features/navigation/MainLayout'));
const DashboardPage = lazy(() => import('@/features/dashboard/DashboardPage'));
const MapPage = lazy(() => import('@/features/atlas/MapPage'));
const TimelinePage = lazy(() => import('@/features/timeline/TimelinePage'));
const GraphPage = lazy(() => import('@/features/graph/GraphPage'));
const WikiLayout = lazy(() => import('@/features/wiki/WikiLayout'));
const WikiDetailPage = lazy(() => import('@/features/wiki/pages/WikiDetailPage'));
const WikiLandingPage = lazy(() => import('@/features/wiki/pages/WikiLandingPage'));

// Admin Features
const AdminLayout = lazy(() => import('@/features/admin/layouts/AdminLayout'));
const SplitPaneManager = lazy(() => import('@/features/admin/pages/SplitPaneManager'));
const BulkReplaceTool = lazy(() => import('@/features/admin/pages/BulkReplaceTool'));

export const AppRoutes = () => {
	const { campaignId } = useCampaign();
	const isDev = import.meta.env.DEV;

	return (
		<Suspense fallback={<RouteLoading text='Loading Application...' />}>
			<Routes>
				{/* Admin Console */}
				{isDev && (
					<Route path='/dm' element={<AdminLayout />}>
						<Route index element={<Navigate to='/dm/manage/campaign' replace />} />
						<Route path='manage/:type/:id?' element={<SplitPaneManager />} />
						<Route path='tools/replace' element={<BulkReplaceTool />} />
					</Route>
				)}

				{/* Campaign Selection */}
				<Route path='/select-campaign' element={<CampaignSelect />} />

				{/* Main App */}
				{campaignId ? (
					<Route path='/' element={<MainLayout />}>
						<Route index element={<DashboardPage />} />

						<Route path='atlas/:mapId' element={<MapPage />} />
						<Route path='atlas' element={<Navigate to='/atlas/world_map' replace />} />
						<Route path='timeline' element={<TimelinePage />} />
						<Route path='relationships' element={<GraphPage />} />

						<Route path='wiki/:type' element={<WikiLayout />}>
							<Route index element={<WikiLandingPage />} />
							<Route path=':entityId' element={<WikiDetailPage />} />
						</Route>

						<Route path='*' element={<Navigate to='/' replace />} />
					</Route>
				) : (
					<Route path='*' element={<Navigate to='/select-campaign' replace />} />
				)}
			</Routes>
		</Suspense>
	);
};

--- END OF app\AppRoutes.jsx ---

--- FILE: app\components\RouteLoading.jsx ---
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export const RouteLoading = ({ text }) => (
	<div className='flex items-center justify-center h-full min-h-screen bg-muted'>
		<LoadingSpinner size='lg' text={text} />
	</div>
);

--- END OF app\components\RouteLoading.jsx ---

--- FILE: app\styles\global.css ---
@import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&family=Spectral:wght@400;500;600;700&display=swap');
@import 'tailwindcss';
@plugin "@tailwindcss/typography";

@theme {
	--font-sans: 'Inter', sans-serif;
	--font-serif: 'Inter', serif;
	--font-display: 'Crimson Text', serif;

	/* Semantic Color Mapping */
	--color-background: var(--background);
	--color-foreground: var(--foreground);
	--color-card: var(--card);
	--color-card-foreground: var(--card-foreground);
	--color-popover: var(--popover);
	--color-popover-foreground: var(--popover-foreground);
	--color-primary: var(--primary);
	--color-primary-foreground: var(--primary-foreground);
	--color-secondary: var(--secondary);
	--color-secondary-foreground: var(--secondary-foreground);
	--color-muted: var(--muted);
	--color-muted-foreground: var(--muted-foreground);
	--color-accent: var(--accent);
	--color-accent-foreground: var(--accent-foreground);
	--color-destructive: var(--destructive);
	--color-destructive-foreground: var(--destructive-foreground);
	--color-border: var(--border);
	--color-input: var(--input);
	--color-ring: var(--ring);
}

@layer base {
	* {
		@apply border-border;
	}
	html,
	body,
	#root {
		height: 100%;
		height: 100dvh;
		overflow: hidden;
		overscroll-behavior: none;
		-webkit-tap-highlight-color: transparent;
	}
	body {
		@apply bg-background text-foreground antialiased font-sans;
	}
	/* Heading Defaults */
	h1,
	h2,
	h3,
	h4,
	h5,
	h6 {
		@apply font-serif font-bold text-foreground;
	}
}

/* --- THEME DEFINITIONS --- */

/* LIGHT MODE */
:root {
	--background: #ffffff;
	--foreground: #09090b;
	--card: #ffffff;
	--card-foreground: #09090b;
	--popover: #ffffff;
	--popover-foreground: #09090b;
	--primary: #d97706;
	--primary-foreground: #ffffff;
	--secondary: #f4f4f5;
	--secondary-foreground: #18181b;
	--muted: #f4f4f5;
	--muted-foreground: #71717a;
	--accent: #f4f4f5;
	--accent-foreground: #18181b;
	--destructive: #ef4444;
	--destructive-foreground: #fafafa;
	--border: #e4e4e7;
	--input: #e4e4e7;
	--ring: #d97706;
	--radius: 0.5rem;
}

/* DARK MODE (Zinc) */
[data-theme='dark'] {
	--background: rgb(17 17 17);
	--foreground: #eee;
	--card: #18181b;
	--card-foreground: #fafafa;
	--popover: #18181b;
	--popover-foreground: #fafafa;
	--primary: #f59e0b;
	--primary-foreground: #09090b;
	--secondary: #27272a;
	--secondary-foreground: #fafafa;
	--muted: #1c1c1f;
	--muted-foreground: #a1a1aa;
	--accent: #27272a;
	--accent-foreground: #fafafa;
	--destructive: #ef4444;
	--destructive-foreground: #fafafa;
	--border: #27272a;
	--input: #27272a;
	--ring: #f59e0b;
}

/* D&D MODE (Parchment) */
[data-theme='dnd'] {
	--background: #fdfbf7;
	--foreground: #2c1a11;
	--card: #fdfbf7;
	--card-foreground: #1b1b1b;
	--popover: #fdfbf7;
	--popover-foreground: #1b1b1b;
	--primary: #d97706; /* Amber-600 */
	--primary-foreground: #ffffff;
	--secondary: #f2efe9;
	--secondary-foreground: #1b1b1b;
	--muted: #f2efe9;
	--muted-foreground: #5f5a52;
	--accent: #f2efe9;
	--accent-foreground: #1b1b1b;
	--destructive: #991b1b;
	--destructive-foreground: #ffffff;
	--border: #cecece;
	--input: #c9c2b8;
	--ring: #8b1e1e;

	--entity-session: #5f5a52;
	--entity-character: #c10007; /* Deep blood red */
	--entity-npc: #bb4d00; /* Burnt Sienna */
	--entity-location: #007a55; /* Deep Forest/Moss green */
	--entity-quest: #1447e6; /* Deep Navy ink */
	--entity-faction: #8200db; /* Royal Plum ink */
	--entity-encounter: #ca3500; /* Iron Oxide */

	text-rendering: optimizeLegibility;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;
}

[data-theme='dnd'] .prose,
[data-theme='dnd'] body {
	text-shadow: 0 0 0.15px rgba(44, 26, 17, 0.1);
}

/* D&D Mode Texture */
[data-theme='dnd'] .bg-background {
	background-color: var(--background);
	background-image: var(--bg-texture, none);
	background-repeat: repeat;
}

[data-theme='dnd'] .bg-muted {
	background-color: var(--muted);
	border-right-color: #c9c2b8;
}

/* --- TYPOGRAPHY (Prose) --- */
.prose {
	--tw-prose-body: var(--foreground);
	--tw-prose-headings: var(--foreground);
	--tw-prose-lead: var(--muted-foreground);
	--tw-prose-links: var(--primary);
	--tw-prose-bold: var(--foreground);
	--tw-prose-counters: var(--muted-foreground);
	--tw-prose-bullets: var(--primary);
	--tw-prose-hr: var(--border);
	--tw-prose-quotes: var(--foreground);
	--tw-prose-quote-borders: var(--primary);
	--tw-prose-captions: var(--muted-foreground);
	--tw-prose-code: var(--foreground);
	--tw-prose-pre-code: var(--foreground);
	--tw-prose-pre-bg: var(--muted);
	--tw-prose-th-borders: var(--border);
	--tw-prose-td-borders: var(--border);

	font-family: var(--font-sans);
	max-width: none;
}

/* Prose Dark Mode Overrides */
[data-theme='dark'] .prose {
	--tw-prose-body: var(--foreground);
	--tw-prose-headings: var(--foreground);
	--tw-prose-lead: var(--muted-foreground);
	--tw-prose-links: var(--primary);
	--tw-prose-bold: var(--foreground);
	--tw-prose-counters: var(--muted-foreground);
	--tw-prose-bullets: var(--primary);
	--tw-prose-hr: var(--border);
	--tw-prose-quotes: var(--muted-foreground);
	--tw-prose-quote-borders: var(--primary);
	--tw-prose-captions: var(--muted-foreground);
	--tw-prose-code: var(--accent-foreground);
	--tw-prose-pre-code: var(--accent-foreground);
	--tw-prose-pre-bg: var(--card);
	--tw-prose-th-borders: var(--border);
	--tw-prose-td-borders: var(--border);
}

/* D&D Mode Prose Styling */
[data-theme='dnd'] .prose h1,
[data-theme='dnd'] .prose h2,
[data-theme='dnd'] .prose h3 {
	font-family: var(--font-serif);
	color: var(--foreground);
	border-bottom-color: var(--border);
}

.prose h3:first-of-type {
	margin-top: 0 !important;
}

/* --- SCROLLBAR --- */
.custom-scrollbar::-webkit-scrollbar {
	width: 6px;
	height: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
	background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
	background: var(--border);
	border-radius: 99px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
	background: var(--muted-foreground);
}

/* --- SAFE AREA INSETS --- */
.pt-safe {
	padding-top: env(safe-area-inset-top, 20px);
}
.pb-safe {
	padding-bottom: env(safe-area-inset-bottom, 20px);
}
.pl-safe {
	padding-left: env(safe-area-inset-left, 0px);
}
.pr-safe {
	padding-right: env(safe-area-inset-right, 0px);
}

/* --- COMPREHENSIVE COMPATIBILITY OVERRIDES --- */

/* Background Colors */
.bg-white {
	background-color: var(--card) !important;
}
.bg-gray-50,
.bg-slate-50,
.bg-stone-50,
.bg-zinc-50 {
	background-color: var(--muted) !important;
}
.bg-gray-100,
.bg-slate-100,
.bg-stone-100,
.bg-zinc-100 {
	background-color: var(--muted) !important;
}
.bg-gray-200,
.bg-slate-200,
.bg-stone-200,
.bg-zinc-200 {
	background-color: var(--border) !important;
}

/* Text Colors - Foreground */
.text-gray-900,
.text-slate-900,
.text-stone-900,
.text-zinc-900 {
	color: var(--foreground) !important;
}
.text-gray-800,
.text-slate-800,
.text-stone-800,
.text-zinc-800 {
	color: var(--foreground) !important;
}
.text-gray-700,
.text-slate-700,
.text-stone-700,
.text-zinc-700 {
	color: var(--card-foreground) !important;
}

/* Text Colors - Muted */
.text-gray-600,
.text-slate-600,
.text-stone-600,
.text-zinc-600 {
	color: var(--muted-foreground) !important;
}
.text-gray-500,
.text-slate-500,
.text-stone-500,
.text-zinc-500 {
	color: var(--muted-foreground) !important;
}
.text-gray-400,
.text-slate-400,
.text-stone-400,
.text-zinc-400 {
	color: var(--muted-foreground) !important;
}

/* Border Colors */
.border-gray-200,
.border-slate-200,
.border-stone-200,
.border-zinc-200 {
	border-color: var(--border) !important;
}
.border-gray-300,
.border-slate-300,
.border-stone-300,
.border-zinc-300 {
	border-color: var(--border) !important;
}

/* Divide Colors */
.divide-gray-200,
.divide-slate-200,
.divide-stone-200,
.divide-zinc-200 {
	border-color: var(--border) !important;
}

/* Ring Colors */
.ring-gray-200,
.ring-slate-200,
.ring-stone-200,
.ring-zinc-200 {
	--tw-ring-color: var(--border) !important;
}

/* Opacity Variants */
.bg-black\/5 {
	background-color: color-mix(in srgb, var(--foreground) 5%, transparent) !important;
}
.bg-black\/10 {
	background-color: color-mix(in srgb, var(--foreground) 10%, transparent) !important;
}
.bg-white\/5 {
	background-color: color-mix(in srgb, var(--background) 5%, transparent) !important;
}
.bg-white\/10 {
	background-color: color-mix(in srgb, var(--background) 10%, transparent) !important;
}

/* Hover States */
.hover\:bg-black\/5:hover {
	background-color: color-mix(in srgb, var(--foreground) 5%, transparent) !important;
}
.hover\:bg-black\/10:hover {
	background-color: color-mix(in srgb, var(--foreground) 10%, transparent) !important;
}

/* Special fallback for header background */
.header-bg-fallback {
	background: linear-gradient(to bottom, color-mix(in srgb, var(--primary) 10%, var(--muted)), var(--background));
}

/* Leaflet Map Fixes for Dark Mode AND D&D Mode */
.leaflet-container {
	/* background-color: var(--background) !important; */
	font-family: var(--font-sans) !important;
}

/* Ensure popups use theme colors */
.leaflet-popup-content-wrapper {
	background-color: var(--card) !important;
	color: var(--card-foreground) !important;
	border-radius: 0.5rem !important; /* rounded-lg */
	box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1) !important; /* shadow-lg */
	padding: 0 !important;
	margin: 0 !important;
}

.leaflet-popup-tip {
	background-color: var(--card) !important;
}

/* Marker Popup Cards */
.marker-popup-card {
	@apply bg-card border-0; /* Remove border since wrapper has shadow */
}

.marker-popup-header {
	@apply bg-muted px-3 py-2 border-b border-border;
}

.marker-popup-category {
	@apply text-xs font-bold uppercase tracking-wider text-muted-foreground;
}

.marker-popup-title {
	@apply font-serif font-bold text-foreground text-sm;
}

.marker-popup-body {
	@apply p-3 text-sm text-muted-foreground;
}

/* FIX: Status Badge Semantic Colors */
.badge-alive {
	@apply border-emerald-600/50 bg-emerald-500/20 text-emerald-700;
}
.badge-dead {
	@apply border-red-600/50 bg-red-500/20 text-red-700;
}

/* Dark Mode Overrides */
[data-theme='dark'] .badge-alive {
	@apply text-emerald-400;
}
[data-theme='dark'] .badge-dead {
	@apply text-red-400;
}

/* Custom Clean Popup - Zero padding for custom cards */
.custom-popup-clean .leaflet-popup-content-wrapper {
	padding: 0 !important;
	overflow: hidden !important;
	background: transparent !important; /* Let the card handle bg */
	border: none !important;
	box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1) !important;
	margin: 0 !important;
}

.custom-popup-clean .leaflet-popup-content {
	margin: 0 !important;
	width: 300px !important; /* Fixed width for consistency */
	line-height: 1.5 !important;
	padding: 0 !important;
}

/* Ensure the tip matches the theme card color */
.custom-popup-clean .leaflet-popup-tip {
	background-color: var(--card) !important;
}

.leaflet-popup-content {
	padding: 0 !important;
	margin: 0 !important;
}

--- END OF app\styles\global.css ---

--- FILE: domain\entity\api\entityService.js ---
import { supabase } from '@/shared/api/supabaseClient';
import { getCampaigns } from '@/features/campaign/api/campaignService';

// --- API METHODS ---

export const getSessions = async (campaignId) => {
	// OPTIMIZATION: Use the pre-aggregated view
	const { data, error } = await supabase
		.from('view_campaign_timeline')
		.select('*')
		.eq('campaign_id', campaignId)
		.order('session_number', { ascending: true });

	if (error) throw error;

	// Map View structure to Domain structure
	return (data || []).map((s) => ({
		id: s.session_id,
		name: s.session_title,
		type: 'session',
		session_number: s.session_number,
		session_date: s.session_date,
		narrative: s.session_narrative,
		// Ensure generic attributes object exists for compatibility
		attributes: {
			session_number: s.session_number,
			session_date: s.session_date,
		},
	}));
};

const getCompleteEntities = async (campaignId, type) => {
	// Uses the detailed view for full entity pages
	const { data, error } = await supabase
		.from('entity_complete_view')
		.select('id, name, type, description, attributes, relationships')
		.eq('campaign_id', campaignId)
		.eq('type', type)
		.order('name');

	if (error) throw error;
	return data;
};

/**
 * Fetch Narrative Arcs and their links to Sessions
 * Used for organizing the Wiki Swimlanes
 */
export const getCampaignArcs = async (campaignId) => {
	// 1. Fetch the Pre-Calculated View
	const { data: arcs, error: arcError } = await supabase
		.from('view_narrative_arc_summary')
		.select('*')
		.eq('campaign_id', campaignId) // Ensure your view handles campaign_id or filter via join if needed
		.order('order', { ascending: true });

	if (arcError) throw arcError;

	// 2. Fetch the Session Links (needed for grouping logic in JS)
	const { data: rels, error: relError } = await supabase
		.from('entity_relationships')
		.select('from_entity_id, to_entity_id')
		.eq('relationship_type', 'part_of')
		.in(
			'to_entity_id',
			arcs.map((a) => a.id)
		); // Only get links for these arcs

	if (relError) throw relError;

	return { arcs, rels };
};

export const getEntities = async (campaignId, type) => {
	const strategy = entityStrategies[type] || entityStrategies.default;
	return strategy(campaignId, type);
};

export const getGraphData = async (campaignId) => {
	// OPTIMIZATION: Use the graph-specific view (Nodes + Adjacency List)
	const { data, error } = await supabase.from('view_campaign_graph').select('*').eq('campaign_id', campaignId);

	if (error) {
		console.error('Graph Fetch Error:', error);
		return [];
	}
	return data || [];
};

export const getEntityIndex = async (campaignId) => {
	// OPTIMIZATION: Use lightweight index view (No heavy JSON joins)
	const { data, error } = await supabase
		.from('view_entity_index')
		.select('*') // Selects: id, name, type, description, icon_url, status, affinity
		.eq('campaign_id', campaignId);

	if (error) return [];

	// Remap flat columns to expected 'attributes' object for UI compatibility
	return data
		.map((e) => ({
			...e,
			attributes: {
				icon: e.icon_url,
				status: e.status,
				affinity: e.affinity,
				background_image: e.background_image,
				aliases: e.aliases,
			},
		}))
		.sort((a, b) => b.name.length - a.name.length);
};

// --- WIKI ENTRY STRATEGIES ---

const fetchSessionWikiEntry = async (id) => {
	// 1. Fetch Core Data + Events + Mentions via View
	// The view_campaign_timeline has everything we need for the session structure
	const { data: timelineData, error } = await supabase
		.from('view_campaign_timeline')
		.select('*')
		.eq('session_id', id)
		.single();

	if (error) throw error;

	// 2. Fetch Direct Session Relationships (not event-tied)
	// We still need the generic relationships for the sidebar
	const { data: directRels } = await supabase
		.from('entity_relationships')
		.select(`target:entities!to_entity_id ( id, name, type ), relationship_type`)
		.eq('from_entity_id', id);

	const sessionRelationships = (directRels || []).map((rel) => ({
		entity_id: rel.target.id,
		entity_name: rel.target.name,
		entity_type: rel.target.type,
		type: rel.relationship_type,
	}));

	// 3. Transform Event Tags to Mention Map
	// The view returns events with 'tags'. We need to flatten this for the UI.
	const eventRelMap = new Map();
	(timelineData.events || []).forEach((event) => {
		if (event.tags && event.tags.length > 0) {
			eventRelMap.set(
				event.id,
				event.tags.map((tag) => ({
					entity_id: tag.entity_id,
					entity_name: tag.name,
					entity_type: tag.type,
					type: 'mention',
				}))
			);
		}
	});

	return {
		data: {
			id: timelineData.session_id,
			title: timelineData.session_title,
			narrative: timelineData.session_narrative,
			events: timelineData.events, // Pre-sorted and aggregated
			attributes: {
				session_number: timelineData.session_number,
				session_date: timelineData.session_date,
			},
		},
		type: 'session',
		additional: { eventRelMap, sessionRelationships },
	};
};

const fetchEncounterWikiEntry = async (id, entityData) => {
	// OPTIMIZATION: Use the Hydrated View
	const { data: actions, error } = await supabase
		.from('view_encounter_actions_hydrated')
		.select('*')
		.eq('encounter_id', id)
		.order('round_number', { ascending: true })
		.order('action_order', { ascending: true });

	if (error) console.error('Encounter Actions Fetch Error:', error);

	return {
		data: entityData,
		type: 'encounter',
		additional: { encounterActions: actions || [] },
	};
};

const fetchQuestWikiEntry = async (id, entityData) => {
	// OPTIMIZATION: Single query with nested select for Session Attributes
	const { data: objectives, error } = await supabase
		.from('quest_objectives')
		.select(
			`
            *,
            session:sessions (
                id, 
                title,
                attributes
            )
        `
		)
		.eq('quest_id', id)
		.order('order_index', { ascending: true });

	if (error) console.error('Quest Objectives Error:', error);

	// Client-side cleanup: Extract session_number from JSONB
	const processedObjectives = (objectives || []).map((obj) => {
		if (obj.session) {
			const attrs = obj.session.attributes || {};
			obj.session.session_number = attrs.session_number || attrs.session;
		}
		return obj;
	});

	return {
		data: entityData,
		type: 'quest',
		additional: { objectives: processedObjectives },
	};
};

// Main Entry Point
export const getWikiEntry = async (id, type) => {
	// Strategy: Session is unique because it comes from a different base table/view
	if (type === 'session') {
		return fetchSessionWikiEntry(id);
	}

	// Standard Entities: Fetch Core Data first
	const { data, error } = await supabase.from('entity_complete_view').select('*').eq('id', id).single();
	if (error) throw error;

	// Strategy Pattern for Additional Data
	if (type === 'encounter') return fetchEncounterWikiEntry(id, data);
	if (type === 'quest') return fetchQuestWikiEntry(id, data);

	// Default
	return { data, type, additional: {} };
};

export const getTooltipData = async (id, type) => {
	if (type === 'session') {
		const { data } = await supabase.from('sessions').select('title, narrative').eq('id', id).single();
		return {
			name: data.title,
			type: 'session',
			description: data.narrative,
			attributes: {},
		};
	}

	// Lightweight fetch for tooltip
	const { data, error } = await supabase
		.from('entity_complete_view') // Could optimize to view_entity_index if attributes aren't needed
		.select('name, type, description, attributes')
		.eq('id', id)
		.single();

	if (error) throw error;
	return data;
};

const entityStrategies = {
	session: getSessions,
	quest: getCompleteEntities,
	default: getCompleteEntities,
	campaign: async () => getCampaigns(),
};

--- END OF domain\entity\api\entityService.js ---

--- FILE: domain\entity\components\EntityBadge.jsx ---
import { clsx } from 'clsx';
import { getEntityLabel } from '@/domain/entity/config/entityTypes';
import { getEntityStyles } from '@/domain/entity/config/entityStyles';

/**
 * EntityBadge Component
 * Displays a colored type badge for an entity
 *
 * @param {string} type - Entity type
 * @param {string} label - Optional custom label (defaults to type label)
 * @param {string} size - Badge size: 'sm', 'md', 'lg' (default 'md')
 * @param {string} variant - Style variant: 'solid', 'outline', 'subtle' (default 'solid')
 * @param {string} className - Additional CSS classes
 */
export default function EntityBadge({ type, label = null, size = 'md', variant = 'solid', className = '', ...props }) {
	const styles = getEntityStyles(type);
	const displayLabel = label || getEntityLabel(type);

	const sizeClasses = {
		sm: 'text-[9px] px-1.5 py-0.5',
		md: 'text-[10px] px-2 py-0.5',
		lg: 'text-xs px-2.5 py-1',
	};

	const variantClasses = {
		solid: clsx(styles.bg, styles.text, styles.border, 'border'),
		outline: clsx('bg-transparent', styles.text, styles.border, 'border'),
		subtle: clsx(styles.bg, styles.text, 'border-transparent border'),
	};

	return (
		<span
			className={clsx(
				'inline-flex items-center font-bold uppercase tracking-wider rounded shrink-0',
				sizeClasses[size],
				variantClasses[variant],
				className
			)}
			{...props}>
			{displayLabel}
		</span>
	);
}

--- END OF domain\entity\components\EntityBadge.jsx ---

--- FILE: domain\entity\components\EntityIcon.jsx ---
import { clsx } from 'clsx';
import { getEntityIcon } from '@/domain/entity/config/entityIcons';
import { getEntityStyles } from '@/domain/entity/config/entityStyles';

/**
 * EntityIcon Component
 * Renders an entity icon with optional custom image override
 * STRICTLY uses <span> to ensure hydration safety inside <p> tags.
 */
export default function EntityIcon({
	type,
	customIconUrl = null,
	size = 16,
	className = '',
	showBackground = false,
	inline = false,
	...props
}) {
	const Icon = getEntityIcon(type);
	const styles = getEntityStyles(type);

	// FIX: Always use 'span' to avoid "div descendant of p" hydration errors
	const Container = 'span';

	// 1. Custom Image Case
	if (customIconUrl) {
		return (
			<Container
				className={clsx(
					'inline-flex items-center justify-center overflow-hidden shrink-0 select-none bg-muted',
					showBackground && clsx('rounded-lg border', styles.bg, styles.border),
					className
				)}
				style={{ width: size, height: size }}
				{...props}>
				<img
					src={customIconUrl}
					alt=''
					className='w-full h-full object-cover'
					draggable={false}
					onError={(e) => {
						e.target.style.display = 'none';
						e.target.parentElement.classList.add('fallback-icon');
					}}
				/>
			</Container>
		);
	}

	// 2. Background/Frame Case
	if (showBackground) {
		return (
			<Container
				className={clsx(
					'inline-flex items-center justify-center rounded-lg border p-1.5 shrink-0 select-none',
					styles.bg,
					styles.border,
					styles.text,
					className
				)}
				style={{ width: size, height: size }}
				{...props}>
				<Icon size={size * 0.75} strokeWidth={2} />
			</Container>
		);
	}

	// 3. Simple Icon Case (SVG is safe in <p>)
	return <Icon size={size} className={clsx(styles.text, className)} strokeWidth={2} {...props} />;
}

--- END OF domain\entity\components\EntityIcon.jsx ---

--- FILE: domain\entity\components\EntityLink.jsx ---
import { useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import { useTooltip } from '@/features/smart-tooltip/TooltipContext';
import { getEntityStyles } from '@/domain/entity/config/entityStyles';
import EntityIcon from './EntityIcon';

export default function EntityLink({
	id,
	type,
	children,
	customIconUrl = null,
	showIcon = true,
	className = '',
	inline = false,
	...props
}) {
	const navigate = useNavigate();
	const { openTooltip, closeTooltip } = useTooltip();
	const styles = getEntityStyles(type);

	const handleMouseEnter = (e) => {
		// Desktop only: Hover to open
		if (window.matchMedia('(hover: hover)').matches) {
			openTooltip(e, id, type);
		}
	};

	// FIX: Guard closeTooltip so mobile touch emulation doesn't auto-close it
	const handleMouseLeave = () => {
		if (window.matchMedia('(hover: hover)').matches) {
			closeTooltip();
		}
	};

	const handleClick = (e) => {
		e.preventDefault();

		if (window.matchMedia('(hover: hover)').matches) {
			// Desktop: Click to navigate
			navigate(`/wiki/${type}/${id}`);
			closeTooltip();
		} else {
			// Mobile: Tap to open tooltip (Sticky mode = true)
			openTooltip(e, id, type, true);
		}
	};

	const commonProps = {
		href: `/wiki/${type}/${id}`,
		onClick: handleClick,
		onMouseEnter: handleMouseEnter,
		onMouseLeave: handleMouseLeave, // Use the guarded handler
		...props,
	};

	if (inline) {
		return (
			<a
				className={clsx(
					'inline-flex items-center gap-1.5 font-semibold no-underline transition-colors',
					'border-b border-dashed border-transparent hover:border-current cursor-pointer align-middle',
					styles.text,
					styles.hover,
					className
				)}
				{...commonProps}>
				{showIcon && (
					<EntityIcon
						type={type}
						customIconUrl={customIconUrl}
						size={14}
						inline={true}
						className='self-center rounded-full'
					/>
				)}
				{children}
			</a>
		);
	}

	return (
		<a
			className={clsx(
				'flex items-center gap-2 px-3 py-2 rounded-lg transition-all cursor-pointer',
				'hover:shadow-sm',
				styles.bg,
				styles.hover,
				styles.border,
				'border',
				className
			)}
			{...commonProps}>
			{showIcon && <EntityIcon type={type} customIconUrl={customIconUrl} size={18} inline={false} />}
			<span className={clsx('font-semibold text-sm', styles.text)}>{children}</span>
		</a>
	);
}

--- END OF domain\entity\components\EntityLink.jsx ---

--- FILE: domain\entity\components\EntityStatusIcon.jsx ---
import { clsx } from 'clsx';
import { getStatusIcon } from '@/domain/entity/utils/statusUtils';

/**
 * EntityStatusIcon Component
 * Smart status indicator based on entity type and status/affinity
 *
 * @param {Object} entity - Entity object with type and status/affinity
 * @param {number} size - Icon size (default 12)
 * @param {string} className - Additional CSS classes
 */
export default function EntityStatusIcon({ entity, size = 12, className = '', ...props }) {
	if (!entity) return null;

	// Determine which status to show (affinity takes priority for NPCs/factions)
	const statusValue = entity.affinity || entity.status;
	if (!statusValue || statusValue === 'unknown') return null;

	const { Icon, className: statusClass } = getStatusIcon(statusValue, entity.type);

	return <Icon size={size} className={clsx(statusClass, className)} strokeWidth={2.5} {...props} />;
}

/**
 * EntityStatusBadge Component
 * Status indicator with text label
 *
 * @param {Object} entity - Entity object
 * @param {string} className - Additional CSS classes
 */
export function EntityStatusBadge({ entity, className = '', ...props }) {
	if (!entity) return null;

	const statusValue = entity.affinity || entity.status;
	if (!statusValue || statusValue === 'unknown') return null;

	const { Icon, className: statusClass } = getStatusIcon(statusValue, entity.type);

	return (
		<span
			className={clsx('inline-flex items-center gap-1.5 text-xs font-semibold px-2 py-1 rounded-md border', className)}
			{...props}>
			<Icon size={12} className={statusClass} strokeWidth={2.5} />
			<span className='capitalize'>{statusValue}</span>
		</span>
	);
}

--- END OF domain\entity\components\EntityStatusIcon.jsx ---

--- FILE: domain\entity\config\entityColors.js ---
/**
 * Entity Color Palettes
 * Hex colors for each entity type
 */

import { ENTITY_TYPES } from './entityTypes';

/**
 * Primary color for each entity type (hex)
 */
export const ENTITY_COLORS = {
	[ENTITY_TYPES.SESSION]: '#64748b', // slate-500
	[ENTITY_TYPES.CHARACTER]: '#ef4444', // red-500
	[ENTITY_TYPES.NPC]: '#d97706', // amber-600
	[ENTITY_TYPES.LOCATION]: '#10b981', // emerald-500
	[ENTITY_TYPES.QUEST]: '#3b82f6', // blue-500
	[ENTITY_TYPES.FACTION]: '#a855f7', // purple-500
	[ENTITY_TYPES.ENCOUNTER]: '#f97316', // orange-500
	[ENTITY_TYPES.ITEM]: '#06b6d4', // cyan-500
	[ENTITY_TYPES.DEFAULT]: '#6b7280', // gray-500
};

/**
 * Get primary color for entity type
 * @param {string} type - Entity type
 * @returns {string} Hex color
 */
export const getEntityColor = (type) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;
	return ENTITY_COLORS[normalized] || ENTITY_COLORS[ENTITY_TYPES.DEFAULT];
};

/**
 * Extended color palette for each type (for future use)
 * Includes lighter/darker shades
 */
export const ENTITY_COLOR_PALETTES = {
	[ENTITY_TYPES.SESSION]: {
		50: '#f8fafc',
		100: '#f1f5f9',
		500: '#64748b',
		700: '#334155',
		900: '#0f172a',
	},
	[ENTITY_TYPES.CHARACTER]: {
		50: '#fef2f2',
		100: '#fee2e2',
		500: '#ef4444',
		700: '#b91c1c',
		900: '#7f1d1d',
	},
	[ENTITY_TYPES.NPC]: {
		50: '#fffbeb',
		100: '#fef3c7',
		500: '#d97706',
		700: '#a16207',
		900: '#78350f',
	},
	[ENTITY_TYPES.LOCATION]: {
		50: '#ecfdf5',
		100: '#d1fae5',
		500: '#10b981',
		700: '#047857',
		900: '#064e3b',
	},
	[ENTITY_TYPES.QUEST]: {
		50: '#eff6ff',
		100: '#dbeafe',
		500: '#3b82f6',
		700: '#1d4ed8',
		900: '#1e3a8a',
	},
	[ENTITY_TYPES.FACTION]: {
		50: '#faf5ff',
		100: '#f3e8ff',
		500: '#a855f7',
		700: '#7e22ce',
		900: '#581c87',
	},
	[ENTITY_TYPES.ENCOUNTER]: {
		50: '#fff7ed',
		100: '#ffedd5',
		500: '#f97316',
		700: '#c2410c',
		900: '#7c2d12',
	},
	[ENTITY_TYPES.ITEM]: {
		// <--- ADDED
		50: '#ecfeff',
		100: '#cffafe',
		500: '#06b6d4',
		700: '#0e7490',
		900: '#164e63',
	},
	[ENTITY_TYPES.DEFAULT]: {
		50: '#f9fafb',
		100: '#f3f4f6',
		500: '#6b7280',
		700: '#374151',
		900: '#111827',
	},
};

/**
 * Get color palette for entity type
 * @param {string} type - Entity type
 * @returns {Object} Color palette
 */
export const getEntityPalette = (type) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;
	return ENTITY_COLOR_PALETTES[normalized] || ENTITY_COLOR_PALETTES[ENTITY_TYPES.DEFAULT];
};

--- END OF domain\entity\config\entityColors.js ---

--- FILE: domain\entity\config\entityConfig.js ---
/**
 * Entity Configuration Orchestrator
 * Combines all entity config modules into a unified API
 * This replaces the old monolithic entityConfig.jsx
 */

import { ENTITY_TYPES, getEntityLabel } from './entityTypes';
import { getEntityIcon } from './entityIcons';
import { getEntityColor, getEntityPalette } from './entityColors';
import { getEntityStyles, getEntityPreset, buildEntityClassName } from './entityStyles';

/**
 * Get complete configuration for an entity type
 * @param {string} type - Entity type
 * @returns {Object} Complete entity config
 */
export const getEntityConfig = (type) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;

	return {
		type: normalized,
		label: getEntityLabel(normalized),
		labelPlural: getEntityLabel(normalized, true),
		icon: getEntityIcon(normalized),
		color: getEntityColor(normalized),
		palette: getEntityPalette(normalized),
		tailwind: getEntityStyles(normalized),
	};
};

/**
 * LEGACY EXPORT: Full config map for backwards compatibility
 * TODO: Gradually migrate consumers to use getEntityConfig() instead
 */
export const ENTITY_CONFIG = Object.values(ENTITY_TYPES).reduce((acc, type) => {
	acc[type] = getEntityConfig(type);
	return acc;
}, {});

// Re-export everything for convenience
export { ENTITY_TYPES, getEntityLabel } from './entityTypes';
export { getEntityIcon } from './entityIcons';
export { getEntityColor, getEntityPalette } from './entityColors';
export { getEntityStyles, getEntityPreset, buildEntityClassName } from './entityStyles';

--- END OF domain\entity\config\entityConfig.js ---

--- FILE: domain\entity\config\entityIcons.js ---
import {
	User,
	MapPin,
	Scroll,
	Sword,
	Flag,
	Crown,
	BookOpen,
	Calendar,
	Trees,
	Castle,
	Ship,
	Landmark,
	Globe,
	Home,
	Mountain,
	Gem,
} from 'lucide-react';
import { ENTITY_TYPES } from './entityTypes';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const ENTITY_ICONS = {
	[ENTITY_TYPES.SESSION]: Calendar,
	[ENTITY_TYPES.CHARACTER]: User,
	[ENTITY_TYPES.NPC]: Crown,
	[ENTITY_TYPES.LOCATION]: MapPin,
	[ENTITY_TYPES.QUEST]: Scroll,
	[ENTITY_TYPES.FACTION]: Flag,
	[ENTITY_TYPES.ENCOUNTER]: Sword,
	[ENTITY_TYPES.ITEM]: Gem,
	[ENTITY_TYPES.DEFAULT]: BookOpen,
};

// Location specific mappings
const LOCATION_TYPE_ICONS = {
	building: Home,
	ship: Ship,
	landmark: Landmark,
	dungeon: Mountain,
	cave: Mountain,
	region: MapPin,
	city: Castle,
	forest: Trees,
	realm: Globe,
};

export const getEntityIcon = (type) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;
	return ENTITY_ICONS[normalized] || ENTITY_ICONS[ENTITY_TYPES.DEFAULT];
};

/**
 * Advanced resolution that looks at attributes for finer detail
 */
export const resolveEntityIcon = (entity) => {
	const type = entity.type?.toLowerCase();

	if (type === 'location') {
		const locType = getAttributeValue(entity.attributes, 'type')?.toLowerCase();
		return LOCATION_TYPE_ICONS[locType] || ENTITY_ICONS.location;
	}

	return getEntityIcon(type);
};

--- END OF domain\entity\config\entityIcons.js ---

--- FILE: domain\entity\config\entityStyles.js ---
import { ENTITY_TYPES } from './entityTypes';

/**
 * Tailwind class maps
 * CHANGED: Replaced 'slate' with 'muted-foreground' or 'foreground' to respect the active theme.
 */
const ENTITY_TAILWIND_CLASSES = {
	[ENTITY_TYPES.SESSION]: {
		text: 'text-[var(--entity-session,theme(colors.slate.500))] font-medium',
		bg: 'bg-muted/50',
		border: 'border-border',
		hover: 'hover:bg-muted',
	},
	[ENTITY_TYPES.CHARACTER]: {
		text: 'text-[var(--entity-character,theme(colors.red.500))]',
		bg: 'bg-red-500/10',
		border: 'border-red-500/20',
		hover: 'hover:bg-red-500/10',
	},
	[ENTITY_TYPES.NPC]: {
		text: 'text-[var(--entity-npc,theme(colors.amber.500))]',
		bg: 'bg-amber-500/10',
		border: 'border-amber-500/20',
		hover: 'hover:bg-amber-500/10',
	},
	[ENTITY_TYPES.LOCATION]: {
		text: 'text-[var(--entity-location,theme(colors.emerald.500))]', // Will use moss green on D&D theme
		bg: 'bg-emerald-500/10',
		border: 'border-emerald-500/20',
		hover: 'hover:bg-emerald-500/10',
	},
	[ENTITY_TYPES.QUEST]: {
		text: 'text-[var(--entity-quest,theme(colors.blue.500))]',
		bg: 'bg-blue-500/10',
		border: 'border-blue-500/20',
		hover: 'hover:bg-blue-500/10',
	},
	[ENTITY_TYPES.FACTION]: {
		text: 'text-[var(--entity-faction,theme(colors.purple.500))]',
		bg: 'bg-purple-500/10',
		border: 'border-purple-500/20',
		hover: 'hover:bg-purple-500/10',
	},
	[ENTITY_TYPES.ENCOUNTER]: {
		text: 'text-[var(--entity-encounter,theme(colors.orange.500))]',
		bg: 'bg-orange-500/10',
		border: 'border-orange-500/20',
		hover: 'hover:bg-orange-500/10',
	},
	[ENTITY_TYPES.ITEM]: {
		text: 'text-[var(--entity-item,theme(colors.cyan.600))] dark:text-[var(--entity-item,theme(colors.cyan.400))]',
		bg: 'bg-cyan-500/10',
		border: 'border-cyan-500/20',
		hover: 'hover:bg-cyan-500/10',
	},
	[ENTITY_TYPES.DEFAULT]: {
		text: 'text-muted-foreground',
		bg: 'bg-muted',
		border: 'border-border',
		hover: 'hover:bg-muted/80',
	},
};

export const getEntityStyles = (type) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;
	return ENTITY_TAILWIND_CLASSES[normalized] || ENTITY_TAILWIND_CLASSES[ENTITY_TYPES.DEFAULT];
};

export const buildEntityClassName = (type, variants = [], additional = '') => {
	const styles = getEntityStyles(type);
	const variantList = Array.isArray(variants) ? variants : [variants];
	const classes = variantList
		.map((variant) => styles[variant])
		.filter(Boolean)
		.join(' ');
	return additional ? `${classes} ${additional}` : classes;
};

// Priority Badges - Using semantic opacity for better dark/light compatibility
export const getPriorityStyles = (priority) => {
	const p = priority?.toLowerCase() || '';
	if (p.includes('high') || p.includes('urgent') || p.includes('critical')) {
		return 'border-orange-500/30 text-orange-700 dark:text-orange-400 bg-orange-500/10';
	}
	if (p.includes('medium') || p.includes('normal')) {
		return 'border-blue-500/30 text-blue-700 dark:text-blue-400 bg-blue-500/10';
	}
	if (p.includes('low')) {
		return 'border-border text-muted-foreground bg-muted/50';
	}
	return 'border-border text-muted-foreground bg-muted/30';
};

export const ENTITY_CLASS_PRESETS = {
	iconBadge: (type) => {
		const styles = getEntityStyles(type);
		return `${styles.bg} ${styles.border} ${styles.text} rounded-lg p-2 border`;
	},
	typeBadge: (type) => {
		const styles = getEntityStyles(type);
		return `${styles.bg} ${styles.text} ${styles.border} text-xs font-bold uppercase tracking-wider px-2 py-0.5 rounded border`;
	},
	card: (type) => {
		const styles = getEntityStyles(type);
		// Force bg-card to ensure cards are readable on all themes
		return `bg-card border-border border rounded-lg p-4 ${styles.hover} transition-colors`;
	},
	link: (type) => {
		const styles = getEntityStyles(type);
		return `${styles.text} transition-colors font-semibold hover:underline`;
	},
};

export const getEntityPreset = (preset, type) => {
	const presetFn = ENTITY_CLASS_PRESETS[preset];
	return presetFn ? presetFn(type) : '';
};

--- END OF domain\entity\config\entityStyles.js ---

--- FILE: domain\entity\config\entityTypes.js ---
/**
 * Entity Type Definitions
 * Central source of truth for entity types
 */

/**
 * All valid entity types in the system
 */
export const ENTITY_TYPES = {
	SESSION: 'session',
	CHARACTER: 'character',
	NPC: 'npc',
	LOCATION: 'location',
	QUEST: 'quest',
	FACTION: 'faction',
	ENCOUNTER: 'encounter',
	ITEM: 'item',
	DEFAULT: 'default',
};

/**
 * Entity type labels (for display)
 */
export const ENTITY_LABELS = {
	[ENTITY_TYPES.SESSION]: 'Session',
	[ENTITY_TYPES.CHARACTER]: 'Character',
	[ENTITY_TYPES.NPC]: 'NPC',
	[ENTITY_TYPES.LOCATION]: 'Location',
	[ENTITY_TYPES.QUEST]: 'Quest',
	[ENTITY_TYPES.FACTION]: 'Faction',
	[ENTITY_TYPES.ENCOUNTER]: 'Encounter',
	[ENTITY_TYPES.ITEM]: 'Item',
	[ENTITY_TYPES.DEFAULT]: 'Entity',
};

/**
 * Pluralized entity labels (for navigation, headers)
 */
export const ENTITY_LABELS_PLURAL = {
	[ENTITY_TYPES.SESSION]: 'Sessions',
	[ENTITY_TYPES.CHARACTER]: 'Characters',
	[ENTITY_TYPES.NPC]: 'NPCs',
	[ENTITY_TYPES.LOCATION]: 'Locations',
	[ENTITY_TYPES.QUEST]: 'Quests',
	[ENTITY_TYPES.FACTION]: 'Factions',
	[ENTITY_TYPES.ENCOUNTER]: 'Encounters',
	[ENTITY_TYPES.ITEM]: 'Items',
	[ENTITY_TYPES.DEFAULT]: 'Entities',
};

/**
 * Get label for entity type
 * @param {string} type - Entity type
 * @param {boolean} plural - Return plural form
 * @returns {string}
 */
export const getEntityLabel = (type, plural = false) => {
	const normalized = type?.toLowerCase() || ENTITY_TYPES.DEFAULT;
	const labels = plural ? ENTITY_LABELS_PLURAL : ENTITY_LABELS;
	return labels[normalized] || labels[ENTITY_TYPES.DEFAULT];
};

--- END OF domain\entity\config\entityTypes.js ---

--- FILE: domain\entity\utils\attributeParser.js ---
/**
 * Attribute Parsing Utilities
 * Safe parsing and extraction of entity attributes
 */

/**
 * Parse attributes safely from JSON string, Object, or DB Row Array
 * @param {string|Object|Array} attrs - Raw attributes
 * @returns {Object} Parsed attributes object { key: value }
 */
export const parseAttributes = (attrs) => {
	if (!attrs) return {};

	// 1. Handle JSON String
	if (typeof attrs === 'string') {
		try {
			return JSON.parse(attrs);
		} catch {
			console.warn('Failed to parse attributes string:', attrs);
			return {};
		}
	}

	// 2. Handle DB Row Array: [{ name: 'icon', value: '...' }, ...]
	// This is common when joining tables (e.g. encounter_actions -> actor -> attributes)
	if (Array.isArray(attrs)) {
		// Check if it looks like a Name/Value pair list
		if (attrs.length > 0 && 'name' in attrs[0] && 'value' in attrs[0]) {
			return attrs.reduce((acc, curr) => {
				if (curr.name) acc[curr.name] = curr.value;
				return acc;
			}, {});
		}
		// Otherwise return as-is (might be a simple list attribute value)
		return {};
	}

	// 3. Already an Object
	return attrs;
};

// ... (Keep getAttributeValue and rest of file exactly as is) ...
export const getAttributeValue = (attributes, keys) => {
	if (!attributes) return null;

	// Normalize keys to array
	const keyList = Array.isArray(keys) ? keys : [keys];

	for (const key of keyList) {
		// Try exact match
		let val = attributes[key];

		// Try lowercase match
		if (!val) {
			val = attributes[key.toLowerCase()];
		}

		// Try capitalized match
		if (!val) {
			val = attributes[key.charAt(0).toUpperCase() + key.slice(1)];
		}

		if (!val) continue;

		// Unwrap nested structures
		if (typeof val === 'string') return val;
		if (Array.isArray(val) && val[0]?.value) return val[0].value;
		if (Array.isArray(val) && val[0]) return String(val[0]);
		if (typeof val === 'object' && val.value) return val.value;

		// Fallback: stringify
		return String(val);
	}

	return null;
};

// ... (Keep rest of file) ...
export const parseAttributeValue = (val, key) => {
	if (val === null || val === undefined) return null;

	// 1. Already an array - clean it
	if (Array.isArray(val)) {
		return val.map((item) => (typeof item === 'object' && item.value ? item.value : item));
	}

	// 2. Check if this should be a list based on key name
	const listKeys = ['feature', 'features', 'traits', 'inventory', 'loot', 'spells'];
	if (typeof val === 'string' && listKeys.includes(key?.toLowerCase())) {
		return val
			.split(',')
			.map((s) => s.trim())
			.filter(Boolean);
	}

	// 3. Unwrap objects
	if (typeof val === 'object' && val.value) {
		return val.value;
	}

	// 4. Return as string
	return String(val);
};

export const parseAbilityScores = (val) => {
	if (!val || typeof val !== 'string') return [];

	return val.split(',').map((s) => {
		const parts = s.trim().split(' ');
		const name = parts[0];
		const score = parts.find((p) => /^\d+$/.test(p)) || '';
		const mod = parts.find((p) => p.includes('('))?.replace(/[()]/g, '') || '';

		return { name, score, mod };
	});
};

export const parseTagList = (val) => {
	if (!val) return [];
	if (Array.isArray(val)) return val.map(String);

	return String(val)
		.split(',')
		.map((s) => s.trim())
		.filter(Boolean);
};

export const isIgnoredAttribute = (key) => {
	const ignoredKeys = [
		'image',
		'portrait',
		'icon',
		'token',
		'session',
		'date',
		'summary',
		'background_image',
		'background',
		'is_active',
		'map_image',
		'map_markers',
		'aliases',
	];

	return ignoredKeys.includes(key.toLowerCase());
};

export const isNarrativeAttribute = (key) => {
	const narrativeKeys = [
		'background',
		'personality',
		'history',
		'bio',
		'biography',
		'goals',
		'ideals',
		'bonds',
		'flaws',
		'notes',
		'gm notes',
		'description',
		'appearance',
		'tactics',
		'narrative',
	];

	return narrativeKeys.includes(key.toLowerCase());
};

export const isListAttribute = (key) => {
	const listKeys = ['feature', 'features', 'traits', 'inventory', 'loot', 'spells'];
	return listKeys.includes(key.toLowerCase());
};

export const getAttributeDisplayType = (key, value) => {
	const normalizedKey = key.toLowerCase();

	// Special widgets
	if (['abilities', 'stats'].includes(normalizedKey)) {
		return 'stat-grid';
	}

	if (['ability score', 'saving throw', 'saves', 'skills', 'languages', 'proficiencies'].includes(normalizedKey)) {
		return 'tags';
	}

	// Force list display
	if (isListAttribute(key) && Array.isArray(value)) {
		return 'list';
	}

	// Narrative text
	if (isNarrativeAttribute(key)) {
		return 'narrative';
	}

	// Long text becomes narrative
	if (typeof value === 'string' && value.length > 100) {
		return 'narrative';
	}

	// Default
	return 'text';
};

--- END OF domain\entity\utils\attributeParser.js ---

--- FILE: domain\entity\utils\entityUtils.js ---
/**
 * Entity Type Utilities
 * Pure functions for entity type checking and normalization
 */

/**
 * Normalize entity type string
 * @param {string} type - Raw type string
 * @returns {string} Normalized type
 */
export const normalizeEntityType = (type) => {
	if (!type) return 'default';
	const normalized = type.toLowerCase().trim();
	// Handle plurals
	return normalized === 'sessions' ? 'session' : normalized;
};

/**
 * Check if entity type is a specific value
 * @param {Object} entity - Entity object
 * @param {string} type - Type to check
 * @returns {boolean}
 */
export const isEntityType = (entity, type) => {
	return normalizeEntityType(entity?.type) === normalizeEntityType(type);
};

/**
 * Check if entity is a session
 */
export const isSession = (entity) => isEntityType(entity, 'session');

/**
 * Check if entity is a quest
 */
export const isQuest = (entity) => isEntityType(entity, 'quest');

/**
 * Check if entity is an NPC
 */
export const isNPC = (entity) => isEntityType(entity, 'npc');

/**
 * Check if entity is a location
 */
export const isLocation = (entity) => isEntityType(entity, 'location');

/**
 * Check if entity type should show status icons
 * @param {string} type - Entity type
 * @returns {boolean}
 */
export const shouldShowStatus = (type) => {
	const normalized = normalizeEntityType(type);
	return ['npc', 'faction', 'quest'].includes(normalized);
};

/**
 * Get entity display name
 * Handles different name fields across entity types
 * @param {Object} entity - Entity object
 * @returns {string}
 */
export const getEntityName = (entity) => {
	if (!entity) return 'Unknown';

	// Sessions use 'title'
	if (isSession(entity)) {
		return entity.title || entity.name || 'Untitled Session';
	}

	// Quests use 'title'
	if (isQuest(entity)) {
		return entity.title || entity.name || 'Untitled Quest';
	}

	// Everyone else uses 'name'
	return entity.name || 'Unnamed';
};

/**
 * Get entity description
 * Handles different description fields
 * @param {Object} entity - Entity object
 * @returns {string|null}
 */
export const getEntityDescription = (entity) => {
	if (!entity) return null;

	// Try description first
	if (entity.description) return entity.description;

	// Sessions might use summary
	if (isSession(entity)) {
		return entity?.summary || entity.narrative || null;
	}

	// Characters might use background
	if (isEntityType(entity, 'character')) {
		return entity.background || entity.short_description || null;
	}

	return null;
};

/**
 * Get entity icon initial (first letter)
 * @param {Object} entity - Entity object
 * @returns {string}
 */
export const getEntityInitial = (entity) => {
	const name = getEntityName(entity);
	return (name[0] || 'E').toUpperCase();
};

/**
 * Check if entity is marked as dead/inactive
 * @param {Object} entity - Entity object
 * @returns {boolean}
 */
export const isEntityDead = (entity) => {
	const status = entity.status?.toLowerCase();
	return status === 'dead' || status === 'deceased' || status === 'inactive';
};

/**
 * Check if entity/quest is completed
 * @param {Object} entity - Entity object
 * @returns {boolean}
 */
export const isEntityCompleted = (entity) => {
	const status = entity.status?.toLowerCase();
	return ['completed', 'finished', 'done', 'success'].some((k) => status?.includes(k));
};

/**
 * Check if entity/quest has failed
 * @param {Object} entity - Entity object
 * @returns {boolean}
 */
export const isEntityFailed = (entity) => {
	const status = entity.status?.toLowerCase();
	return ['failed', 'failure', 'abandoned'].some((k) => status?.includes(k));
};

/**
 * Determine the parent ID of an entity based on its relationships.
 * Prioritizes explicit parent relationships, then location containers.
 * @param {Object} entity - Entity object with relationships array
 * @returns {string|null} ID of the parent entity
 */
export const getParentId = (entity) => {
	const relationships = entity.relationships;
	if (!relationships || !Array.isArray(relationships)) return null;

	// 1. Check for explicit parent (Location hierarchy: Location -> Parent Location)
	const parentRel = relationships.find(
		(r) =>
			(r.type === 'parent_location' || r.type === 'parent') && (r.direction === 'outgoing' || r.direction === undefined)
	);
	if (parentRel) return parentRel.entity_id;

	// 2. Check for location link (NPC hierarchy: NPC -> Location)
	if (entity.type === 'npc' || entity.type === 'encounter') {
		// Get ALL relationships to locations
		const locationRels = relationships.filter((r) => r.entity_type === 'location');

		if (locationRels.length > 0) {
			// Priority 1: Look for specific semantic types
			const primary = locationRels.find((r) =>
				['location', 'located_in', 'base', 'home', 'residence', 'origin', 'occurred_at'].includes(r.type?.toLowerCase())
			);

			// Priority 2: Fallback to the first location found (e.g. generic 'related')
			return primary ? primary.entity_id : locationRels[0].entity_id;
		}
	}

	return null;
};

--- END OF domain\entity\utils\entityUtils.js ---

--- FILE: domain\entity\utils\statusUtils.js ---
import { Sword, Shield, Circle, HelpCircle, CheckCircle2, XCircle, Clock } from 'lucide-react';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

/**
 * Rank definitions for sorting.
 * Lower number = Higher priority in lists.
 */
const AFFINITY_RANKS = {
	// Rank 1: Allies
	ally: 1,
	allies: 1,
	friend: 1,
	friendly: 1,
	helpful: 1,
	allied: 1,
	alliance: 1,
	aligned: 1,
	// Rank 2: Neutral
	neutral: 2,
	indifferent: 2,
	unknown: 2, // 'Unknown' faction status often implies neutral
	// Rank 3: Enemies
	enemy: 3,
	enemies: 3,
	hostile: 3,
	rival: 3,
	villain: 3,
	threat: 3,
	// Rank 99: Fallback
	other: 99,
};

/**
 * Calculate a numeric rank for an entity based on status/affinity string.
 * Used for sorting: Allies -> Neutral -> Enemies -> Unknown
 *
 * @param {string} statusOrAffinity
 * @returns {number} 1, 2, 3, or 99
 */
export const getAffinityRank = (statusOrAffinity) => {
	const key = (statusOrAffinity || '').toLowerCase();

	// Check for exact matches or substring matches
	for (const [term, rank] of Object.entries(AFFINITY_RANKS)) {
		if (key.includes(term)) return rank;
	}

	return 99;
};

/**
 * Get status icon based on entity type and status
 */
export const getStatusIcon = (status, type) => {
	const s = status?.toLowerCase() || 'unknown';

	// Quest-specific icons
	if (type === 'quest') {
		if (['active', 'in progress', 'started'].some((k) => s.includes(k))) {
			return { Icon: Circle, className: 'text-amber-500 fill-amber-500/20' };
		}
		if (['completed', 'finished', 'done', 'success'].some((k) => s.includes(k))) {
			return { Icon: CheckCircle2, className: 'text-emerald-600' };
		}
		if (['failed', 'failure'].some((k) => s.includes(k))) {
			return { Icon: XCircle, className: 'text-red-500' };
		}
		if (['abandoned', 'on-hold', 'paused'].some((k) => s.includes(k))) {
			return { Icon: Clock, className: 'text-slate-400' };
		}
		return { Icon: Circle, className: 'text-slate-300' };
	}

	// NPC/Faction affinity icons
	const rank = getAffinityRank(s);

	if (rank === 3) {
		// Enemy
		return { Icon: Sword, className: 'text-red-500 fill-red-500/10' };
	}
	if (rank === 1) {
		// Ally
		return { Icon: Shield, className: 'text-emerald-500 fill-emerald-500/10' };
	}
	// Neutral / Unknown
	return { Icon: Circle, className: 'text-muted-foreground/70' };
};

export const getStatusInfo = (entity) => {
	const statusRaw = entity.status || getAttributeValue(entity.attributes, ['status']);
	const affinityRaw = getAttributeValue(entity.attributes, ['affinity']);

	const displayStatus = affinityRaw && affinityRaw !== 'unknown' ? affinityRaw : statusRaw;
	const statusLower = displayStatus?.toLowerCase();

	return {
		raw: statusRaw,
		display: displayStatus,
		icon: getStatusIcon(displayStatus, entity.type),
		rank: getAffinityRank(displayStatus),
		isDead: statusLower === 'dead',
		isFailed: statusLower === 'failed',
		isCompleted: ['completed', 'finished', 'done', 'success'].some((k) => statusLower?.includes(k)),
	};
};

--- END OF domain\entity\utils\statusUtils.js ---

--- FILE: features\admin\api\adminService.js ---
import { supabase } from '@/shared/api/supabaseClient';
import { getStrategy } from '@/features/admin/config/adminStrategies';

/**
 * Helper to determine which column stores JSON attributes.
 */
const getAttrColumn = (type) => 'attributes';

/**
 * Escape Regex characters for JS processing
 */
function escapeRegExp(string) {
	return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Escape SQL Like wildcards (% and _) for RPC calls
 */
function escapeSqlLike(string) {
	return string.replace(/[%_]/g, '\\$&');
}

export const createEntity = async (type, data) => {
	const strategy = getStrategy(type);
	const attrCol = getAttrColumn(type);

	// 1. Prepare Core Payload
	const corePayload = {};

	// Standard campaign_id link for non-campaign entities
	if (type !== 'campaign' && data.campaign_id) {
		corePayload.campaign_id = data.campaign_id;
	}

	// Map generic name/description to specific table columns
	if (strategy.colMapping) {
		if (data.name) corePayload[strategy.colMapping.name] = data.name;
		if (data.description) corePayload[strategy.colMapping.description] = data.description;
	}

	if (strategy.primaryTable === 'entities') corePayload.type = type;

	// 2. Process Attributes -> JSONB
	const rawAttributes =
		data.attributesList ||
		(data.attributes ? Object.entries(data.attributes).map(([k, v]) => ({ name: k, value: v })) : []);

	const jsonStorage = {};

	rawAttributes.forEach((attr) => {
		jsonStorage[attr.name] = attr.value;
	});

	// --- FIX START: Extract campaign_id from attributes for the Campaign table itself ---
	if (type === 'campaign' && jsonStorage.campaign_id !== undefined) {
		// The 'campaigns' table requires an integer 'campaign_id' column
		corePayload.campaign_id = parseInt(jsonStorage.campaign_id, 10);
	}
	// --- FIX END ---

	corePayload[attrCol] = jsonStorage;

	// 3. Insert Single Row
	const { data: insertedRecord, error: insertError } = await supabase
		.from(strategy.primaryTable)
		.insert(corePayload)
		.select()
		.single();

	if (insertError) throw insertError;

	return insertedRecord;
};

export const updateEntity = async (type, id, data) => {
	const strategy = getStrategy(type);
	const attrCol = getAttrColumn(type);

	const corePayload = {};
	if (strategy.colMapping) {
		if (data.name) corePayload[strategy.colMapping.name] = data.name;
		if (data.description) corePayload[strategy.colMapping.description] = data.description;
	}

	const rawAttributes =
		data.attributesList ||
		(data.attributes ? Object.entries(data.attributes).map(([k, v]) => ({ name: k, value: v })) : []);

	const jsonStorage = {};

	rawAttributes.forEach((attr) => {
		jsonStorage[attr.name] = attr.value;
	});

	// --- FIX START: Sync campaign_id column on update for Campaigns ---
	if (type === 'campaign' && jsonStorage.campaign_id !== undefined) {
		corePayload.campaign_id = parseInt(jsonStorage.campaign_id, 10);
	}
	// --- FIX END ---

	corePayload[attrCol] = jsonStorage;

	const { error: updateError } = await supabase.from(strategy.primaryTable).update(corePayload).eq('id', id);

	if (updateError) throw updateError;
	return { success: true };
};

export const fetchRawEntity = async (type, id) => {
	const strategy = getStrategy(type);
	const attrCol = getAttrColumn(type);

	const { data: coreData, error: coreError } = await supabase
		.from(strategy.primaryTable)
		.select('*')
		.eq('id', id)
		.single();

	if (coreError) throw coreError;

	const formData = { ...coreData };
	if (strategy.colMapping) {
		Object.entries(strategy.colMapping).forEach(([formField, dbCol]) => {
			if (coreData[dbCol] !== undefined) {
				formData[formField] = coreData[dbCol];
			}
		});
	}

	const attributesList = [];
	const jsonSource = coreData[attrCol] || {};

	Object.entries(jsonSource).forEach(([key, value]) => {
		attributesList.push({ name: key, value: value });
	});

	if (strategy.defaultAttributes) {
		strategy.defaultAttributes.forEach((defAttr) => {
			if (coreData[defAttr.key] !== undefined && !jsonSource[defAttr.key]) {
				attributesList.push({
					name: defAttr.key,
					value: coreData[defAttr.key],
				});
			}
		});
	}

	return { ...formData, attributesList };
};

export const fetchRelationships = async (id) => {
	const { data, error } = await supabase
		.from('entity_relationships')
		.select(
			`
            id,
            relationship_type,
            description,
            is_bidirectional,
            is_hidden,
            target:entities!to_entity_id ( id, name, type )
        `
		)
		.eq('from_entity_id', id);

	if (error) throw error;
	return data;
};

export const addRelationship = async (payload) => {
	const { data, error } = await supabase.from('entity_relationships').insert(payload).select().single();
	if (error) throw error;
	return data;
};

export const deleteRelationship = async (relId) => {
	const { error } = await supabase.from('entity_relationships').delete().eq('id', relId);
	if (error) throw error;
	return true;
};

export const fetchChildRows = async (table, foreignKeyCol, parentId, orderBy = 'id') => {
	const { data, error } = await supabase
		.from(table)
		.select('*')
		.eq(foreignKeyCol, parentId)
		.order(orderBy, { ascending: true });
	if (error) throw error;
	return data;
};

export const upsertSessionEvent = async (eventData) => {
	const payload = { ...eventData };
	if (String(payload.id).startsWith('new')) delete payload.id;
	const { data, error } = await supabase.from('session_events').upsert(payload).select().single();
	if (error) throw error;
	return data;
};

export const deleteRow = async (table, id) => {
	const { error } = await supabase.from(table).delete().eq('id', id);
	if (error) throw error;
	return true;
};

export const upsertQuestObjective = async (objectiveData) => {
	const payload = { ...objectiveData };
	if (String(payload.id).startsWith('new')) delete payload.id;
	const { data, error } = await supabase.from('quest_objectives').upsert(payload).select().single();
	if (error) throw error;
	return data;
};

export const deleteEntity = async (type, id) => {
	const strategy = getStrategy(type);
	const { error: mainError } = await supabase.from(strategy.primaryTable).delete().eq('id', id);
	if (mainError) throw mainError;
	return true;
};

export const updateRelationship = async (relId, updates) => {
	const { error } = await supabase.from('entity_relationships').update(updates).eq('id', relId);
	if (error) throw error;
	return true;
};

export const searchEntitiesByName = async (campaignId, query) => {
	if (!query) return [];

	const cleanQuery = escapeSqlLike(query);

	const { data, error } = await supabase.rpc('api_search_entities', {
		p_campaign_id: campaignId,
		p_search_term: cleanQuery,
	});

	if (error) {
		console.error('Search RPC failed', error);
		throw error;
	}

	return data || [];
};

export const getSessionList = async (campaignId) => {
	const { data, error } = await supabase
		.from('sessions')
		.select('id, title')
		.eq('campaign_id', campaignId)
		.order('title', { ascending: true });
	if (error) throw error;
	return data;
};

export const fetchSessionEventsWithRelationships = async (sessionId) => {
	const { data: events, error: eventError } = await supabase
		.from('session_events')
		.select('*')
		.eq('session_id', sessionId)
		.order('event_order', { ascending: true });

	if (eventError) throw eventError;
	if (!events || events.length === 0) return [];

	const eventIds = events.map((e) => e.id);
	const { data: rels, error: relError } = await supabase
		.from('entity_relationships')
		.select(
			`
            id,
            from_entity_id,
            target:entities!to_entity_id ( id, name, type )
        `
		)
		.in('from_entity_id', eventIds);

	if (relError) throw relError;

	const relMap = {};
	rels.forEach((r) => {
		if (!relMap[r.from_entity_id]) relMap[r.from_entity_id] = [];
		relMap[r.from_entity_id].push(r);
	});

	return events.map((e) => ({
		...e,
		relationships: relMap[e.id] || [],
	}));
};

export const fetchEncounterActions = async (encounterId) => {
	const { data, error } = await supabase
		.from('encounter_actions')
		.select(
			`
			*,
			actor:entities!actor_entity_id(name, type),
			target:entities!target_entity_id(name, type)
		`
		)
		.eq('encounter_id', encounterId)
		.order('round_number', { ascending: true })
		.order('action_order', { ascending: true });
	if (error) throw error;
	return data;
};

export const upsertEncounterAction = async (actionData) => {
	const payload = { ...actionData };
	if (String(payload.id).startsWith('new')) delete payload.id;
	delete payload.actor;
	delete payload.target;
	if (payload.round_number) payload.round_number = parseInt(payload.round_number);
	if (payload.action_order) payload.action_order = parseInt(payload.action_order);
	if (payload.actor_entity_id === '') payload.actor_entity_id = null;
	if (payload.target_entity_id === '') payload.target_entity_id = null;

	const { data, error } = await supabase.from('encounter_actions').upsert(payload).select().single();
	if (error) throw error;
	return data;
};

export const getBulkReplacePreview = async (campaignId, findTerm, replaceTerm) => {
	if (!findTerm || !findTerm.trim()) return [];

	const safeReplace = replaceTerm === undefined || replaceTerm === null ? '' : replaceTerm;

	const { data, error } = await supabase.rpc('api_scan_campaign_text', {
		p_campaign_id: campaignId,
		p_term: findTerm.trim(),
	});

	if (error) {
		console.error('Scan RPC failed', error);
		throw error;
	}

	const escapedTerm = escapeRegExp(findTerm.trim());
	const regex = new RegExp(escapedTerm, 'gi');

	return data.map((row) => ({
		table: row.table_name,
		id: row.record_id,
		field: row.field_name,
		context: row.context,
		original: row.current_value,
		proposal: row.current_value.replace(regex, safeReplace),
	}));
};

export const executeBulkReplace = async (changeList) => {
	const results = { count: 0 };
	for (const change of changeList) {
		const { error } = await supabase
			.from(change.table)
			.update({ [change.field]: change.proposal })
			.eq('id', change.id);
		if (!error) results.count++;
	}
	return results;
};

--- END OF features\admin\api\adminService.js ---

--- FILE: features\admin\components\AdminForm.jsx ---
import React, { useEffect, useState, useRef } from 'react';
import { useForm, useFieldArray } from 'react-hook-form';
import { useQueryClient } from '@tanstack/react-query';
import { getStrategy } from '@/features/admin/config/adminStrategies';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { createEntity, fetchRawEntity, updateEntity } from '@/features/admin/api/adminService';
import Button from '@/shared/components/ui/Button';
import { Save, RotateCcw, ExternalLink, Plus, Trash2, Code, Braces, AlignLeft, Hash } from 'lucide-react';
import { Link } from 'react-router-dom';
import { ADMIN_INPUT_CLASS, ADMIN_LABEL_CLASS, ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS } from './AdminFormStyles';

// Inputs
import MarkdownEditor from '@/features/admin/components/MarkdownEditor';
import SmartImageInput from '@/features/admin/components/SmartImageInput';

// Sub-Managers
import SessionEventManager from './SessionEventManager';
import QuestObjectiveManager from '@/features/admin/components/QuestObjectiveManager';
import RelationshipManager from '@/features/admin/components/RelationshipManager';
import EncounterActionManager from './EncounterManager';
import TacticalMapManager from './TacticalMapManager';

const AutoSizeTextarea = ({ register, path, placeholder, className }) => {
	const { ref, ...rest } = register(path);
	const textareaRef = useRef(null);

	const adjustHeight = () => {
		const el = textareaRef.current;
		if (el) {
			el.style.height = 'auto';
			el.style.height = el.scrollHeight + 2 + 'px';
		}
	};

	return (
		<textarea
			{...rest}
			ref={(e) => {
				ref(e);
				textareaRef.current = e;
			}}
			rows={1}
			onInput={adjustHeight}
			placeholder={placeholder}
			className={`${className} min-h-[42px] py-2 resize-none overflow-hidden font-mono text-sm`}
			onFocus={adjustHeight}
		/>
	);
};

export default function AdminForm({ type, id }) {
	const strategy = getStrategy(type);
	const { campaignId } = useCampaign();
	const queryClient = useQueryClient();
	const [isLoading, setIsLoading] = useState(false);
	const [isSaving, setIsSaving] = useState(false);

	const {
		register,
		control,
		handleSubmit,
		reset,
		watch,
		setValue,
		formState: { errors },
	} = useForm({
		defaultValues: {
			attributes: {},
			customAttributes: [],
		},
	});
	const { fields, append, remove } = useFieldArray({ control, name: 'customAttributes' });

	// --- 1. LOADER LOGIC ---
	useEffect(() => {
		const loadEntity = async () => {
			setIsLoading(true);
			try {
				if (!id) {
					reset({ attributes: {}, customAttributes: [] });
					setIsLoading(false);
					return;
				}
				const rawData = await fetchRawEntity(type, id);

				const definedKeys = strategy.defaultAttributes.map((a) => a.key);
				const standardAttrs = {};
				const customAttrs = [];

				(rawData.attributesList || []).forEach((attr) => {
					const key = attr.name;
					let value = attr.value;
					let dataType = 'string';

					// FIX: Detect Object/Array explicitly
					if (typeof value === 'object' && value !== null) {
						value = JSON.stringify(value, null, 2);
						dataType = 'json';
					} else if (typeof value === 'number') {
						dataType = 'number';
					}

					if (definedKeys.includes(key)) {
						if (!standardAttrs[key]) standardAttrs[key] = value;
						// For standard attrs, we don't push to custom array
					} else {
						customAttrs.push({ key, value, type: dataType });
					}
				});

				reset({
					...rawData,
					attributes: standardAttrs,
					customAttributes: customAttrs,
				});
			} catch (err) {
				console.error(err);
				alert('Error loading entity.');
			} finally {
				setIsLoading(false);
			}
		};
		loadEntity();
	}, [type, id, reset, strategy]);

	// --- 2. SAVER LOGIC ---
	const onSubmit = async (data) => {
		if (!campaignId && type !== 'campaign') {
			alert('No Campaign Selected!');
			return;
		}

		const attributesList = [];

		// Process Standard Attributes
		Object.entries(data.attributes).forEach(([key, value]) => {
			if (value && String(value).trim() !== '') {
				attributesList.push({ name: key, value });
			}
		});

		// Process Custom Attributes with Explicit Types
		data.customAttributes.forEach((item) => {
			if (item.key && item.key.trim() !== '') {
				let finalValue = item.value;

				// Explicit Type Casting
				if (item.type === 'number') {
					finalValue = Number(item.value);
				} else if (item.type === 'json') {
					try {
						finalValue = JSON.parse(item.value);
					} catch (e) {
						// Fallback: save as string if invalid JSON, but warn user ideally
						console.warn(`Failed to parse JSON for ${item.key}, saving as string.`);
					}
				}

				attributesList.push({ name: item.key, value: finalValue });
			}
		});

		const payload = {
			...data,
			attributesList,
		};
		delete payload.attributes;
		delete payload.customAttributes;

		setIsSaving(true);
		try {
			if (id) {
				await updateEntity(type, id, payload);
			} else {
				await createEntity(type, { ...payload, campaign_id: campaignId });
				if (!id) reset();
			}

			queryClient.invalidateQueries();
		} catch (error) {
			alert(`Error: ${error.message}`);
		} finally {
			setIsSaving(false);
		}
	};

	const handleFormatJSON = (index) => {
		const currentVal = watch(`customAttributes.${index}.value`);
		try {
			const parsed = JSON.parse(currentVal);
			setValue(`customAttributes.${index}.value`, JSON.stringify(parsed, null, 2));
		} catch (e) {
			alert('Invalid JSON: ' + e.message);
		}
	};

	if (isLoading) return <div className='p-8 text-center text-muted-foreground text-sm'>Loading editor...</div>;

	const mapImageUrl = watch('attributes.map_image') || watch('attributes.map');

	// Helper to sync Tactical Map to Custom Attrs
	const customAttrs = watch('customAttributes') || [];
	const standardMarkers = watch('attributes.map_markers');
	const customMarkers = customAttrs.find((a) => a.key === 'map_markers')?.value;
	const activeMarkersValue = standardMarkers || customMarkers || '[]';

	const handleMarkersChange = (jsonValue) => {
		const customIdx = customAttrs.findIndex((a) => a.key === 'map_markers');
		if (customIdx >= 0) {
			setValue(`customAttributes.${customIdx}.value`, jsonValue);
			setValue(`customAttributes.${customIdx}.type`, 'json'); // Ensure it's marked as JSON
		} else {
			setValue('attributes.map_markers', jsonValue);
		}
	};

	return (
		<form onSubmit={handleSubmit(onSubmit)} className='space-y-5 animate-in slide-in-from-bottom-2 duration-300 pb-20'>
			{/* Top Bar */}
			<div className='flex items-center justify-between bg-background border border-border p-3 rounded-lg shadow-sm sticky top-0 z-20 backdrop-blur-md bg-background/80'>
				<div className='flex items-center gap-2'>
					<span className={`w-2 h-2 rounded-full ${id ? 'bg-amber-500/100' : 'bg-emerald-500/100'}`} />
					<span className='text-xs font-bold uppercase tracking-wider text-muted-foreground'>
						{id ? 'Edit Mode' : 'Create Mode'}
					</span>
				</div>
				<div className='flex gap-2'>
					{id && (
						<Link
							to={`/wiki/${type}/${id}`}
							target='_blank'
							className='flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-primary bg-card hover:border-primary border border-border rounded-md transition-colors'>
							<ExternalLink size={14} /> View Live
						</Link>
					)}
					<Button type='button' variant='secondary' size='sm' icon={RotateCcw} onClick={() => reset()}>
						Reset
					</Button>
					<Button type='submit' variant='primary' size='sm' icon={Save} disabled={isSaving}>
						{isSaving ? 'Saving...' : 'Save Changes'}
					</Button>
				</div>
			</div>

			{/* Core Details */}
			<div className={ADMIN_SECTION_CLASS}>
				<h2 className={ADMIN_HEADER_CLASS}>Core Details</h2>
				<div className='grid grid-cols-1 gap-4'>
					<div>
						<label className={ADMIN_LABEL_CLASS}>Name / Title</label>
						<input
							type='text'
							{...register('name', { required: true })}
							className={ADMIN_INPUT_CLASS}
							placeholder='Entity Name...'
						/>
						{errors.name && <span className='text-xs text-red-500 mt-1'>Required</span>}
					</div>

					{strategy.hasNarrative && (
						<div>
							<MarkdownEditor
								label='Description / Narrative'
								rows={8}
								value={watch('description') || ''}
								onChange={(e) => setValue('description', e.target.value)}
								placeholder='Write description using Markdown...'
							/>
						</div>
					)}
				</div>
			</div>

			{mapImageUrl && (
				<TacticalMapManager imageUrl={mapImageUrl} value={activeMarkersValue} onChange={handleMarkersChange} />
			)}

			{/* Attributes */}
			<div className={ADMIN_SECTION_CLASS}>
				<h2 className={ADMIN_HEADER_CLASS}>{strategy.label} Attributes</h2>
				<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
					{strategy.defaultAttributes.map((attr) => (
						<div key={attr.key}>
							<label className={ADMIN_LABEL_CLASS}>{attr.label}</label>
							{attr.type === 'image' ? (
								<SmartImageInput
									value={watch(`attributes.${attr.key}`)}
									onChange={(e) => setValue(`attributes.${attr.key}`, e.target.value)}
									placeholder='images/...'
								/>
							) : attr.type === 'select' ? (
								<select {...register(`attributes.${attr.key}`)} className={ADMIN_INPUT_CLASS}>
									<option value=''>Select...</option>
									{attr.options.map((opt) => (
										<option key={opt} value={opt}>
											{opt}
										</option>
									))}
								</select>
							) : (
								<input
									type={attr.type === 'number' ? 'number' : 'text'}
									{...register(`attributes.${attr.key}`)}
									className={ADMIN_INPUT_CLASS}
								/>
							)}
						</div>
					))}
				</div>
			</div>

			{/* Custom Attributes */}
			<div className={ADMIN_SECTION_CLASS}>
				<div className={ADMIN_HEADER_CLASS}>
					<span>Custom Attributes</span>
					<Button
						type='button'
						onClick={() => append({ key: '', value: '', type: 'string' })}
						size='sm'
						variant='secondary'
						icon={Plus}>
						Add New
					</Button>
				</div>

				<div className='space-y-3'>
					{fields.map((field, index) => {
						const attrType = watch(`customAttributes.${index}.type`);
						return (
							<div key={field.id} className='flex gap-2 items-start animate-in fade-in group'>
								{/* Key Input */}
								<div className='w-1/4 pt-1'>
									<input
										type='text'
										{...register(`customAttributes.${index}.key`)}
										placeholder='Key'
										className={`${ADMIN_INPUT_CLASS} font-bold text-muted-foreground border-transparent bg-transparent hover:bg-accent/50 focus:bg-background focus:border-input transition-all`}
									/>
								</div>

								{/* Type Selector */}
								<div className='w-24 pt-1'>
									<div className='relative'>
										<select
											{...register(`customAttributes.${index}.type`)}
											className={`${ADMIN_INPUT_CLASS} pr-8 appearance-none text-xs`}>
											<option value='string'>Text</option>
											<option value='number'>Number</option>
											<option value='json'>JSON</option>
										</select>
										<div className='absolute right-2 top-2.5 pointer-events-none text-muted-foreground'>
											{attrType === 'json' ? (
												<Braces size={12} />
											) : attrType === 'number' ? (
												<Hash size={12} />
											) : (
												<AlignLeft size={12} />
											)}
										</div>
									</div>
								</div>

								{/* Value Input */}
								<div className='flex-1 relative'>
									<AutoSizeTextarea
										register={register}
										path={`customAttributes.${index}.value`}
										placeholder='Value'
										className={ADMIN_INPUT_CLASS}
									/>

									{/* JSON Format Button */}
									{attrType === 'json' && (
										<button
											type='button'
											onClick={() => handleFormatJSON(index)}
											className='absolute right-2 top-2 text-[10px] bg-card text-primary px-1.5 py-0.5 rounded border border-border hover:border-primary transition-colors'>
											Format
										</button>
									)}
								</div>

								<button
									type='button'
									onClick={() => remove(index)}
									className='mt-2 p-1.5 text-muted-foreground/40 hover:text-primary hover:bg-red-500/10 rounded transition-colors'>
									<Trash2 size={16} />
								</button>
							</div>
						);
					})}
					{fields.length === 0 && (
						<div className='text-sm text-muted-foreground italic py-2'>No custom attributes defined.</div>
					)}
				</div>
			</div>

			{/* Sub Managers */}
			{id && type === 'session' && <SessionEventManager sessionId={id} />}
			{id && type === 'quest' && <QuestObjectiveManager questId={id} />}
			{id && type === 'encounter' && <EncounterActionManager encounterId={id} />}
			{id && <RelationshipManager entityId={id} />}
		</form>
	);
}

--- END OF features\admin\components\AdminForm.jsx ---

--- FILE: features\admin\components\AdminFormStyles.js ---
export const ADMIN_INPUT_CLASS =
	'w-full px-3 py-2 bg-background border border-border rounded-md text-sm text-foreground focus:outline-none focus:ring-1 focus:ring-primary placeholder:text-muted-foreground/40 transition-all shadow-sm';

export const ADMIN_LABEL_CLASS =
	'block text-[10px] font-bold text-muted-foreground uppercase tracking-[0.1em] mb-1.5 ml-0.5';

export const ADMIN_SECTION_CLASS = 'bg-card border border-border rounded-xl p-5 shadow-sm space-y-4 relative';

export const ADMIN_HEADER_CLASS =
	'text-base font-serif font-bold text-foreground border-b border-border/60 pb-2 mb-4 flex items-center justify-between tracking-tight';

--- END OF features\admin\components\AdminFormStyles.js ---

--- FILE: features\admin\components\EncounterManager.jsx ---
import React, { useEffect, useState } from 'react';
import { Plus, Trash2, Edit2, Save, X, Swords, Skull, Target, Zap, HeartHandshake } from 'lucide-react'; // Added HeartHandshake
import { fetchEncounterActions, upsertEncounterAction, deleteRow } from '@/features/admin/api/adminService';
import { ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS, ADMIN_INPUT_CLASS, ADMIN_LABEL_CLASS } from './AdminFormStyles';
import EntitySearch from './EntitySearch';
import Button from '@/shared/components/ui/Button';

export default function EncounterActionManager({ encounterId }) {
	const [actions, setActions] = useState([]);
	const [loading, setLoading] = useState(false);
	const [editingId, setEditingId] = useState(null);
	const [formData, setFormData] = useState({});

	useEffect(() => {
		if (encounterId) loadActions();
	}, [encounterId]);

	const loadActions = async () => {
		setLoading(true);
		try {
			const data = await fetchEncounterActions(encounterId);
			setActions(data);
		} catch (e) {
			console.error(e);
		} finally {
			setLoading(false);
		}
	};

	const handleAddNew = () => {
		const lastAction = actions[actions.length - 1];
		const nextRound = lastAction ? lastAction.round_number : 1;
		const nextOrder = lastAction ? lastAction.action_order + 1 : 1;

		const newAction = {
			id: `new-${Date.now()}`,
			encounter_id: encounterId,
			round_number: nextRound,
			action_order: nextOrder,
			actor_name: '',
			action_description: '',
			action_type: 'attack',
			result: '',
			effect: '',
			is_friendly: false, // Default to hostile
		};
		setActions([...actions, newAction]);
		handleEdit(newAction);
	};

	const handleEdit = (action) => {
		setEditingId(action.id);
		setFormData({ ...action });
	};

	const handleSave = async () => {
		try {
			await upsertEncounterAction(formData);
			setEditingId(null);
			loadActions();
		} catch (e) {
			alert('Error saving action: ' + e.message);
		}
	};

	const handleDelete = async (id) => {
		if (!confirm('Delete this turn?')) return;
		if (String(id).startsWith('new')) {
			setActions(actions.filter((a) => a.id !== id));
			return;
		}
		try {
			await deleteRow('encounter_actions', id);
			loadActions();
		} catch (e) {
			alert(e.message);
		}
	};

	const setActor = (entity) =>
		setFormData((prev) => ({ ...prev, actor_entity_id: entity.id, actor_name: entity.name }));
	const setTarget = (entity) =>
		setFormData((prev) => ({ ...prev, target_entity_id: entity.id, target_name: entity.name }));

	return (
		<div className={ADMIN_SECTION_CLASS}>
			<div className={`${ADMIN_HEADER_CLASS} flex items-center justify-between`}>
				<span className='flex items-center gap-2'>
					<Swords size={18} className='text-red-600' /> Combat Tracker
				</span>
				<Button onClick={handleAddNew} size='sm' variant='secondary' icon={Plus}>
					Add Turn
				</Button>
			</div>

			<div className='space-y-4'>
				{actions.map((action) => {
					const isFriendly = action.is_friendly;
					const theme = isFriendly
						? {
								border: 'border-emerald-200 hover:border-emerald-300',
								bg: 'bg-emerald-500/10/20',
								accentText: 'text-emerald-700',
								badge: 'bg-emerald-100 text-emerald-800 border-emerald-200',
						  }
						: {
								border: 'border-red-200 hover:border-red-300',
								bg: 'bg-background',
								accentText: 'text-red-700',
								badge: 'bg-red-500/10 text-red-700 border-red-100',
						  };

					return (
						<div key={action.id} className='group'>
							{editingId === action.id ? (
								/* --- EDIT MODE --- */
								<div className='bg-muted/30 border border-border rounded-lg p-4 space-y-3 animate-in fade-in shadow-sm'>
									{/* Row 1: Timing & Type */}
									<div className='flex gap-3 items-end'>
										<div className='w-16'>
											<label className={ADMIN_LABEL_CLASS}>Round</label>
											<input
												type='number'
												className={ADMIN_INPUT_CLASS}
												value={formData.round_number}
												onChange={(e) => setFormData({ ...formData, round_number: e.target.value })}
											/>
										</div>
										<div className='w-16'>
											<label className={ADMIN_LABEL_CLASS}>Order</label>
											<input
												type='number'
												className={ADMIN_INPUT_CLASS}
												value={formData.action_order}
												onChange={(e) => setFormData({ ...formData, action_order: e.target.value })}
											/>
										</div>
										<div className='flex-1'>
											<label className={ADMIN_LABEL_CLASS}>Action Type</label>
											<select
												className={ADMIN_INPUT_CLASS}
												value={formData.action_type || 'attack'}
												onChange={(e) => setFormData({ ...formData, action_type: e.target.value })}>
												<option value='attack'>Attack</option>
												<option value='action'>Action</option>
												<option value='bonus_action'>Bonus Action</option>
												<option value='spell'>Spell</option>
												<option value='move'>Movement</option>
												<option value='item'>Item Interaction</option>
												<option value='check'>Skill Check</option>
												<option value='save'>Saving Throw</option>
												<option value='legendary'>Legendary Action</option>
												<option value='lair'>Lair Action</option>
											</select>
										</div>
										<label className='flex items-center gap-2 cursor-pointer select-none border border-border rounded-md px-3 py-2 bg-background h-[38px] hover:border-emerald-300 transition-colors'>
											<input
												type='checkbox'
												checked={formData.is_friendly || false}
												onChange={(e) => setFormData({ ...formData, is_friendly: e.target.checked })}
												className='w-4 h-4 text-emerald-600 rounded focus:ring-emerald-500 cursor-pointer'
											/>
											<span className='text-xs font-bold text-foreground'>Friendly?</span>
										</label>
									</div>

									{/* Row 2: Actor & Target */}
									<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
										<div>
											<label className={ADMIN_LABEL_CLASS}>Actor (Who?)</label>
											{formData.actor_entity_id ? (
												<div className='flex gap-2 items-center'>
													<input
														className={`${ADMIN_INPUT_CLASS} bg-emerald-500/10 font-medium`}
														readOnly
														value={formData.actor_name || 'Linked Entity'}
													/>
													<Button
														size='sm'
														variant='ghost'
														onClick={() => setFormData({ ...formData, actor_entity_id: null, actor_name: '' })}>
														Change
													</Button>
												</div>
											) : (
												<div className='space-y-1'>
													<EntitySearch onSelect={setActor} />
													<input
														type='text'
														placeholder='Or type manual name...'
														className={ADMIN_INPUT_CLASS}
														value={formData.actor_name || ''}
														onChange={(e) => setFormData({ ...formData, actor_name: e.target.value })}
													/>
												</div>
											)}
										</div>

										<div>
											<label className={ADMIN_LABEL_CLASS}>Target (Whom?)</label>
											{formData.target_entity_id ? (
												<div className='flex gap-2 items-center'>
													<input
														className={`${ADMIN_INPUT_CLASS} bg-red-500/10 font-medium`}
														readOnly
														value={formData.target_name || 'Linked Entity'}
													/>
													<Button
														size='sm'
														variant='ghost'
														onClick={() => setFormData({ ...formData, target_entity_id: null, target_name: '' })}>
														Change
													</Button>
												</div>
											) : (
												<div className='space-y-1'>
													<EntitySearch onSelect={setTarget} />
													<input
														type='text'
														placeholder='Or type manual name...'
														className={ADMIN_INPUT_CLASS}
														value={formData.target_name || ''}
														onChange={(e) => setFormData({ ...formData, target_name: e.target.value })}
													/>
												</div>
											)}
										</div>
									</div>

									{/* Row 3: Description */}
									<div>
										<label className={ADMIN_LABEL_CLASS}>Description</label>
										<textarea
											rows={2}
											className={ADMIN_INPUT_CLASS}
											value={formData.action_description || ''}
											onChange={(e) => setFormData({ ...formData, action_description: e.target.value })}
											placeholder='Uses Multiattack...'
										/>
									</div>

									{/* Row 4: Result & Effect */}
									<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
										<div>
											<label className={ADMIN_LABEL_CLASS}>Result (Hit/Miss/Save)</label>
											<input
												type='text'
												className={ADMIN_INPUT_CLASS}
												value={formData.result || ''}
												onChange={(e) => setFormData({ ...formData, result: e.target.value })}
												placeholder='e.g., Hit (24), Crit, Failed Save'
											/>
										</div>
										<div>
											<label className={ADMIN_LABEL_CLASS}>Effect (Damage/Status)</label>
											<input
												type='text'
												className={ADMIN_INPUT_CLASS}
												value={formData.effect || ''}
												onChange={(e) => setFormData({ ...formData, effect: e.target.value })}
												placeholder='e.g., 23 slashing dmg, Prone'
											/>
										</div>
									</div>

									<div className='flex justify-end gap-3 pt-2'>
										<Button
											onClick={() => {
												setEditingId(null);
												loadActions();
											}}
											variant='ghost'
											size='sm'
											icon={X}>
											Cancel
										</Button>
										<Button onClick={handleSave} variant='primary' size='sm' icon={Save}>
											Save Turn
										</Button>
									</div>
								</div>
							) : (
								/* --- VIEW MODE --- */
								<div
									className={`flex items-start gap-3 p-3 border rounded-lg transition-colors ${theme.bg} ${theme.border}`}>
									<div className='flex flex-col items-center justify-center w-10 shrink-0'>
										<span className='text-[9px] font-bold uppercase text-muted-foreground'>Round</span>
										<span className={`text-lg font-serif font-bold ${theme.accentText}`}>{action.round_number}</span>
									</div>

									<div className='flex-1 min-w-0'>
										<div className='flex items-center gap-2 mb-1 flex-wrap'>
											<span className='text-sm font-bold text-foreground'>{action.actor_name || 'Unknown Actor'}</span>

											{/* Friendly/Hostile Icon Indicator */}
											{isFriendly ? (
												<HeartHandshake size={14} className='text-emerald-500' title='Friendly Action' />
											) : (
												<span className='text-[10px] uppercase tracking-wider text-muted-foreground'>used</span>
											)}

											<span className={`px-1.5 py-0.5 border rounded text-[10px] font-bold uppercase ${theme.badge}`}>
												{action.action_type}
											</span>
											{action.target_name && (
												<>
													<span className='text-[10px] text-muted-foreground'>on</span>
													<span className='text-sm font-medium text-foreground'>{action.target_name}</span>
												</>
											)}
										</div>

										<p className='text-xs text-muted-foreground mb-1'>{action.action_description}</p>

										<div className='flex items-center gap-2 mt-2'>
											{action.result && (
												<div className='flex items-center gap-1.5 text-xs font-semibold text-slate-700 bg-muted px-2 py-0.5 rounded border border-border'>
													<Target size={12} /> {action.result}
												</div>
											)}
											{action.effect && (
												<div className='flex items-center gap-1.5 text-xs font-semibold text-red-800 bg-red-500/10 px-2 py-0.5 rounded border border-red-100'>
													<Zap size={12} /> {action.effect}
												</div>
											)}
										</div>
									</div>

									<div className='flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity'>
										<button
											onClick={() => handleEdit(action)}
											className='p-2 text-muted-foreground hover:text-blue-600 hover:bg-blue-500/10 rounded-md transition-colors'>
											<Edit2 size={16} />
										</button>
										<button
											onClick={() => handleDelete(action.id)}
											className='p-2 text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors'>
											<Trash2 size={16} />
										</button>
									</div>
								</div>
							)}
						</div>
					);
				})}

				{actions.length === 0 && !loading && (
					<div className='text-center py-8 text-muted-foreground text-sm italic'>No combat turns recorded yet.</div>
				)}
			</div>
		</div>
	);
}

--- END OF features\admin\components\EncounterManager.jsx ---

--- FILE: features\admin\components\EntitySearch.jsx ---
import React, { useState, useEffect, useRef } from 'react';
import { searchEntitiesByName } from '@/features/admin/api/adminService'; // <--- NEW IMPORT
import { useCampaign } from '@/features/campaign/CampaignContext';
import { Search, X, Loader2 } from 'lucide-react';

export default function EntitySearch({ onSelect }) {
	const { campaignId } = useCampaign();
	const [query, setQuery] = useState('');
	const [results, setResults] = useState([]);
	const [isOpen, setIsOpen] = useState(false);
	const [isLoading, setIsLoading] = useState(false);
	const wrapperRef = useRef(null);

	// Close on click outside
	useEffect(() => {
		function handleClickOutside(event) {
			if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
				setIsOpen(false);
			}
		}
		document.addEventListener('mousedown', handleClickOutside);
		return () => document.removeEventListener('mousedown', handleClickOutside);
	}, [wrapperRef]);

	useEffect(() => {
		const doSearch = async () => {
			if (query.length < 2) {
				setResults([]);
				return;
			}
			setIsLoading(true);
			try {
				// <--- USE NEW SERVICE HERE
				const flat = await searchEntitiesByName(campaignId, query);

				// Client-side Sorting: Exact Match > Starts With > Includes
				flat.sort((a, b) => {
					const nameA = (a.name || '').toLowerCase();
					const nameB = (b.name || '').toLowerCase();
					const q = query.toLowerCase();

					// 1. Exact Match Priority
					if (nameA === q && nameB !== q) return -1;
					if (nameB === q && nameA !== q) return 1;

					// 2. Starts With Priority
					if (nameA.startsWith(q) && !nameB.startsWith(q)) return -1;
					if (nameB.startsWith(q) && !nameA.startsWith(q)) return 1;

					// 3. Shortest Name Priority (Less noise)
					return nameA.length - nameB.length;
				});

				setResults(flat);
				setIsOpen(true);
			} catch (error) {
				console.error('Search failed', error);
			} finally {
				setIsLoading(false);
			}
		};

		const timeout = setTimeout(doSearch, 300);
		return () => clearTimeout(timeout);
	}, [query, campaignId]);

	const handleSelect = (item) => {
		onSelect(item);
		setQuery('');
		setIsOpen(false);
	};

	return (
		<div className='relative w-full' ref={wrapperRef}>
			{/* Label removed inside component for cleaner Bulk UI */}

			<div className='relative'>
				<input
					autoFocus
					type='text'
					value={query}
					onChange={(e) => {
						setQuery(e.target.value);
						if (!isOpen) setIsOpen(true);
					}}
					placeholder='Search by name...'
					className='w-full pl-9 pr-8 py-2 bg-background border border-border rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary shadow-sm transition-shadow'
				/>
				<Search className='absolute left-3 top-2.5 text-muted-foreground/60' size={14} />

				{query && (
					<button
						onClick={() => {
							setQuery('');
							setIsOpen(false);
						}}
						className='absolute right-2 top-2 text-muted-foreground hover:text-foreground p-0.5 rounded'>
						<X size={14} />
					</button>
				)}
			</div>

			{/* Dropdown Results */}
			{isOpen && (results.length > 0 || isLoading) && (
				<div className='absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-xl max-h-60 overflow-y-auto overflow-x-hidden animate-in fade-in zoom-in-95 duration-100'>
					{isLoading ? (
						<div className='p-3 text-center text-xs text-muted-foreground flex items-center justify-center gap-2'>
							<Loader2 size={14} className='animate-spin' /> Searching...
						</div>
					) : (
						results.map((item) => (
							<button
								key={item.id}
								type='button'
								onClick={() => handleSelect(item)}
								className='w-full text-left px-3 py-2 hover:bg-primary/5 border-b border-border/50 last:border-0 transition-colors group'>
								<div className='font-bold text-sm text-foreground group-hover:text-primary truncate'>{item.name}</div>
								<div className='flex items-center gap-2'>
									<span className='text-[10px] font-bold uppercase tracking-wider text-foreground bg-muted px-1.5 rounded group-hover:bg-primary/50'>
										{item.type}
									</span>
									{/* Description Snippet */}
									<span className='text-[10px] text-muted-foreground/60 truncate max-w-[200px]'>
										{item.description ? item.description.substring(0, 50) : ''}
									</span>
								</div>
							</button>
						))
					)}
				</div>
			)}

			{isOpen && !isLoading && results.length === 0 && query.length >= 2 && (
				<div className='absolute z-50 w-full mt-1 bg-card border border-border rounded-lg shadow-xl p-3 text-center text-xs text-muted-foreground'>
					No results for "{query}"
				</div>
			)}
		</div>
	);
}

--- END OF features\admin\components\EntitySearch.jsx ---

--- FILE: features\admin\components\EventTagger.jsx ---
import React, { useState, useEffect } from 'react';
import { X, Plus, Loader2 } from 'lucide-react';
import EntitySearch from './EntitySearch';
import { fetchRelationships, addRelationship, deleteRelationship } from '@/features/admin/api/adminService';

export default function EventTagger({ eventId }) {
	const [tags, setTags] = useState([]);
	const [loading, setLoading] = useState(false);
	const [isAdding, setIsAdding] = useState(false);

	// If it's a temporary event (unsaved), we can't tag yet
	const isTemp = String(eventId).startsWith('new-');

	useEffect(() => {
		if (!isTemp) loadTags();
	}, [eventId]);

	const loadTags = async () => {
		setLoading(true);
		try {
			const data = await fetchRelationships(eventId);
			setTags(data);
		} catch (e) {
			console.error(e);
		} finally {
			setLoading(false);
		}
	};

	const handleAdd = async (target) => {
		if (tags.find((t) => t.target?.id === target.id)) return;

		setIsAdding(true);
		try {
			await addRelationship({
				from_entity_id: eventId,
				to_entity_id: target.id,
				relationship_type: 'mention', // Standard type for events
				is_bidirectional: false,
			});
			loadTags();
		} catch (e) {
			alert(e.message);
		} finally {
			setIsAdding(false);
		}
	};

	const handleRemove = async (relId) => {
		try {
			await deleteRelationship(relId);
			setTags(tags.filter((t) => t.id !== relId));
		} catch (e) {
			alert(e.message);
		}
	};

	if (isTemp) {
		return <div className='text-xs text-amber-600 bg-amber-500/10 p-2 rounded'>Save this event to enable tagging.</div>;
	}

	return (
		<div className='space-y-2 mt-2 pt-2 border-t border-border/50'>
			<label className='text-[10px] font-bold uppercase text-muted-foreground'>Mentions / Related Entities</label>

			{/* Tag List */}
			<div className='flex flex-wrap gap-2 mb-2'>
				{tags.map((rel) => (
					<div
						key={rel.id}
						className='flex items-center gap-1 bg-card border border-border px-2 py-1 rounded-md text-xs shadow-sm'>
						<span className='font-medium text-foreground'>{rel.target?.name}</span>
						<span className='text-[9px] text-muted-foreground uppercase'>{rel.target?.type}</span>
						<button onClick={() => handleRemove(rel.id)} className='ml-1 text-muted-foreground/70 hover:text-red-500'>
							<X size={12} />
						</button>
					</div>
				))}
				{loading && <Loader2 size={14} className='animate-spin text-muted-foreground' />}
			</div>

			{/* Search Input */}
			<div className='max-w-xs'>
				<EntitySearch onSelect={handleAdd} />
			</div>
		</div>
	);
}

--- END OF features\admin\components\EventTagger.jsx ---

--- FILE: features\admin\components\ImageLibraryModal.jsx ---
import React, { useState } from 'react';
import { Search, Image as ImageIcon, FolderOpen, RefreshCw } from 'lucide-react';
import { Drawer } from '@/shared/components/ui/Drawer';
import { ADMIN_INPUT_CLASS } from './AdminFormStyles';
// IMPORT THE GENERATED FILE
import imageLibraryData from '../config/imageManifest.json';

export default function ImageLibraryModal({ isOpen, onClose, onSelect }) {
	const [searchTerm, setSearchTerm] = useState('');

	// Use the dynamic data from the script
	const filteredLibrary = imageLibraryData
		.map((cat) => ({
			...cat,
			files: cat.files.filter((f) => f.toLowerCase().includes(searchTerm.toLowerCase())),
		}))
		.filter((cat) => cat.files.length > 0);

	return (
		<Drawer isOpen={isOpen} onClose={onClose} title='Image Library' position='right'>
			<div className='p-4 space-y-6'>
				<div className='relative'>
					<Search className='absolute left-3 top-2.5 text-muted-foreground' size={14} />
					<input
						type='text'
						placeholder='Search for image or category...'
						className={ADMIN_INPUT_CLASS + ' pl-9'}
						value={searchTerm}
						onChange={(e) => setSearchTerm(e.target.value)}
						autoFocus
					/>
				</div>

				<div className='space-y-8 pb-20'>
					{filteredLibrary.map((group) => (
						<div key={group.category} className='space-y-3 animate-in fade-in slide-in-from-bottom-1 duration-300'>
							<h3 className='text-[9px] font-bold uppercase tracking-[0.2em] text-muted-foreground flex items-center gap-2'>
								<FolderOpen size={10} className='text-primary' />
								{group.category}
								<span className='text-[8px] font-normal lowercase tracking-normal bg-muted px-1.5 rounded-full'>
									{group.files.length} images
								</span>
							</h3>

							<div className='grid grid-cols-3 sm:grid-cols-4 gap-2'>
								{group.files.map((file) => {
									const fullPath = `${group.path}${file}`;
									const previewUrl = `${import.meta.env.BASE_URL}${fullPath}`;

									return (
										<button
											key={file}
											type='button'
											title={file}
											onClick={() => {
												onSelect(fullPath);
												onClose();
											}}
											className='group relative aspect-square rounded-md border border-border bg-card overflow-hidden hover:border-amber-500 hover:ring-2 hover:ring-amber-500/20 transition-all shadow-sm'>
											<img
												src={previewUrl}
												alt={file}
												className='w-full h-full object-cover group-hover:scale-110 transition-transform duration-500'
												loading='lazy'
											/>
											{/* Hover Overlay with filename */}
											<div className='absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-1'>
												<p className='text-[7px] text-white truncate w-full text-center font-mono'>{file}</p>
											</div>
										</button>
									);
								})}
							</div>
						</div>
					))}

					{filteredLibrary.length === 0 && (
						<div className='text-center py-20 opacity-30 flex flex-col items-center'>
							<ImageIcon size={40} strokeWidth={1} />
							<p className='text-xs mt-2'>No matching images found.</p>
						</div>
					)}
				</div>
			</div>
		</Drawer>
	);
}

--- END OF features\admin\components\ImageLibraryModal.jsx ---

--- FILE: features\admin\components\MarkdownEditor.jsx ---
// features/admin/components/MarkdownEditor.jsx
import React, { Suspense } from 'react';
import { Loader2 } from 'lucide-react';
import { ADMIN_LABEL_CLASS } from './AdminFormStyles';

const HeavyEditor = React.lazy(() => import('./MarkdownEditorImpl'));

export default function MarkdownEditor(props) {
	return (
		<Suspense fallback={<LoadingFallback label={props.label} />}>
			<HeavyEditor {...props} />
		</Suspense>
	);
}

function LoadingFallback({ label }) {
	return (
		<div className='flex flex-col gap-1.5'>
			{label && <label className={ADMIN_LABEL_CLASS}>{label}</label>}
			<div className='h-[230px] w-full border border-border rounded-lg bg-muted/10 flex items-center justify-center text-muted-foreground gap-2 animate-pulse'>
				<Loader2 size={20} className='animate-spin' />
				<span className='text-xs'>Loading Editor...</span>
			</div>
		</div>
	);
}

--- END OF features\admin\components\MarkdownEditor.jsx ---

--- FILE: features\admin\components\MarkdownEditorImpl.jsx ---
import React, { useState, useEffect } from 'react';
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Link from '@tiptap/extension-link';
import { Markdown } from 'tiptap-markdown';
import {
	Bold,
	Italic,
	List,
	Heading1,
	Heading2,
	Heading3,
	Quote,
	Code,
	Link as LinkIcon,
	Undo,
	Redo,
	AtSign,
	Wand2,
	X,
	FileCode,
	Eye,
} from 'lucide-react';
import EntitySearch from './EntitySearch';
import { ADMIN_LABEL_CLASS } from './AdminFormStyles';
import clsx from 'clsx';

// --- TOOLBAR COMPONENT ---
const MenuBar = ({ editor, mode, setMode, onMentionClick }) => {
	// Helper for buttons
	const Btn = ({ icon: Icon, onClick, isActive, disabled, title }) => (
		<button
			type='button'
			onClick={onClick}
			disabled={disabled}
			title={title}
			className={clsx(
				'p-1.5 rounded transition-colors flex items-center justify-center h-7 w-7',
				isActive ? 'bg-primary/20 text-primary' : 'text-muted-foreground hover:bg-muted hover:text-foreground',
				disabled && 'opacity-30 cursor-not-allowed'
			)}>
			<Icon size={14} strokeWidth={2.5} />
		</button>
	);

	return (
		<div className='flex items-center gap-1 p-1.5 border-b border-border bg-muted/20 select-none flex-wrap'>
			{/* Standard Formatting Tools - Only active in Visual Mode */}
			<div className={clsx('flex items-center gap-1', mode === 'source' && 'opacity-30 pointer-events-none grayscale')}>
				<Btn
					icon={Bold}
					title='Bold'
					onClick={() => editor?.chain().focus().toggleBold().run()}
					isActive={editor?.isActive('bold')}
				/>
				<Btn
					icon={Italic}
					title='Italic'
					onClick={() => editor?.chain().focus().toggleItalic().run()}
					isActive={editor?.isActive('italic')}
				/>
				<div className='w-px h-4 bg-border mx-1 opacity-50' />
				<Btn
					icon={Heading1}
					title='H1'
					onClick={() => editor?.chain().focus().toggleHeading({ level: 1 }).run()}
					isActive={editor?.isActive('heading', { level: 1 })}
				/>
				<Btn
					icon={Heading2}
					title='H2'
					onClick={() => editor?.chain().focus().toggleHeading({ level: 2 }).run()}
					isActive={editor?.isActive('heading', { level: 2 })}
				/>
				<Btn
					icon={Heading3}
					title='H3'
					onClick={() => editor?.chain().focus().toggleHeading({ level: 3 }).run()}
					isActive={editor?.isActive('heading', { level: 3 })}
				/>
				<Btn
					icon={List}
					title='Bullet List'
					onClick={() => editor?.chain().focus().toggleBulletList().run()}
					isActive={editor?.isActive('bulletList')}
				/>
				<Btn
					icon={Quote}
					title='Blockquote'
					onClick={() => editor?.chain().focus().toggleBlockquote().run()}
					isActive={editor?.isActive('blockquote')}
				/>
				<Btn
					icon={Code}
					title='Code Block'
					onClick={() => editor?.chain().focus().toggleCodeBlock().run()}
					isActive={editor?.isActive('codeBlock')}
				/>
				<div className='w-px h-4 bg-border mx-1 opacity-50' />
				<Btn
					icon={LinkIcon}
					title='Link'
					isActive={editor?.isActive('link')}
					onClick={() => {
						const previousUrl = editor?.getAttributes('link').href;
						const url = window.prompt('URL', previousUrl);
						if (url === null) return;
						if (url === '') {
							editor?.chain().focus().extendMarkRange('link').unsetLink().run();
							return;
						}
						editor?.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
					}}
				/>
			</div>

			{/* Mention Button (Works in both, but handled manually in Source) */}
			<div className='w-px h-4 bg-border mx-1 opacity-50' />
			<button
				type='button'
				onClick={onMentionClick}
				className={clsx(
					'ml-1 flex items-center gap-1 px-2 py-0.5 text-[10px] font-bold uppercase rounded hover:bg-primary/10 transition-colors',
					'text-primary'
				)}
				title='Mention Entity (@)'>
				<AtSign size={13} />
				<span className='hidden sm:inline'>Mention</span>
			</button>

			{/* Right Side: Mode Toggle */}
			<div className='flex-1' />

			{/* Undo/Redo - Only Visual */}
			<div className={clsx('flex gap-1 mr-2', mode === 'source' && 'hidden')}>
				<Btn
					icon={Undo}
					title='Undo'
					onClick={() => editor?.chain().focus().undo().run()}
					disabled={!editor?.can().undo()}
				/>
				<Btn
					icon={Redo}
					title='Redo'
					onClick={() => editor?.chain().focus().redo().run()}
					disabled={!editor?.can().redo()}
				/>
			</div>

			<div className='flex bg-muted rounded p-0.5 border border-border'>
				<button
					type='button'
					onClick={() => setMode('visual')}
					className={clsx(
						'px-2 py-0.5 text-[10px] font-bold uppercase rounded flex items-center gap-1.5 transition-all',
						mode === 'visual' ? 'bg-background shadow text-foreground' : 'text-muted-foreground hover:text-foreground'
					)}>
					<Eye size={12} /> Visual
				</button>
				<button
					type='button'
					onClick={() => setMode('source')}
					className={clsx(
						'px-2 py-0.5 text-[10px] font-bold uppercase rounded flex items-center gap-1.5 transition-all',
						mode === 'source' ? 'bg-background shadow text-foreground' : 'text-muted-foreground hover:text-foreground'
					)}>
					<FileCode size={12} /> Source
				</button>
			</div>
		</div>
	);
};

export default function MarkdownEditorImpl({ label, value, onChange, placeholder }) {
	const [mode, setMode] = useState('visual'); // 'visual' | 'source'
	const [mentionPos, setMentionPos] = useState(null);
	const sourceRef = React.useRef(null);

	// --- TIPTAP CONFIG ---
	const editor = useEditor({
		extensions: [
			StarterKit.configure({
				heading: { levels: [1, 2, 3] },
			}),
			Link.configure({
				openOnClick: false,
				HTMLAttributes: { class: 'text-blue-500 underline cursor-pointer' },
			}),
			Markdown,
		],
		editorProps: {
			attributes: {
				class:
					'prose prose-sm prose-neutral dark:prose-invert max-w-none min-h-[180px] px-4 py-3 focus:outline-none custom-scrollbar',
			},
			handleKeyDown: (view, event) => {
				if (event.key === '@') {
					const { top, left } = view.coordsAtPos(view.state.selection.from);
					setMentionPos({ top: top + 20, left });
					return false;
				}
				return false;
			},
		},
		content: value,
		onUpdate: ({ editor }) => {
			// Sync to parent form
			if (mode === 'visual') {
				onChange({ target: { value: editor.storage.markdown.getMarkdown() } });
			}
		},
	});

	// --- SYNCING LOGIC ---
	useEffect(() => {
		// When switching back to Visual, or when Form resets, sync Tiptap
		if (editor && mode === 'visual') {
			const currentContent = editor.storage.markdown.getMarkdown();
			if (value !== currentContent) {
				// Check if empty to avoid jumping cursor on slight formatting diffs
				if (value === '' || value === undefined) {
					editor.commands.setContent('');
				} else if (Math.abs(value.length - currentContent.length) > 5) {
					// Only hard reset if significant change (e.g. from Source edit)
					editor.commands.setContent(value);
				}
			}
		}
	}, [value, editor, mode]);

	// --- HANDLERS ---
	const handleMentionClick = (e) => {
		e.stopPropagation();
		const rect = e.currentTarget.getBoundingClientRect();
		setMentionPos({ top: rect.bottom + 5, left: rect.left });
	};

	const handleInsertEntity = (entity) => {
		const link = `[:: ${entity.name} ::](#entity/${entity.id}/${entity.type})`;

		if (mode === 'visual' && editor) {
			// Visual Mode: Insert as Link Node
			const href = `#entity/${entity.id}/${entity.type}`;
			const label = `:: ${entity.name} ::`;

			// Remove pending '@'
			const { from } = editor.state.selection;
			const textBefore = editor.state.doc.textBetween(Math.max(0, from - 1), from);
			if (textBefore === '@')
				editor
					.chain()
					.focus()
					.deleteRange({ from: from - 1, to: from })
					.run();

			editor.chain().focus().setLink({ href }).insertContent(label).run();
		} else {
			// Source Mode: Insert raw text
			const textarea = sourceRef.current;
			if (textarea) {
				const start = textarea.selectionStart;
				const end = textarea.selectionEnd;
				const text = textarea.value;
				const before = text.substring(0, start);
				const after = text.substring(end);

				// Remove pending '@' if exists
				const finalBefore = before.endsWith('@') ? before.slice(0, -1) : before;

				const newValue = finalBefore + link + after;

				// Fire change event manually for React Hook Form
				onChange({ target: { value: newValue } });

				// Restore focus
				setTimeout(() => {
					textarea.focus();
					textarea.setSelectionRange(finalBefore.length + link.length, finalBefore.length + link.length);
				}, 0);
			}
		}
		setMentionPos(null);
	};

	return (
		<div className='flex flex-col gap-1.5 group'>
			{label && <label className={ADMIN_LABEL_CLASS}>{label}</label>}

			<div
				className={clsx(
					'border rounded-lg bg-background overflow-hidden shadow-sm transition-all flex flex-col',
					'focus-within:ring-1 focus-within:ring-amber-500 focus-within:border-amber-500',
					'border-border'
				)}>
				<MenuBar editor={editor} mode={mode} setMode={setMode} onMentionClick={handleMentionClick} />

				<div className='relative bg-background min-h-[180px]'>
					{mode === 'visual' ? (
						<div onClick={() => editor?.commands.focus()} className='cursor-text h-full'>
							<EditorContent editor={editor} />
						</div>
					) : (
						<textarea
							ref={sourceRef}
							value={value}
							onChange={onChange}
							className='w-full h-full min-h-[180px] p-4 font-mono text-sm resize-y outline-none bg-transparent'
							placeholder='Type raw markdown here...'
							onKeyDown={(e) => {
								if (e.key === '@') {
									// Naive source mode positioning (bottom of textarea)
									// Precise positioning in textarea is hard without libraries,
									// so we default to the mention button position logic or fixed center
									const rect = e.target.getBoundingClientRect();
									setMentionPos({ top: rect.top + 20, left: rect.left + 20 });
								}
							}}
						/>
					)}
				</div>
			</div>

			{/* Mention Popup */}
			{mentionPos && (
				<div
					className='fixed z-[9999] w-72 bg-background border border-primary/30 shadow-2xl rounded-lg animate-in fade-in zoom-in-95 duration-100 flex flex-col'
					style={{ top: mentionPos.top, left: mentionPos.left }}
					onClick={(e) => e.stopPropagation()}>
					<div className='flex justify-between items-center p-2 border-b border-border bg-muted/50'>
						<span className='text-[10px] font-bold uppercase text-primary tracking-widest flex items-center gap-1'>
							<Wand2 size={10} /> Link Entity
						</span>
						<button
							type='button'
							onClick={() => setMentionPos(null)}
							className='text-muted-foreground hover:text-red-500'>
							<X size={14} />
						</button>
					</div>
					<div className='p-2'>
						<EntitySearch onSelect={handleInsertEntity} autoFocus />
					</div>
					{/* Click-away listener backdrop */}
					<div className='fixed inset-0 z-[-1]' onClick={() => setMentionPos(null)} />
				</div>
			)}
		</div>
	);
}

--- END OF features\admin\components\MarkdownEditorImpl.jsx ---

--- FILE: features\admin\components\QuestObjectiveManager.jsx ---
import React, { useEffect, useState } from 'react';
import { Plus, Trash2, Edit2, Save, X, Target, CheckCircle2, Circle, Calendar } from 'lucide-react';
import { fetchChildRows, upsertQuestObjective, deleteRow, getSessionList } from '@/features/admin/api/adminService'; // Import getSessionList
import { ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS, ADMIN_INPUT_CLASS, ADMIN_LABEL_CLASS } from './AdminFormStyles';
import { useCampaign } from '@/features/campaign/CampaignContext';
import Button from '@/shared/components/ui/Button';

export default function QuestObjectiveManager({ questId }) {
	const { campaignId } = useCampaign();
	const [objectives, setObjectives] = useState([]);
	const [sessions, setSessions] = useState([]); // Store session options
	const [loading, setLoading] = useState(false);
	const [editingId, setEditingId] = useState(null);
	const [formData, setFormData] = useState({});

	useEffect(() => {
		if (questId) {
			loadObjectives();
			loadSessions();
		}
	}, [questId]);

	const loadObjectives = async () => {
		setLoading(true);
		try {
			const data = await fetchChildRows('quest_objectives', 'quest_id', questId, 'order_index');
			setObjectives(data);
		} catch (e) {
			console.error(e);
		} finally {
			setLoading(false);
		}
	};

	const loadSessions = async () => {
		if (!campaignId) return;
		try {
			const data = await getSessionList(campaignId);
			setSessions(data);
		} catch (e) {
			console.error('Failed to load sessions', e);
		}
	};

	const handleAddNew = () => {
		const nextOrder = objectives.length > 0 ? Math.max(...objectives.map((o) => o.order_index || 0)) + 1 : 1;
		const newObj = {
			id: `new-${Date.now()}`,
			quest_id: questId,
			objective_name: '', // Title
			description: '',
			objective_update: '', // Resolution text
			status: 'pending',
			order_index: nextOrder,
			completed_session_id: null,
		};
		setObjectives([...objectives, newObj]);
		handleEdit(newObj);
	};

	const handleEdit = (obj) => {
		setEditingId(obj.id);
		setFormData({ ...obj });
	};

	const handleSave = async () => {
		try {
			await upsertQuestObjective(formData);
			setEditingId(null);
			loadObjectives();
		} catch (e) {
			alert(e.message);
		}
	};

	const handleDelete = async (id) => {
		if (!confirm('Delete?')) return;
		if (String(id).startsWith('new')) {
			setObjectives(objectives.filter((o) => o.id !== id));
			return;
		}
		try {
			await deleteRow('quest_objectives', id);
			loadObjectives();
		} catch (e) {
			alert(e.message);
		}
	};

	return (
		<div className={ADMIN_SECTION_CLASS}>
			<div className={`${ADMIN_HEADER_CLASS} flex justify-between`}>
				<span className='flex items-center gap-2'>
					<Target size={18} className='text-blue-600' /> Objectives
				</span>
				<Button onClick={handleAddNew} size='sm' variant='secondary' icon={Plus}>
					Add Objective
				</Button>
			</div>

			<div className='space-y-3'>
				{objectives.map((obj) => (
					<div key={obj.id} className='group'>
						{editingId === obj.id ? (
							/* --- EDIT MODE --- */
							<div className='bg-muted/30 border border-blue-300 rounded-lg p-4 space-y-4 animate-in fade-in'>
								{/* Row 1: Order, Title, Status */}
								<div className='flex gap-3'>
									<div className='w-16'>
										<label className={ADMIN_LABEL_CLASS}>#</label>
										<input
											type='number'
											className={ADMIN_INPUT_CLASS}
											value={formData.order_index}
											onChange={(e) => setFormData({ ...formData, order_index: parseInt(e.target.value) })}
										/>
									</div>
									<div className='flex-1'>
										<label className={ADMIN_LABEL_CLASS}>Title (Name)</label>
										<input
											type='text'
											className={`${ADMIN_INPUT_CLASS} font-bold`}
											autoFocus
											value={formData.objective_name || ''}
											onChange={(e) => setFormData({ ...formData, objective_name: e.target.value })}
											placeholder='Short summary...'
										/>
									</div>
									<div className='w-32'>
										<label className={ADMIN_LABEL_CLASS}>Status</label>
										<select
											className={ADMIN_INPUT_CLASS}
											value={formData.status}
											onChange={(e) => setFormData({ ...formData, status: e.target.value })}>
											<option value='pending'>Pending</option>
											<option value='completed'>Completed</option>
											<option value='failed'>Failed</option>
										</select>
									</div>
								</div>

								{/* Row 2: Description */}
								<div>
									<label className={ADMIN_LABEL_CLASS}>Description</label>
									<textarea
										rows={2}
										className={ADMIN_INPUT_CLASS}
										value={formData.description || ''}
										onChange={(e) => setFormData({ ...formData, description: e.target.value })}
										placeholder='What needs to be done?'
									/>
								</div>

								{/* Row 3: Updates & Session */}
								<div className='grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-border/50 pt-3'>
									<div>
										<label className={ADMIN_LABEL_CLASS}>Resolution / Update Text</label>
										<textarea
											rows={2}
											className={ADMIN_INPUT_CLASS}
											value={formData.objective_update || ''}
											onChange={(e) => setFormData({ ...formData, objective_update: e.target.value })}
											placeholder='How was it resolved?'
										/>
									</div>
									<div>
										<label className={ADMIN_LABEL_CLASS}>Completed In Session</label>
										<select
											className={ADMIN_INPUT_CLASS}
											value={formData.completed_session_id || ''}
											onChange={(e) => setFormData({ ...formData, completed_session_id: e.target.value || null })}>
											<option value=''>-- None --</option>
											{sessions.map((s) => (
												<option key={s.id} value={s.id}>
													{s.title}
												</option>
											))}
										</select>
									</div>
								</div>

								<div className='flex justify-end gap-2 pt-2'>
									<Button
										onClick={() => {
											setEditingId(null);
											loadObjectives();
										}}
										variant='ghost'
										size='sm'
										icon={X}>
										Cancel
									</Button>
									<Button onClick={handleSave} variant='primary' size='sm' icon={Save}>
										Save Objective
									</Button>
								</div>
							</div>
						) : (
							/* --- VIEW MODE --- */
							<div
								className={`flex items-start gap-3 p-3 border rounded-lg transition-colors ${
									obj.status === 'completed'
										? 'bg-emerald-500/10/50 border-emerald-200'
										: 'bg-background border-border hover:border-blue-300'
								}`}>
								<span className='font-mono text-xs font-bold opacity-40 w-5 mt-1'>#{obj.order_index}</span>

								<div className='shrink-0 mt-0.5'>
									{obj.status === 'completed' ? (
										<CheckCircle2 size={18} className='text-emerald-600' />
									) : (
										<Circle size={18} className='text-muted-foreground' />
									)}
								</div>

								<div className='flex-1 min-w-0'>
									{obj.objective_name && (
										<div className='font-bold text-sm text-foreground mb-0.5'>{obj.objective_name}</div>
									)}
									<div
										className={`text-sm ${obj.status === 'completed' ? 'text-muted-foreground' : 'text-foreground'}`}>
										{obj.description}
									</div>

									{/* Resolution & Session Badges */}
									{(obj.objective_update || obj.completed_session_id) && (
										<div className='mt-2 flex flex-col gap-1'>
											{obj.objective_update && (
												<div className='text-xs text-emerald-700 bg-emerald-100/50 px-2 py-1 rounded border border-emerald-100 italic'>
													"{obj.objective_update}"
												</div>
											)}
											{obj.completed_session_id && (
												<div className='flex items-center gap-1 text-[10px] uppercase font-bold text-muted-foreground'>
													<Calendar size={10} />
													Session: {sessions.find((s) => s.id === obj.completed_session_id)?.title || 'Unknown'}
												</div>
											)}
										</div>
									)}
								</div>

								<div className='flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity'>
									<button
										onClick={() => handleEdit(obj)}
										className='p-2 text-muted-foreground hover:text-blue-600 hover:bg-blue-500/10 rounded-md transition-colors'
										title='Edit Event'>
										<Edit2 size={18} />
									</button>
									<button
										onClick={() => handleDelete(obj.id)}
										className='p-2 text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors'
										title='Delete Event'>
										<Trash2 size={18} />
									</button>
								</div>
							</div>
						)}
					</div>
				))}

				{objectives.length === 0 && !loading && (
					<div className='text-center py-6 text-muted-foreground text-sm italic'>No objectives defined yet.</div>
				)}
			</div>
		</div>
	);
}

--- END OF features\admin\components\QuestObjectiveManager.jsx ---

--- FILE: features\admin\components\RelationshipManager.jsx ---
import React, { useEffect, useState, useMemo } from 'react';
import {
	Trash2,
	Link as LinkIcon,
	ArrowRightLeft,
	ArrowRight,
	Save,
	X,
	Edit2,
	Layers,
	EyeOff,
	Shield,
	Sword,
	MapPin,
	Flag,
	User,
	Users,
	Briefcase,
	BookOpen,
	Gem,
	Calendar,
} from 'lucide-react';
import EntitySearch from '@/features/admin/components/EntitySearch';
import {
	fetchRelationships,
	addRelationship,
	deleteRelationship,
	updateRelationship,
} from '@/features/admin/api/adminService';
import { ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS, ADMIN_INPUT_CLASS } from './AdminFormStyles';
import Button from '@/shared/components/ui/Button';

// --- CONFIGURATION ---

// 1. Group Headers (By Entity Type)
const ENTITY_GROUPS = {
	character: { label: 'Characters', icon: Users, color: 'text-rose-600', bg: 'bg-rose-50' },
	npc: { label: 'NPCs', icon: User, color: 'text-amber-600', bg: 'bg-amber-500/10' },
	location: { label: 'Locations', icon: MapPin, color: 'text-emerald-600', bg: 'bg-emerald-500/10' },
	faction: { label: 'Factions', icon: Shield, color: 'text-purple-600', bg: 'bg-purple-500/10' },
	quest: { label: 'Quests', icon: Flag, color: 'text-blue-600', bg: 'bg-blue-500/10' },
	session: { label: 'Sessions', icon: BookOpen, color: 'text-slate-600', bg: 'bg-muted/30' },
	item: { label: 'Items', icon: Gem, color: 'text-indigo-600', bg: 'bg-indigo-50' },
	event: { label: 'Events', icon: Calendar, color: 'text-orange-600', bg: 'bg-orange-50' },
	default: { label: 'Other Entities', icon: LinkIcon, color: 'text-muted-foreground', bg: 'bg-muted/30' },
};

const GROUP_ORDER = ['character', 'npc', 'faction', 'location', 'quest', 'item', 'session', 'event'];

// 2. Item Styles (By Relationship Type) - Keeps the "Ally/Enemy" visual context
const REL_STYLES = {
	Ally: { color: 'text-emerald-700', bg: 'bg-emerald-100/50', border: 'border-emerald-400' },
	Friend: { color: 'text-emerald-700', bg: 'bg-emerald-100/50', border: 'border-emerald-400' },
	Enemy: { color: 'text-red-700', bg: 'bg-red-100/50', border: 'border-red-400' },
	Rival: { color: 'text-red-700', bg: 'bg-red-100/50', border: 'border-red-400' },
	Located_In: { color: 'text-amber-700', bg: 'bg-amber-100/50', border: 'border-amber-400' },
	Parent_Location: { color: 'text-amber-700', bg: 'bg-amber-100/50', border: 'border-amber-400' },
	Quest_Giver: { color: 'text-blue-700', bg: 'bg-blue-100/50', border: 'border-blue-400' },
	Participant: { color: 'text-blue-700', bg: 'bg-blue-100/50', border: 'border-blue-400' },
	Generic: { color: 'text-slate-600', bg: 'bg-muted', border: 'border-slate-300' },
};

export default function RelationshipManager({ entityId }) {
	const [relationships, setRelationships] = useState([]);
	const [loading, setLoading] = useState(false);

	// BULK ADD STATE
	const [pendingTargets, setPendingTargets] = useState([]);
	const [type, setType] = useState('Generic');
	const [isBidirectional, setIsBidirectional] = useState(false);
	const [isHidden, setIsHidden] = useState(false);
	const [isAdding, setIsAdding] = useState(false);

	// EDIT STATE
	const [editingId, setEditingId] = useState(null);
	const [editForm, setEditForm] = useState({});

	useEffect(() => {
		if (entityId) loadRelationships();
	}, [entityId]);

	const loadRelationships = async () => {
		setLoading(true);
		try {
			const data = await fetchRelationships(entityId);
			setRelationships(data);
		} catch (e) {
			console.error(e);
		} finally {
			setLoading(false);
		}
	};

	// --- GROUPING LOGIC (By Entity Type) ---
	const grouped = useMemo(() => {
		const groups = {};
		relationships.forEach((rel) => {
			// Group by Target Entity Type (e.g. 'npc', 'location')
			const entityType = rel.target?.type?.toLowerCase() || 'default';
			// Map to config key or fallback
			const groupKey = ENTITY_GROUPS[entityType] ? entityType : 'default';

			if (!groups[groupKey]) groups[groupKey] = [];
			groups[groupKey].push(rel);
		});
		return groups;
	}, [relationships]);

	// --- HANDLERS ---
	const handleSelectTarget = (item) => {
		if (pendingTargets.find((t) => t.id === item.id) || item.id === entityId) return;
		setPendingTargets([...pendingTargets, item]);
	};
	const removePending = (id) => setPendingTargets(pendingTargets.filter((t) => t.id !== id));

	const handleBulkAdd = async () => {
		if (pendingTargets.length === 0) return;
		setIsAdding(true);
		try {
			await Promise.all(
				pendingTargets.map((target) =>
					addRelationship({
						from_entity_id: entityId,
						to_entity_id: target.id,
						relationship_type: type,
						is_bidirectional: isBidirectional,
						is_hidden: isHidden,
					})
				)
			);
			setPendingTargets([]);
			setType('Generic');
			loadRelationships();
		} catch (e) {
			alert('Error: ' + e.message);
		} finally {
			setIsAdding(false);
		}
	};

	const handleUpdate = async () => {
		try {
			await updateRelationship(editingId, {
				relationship_type: editForm.relationship_type,
				is_bidirectional: editForm.is_bidirectional,
				is_hidden: editForm.is_hidden,
			});
			setEditingId(null);
			loadRelationships();
		} catch (e) {
			alert(e.message);
		}
	};

	const handleDelete = async (id) => {
		if (!confirm('Remove link?')) return;
		try {
			await deleteRelationship(id);
			loadRelationships();
		} catch (e) {
			alert(e.message);
		}
	};

	if (!entityId) return null;

	// Dropdown options
	const relationshipTypes = [
		'member_of',
		'leadership_relation',
		'part_of',
		'affiliated_with',
		'family_relation',
		'romantic_relation',
		'professional_relation',
		'located_in',
		'parent_location',
		'residence_relation',
		'workplace_relation',
		'ownership_relation',
		'quest_giver',
		'quest_objective',
		'quest_update',
		'quest_participant',
		'quest_location',
		'hostile_to',
		'knowledge_of',
		'encountered',
	];

	// Helper to get sort order including "Other" groups not in explicit list
	const sortedGroupKeys = [...GROUP_ORDER, ...Object.keys(grouped).filter((k) => !GROUP_ORDER.includes(k))];

	return (
		<div className={ADMIN_SECTION_CLASS}>
			<h2 className={`${ADMIN_HEADER_CLASS} flex items-center gap-2`}>
				<LinkIcon size={18} className='text-amber-600' /> Relationships
			</h2>

			{/* --- ADD NEW SECTION --- */}
			<div className='bg-muted/30 p-4 rounded-lg mb-6 border border-border shadow-sm'>
				<div className='flex items-center justify-between mb-3'>
					<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider flex items-center gap-2'>
						<Layers size={12} /> Bulk Connect
					</h3>
					{pendingTargets.length > 0 && (
						<span className='text-xs text-amber-600 font-bold bg-amber-500/10 px-2 py-0.5 rounded-full border border-amber-100'>
							{pendingTargets.length} Ready
						</span>
					)}
				</div>

				<div className='space-y-4'>
					<div className='w-full'>
						<EntitySearch onSelect={handleSelectTarget} />
					</div>

					{pendingTargets.length > 0 && (
						<div className='flex flex-wrap gap-2 p-3 bg-background border border-border rounded-md'>
							{pendingTargets.map((t) => (
								<div
									key={t.id}
									className='flex items-center gap-2 bg-amber-500/10 text-amber-900 px-2 py-1 rounded border border-amber-200 text-xs font-medium'>
									<span className='uppercase text-[9px] text-amber-700/60 font-bold'>{t.type}</span>
									<span>{t.name}</span>
									<button onClick={() => removePending(t.id)} className='text-amber-500 hover:text-amber-800'>
										
									</button>
								</div>
							))}
						</div>
					)}

					<div className='flex flex-col md:flex-row gap-3 items-end pt-2 border-t border-border/50'>
						<div className='flex-1 w-full grid grid-cols-2 gap-4'>
							<div>
								<label className='block text-[10px] uppercase font-bold text-muted-foreground mb-1'>Type</label>
								<select value={type} onChange={(e) => setType(e.target.value)} className={ADMIN_INPUT_CLASS}>
									{relationshipTypes.map((t) => (
										<option key={t} value={t}>
											{t.replace('_', ' ')}
										</option>
									))}
								</select>
							</div>
							<div className='flex flex-col gap-2 pb-1'>
								<label className='flex items-center gap-2 cursor-pointer select-none'>
									<input
										type='checkbox'
										checked={isBidirectional}
										onChange={(e) => setIsBidirectional(e.target.checked)}
										className='w-4 h-4 text-amber-600 rounded focus:ring-amber-500'
									/>
									<span className='text-xs text-muted-foreground font-medium'>2-Way</span>
								</label>
								<label className='flex items-center gap-2 cursor-pointer select-none'>
									<input
										type='checkbox'
										checked={isHidden}
										onChange={(e) => setIsHidden(e.target.checked)}
										className='w-4 h-4 text-amber-600 rounded focus:ring-amber-500'
									/>
									<span className='text-xs text-muted-foreground font-medium flex items-center gap-1'>
										Hidden <EyeOff size={10} />
									</span>
								</label>
							</div>
						</div>
						<Button
							onClick={handleBulkAdd}
							disabled={pendingTargets.length === 0 || isAdding}
							size='sm'
							variant='primary'
							className='w-full md:w-auto min-w-[100px]'>
							{isAdding ? 'Saving...' : `Add ${pendingTargets.length > 0 ? `(${pendingTargets.length})` : ''}`}
						</Button>
					</div>
				</div>
			</div>

			{/* --- LIST SECTION (GROUPED BY ENTITY TYPE) --- */}
			<div className='space-y-6'>
				{relationships.length === 0 && (
					<div className='p-4 text-center text-xs text-muted-foreground italic border border-dashed border-border rounded-lg'>
						No relationships connected.
					</div>
				)}

				{sortedGroupKeys.map((groupKey) => {
					const items = grouped[groupKey];
					if (!items || items.length === 0) return null;

					const groupConfig = ENTITY_GROUPS[groupKey] || ENTITY_GROUPS.default;
					const GroupIcon = groupConfig.icon;

					return (
						<div key={groupKey} className='animate-in fade-in slide-in-from-bottom-2 duration-500'>
							{/* Group Header */}
							<h3
								className={`text-[11px] font-bold uppercase tracking-widest mb-3 border-b border-border/60 pb-1 flex items-center gap-2 ${groupConfig.color} opacity-90`}>
								<GroupIcon size={14} /> {groupConfig.label}
								<span className='ml-auto text-[9px] bg-muted/50 px-1.5 py-0.5 rounded-full text-muted-foreground'>
									{items.length}
								</span>
							</h3>

							<div className='grid grid-cols-1 gap-2'>
								{items.map((rel) => {
									// Item Style based on Relationship Type (Ally/Enemy)
									const style = REL_STYLES[rel.relationship_type] || REL_STYLES.Generic;

									return (
										<div
											key={rel.id}
											className={`group border rounded-lg transition-all bg-background hover:shadow-sm ${
												editingId === rel.id ? 'border-amber-400 ring-1 ring-amber-400' : 'border-border'
											}`}>
											{editingId === rel.id ? (
												/* EDIT MODE */
												<div className='grid grid-cols-[1fr_auto_auto_auto] gap-3 items-center p-2 bg-muted/20'>
													<div className='font-bold text-sm text-foreground truncate min-w-0'>{rel.target?.name}</div>

													<div className='w-36'>
														<select
															className={`${ADMIN_INPUT_CLASS} py-1 h-8 text-xs`}
															value={editForm.relationship_type}
															onChange={(e) => setEditForm({ ...editForm, relationship_type: e.target.value })}>
															{relationshipTypes.map((t) => (
																<option key={t} value={t}>
																	{t.replace('_', ' ')}
																</option>
															))}
														</select>
													</div>

													<div className='flex flex-col gap-1 px-2'>
														<label className='flex items-center gap-1 cursor-pointer'>
															<input
																type='checkbox'
																checked={editForm.is_bidirectional}
																onChange={(e) => setEditForm({ ...editForm, is_bidirectional: e.target.checked })}
															/>
															<span className='text-[10px] uppercase text-muted-foreground'>2-Way</span>
														</label>
														<label className='flex items-center gap-1 cursor-pointer'>
															<input
																type='checkbox'
																checked={editForm.is_hidden}
																onChange={(e) => setEditForm({ ...editForm, is_hidden: e.target.checked })}
															/>
															<span className='text-[10px] uppercase text-muted-foreground'>Hidden</span>
														</label>
													</div>

													<div className='flex gap-1'>
														<Button onClick={handleUpdate} size='sm' variant='primary' icon={Save} className='h-9 px-3'>
															Save
														</Button>
														<Button
															onClick={() => setEditingId(null)}
															size='sm'
															variant='ghost'
															icon={X}
															className='h-9 px-3'>
															Cancel
														</Button>
													</div>
												</div>
											) : (
												/* VIEW MODE */
												<div className={`flex items-center justify-between p-1 pl-0`}>
													<div className='flex items-center gap-3 min-w-0 pl-3'>
														<div className='flex items-center gap-2'>
															<span className='text-sm font-bold text-foreground truncate'>{rel.target?.name}</span>
															{rel.is_hidden && <EyeOff size={14} className='text-muted-foreground/70' title='Hidden' />}
															{rel.is_bidirectional && (
																<ArrowRightLeft size={12} className='text-muted-foreground/50' title='Bidirectional' />
															)}
														</div>
														<div className='flex items-center gap-1.5 mt-0.5'>
															{/* Relationship Type Badge */}
															<span
																className={`text-[10px] font-bold uppercase px-1.5 py-0 rounded-sm ${style.bg} ${style.color} border border-transparent`}>
																{rel.relationship_type.replace('_', ' ')}
															</span>
														</div>
													</div>
													<div className='flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity pr-2'>
														<button
															onClick={() => {
																setEditingId(rel.id);
																setEditForm({
																	relationship_type: rel.relationship_type,
																	is_bidirectional: rel.is_bidirectional,
																	is_hidden: rel.is_hidden,
																});
															}}
															className='p-2 text-muted-foreground hover:text-blue-600 hover:bg-blue-500/10 rounded-md transition-colors'>
															<Edit2 size={18} />
														</button>
														<button
															onClick={() => handleDelete(rel.id)}
															className='p-2 text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors'>
															<Trash2 size={18} />
														</button>
													</div>
												</div>
											)}
										</div>
									);
								})}
							</div>
						</div>
					);
				})}
			</div>
		</div>
	);
}

--- END OF features\admin\components\RelationshipManager.jsx ---

--- FILE: features\admin\components\SessionEventManager.jsx ---
import React, { useEffect, useState } from 'react';
import { Plus, Trash2, Edit2, Save, X, Calendar } from 'lucide-react';
import {
	fetchChildRows,
	upsertSessionEvent,
	deleteRow,
	fetchSessionEventsWithRelationships,
} from '@/features/admin/api/adminService';
import { ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS, ADMIN_INPUT_CLASS, ADMIN_LABEL_CLASS } from './AdminFormStyles';
import Button from '@/shared/components/ui/Button';
import EventTagger from './EventTagger';

const EVENT_TYPES = [
	'combat',
	'social',
	'quest_started',
	'quest_progressed',
	'travel',
	'location_discovered',
	'location_visited',
	'npc_encountered',
	'faction_discovered',
	'investigation',
	'backstory',
	'discovery',
	'vision',
	'shopping',
	'special_event',
];

export default function SessionEventManager({ sessionId }) {
	const [events, setEvents] = useState([]);
	const [loading, setLoading] = useState(false);
	const [editingId, setEditingId] = useState(null);
	const [formData, setFormData] = useState({});

	useEffect(() => {
		if (sessionId) loadEvents();
	}, [sessionId]);

	const loadEvents = async () => {
		setLoading(true);
		try {
			const data = await fetchSessionEventsWithRelationships(sessionId);
			setEvents(data);
		} catch (e) {
			console.error(e);
		} finally {
			setLoading(false);
		}
	};

	const handleAddNew = () => {
		const nextOrder = events.length > 0 ? Math.max(...events.map((e) => e.event_order || 0)) + 1 : 1;
		const newEvent = {
			id: `new-${Date.now()}`,
			session_id: sessionId,
			title: '',
			description: '',
			event_type: 'travel',
			event_order: nextOrder,
		};
		setEvents([...events, newEvent]);
		handleEdit(newEvent);
	};

	const handleEdit = (event) => {
		setEditingId(event.id);
		setFormData({ ...event });
	};

	const handleSave = async () => {
		try {
			const { relationships, ...payload } = formData;
			await upsertSessionEvent(payload);
			setEditingId(null);
			loadEvents();
		} catch (e) {
			alert('Error saving event: ' + e.message);
		}
	};

	const handleDelete = async (id) => {
		if (!confirm('Delete this event?')) return;
		if (String(id).startsWith('new')) {
			setEvents(events.filter((e) => e.id !== id));
			return;
		}
		try {
			await deleteRow('session_events', id);
			loadEvents();
		} catch (e) {
			alert(e.message);
		}
	};

	return (
		<div className={ADMIN_SECTION_CLASS}>
			<div className={`${ADMIN_HEADER_CLASS} flex items-center justify-between`}>
				<span className='flex items-center gap-2'>
					<Calendar size={18} className='text-primary' /> Session Timeline
				</span>
				<Button onClick={handleAddNew} size='sm' variant='secondary' icon={Plus}>
					Add Event
				</Button>
			</div>

			<div className='space-y-3'>
				{events.map((evt) => (
					<div key={evt.id} className='group'>
						{editingId === evt.id ? (
							/* --- EDIT MODE --- */
							<div className='bg-muted/30 border border-primary/20 rounded-lg p-4 space-y-4 animate-in fade-in'>
								<div className='flex gap-3'>
									<div className='w-16'>
										<label className={ADMIN_LABEL_CLASS}>Order</label>
										<input
											type='number'
											className={ADMIN_INPUT_CLASS}
											value={formData.event_order}
											onChange={(e) => setFormData({ ...formData, event_order: parseInt(e.target.value) })}
										/>
									</div>
									<div className='flex-1'>
										<label className={ADMIN_LABEL_CLASS}>Title</label>
										<input
											type='text'
											className={`${ADMIN_INPUT_CLASS} font-bold`}
											autoFocus
											value={formData.title}
											onChange={(e) => setFormData({ ...formData, title: e.target.value })}
										/>
									</div>
									<div className='w-1/3'>
										<label className={ADMIN_LABEL_CLASS}>Type</label>
										<select
											className={ADMIN_INPUT_CLASS}
											value={formData.event_type}
											onChange={(e) => setFormData({ ...formData, event_type: e.target.value })}>
											{EVENT_TYPES.map((t) => (
												<option key={t} value={t}>
													{t.replace(/_/g, ' ')}
												</option>
											))}
										</select>
									</div>
								</div>

								<div>
									<label className={ADMIN_LABEL_CLASS}>Description</label>
									<textarea
										rows={3}
										className={ADMIN_INPUT_CLASS}
										value={formData.description || ''}
										onChange={(e) => setFormData({ ...formData, description: e.target.value })}
									/>
								</div>

								<EventTagger eventId={evt.id} />

								<div className='flex justify-end gap-3 border-t border-border/50 pt-3'>
									<Button
										onClick={() => {
											setEditingId(null);
											loadEvents();
										}}
										variant='ghost'
										icon={X}>
										Cancel
									</Button>
									<Button onClick={handleSave} variant='primary' icon={Save}>
										Save Changes
									</Button>
								</div>
							</div>
						) : (
							/* --- VIEW MODE --- */
							<div className='flex items-start gap-3 p-3 bg-background border border-border rounded-lg hover:border-amber-300 transition-colors'>
								<div className='shrink-0 w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-bold text-muted-foreground border border-border'>
									{evt.event_order}
								</div>
								<div className='flex-1 min-w-0'>
									<div className='flex items-center gap-2 mb-1'>
										<span className='text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 bg-muted text-muted-foreground rounded border border-border'>
											{evt.event_type ? evt.event_type.replace(/_/g, ' ') : 'Event'}
										</span>
										<h4 className='font-bold text-sm text-foreground'>{evt.title}</h4>
									</div>
									<p className='text-xs text-muted-foreground line-clamp-2'>{evt.description}</p>
									{evt.relationships && evt.relationships.length > 0 && (
										<div className='flex flex-wrap gap-1.5 mt-1'>
											{evt.relationships.map((rel) => (
												<div
													key={rel.id}
													className='inline-flex items-center gap-1.5 px-1.5 py-0.5 rounded bg-card border border-border text-[10px] text-muted-foreground shadow-sm select-none'>
													<span className='font-medium text-foreground'>{rel.target?.name}</span>
													<span className='text-[9px] opacity-60 uppercase'>{rel.target?.type}</span>
												</div>
											))}
										</div>
									)}
								</div>

								<div className='flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity'>
									<button
										onClick={() => handleEdit(evt)}
										className='p-2 text-muted-foreground hover:text-blue-600 hover:bg-blue-500/10 rounded-md transition-colors'>
										<Edit2 size={18} />
									</button>
									<button
										onClick={() => handleDelete(evt.id)}
										className='p-2 text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors'>
										<Trash2 size={18} />
									</button>
								</div>
							</div>
						)}
					</div>
				))}
			</div>
		</div>
	);
}

--- END OF features\admin\components\SessionEventManager.jsx ---

--- FILE: features\admin\components\SmartImageInput.jsx ---
import React, { useState } from 'react';
import { Image as ImageIcon, X, Link as LinkIcon, Search } from 'lucide-react';
import { ADMIN_INPUT_CLASS } from './AdminFormStyles';
import ImageLibraryModal from './ImageLibraryModal';

const resolvePreviewUrl = (url) => {
	if (!url) return null;
	const cleanPath = url.replace(/(\.\.\/)+/g, '').replace(/^\//, '');
	return `${import.meta.env.BASE_URL}${cleanPath}`;
};

export default function SmartImageInput({ value, onChange, placeholder, ...props }) {
	const [isPickerOpen, setIsPickerOpen] = useState(false);
	const previewUrl = resolvePreviewUrl(value);

	return (
		<div className='space-y-2'>
			<div className='flex gap-2 items-center'>
				<div className='relative flex-1 group'>
					<div className='absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground/50'>
						<LinkIcon size={14} />
					</div>
					<input
						type='text'
						className={`${ADMIN_INPUT_CLASS} pl-9 pr-20`} // Extra padding for buttons
						placeholder={placeholder || 'images/path/to/file.png'}
						value={value || ''}
						onChange={onChange}
						{...props}
					/>

					{/* Actions inside input */}
					<div className='absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-0.5'>
						{value && (
							<button
								type='button'
								onClick={() => onChange({ target: { value: '' } })}
								className='p-1.5 text-muted-foreground hover:text-red-500 transition-colors'
								title='Clear'>
								<X size={14} />
							</button>
						)}
						<button
							type='button'
							onClick={() => setIsPickerOpen(true)}
							className='p-1.5 text-amber-600 hover:text-amber-700 hover:bg-amber-500/10 rounded-md transition-all'
							title='Browse Library'>
							<Search size={14} strokeWidth={3} />
						</button>
					</div>
				</div>

				{/* Visual Preview */}
				<div className='shrink-0 w-10 h-10 rounded-lg border border-border bg-card flex items-center justify-center overflow-hidden shadow-sm'>
					{previewUrl ? (
						<img
							src={previewUrl}
							alt='Preview'
							className='w-full h-full object-cover'
							onError={(e) => {
								e.target.style.display = 'none';
							}}
						/>
					) : (
						<ImageIcon size={16} className='text-muted-foreground/20' />
					)}
				</div>
			</div>

			<ImageLibraryModal
				isOpen={isPickerOpen}
				onClose={() => setIsPickerOpen(false)}
				onSelect={(path) => onChange({ target: { value: path } })}
			/>
		</div>
	);
}

--- END OF features\admin\components\SmartImageInput.jsx ---

--- FILE: features\admin\components\TacticalMapManager.jsx ---
/* --- FILE: features/admin/components/TacticalMapManager.jsx --- */
import React, { useState, useEffect } from 'react';
import { MapContainer, ImageOverlay, Marker, useMap, useMapEvents } from 'react-leaflet';
import L from 'leaflet';
import { Map as MapIcon, Trash2, Plus, Target, Save } from 'lucide-react';
import { ADMIN_SECTION_CLASS, ADMIN_HEADER_CLASS, ADMIN_INPUT_CLASS, ADMIN_LABEL_CLASS } from './AdminFormStyles';
import { resolveMarkerIcon } from '@/features/atlas/utils/markerUtils';
import Button from '@/shared/components/ui/Button';

// Click handler component
const MapClickHandler = ({ onMapClick }) => {
	useMapEvents({
		click: (e) => onMapClick(e.latlng),
	});
	return null;
};

const MapController = ({ bounds }) => {
	const map = useMap();
	useEffect(() => {
		if (bounds) map.fitBounds(bounds);
	}, [map, bounds]);
	return null;
};

export default function TacticalMapManager({ imageUrl, value, onChange }) {
	const [markers, setMarkers] = useState([]);
	const [dimensions, setDimensions] = useState(null);
	const [selectedIdx, setSelectedIdx] = useState(null);

	// 1. Load existing markers from JSON string
	useEffect(() => {
		if (value) {
			try {
				const parsed = typeof value === 'string' ? JSON.parse(value) : value;
				setMarkers(Array.isArray(parsed) ? parsed : []);
			} catch (e) {
				setMarkers([]);
			}
		}
	}, [value]);

	// 2. Handle Image Dimensions
	useEffect(() => {
		if (!imageUrl) return;
		const img = new Image();
		img.src = imageUrl;
		img.onload = () => {
			const h = img.height;
			const w = img.width;
			setDimensions(L.latLngBounds([-h, 0], [0, w]));
		};
	}, [imageUrl]);

	const handleMapClick = (latlng) => {
		const newMarker = {
			lat: Math.round(latlng.lat),
			lng: Math.round(latlng.lng),
			label: 'New Marker',
			category: 'default',
		};
		const updated = [...markers, newMarker];
		setMarkers(updated);
		setSelectedIdx(updated.length - 1);
		onChange(JSON.stringify(updated));
	};

	const updateMarker = (idx, fields) => {
		const updated = [...markers];
		updated[idx] = { ...updated[idx], ...fields };
		setMarkers(updated);
		onChange(JSON.stringify(updated));
	};

	const removeMarker = (idx) => {
		const updated = markers.filter((_, i) => i !== idx);
		setMarkers(updated);
		setSelectedIdx(null);
		onChange(JSON.stringify(updated));
	};

	if (!imageUrl || !dimensions) return null;

	return (
		<div className={ADMIN_SECTION_CLASS}>
			<div className={ADMIN_HEADER_CLASS}>
				<span className='flex items-center gap-2'>
					<Target size={18} className='text-primary' /> Marker Editor
				</span>
				<span className='text-[10px] text-muted-foreground uppercase tracking-widest'>Click map to add</span>
			</div>

			<div className='grid grid-cols-1 lg:grid-cols-3 gap-6'>
				{/* Visual Map Area */}
				<div className='lg:col-span-2 h-[400px] rounded-lg border border-border overflow-hidden bg-muted relative z-0'>
					<MapContainer
						crs={L.CRS.Simple}
						bounds={dimensions}
						zoom={-2}
						minZoom={-3}
						attributionControl={false}
						style={{ height: '100%', width: '100%', background: 'var(--background)' }}>
						<MapController bounds={dimensions} />
						<MapClickHandler onMapClick={handleMapClick} />
						<ImageOverlay url={imageUrl} bounds={dimensions} />

						{markers?.map((m, i) => (
							<Marker
								key={i}
								position={[m.lat, m.lng]}
								icon={resolveMarkerIcon(m)}
								eventHandlers={{ click: () => setSelectedIdx(i) }}
							/>
						))}
					</MapContainer>
				</div>

				{/* Sidebar Editor */}
				<div className='space-y-4'>
					<div className='max-h-[400px] overflow-y-auto pr-2 space-y-3 custom-scrollbar'>
						{markers.length === 0 && (
							<div className='text-center py-10 text-xs text-muted-foreground italic border-2 border-dashed border-border rounded-lg'>
								No markers yet. Click the map to start.
							</div>
						)}
						{markers.map((m, i) => (
							<div
								key={i}
								className={`p-3 rounded-lg border transition-all ${
									selectedIdx === i ? 'border-accent bg-accent/5 ring-1 ring-accent' : 'border-border bg-background'
								}`}
								onClick={() => setSelectedIdx(i)}>
								<div className='flex justify-between items-start mb-2'>
									<span className='text-[10px] font-bold text-muted-foreground uppercase'>Marker #{i + 1}</span>
									<button onClick={() => removeMarker(i)} className='text-muted-foreground hover:text-red-600'>
										<Trash2 size={14} />
									</button>
								</div>
								<div className='space-y-2'>
									<input
										className={ADMIN_INPUT_CLASS}
										value={m.label}
										onChange={(e) => updateMarker(i, { label: e.target.value })}
										placeholder='Label...'
									/>
									<select
										className={ADMIN_INPUT_CLASS}
										value={m.category}
										onChange={(e) => updateMarker(i, { category: e.target.value })}>
										<option value='default'>Default Pin</option>
										<option value='combat'>Combat / Danger</option>
										<option value='city'>City / Settlement</option>
										<option value='npc'>NPC / Person</option>
										<option value='magic'>Magic / Mystery</option>
										<option value='quest'>Objective</option>
										<option value='location'>Location</option>
									</select>
									<div className='flex gap-2 text-[9px] font-mono text-muted-foreground'>
										<span>LAT: {m.lat}</span>
										<span>LNG: {m.lng}</span>
									</div>
								</div>
							</div>
						))}
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\admin\components\TacticalMapManager.jsx ---

--- FILE: features\admin\config\adminStrategies.js ---
export const ADMIN_STRATEGIES = {
	// 0. CAMPAIGN (Meta Entity)
	campaign: {
		label: 'Campaign',
		type: 'campaign',
		primaryTable: 'campaigns',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true, // Use Markdown for description
		defaultAttributes: [
			{ key: 'campaign_id', label: 'Campaign ID (Integer)', type: 'number' }, // Required by your schema
			{ key: 'map_data', label: 'Map Data (JSON)', type: 'text' }, // Advanced: map config
			{ key: 'icon', label: 'Icon URL', type: 'image' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 1. NPC
	npc: {
		label: 'NPC',
		type: 'npc',
		primaryTable: 'npcs',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'race', label: 'Race/Ancestry', type: 'text' },
			{ key: 'class', label: 'Class/Occupation', type: 'text' },
			{ key: 'affinity', label: 'Affinity', type: 'select', options: ['Ally', 'Neutral', 'Enemy', 'Unknown'] },
			{ key: 'status', label: 'Status', type: 'text' },
			{ key: 'icon', label: 'Icon URL', type: 'image' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 2. LOCATION
	location: {
		label: 'Location',
		type: 'location',
		primaryTable: 'locations',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'type', label: 'Type', type: 'text' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
			{ key: 'map_image', label: 'Map Image', type: 'image' },
		],
	},

	// 3. SESSION
	session: {
		label: 'Chronicles',
		type: 'session',
		primaryTable: 'sessions',
		colMapping: { name: 'title', description: 'narrative' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'session_number', label: 'Session Number', type: 'number' },
			{ key: 'session_date', label: 'In-Game Date', type: 'text' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 4. QUEST
	quest: {
		label: 'Quest',
		type: 'quest',
		primaryTable: 'quests',
		colMapping: { name: 'title', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'status', label: 'Status', type: 'select', options: ['Active', 'Completed', 'Failed', 'Pending'] },
			{
				key: 'quest type',
				label: 'Quest Type',
				type: 'select',
				options: ['Main Quest', 'Side Quest', 'Personal Quest'],
			},
			{ key: 'priority', label: 'Priority', type: 'select', options: ['Critical', 'High', 'Medium', 'Low', 'Trivial'] },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 5. FACTION
	faction: {
		label: 'Faction',
		type: 'faction',
		primaryTable: 'factions',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'leader', label: 'Leader', type: 'text' },
			{ key: 'affinity', label: 'Affinity', type: 'select', options: ['Ally', 'Neutral', 'Enemy'] },
			{ key: 'icon', label: 'Icon URL', type: 'image' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 6. ITEM
	item: {
		label: 'Item',
		type: 'item',
		primaryTable: 'items',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{
				key: 'type',
				label: 'Type',
				type: 'select',
				options: ['Weapon', 'Armor', 'Potion', 'Scroll', 'Wondrous Weapon', 'Wondrous Armor', 'Key Item', 'Treasure'],
			},
			{
				key: 'rarity',
				label: 'Rarity',
				type: 'select',
				options: ['Common', 'Uncommon', 'Rare', 'Very Rare', 'Legendary', 'Artifact'],
			},
			{ key: 'attunement', label: 'Attunement?', type: 'select', options: ['Yes', 'No'] },
			{ key: 'icon', label: 'Icon URL', type: 'image' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 7. CHARACTER (The Party)
	character: {
		label: 'Character',
		type: 'character',
		primaryTable: 'characters',
		// 'background' is usually the column name for description in D&D schemas
		// If your table uses 'description', change 'background' to 'description'
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'race', label: 'Race', type: 'text' },
			{ key: 'class', label: 'Class', type: 'text' },
			{ key: 'level', label: 'Level', type: 'number' },
			{ key: 'speed', label: 'Speed', type: 'text' },
			{ key: 'hit points', label: 'Hit Points', type: 'text' },
			{ key: 'armor class', label: 'Armor Class', type: 'text' },
			{ key: 'icon', label: 'Icon URL', type: 'image' },
			{ key: 'background_image', label: 'Background Image', type: 'image' },
		],
	},

	// 8. ENCOUNTER
	encounter: {
		label: 'Encounter',
		type: 'encounter',
		primaryTable: 'encounters',
		colMapping: { name: 'name', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{
				key: 'status',
				label: 'Status',
				type: 'select',
				options: ['Planned', 'In Progress', 'Completed', 'Skipped'],
			},
			{ key: 'background_image', label: 'Background Image', type: 'image' },
			{ key: 'map_image', label: 'Map Image', type: 'image' },
		],
	},

	// 9. Narrative Arc

	narrative_arc: {
		label: 'Narrative Arc',
		type: 'narrative_arc',
		primaryTable: 'narrative_arcs',
		colMapping: { name: 'title', description: 'description' },
		hasNarrative: true,
		defaultAttributes: [
			{ key: 'order', label: 'Sort Order', type: 'number' },
			{ key: 'type', label: 'Arc Type', type: 'select', options: ['Primary', 'Secondary', 'Character Arc'] },
			{ key: 'background_image', label: 'Cover Image', type: 'image' },
		],
	},

	default: {
		label: 'Entity',
		primaryTable: 'entities',
		colMapping: { name: 'name', description: 'description' },
		defaultAttributes: [
			{ key: 'type', label: 'Type', type: 'text' },
			{ key: 'map_image', label: 'Tactical Map Image', type: 'image' }, // Added this
			{ key: 'background_image', label: 'Header Background', type: 'image' },
		],
	},
};

export const getStrategy = (type) => {
	return ADMIN_STRATEGIES[type] || ADMIN_STRATEGIES.default;
};

--- END OF features\admin\config\adminStrategies.js ---

--- FILE: features\admin\config\imageLibrary.js ---
export const IMAGE_LIBRARY = [
	{
		category: 'Icons',
		path: 'images/icons/',
		// Example list: In a real app, you can generate this JSON via a script
		// or just list your primary D&D icons here.
		files: ['npc.png', 'location.png', 'quest.png', 'faction.png', 'encounter.png', 'item.png'],
	},
	{
		category: 'Backgrounds',
		path: 'images/backgrounds/',
		files: ['forest.jpg', 'dungeon.jpg', 'city.jpg', 'tavern.jpg', 'map_parchment.jpg'],
	},
	{
		category: 'Tokens',
		path: 'images/tokens/',
		files: ['party_token.png', 'enemy_token.png'],
	},
];

--- END OF features\admin\config\imageLibrary.js ---

--- FILE: features\admin\config\imageManifest.json ---
[
  {
    "category": "Assets > Character_backgrounds > Campaign_002",
    "path": "images/assets/character_backgrounds/campaign_002/",
    "files": [
      "bonnie_bg_horizontal.webp",
      "bonnie_bg_square.webp",
      "kaedin_bg_horizontal.webp",
      "kaedin_bg_vertical.webp",
      "norr_bg_horizontal.webp",
      "olek_bg_horizontal.webp",
      "olek_bg_square.webp",
      "party_bg_horizontal.webp",
      "soshi_bg_horizontal.webp",
      "soshi_bg_vertical.webp"
    ]
  },
  {
    "category": "Assets > Character_thumbnails > Campaign_001",
    "path": "images/assets/character_thumbnails/campaign_001/",
    "files": [
      "aenwyn.webp",
      "aethere.webp",
      "alezander.webp",
      "nora.webp",
      "samantha.webp",
      "smasherina.webp"
    ]
  },
  {
    "category": "Assets > Character_thumbnails > Campaign_002",
    "path": "images/assets/character_thumbnails/campaign_002/",
    "files": [
      "bonnie.webp",
      "kaedin.webp",
      "norr.webp",
      "olek.webp",
      "party.webp",
      "soshi.webp"
    ]
  },
  {
    "category": "Assets > Encounter_backgrounds > Campaign_002",
    "path": "images/assets/encounter_backgrounds/campaign_002/",
    "files": [
      "demonic_ambush_bg.webp",
      "hydra_encounter_bg.webp",
      "thylacoleo_ambush_bg.webp"
    ]
  },
  {
    "category": "Assets > Location_backgrounds > Campaign_002",
    "path": "images/assets/location_backgrounds/campaign_002/",
    "files": [
      "avarthel_grove_bg.webp",
      "drellin_ferry_bg.webp",
      "grackledorn_bg.webp",
      "neverwinter_bg.webp",
      "strategic_bridge.webp",
      "underground_temple_complex.webp",
      "wrath_keep_bg.webp"
    ]
  },
  {
    "category": "Assets > Map_backgrounds > Backups",
    "path": "images/assets/map_backgrounds/backups/",
    "files": [
      "brindol_map.webp",
      "drellin_ferry_map.webp",
      "elsir_vale_map (2).webp",
      "elsir_vale_map.webp",
      "witchwood_map.webp"
    ]
  },
  {
    "category": "Assets > Map_backgrounds > Campaign_001",
    "path": "images/assets/map_backgrounds/campaign_001/",
    "files": [
      "korinis_city_harbour.webp",
      "korinis_city_lower_city.webp",
      "korinis_city_upper_city.webp",
      "lobart_farm.webp"
    ]
  },
  {
    "category": "Assets > Map_backgrounds > Campaign_002",
    "path": "images/assets/map_backgrounds/campaign_002/",
    "files": [
      "brindol_map.webp",
      "demonic_ambush_map.webp",
      "drellin_ferry_map.webp",
      "elsir_vale_map.webp",
      "strategic_bridge_map.webp",
      "vraath_courtyard_map.webp",
      "witchwood_map.webp"
    ]
  },
  {
    "category": "Assets > Npc_backgrounds > Campaign_002",
    "path": "images/assets/npc_backgrounds/campaign_002/",
    "files": [
      "avarthel_bg.webp",
      "soranna_bg.webp",
      "yoghurt_bg.webp"
    ]
  },
  {
    "category": "Assets > Session_backgrounds > Campaign_002",
    "path": "images/assets/session_backgrounds/campaign_002/",
    "files": [
      "session_01_bg.webp"
    ]
  },
  {
    "category": "General",
    "path": "images/",
    "files": [
      "background_texture.webp"
    ]
  },
  {
    "category": "Icons",
    "path": "images/icons/",
    "files": [
      "avian.webp",
      "bonnie.webp",
      "deity.webp",
      "dwarf.webp",
      "earth_genasi.webp",
      "elemental.webp",
      "encounter.webp",
      "faction.webp",
      "feline.webp",
      "female.webp",
      "gnome.webp",
      "goblin.webp",
      "hobgoblin.webp",
      "kaedin.webp",
      "location.webp",
      "male.webp",
      "monster.webp",
      "norr.webp",
      "ogre.webp",
      "olek.webp",
      "other.webp",
      "party.webp",
      "phoenix.webp",
      "quest.webp",
      "quickling.webp",
      "rat.webp",
      "session.webp",
      "soshi.webp",
      "tabaxi.webp",
      "unknown.webp"
    ]
  },
  {
    "category": "Icons > Factions > Campaign_002",
    "path": "images/icons/factions/campaign_002/",
    "files": [
      "arcane_brotherhood_icon.webp",
      "circle_of_the_land_icon.webp",
      "crazy_hogs_icon.webp",
      "kryn_dynasty_icon.webp",
      "red_hand_icon.webp",
      "red_wizards_of_thay_icon.webp",
      "thieves_guild.webp"
    ]
  },
  {
    "category": "Icons > Weapons > Campaign_001",
    "path": "images/icons/weapons/campaign_001/",
    "files": [
      "amulet_of_mualthar.webp",
      "amulet_of_slow.webp",
      "boots_of_speed.webp",
      "ring_of_haste.webp",
      "tiny_oracle.webp"
    ]
  },
  {
    "category": "Icons > Weapons > Campaign_002",
    "path": "images/icons/weapons/campaign_002/",
    "files": [
      "boots_jungle_strider.webp",
      "bracers_spell_plague_icon.webp",
      "crocodile_tears_icon.webp",
      "gloves_brotherhood_icon.webp",
      "talisman_elemental_acuity_icon.webp",
      "veilbranch.webp"
    ]
  },
  {
    "category": "Overlays > Korinis_island",
    "path": "images/overlays/korinis_island/",
    "files": [
      "korinis_island_penal_colony_chapel.webp",
      "korinis_island_penal_colony_merchants_cave.webp",
      "korinis_island_penal_colony_mine_cave.webp",
      "korinis_island_penal_colony_mine_cave_v2.webp",
      "korinis_island_penal_colony_paladin_barracks.webp",
      "korinis_island_penal_colony_spider_cave.webp"
    ]
  }
]
--- END OF features\admin\config\imageManifest.json ---

--- FILE: features\admin\layouts\AdminLayout.jsx ---
import React from 'react';
import { Outlet, Link, useLocation, useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import {
	Database,
	Users,
	MapPin,
	BookOpen,
	Scroll,
	ArrowLeft,
	Shield,
	Gem,
	LogOut,
	Play,
	Sword,
	Replace,
	Drama,
	Sun,
	Moon,
	Dice5, // Icon for D&D mode
} from 'lucide-react';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { useTheme, THEMES } from '@/shared/hooks/useTheme'; // Import constant too

const NavItem = ({ to, icon: Icon, label }) => {
	const location = useLocation();
	const isActive = location.pathname.includes(to);

	return (
		<Link
			to={to}
			className={clsx(
				'flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200',
				isActive
					? 'bg-card text-primary shadow-sm ring-1 ring-amber'
					: 'text-muted-foreground hover:bg-muted/80 hover:text-foreground'
			)}>
			<Icon size={15} className={isActive ? 'text-primary' : 'opacity-70'} />
			{label}
		</Link>
	);
};

export default function AdminLayout() {
	const { campaignId, setCampaignId } = useCampaign();
	const { theme, cycleTheme } = useTheme(); // Use cycleTheme
	const navigate = useNavigate();

	const handleSwitch = () => {
		if (confirm('Go to Campaign Selection screen?')) {
			setCampaignId(null);
			navigate('/select-campaign');
		}
	};

	// Helper to render current theme icon
	const ThemeIcon = () => {
		if (theme === THEMES.DARK) return <Moon size={16} />;
		if (theme === THEMES.DND) return <Dice5 size={16} />;
		return <Sun size={16} />;
	};

	return (
		<div className='flex h-screen bg-muted/30 text-foreground overflow-hidden font-sans '>
			{/* Sidebar */}
			<aside className='w-56 bg-background border-r border-border flex flex-col shrink-0'>
				<div className='p-4 border-b border-border bg-muted/20 flex items-center justify-between'>
					<div className='flex items-center gap-2 text-primary'>
						<div className='p-1.5 bg-primary  rounded-md'>
							<Database size={18} />
						</div>
						<h2 className='font-serif font-bold text-lg leading-none'>DM Console</h2>
					</div>

					{/* THEME TOGGLE BUTTON */}
					<button
						onClick={cycleTheme}
						className='p-1.5 text-muted-foreground hover:bg-muted rounded-md transition-colors hover:text-foreground'
						title={`Current Theme: ${theme}`}>
						<ThemeIcon />
					</button>
				</div>

				<nav className='flex-1 p-3 space-y-0.5 overflow-y-auto'>
					<div className='px-3 py-2 text-[10px] font-bold uppercase tracking-widest text-muted-foreground/60'>
						System
					</div>
					<NavItem to='/dm/manage/campaign' icon={Database} label='Campaigns' />
					<NavItem to='/dm/tools/replace' icon={Replace} label='Find & Replace' />

					<div className='mt-4 px-3 py-2 text-[10px] font-bold uppercase tracking-widest text-muted-foreground/60'>
						Entities
					</div>
					<NavItem to='/dm/manage/character' icon={Users} label='Characters' />
					<NavItem to='/dm/manage/npc' icon={Users} label='NPCs' />
					<NavItem to='/dm/manage/location' icon={MapPin} label='Locations' />
					<NavItem to='/dm/manage/faction' icon={Shield} label='Factions' />
					<NavItem to='/dm/manage/item' icon={Gem} label='Items' />
					<NavItem to='/dm/manage/encounter' icon={Sword} label='Encounters' />

					<div className='mt-4 px-3 py-2 text-[10px] font-bold uppercase tracking-widest text-muted-foreground/60'>
						Campaign
					</div>
					<NavItem to='/dm/manage/session' icon={BookOpen} label='Chronicles' />
					<NavItem to='/dm/manage/narrative_arc' icon={Drama} label='Narrative Arcs' />
					<NavItem to='/dm/manage/quest' icon={Scroll} label='Quests' />
				</nav>

				<div className='p-3 border-t border-border space-y-1'>
					{campaignId && (
						<Link
							to='/'
							className='flex items-center gap-2 w-full px-3 py-2 text-xs font-bold uppercase tracking-wide text-emerald-700 hover:bg-emerald-500/10 rounded-md transition-colors dark:text-emerald-400 dark:hover:bg-emerald-900/20'
							title={`Return to Campaign ID: ${campaignId}`}>
							<Play size={14} /> Enter Campaign
						</Link>
					)}

					<button
						onClick={handleSwitch}
						className='flex items-center gap-2 w-full px-3 py-2 text-xs font-bold uppercase tracking-wide text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors text-left dark:hover:text-red-400 dark:hover:bg-red-900/20'>
						<LogOut size={14} /> Campaign Select
					</button>
				</div>
			</aside>

			{/* Main Content */}
			<main className='flex-1 h-full overflow-y-auto custom-scrollba'>
				<div className='mx-auto'>
					<Outlet />
				</div>
			</main>
		</div>
	);
}

--- END OF features\admin\layouts\AdminLayout.jsx ---

--- FILE: features\admin\pages\BulkReplaceTool.jsx ---
import React, { useState } from 'react';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getBulkReplacePreview, executeBulkReplace } from '@/features/admin/api/adminService';
import {
	ADMIN_SECTION_CLASS,
	ADMIN_HEADER_CLASS,
	ADMIN_INPUT_CLASS,
	ADMIN_LABEL_CLASS,
} from '@/features/admin/components/AdminFormStyles';
import Button from '@/shared/components/ui/Button';
import { Replace, Eye, ArrowRight, CheckCircle2, AlertCircle, Loader2 } from 'lucide-react';
import { useQueryClient } from '@tanstack/react-query';

export default function BulkReplaceTool() {
	const { campaignId } = useCampaign();
	const queryClient = useQueryClient();
	const [find, setFind] = useState('');
	const [replace, setReplace] = useState('');
	const [preview, setPreview] = useState(null); // null, [], or items
	const [isProcessing, setIsProcessing] = useState(false);

	const handlePreview = async () => {
		setIsProcessing(true);
		const matches = await getBulkReplacePreview(campaignId, find, replace);
		setPreview(matches);
		setIsProcessing(false);
	};

	const handleConfirm = async () => {
		if (!confirm(`Apply all ${preview.length} changes?`)) return;
		setIsProcessing(true);
		await executeBulkReplace(preview);
		queryClient.invalidateQueries();
		alert('Archive successfully patched.');
		setPreview(null);
		setFind('');
		setReplace('');
		setIsProcessing(false);
	};

	return (
		<div className='max-w-4xl mx-auto p-6 space-y-6'>
			<div className={ADMIN_SECTION_CLASS}>
				<h2 className={ADMIN_HEADER_CLASS}>
					<span className='flex items-center gap-2'>
						<Replace size={18} className='text-amber-600' /> Archive Patch Tool
					</span>
				</h2>

				<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
					<div>
						<label className={ADMIN_LABEL_CLASS}>Search Term</label>
						<input
							className={ADMIN_INPUT_CLASS}
							value={find}
							onChange={(e) => setFind(e.target.value)}
							placeholder='Misspelled word...'
						/>
					</div>
					<div>
						<label className={ADMIN_LABEL_CLASS}>Replacement</label>
						<input
							className={ADMIN_INPUT_CLASS}
							value={replace}
							onChange={(e) => setReplace(e.target.value)}
							placeholder='Proper word...'
						/>
					</div>
				</div>

				<div className='pt-2'>
					<Button
						variant='primary'
						fullWidth
						icon={isProcessing ? Loader2 : Eye}
						disabled={isProcessing || !find.trim()}
						onClick={handlePreview}>
						{isProcessing ? 'Scanning...' : 'Scan for Matches'}
					</Button>
				</div>
			</div>

			{preview && (
				<div className={`${ADMIN_SECTION_CLASS} animate-in slide-in-from-bottom-4`}>
					<div className={ADMIN_HEADER_CLASS}>
						<span>Review Proposed Changes ({preview.length})</span>
						<Button size='sm' variant='danger' icon={Replace} onClick={handleConfirm} disabled={preview.length === 0}>
							Apply All Updates
						</Button>
					</div>

					{preview.length === 0 ? (
						<div className='text-center py-10 text-muted-foreground italic'>No matches found in the archives.</div>
					) : (
						<div className='border border-border rounded-lg overflow-hidden bg-background'>
							<table className='w-full text-[11px] text-left border-collapse'>
								<thead className='bg-muted text-muted-foreground font-bold uppercase tracking-wider'>
									<tr>
										<th className='p-3 border-b border-border'>Context / Source</th>
										<th className='p-3 border-b border-border'>Change Preview</th>
									</tr>
								</thead>
								<tbody className='divide-y divide-border'>
									{preview.map((item, idx) => (
										<tr key={idx} className='hover:bg-muted/30'>
											<td className='p-3 align-top font-bold text-muted-foreground w-1/3'>
												<div className='uppercase text-[9px] opacity-50 mb-1'>
													{item.table}.{item.field}
												</div>
												{item.context}
											</td>
											<td className='p-3 space-y-1'>
												<div className='text-red-600 line-through opacity-60 bg-red-500/10 p-1 rounded'>
													{item.original}
												</div>
												<div className='flex items-center gap-2 text-emerald-700 font-medium bg-emerald-500/10 p-1 rounded'>
													<ArrowRight size={10} /> {item.proposal}
												</div>
											</td>
										</tr>
									))}
								</tbody>
							</table>
						</div>
					)}
				</div>
			)}
		</div>
	);
}

--- END OF features\admin\pages\BulkReplaceTool.jsx ---

--- FILE: features\admin\pages\EntityEditorPage.jsx ---
import React from 'react';
import { useParams } from 'react-router-dom';
import AdminForm from '@/features/admin/components/AdminForm'; // Import the form

export default function EntityEditorPage() {
	const { type, id } = useParams();

	return (
		<div className='max-w-5xl mx-auto'>
			{/* Page Header */}
			<div className='mb-6'>
				<h1 className='text-2xl font-serif font-bold text-foreground capitalize'>
					{id ? `Edit ${type}` : `Create New ${type}`}
				</h1>
				<p className='text-sm text-muted-foreground'>
					{id ? `ID: ${id}` : 'Fill in the details below to create a new entry.'}
				</p>
			</div>

			{/* The Dynamic Form */}
			<AdminForm
				type={type}
				id={id}
				key={`${type}-${id || 'new'}`} // <--- This forces a complete rebuild when type changes
			/>
		</div>
	);
}

--- END OF features\admin\pages\EntityEditorPage.jsx ---

--- FILE: features\admin\pages\EntityListPage.jsx ---
import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Link, useParams, useNavigate } from 'react-router-dom';
import { Edit, Plus, Search, Loader2, Copy, Trash2 } from 'lucide-react';
import { getEntities } from '@/domain/entity/api/entityService';
import { createEntity, fetchRawEntity, deleteEntity } from '@/features/admin/api/adminService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import Button from '@/shared/components/ui/Button';
import EntityBadge from '@/domain/entity/components/EntityBadge';

export default function EntityListPage() {
	const { type } = useParams();
	const navigate = useNavigate();
	const { campaignId } = useCampaign();
	const [search, setSearch] = useState('');
	const [isCloning, setIsCloning] = useState(null);
	const [isDeleting, setIsDeleting] = useState(null);

	const normalizedType = type === 'sessions' ? 'session' : type;

	const { data, isLoading, refetch } = useQuery({
		queryKey: ['admin-list', campaignId, normalizedType],
		queryFn: () => getEntities(campaignId, normalizedType),
		enabled: !!campaignId,
	});

	const filtered = (data || []).filter((item) =>
		(item.name || item.title || '').toLowerCase().includes(search.toLowerCase())
	);

	// ... (Handlers handleDuplicate and handleDelete remain same) ...
	const handleDuplicate = async (originalId) => {
		if (!confirm('Create a copy of this entity?')) return;
		setIsCloning(originalId);
		try {
			const raw = await fetchRawEntity(normalizedType, originalId);
			const copyData = {
				...raw,
				name: raw.name ? `${raw.name} (Copy)` : undefined,
				title: raw.title ? `${raw.title} (Copy)` : undefined,
				campaign_id: campaignId,
			};
			const result = await createEntity(normalizedType, copyData);
			navigate(`/dm/editor/${normalizedType}/${result.id}`);
		} catch (e) {
			console.error('Duplication failed:', e);
			alert('Failed to duplicate: ' + e.message);
			setIsCloning(false);
		}
	};

	const handleDelete = async (id) => {
		if (!confirm(`Are you sure you want to delete this ${normalizedType}? This cannot be undone.`)) return;
		setIsDeleting(id);
		try {
			await deleteEntity(normalizedType, id);
			refetch();
		} catch (e) {
			alert('Delete failed: ' + e.message);
		} finally {
			setIsDeleting(null);
		}
	};

	return (
		<div className='space-y-4 animate-in fade-in duration-300'>
			{/* Header Toolbar */}
			<div className='flex flex-col sm:flex-row sm:items-center justify-between gap-4'>
				<h1 className='text-2xl font-serif font-bold text-foreground capitalize flex items-center gap-2'>
					{type}s
					<span className='text-sm font-sans font-normal text-muted-foreground bg-muted px-2 py-0.5 rounded-full border border-border'>
						{data?.length || 0}
					</span>
				</h1>
				<Link to={`/dm/editor/${normalizedType}`}>
					<Button variant='primary' icon={Plus} size='sm'>
						Create New
					</Button>
				</Link>
			</div>

			{/* Search Bar */}
			<div className='relative'>
				<Search className='absolute left-3 top-2.5 text-muted-foreground/60' size={16} />
				<input
					type='text'
					placeholder={`Filter ${type}s...`}
					value={search}
					onChange={(e) => setSearch(e.target.value)}
					className='w-full pl-9 pr-4 py-2 bg-background border border-border rounded-lg text-sm text-foreground focus:outline-none focus:ring-1 focus:ring-amber-500 shadow-sm placeholder:text-muted-foreground/50'
				/>
			</div>

			{/* Entity List */}
			<div className='bg-background border border-border rounded-lg shadow-sm overflow-hidden'>
				<div className='divide-y divide-border'>
					{isLoading ? (
						<div className='p-12 flex justify-center text-muted-foreground'>
							<Loader2 className='animate-spin text-amber-600' />
						</div>
					) : filtered.length === 0 ? (
						<div className='p-12 text-center text-muted-foreground text-sm italic bg-muted/10'>
							{search ? `No matches for "${search}"` : `No ${type}s found. Create one to get started.`}
						</div>
					) : (
						filtered.map((item) => (
							<div
								key={item.id}
								// CHANGED: Added virtual-list-item class for CSS native virtualization
								className='virtual-list-item group flex items-center justify-between p-3 hover:bg-muted/40 transition-colors'>
								{/* Left: Info */}
								<div className='flex items-center gap-3 min-w-0 flex-1'>
									<div className='min-w-0'>
										<div className='flex items-center gap-2'>
											<span className='font-medium text-sm text-foreground truncate'>{item.name || item.title}</span>
											{item.type !== normalizedType && <EntityBadge type={item.type} size='sm' variant='subtle' />}
										</div>
										<div className='text-[11px] text-muted-foreground truncate max-w-xl'>
											{item.summary || item.narrative || item.description || 'No description'}
										</div>
									</div>
								</div>

								{/* Right: Actions */}
								<div className='flex items-center gap-2 shrink-0 ml-4 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity'>
									<EntityBadge
										type={item.type}
										size='sm'
										variant='outline'
										className='opacity-50 hidden sm:inline-flex'
									/>
									<button
										onClick={() => handleDuplicate(item.id)}
										disabled={isCloning === item.id}
										className='p-1.5 text-muted-foreground hover:text-amber-600 hover:bg-amber-500/10 rounded-md transition-colors focus:outline-none focus:ring-1 focus:ring-amber-500'
										title='Duplicate'>
										{isCloning === item.id ? (
											<Loader2 size={16} className='animate-spin text-amber-600' />
										) : (
											<Copy size={16} />
										)}
									</button>
									<Link to={`/dm/editor/${normalizedType}/${item.id}`}>
										<Button
											variant='ghost'
											size='sm'
											icon={Edit}
											className='h-8 px-2 text-muted-foreground hover:text-foreground'>
											Edit
										</Button>
									</Link>
									<button
										onClick={() => handleDelete(item.id)}
										disabled={isDeleting === item.id}
										className='p-1.5 text-muted-foreground hover:text-red-600 hover:bg-red-500/10 rounded-md transition-colors'
										title='Delete'>
										{isDeleting === item.id ? <Loader2 size={16} className='animate-spin' /> : <Trash2 size={16} />}
									</button>
								</div>
							</div>
						))
					)}
				</div>
			</div>
		</div>
	);
}

--- END OF features\admin\pages\EntityListPage.jsx ---

--- FILE: features\admin\pages\SplitPaneManager.jsx ---
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { Plus, Search, Loader2, Copy, Trash2 } from 'lucide-react';
import { getEntities } from '@/domain/entity/api/entityService';
import { createEntity, fetchRawEntity, deleteEntity } from '@/features/admin/api/adminService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import AdminForm from '@/features/admin/components/AdminForm';
import Button from '@/shared/components/ui/Button';

export default function SplitPaneManager() {
	const { type, id } = useParams();
	const navigate = useNavigate();
	const { campaignId } = useCampaign();
	const [search, setSearch] = useState('');

	// Action States
	const [isCloning, setIsCloning] = useState(null);
	const [isDeleting, setIsDeleting] = useState(null);

	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Fetch List Data
	const {
		data: entities,
		isLoading,
		refetch,
	} = useQuery({
		queryKey: ['admin-list', campaignId, normalizedType],
		queryFn: () => getEntities(campaignId, normalizedType),
		enabled: normalizedType === 'campaign' || !!campaignId,
	});

	const filtered = (entities || []).filter((item) =>
		(item.name || item.title || '').toLowerCase().includes(search.toLowerCase())
	);

	// --- ACTIONS ---

	const handleDuplicate = async (originalId, e) => {
		e.stopPropagation(); // Prevent navigation
		if (!confirm('Create a copy?')) return;

		setIsCloning(originalId);
		try {
			const raw = await fetchRawEntity(normalizedType, originalId);
			// Fix: Check for attributesList vs attributes object structure from fetchRawEntity
			// fetchRawEntity returns { ..., attributes: {...} } OR { ..., attributesList: [...] } depending on version
			// The service handles formatting for createEntity, we just need to modify the name.

			const copyData = {
				...raw,
				name: raw.name ? `${raw.name} (Copy)` : undefined,
				title: raw.title ? `${raw.title} (Copy)` : undefined,
				campaign_id: campaignId,
			};

			// If ID exists in raw data, remove it so DB creates new one
			delete copyData.id;

			const result = await createEntity(normalizedType, copyData);
			refetch(); // Refresh list
			navigate(`/dm/manage/${normalizedType}/${result.id}`);
		} catch (e) {
			alert('Failed to duplicate: ' + e.message);
		} finally {
			setIsCloning(false);
		}
	};

	const handleDelete = async (itemId, e) => {
		e.stopPropagation(); // Prevent navigation
		if (!confirm('Delete this entry?')) return;

		setIsDeleting(itemId);
		try {
			await deleteEntity(normalizedType, itemId);
			refetch();
			// If we deleted the currently selected item, go back to "Create New"
			if (id === itemId) {
				navigate(`/dm/manage/${normalizedType}`);
			}
		} catch (e) {
			alert('Delete failed: ' + e.message);
		} finally {
			setIsDeleting(null);
		}
	};

	return (
		<div className='flex h-[100vh] overflow-hidden bg-muted/10'>
			{/* --- LEFT PANE: LIST --- */}
			<div className='w-80 flex flex-col border-r border-border bg-background shrink-0 shadow-sm z-10'>
				{/* Header & Search */}
				<div className='p-3 border-b border-border space-y-3 bg-muted/10'>
					<div className='flex items-center justify-between'>
						<h2 className='text-lg font-serif font-bold capitalize text-foreground flex items-center gap-2'>
							{type}s
							<span className='text-xs font-sans font-normal text-muted-foreground bg-muted px-2 py-0.5 rounded-full border border-border'>
								{entities?.length || 0}
							</span>
						</h2>
						<Button
							onClick={() => navigate(`/dm/manage/${normalizedType}`)}
							size='sm'
							variant='primary'
							icon={Plus}
							className='h-7 px-2 text-xs'>
							New
						</Button>
					</div>
					<div className='relative'>
						<Search className='absolute left-2.5 top-2 text-muted-foreground/60' size={14} />
						<input
							type='text'
							placeholder='Filter list...'
							value={search}
							onChange={(e) => setSearch(e.target.value)}
							className='w-full pl-8 pr-3 py-1.5 bg-background border border-border rounded-md text-xs focus:outline-none focus:ring-1 focus:ring-amber-500 shadow-sm'
						/>
					</div>
				</div>

				{/* Scrollable List */}
				<div className='flex-1 overflow-y-auto custom-scrollbar'>
					{isLoading ? (
						<div className='p-8 flex justify-center'>
							<Loader2 className='animate-spin text-amber-600' />
						</div>
					) : filtered.length === 0 ? (
						<div className='p-6 text-center text-xs text-muted-foreground italic'>No matches.</div>
					) : (
						<div className='divide-y divide-border/40'>
							{filtered.map((item) => {
								const isActive = id === item.id;
								return (
									<div
										key={item.id}
										onClick={() => navigate(`/dm/manage/${normalizedType}/${item.id}`)}
										className={`group relative flex items-center w-full text-left transition-all cursor-pointer ${
											isActive ? 'bg-amber-500/10/80' : 'bg-background hover:bg-muted/50'
										}`}>
										{/* Active Marker Strip */}
										<div
											className={`absolute left-0 top-0 bottom-0 w-1 ${isActive ? 'bg-primary' : 'bg-transparent'}`}
										/>

										{/* Main Content Area */}
										<div className='flex-1 py-3 pl-4 pr-2 min-w-0'>
											<div
												className={`font-bold text-sm truncate mb-0.5 ${
													isActive ? 'text-primary' : 'text-foreground'
												}`}>
												{item.name || item.title}
											</div>
											<div className='flex items-center justify-between'>
												<div className='text-[10px] text-muted-foreground truncate w-full'>
													{item.summary || item.narrative || item.description || 'No description'}
												</div>
												{/* Status Dot */}
												{item.status && (
													<div
														title={item.status}
														className={`w-1.5 h-1.5 rounded-full shrink-0 ${
															item.status.toLowerCase().includes('active')
																? 'bg-emerald-500/100'
																: item.status.toLowerCase().includes('dead')
																? 'bg-red-500/100'
																: 'bg-slate-300'
														}`}
													/>
												)}
											</div>
										</div>

										{/* Action Buttons (Visible on Hover) */}
										<div
											className={`flex flex-col gap-1 pr-1 pl-1 ${
												isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'
											} transition-opacity`}>
											<button
												onClick={(e) => handleDuplicate(item.id, e)}
												className='p-1 text-muted-foreground hover:text-blue-600 hover:bg-blue-100 rounded'
												title='Duplicate'>
												{isCloning === item.id ? <Loader2 size={12} className='animate-spin' /> : <Copy size={12} />}
											</button>
											<button
												onClick={(e) => handleDelete(item.id, e)}
												className='p-1 text-muted-foreground hover:text-red-600 hover:bg-red-100 rounded'
												title='Delete'>
												{isDeleting === item.id ? <Loader2 size={12} className='animate-spin' /> : <Trash2 size={12} />}
											</button>
										</div>
									</div>
								);
							})}
						</div>
					)}
				</div>
			</div>

			{/* --- RIGHT PANE: EDITOR --- */}
			<div className='flex-1 overflow-y-auto bg-muted/10 p-4 md:p-8 custom-scrollbar'>
				<div className='max-w-4xl mx-auto'>
					<AdminForm key={`${normalizedType}-${id || 'new'}`} type={normalizedType} id={id} />
				</div>
			</div>
		</div>
	);
}

--- END OF features\admin\pages\SplitPaneManager.jsx ---

--- FILE: features\atlas\MapPage.jsx ---
import { useMapData } from './useMapData';
import { MapCanvas } from './components/MapCanvas';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export default function MapView() {
	const { data, navigateToMap, isLoading, currentMapKey } = useMapData();

	if (isLoading) {
		return (
			<div className='h-full flex items-center justify-center bg-[#1a1412]'>
				<LoadingSpinner text='Unrolling the parchment...' className='text-amber-500' />
			</div>
		);
	}

	return <MapCanvas data={data} onNavigate={navigateToMap} currentMapKey={currentMapKey} />;
}

--- END OF features\atlas\MapPage.jsx ---

--- FILE: features\atlas\useMapData.js ---
import { useSearchParams } from 'react-router-dom';
import { useMemo } from 'react';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getMapConfig } from './utils/mapNavigation';

export function useMapData() {
	const { campaignData } = useCampaign();
	const [searchParams, setSearchParams] = useSearchParams();

	const currentMapKey = searchParams.get('map') || 'world_maps'; // Default updated to match typical ID

	const mapConfig = useMemo(() => {
		// If campaignData comes from API/DB, ensure it matches the { maps: { ... } } structure
		return getMapConfig(currentMapKey, campaignData);
	}, [currentMapKey, campaignData]);

	const viewData = useMemo(() => {
		if (!mapConfig) return null;

		const { metadata, annotations, paths, areas, overlays } = mapConfig;

		// --- MATH FIX ---
		const scaleFactor = Math.pow(2, metadata.sizes.maxZoom);
		const bounds = [
			[-metadata.sizes.imageHeight / scaleFactor, 0],
			[0, metadata.sizes.imageWidth / scaleFactor],
		];

		// --- MARKER FLATTENING ---
		// The modular structure still passes 'annotations' as an object with categories
		const markers = [];
		if (annotations) {
			Object.entries(annotations).forEach(([categoryKey, category]) => {
				if (category.items) {
					category.items.forEach((item) => {
						markers.push({
							...item,
							category: category.name,
							categoryId: categoryKey,
							position: [Number(item.lat), Number(item.lng)],
						});
					});
				}
			});
		}

		// Process Areas
		const mapAreas = [];
		if (areas) {
			Object.values(areas).forEach((category) => {
				category.items.forEach((area) => {
					mapAreas.push({
						...area,
						positions: area.points.map((p) => p.coordinates),
					});
				});
			});
		}

		return {
			config: metadata, // mapConfig.metadata usually contains path, sizes, etc.
			bounds,
			markers,
			sessions: paths || [],
			areas: mapAreas,
			overlays: overlays || [],
		};
	}, [mapConfig]);

	const navigateToMap = (mapKey) => {
		setSearchParams({ map: mapKey });
	};

	return {
		data: viewData,
		currentMapKey,
		navigateToMap,
		isLoading: false,
	};
}

--- END OF features\atlas\useMapData.js ---

--- FILE: features\atlas\components\AtlasSidebar.jsx ---
import React, { useState } from 'react';
import { clsx } from 'clsx';
import {
	Search,
	PanelLeftClose,
	PanelLeftOpen,
	Map as MapIcon,
	ChevronRight,
	ChevronDown,
	Eye,
	EyeOff,
	Crosshair,
} from 'lucide-react';

/**
 * Sidebar Group Item
 */
const AtlasGroup = ({ group, visibility, onToggleVisibility, onNavigate }) => {
	const [isExpanded, setIsExpanded] = useState(true);
	const isGroupVisible = visibility[group.id];

	return (
		<div className='select-none'>
			{/* Header */}
			<div className='flex items-center gap-1 px-3 py-2 hover:bg-black/5 transition-colors group/header sticky top-0 bg-muted/95 backdrop-blur-sm z-10 border-b border-border/40'>
				{/* Expand Toggle */}
				<button
					onClick={() => setIsExpanded(!isExpanded)}
					className='p-0.5 text-muted-foreground/70 hover:text-foreground'>
					{isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
				</button>

				{/* Title */}
				<span
					className={clsx(
						'flex-1 text-xs font-bold uppercase tracking-wider cursor-pointer truncate',
						isGroupVisible
							? 'text-foreground'
							: 'text-muted-foreground decoration-line-through decoration-muted-foreground/50'
					)}
					onClick={() => setIsExpanded(!isExpanded)}>
					{group.label}
				</span>

				{/* Layer Visibility Toggle (Global for Group) */}
				<button
					onClick={(e) => {
						e.stopPropagation();
						onToggleVisibility(group.id);
					}}
					className={clsx(
						'p-1.5 rounded-md transition-all',
						isGroupVisible ? 'text-primary hover:bg-primary/10' : 'text-muted-foreground/50 hover:text-foreground'
					)}
					title={isGroupVisible ? 'Hide Layer' : 'Show Layer'}>
					{isGroupVisible ? <Eye size={14} /> : <EyeOff size={14} />}
				</button>
			</div>

			{/* Marker List */}
			{isExpanded && (
				<div className='pl-2 pb-1 pt-0.5 space-y-0.5'>
					{group.items.map((marker, idx) => {
						const isItemVisible = visibility[marker.id];

						return (
							<div
								key={`${group.id}-${idx}`}
								className='flex items-center gap-1 pr-2 group/item hover:bg-black/5 rounded-md'>
								{/* Navigation Button */}
								<button
									onClick={() => onNavigate(marker.position)}
									className='flex-1 flex items-center text-left gap-2 px-2 py-1.5 min-w-0'>
									<span className='opacity-50 group-hover/item:opacity-100 transition-opacity shrink-0'>
										<Crosshair size={12} />
									</span>
									<span
										className={clsx(
											'text-sm font-medium truncate transition-colors',
											isItemVisible && isGroupVisible ? 'text-foreground' : 'text-muted-foreground opacity-70'
										)}>
										{marker.label}
									</span>
								</button>

								{/* Individual Visibility Toggle */}
								<button
									onClick={() => onToggleVisibility(marker.id)}
									className={clsx(
										'p-1 rounded opacity-0 group-hover/item:opacity-100 focus:opacity-100 transition-opacity',
										isItemVisible ? 'text-muted-foreground hover:text-foreground' : 'text-muted-foreground/50'
									)}
									title={isItemVisible ? 'Hide Item' : 'Show Item'}>
									{isItemVisible ? <Eye size={12} /> : <EyeOff size={12} />}
								</button>
							</div>
						);
					})}
					{group.items.length === 0 && (
						<div className='text-[10px] text-muted-foreground/50 pl-9 italic py-1'>No locations</div>
					)}
				</div>
			)}
		</div>
	);
};

export const AtlasSidebar = ({ groups, visibility, onToggleLayer, onFlyTo }) => {
	const [search, setSearch] = useState('');
	const [desktopCollapsed, setDesktopCollapsed] = useState(false);
	const [mobileOpen, setMobileOpen] = useState(false);

	// Filter logic
	const filteredGroups = groups
		.map((g) => ({
			...g,
			items: g.items.filter((m) => m.label.toLowerCase().includes(search.toLowerCase())),
		}))
		.filter((g) => g.items.length > 0 || search === '');

	return (
		<>
			{/* COLLAPSED STATE (Desktop) */}
			{desktopCollapsed && (
				<div className='hidden lg:flex flex-col h-full border-l border-border bg-muted w-12 shrink-0 z-10 transition-all duration-300'>
					<div className='p-3 border-b border-border/50 h-14 flex items-center justify-center'>
						<button
							onClick={() => setDesktopCollapsed(false)}
							className='p-1.5 text-muted-foreground hover:text-primary hover:bg-background rounded-md transition-colors'
							title='Expand Atlas Sidebar'>
							<PanelLeftClose size={20} />
						</button>
					</div>
				</div>
			)}

			{/* SIDEBAR */}
			<div
				className={clsx(
					'flex flex-col bg-muted border-l border-border transition-all duration-300',
					// FIX: Removed global 'h-full' here.

					// Desktop Width Logic
					desktopCollapsed ? 'w-0 overflow-hidden border-none' : 'w-full lg:w-80',

					// Position Logic
					'absolute top-0 left-0 lg:relative z-[1000] lg:z-0',

					// Height Logic:
					// Mobile Closed: h-auto (just header)
					// Mobile Open: h-full (full screen overlay)
					// Desktop: h-full
					!mobileOpen ? 'h-auto bottom-auto lg:h-full' : 'h-full'
				)}>
				{/* Header */}
				<div className='p-4 border-b border-border/50 bg-muted flex flex-col gap-3'>
					<div className='flex items-center justify-between'>
						<div className='flex items-center gap-2 text-foreground font-serif font-bold'>
							<MapIcon size={18} className='text-primary' />
							<span>Atlas Index</span>
						</div>

						<div className='flex gap-1'>
							{/* Desktop Collapse */}
							<button
								onClick={() => setDesktopCollapsed(true)}
								className='hidden lg:block p-1 text-muted-foreground hover:text-primary transition-colors'
								title='Collapse Sidebar'>
								<PanelLeftOpen size={16} />
							</button>

							{/* Mobile Toggle */}
							<button
								onClick={() => setMobileOpen(!mobileOpen)}
								className='lg:hidden p-1 text-muted-foreground hover:text-foreground transition-colors'
								aria-label={mobileOpen ? 'Collapse' : 'Expand'}>
								{mobileOpen ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
							</button>
						</div>
					</div>

					{/* Search - Visible when open */}
					<div className={clsx('relative', !mobileOpen && 'hidden lg:block')}>
						<Search className='absolute left-2.5 top-2.5 text-muted-foreground/50' size={14} />
						<input
							type='text'
							placeholder='Search locations...'
							value={search}
							onChange={(e) => setSearch(e.target.value)}
							className='w-full bg-background border border-border rounded-md pl-8 pr-3 py-2 text-sm focus:ring-1 focus:ring-primary/50 focus:border-primary outline-none shadow-sm'
						/>
					</div>
				</div>

				{/* Scrollable Content */}
				<div className={clsx('flex-1 overflow-y-auto custom-scrollbar bg-muted/30', !mobileOpen && 'hidden lg:block')}>
					{filteredGroups.map((group) => (
						<AtlasGroup
							key={group.id}
							group={group}
							visibility={visibility}
							onToggleVisibility={onToggleLayer}
							onNavigate={onFlyTo}
						/>
					))}

					{filteredGroups.length === 0 && (
						<div className='p-6 text-center text-xs text-muted-foreground italic'>No locations found.</div>
					)}
				</div>
			</div>
		</>
	);
};

--- END OF features\atlas\components\AtlasSidebar.jsx ---

--- FILE: features\atlas\components\MapCanvas.jsx ---
import { useEffect, useState, useMemo, useRef } from 'react';
import { MapContainer, TileLayer, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

import { MapMarkers } from './layers/MapMarkers';
import { MapRecaps } from './layers/MapRecaps';
import { MapAreas } from './layers/MapAreas';
import { MapOverlays } from './layers/MapOverlays';
import { MapTools } from './MapTools';
import { AtlasSidebar } from './AtlasSidebar';
import { useMapCanvasViewModel } from './useMapCanvasViewModel';

// Controller to handle FlyTo from sidebar
const MapController = ({ bounds, minZoom, config, flyToTarget }) => {
	const map = useMap();
	const prevConfigRef = useRef();

	// Handle initial bounds
	useEffect(() => {
		if (!bounds) return;
		const isNewMap = prevConfigRef.current !== config.path;
		prevConfigRef.current = config.path;

		map.setMaxBounds(L.latLngBounds(bounds).pad(0.1));
		if (minZoom !== undefined) map.setMinZoom(minZoom);

		map.fitBounds(bounds, {
			animate: !isNewMap,
			duration: isNewMap ? 0 : 0.5,
		});
	}, [map, bounds, minZoom, config.path]);

	// Handle Sidebar FlyTo
	useEffect(() => {
		if (flyToTarget) {
			map.flyTo(flyToTarget, config.sizes.maxZoom - 1, {
				animate: true,
				duration: 1.5,
			});
		}
	}, [map, flyToTarget]);

	return null;
};

export const MapCanvas = ({ data, onNavigate }) => {
	if (!data) return null;

	const { config, bounds, areas } = data;
	const vm = useMapCanvasViewModel(data);
	const wrapperRef = useRef(null);
	const [flyToTarget, setFlyToTarget] = useState(null);

	const tileUrl = `https://raw.githubusercontent.com/aethere92/dnd-campaign-map/main/${config.path}/{z}/{x}_{y}.png`;
	const minZoom = 0;

	return (
		<div className='flex h-full w-full relative overflow-hidden'>
			{/* MAP AREA - First in DOM (Left side in flex row) */}
			<div
				ref={wrapperRef}
				className='flex-1 relative h-full bg-background'
				style={{
					backgroundColor: 'var(--background)',
					backgroundImage:
						'radial-gradient(circle at center, var(--border) 1px, transparent 1px), radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
					backgroundSize: '40px 40px, 20px 20px',
					backgroundPosition: '0 0, 20px 20px',
				}}>
				<MapContainer
					center={[0, 0]}
					zoom={minZoom}
					crs={L.CRS.Simple}
					minZoom={minZoom}
					maxZoom={config.sizes.maxZoom}
					scrollWheelZoom={true}
					attributionControl={false}
					zoomControl={false}
					style={{ height: '100%', width: '100%', background: 'transparent' }}>
					<MapController bounds={bounds} minZoom={minZoom} config={config} flyToTarget={flyToTarget} />

					<TileLayer key={tileUrl} url={tileUrl} noWrap={true} bounds={bounds} maxNativeZoom={config.sizes.maxZoom} />

					<MapOverlays overlays={vm.visibleOverlays} />
					{vm.showAreas && <MapAreas areas={areas} />}
					<MapRecaps sessions={vm.visibleSessions} />
					<MapMarkers markers={vm.visibleMarkers} onNavigate={onNavigate} />

					<MapTools bounds={bounds} containerRef={wrapperRef} />
				</MapContainer>
			</div>

			{/* ATLAS SIDEBAR - Second in DOM (Right side) */}
			<AtlasSidebar
				groups={vm.sidebarGroups}
				visibility={vm.visibility}
				onToggleLayer={vm.toggleLayer}
				onFlyTo={setFlyToTarget}
			/>
		</div>
	);
};

--- END OF features\atlas\components\MapCanvas.jsx ---

--- FILE: features\atlas\components\MapTools.jsx ---
import { useState, useEffect } from 'react';
import { useMap } from 'react-leaflet';
import { Maximize, Minimize, Crosshair } from 'lucide-react';
import { clsx } from 'clsx';

export const MapTools = ({ bounds, containerRef }) => {
	const map = useMap();
	const [isFullscreen, setIsFullscreen] = useState(false);

	// Sync state if user presses ESC or browser exit
	useEffect(() => {
		const onFullScreenChange = () => {
			setIsFullscreen(!!document.fullscreenElement);
		};
		document.addEventListener('fullscreenchange', onFullScreenChange);
		return () => document.removeEventListener('fullscreenchange', onFullScreenChange);
	}, []);

	const handleCenter = (e) => {
		e.stopPropagation();
		if (bounds) {
			map.fitBounds(bounds, { animate: true, duration: 1 });
		}
	};

	const toggleFullscreen = (e) => {
		e.stopPropagation();
		if (!containerRef?.current) return;

		if (!document.fullscreenElement) {
			containerRef.current.requestFullscreen().catch((err) => {
				console.error(`Error attempting to enable fullscreen: ${err.message}`);
			});
		} else {
			document.exitFullscreen();
		}
	};

	// Reusable Button Style
	const Btn = ({ onClick, icon: Icon, title, active }) => (
		<button
			onClick={onClick}
			title={title}
			className={clsx(
				'flex items-center justify-center w-8 h-8 transition-colors first:rounded-t-md last:rounded-b-md border-b last:border-b-0',
				// FIX: Semantic Theme Colors
				'bg-card border-border text-muted-foreground hover:bg-muted hover:text-primary',
				active && 'bg-primary/10 text-primary'
			)}>
			<Icon size={16} strokeWidth={2.5} />
		</button>
	);

	return (
		<div className='leaflet-top leaflet-left'>
			<div className='leaflet-control leaflet-bar !border-0 !shadow-xl !m-3 rounded-md overflow-hidden border border-border/50'>
				<Btn onClick={handleCenter} icon={Crosshair} title='Center Map' />
				<Btn
					onClick={toggleFullscreen}
					icon={isFullscreen ? Minimize : Maximize}
					title={isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen'}
					active={isFullscreen}
				/>
			</div>
		</div>
	);
};

--- END OF features\atlas\components\MapTools.jsx ---

--- FILE: features\atlas\components\useMapCanvasViewModel.js ---
import { useState, useEffect, useMemo } from 'react';
import { BookOpen, MapPin, Image as ImageIcon, Map as MapIcon } from 'lucide-react';

export function useMapCanvasViewModel(data) {
	// 1. Initialize Visibility
	const [visibility, setVisibility] = useState(() => {
		const init = { areas: false };
		if (!data) return init;

		// Initialize marker categories
		const uniqueCats = [...new Set(data.markers.map((m) => m.category))].filter(Boolean);
		uniqueCats.forEach((cat) => {
			init[`marker-cat-${cat}`] = true;
		});

		// Initialize individual markers (new)
		data.markers.forEach((m) => {
			if (m.label) init[`marker-item-${m.label}`] = true;
		});

		// Sessions/Overlays: OFF by default
		data.sessions.forEach((s) => (init[`session-${s.name}`] = false));
		data.overlays.forEach((o) => (init[`overlay-${o.name}`] = false));

		return init;
	});

	// Sync with data updates
	useEffect(() => {
		if (!data) return;
		setVisibility((prev) => {
			const next = { ...prev };
			let changed = false;

			// Sync Categories
			const uniqueCats = [...new Set(data.markers.map((m) => m.category))].filter(Boolean);
			uniqueCats.forEach((cat) => {
				const key = `marker-cat-${cat}`;
				if (next[key] === undefined) {
					next[key] = true;
					changed = true;
				}
			});

			// Sync Items
			data.markers.forEach((m) => {
				const key = `marker-item-${m.label}`;
				if (next[key] === undefined) {
					next[key] = true;
					changed = true;
				}
			});

			return changed ? next : prev;
		});
	}, [data?.markers]);

	const toggleLayer = (id) => {
		setVisibility((prev) => ({ ...prev, [id]: !prev[id] }));
	};

	// 2. Control Groups Configuration
	const sidebarGroups = useMemo(() => {
		if (!data) return [];

		const groups = [];

		// 1. Sessions
		if (data.sessions.length > 0) {
			groups.push({
				id: 'sessions-group',
				label: 'Sessions & Paths',
				items: data.sessions
					.map((s) => ({
						label: s.name,
						id: `session-${s.name}`,
						position: s.points[0]?.coordinates,
					}))
					.filter((i) => i.position),
			});
		}

		// 2. Markers by Category
		const uniqueCats = [...new Set(data.markers.map((m) => m.category))].filter(Boolean).sort();

		uniqueCats.forEach((cat) => {
			const catId = `marker-cat-${cat}`;
			const catMarkers = data.markers.filter((m) => m.category === cat);

			groups.push({
				id: catId,
				label: cat,
				items: catMarkers.map((m) => ({
					label: m.label,
					id: `marker-item-${m.label}`, // Individual ID
					position: m.position,
				})),
			});
		});

		// 3. Overlays
		if (data.overlays.length > 0) {
			groups.push({
				id: 'overlays-group',
				label: 'Overlays',
				items: data.overlays.map((o) => ({
					label: o.name,
					id: `overlay-${o.name}`,
					position: o.bounds[0],
				})),
			});
		}

		// 4. Areas
		if (data.areas.length > 0) {
			groups.push({
				id: 'areas',
				label: 'Regions & Areas',
				items: data.areas.map((a) => ({
					label: a.name,
					id: 'areas', // Shared ID for all areas for now
					position: a.positions[0],
				})),
			});
		}

		return groups;
	}, [data]);

	// 3. Filter Layers
	// Logic: Marker is visible if Category is ON AND Individual Item is ON
	const visibleMarkers = useMemo(
		() =>
			data?.markers.filter(
				(m) =>
					visibility[`marker-cat-${m.category}`] !== false && // Default to true if undefined
					visibility[`marker-item-${m.label}`] !== false
			) || [],
		[data, visibility]
	);

	const visibleSessions = useMemo(
		() => data?.sessions.filter((s) => visibility[`session-${s.name}`] || visibility['sessions-group']) || [],
		[data, visibility]
	);

	const visibleOverlays = useMemo(
		() => data?.overlays.filter((o) => visibility[`overlay-${o.name}`] || visibility['overlays-group']) || [],
		[data, visibility]
	);

	return {
		visibility,
		toggleLayer,
		sidebarGroups,
		visibleMarkers,
		visibleSessions,
		visibleOverlays,
		showAreas: visibility['areas'],
	};
}

--- END OF features\atlas\components\useMapCanvasViewModel.js ---

--- FILE: features\atlas\components\__MapLayerControl.jsx ---
import { useState, useEffect, useRef } from 'react';
import { Layers, ChevronDown, ChevronRight, Eye, EyeOff, Check } from 'lucide-react';
import { clsx } from 'clsx';
import L from 'leaflet';

// Reusable styled Group Header matching Sidebar aesthetics
const Group = ({ label, icon: Icon, children, defaultOpen = true }) => {
	const [isOpen, setIsOpen] = useState(defaultOpen);
	if (!children || children.length === 0) return null;

	return (
		<div className='mb-2'>
			<button
				onClick={(e) => {
					e.stopPropagation();
					setIsOpen(!isOpen);
				}}
				className='flex items-center w-full text-left text-[10px] font-bold uppercase tracking-widest text-muted-foreground hover:text-primary transition-colors mb-1 select-none font-sans'>
				<span className='mr-1 opacity-70'>{isOpen ? <ChevronDown size={10} /> : <ChevronRight size={10} />}</span>
				<span className='flex items-center gap-1.5'>
					{Icon && <Icon size={12} />}
					{label}
				</span>
			</button>
			{isOpen && <div className='pl-2 space-y-0.5 border-l border-black/5 ml-1'>{children}</div>}
		</div>
	);
};

// Toggle Item with explicit Checkmark UI
const ToggleItem = ({ label, checked, onChange }) => (
	<div
		className='flex items-center gap-2 cursor-pointer group px-2 py-1 hover:bg-black/5 rounded-md transition-colors select-none'
		onClick={(e) => {
			e.stopPropagation();
			onChange();
		}}>
		{/* Custom Checkbox UI - Reduced size */}
		<div
			className={clsx(
				'w-3.5 h-3.5 rounded-[3px] border flex items-center justify-center transition-all shadow-sm shrink-0',
				checked ? 'bg-amber-600 border-amber-700 text-white' : 'bg-card border-border group-hover:border-amber-400'
			)}>
			{checked && <Check size={10} strokeWidth={3.5} />}
		</div>

		<span
			className={clsx(
				'text-[11px] font-medium leading-tight pt-0.5 font-sans',
				checked ? 'text-foreground' : 'text-muted-foreground'
			)}>
			{label}
		</span>
	</div>
);

export const MapLayerControl = ({ groups, visibility, toggleLayer }) => {
	const [expanded, setExpanded] = useState(true);
	const containerRef = useRef(null);

	// Prevent Leaflet map interactions when clicking inside this control
	useEffect(() => {
		if (containerRef.current) {
			L.DomEvent.disableClickPropagation(containerRef.current);
			L.DomEvent.disableScrollPropagation(containerRef.current);
		}
	}, []);

	return (
		<div className='leaflet-top leaflet-right font-sans' style={{ pointerEvents: 'none', zIndex: 1000 }}>
			<div
				ref={containerRef}
				className={clsx(
					'leaflet-control m-3 transition-all duration-200 ease-in-out',
					// Theme colors
					'bg-[#fdfbf7] border border-[#c9c2b8] rounded-lg shadow-xl overflow-hidden'
				)}
				style={{ pointerEvents: 'auto' }}>
				{/* Header */}
				<div
					className='flex items-center justify-between p-2.5 bg-[#f2efe9] border-b border-[#c9c2b8] cursor-pointer min-w-[180px]'
					onClick={() => setExpanded(!expanded)}>
					<div className='flex items-center gap-2 text-xs font-serif font-bold text-amber-900'>
						<Layers size={14} />
						<span>Atlas Layers</span>
					</div>
					<button className='p-0.5 hover:bg-black/5 rounded text-amber-900/70'>
						{expanded ? <Eye size={12} /> : <EyeOff size={12} />}
					</button>
				</div>

				{/* Content */}
				{expanded && (
					<div className='p-2 max-h-[60vh] overflow-y-auto w-56 custom-scrollbar bg-background/50'>
						{groups.overlays?.length > 0 && (
							<Group label='Overlays' icon={groups.icons.overlays} defaultOpen={false}>
								{groups.overlays.map((l) => (
									<ToggleItem
										key={l.id}
										label={l.label}
										checked={!!visibility[l.id]}
										onChange={() => toggleLayer(l.id)}
									/>
								))}
							</Group>
						)}

						{groups.sessions?.length > 0 && (
							<Group label='Journal & Paths' icon={groups.icons.sessions} defaultOpen={false}>
								{groups.sessions.map((l) => (
									<ToggleItem
										key={l.id}
										label={l.label}
										checked={!!visibility[l.id]}
										onChange={() => toggleLayer(l.id)}
									/>
								))}
							</Group>
						)}

						{groups.markers?.length > 0 && (
							<Group label='Map Markers' icon={groups.icons.markers} defaultOpen={true}>
								{groups.markers.map((cat) => (
									<ToggleItem
										key={cat.id}
										label={cat.label}
										checked={!!visibility[cat.id]}
										onChange={() => toggleLayer(cat.id)}
									/>
								))}
							</Group>
						)}

						<div className='mt-2 pt-2 border-t border-black/5'>
							<ToggleItem
								label='Show Areas & Regions'
								checked={!!visibility['areas']}
								onChange={() => toggleLayer('areas')}
							/>
						</div>
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\atlas\components\__MapLayerControl.jsx ---

--- FILE: features\atlas\components\layers\MapAreas.jsx ---
import { Polygon, Tooltip } from 'react-leaflet';

export const MapAreas = ({ areas }) => {
	if (!areas || areas.length === 0) return null;

	return (
		<>
			{areas.map((area, idx) => (
				<Polygon
					key={`${area.name}-${idx}`}
					positions={area.positions}
					pathOptions={{
						color: area.lineColor || 'transparent',
						fillColor: area.interiorColor || '#ff0000',
						fillOpacity: 0.3,
						weight: 1,
					}}>
					<Tooltip
						permanent
						direction='center'
						className='bg-transparent border-0 shadow-none font-serif text-lg font-bold text-white drop-shadow-md text-center'>
						<div style={{ transform: `rotate(${area.textRotation || '0deg'})` }}>{area.name}</div>
					</Tooltip>
				</Polygon>
			))}
		</>
	);
};

--- END OF features\atlas\components\layers\MapAreas.jsx ---

--- FILE: features\atlas\components\layers\MapMarkers.jsx ---
import { Marker, Popup } from 'react-leaflet';
import { ArrowRight, BookOpen, Map as MapIcon } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import { resolveMarkerIcon } from '@/features/atlas/utils/markerUtils';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const MapMarkers = ({ markers, onNavigate }) => {
	const navigate = useNavigate();
	const { map: entityMap } = useEntityIndex();

	if (!markers || markers.length === 0) return null;

	return (
		<>
			{markers.map((marker, idx) => {
				const leafletIcon = resolveMarkerIcon(marker);

				const entityMatch = Array.from(entityMap.values()).find(
					(e) => e.name.toLowerCase() === marker.label.toLowerCase()
				);

				const entityAttrs = entityMatch ? parseAttributes(entityMatch.attributes) : {};

				const displayData = {
					title: marker.label,
					category:
						marker.category && marker.category !== 'default'
							? marker.category
							: entityMatch
							? entityMatch.type
							: 'Point of Interest',
					description: marker.description
						? marker.description
						: entityMatch
						? getAttributeValue(entityAttrs, ['summary', 'narrative']) || entityMatch.description
						: null,
					image: entityMatch ? resolveImageUrl(entityAttrs, 'background') : null,
				};

				const entityConfig = entityMatch ? getEntityConfig(entityMatch.type) : null;

				const handleWikiNav = (e) => {
					e.stopPropagation();
					if (entityMatch) {
						navigate(`/wiki/${entityMatch.type}/${entityMatch.id}`);
					}
				};

				const handleMapNav = (e) => {
					e.stopPropagation();
					onNavigate(marker.mapLink);
				};

				return (
					<Marker key={`${marker.label}-${idx}`} position={marker.position} icon={leafletIcon}>
						<Popup className='custom-popup-clean' closeButton={false}>
							<div className='flex flex-col w-full font-sans bg-background rounded-lg overflow-hidden border border-border shadow-sm'>
								{displayData.image && (
									<div className='h-24 w-full relative bg-muted'>
										<img src={displayData.image} alt={displayData.title} className='w-full h-full object-cover' />
										{/* FIX: Improved Gradient - Stronger fade at bottom for text readability */}
										<div className='absolute inset-0 bg-gradient-to-t from-[var(--background)] via-[var(--background)]/80 via-30% to-transparent pointer-events-none' />
									</div>
								)}

								<div className={clsx('px-4 pb-3', displayData.image ? 'pt-2 -mt-8 relative z-10' : 'pt-4')}>
									<div className='flex items-start justify-between gap-2'>
										<div>
											<span
												className={clsx(
													'text-[10px] font-bold uppercase tracking-wider block mb-0.5',
													entityConfig ? entityConfig.tailwind.text : 'text-muted-foreground'
												)}>
												{displayData.category}
											</span>
											{/* FIX: Ensure title text color is always readable (foreground) */}
											<h3 className='font-serif font-bold text-lg leading-tight text-foreground drop-shadow-sm'>
												{displayData.title}
											</h3>
										</div>
										{entityConfig && (
											<div
												className={clsx(
													'p-1.5 rounded-md border shrink-0 bg-background/80 backdrop-blur-sm',
													entityConfig.tailwind.border,
													entityConfig.tailwind.text
												)}>
												<entityConfig.icon size={14} />
											</div>
										)}
									</div>

									<div className='h-px w-full bg-border/50 my-3' />

									<div className='text-xs text-muted-foreground leading-relaxed max-h-32 overflow-y-auto custom-scrollbar'>
										{displayData.description || <span className='italic opacity-70'>No details available.</span>}
									</div>
								</div>

								{(marker.mapLink || entityMatch) && (
									<div className='bg-muted/50 p-2 border-t border-border flex flex-col gap-1'>
										{marker.mapLink && (
											<button
												onClick={handleMapNav}
												className='w-full flex items-center justify-between px-3 py-1.5 rounded hover:bg-primary/10 text-primary transition-colors text-xs font-bold uppercase tracking-wide group'>
												<span className='flex items-center gap-2'>
													<MapIcon size={12} /> Enter Location
												</span>
												<ArrowRight size={12} className='group-hover:translate-x-1 transition-transform' />
											</button>
										)}

										{entityMatch && (
											<button
												onClick={handleWikiNav}
												className='w-full flex items-center justify-between px-3 py-1.5 rounded hover:bg-background text-muted-foreground hover:text-foreground transition-colors text-xs font-semibold group'>
												<span className='flex items-center gap-2'>
													<BookOpen size={12} /> View Encyclopedia
												</span>
												<ArrowRight size={12} className='opacity-0 group-hover:opacity-100 transition-opacity' />
											</button>
										)}
									</div>
								)}
							</div>
						</Popup>
					</Marker>
				);
			})}
		</>
	);
};

--- END OF features\atlas\components\layers\MapMarkers.jsx ---

--- FILE: features\atlas\components\layers\MapOverlays.jsx ---
import { ImageOverlay } from 'react-leaflet';

export const MapOverlays = ({ overlays }) => {
	if (!overlays || overlays.length === 0) return null;

	return (
		<>
			{overlays.map((overlay, idx) => (
				<ImageOverlay
					key={`${overlay.name}-${idx}`}
					url={`${import.meta.env.BASE_URL}${overlay.image}`}
					bounds={overlay.bounds}
					opacity={1}
				/>
			))}
		</>
	);
};

--- END OF features\atlas\components\layers\MapOverlays.jsx ---

--- FILE: features\atlas\components\layers\MapRecaps.jsx ---
import { Fragment } from 'react';
import { Polyline, Marker, Popup } from 'react-leaflet';
import { Calendar } from 'lucide-react';
import { createDotIcon } from '@/features/atlas/utils/markerUtils';

export const MapRecaps = ({ sessions }) => {
	if (!sessions || sessions.length === 0) return null;

	return (
		<>
			{sessions.map((session, idx) => (
				<Fragment key={session.name}>
					<Polyline
						positions={session.points.map((p) => p.coordinates)}
						pathOptions={{ color: session.lineColor || '#d97706', weight: 3, dashArray: '8, 8', opacity: 0.7 }}
					/>

					{session.points
						.filter((p) => p.text)
						.map((point, pIdx) => (
							<Marker
								key={`${session.name}-p-${pIdx}`}
								position={point.coordinates}
								icon={createDotIcon(session.lineColor || '#d97706')}>
								<Popup closeButton={false} className='leaflet-popup-clean'>
									<div className='flex flex-col w-[200px] font-sans bg-background rounded-md overflow-hidden shadow-sm border border-border/50'>
										{/* Header */}
										<div className='px-3 py-2 bg-amber-500/10/80 border-b border-primary/20 flex items-center gap-2'>
											<Calendar size={12} className='text-primary' />
											<span className='text-[10px] font-bold uppercase tracking-wider text-primary'>
												{session.name}
											</span>
										</div>

										{/* Content */}
										<div className='p-3 px-5 text-xs text-foreground/90 leading-snug'>{point.text}</div>
									</div>
								</Popup>
							</Marker>
						))}
				</Fragment>
			))}
		</>
	);
};

--- END OF features\atlas\components\layers\MapRecaps.jsx ---

--- FILE: features\atlas\config\mapConfig.js ---

--- END OF features\atlas\config\mapConfig.js ---

--- FILE: features\atlas\data\modularize.js ---
import fs from 'fs';
import path from 'path';

// ==========================================
// CONFIGURATION
// ==========================================
const INPUT_FILE = 'campaign_01.js';

// We output deep into src so it's ready for Vite to pick up
const OUTPUT_DIR = 'campaign_01';

// ==========================================
// 1. HELPER: JS Stringifier
// ==========================================
function toJsString(obj, indentLevel = 0) {
	const indent = '\t'.repeat(indentLevel);
	const nextIndent = '\t'.repeat(indentLevel + 1);

	if (obj === null) return 'null';
	if (typeof obj === 'undefined') return 'undefined';

	// Force single quotes for strings
	if (typeof obj === 'string') {
		const escaped = obj.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
		return `'${escaped}'`;
	}

	if (typeof obj !== 'object') return String(obj);

	if (Array.isArray(obj)) {
		if (obj.length === 0) return '[]';
		// Keep coordinates [x, y] on one line
		if (obj.length === 2 && typeof obj[0] === 'number') {
			return `[${obj.join(', ')}]`;
		}
		const items = obj.map((item) => toJsString(item, indentLevel + 1));
		return `[\n${nextIndent}${items.join(`,\n${nextIndent}`)}\n${indent}]`;
	}

	const keys = Object.keys(obj);
	if (keys.length === 0) return '{}';

	const props = keys.map((key) => {
		const value = toJsString(obj[key], indentLevel + 1);
		// Don't quote simple keys
		const cleanKey = /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(key) ? key : `'${key}'`;
		return `${cleanKey}: ${value}`;
	});

	return `{\n${nextIndent}${props.join(`,\n${nextIndent}`)}\n${indent}}`;
}

// ==========================================
// 2. HELPER: Recursive Extractor
// ==========================================
function extractMapsRecursively(obj, parentId = null, collectedMaps = []) {
	// If it has metadata, we treat it as a Map configuration
	if (obj.metadata) {
		const mapId = obj.metadata.mapId || 'unknown_map';

		// Clone to avoid mutating the original deeply nested structure immediately
		const mapData = { ...obj };

		// Add explicit parent ID for navigation logic
		if (parentId) {
			mapData.parentId = parentId;
		}

		// Check for children (submaps)
		if (obj.submaps) {
			Object.keys(obj.submaps).forEach((category) => {
				const categoryObj = obj.submaps[category];
				Object.keys(categoryObj).forEach((submapKey) => {
					// Recurse down
					extractMapsRecursively(categoryObj[submapKey], mapId, collectedMaps);
				});
			});
		}

		// Clean up the object (we don't want the nested submaps in the flat config)
		delete mapData.submaps;

		collectedMaps.push({
			id: mapId,
			data: mapData,
		});
	} else {
		// If it's the root container (CAMPAIGN_01)
		Object.keys(obj).forEach((key) => {
			if (obj[key] && typeof obj[key] === 'object') {
				extractMapsRecursively(obj[key], null, collectedMaps);
			}
		});
	}
	return collectedMaps;
}

// ==========================================
// 3. MAIN PROCESS
// ==========================================
try {
	console.log(` Reading ${INPUT_FILE}...`);
	let fileContent = fs.readFileSync(INPUT_FILE, 'utf8');

	// Remove "export" keywords so we can eval it locally
	const cleanCode = fileContent.replace(/export const/g, 'const');

	// Evaluate to get the object
	const { CAMPAIGN_01 } = eval(`${cleanCode}; ({ CAMPAIGN_01 });`);

	console.log(` Flattening map hierarchy...`);
	const allMaps = extractMapsRecursively(CAMPAIGN_01);
	console.log(`   Found ${allMaps.length} maps.`);

	// Prepare Directories
	if (fs.existsSync(OUTPUT_DIR)) {
		fs.rmSync(OUTPUT_DIR, { recursive: true, force: true });
	}
	fs.mkdirSync(path.join(OUTPUT_DIR, 'maps'), { recursive: true });

	const registryImports = [];
	const registryExports = [];

	// Process every map found
	allMaps.forEach((map) => {
		const mapId = map.id;
		const mapData = map.data;
		const mapDir = path.join(OUTPUT_DIR, 'maps', mapId);

		fs.mkdirSync(mapDir, { recursive: true });

		const localImports = [];

		// -----------------------------------------------------
		// FILE EXTRACTION LOGIC
		// We replace data with strings like 'PLACEHOLDER_PATHS'
		// and then regex replace them later.
		// -----------------------------------------------------

		// 1. Paths
		if (mapData.paths && mapData.paths.length > 0) {
			const content = `export const paths = ${toJsString(mapData.paths)};`;
			fs.writeFileSync(path.join(mapDir, 'paths.js'), content);

			localImports.push(`import { paths } from './paths.js';`);
			mapData.paths = 'PLACEHOLDER_PATHS';
		}

		// 2. Annotations (POIs, NPCs, etc)
		if (mapData.annotations && Object.keys(mapData.annotations).length > 0) {
			const content = `export const annotations = ${toJsString(mapData.annotations)};`;
			fs.writeFileSync(path.join(mapDir, 'annotations.js'), content);

			localImports.push(`import { annotations } from './annotations.js';`);
			mapData.annotations = 'PLACEHOLDER_ANNOTATIONS';
		}

		// 3. Areas (Polygons)
		if (mapData.areas && Object.keys(mapData.areas).length > 0) {
			const content = `export const areas = ${toJsString(mapData.areas)};`;
			fs.writeFileSync(path.join(mapDir, 'areas.js'), content);

			localImports.push(`import { areas } from './areas.js';`);
			mapData.areas = 'PLACEHOLDER_AREAS';
		}

		// 4. Overlays
		if (mapData.overlays && mapData.overlays.length > 0) {
			const content = `export const overlays = ${toJsString(mapData.overlays)};`;
			fs.writeFileSync(path.join(mapDir, 'overlays.js'), content);

			localImports.push(`import { overlays } from './overlays.js';`);
			mapData.overlays = 'PLACEHOLDER_OVERLAYS';
		}

		// Generate the Map Config String
		let configStr = toJsString(mapData);

		// Replace Placeholders with actual variables
		// We match quotes around them because toJsString adds quotes to strings
		configStr = configStr.replace(/['"]PLACEHOLDER_PATHS['"]/g, 'paths');
		configStr = configStr.replace(/['"]PLACEHOLDER_ANNOTATIONS['"]/g, 'annotations');
		configStr = configStr.replace(/['"]PLACEHOLDER_AREAS['"]/g, 'areas');
		configStr = configStr.replace(/['"]PLACEHOLDER_OVERLAYS['"]/g, 'overlays');

		const mapVarName = mapId.toUpperCase();

		const indexContent = `
${localImports.join('\n')}

export const ${mapVarName} = ${configStr};
`;
		fs.writeFileSync(path.join(mapDir, 'index.js'), indexContent.trim());

		// Prepare Registry
		registryImports.push(`import { ${mapVarName} } from './maps/${mapId}/index.js';`);
		registryExports.push(`    [${mapVarName}.metadata.mapId]: ${mapVarName}`);
	});

	// ==========================================
	// 4. GENERATE REGISTRY
	// ==========================================
	const registryContent = `
${registryImports.join('\n')}

export const CAMPAIGN_01 = {
    name: 'Campaign 01',
    maps: {
${registryExports.join(',\n')}
    }
};
`;
	fs.writeFileSync(path.join(OUTPUT_DIR, 'index.js'), registryContent.trim());

	console.log(` Done! Created modular React structure in:`);
	console.log(`    ${OUTPUT_DIR}/`);
	console.log(`       index.js (Import this in your App)`);
	console.log(`       maps/ (Individual map configs)`);
} catch (err) {
	console.error(' Error:', err.message);
	console.error(err.stack);
}

--- END OF features\atlas\data\modularize.js ---

--- FILE: features\atlas\data\refactor.js ---
import fs from 'fs';

// 1. CONFIGURATION
const INPUT_FILE = 'campaign_01.js';
const OUTPUT_FILE = 'campaign_01_cleaned.js';

// Keys to completely remove
const KEYS_TO_REMOVE = ['icon', 'iconType', 'animation', 'pointColor', 'pointWidth', 'filter', 'loot', 'image'];

// Keys to force to the top of objects
const KEY_ORDER = ['label', 'name', 'lat', 'lng', 'coordinates', 'text'];

// 2. HELPERS

/**
 * Recursively cleans and reorders objects
 */
function cleanAndReorder(obj) {
	if (!obj || typeof obj !== 'object') {
		return obj;
	}

	if (Array.isArray(obj)) {
		return obj.map(cleanAndReorder);
	}

	const newObj = {};

	// 1. Add High Priority Keys first
	KEY_ORDER.forEach((key) => {
		if (Object.prototype.hasOwnProperty.call(obj, key)) {
			newObj[key] = cleanAndReorder(obj[key]);
		}
	});

	// 2. Add remaining keys (filtering out removed ones)
	Object.keys(obj).forEach((key) => {
		if (KEYS_TO_REMOVE.includes(key)) return;
		if (KEY_ORDER.includes(key)) return;

		newObj[key] = cleanAndReorder(obj[key]);
	});

	return newObj;
}

/**
 * Converts object to formatted JS string using single quotes
 */
function toJsString(obj, indentLevel = 0) {
	const indent = '\t'.repeat(indentLevel);
	const nextIndent = '\t'.repeat(indentLevel + 1);

	if (obj === null) return 'null';
	if (typeof obj === 'undefined') return 'undefined';

	// Force single quotes for strings
	if (typeof obj === 'string') {
		const escaped = obj.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
		return `'${escaped}'`;
	}

	if (typeof obj !== 'object') return String(obj);

	if (Array.isArray(obj)) {
		if (obj.length === 0) return '[]';

		// Keep coordinate arrays [x, y] on one line
		if (obj.length === 2 && typeof obj[0] === 'number') {
			return `[${obj.join(', ')}]`;
		}

		const items = obj.map((item) => toJsString(item, indentLevel + 1));
		return `[\n${nextIndent}${items.join(`,\n${nextIndent}`)}\n${indent}]`;
	}

	const keys = Object.keys(obj);
	if (keys.length === 0) return '{}';

	const props = keys.map((key) => {
		const value = toJsString(obj[key], indentLevel + 1);
		const cleanKey = /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(key) ? key : `'${key}'`;
		return `${cleanKey}: ${value}`;
	});

	return `{\n${nextIndent}${props.join(`,\n${nextIndent}`)}\n${indent}}`;
}

// 3. MAIN LOGIC
try {
	console.log(`Reading ${INPUT_FILE}...`);
	let fileContent = fs.readFileSync(INPUT_FILE, 'utf8');

	// Remove "export" keywords to allow local eval
	const cleanCode = fileContent.replace(/export const/g, 'const');

	// Evaluate code to get objects
	const { CAMPAIGN_01, CAMPAIGN_01_ALIASES } = eval(`
        ${cleanCode}
        ;({ CAMPAIGN_01, CAMPAIGN_01_ALIASES });
    `);

	console.log('Cleaning and reordering data...');
	const cleanedCampaign = cleanAndReorder(CAMPAIGN_01);
	const cleanedAliases = cleanAndReorder(CAMPAIGN_01_ALIASES);

	// 4. DATA EXTRACTION

	// Extract Paths
	let WORLD_MAP_PATHS = [];
	if (cleanedCampaign.world_maps?.paths) {
		WORLD_MAP_PATHS = cleanedCampaign.world_maps.paths;
		// Set placeholder
		cleanedCampaign.world_maps.paths = 'PLACEHOLDER_PATHS';
	}

	// Extract Korinis
	let KORINIS_ISLAND = null;
	if (cleanedCampaign.world_maps?.submaps?.islands?.korinis_island) {
		KORINIS_ISLAND = cleanedCampaign.world_maps.submaps.islands.korinis_island;
		cleanedCampaign.world_maps.submaps.islands.korinis_island = 'PLACEHOLDER_KORINIS';
	}

	// Extract Unnamed Island
	let UNNAMED_ISLAND = null;
	if (cleanedCampaign.world_maps?.submaps?.islands?.unnamed_island_01) {
		UNNAMED_ISLAND = cleanedCampaign.world_maps.submaps.islands.unnamed_island_01;
		cleanedCampaign.world_maps.submaps.islands.unnamed_island_01 = 'PLACEHOLDER_UNNAMED';
	}

	// 5. FILE GENERATION
	console.log('Generating output string...');

	let output = `// ==========================================
// ALIASES
// ==========================================
export const CAMPAIGN_01_ALIASES = ${toJsString(cleanedAliases)};

// ==========================================
// EXTRACTED DATA
// ==========================================

// --- World Map Paths ---
const WORLD_MAP_PATHS = ${toJsString(WORLD_MAP_PATHS)};

`;

	if (KORINIS_ISLAND) {
		output += `// --- Submap: Korinis Island ---\nconst KORINIS_ISLAND = ${toJsString(KORINIS_ISLAND)};\n\n`;
	}

	if (UNNAMED_ISLAND) {
		output += `// --- Submap: Unnamed Island ---\nconst UNNAMED_ISLAND = ${toJsString(UNNAMED_ISLAND)};\n\n`;
	}

	// Generate main string
	let mainString = toJsString(cleanedCampaign);

	// 6. REPLACE PLACEHOLDERS (Robust Regex)
	// Matches 'PLACEHOLDER' or "PLACEHOLDER"
	mainString = mainString.replace(/['"]PLACEHOLDER_PATHS['"]/g, 'WORLD_MAP_PATHS');
	mainString = mainString.replace(/['"]PLACEHOLDER_KORINIS['"]/g, 'KORINIS_ISLAND');
	mainString = mainString.replace(/['"]PLACEHOLDER_UNNAMED['"]/g, 'UNNAMED_ISLAND');

	output += `// ==========================================
// MAIN CAMPAIGN OBJECT
// ==========================================
export const CAMPAIGN_01 = ${mainString};
`;

	fs.writeFileSync(OUTPUT_FILE, output);
	console.log(`\n Success! File saved to: ${OUTPUT_FILE}`);
} catch (err) {
	console.error(' Error:', err.message);
	console.error(err.stack);
}

--- END OF features\atlas\data\refactor.js ---

--- FILE: features\atlas\utils\mapNavigation.js ---
// 1. Update the import to point to your new generated folder
// Ensure this path matches where your modularize.js script output the files
import { CAMPAIGN_01 } from '@/features/atlas/data/campaign_01/index';

/**
 * Resolves the configuration object for a specific map key.
 *
 * CHANGE: With the modular structure, all maps are now siblings
 * in the .maps object, so deep traversal/aliases are no longer needed.
 */
export const getMapConfig = (mapKey, campaignData) => {
	// 1. Use context data if provided, otherwise fallback to static generated file
	const rootData = campaignData || CAMPAIGN_01;

	// 2. Determine ID (Default to 'world_maps' if undefined)
	// Make sure 'world_maps' matches the mapId in your world map's metadata
	const targetId = mapKey || 'world_maps';

	// 3. Direct Lookup
	// The new structure is simply { maps: { [id]: { ...config } } }
	if (rootData.maps && rootData.maps[targetId]) {
		return rootData.maps[targetId];
	}

	console.warn(`[getMapConfig] Map ID not found: ${targetId}`);
	return null;
};

/**
 * Helper to calculate map bounds based on image size
 */
export const calculateBounds = (imageWidth, imageHeight) => {
	return [
		[-imageHeight, 0],
		[0, imageWidth],
	];
};

--- END OF features\atlas\utils\mapNavigation.js ---

--- FILE: features\atlas\utils\markerUtils.js ---
import React from 'react';
import L from 'leaflet';
import { renderToString } from 'react-dom/server';
import { Skull, MapPin, Castle, User, Tent, Sparkles, Home, Sword, Anchor, Mountain, Scroll } from 'lucide-react';

// 1. Map your category strings to Lucide Components
const ICON_MAP = {
	combat: Skull,
	danger: Skull,
	encounter: Sword,
	city: Castle,
	town: Home,
	village: Home,
	npc: User,
	people: User,
	camp: Tent,
	magic: Sparkles,
	shrine: Sparkles,
	port: Anchor,
	landmark: MapPin,
	dungeon: Mountain,
	quest: Scroll,
	default: MapPin,
};

// Singleton for invisible/interactive-only markers
export const invisibleIcon = L.divIcon({
	className: 'bg-transparent border-none',
	html: '<div style="width: 100%; height: 100%;"></div>',
	iconSize: [20, 20],
	iconAnchor: [10, 10],
	popupAnchor: [0, -10],
});

/**
 * Creates a "Pin" style marker using a Lucide React Icon
 */
export const createLucideMarker = (category, color = '#d97706') => {
	const normalized = category?.toLowerCase() || 'default';
	let IconComponent = ICON_MAP.default;
	for (const [key, comp] of Object.entries(ICON_MAP)) {
		if (normalized.includes(key)) {
			IconComponent = comp;
			break;
		}
	}

	const iconHtml = renderToString(
		React.createElement(IconComponent, {
			size: 14,
			strokeWidth: 3,
			color: 'white',
		})
	);

	/**
	 * STABLE SVG PIN
	 * The point is exactly at 16, 36.
	 * The circle center is at 16, 16.
	 */
	return L.divIcon({
		className: 'custom-marker-container',
		html: `
            <div class="relative group" style="width: 32px; height: 36px;">
                <svg width="32" height="36" viewBox="0 0 32 36" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.2));">
                    <!-- Pin Body -->
                    <path d="M16 36C16 36 32 26.5 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 26.5 16 36 16 36Z" fill="white"/>
                    <path d="M16 33C16 33 29 24.5 29 16C29 8.8203 23.1797 3 16 3C8.8203 3 3 8.8203 3 16C3 24.5 16 33 16 33Z" fill="${color}"/>
                    <!-- Inner Hole -->
                    <circle cx="16" cy="16" r="10" fill="white" fill-opacity="0.2"/>
                </svg>
                <!-- Icon Overlay -->
                <div class="absolute top-[8px] left-[8px] w-[16px] h-[16px] flex items-center justify-center pointer-events-none transition-transform group-hover:-translate-y-0.5">
                    ${iconHtml}
                </div>
            </div>
        `,
		iconSize: [32, 36],
		iconAnchor: [16, 36], // EXACT BOTTOM CENTER
		popupAnchor: [0, -36],
	});
};

// Text Label Marker Generator
export const createTextMarker = (label, fontSize) => {
	const sizeStyle = fontSize ? `${fontSize}px` : '1.5rem';
	return L.divIcon({
		className: 'map-text-marker',
		html: `
            <div style="transform: translate(-50%, -50%); width: max-content; text-align: center; display: flex; justify-content: center; align-items: center;">
                <span style="font-family: 'Inter', sans-serif; text-transform: uppercase; font-weight: 600; font-size: ${sizeStyle}; color: #2c1a0e; text-shadow: 0 0 4px #fdfbf7, 0 0 8px #fdfbf7, 0 0 15px #fdfbf7; pointer-events: auto; cursor: pointer; white-space: nowrap;">
                    ${label}
                </span>
            </div>`,
		iconSize: [0, 0],
		iconAnchor: [0, 0],
		popupAnchor: [0, -10],
	});
};

/**
 * Logic Hub: Resolves the appropriate Leaflet icon
 */
export const resolveMarkerIcon = (marker) => {
	const { icon, type, label, fontSize, category } = marker;

	// 1. Existing Text Marker logic
	if (type === 'text' || icon === 'text') {
		return createTextMarker(label, fontSize);
	}

	// 2. Invisible / Null Icon
	if (!icon && !category) {
		return invisibleIcon;
	}

	// 3. Lucide Marker logic
	let markerColor = '#d97706';
	const cat = category?.toLowerCase() || '';
	if (cat.includes('combat') || cat.includes('danger')) markerColor = '#dc2626'; // Red
	if (cat.includes('magic') || cat.includes('shrine')) markerColor = '#7c3aed'; // Purple
	if (['city', 'location', 'town', 'points of interest'].includes(cat)) markerColor = '#059669'; // Emerald
	if (cat.includes('city') || cat.includes('town')) markerColor = '#1e40af'; // Blue
	if (['npcs', 'people'].includes(cat)) markerColor = '#d97706'; // Orange

	return createLucideMarker(category, markerColor);
};

// For session paths/dots
export const createDotIcon = (color) =>
	L.divIcon({
		className: 'path-dot',
		html: `<div style="background-color: ${color};" class="w-3 h-3 rounded-full border-2 border-white shadow-sm"></div>`,
		iconSize: [12, 12],
		iconAnchor: [6, 6],
	});

--- END OF features\atlas\utils\markerUtils.js ---

--- FILE: features\campaign\CampaignContext.jsx ---
import { createContext, useContext } from 'react';
import { useCampaignPersistence } from './useCampaignPersistence';

const CampaignContext = createContext(null);

export const CampaignProvider = ({ children }) => {
	const persistence = useCampaignPersistence();

	return <CampaignContext.Provider value={persistence}>{children}</CampaignContext.Provider>;
};

export const useCampaign = () => {
	const context = useContext(CampaignContext);
	if (!context) {
		throw new Error('useCampaign must be used within CampaignProvider');
	}
	return context;
};

--- END OF features\campaign\CampaignContext.jsx ---

--- FILE: features\campaign\useCampaignPersistence.js ---
import { useState, useCallback } from 'react';

const STORAGE_KEY = 'campaignId';

// Safe wrapper for environments where localStorage might fail
const storage = {
	getItem: (key) => {
		try {
			return localStorage.getItem(key) || sessionStorage.getItem(key);
		} catch {
			return null;
		}
	},
	setItem: (key, value) => {
		try {
			localStorage.setItem(key, value);
		} catch {
			sessionStorage.setItem(key, value);
		}
	},
	removeItem: (key) => {
		try {
			localStorage.removeItem(key);
			sessionStorage.removeItem(key);
		} catch {
			// ignore
		}
	},
};

export function useCampaignPersistence() {
	const [campaignId, setCampaignIdState] = useState(() => {
		return storage.getItem(STORAGE_KEY) || null;
	});

	const setCampaignId = useCallback((id) => {
		setCampaignIdState(id);
		if (id) {
			storage.setItem(STORAGE_KEY, id);
		} else {
			storage.removeItem(STORAGE_KEY);
		}
	}, []);

	return { campaignId, setCampaignId };
}

--- END OF features\campaign\useCampaignPersistence.js ---

--- FILE: features\campaign\useCampaignSelection.js ---
import { useQuery } from '@tanstack/react-query';
import { useNavigate } from 'react-router-dom';
import { getCampaigns } from '@/features/campaign/api/campaignService';
import { useCampaign } from './CampaignContext';
// import './types';

export function useCampaignSelection() {
	const { setCampaignId } = useCampaign();
	const navigate = useNavigate(); // 2. Initialize hook

	const { data: campaigns, isLoading } = useQuery({
		queryKey: ['campaigns'],
		queryFn: getCampaigns,
	});

	// Sort by ID
	const sortedCampaigns = (campaigns || []).sort((a, b) => String(a.campaign_id).localeCompare(String(b.campaign_id)));

	const selectCampaign = (id) => {
		setCampaignId(id);
		navigate('/'); // 3. Force navigation to the main app route
	};

	return {
		isLoading,
		campaigns: sortedCampaigns,
		selectCampaign,
	};
}

--- END OF features\campaign\useCampaignSelection.js ---

--- FILE: features\campaign\api\campaignService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getCampaigns = async () => {
	/**
	 * OPTIMIZATION:
	 * Instead of fetching all entities and filtering in JS or via multiple query params,
	 * we join 'view_active_party'. This SQL view already filters for:
	 * (attributes->>'is_active')::boolean = true
	 */
	const { data, error } = await supabase.from('campaigns').select(`
            id,
            campaign_id,
            name, 
            description,
            attributes,
            active_characters:view_active_party(name)
        `);

	if (error) {
		console.error('[campaignService] Error fetching campaigns:', error);
		throw error;
	}

	// Clean up the nested structure
	return data.map((campaign) => ({
		...campaign,
		// Map the view results to the characterNames array used by the UI
		characterNames: campaign.active_characters?.map((c) => c.name) || [],
	}));
};

--- END OF features\campaign\api\campaignService.js ---

--- FILE: features\campaign\components\CampaignCard.jsx ---
import { ArrowRight, Users, Map, BookOpen } from 'lucide-react';
import Button from '@/shared/components/ui/Button';
import { clsx } from 'clsx';

export const CampaignCard = ({ campaign, onSelect }) => {
	const initial = (campaign.name?.[0] || 'C').toUpperCase();
	const bgImage = campaign.attributes?.background_image;
	const campaignIcon = campaign.attributes?.icon; // Check for icon in attributes
	const mapData = campaign.attributes?.map_data ? 'Atlas active' : 'No Atlas';

	// Fallback pattern if no image is provided
	const hasBg = !!bgImage;

	return (
		<div className='group relative flex flex-col h-full bg-card rounded-xl border border-border hover:border-primary shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden'>
			{/* Banner / Header Image */}
			<div className={clsx('relative h-32 w-full shrink-0 overflow-hidden', !hasBg && 'bg-muted')}>
				{hasBg ? (
					<img
						src={bgImage}
						alt='Campaign Cover'
						className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
					/>
				) : (
					<div
						className='absolute inset-0 opacity-10'
						style={{
							backgroundImage: 'radial-gradient(circle at 2px 2px, currentColor 1px, transparent 0)',
							backgroundSize: '16px 16px',
						}}
					/>
				)}

				{/* Gradient Overlay for Text Readability/Transition */}
				<div className='absolute inset-0 bg-gradient-to-t from-card via-card/20 to-transparent' />
			</div>

			{/* Card Content */}
			<div className='flex flex-col flex-1 px-6 pb-6 relative'>
				{/* Avatar Badge (Icon or Initial) */}
				<div className='-mt-12 mb-6'>
					<div className='w-20 h-20 border-border rounded-xl bg-background border hover:shadow-md flex items-center justify-center overflow-hidden transition-colors'>
						{campaignIcon ? (
							<img src={campaignIcon} alt={`${campaign.name} icon`} className='w-full h-full object-cover' />
						) : (
							<span className='text-4xl font-serif font-bold text-primary/80 group-hover:text-primary'>{initial}</span>
						)}
					</div>
				</div>

				{/* Title & Description */}
				<div className='mb-6'>
					<h3 className='text-[clamp(1rem,5vw,1.2rem)] font-bold font-serif text-foreground leading-tight mb-2 group-hover:text-primary transition-colors'>
						{campaign.name}
					</h3>
					<p className='text-sm text-muted-foreground line-clamp-5 leading-relaxed'>
						{campaign.description || 'A journey into the unknown.'}
					</p>
				</div>

				{/* Metadata / Stats Row */}
				<div className='mt-auto pt-4 border-t border-border/50 grid grid-cols-2 gap-4 mb-6'>
					<div className='flex flex-col'>
						<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/70 mb-1 flex items-center gap-1.5'>
							<Users size={10} /> Party Size
						</span>
						<span className='text-sm font-medium text-foreground'>{campaign.characterNames?.length || 0} Heroes</span>
					</div>
					<div className='flex flex-col'>
						<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/70 mb-1 flex items-center gap-1.5'>
							<Map size={10} /> Setting
						</span>
						<span className='text-sm font-medium text-foreground'>{mapData}</span>
					</div>
				</div>

				{/* Action Button */}
				<Button
					onClick={() => onSelect(campaign.id)}
					fullWidth
					variant='outline'
					className='bg-primary text-primary-foreground border-primary transition-colors'
					icon={ArrowRight}>
					Enter Campaign
				</Button>
			</div>
		</div>
	);
};

--- END OF features\campaign\components\CampaignCard.jsx ---

--- FILE: features\campaign\components\CampaignSelect.jsx ---
import { useCampaignSelection } from '@/features/campaign/useCampaignSelection';
import { CampaignCard } from './CampaignCard';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { useTheme } from '@/shared/hooks/useTheme';
import { useMemo } from 'react';

export default function CampaignSelect() {
	// 1. Initialize Theme to ensure dark mode works on full-page reload
	const { theme } = useTheme();
	const isDark = theme === 'dark';

	const { campaigns, isLoading, selectCampaign } = useCampaignSelection();
	const logoPath = `${import.meta.env.BASE_URL}logo_detailed.png`;

	const backgroundStyle = useMemo(() => {
		if (isDark) {
			return {
				backgroundImage:
					'radial-gradient(circle at center, rgba(255,255,255,0.05) 1px, transparent 1px), radial-gradient(circle at center, rgba(255,255,255,0.03) 1px, transparent 1px)',
				backgroundSize: '40px 40px, 20px 20px',
				backgroundPosition: '0 0, 20px 20px',
				backgroundColor: 'var(--background)',
			};
		}
		return {
			backgroundColor: 'var(--background)',
			opacity: 0.9,
		};
	}, [isDark]);

	if (isLoading) {
		return (
			<div className='h-full w-full bg-muted flex flex-col items-center justify-center'>
				<LoadingSpinner size='lg' text='Consulting the Archives...' />
			</div>
		);
	}

	return (
		<div
			className='h-full w-full overflow-y-auto custom-scrollbar font-sans bg-background text-foreground'
			style={backgroundStyle}>
			<div className='min-h-full w-full flex items-center justify-center p-6 md:p-12'>
				<div className='max-w-6xl w-full mx-auto'>
					{/* Header Section */}
					<div className='text-center mb-12 animate-in fade-in slide-in-from-top-4 duration-700'>
						<img src={logoPath} alt='Logo' className='h-32 md:h-40 mx-auto mb-8 drop-shadow-2xl' />
						<h1 className='text-4xl md:text-5xl font-serif font-bold text-foreground mb-4'>Select Campaign</h1>
						<p className='text-muted-foreground text-lg max-w-xl mx-auto'>
							Choose a world to enter. Your adventures, characters, and chronicles await.
						</p>
					</div>

					{/* Grid Section */}
					<div className='flex flex-wrap justify-center gap-8 pb-8'>
						{campaigns.map((campaign) => (
							<div key={campaign.id} className='w-full md:w-[calc(50%-1rem)] lg:w-[calc(33.33%-1.5rem)] max-w-sm'>
								<CampaignCard campaign={campaign} onSelect={selectCampaign} />
							</div>
						))}

						{campaigns.length === 0 && (
							<div className='w-full py-20 text-center border-2 border-dashed border-border rounded-xl bg-card/50 backdrop-blur-sm shadow-sm'>
								<p className='text-muted-foreground/70 font-serif text-xl'>No campaigns found in the library.</p>
							</div>
						)}
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\campaign\components\CampaignSelect.jsx ---

--- FILE: features\dashboard\DashboardPage.jsx ---
import { useQuery } from '@tanstack/react-query';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getDashboardData } from '@/features/dashboard/api/dashboardService';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';

import { CampaignHeader } from './components/CampaignHeader';
import { CurrentArcMetadata } from './components/CurrentArcMetadata';
import { CurrentStoryStack } from './components/CurrentStoryStack';
import { ArchiveTree } from './components/ArchiveTree';
import { InsightsGrid } from './components/InsightsGrid';
import { PartyWidget } from './components/PartyWidget';
import { ActiveThreads } from './components/ActiveThreads';

export default function DashboardView() {
	const { campaignId } = useCampaign();

	const { data, isLoading } = useQuery({
		queryKey: ['dashboard_final', campaignId],
		queryFn: () => getDashboardData(campaignId),
		enabled: !!campaignId,
		staleTime: 1000 * 60 * 5,
	});

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text='Opening chronicle...' fullScreen />;

	const { campaign, counts, currentArc, otherArcs, activeParty, activeThreads, stats } = data || {};

	const currentSessions = currentArc?.sessions || [];
	const latestSession = currentArc?.latestSession;
	const otherCurrentSessions = currentSessions.filter((s) => s.id !== latestSession?.id);

	return (
		<div className='h-full overflow-y-auto bg-background custom-scrollbar'>
			<div className='p-6 pb-12'>
				<div className='max-w-[1600px] mx-auto space-y-12'>
					{/* ROW 1: Campaign Hero */}
					<div className='w-full'>
						<CampaignHeader campaign={campaign} counts={counts} />
					</div>

					{/* ROW 2: Main Story Area */}
					<div className='grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch lg:min-h-[600px]'>
						{/* Left: Metadata */}
						<div className='lg:col-span-3'>
							<CurrentArcMetadata arc={currentArc?.data} />
						</div>

						{/* Middle: Unified Story Stack */}
						<div className='lg:col-span-6'>
							<CurrentStoryStack latestSession={latestSession} previousSessions={otherCurrentSessions} />
						</div>

						{/* Right: Archive */}
						<div className='lg:col-span-3'>
							<ArchiveTree arcs={otherArcs} />
						</div>
					</div>

					<SectionDivider className='my-6' />

					{/* ROW 3: Active Party */}
					<PartyWidget party={activeParty} />

					<SectionDivider className='my-6 mb-12' />

					{/* ROW 4: Status Panel (Insights & Threads) */}
					<div className='bg-card/30 border border-border rounded-xl p-8 relative overflow-hidden min-h-[400px]'>
						<div
							className='absolute inset-0 opacity-[0.03] pointer-events-none'
							style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '24px 24px' }}
						/>

						<div className='grid grid-cols-1 lg:grid-cols-12 gap-12 relative z-10 h-full'>
							{/* Insights - Expanded to 8 columns */}
							<div className='lg:col-span-8 h-full'>
								<InsightsGrid stats={stats} counts={counts} />
							</div>

							{/* Threads - 4 columns */}
							<div className='lg:col-span-4 h-full sm:border-l sm:border-border/50 sm:pl-8'>
								<ActiveThreads quests={activeThreads} />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\dashboard\DashboardPage.jsx ---

--- FILE: features\dashboard\api\dashboardService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getDashboardData = async (campaignId) => {
	const [{ data: campaign }, { data: stats }, { data: activeParty }, { data: activeThreads }, { data: sessions }] =
		await Promise.all([
			supabase.from('campaigns').select('*').eq('id', campaignId).single(),
			supabase.from('view_dashboard_stats').select('*').eq('campaign_id', campaignId).single(),
			supabase.from('view_active_party').select('*').eq('campaign_id', campaignId),
			supabase.from('view_active_quests').select('*').eq('campaign_id', campaignId),
			supabase
				.from('view_session_arcs')
				.select('*')
				.eq('campaign_id', campaignId)
				.order('session_number', { ascending: false }),
		]);

	const allSessions = sessions || [];
	const latestSession = allSessions[0];

	// 1. Sort Threads (Quests)
	// Order: Main > Personal > Side, then by Priority
	const sortedThreads = sortThreads(activeThreads || []);

	// 2. Identify Current Arc
	const currentArcId = latestSession?.arc_id;

	// 3. Group Sessions into Arcs
	const arcMap = new Map();

	allSessions.forEach((session) => {
		if (!session.arc_id) return;

		if (!arcMap.has(session.arc_id)) {
			arcMap.set(session.arc_id, {
				id: session.arc_id,
				title: session.arc_title,
				description: session.arc_description,
				order: session.arc_order,
				attributes: session.arc_attributes,
				sessions: [],
			});
		}
		arcMap.get(session.arc_id).sessions.push(session);
	});

	// 4. Format Arcs
	const fullTimeline = Array.from(arcMap.values()).sort((a, b) => (b.order || 0) - (a.order || 0));
	const currentArcData = fullTimeline.find((a) => a.id === currentArcId);
	const otherArcs = fullTimeline.filter((a) => a.id !== currentArcId);

	const counts = {
		sessions: allSessions.length,
		arcs: fullTimeline.length,
		quests: sortedThreads.length,
		npcs: stats?.unique_npcs || 0,
		locations: stats?.unique_locations || 0,
		encounters: stats?.total_encounters || 0,
	};

	return {
		campaign,
		stats,
		activeParty: activeParty || [],
		activeThreads: sortedThreads, // Return the sorted list
		currentArc: {
			data: currentArcData,
			latestSession,
			sessions: currentArcData?.sessions || [],
		},
		otherArcs,
		progression: allSessions,
		counts,
	};
};

// --- Helper: Sorting Logic ---
function sortThreads(quests) {
	// Lower number = Higher importance
	const typeWeights = {
		'main quest': 1,
		'personal quest': 2,
		'side quest': 3,
	};

	const priorityWeights = {
		critical: 1,
		high: 2,
		medium: 3,
		normal: 4,
		low: 5,
	};

	return [...quests].sort((a, b) => {
		const typeA = (a.attributes?.type || '').toLowerCase();
		const typeB = (b.attributes?.type || '').toLowerCase();

		// 1. Primary Sort: Type
		// Default to 4 (bottom) if type is unknown
		const wA = typeWeights[typeA] || 4;
		const wB = typeWeights[typeB] || 4;

		if (wA !== wB) return wA - wB;

		// 2. Secondary Sort: Priority
		const prioA = (a.attributes?.priority || '').toLowerCase();
		const prioB = (b.attributes?.priority || '').toLowerCase();

		const pA = priorityWeights[prioA] || 4; // Default to Normal
		const pB = priorityWeights[prioB] || 4;

		return pA - pB;
	});
}

--- END OF features\dashboard\api\dashboardService.js ---

--- FILE: features\dashboard\components\ActiveThreads.jsx ---
import { useNavigate } from 'react-router-dom';
import { Scroll } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const ActiveThreads = ({ quests }) => {
	const navigate = useNavigate();
	// Show more quests now that we have height
	const displayQuests = quests?.slice(0, 12) || [];

	const handleRowClick = (id, e) => {
		// If the user clicked a link inside SmartMarkdown, don't trigger the row click
		if (e.target.tagName === 'A' || e.target.closest('a')) {
			return;
		}
		navigate(`/wiki/quest/${id}`);
	};

	return (
		<div className='h-full flex flex-col'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-6 shrink-0'>
				Active Threads
			</h4>

			<div className='space-y-3 overflow-y-auto custom-scrollbar flex-1 min-h-0 pr-2'>
				{displayQuests.map((quest) => {
					const priority = (quest.attributes?.priority || 'normal').toLowerCase();
					const isMain = (quest.attributes?.type || '').toLowerCase() === 'main quest';

					let prioColor = 'text-muted-foreground/50';
					if (priority === 'critical') prioColor = 'text-red-500';
					else if (priority === 'high') prioColor = 'text-orange-500';
					else if (isMain) prioColor = 'text-amber-500';

					return (
						<div
							key={quest.id}
							onClick={(e) => handleRowClick(quest.id, e)}
							className='block group py-1 cursor-pointer relative'>
							<div className='flex gap-1 min-w-0 justify-between'>
								<div
									className={clsx(
										'text-sm font-serif font-medium leading-snug group-hover:text-primary transition-colors line-clamp-1 truncate',
										isMain ? 'text-foreground font-bold' : 'text-foreground/80'
									)}>
									{/* Now safe to use because parent is a div, not an <a> */}
									<SmartMarkdown>{quest.title || quest.name}</SmartMarkdown>
								</div>

								<div className='flex items-center justify-between'>
									<span />
									{priority !== 'normal' && priority !== 'low' && (
										<span className={clsx('text-[9px] uppercase font-bold tracking-wider', prioColor)}>{priority}</span>
									)}
								</div>
							</div>
						</div>
					);
				})}

				{quests?.length === 0 && (
					<div className='text-center py-6 text-muted-foreground'>
						<Scroll size={24} className='mx-auto mb-2 opacity-20' />
						<p className='text-xs italic'>No active threads recorded.</p>
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\ActiveThreads.jsx ---

--- FILE: features\dashboard\components\ArchiveTree.jsx ---
import { Link } from 'react-router-dom';
import { ChevronRight, Folder } from 'lucide-react';
import { useState } from 'react';

export const ArchiveTree = ({ arcs }) => {
	return (
		<div className='bg-card border border-border rounded-xl p-6 h-full overflow-hidden flex flex-col hover:shadow-sm transition-all duration-300'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2'>
				<Folder size={12} /> Campaign Archive
			</h4>

			<div className='flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4'>
				{arcs.map((arc) => (
					<ArchiveArcItem key={arc.id} arc={arc} />
				))}
				{arcs.length === 0 && (
					<div className='text-xs text-muted-foreground italic opacity-50 text-center py-8'>
						No archived arcs found.
					</div>
				)}
			</div>
		</div>
	);
};

const ArchiveArcItem = ({ arc }) => {
	// MODIFICATION: Default to true
	const [isOpen, setIsOpen] = useState(true);

	return (
		<div>
			<button
				onClick={() => setIsOpen(!isOpen)}
				className='w-full flex items-center justify-between text-left group mb-1 hover:bg-muted/50 p-1 rounded transition-colors'>
				<div className='min-w-0'>
					<div className='text-[10px] font-bold uppercase text-muted-foreground group-hover:text-primary'>
						Arc {arc.order}
					</div>
					<div className='text-sm font-serif font-bold truncate text-foreground'>{arc.title}</div>
				</div>
				<ChevronRight size={14} className={`text-muted-foreground transition-transform ${isOpen ? 'rotate-90' : ''}`} />
			</button>

			{isOpen && (
				<div className='pl-3 ml-1 border-l border-border mt-1 space-y-1 mb-3 animate-in slide-in-from-top-1 duration-200'>
					{arc.sessions.map((session) => (
						<Link
							key={session.id}
							to={`/wiki/session/${session.id}`}
							className='block text-xs py-1.5 px-2 rounded text-muted-foreground hover:text-foreground hover:bg-muted/50 truncate transition-colors'>
							<span className='font-bold mr-2 opacity-50'>#{session.session_number}</span>
							{session.title}
						</Link>
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\dashboard\components\ArchiveTree.jsx ---

--- FILE: features\dashboard\components\CampaignHeader.jsx ---
import { Layers, Scroll, MapPin, Users, Swords, Crown, Box } from 'lucide-react';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { HighlightBadge } from '@/shared/components/ui/HighlightBadge';

export const CampaignHeader = ({ campaign, counts }) => {
	return (
		<div className='flex flex-col gap-4 mb-12 items-center text-center max-w-4xl mx-auto'>
			{/* 1. Meta Label */}
			<div className='flex items-center gap-2 text-xs font-bold uppercase tracking-[0.2em] text-primary/70'>
				<Crown size={12} />
				Campaign Chronicle
			</div>

			{/* 2. Title */}
			<h1 className='text-5xl md:text-7xl font-serif font-bold text-foreground tracking-tight leading-none'>
				{campaign?.name}
			</h1>

			{/* 3. Description (Limited width for readability) */}
			<div className='max-w-2xl text-base text-muted-foreground leading-relaxed font-serif'>
				<SmartMarkdown components={{ p: 'span' }}>{campaign?.description || 'No description available.'}</SmartMarkdown>
			</div>

			{/* 4. Stats Row (Using Swimlane Badge Style) */}
			<div className='flex flex-wrap justify-center gap-6 mt-4'>
				<HighlightBadge icon={Layers} count={counts?.sessions} label='Sessions' />
				<HighlightBadge icon={Crown} count={counts?.arcs} label='Story Arcs' />
				<HighlightBadge icon={Users} count={counts?.npcs} label='NPCs' />
				<HighlightBadge icon={MapPin} count={counts?.locations} label='Locations' />
				<HighlightBadge icon={Swords} count={counts?.encounters} label='Encounters' />
				<HighlightBadge icon={Scroll} count={counts?.quests} label='Quests' />
			</div>

			<div className='w-24 h-px bg-border mt-6' />
		</div>
	);
};

--- END OF features\dashboard\components\CampaignHeader.jsx ---

--- FILE: features\dashboard\components\CurrentArcMetadata.jsx ---
import { Map, Crown } from 'lucide-react'; // Swapped icons
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const CurrentArcMetadata = ({ arc }) => {
	return (
		<div className='bg-card border border-border rounded-xl p-8 h-full flex flex-col hover:shadow-sm relative overflow-hidden group'>
			{/* Subtle background decoration - Moved to bottom right and changed to Map for adventure feel */}
			<div className='absolute -right-10 -bottom-10 text-muted-foreground/5 pointer-events-none group-hover:scale-110 transition-transform duration-1000'>
				<Map size={180} />
			</div>

			{/* Metadata Header */}
			<div className='relative z-10 flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-primary mb-6'>
				<span className='flex items-center gap-1.5'>
					{/* Changed Hash to Layers for a "Story Layer" feel */}
					{arc?.order ? `# Arc ${arc.order}` : 'Current Arc'}
				</span>
				<span className='text-muted-foreground/30'>|</span>
				<span className='text-muted-foreground'>{arc?.attributes?.type || 'Major Arc'}</span>
			</div>

			{/* Title */}
			<h2 className='relative z-10 text-4xl font-serif font-bold text-foreground mb-6 leading-tight'>
				{arc?.title || 'Uncategorized Stories'}
			</h2>

			{/* Description */}
			<div className='relative z-10 text-sm text-muted-foreground leading-relaxed font-serif prose prose-invert max-w-none'>
				<SmartMarkdown components={{ p: 'span' }}>
					{arc?.description || 'No description available for this narrative arc.'}
				</SmartMarkdown>
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\CurrentArcMetadata.jsx ---

--- FILE: features\dashboard\components\CurrentStoryStack.jsx ---
import { Link } from 'react-router-dom';
import { ArrowRight, Calendar, BookOpen, Clock, History } from 'lucide-react';
import { formatDate } from '@/shared/utils/textUtils';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { clsx } from 'clsx';

export const CurrentStoryStack = ({ latestSession, previousSessions }) => {
	if (!latestSession) return null;

	const bgImage = latestSession.image;
	// If no previous sessions, the list section is hidden and hero takes full height
	const hasHistory = previousSessions && previousSessions.length > 0;

	return (
		<div className='flex flex-col h-full bg-card border border-border rounded-xl hover:shadow-md overflow-hidden transition-all duration-500 group'>
			{/* --- TOP SECTION: LATEST SESSION (HERO) --- */}
			{/* flex-1 ensures it fills all available space not taken by the list */}
			<div className='relative flex-1 min-h-[300px] flex flex-col overflow-hidden'>
				{/* Background Image Layer */}
				<div className='absolute inset-0 z-0'>
					{bgImage ? (
						<img
							src={bgImage}
							alt='Session Background'
							className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
						/>
					) : (
						<div className='w-full h-full bg-muted/20 flex items-center justify-center'>
							<BookOpen size={64} className='text-muted-foreground/10' />
						</div>
					)}
					{/* Gradient: Darkens text area, fades to transparent at top */}
					<div className='absolute inset-0 bg-gradient-to-t from-background via-background/90 to-transparent opacity-90' />
				</div>

				{/* Content Layer */}
				<div className='relative z-10 p-8 flex flex-col h-full'>
					{/* Badge */}
					<div className='flex justify-between items-start mb-auto'>
						<div className='bg-primary/90 text-primary-foreground backdrop-blur-md px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest hover:shadow-sm'>
							Latest Session
						</div>
						{/* Date */}
						<div className='text-[10px] font-bold text-muted-foreground bg-background/50 backdrop-blur px-2 py-1 rounded border border-white/10 flex items-center gap-1'>
							<Calendar size={10} />
							{formatDate(latestSession.session_date)}
						</div>
					</div>

					{/* Text Content */}
					<div className='mt-8'>
						<span className='text-xs font-bold text-primary mb-1 block uppercase tracking-wider'>
							Session {latestSession.session_number}
						</span>

						<h3 className='text-3xl md:text-4xl font-serif font-bold text-foreground mb-4 leading-tight group-hover:text-primary transition-colors'>
							{latestSession.title}
						</h3>

						<div className='text-sm text-muted-foreground line-clamp-6 mb-6 prose prose-invert max-w-none leading-relaxed'>
							<SmartMarkdown components={{ p: 'span' }}>
								{latestSession.narrative || 'No summary recorded.'}
							</SmartMarkdown>
						</div>

						<Link
							to={`/wiki/session/${latestSession.id}`}
							className='inline-flex items-center gap-2 px-5 py-2.5 bg-primary text-primary-foreground text-xs font-bold uppercase tracking-wider rounded-lg hover:bg-primary/90 transition-all shadow-lg shadow-primary/20'>
							Read Full Log <ArrowRight size={14} />
						</Link>
					</div>
				</div>
			</div>

			{/* --- BOTTOM SECTION: PREVIOUS CHAPTERS (LIST) --- */}
			{/* flex-none ensures it only takes the space it needs */}
			{hasHistory && (
				<div className='flex-none bg-muted/30 border-t border-border p-6'>
					<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-3 flex items-center gap-2'>
						<History size={12} /> Previous Chapters
					</h4>

					<div className='space-y-1'>
						{previousSessions.map((session) => (
							<Link
								key={session.id}
								to={`/wiki/session/${session.id}`}
								className='flex items-center gap-3 p-2 rounded hover:bg-background/80 hover:shadow-sm border border-transparent hover:border-border transition-all group/item'>
								<span className='text-xs font-bold text-muted-foreground group-hover/item:text-primary w-8 text-center shrink-0 bg-background border border-border rounded px-1 py-0.5'>
									#{session.session_number}
								</span>
								<span className='text-sm font-medium truncate text-foreground/80 group-hover/item:text-foreground flex-1'>
									{session.title}
								</span>
								<span className='text-[10px] text-muted-foreground/50 whitespace-nowrap'>
									{formatDate(session.session_date)}
								</span>
							</Link>
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\dashboard\components\CurrentStoryStack.jsx ---

--- FILE: features\dashboard\components\InsightsGrid.jsx ---
import { Trophy, Map, Users, Swords, Skull, Crown } from 'lucide-react';

export const InsightsGrid = ({ stats, counts }) => {
	// Helper to safely get data
	const getVal = (obj, key) => obj?.[key];

	const insights = [
		{
			label: 'Most Active Session',
			value: getVal(stats?.most_active_session, 'title'),
			sub: `${getVal(stats?.most_active_session, 'event_count') || 0} Events`,
			icon: Trophy,
			color: 'text-yellow-500',
		},
		{
			label: 'Top Location',
			value: getVal(stats?.top_location, 'name'),
			sub: `${getVal(stats?.top_location, 'visits') || 0} Visits`,
			icon: Map,
			color: 'text-emerald-500',
		},
		{
			label: 'Most Met NPC',
			value: getVal(stats?.top_npc, 'name'),
			sub: `${getVal(stats?.top_npc, 'mentions') || 0} Mentions`,
			icon: Users,
			color: 'text-blue-500',
		},
		{
			label: 'Campaign Duration',
			value: `${counts?.sessions || 0} Sessions`,
			sub: 'Total Playtime',
			icon: Crown,
			color: 'text-purple-500',
		},
		{
			label: 'Battles Fought',
			value: stats?.total_encounters || 0,
			sub: 'Total Encounters',
			icon: Swords,
			color: 'text-red-500',
		},
	];

	return (
		<div className='h-full'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-6 flex items-center gap-2'>
				Campaign Insights
			</h4>
			<div className='grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-8'>
				{insights.map((item, idx) => (
					<div key={idx} className='flex items-start gap-4 group'>
						<div className={`mt-1 p-2 rounded-lg bg-muted/30 group-hover:bg-muted/50 transition-colors ${item.color}`}>
							<item.icon size={18} />
						</div>
						<div className='min-w-0 flex-1'>
							<p className='text-xl font-serif font-bold text-foreground truncate leading-none mb-1'>
								{item.value || 'N/A'}
							</p>
							<p className='text-[10px] font-bold uppercase text-muted-foreground/60'>{item.label}</p>
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\InsightsGrid.jsx ---

--- FILE: features\dashboard\components\PartyWidget.jsx ---
import { useNavigate } from 'react-router-dom';
import { Shield, Heart, Footprints, User } from 'lucide-react';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { clsx } from 'clsx';

export const PartyWidget = ({ party }) => {
	const navigate = useNavigate();

	if (!party || party.length === 0) return null;

	const handleCardClick = (id, e) => {
		if (e.target.closest('a')) return;
		navigate(`/wiki/character/${id}`);
	};

	return (
		<div className='w-full'>
			<div className='flex items-center justify-between mb-4'>
				<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground'>The Party</h4>
			</div>

			{/* CHANGED: xl:grid-cols-6 to fit 6 cards in a row */}
			<div className='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4'>
				{party.map((char) => (
					<PartyCard key={char.id} char={char} onClick={(e) => handleCardClick(char.id, e)} />
				))}
			</div>
		</div>
	);
};

const PartyCard = ({ char, onClick }) => {
	const { attributes, name, race, level, icon, description } = char;

	const hp = attributes?.['hit points'] || '';
	const ac = attributes?.['armor class'] || '';

	// CHANGED: Extract Speed instead of Passive Perception
	// Usually stored as "30ft." or just "30"
	const speed = attributes?.speed || '';

	const charClass = char.class || attributes?.class || 'Unknown Class';
	const bgImage = attributes?.background_image || attributes?.header_image;

	return (
		<div
			onClick={onClick}
			className='group relative bg-card border border-border rounded-xl overflow-hidden hover:shadow-md hover:border-primary/50 transition-all duration-300 cursor-pointer flex flex-col h-full'>
			{/* --- Header Banner --- */}
			<div className='h-24 bg-muted relative overflow-hidden'>
				{bgImage ? (
					<img
						src={bgImage}
						alt='Background'
						className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-80'
					/>
				) : (
					<div className='w-full h-full bg-gradient-to-br from-primary/5 to-muted' />
				)}
				<div className='absolute inset-0 bg-gradient-to-t from-card via-card/40 to-transparent' />
			</div>

			{/* --- Body Content --- */}
			<div className='relative px-5 pb-4 pt-0 flex-1 flex flex-col'>
				<div className='flex justify-between items-end -mt-10 mb-3'>
					{/* Avatar */}
					<div className='w-16 h-16 rounded-xl border-4 border-card bg-muted shadow-sm overflow-hidden shrink-0 z-10 group-hover:scale-105 transition-transform'>
						{icon ? (
							<img src={icon} alt={name} className='w-full h-full object-cover' />
						) : (
							<div className='w-full h-full flex items-center justify-center bg-primary/10 text-primary'>
								<User size={24} />
							</div>
						)}
					</div>

					{/* Level Badge */}
					<div className='mb-1 bg-background/80 backdrop-blur border border-border px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-muted-foreground shadow-sm'>
						LVL {level || '?'}
					</div>
				</div>

				{/* Identity */}
				<div className='mb-3'>
					<h3 className='font-serif font-bold text-lg text-foreground group-hover:text-primary transition-colors leading-tight line-clamp-1'>
						<SmartMarkdown>{name}</SmartMarkdown>
					</h3>
					<p className='text-[10px] uppercase font-bold tracking-wider text-muted-foreground/70 truncate'>
						{race}  {charClass}
					</p>
				</div>

				{/* Description (Trimmed) */}
				{/* CHANGED: Increased height (h-20) and line-clamp (4) for taller cards */}
				<div className='text-xs text-muted-foreground line-clamp-4 mb-4 h-20 leading-relaxed'>
					<SmartMarkdown components={{ p: 'span' }}>{description || 'No description available.'}</SmartMarkdown>
				</div>

				{/* Combat Strip */}
				{/* CHANGED: Swapped Eye (PP) for Footprints (Speed) */}
				<div className='mt-auto pt-3 border-t border-border/50 grid grid-cols-3 gap-2'>
					<StatItem icon={Heart} label='HP' value={hp} color='text-red-500' />
					<StatItem icon={Shield} label='AC' value={ac} color='text-amber-500' />
					<StatItem icon={Footprints} label='SPD' value={speed} color='text-emerald-500' />
				</div>
			</div>
		</div>
	);
};

const StatItem = ({ icon: Icon, label, value, color }) => (
	<div className='flex flex-col items-center justify-center p-1.5 rounded bg-muted/30 group-hover:bg-muted/50 transition-colors'>
		<div className='flex items-center gap-1.5 text-muted-foreground mb-0.5'>
			<Icon size={10} className={clsx('opacity-70', color)} />
			<span className='text-[9px] font-bold uppercase tracking-wider'>{label}</span>
		</div>
		<span className='text-sm font-bold font-mono text-foreground'>{value}</span>
	</div>
);

--- END OF features\dashboard\components\PartyWidget.jsx ---

--- FILE: features\dashboard\components\QuickInsights.jsx ---
import { TrendingUp, Trophy, Map, Users } from 'lucide-react';
import { clsx } from 'clsx';

export const QuickInsights = ({ stats, sessions }) => {
	const insights = [
		{
			icon: TrendingUp,
			label: 'Most Active Session',
			value: stats?.mostActiveSession?.title || 'N/A',
			subtitle: `${stats?.mostActiveSession?.eventCount || 0} events`,
			color: 'text-blue-600',
			bg: 'bg-blue-500/10',
			border: 'border-blue-500/30',
		},
		{
			icon: Map,
			label: 'Most Visited Location',
			value: stats?.topLocation?.name || 'N/A',
			subtitle: `${stats?.topLocation?.visits || 0} visits`,
			color: 'text-emerald-600',
			bg: 'bg-emerald-500/10',
			border: 'border-emerald-500/30',
		},
		{
			icon: Users,
			label: 'Most Encountered NPC',
			value: stats?.topNPC?.name || 'N/A',
			subtitle: `${stats?.topNPC?.mentions || 0} mentions`,
			color: 'text-amber-600',
			bg: 'bg-amber-500/10',
			border: 'border-amber-500/30',
		},
		{
			icon: Trophy,
			label: 'Quests Completed',
			value: stats?.completedQuests || 0,
			subtitle: `${stats?.activeQuests || 0} still active`,
			color: 'text-purple-600',
			bg: 'bg-purple-500/10',
			border: 'border-purple-500/30',
		},
	];

	return (
		<div>
			<h2 className='text-xl font-serif font-bold text-foreground mb-4'>Campaign Insights</h2>
			<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
				{insights.map((insight, idx) => {
					const Icon = insight.icon;
					return (
						<div
							key={idx}
							className={clsx('bg-background border rounded-lg p-4 hover:shadow-md transition-all', insight.border)}>
							<div className='flex items-start gap-3'>
								<div className={clsx('p-2 rounded-lg shrink-0', insight.bg)}>
									<Icon size={20} className={insight.color} strokeWidth={2.5} />
								</div>
								<div className='flex-1 min-w-0'>
									<p className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground mb-1'>
										{insight.label}
									</p>
									<p className='text-lg font-serif font-bold text-foreground truncate mb-0.5'>{insight.value}</p>
									<p className='text-xs text-muted-foreground'>{insight.subtitle}</p>
								</div>
							</div>
						</div>
					);
				})}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\QuickInsights.jsx ---

--- FILE: features\graph\GraphPage.jsx ---
import { useGraphViewModel } from './useGraphView';
import { GraphLegend } from './components/GraphLegend';
import { CytoscapeCanvas } from './components/CytoscapeCanvas';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export default function RelationshipGraph() {
	const { elements, isLoading } = useGraphViewModel();

	if (isLoading) {
		return (
			<div className='h-full flex items-center justify-center'>
				<LoadingSpinner text='Analyzing Connections...' />
			</div>
		);
	}

	return (
		// IMPLEMENTATION: Constellation Background via CSS radial-gradient
		// FIX: Replaced #e5e5e5 with var(--border) to fix contrast in dark mode
		<div
			className='h-full w-full relative bg-background overflow-hidden'
			style={{
				backgroundImage:
					'radial-gradient(circle at center, var(--border) 1px, transparent 1px), radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
				backgroundSize: '40px 40px, 20px 20px',
				backgroundPosition: '0 0, 20px 20px',
			}}>
			{/* Overlay UI */}
			<GraphLegend />

			{/* The Graph Layer */}
			<CytoscapeCanvas elements={elements} />
		</div>
	);
}

--- END OF features\graph\GraphPage.jsx ---

--- FILE: features\graph\useGraphView.js ---
import { useQuery } from '@tanstack/react-query';
import { useMemo } from 'react';
import { getGraphData } from '@/features/graph/api/graphService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { transformGraphData } from './utils/graphMapper'; // Import transform
// import './types';

export function useGraphViewModel() {
	const { campaignId } = useCampaign();

	const { data: rawEntities, isLoading } = useQuery({
		queryKey: ['graph', campaignId],
		queryFn: () => getGraphData(campaignId),
		enabled: !!campaignId,
	});

	// Use the pure transform function
	const elements = useMemo(() => {
		return transformGraphData(rawEntities);
	}, [rawEntities]);

	return { elements, isLoading };
}

--- END OF features\graph\useGraphView.js ---

--- FILE: features\graph\api\graphService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getGraphData = async (campaignId) => {
	const { data, error } = await supabase.from('view_campaign_graph').select('*').eq('campaign_id', campaignId);

	if (error) {
		console.error('Graph Fetch Error:', error);
		return [];
	}
	return data || [];
};

--- END OF features\graph\api\graphService.js ---

--- FILE: features\graph\components\CytoscapeCanvas.jsx ---
import { useEffect, useRef, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import cytoscape from 'cytoscape';
import fcose from 'cytoscape-fcose';
import { useTheme } from '@/shared/hooks/useTheme';
import { getGraphStyles, LAYOUT_CONFIG } from '@/features/graph/config/graphStyles';

cytoscape.use(fcose);

export const CytoscapeCanvas = ({
	elements,
	layoutConfig = LAYOUT_CONFIG,
	stylesheet,
	onNodeClick,
	interactive = true,
}) => {
	const containerRef = useRef(null);
	const cyRef = useRef(null);

	// STABILITY FIX: Store callbacks in refs to prevent re-init on render
	const onNodeClickRef = useRef(onNodeClick);
	onNodeClickRef.current = onNodeClick;

	const navigate = useNavigate();
	const { theme } = useTheme();

	const styles = useMemo(() => {
		if (stylesheet) return stylesheet;
		return getGraphStyles(theme);
	}, [theme, stylesheet]);

	// Style Update (Lightweight)
	useEffect(() => {
		if (cyRef.current) {
			cyRef.current.style().fromJson(styles).update();
		}
	}, [styles]);

	// Initialization (Run ONCE)
	useEffect(() => {
		if (!containerRef.current) return;

		cyRef.current = cytoscape({
			container: containerRef.current,
			elements: [], // Elements added in separate effect
			style: styles,
			layout: { name: 'preset' }, // Initial static layout
			wheelSensitivity: 3,
			minZoom: 0.2,
			maxZoom: 4,
			zoomingEnabled: interactive,
			panningEnabled: interactive,
			userZoomingEnabled: interactive,
			userPanningEnabled: interactive,
			boxSelectionEnabled: false,
			autoungrabify: true,
		});

		const cy = cyRef.current;

		// Resize Observer
		const resizeObserver = new ResizeObserver(() => {
			if (cy && !cy.destroyed()) {
				cy.resize();
				cy.fit(null, 30);
			}
		});
		resizeObserver.observe(containerRef.current);

		// Event Delegation using Refs
		cy.on('tap', 'node', (evt) => {
			const data = evt.target.data();
			// 1. Priority: Custom Handler
			if (onNodeClickRef.current) {
				onNodeClickRef.current(data);
				return;
			}
			// 2. Default: Navigate (Global Graph behavior)
			// Note: In global graph, we might want double-click,
			// but preserving existing logic structure here.
			// If explicit onNodeClick is missing, we check interactive mode behavior
		});

		// Hover Effects
		if (interactive) {
			cy.on('mouseover', 'node', () => (containerRef.current.style.cursor = 'pointer'));
			cy.on('mouseout', 'node', () => (containerRef.current.style.cursor = 'default'));
		}

		// Default Global Graph Logic (Only if no custom handler passed)
		if (!onNodeClick) {
			cy.on('tap', (evt) => {
				if (evt.target === cy) cy.elements().removeClass('highlighted dimmed');
				else {
					const node = evt.target;
					cy.elements().removeClass('highlighted dimmed');
					const connectedEdges = node.connectedEdges();
					const connectedNodes = connectedEdges.connectedNodes();
					cy.elements().difference(connectedNodes.union(connectedEdges).union(node)).addClass('dimmed');
					node.addClass('highlighted');
					connectedNodes.addClass('highlighted');
					connectedEdges.addClass('highlighted');
				}
			});

			cy.on('dblclick', 'node', (evt) => {
				const { id, type } = evt.target.data();
				if (id && type) navigate(`/wiki/${type}/${id}`);
			});
		}

		return () => {
			resizeObserver.disconnect();
			if (cyRef.current) {
				cyRef.current.destroy();
				cyRef.current = null;
			}
		};
		// CRITICAL: Dependencies list is small. interactive/navigate shouldn't change often.
	}, [interactive, navigate]);

	// Data & Layout Updates
	useEffect(() => {
		if (!cyRef.current || !elements) return;
		const cy = cyRef.current;

		// Batch update elements
		cy.batch(() => {
			cy.elements().remove();
			cy.add(elements);
		});

		// Run Layout only if we have elements
		if (elements.length > 0) {
			// Apply Layout
			const layout = cy.layout({
				...layoutConfig,
				// Ensure fit happens AFTER layout finishes
				stop: () => {
					cy.fit(null, 30);
				},
			});
			layout.run();
		}
	}, [elements, layoutConfig]);

	return <div ref={containerRef} className='absolute inset-0 w-full h-full' />;
};

--- END OF features\graph\components\CytoscapeCanvas.jsx ---

--- FILE: features\graph\components\GraphLegend.jsx ---
import { ENTITY_CONFIG } from '@/domain/entity/config/entityConfig'; // Adjust path

export const GraphLegend = () => {
	// Filter out the 'default' config to keep legend clean
	const legendItems = Object.values(ENTITY_CONFIG).filter((c) => c.label !== 'Entity');

	return (
		<div className='absolute top-4 left-4 z-10 bg-background/90 p-3 rounded shadow border border-border backdrop-blur pointer-events-none select-none'>
			<h2 className='text-xs font-bold uppercase text-muted-foreground/70 mb-2'>Legend</h2>
			<div className='space-y-1.5'>
				{legendItems.map((config) => (
					<div key={config.label} className='flex items-center gap-2 text-xs font-medium text-muted-foreground'>
						<div className='w-2.5 h-2.5 rounded-full shadow-sm' style={{ backgroundColor: config.color }} />
						{config.label}
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\graph\components\GraphLegend.jsx ---

--- FILE: features\graph\config\graphStyles.js ---
export const getGraphStyles = (theme) => {
	// Logic based on explicit App Theme
	const isDark = theme === 'dark';

	// Define dynamic colors
	const colors = {
		// Major Nodes
		text: isDark ? '#F3F4F6' : '#000000', // White vs Black
		textBg: isDark ? '#1F2937' : '#ffffff', // Dark Gray vs White

		// Minor Nodes
		minorText: isDark ? '#D1D5DB' : '#374151', // Light Gray vs Dark Gray
		textOutline: isDark ? '#000000' : '#ffffff', // Black halo vs White halo
	};

	return [
		// --- MAJOR NODES (Hubs/VIPs) ---
		{
			selector: 'node',
			style: {
				label: 'data(label)',
				'border-color': 'data(color)',
				'background-image': 'data(image)',
				'background-fit': 'cover',
				'border-width': 2,
				width: 'mapData(degree, 3, 20, 30, 50)',
				height: 'mapData(degree, 3, 20, 30, 50)',
				'font-family': 'Inter, sans-serif',
				'font-size': '10pt',
				'font-weight': '500',
				'text-valign': 'bottom',
				'text-margin-y': 6,
				'letter-spacing': 0,

				// DYNAMIC: Text Background
				'text-background-color': colors.textBg,
				'text-background-opacity': 0.7,
				'text-background-padding': 2,
				'text-background-shape': 'roundrectangle',

				// DYNAMIC: Main Text Color
				color: colors.text,

				'text-wrap': 'ellipsis',
				'text-max-width': 100,
				'transition-property': 'opacity, width, height, color, text-background-color',
				'transition-duration': '0.3s',
			},
		},
		// --- MINOR NODES (Dots) ---
		{
			selector: 'node.minor',
			style: {
				width: 20,
				height: 20,
				'background-color': 'data(color)',
				'border-width': 1,
				'border-color': 'data(color)',
				'font-size': 10,
				'text-margin-y': 4,

				// Minor nodes: No box, but use an outline (halo) to separate text from background
				'text-background-opacity': 0,

				// DYNAMIC: Halo color (Black in dark mode makes text pop)
				'text-outline-color': colors.textOutline,
				'text-outline-width': 2,
				'text-outline-opacity': 0.8,

				// DYNAMIC: Minor text color
				color: colors.minorText,
			},
		},
		// --- EDGES ---
		{
			selector: 'edge',
			style: {
				'line-color': 'data(color)',
				'target-arrow-color': 'data(color)',
				'curve-style': 'bezier',
				width: 1,
				opacity: 0.3,
				'arrow-scale': 0.6,
				'target-arrow-shape': 'triangle',
				events: 'no',
			},
		},
		// --- INTERACTION STATES ---
		{
			selector: '.dimmed',
			style: {
				opacity: 0.05,
				'text-opacity': 0.1,
				'border-opacity': 0.1,
				'background-opacity': 0.1,
			},
		},
		{
			selector: '.highlighted',
			style: {
				'z-index': 9999,
				'text-wrap': 'wrap',
			},
		},
		{
			selector: 'edge.highlighted',
			style: {
				width: 2,
				opacity: 1,
			},
		},
	];
};

export const LAYOUT_CONFIG = {
	name: 'fcose',
	quality: 'default',
	randomize: true,
	animate: false,
	animationDuration: 1000,
	fit: true,
	padding: 50,
	nodeDimensionsIncludeLabels: true,
	nodeRepulsion: (node) => {
		const degree = node.data('degree') || 0;
		return 40000 + degree * 5000;
	},
	idealEdgeLength: (edge) => {
		const d1 = edge.source().data('degree') || 0;
		const d2 = edge.target().data('degree') || 0;
		const maxDegree = Math.max(d1, d2);
		return 150 + maxDegree * 30;
	},
	edgeElasticity: (edge) => 0.1,
	gravity: 0.25,
	gravityRange: 3.8,
	numIter: 2500,
	tile: true,
	tilingPaddingVertical: 100,
	tilingPaddingHorizontal: 100,
};

--- END OF features\graph\config\graphStyles.js ---

--- FILE: features\graph\utils\graphMapper.js ---
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { getAffinityRank } from '@/domain/entity/utils/statusUtils';

const INK_COLORS = {
	ALLY: '#4d7c0f',
	ENEMY: '#7f1d1d',
	NEUTRAL: '#78716c',
};

const FALLBACK_ICON_PATH = 'images/icons';

export const transformGraphData = (rawEntities) => {
	if (!rawEntities || rawEntities.length === 0) return [];

	const entities = rawEntities;

	const nodes = [];
	const edges = [];
	const entityIds = new Set(entities.map((e) => e.id));
	const uniqueEdgeTracker = new Set();

	// FIX: Re-introduce client-side degree calculation
	// We must count ONLY the edges that actually appear in the graph
	// to ensure the layout physics work correctly.
	const visualDegreeMap = new Map();
	const connectedNodeIds = new Set();

	// Pass 1: Edges & Degree Calculation
	entities.forEach((entity) => {
		(entity.relationships || []).forEach((rel) => {
			// Ensure target exists in our visible dataset
			if (!entityIds.has(rel.target)) return;

			// Sort IDs to treat A->B and B->A as the same visual edge
			const [id1, id2] = [entity.id, rel.target].sort();
			const edgeKey = `${id1}-${id2}`;

			if (uniqueEdgeTracker.has(edgeKey)) return;
			uniqueEdgeTracker.add(edgeKey);

			// Track connections
			connectedNodeIds.add(entity.id);
			connectedNodeIds.add(rel.target);

			// Increment Visual Degree
			visualDegreeMap.set(entity.id, (visualDegreeMap.get(entity.id) || 0) + 1);
			visualDegreeMap.set(rel.target, (visualDegreeMap.get(rel.target) || 0) + 1);

			// Determine Color
			const rank = getAffinityRank(rel.type);
			let edgeColor = INK_COLORS.NEUTRAL;
			if (rank === 1) edgeColor = INK_COLORS.ALLY;
			if (rank === 3) edgeColor = INK_COLORS.ENEMY;

			edges.push({
				group: 'edges',
				data: {
					id: `e-${edgeKey}`,
					source: entity.id,
					target: rel.target,
					color: edgeColor,
				},
			});
		});
	});

	// Pass 2: Nodes
	entities.forEach((entity) => {
		// Filter orphans: Only show if connected OR if it's a major hub
		// (Using the new visual degree for this check)
		const degree = visualDegreeMap.get(entity.id) || 0;
		if (degree === 0) return;

		const config = getEntityConfig(entity.type);

		// Use pre-fetched icon string via compatibility wrapper
		const mockAttributes = { icon: entity.icon };
		const finalIconUrl = resolveImageUrl(mockAttributes, 'icon') || `${FALLBACK_ICON_PATH}/${entity.type}.webp`;

		const isMinor = degree < 3;

		nodes.push({
			group: 'nodes',
			classes: isMinor ? 'minor' : 'major',
			data: {
				id: entity.id,
				label: entity.name,
				color: config.color,
				image: finalIconUrl,
				type: entity.type,
				// FIX: Pass the VISUAL degree, not the DB degree
				degree: degree,
			},
		});
	});

	return [...nodes, ...edges];
};

--- END OF features\graph\utils\graphMapper.js ---

--- FILE: features\navigation\MainLayout.jsx ---
import { Outlet } from 'react-router-dom';
import { Menu, Search } from 'lucide-react';
import { useMainLayout } from '@/features/navigation/useNavigation';
import { Sidebar } from './components/Sidebar';
import DevAdminButton from '@/shared/components/ui/DevAdminButton';
import Breadcrumbs from '@/shared/components/ui/Breadcrumbs';
import GlobalSearch from '@/features/search/GlobalSearch';
import { SearchProvider, useSearch } from '@/features/search/SearchContext';

const MobileHeaderActions = ({ vm }) => {
	const { openSearch } = useSearch();

	return (
		// CHANGED: Added pt-safe for notch support and min-h for touch targets
		<div className='lg:hidden flex items-center justify-between px-4 pb-3 pt-[calc(0.75rem+env(safe-area-inset-top))] border-b border-border bg-background/95 backdrop-blur-md shrink-0 sticky top-0 z-40 transition-all'>
			<button
				onClick={() => vm.setSidebarOpen(true)}
				className='p-2 -ml-2 text-muted-foreground hover:bg-muted rounded-full active:scale-95 transition-transform'
				aria-label='Open Menu'>
				<Menu size={24} strokeWidth={1.5} />
			</button>

			<h1 className='text-base font-serif font-bold truncate max-w-[60%]'>{vm.campaign?.name || 'Campaign'}</h1>

			<button
				onClick={openSearch}
				className='p-2 -mr-2 text-muted-foreground hover:bg-muted rounded-full active:scale-95 transition-transform'
				aria-label='Search'>
				<Search size={24} strokeWidth={1.5} />
			</button>
		</div>
	);
};

export default function MainLayout() {
	const vm = useMainLayout();

	return (
		<SearchProvider>
			<div className='flex h-full w-full bg-background text-foreground overflow-hidden'>
				<Sidebar vm={vm} />
				<main className='flex-1 h-full overflow-hidden bg-background relative flex flex-col w-full'>
					{/* Mobile Header */}
					<MobileHeaderActions vm={vm} />

					{/* Desktop Breadcrumbs */}
					<div className='absolute top-4 left-6 z-40 hidden lg:block pointer-events-none'>
						<div className='pointer-events-auto'>
							<Breadcrumbs />
						</div>
					</div>

					{/* Content Area */}
					<div className='flex-1 overflow-hidden relative w-full'>
						<Outlet />
					</div>

					<DevAdminButton />
				</main>

				<GlobalSearch />
			</div>
		</SearchProvider>
	);
}

--- END OF features\navigation\MainLayout.jsx ---

--- FILE: features\navigation\useNavigation.js ---
import { useState, useMemo, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { getCampaigns } from '@/features/campaign/api/campaignService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { NAV_STRUCTURE } from './config/navConfig';
// import './types';

export function useMainLayout() {
	const navigate = useNavigate();
	const location = useLocation();
	const { campaignId, setCampaignId } = useCampaign();
	const [sidebarOpen, setSidebarOpen] = useState(false);

	const { data: campaigns } = useQuery({
		queryKey: ['campaigns'],
		queryFn: getCampaigns,
		staleTime: 1000 * 60 * 10,
	});

	const currentCampaignData = campaigns?.find((c) => c.id === campaignId);

	const campaign = currentCampaignData
		? {
				name: currentCampaignData.name || 'Campaign',
				initial: (currentCampaignData.name?.[0] || 'C').toUpperCase(),
		  }
		: null;

	// --- NEW: Dynamic Document Title ---
	useEffect(() => {
		if (campaign?.name) {
			document.title = `${campaign.name} | Campaign Manager`;
		}
		// Reset when unmounting (leaving campaign view)
		return () => {
			document.title = 'D&D Campaign Manager';
		};
	}, [campaign]);
	// -----------------------------------

	const navStructure = useMemo(() => {
		const hasMapData = !!currentCampaignData?.attributes?.map_data;

		return NAV_STRUCTURE.map((group) => ({
			...group,
			items: group.items.filter((item) => {
				if (item.key === 'atlas') {
					return hasMapData;
				}
				return true;
			}),
		})).filter((group) => group.items.length > 0);
	}, [currentCampaignData]);

	const navigateTo = (path) => {
		navigate(path);
		setSidebarOpen(false);
	};

	const onSwitchCampaign = () => {
		setCampaignId(null);
		navigate('/wiki/session');
	};

	return {
		sidebarOpen,
		setSidebarOpen,
		currentPath: location.pathname,
		navigateTo,
		campaign,
		onSwitchCampaign,
		navStructure,
	};
}

--- END OF features\navigation\useNavigation.js ---

--- FILE: features\navigation\components\Sidebar.jsx ---
import { clsx } from 'clsx';
import { Drawer } from '@/shared/components/ui/Drawer';
import { SidebarHeader } from './SidebarHeader';
import { SidebarNav } from './SidebarNav';
import { SidebarFooter } from './SidebarFooter';

export const Sidebar = ({ vm }) => {
	const { sidebarOpen, setSidebarOpen, campaign, navStructure, currentPath, navigateTo, onSwitchCampaign } = vm;

	const SidebarContent = () => (
		// FIXED: Uses semantic colors
		<div className='flex flex-col h-full bg-muted border-r border-border'>
			<SidebarHeader campaign={campaign} />
			<SidebarNav structure={navStructure} currentPath={currentPath} onNavigate={navigateTo} />
			<SidebarFooter onSwitch={onSwitchCampaign} />
		</div>
	);

	return (
		<>
			{/* Mobile */}
			<Drawer
				isOpen={sidebarOpen}
				onClose={() => setSidebarOpen(false)}
				title={campaign?.name || 'Menu'}
				position='left'
				className='w-72'>
				<div className='flex flex-col h-full bg-muted'>
					{/* FIX: Pass onSearch to close sidebar when search is triggered on mobile */}
					<SidebarHeader campaign={campaign} onSearch={() => setSidebarOpen(false)} />
					<SidebarNav structure={navStructure} currentPath={currentPath} onNavigate={navigateTo} />
					<SidebarFooter onSwitch={onSwitchCampaign} />
				</div>
			</Drawer>

			{/* Desktop */}
			<aside className='hidden lg:flex w-64 flex-col h-full border-r border-border bg-muted shrink-0'>
				<SidebarContent />
			</aside>
		</>
	);
};

--- END OF features\navigation\components\Sidebar.jsx ---

--- FILE: features\navigation\components\SidebarFooter.jsx ---
import { Moon, Sun, Sword, Settings } from 'lucide-react';
import { useTheme, THEMES } from '@/shared/hooks/useTheme';

export const SidebarFooter = ({ onSwitch }) => {
	const { theme, cycleTheme } = useTheme();

	const getThemeIcon = () => {
		switch (theme) {
			case THEMES.DARK:
				return <Moon size={14} className='mr-2' />;
			case THEMES.DND:
				return <Sword size={14} className='mr-2' />;
			default:
				return <Sun size={14} className='mr-2' />;
		}
	};

	const getThemeLabel = () => {
		switch (theme) {
			case THEMES.DARK:
				return 'Dark Mode';
			case THEMES.DND:
				return 'D&D';
			default:
				return 'Light Mode';
		}
	};

	return (
		<div className='mt-auto p-4 border-t border-border space-y-2 bg-inherit'>
			<button
				onClick={cycleTheme}
				className='flex items-center w-full px-2 py-2 text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-black/5 rounded-md transition-colors'>
				{getThemeIcon()}
				Theme: {getThemeLabel()}
			</button>

			<button
				onClick={onSwitch}
				className='flex items-center w-full px-2 py-2 text-xs text-muted-foreground hover:text-foreground hover:bg-black/5 rounded-md transition-colors'>
				<Settings size={14} className='mr-2' />
				Switch Campaign
			</button>
		</div>
	);
};

--- END OF features\navigation\components\SidebarFooter.jsx ---

--- FILE: features\navigation\components\SidebarHeader.jsx ---
import { SearchTrigger } from '@/features/search/components/SearchTrigger';

export const SidebarHeader = ({ campaign, onSearch }) => {
	return (
		<div className='p-4'>
			{/* Campaign Card */}
			<div className='hidden lg:flex items-center gap-3 px-2 py-2 mb-4 hover:bg-muted rounded-lg cursor-pointer transition-colors'>
				<div className='w-8 h-8 rounded bg-gradient-to-br from-amber-700 to-amber-900 flex items-center justify-center text-white font-serif font-bold shadow-sm'>
					{campaign?.initial || 'C'}
				</div>
				<div className='flex-1 min-w-0'>
					<h2 className='text-sm font-bold text-foreground font-serif'>{campaign?.name || 'Loading...'}</h2>
				</div>
			</div>

			{/* Global Search Trigger - Desktop */}
			<div className='lg:mb-6'>
				<SearchTrigger onClick={onSearch} />
			</div>
		</div>
	);
};

--- END OF features\navigation\components\SidebarHeader.jsx ---

--- FILE: features\navigation\components\SidebarNav.jsx ---
import { clsx } from 'clsx';

export const SidebarNav = ({ structure, currentPath, onNavigate }) => {
	return (
		<div className='flex-1 overflow-y-auto px-4 space-y-6 custom-scrollbar'>
			{structure.map((group) => (
				<div key={group.title}>
					<h3 className='px-3 text-xs font-semibold text-muted-foreground/70 uppercase tracking-wider mb-2'>
						{group.title}
					</h3>
					<div className='space-y-0.5'>
						{group.items.map((item) => {
							const isWiki = item.path.startsWith('/wiki/');
							const active = isWiki ? currentPath.startsWith(item.path) : currentPath === item.path;
							const Icon = item.Icon;
							return (
								<button
									key={item.path}
									onClick={() => onNavigate(item.path)}
									className={clsx(
										'flex items-center w-full px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
										active
											? 'bg-background shadow-sm ring-1 ring-border'
											: 'text-muted-foreground hover:bg-muted hover:text-foreground'
									)}>
									<Icon size={16} className={clsx('mr-2', active ? 'text-primary' : 'text-muted-foreground/70')} />
									{item.label}
								</button>
							);
						})}
					</div>
				</div>
			))}
		</div>
	);
};

--- END OF features\navigation\components\SidebarNav.jsx ---

--- FILE: features\navigation\config\navConfig.js ---
import { Map, History, Network, BookOpen, Users, Scroll, Sword, Shield, Home, UserStar, Gem } from 'lucide-react';

export const NAV_STRUCTURE = [
	{
		title: 'Overview',
		items: [{ label: 'Dashboard', Icon: Home, path: '/', key: 'dashboard' }],
	},
	{
		title: 'World',
		items: [
			{ label: 'Atlas', Icon: Map, path: '/atlas', key: 'atlas' },
			{ label: 'Timeline', Icon: History, path: '/timeline', key: 'timeline' },
			{ label: 'Graph', Icon: Network, path: '/relationships', key: 'graph' },
		],
	},
	{
		title: 'Wiki',
		items: [
			{ label: 'Chronicles', Icon: BookOpen, path: '/wiki/session', key: 'session' },
			{ label: 'Characters', Icon: UserStar, path: '/wiki/character', key: 'character' },
			{ label: 'NPCs', Icon: Users, path: '/wiki/npc', key: 'npc' },
			{ label: 'Locations', Icon: Map, path: '/wiki/location', key: 'location' },
			{ label: 'Factions', Icon: Shield, path: '/wiki/faction', key: 'faction' },
			{ label: 'Quests', Icon: Scroll, path: '/wiki/quest', key: 'quest' },
			{ label: 'Encounters', Icon: Sword, path: '/wiki/encounter', key: 'encounter' },
			{ label: 'Items', Icon: Gem, path: '/wiki/item', key: 'item' },
		],
	},
];

--- END OF features\navigation\config\navConfig.js ---

--- FILE: features\search\GlobalSearch.jsx ---
import { useRef, useEffect } from 'react';
import { SearchModal } from './components/SearchModal';
import { useGlobalSearchViewModel } from './useGlobalSearch';

export default function GlobalSearch() {
	const vm = useGlobalSearchViewModel();
	const inputRef = useRef(null);

	// Focus input when opened
	useEffect(() => {
		if (vm.isOpen && inputRef.current) {
			// Small timeout to ensure DOM is ready on mobile transitions
			setTimeout(() => inputRef.current?.focus(), 50);
		}
	}, [vm.isOpen]);

	// If not open, don't render anything (Modal handles Portal)
	if (!vm.isOpen) return null;

	return <SearchModal vm={vm} inputRef={inputRef} />;
}

--- END OF features\search\GlobalSearch.jsx ---

--- FILE: features\search\SearchContext.jsx ---
import { createContext, useContext, useState, useCallback, useEffect } from 'react';

const SearchContext = createContext(null);

export const SearchProvider = ({ children }) => {
	const [isOpen, setIsOpen] = useState(false);
	const [query, setQuery] = useState('');

	// Keyboard shortcut listener (CMD+K)
	useEffect(() => {
		const handleKeyDown = (e) => {
			if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
				e.preventDefault();
				setIsOpen((prev) => !prev);
			}
			if (e.key === 'Escape' && isOpen) {
				setIsOpen(false);
			}
		};

		window.addEventListener('keydown', handleKeyDown);
		return () => window.removeEventListener('keydown', handleKeyDown);
	}, [isOpen]);

	const openSearch = useCallback(() => setIsOpen(true), []);
	const closeSearch = useCallback(() => {
		setIsOpen(false);
		setQuery(''); // Optional: clear query on close
	}, []);

	return (
		<SearchContext.Provider value={{ isOpen, query, setQuery, openSearch, closeSearch }}>
			{children}
		</SearchContext.Provider>
	);
};

export const useSearch = () => {
	const context = useContext(SearchContext);
	if (!context) throw new Error('useSearch must be used within SearchProvider');
	return context;
};

--- END OF features\search\SearchContext.jsx ---

--- FILE: features\search\useGlobalSearch.js ---
import { useState, useEffect, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { globalSearch } from '@/features/search/api/searchService';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { transformSearchResults } from '@/features/search/utils/searchMapper';
import { useSearch } from './SearchContext'; // IMPORT CONTEXT

const STORAGE_KEY = 'recent-searches';

export function useGlobalSearchViewModel() {
	const navigate = useNavigate();
	const { campaignId } = useCampaign();

	// 1. Consume Context
	const { isOpen, openSearch: setIsOpen, closeSearch, query, setQuery } = useSearch();

	const [selectedIndex, setSelectedIndex] = useState(0);
	const [recentSearches, setRecentSearches] = useState(() => {
		try {
			const stored = localStorage.getItem(STORAGE_KEY);
			return stored ? JSON.parse(stored) : [];
		} catch {
			return [];
		}
	});

	// Fetch search results
	const { data: rawData, isLoading } = useQuery({
		queryKey: ['globalSearch', campaignId, query],
		queryFn: () => globalSearch(campaignId, query),
		enabled: !!campaignId && query.trim().length > 0,
		staleTime: 1000 * 30,
	});

	// Transform results
	const results = useMemo(() => {
		if (!rawData) return [];
		const processedItems = transformSearchResults(rawData);

		return processedItems.map((result) => {
			const config = getEntityConfig(result.type);
			return {
				id: result.id,
				name: result.name,
				type: result.type,
				typeLabel: result.type.toUpperCase(),
				description: result.description || '',
				icon: config.icon,
				theme: config.tailwind,
			};
		});
	}, [rawData]);

	const flattenedRawResults = useMemo(() => {
		if (!rawData) return [];
		return transformSearchResults(rawData);
	}, [rawData]);

	const recentSearchesViewModel = useMemo(() => {
		return recentSearches.map((result) => {
			const config = getEntityConfig(result.type);
			return {
				id: result.id,
				name: result.name,
				type: result.type,
				typeLabel: result.type.toUpperCase(),
				description: result.description || '',
				icon: config.icon,
				theme: config.tailwind,
			};
		});
	}, [recentSearches]);

	const handleSelect = (result) => {
		const rawResult = flattenedRawResults.find((r) => r.id === result.id);

		if (rawResult) {
			const toStore = {
				id: rawResult.id,
				name: rawResult.name,
				type: rawResult.type,
				description: rawResult.description || '',
			};
			const updated = [toStore, ...recentSearches.filter((r) => r.id !== toStore.id)].slice(0, 5);
			setRecentSearches(updated);
			try {
				localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
			} catch {}
		}

		navigate(`/wiki/${result.type}/${result.id}`);

		// Use Context Close
		closeSearch();
		setSelectedIndex(0);
	};

	const clearRecent = () => {
		setRecentSearches([]);
		try {
			localStorage.removeItem(STORAGE_KEY);
		} catch {}
	};

	// Arrow key navigation
	useEffect(() => {
		if (!isOpen || results.length === 0) return;

		const handleKeyDown = (e) => {
			if (e.key === 'ArrowDown') {
				e.preventDefault();
				setSelectedIndex((prev) => (prev + 1) % results.length);
			} else if (e.key === 'ArrowUp') {
				e.preventDefault();
				setSelectedIndex((prev) => (prev - 1 + results.length) % results.length);
			} else if (e.key === 'Enter' && results[selectedIndex]) {
				e.preventDefault();
				handleSelect(results[selectedIndex]);
			}
		};

		window.addEventListener('keydown', handleKeyDown);
		return () => window.removeEventListener('keydown', handleKeyDown);
	}, [isOpen, results, selectedIndex]);

	return {
		isOpen,
		setIsOpen, // Keeps API compatible with old components if they passed bool
		closeSearch, // New explicit close
		query,
		setQuery,
		results,
		isLoading,
		recentSearches: recentSearchesViewModel,
		selectedIndex,
		setSelectedIndex,
		handleSelect,
		clearRecent,
	};
}

--- END OF features\search\useGlobalSearch.js ---

--- FILE: features\search\api\searchService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const globalSearch = async (campaignId, query) => {
	if (!query || query.trim().length === 0) return { sessions: [], entities: [], sessionAttributes: [] };

	const searchTerm = `%${query.trim()}%`;

	// 1. Search Entities
	const { data: entities, error: entitiesError } = await supabase
		.from('entities')
		.select('id, name, type, description')
		.eq('campaign_id', campaignId)
		.or(`name.ilike.${searchTerm},description.ilike.${searchTerm}`)
		.limit(8);

	if (entitiesError) console.error('Entity search error:', entitiesError);

	// 2. Search Sessions
	const { data: sessions, error: sessionsError } = await supabase
		.from('sessions')
		.select('id, title, narrative')
		.eq('campaign_id', campaignId)
		.or(`title.ilike.${searchTerm},narrative.ilike.${searchTerm}`)
		.limit(5);

	if (sessionsError) console.error('Session search error:', sessionsError);

	// 3. Fetch Attributes for Sessions (if any found)
	let sessionAttributes = [];
	if (sessions && sessions.length > 0) {
		const sessionIds = sessions.map((s) => s.id);
		const { data } = await supabase.from('attributes').select('entity_id, name, value').in('entity_id', sessionIds);
		sessionAttributes = data || [];
	}

	return {
		sessions: sessions || [],
		entities: entities || [],
		sessionAttributes,
	};
};

--- END OF features\search\api\searchService.js ---

--- FILE: features\search\components\SearchFooter.jsx ---
export const SearchFooter = () => {
	return (
		<div className='flex items-center justify-between px-4 py-2.5 border-t border-border bg-muted/30 text-[10px] text-muted-foreground'>
			<div className='flex items-center gap-4'>
				<span className='flex items-center gap-1.5'>
					<kbd className='px-1.5 py-0.5 bg-background border border-border rounded font-semibold'></kbd>
					<kbd className='px-1.5 py-0.5 bg-background border border-border rounded font-semibold'></kbd>
					<span>navigate</span>
				</span>
				<span className='flex items-center gap-1.5'>
					<kbd className='px-1.5 py-0.5 bg-background border border-border rounded font-semibold'></kbd>
					<span>select</span>
				</span>
			</div>
			<span className='flex items-center gap-1.5'>
				<kbd className='px-1.5 py-0.5 bg-background border border-border rounded font-semibold'>ESC</kbd>
				<span>close</span>
			</span>
		</div>
	);
};

--- END OF features\search\components\SearchFooter.jsx ---

--- FILE: features\search\components\SearchModal.jsx ---
import { createPortal } from 'react-dom';
import { Search, X, Loader2 } from 'lucide-react';
import { SearchResults } from './SearchResults';
import { SearchFooter } from './SearchFooter';

export const SearchModal = ({ vm, inputRef }) => {
	return createPortal(
		// Fixed inset-0 for full screen coverage on mobile
		<div className='fixed inset-0 z-[100] flex flex-col lg:items-center lg:pt-[15vh] px-0 lg:px-4'>
			{/* Backdrop */}
			<div
				className='absolute inset-0 bg-background/95 lg:bg-black/60 lg:backdrop-blur-sm transition-all'
				onClick={vm.closeSearch}
			/>

			{/* Search Panel */}
			<div className='relative w-full lg:max-w-2xl bg-background lg:rounded-xl shadow-2xl border-b lg:border border-border overflow-hidden flex flex-col h-full lg:h-auto lg:max-h-[70vh] animate-in fade-in slide-in-from-bottom-2 lg:slide-in-from-top-4 duration-200'>
				{/* Search Input Area */}
				<div className='flex items-center gap-3 p-4 border-b border-border bg-background shrink-0'>
					<button onClick={vm.closeSearch} className='lg:hidden p-1 -ml-1 text-muted-foreground'>
						<X size={20} />
					</button>
					<Search size={18} className='text-muted-foreground/70 shrink-0 hidden lg:block' />

					<input
						ref={inputRef}
						type='text'
						value={vm.query}
						onChange={(e) => {
							vm.setQuery(e.target.value);
							vm.setSelectedIndex(0);
						}}
						placeholder='Search sessions, entities, lore...'
						className='flex-1 bg-transparent text-base lg:text-sm text-foreground placeholder:text-muted-foreground/70 outline-none h-10 lg:h-auto'
					/>

					{vm.isLoading && <Loader2 size={16} className='animate-spin text-amber-600' />}

					{vm.query && !vm.isLoading && (
						<button
							onClick={() => {
								vm.setQuery('');
								inputRef.current?.focus();
							}}
							className='p-1 text-muted-foreground/70 hover:text-foreground hover:bg-muted rounded transition-colors'>
							<X size={16} />
						</button>
					)}
					<kbd className='hidden lg:inline-block px-2 py-1 text-[10px] font-semibold text-muted-foreground/70 bg-muted border border-border rounded'>
						ESC
					</kbd>
				</div>

				{/* Results Area - Flex 1 for mobile scrolling */}
				<div className='flex-1 overflow-y-auto bg-muted/10 custom-scrollbar'>
					<SearchResults vm={vm} />
				</div>

				{/* Footer (Desktop Only) */}
				<div className='hidden lg:block'>
					<SearchFooter />
				</div>
			</div>
		</div>,
		document.body
	);
};

--- END OF features\search\components\SearchModal.jsx ---

--- FILE: features\search\components\SearchResultItem.jsx ---
import { clsx } from 'clsx';

export const SearchResultItem = ({ item, isSelected, onSelect, onHover }) => {
	return (
		<button
			onClick={onSelect}
			onMouseEnter={onHover}
			className={clsx(
				'w-full flex items-start gap-3 px-4 py-2.5 transition-colors text-left',
				isSelected ? 'bg-amber-500/10' : 'hover:bg-muted'
			)}>
			<div
				className={clsx(
					'shrink-0 w-9 h-9 rounded-lg border flex items-center justify-center',
					item.theme.bg,
					item.theme.border,
					item.theme.text
				)}>
				<item.icon size={16} />
			</div>
			<div className='flex-1 min-w-0'>
				<div className='flex items-center gap-2 mb-0.5'>
					<span className='text-sm font-semibold text-foreground truncate'>{item.name}</span>
					<span className='shrink-0 text-[10px] uppercase font-bold tracking-wider text-muted-foreground/70 bg-muted px-1.5 py-0.5 rounded'>
						{item.type}
					</span>
				</div>
				{item.description && <p className='text-xs text-muted-foreground line-clamp-2 leading-relaxed'>{item.description}</p>}
			</div>
			{isSelected && (
				<kbd className='shrink-0 text-[10px] font-semibold text-muted-foreground/70 bg-muted px-2 py-1 rounded border border-border'>
					
				</kbd>
			)}
		</button>
	);
};

--- END OF features\search\components\SearchResultItem.jsx ---

--- FILE: features\search\components\SearchResults.jsx ---
import { Search, Clock, Calendar, Database } from 'lucide-react';
import { clsx } from 'clsx';
import { SearchResultItem } from './SearchResultItem';

const GroupHeader = ({ label, icon: Icon }) => (
	<div className='px-4 py-2 mt-2 text-[10px] font-bold uppercase tracking-widest text-muted-foreground flex items-center gap-2 bg-muted/50 border-y border-border/50 sticky top-0 z-10 backdrop-blur-sm'>
		<Icon size={12} />
		{label}
	</div>
);

export const SearchResults = ({ vm }) => {
	const { query, results, isLoading, recentSearches, selectedIndex, setSelectedIndex, handleSelect, clearRecent } = vm;

	// GROUPING LOGIC
	const groupedResults = results.reduce(
		(acc, item) => {
			const group = item.type === 'session' ? 'sessions' : 'entities';
			if (!acc[group]) acc[group] = [];
			acc[group].push(item);
			return acc;
		},
		{ sessions: [], entities: [] }
	);

	return (
		<div className='pb-4'>
			{query.trim() === '' ? (
				// Recent Searches / Empty State
				<div className='p-4'>
					{recentSearches.length > 0 ? (
						<>
							<div className='flex items-center justify-between mb-3'>
								<h3 className='text-xs font-semibold uppercase tracking-wider text-muted-foreground/70'>Recent Searches</h3>
								<button onClick={clearRecent} className='text-xs text-muted-foreground/70 hover:text-foreground transition-colors'>
									Clear
								</button>
							</div>
							<div className='space-y-1'>
								{recentSearches.map((item) => (
									<button
										key={item.id}
										onClick={() => handleSelect(item)}
										className='w-full flex items-start gap-3 p-2 rounded-lg hover:bg-muted transition-colors text-left group'>
										<Clock size={14} className='mt-1 text-gray-300 group-hover:text-amber-600 transition-colors' />
										<span className='text-sm text-muted-foreground group-hover:text-foreground transition-colors'>
											{item.name}
										</span>
									</button>
								))}
							</div>
						</>
					) : (
						<div className='text-center py-12 opacity-60'>
							<Search size={40} className='mx-auto text-gray-300 mb-3' />
							<p className='text-sm font-medium text-foreground mb-1'>Global Search</p>
							<p className='text-xs text-muted-foreground'>Find anything in your campaign</p>
						</div>
					)}
				</div>
			) : results.length > 0 ? (
				// Grouped Search Results
				<div>
					{groupedResults.sessions.length > 0 && (
						<div className='mb-2'>
							<GroupHeader label='Sessions' icon={Calendar} />
							{groupedResults.sessions.map((item) => {
								const idx = results.indexOf(item);
								return (
									<SearchResultItem
										key={item.id}
										item={item}
										isSelected={idx === selectedIndex}
										onSelect={() => handleSelect(item)}
										onHover={() => setSelectedIndex(idx)}
									/>
								);
							})}
						</div>
					)}

					{groupedResults.entities.length > 0 && (
						<div>
							<GroupHeader label='Entities' icon={Database} />
							{groupedResults.entities.map((item) => {
								const idx = results.indexOf(item);
								return (
									<SearchResultItem
										key={item.id}
										item={item}
										isSelected={idx === selectedIndex}
										onSelect={() => handleSelect(item)}
										onHover={() => setSelectedIndex(idx)}
									/>
								);
							})}
						</div>
					)}
				</div>
			) : (
				// No Results
				!isLoading && (
					<div className='text-center py-12 px-4'>
						<p className='text-sm font-medium text-foreground mb-1'>No matches for "{query}"</p>
						<p className='text-xs text-muted-foreground'>Try checking your spelling</p>
					</div>
				)
			)}
		</div>
	);
};

--- END OF features\search\components\SearchResults.jsx ---

--- FILE: features\search\components\SearchTrigger.jsx ---
import { Search } from 'lucide-react';
import { useSearch } from '@/features/search/SearchContext'; // Import Context

export const SearchTrigger = ({ className, onClick }) => {
	const { openSearch } = useSearch();

	const handleClick = (e) => {
		openSearch();
		if (onClick) onClick(e);
	};

	return (
		<button
			onClick={handleClick}
			className={`w-full flex items-center gap-2 px-3 py-1.5 bg-background border border-border rounded-md text-sm text-muted-foreground hover:text-foreground hover:border-primary/50 transition-all group ${className}`}>
			<Search size={14} className='text-muted-foreground/70 group-hover:text-primary' />
			<span className='flex-1 text-left text-xs'>Search...</span>
			<kbd className='hidden sm:inline-block px-1.5 py-0.5 text-[10px] font-semibold text-muted-foreground/70 bg-muted border border-border rounded'>
				K
			</kbd>
		</button>
	);
};

--- END OF features\search\components\SearchTrigger.jsx ---

--- FILE: features\search\utils\searchMapper.js ---
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const transformSearchResults = (rawResults) => {
	const { sessions, entities, sessionAttributes } = rawResults;

	// 1. Process Sessions
	const attrMap = new Map();
	(sessionAttributes || []).forEach((attr) => {
		if (!attrMap.has(attr.entity_id)) attrMap.set(attr.entity_id, []);
		attrMap.get(attr.entity_id).push(attr);
	});

	const processedSessions = sessions.map((s) => {
		const rawAttrs = attrMap.get(s.id) || [];
		const attrs = rawAttrs.reduce((acc, c) => ({ ...acc, [c.name]: c.value }), {});

		const num = getAttributeValue(attrs, ['session_number', 'Session']);
		const date = getAttributeValue(attrs, ['session_date', 'Date']);
		const summaryAttr = getAttributeValue(attrs, 'Summary');

		return {
			id: s.id,
			name: s.title,
			type: 'session',
			// Prefer Summary attribute, fallback to snippet of narrative
			description: summaryAttr || s.narrative?.substring(0, 150) || '',
			attributes: {
				Session: num,
				Date: date,
			},
		};
	});

	// 2. Combine with standard entities
	return [...processedSessions, ...(entities || [])];
};

--- END OF features\search\utils\searchMapper.js ---

--- FILE: features\smart-text\SmartMarkdown.jsx ---
import ReactMarkdown from 'react-markdown';
import { useSmartText } from './useSmartText';
import { SmartEntityLink } from './components/SmartEntityLink';
import { EntityEmbed } from './components/EntityEmbed';
import { generateId, extractText } from '@/shared/utils/textUtils';
import { Link } from 'react-router-dom';
import { getEntityStyles } from '@/domain/entity/config/entityStyles';

export default function SmartMarkdown({ children, inline = false, disableTooltips = false, ...props }) {
	let safeText = children;
	if (Array.isArray(children)) {
		safeText = children.join('');
	} else if (typeof children !== 'string' && children !== null && children !== undefined) {
		safeText = String(children);
	}

	const processedText = useSmartText(safeText);

	const HeadingRenderer = ({ level, children }) => {
		const text = extractText(children);
		const id = generateId(text);
		const Tag = `h${level}`;
		return <Tag id={id}>{children}</Tag>;
	};

	return (
		<ReactMarkdown
			{...props}
			disallowedElements={inline ? ['p'] : []}
			unwrapDisallowed={inline}
			components={{
				...props.components,
				h1: (props) => <HeadingRenderer level={1} {...props} />,
				h2: (props) => <HeadingRenderer level={2} {...props} />,
				h3: (props) => <HeadingRenderer level={3} {...props} />,

				a: ({ href, children }) => {
					if (href && href.startsWith('#entity/')) {
						const parts = href.split('/');
						const id = parts[1];
						const type = parts[2] || 'default';

						const textContent = String(children);
						const isEmbed = textContent.startsWith('::') && textContent.endsWith('::');

						if (isEmbed) {
							const label = textContent.replace(/^::\s*|\s*::$/g, '');
							return <EntityEmbed id={id} type={type} label={label} />;
						}

						// PREVENT RECURSIVE TOOLTIPS
						if (disableTooltips) {
							const styles = getEntityStyles(type);
							return (
								<Link
									to={`/wiki/${type}/${id}`}
									className={`${styles.text} font-semibold hover:underline cursor-pointer`}
									onClick={(e) => e.stopPropagation()} // Prevent card click
								>
									{children}
								</Link>
							);
						}

						return (
							<SmartEntityLink id={id} type={type}>
								{children}
							</SmartEntityLink>
						);
					}

					return (
						<a href={href} className='text-blue-600 hover:underline' target='_blank' rel='noopener noreferrer'>
							{children}
						</a>
					);
				},
			}}>
			{processedText}
		</ReactMarkdown>
	);
}

--- END OF features\smart-text\SmartMarkdown.jsx ---

--- FILE: features\smart-text\useEntityIndex.js ---
import { useQuery } from '@tanstack/react-query';
import { getEntityIndex } from '@/domain/entity/api/entityService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getParentId } from '@/domain/entity/utils/entityUtils';

export function useEntityIndex() {
	const { campaignId } = useCampaign();

	const { data } = useQuery({
		queryKey: ['entityIndex', campaignId],
		queryFn: async () => {
			const rawData = await getEntityIndex(campaignId);

			const list = [];
			const map = new Map();
			const searchTokens = [];

			rawData.forEach((entity) => {
				const attrs = parseAttributes(entity.attributes);

				const lightEntity = {
					...entity,
					parentId: getParentId(entity),
					iconUrl: resolveImageUrl(attrs, 'icon'),
					attributes: attrs,
				};

				// 1. Add Primary Name
				if (entity.name && entity.name.length > 2) {
					searchTokens.push({
						term: entity.name,
						entityId: entity.id,
						type: entity.type,
					});
				}

				// 2. Add Aliases
				if (attrs.aliases) {
					// Handle Array or String
					const aliasList = Array.isArray(attrs.aliases)
						? attrs.aliases
						: typeof attrs.aliases === 'string'
						? attrs.aliases.split(',').map((s) => s.trim())
						: [];

					aliasList.forEach((alias) => {
						if (alias && alias.length > 2) {
							searchTokens.push({
								term: alias,
								entityId: entity.id,
								type: entity.type,
							});
						}
					});
				}

				list.push(lightEntity);
				map.set(entity.id, lightEntity);
			});

			// Sort by length DESC so "Captain Soranna" matches before "Soranna"
			searchTokens.sort((a, b) => b.term.length - a.term.length);

			return { list, map, searchTokens };
		},
		staleTime: 1000 * 60 * 30,
		enabled: !!campaignId,
	});

	return data || { list: [], map: new Map(), searchTokens: [] };
}

--- END OF features\smart-text\useEntityIndex.js ---

--- FILE: features\smart-text\useSmartText.js ---
import { useMemo } from 'react';
import { useEntityIndex } from './useEntityIndex';

const escapeRegex = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

const findEntityMatches = (text, searchTokens, entityMap) => {
	const matches = [];
	const processedRanges = [];

	if (!searchTokens || searchTokens.length === 0) return [];

	for (const token of searchTokens) {
		// Use standard Word Boundaries (\b) for matching
		const pattern = new RegExp(`\\b${escapeRegex(token.term)}\\b`, 'gi');
		let match;

		while ((match = pattern.exec(text)) !== null) {
			const start = match.index;
			const end = start + token.term.length;

			// Check overlap
			const overlaps = processedRanges.some(
				(range) =>
					(start >= range.start && start < range.end) ||
					(end > range.start && end <= range.end) ||
					(start <= range.start && end >= range.end)
			);

			if (!overlaps) {
				const entity = entityMap.get(token.entityId);
				if (entity) {
					// CHANGED: Use text.slice(start, end) to grab the ACTUAL text
					// (e.g., "the Arcane Brotherhood") instead of token.term ("The Arcane Brotherhood")
					matches.push({
						start,
						end,
						text: text.slice(start, end),
						entity,
					});
					processedRanges.push({ start, end });
				}
			}
		}
	}

	return matches.sort((a, b) => a.start - b.start);
};

const replaceMatches = (text, matches) => {
	if (matches.length === 0) return text;
	let result = '';
	let lastIndex = 0;
	for (const match of matches) {
		result += text.slice(lastIndex, match.start);
		result += `[${match.text}](#entity/${match.entity.id}/${match.entity.type})`;
		lastIndex = match.end;
	}
	result += text.slice(lastIndex);
	return result;
};

export function useSmartText(text) {
	const { searchTokens, map } = useEntityIndex();

	const shouldProcess = useMemo(() => {
		if (!text || typeof text !== 'string' || text.length < 3) return false;
		if (!searchTokens || searchTokens.length === 0) return false;
		return true;
	}, [text, searchTokens]);

	return useMemo(() => {
		if (!shouldProcess) return text || '';

		try {
			const linkProtectionRegex = /(\[.*?\]\(.*?\))/g;
			const parts = text.split(linkProtectionRegex);

			const processedParts = parts.map((part) => {
				if (part.startsWith('[') && part.includes('](') && part.endsWith(')')) {
					return part;
				}
				const matches = findEntityMatches(part, searchTokens, map);
				return replaceMatches(part, matches);
			});

			return processedParts.join('');
		} catch (err) {
			console.error('SmartMarkdown processing error:', err);
			return text;
		}
	}, [text, searchTokens, map, shouldProcess]);
}

--- END OF features\smart-text\useSmartText.js ---

--- FILE: features\smart-text\components\EntityEmbed.jsx ---
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowRight } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';

// Utility to calculate brightness from an image
const getImageBrightness = (imageUrl) => {
	return new Promise((resolve) => {
		const img = new Image();
		img.crossOrigin = 'Anonymous';

		img.onload = () => {
			try {
				const canvas = document.createElement('canvas');
				const ctx = canvas.getContext('2d');

				canvas.width = 100;
				canvas.height = 100;

				ctx.drawImage(img, 0, 0, 100, 100);
				const imageData = ctx.getImageData(0, 0, 100, 100);
				const data = imageData.data;

				let totalBrightness = 0;
				let pixelCount = 0;

				for (let i = 0; i < data.length; i += 4) {
					const r = data[i];
					const g = data[i + 1];
					const b = data[i + 2];
					const a = data[i + 3];

					if (a < 125) continue;

					const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
					totalBrightness += brightness;
					pixelCount++;
				}

				const avgBrightness = totalBrightness / pixelCount;
				resolve(avgBrightness);
			} catch (e) {
				resolve(200);
			}
		};

		img.onerror = () => {
			resolve(200);
		};

		img.src = imageUrl;
	});
};

export const EntityEmbed = ({ id, type, label }) => {
	const navigate = useNavigate();
	// FIX: Destructure the 'map' from the new hook signature
	const { map: entityMap } = useEntityIndex();

	// FIX: Use .get() (O(1) speed) instead of .find()
	const entity = entityMap.get(id);
	const resolvedLabel = label || entity?.name || 'Unknown Entity';

	// Resolve Images
	const attributes = parseAttributes(entity?.attributes);
	const customIcon = entity?.iconUrl || resolveImageUrl(attributes, 'icon');
	const bgImage = resolveImageUrl(attributes, 'background_image');

	// State for brightness detection
	const [isDarkBackground, setIsDarkBackground] = useState(false);
	const [isAnalyzing, setIsAnalyzing] = useState(!!bgImage);

	// Analyze background image brightness
	useEffect(() => {
		if (!bgImage) {
			setIsAnalyzing(false);
			return;
		}

		setIsAnalyzing(true);

		getImageBrightness(bgImage).then((brightness) => {
			setIsDarkBackground(brightness < 127.5);
			setIsAnalyzing(false);
		});
	}, [bgImage]);

	// Border Color Logic (Left Side Only)
	const getBorderColor = () => {
		switch (type) {
			case 'encounter':
				return 'border-l-red-600';
			case 'quest':
				return 'border-l-blue-600';
			case 'location':
				return 'border-l-emerald-600';
			default:
				return 'border-l-amber-600';
		}
	};

	const getActionLabel = () => {
		switch (type) {
			case 'encounter':
				return 'View Encounter';
			case 'quest':
				return 'View Quest';
			case 'location':
				return 'View Map';
			default:
				return 'View Entity';
		}
	};

	return (
		<span
			role='button'
			onClick={(e) => {
				e.preventDefault();
				navigate(`/wiki/${type}/${id}`);
			}}
			className={clsx(
				// Layout & Base (Changed to flex to behave like block context within span)
				'group relative w-full h-[30px] my-4 cursor-pointer select-none overflow-hidden',
				'flex rounded-md transition-all duration-200',

				// Borders
				'border border-border/60 border-l-[3px]',
				getBorderColor(),

				// Background (Default White if no image)
				!bgImage && 'bg-background hover:bg-muted/30',

				// Hover Effects
				'hover:shadow hover:border-l-4'
			)}>
			{/* BACKGROUND IMAGE LAYER */}
			{bgImage && (
				<span
					className='absolute inset-0 bg-cover bg-center opacity-80 group-hover:scale-105 transition-transform duration-500 block'
					style={{ backgroundImage: `url('${bgImage}')` }}
				/>
			)}

			{/* CONTENT LAYER */}
			<span className='relative z-10 flex items-center gap-2 pl-2 pr-3 h-full w-full'>
				{/* Icon - Adaptive color, no background */}
				<span
					className={clsx(
						'shrink-0 flex items-center justify-center opacity-90 group-hover:opacity-100 transition-all duration-200',
						isAnalyzing ? 'opacity-0' : 'opacity-100'
					)}
					style={{
						filter: bgImage
							? isDarkBackground
								? 'brightness(0) invert(1)' // White for dark backgrounds
								: 'brightness(0)' // Black for light backgrounds
							: 'none',
					}}>
					<EntityIcon
						type={type}
						customIconUrl={customIcon}
						size={16}
						inline={true}
						className='object-cover rounded-full'
					/>
				</span>

				{/* Label */}
				<span
					className={clsx(
						'font-serif font-bold text-[12px] truncate leading-none flex-1 pt-0.5 block',
						'transition-colors duration-200',
						isAnalyzing ? 'opacity-0' : 'opacity-100',
						bgImage ? (isDarkBackground ? 'text-white' : 'text-black') : 'text-foreground'
					)}>
					{resolvedLabel}
				</span>

				{/* Right Side Action */}
				<span
					className={clsx(
						'text-[9px] font-bold uppercase tracking-wider flex items-center gap-1 shrink-0 transition-colors',
						isAnalyzing ? 'opacity-0' : 'opacity-100',
						bgImage
							? isDarkBackground
								? 'text-white/90 group-hover:text-white'
								: 'text-black/90 group-hover:text-black'
							: 'text-muted-foreground/60 group-hover:text-amber-700'
					)}>
					{getActionLabel()} <ArrowRight size={10} />
				</span>
			</span>
		</span>
	);
};

--- END OF features\smart-text\components\EntityEmbed.jsx ---

--- FILE: features\smart-text\components\SmartEntityLink.jsx ---
/**
 * SmartEntityLink - MIGRATED to use EntityLink component
 * This is now just a thin wrapper that adds entity index lookup
 */

import EntityLink from '@/domain/entity/components/EntityLink';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';

export const SmartEntityLink = ({ id, type, children }) => {
	// FIX: Destructure the 'map' from the new hook signature
	const { map: entityMap } = useEntityIndex();

	// FIX: Use .get() (O(1) speed) instead of .find()
	const entity = entityMap.get(id);
	const customIconUrl = entity?.iconUrl;

	return (
		<EntityLink id={id} type={type} customIconUrl={customIconUrl} inline>
			{children}
		</EntityLink>
	);
};

--- END OF features\smart-text\components\SmartEntityLink.jsx ---

--- FILE: features\smart-tooltip\TooltipContainer.jsx ---
import { createPortal } from 'react-dom';
import { useQuery } from '@tanstack/react-query';
import { getTooltipData } from '@/domain/entity/api/entityService';
import { TooltipCard } from './components/TooltipCard';

export const TooltipContainer = ({ target, onMouseEnter, onMouseLeave }) => {
	const targetId = target?.id;
	const targetType = target?.type;
	const isValidId = targetId ? /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(targetId) : false;

	const { data, isLoading } = useQuery({
		queryKey: ['tooltip', targetId],
		queryFn: async () => {
			if (!targetId) return null;
			const rawData = await getTooltipData(targetId, targetType);

			// FIX: If it's a session, ensure the 'narrative' is used as description
			// because the entities table often has null description for sessions.
			if (targetType === 'session' && !rawData.description && rawData.narrative) {
				return { ...rawData, description: rawData.narrative };
			}

			return rawData;
		},
		enabled: !!targetId && isValidId,
		staleTime: 1000 * 60 * 5,
		retry: false,
	});

	if (!target) return null;
	const isMobile = window.matchMedia('(pointer: coarse)').matches || window.innerWidth < 1024;

	return createPortal(
		<>
			{/* Mobile Backdrop to close tooltip on tap outside */}
			{isMobile && (
				<div
					className='fixed inset-0 z-[9998]'
					onClick={(e) => {
						e.stopPropagation();
						onMouseLeave && onMouseLeave();
					}}
					style={{ touchAction: 'none' }}
				/>
			)}
			<TooltipCard
				data={data}
				type={target.type}
				id={target.id}
				position={target.pos}
				isLoading={isLoading}
				onMouseEnter={onMouseEnter}
				onMouseLeave={onMouseLeave}
			/>
		</>,
		document.body
	);
};

--- END OF features\smart-tooltip\TooltipContainer.jsx ---

--- FILE: features\smart-tooltip\TooltipContext.jsx ---
import { createContext, useContext } from 'react';
import { useTooltipState } from './useTooltipState';
import { TooltipContainer } from './TooltipContainer';

const TooltipContext = createContext(null);

export const TooltipProvider = ({ children }) => {
	const { activeTooltip, openTooltip, closeTooltip, cancelClose } = useTooltipState();

	return (
		<TooltipContext.Provider value={{ openTooltip, closeTooltip, cancelClose }}>
			{children}

			{/* Pass interaction handlers to the Overlay Layer */}
			<TooltipContainer target={activeTooltip} onMouseEnter={cancelClose} onMouseLeave={closeTooltip} />
		</TooltipContext.Provider>
	);
};

export const useTooltip = () => {
	const context = useContext(TooltipContext);

	// CHANGED: Graceful degradation instead of hard crash
	if (!context) {
		// Return dummy functions so components don't break
		return {
			openTooltip: () => {},
			closeTooltip: () => {},
			cancelClose: () => {},
		};
	}
	return context;
};

--- END OF features\smart-tooltip\TooltipContext.jsx ---

--- FILE: features\smart-tooltip\useSmartPosition.js ---
import { useState, useEffect, useRef } from 'react';

/**
 * Calculates smart positioning for tooltips to keep them onscreen
 * @param {Object} targetPosition - { x, y } coordinates of the trigger element
 * @param {boolean} isOpen - Whether the tooltip is currently visible
 * @returns {Object} - { style, tooltipRef } for positioning
 */
export function useSmartPosition(targetPosition, isOpen) {
	const tooltipRef = useRef(null);
	const [position, setPosition] = useState({ top: 0, left: 0, transform: '' });
	const [isPositioned, setIsPositioned] = useState(false);

	useEffect(() => {
		if (!isOpen || !tooltipRef.current || !targetPosition) {
			setIsPositioned(false);
			return;
		}

		const calculatePosition = () => {
			const tooltip = tooltipRef.current;
			const rect = tooltip.getBoundingClientRect();

			// Get viewport dimensions
			const viewportWidth = window.innerWidth;
			const viewportHeight = window.innerHeight;

			// Configuration
			const EDGE_PADDING = 10; // Minimum distance from screen edges
			const OFFSET_Y = 20; // Distance below cursor
			const TOOLTIP_WIDTH = 300; // Match your tooltip width

			let top = targetPosition.y + OFFSET_Y;
			let left = targetPosition.x;
			let transform = 'translateX(-50%)'; // Center by default

			// --- HORIZONTAL POSITIONING ---

			// Calculate where the tooltip would end up with center alignment
			const leftEdge = left - TOOLTIP_WIDTH / 2;
			const rightEdge = left + TOOLTIP_WIDTH / 2;

			if (rightEdge > viewportWidth - EDGE_PADDING) {
				// Tooltip would overflow right side
				// Align to right edge of viewport with padding
				left = viewportWidth - EDGE_PADDING;
				transform = 'translateX(-100%)'; // Right align
			} else if (leftEdge < EDGE_PADDING) {
				// Tooltip would overflow left side
				// Align to left edge of viewport with padding
				left = EDGE_PADDING;
				transform = 'translateX(0)'; // Left align
			}

			// --- VERTICAL POSITIONING ---

			// Check if tooltip would overflow bottom
			if (top + rect.height > viewportHeight - EDGE_PADDING) {
				// Position above the cursor instead
				top = targetPosition.y - rect.height - 10;

				// If it still doesn't fit above, clamp to top
				if (top < EDGE_PADDING) {
					top = EDGE_PADDING;
				}
			}

			// Ensure tooltip doesn't go above viewport
			if (top < EDGE_PADDING) {
				top = EDGE_PADDING;
			}

			setPosition({ top, left, transform });
			setIsPositioned(true);
		};

		// Initial calculation
		calculatePosition();

		// Recalculate on resize (debounced)
		let resizeTimer;
		const handleResize = () => {
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(calculatePosition, 100);
		};

		window.addEventListener('resize', handleResize);

		return () => {
			window.removeEventListener('resize', handleResize);
			clearTimeout(resizeTimer);
		};
	}, [targetPosition, isOpen]);

	const style = {
		position: 'fixed',
		top: `${position.top}px`,
		left: `${position.left}px`,
		transform: position.transform,
		zIndex: 9999,
		width: '300px',
		pointerEvents: 'auto',
		opacity: isPositioned ? 1 : 0,
		transition: 'opacity 0.15s ease-out',
	};

	return { style, tooltipRef, isPositioned };
}

--- END OF features\smart-tooltip\useSmartPosition.js ---

--- FILE: features\smart-tooltip\useTooltipState.js ---
import { useState, useRef, useCallback, useEffect } from 'react';
// import './types';

export function useTooltipState() {
	const [activeTooltip, setActiveTooltip] = useState(null);
	const timeoutRef = useRef(null);

	useEffect(() => {
		return () => {
			if (timeoutRef.current) {
				clearTimeout(timeoutRef.current);
			}
		};
	}, []);

	const openTooltip = useCallback((e, id, type, isPinned = false) => {
		// If we are opening a new one, clear any pending close
		if (timeoutRef.current) clearTimeout(timeoutRef.current);

		// Get position from event
		let x = e.clientX;
		let y = e.clientY;

		// For touch events on mobile, use touch coordinates
		if (e.touches && e.touches[0]) {
			x = e.touches[0].clientX;
			y = e.touches[0].clientY;
		}

		setActiveTooltip({ id, type, pos: { x, y }, isPinned });
	}, []);

	const closeTooltip = useCallback(() => {
		// Add a delay so the user can move their mouse from the link TO the tooltip
		timeoutRef.current = setTimeout(() => {
			setActiveTooltip(null);
		}, 300); // 300ms grace period
	}, []);

	// Allows the Tooltip Card to say "I'm being hovered, don't close!"
	const cancelClose = useCallback(() => {
		if (timeoutRef.current) clearTimeout(timeoutRef.current);
	}, []);

	return {
		activeTooltip,
		openTooltip,
		closeTooltip,
		cancelClose,
	};
}

--- END OF features\smart-tooltip\useTooltipState.js ---

--- FILE: features\smart-tooltip\components\TooltipCard.jsx ---
import { useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import { ArrowRight, Heart, Crown, Shield, Wind } from 'lucide-react';
import { useSmartPosition } from '@/features/smart-tooltip/useSmartPosition';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

// SINGLE SOURCE OF TRUTH IMPORTS
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { getEntityPalette } from '@/domain/entity/config/entityColors';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import { TOOLTIP_PROFILES, DEFAULT_PROFILE } from '../config/tooltipProfiles';

// --- UTILS ---

const resolveField = (attrs, key) => {
	if (key === 'level_prefix') {
		const lvl = getAttributeValue(attrs, 'level');
		return lvl ? `Lvl ${lvl}` : null;
	}
	if (key === 'session_number_prefixed') {
		const num = getAttributeValue(attrs, ['session_number', 'number']);
		return num ? `Session ${num}` : null;
	}
	return getAttributeValue(attrs, key);
};

// --- MINI COMPONENTS ---

const StatusDot = ({ status }) => {
	if (!status) return null;
	const s = status.toLowerCase();
	const isDead = ['dead', 'destroyed', 'completed', 'failed'].includes(s);
	const isAlive = ['alive', 'active', 'in progress'].includes(s);

	let colorClass = 'bg-muted-foreground/50';
	if (isDead) colorClass = 'bg-red-500';
	if (isAlive) colorClass = 'bg-emerald-500';

	return (
		<div className='flex items-center gap-1.5 text-[10px] font-medium uppercase tracking-wide text-muted-foreground/90'>
			<span className={`w-1.5 h-1.5 rounded-full ${colorClass}`} />
			{status}
		</div>
	);
};

const TagText = ({ value, type }) => {
	if (!value) return null;
	const v = value.toLowerCase();

	let colorClass = 'text-muted-foreground';

	if (type === 'affinity') {
		if (['enemy', 'hostile'].includes(v)) colorClass = 'text-orange-600 dark:text-orange-400';
		if (['ally', 'friendly'].includes(v)) colorClass = 'text-blue-600 dark:text-blue-400';
	}

	return <span className={clsx('text-[10px] font-bold uppercase tracking-wide opacity-90', colorClass)}>{value}</span>;
};

// --- MAIN CARD ---

export const TooltipCard = ({ data, type, id, position, isLoading, onMouseEnter, onMouseLeave }) => {
	const navigate = useNavigate();

	// 1. Get Domain Configuration
	const config = getEntityConfig(type);
	const palette = getEntityPalette(type);
	const TypeIcon = config.icon;

	// 2. Get Layout Profile
	const profile = TOOLTIP_PROFILES[type] || DEFAULT_PROFILE;

	const { style, tooltipRef } = useSmartPosition(position, true);

	const handleClick = (e) => {
		e.stopPropagation();
		navigate(`/wiki/${type}/${id}`);
		onMouseLeave && onMouseLeave();
	};

	// 3. Dynamic Styles based on Entity Palette (500 shade)
	const primaryColor = palette[500];
	const fallbackGradient = {
		background: `linear-gradient(135deg, ${primaryColor}33 0%, ${primaryColor}11 100%)`,
	};

	if (isLoading) {
		return (
			<div
				ref={tooltipRef}
				style={style}
				className='bg-background/95 backdrop-blur p-4 rounded-lg shadow-xl border border-border text-xs text-muted-foreground'>
				Loading...
			</div>
		);
	}

	if (!data) return null;

	const attributes = parseAttributes(data.attributes);
	const image = resolveImageUrl(attributes, 'background');

	// Info Line
	const infoParts = (profile.subtitle || []).map((key) => resolveField(attributes, key)).filter(Boolean);
	const infoLine = infoParts.join('  ');

	// Extra Data
	const hp = profile.features?.showHP ? getAttributeValue(attributes, ['hit points', 'hp']) : null;
	const armorClass = profile.features?.showArmorClass ? getAttributeValue(attributes, ['armor class', 'ac']) : null;
	const movement = profile.features?.showMovement ? getAttributeValue(attributes, ['movement', 'speed']) : null;
	const ruler = profile.features?.showRuler ? getAttributeValue(attributes, 'ruler') : null;

	// Personality Parsing
	let parsedPersonality = null;
	const personality = profile.features?.showPersonality ? getAttributeValue(attributes, 'personality') : null;
	if (personality) {
		if (Array.isArray(personality)) {
			parsedPersonality = personality.map((p) => p.value || p).join(' ');
		} else {
			parsedPersonality = personality;
		}
	}

	return (
		<div
			ref={tooltipRef}
			style={style}
			onClick={handleClick}
			onMouseEnter={onMouseEnter}
			onMouseLeave={onMouseLeave}
			className={clsx(
				'bg-background rounded-lg shadow-2xl ring-1 ring-border group flex flex-col w-[300px] overflow-hidden select-none',
				'hover:ring-2 transition-all duration-200'
			)}>
			{/* HEADER */}
			{image ? (
				<div className='h-28 w-full bg-muted relative shrink-0'>
					<img src={image} alt='' className='w-full h-full object-cover opacity-90' />
					<div className='absolute inset-0 bg-gradient-to-t from-background via-transparent to-transparent' />
				</div>
			) : (
				<div className='h-20 w-full relative overflow-hidden shrink-0' style={fallbackGradient}>
					<TypeIcon
						strokeWidth={1.5}
						className='absolute -bottom-3 -right-3 w-24 h-24 opacity-[0.07] -rotate-12 text-foreground'
						style={{ color: primaryColor }}
					/>
				</div>
			)}

			{/* CONTENT */}
			<div className={clsx('flex flex-col px-4 pb-3', image ? '-mt-8 relative z-10' : 'pt-2')}>
				{/* TITLE ROW */}
				<div className='flex justify-between items-end gap-2 mb-1'>
					<div className='min-w-0 flex-1'>
						<span
							className='text-[9px] font-bold uppercase tracking-wider block opacity-70 mb-0.5'
							style={{ color: primaryColor }}>
							{data.type}
						</span>
						<h3
							className={clsx(
								'font-serif font-bold text-xl leading-none truncate pr-1 drop-shadow-sm text-foreground'
							)}>
							{data.name}
						</h3>
					</div>
					{/* Floating Icon Badge */}
					<div
						className={clsx(
							'p-1.5 rounded-md border shadow-sm shrink-0 mb-0.5',
							image
								? 'bg-background/90 text-foreground border-transparent backdrop-blur'
								: 'bg-muted/30 border-border/50'
						)}>
						<TypeIcon size={18} strokeWidth={1.5} style={!image ? { color: primaryColor } : {}} />
					</div>
				</div>

				{/* SUBTITLE */}
				{infoLine && <div className='text-xs font-medium text-muted-foreground/90 mb-2 truncate'>{infoLine}</div>}

				{/* TAGS */}
				{(profile.tags?.length > 0 || hp) && (
					<div className='flex items-center gap-3 mb-3 border-b border-border/40 pb-2'>
						{hp && (
							<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground mr-1'>
								<Heart size={10} className='text-red-500/70 fill-red-500/10' /> {hp}
							</div>
						)}
						{armorClass && (
							<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground mr-1'>
								<Shield size={10} className='text-emerald-500/70 fill-emerald-500/10' /> {armorClass}
							</div>
						)}
						{movement && (
							<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground mr-1'>
								<Wind size={10} className='text-blue-500/70 fill-blue-500/10' /> {movement}
							</div>
						)}
						{profile.tags?.includes('status') && <StatusDot status={getAttributeValue(attributes, 'status')} />}
						{profile.tags?.includes('affinity') && (
							<TagText value={getAttributeValue(attributes, 'affinity')} type='affinity' />
						)}
						{profile.tags?.includes('priority') && (
							<TagText value={getAttributeValue(attributes, 'priority')} type='priority' />
						)}
					</div>
				)}

				{/* PERSONALITY */}
				{parsedPersonality && (
					<div className='mb-2 text-xs italic text-muted-foreground/80 leading-relaxed border-l-2 border-border/60 pl-2'>
						<SmartMarkdown inline={true} disableTooltips={true}>
							{`"${parsedPersonality}"`}
						</SmartMarkdown>
					</div>
				)}

				{/* DESCRIPTION */}
				{data.description && (
					<div className='text-xs text-muted-foreground/90'>
						<div className='max-h-[140px] overflow-y-auto pr-2 custom-scrollbar leading-relaxed'>
							<SmartMarkdown inline={true} disallowedElements={['h1', 'h2', 'h3', 'img']} disableTooltips={true}>
								{data.description}
							</SmartMarkdown>
						</div>
					</div>
				)}
			</div>

			{/* FOOTER */}
			<div className='bg-muted/30 py-1.5 px-3 border-t border-border flex justify-between items-center mt-auto shrink-0'>
				<span className='text-[9px] text-muted-foreground/50 font-medium'>
					{ruler && (
						<span className='flex items-center gap-1'>
							<Crown size={8} /> {ruler}
						</span>
					)}
				</span>

				<span className='text-[9px] font-semibold text-muted-foreground/60 flex items-center gap-1 group-hover:text-amber-600 transition-colors'>
					Open Wiki <ArrowRight size={8} />
				</span>
			</div>
		</div>
	);
};

--- END OF features\smart-tooltip\components\TooltipCard.jsx ---

--- FILE: features\smart-tooltip\config\tooltipProfiles.js ---
// Defines WHICH data fields to show for each entity type.
// Visuals (Icons, Colors) are handled by the centralized EntityConfig.

export const TOOLTIP_PROFILES = {
	// --- CHARACTERS ---
	character: {
		subtitle: ['level_prefix', 'race', 'class'],
		tags: ['status'],
		features: { showHP: true, showArmorClass: true, showMovement: true },
	},

	// --- NPCs ---
	npc: {
		subtitle: ['gender', 'race', 'role'],
		tags: ['status', 'affinity'],
		features: { showPersonality: true },
	},

	// --- LOCATIONS ---
	location: {
		subtitle: ['type', 'parent_location'],
		tags: [],
		features: { showRuler: true },
	},

	// --- QUESTS ---
	quest: {
		subtitle: ['quest type'],
		tags: ['status', 'priority'],
		features: {},
	},

	// --- ENCOUNTERS ---
	encounter: {
		subtitle: ['status'],
		tags: [],
		features: {},
	},

	// --- FACTIONS ---
	faction: {
		subtitle: ['affinity'],
		tags: [],
		features: {},
	},

	// --- SESSIONS ---
	session: {
		subtitle: ['session_number_prefixed', 'session_date'],
		tags: [],
		features: {},
	},
};

export const DEFAULT_PROFILE = {
	subtitle: ['type'],
	tags: [],
	features: {},
};

--- END OF features\smart-tooltip\config\tooltipProfiles.js ---

--- FILE: features\table-of-contents\TableOfContents.jsx ---
import { useState, useEffect, useMemo, useRef } from 'react';
import { clsx } from 'clsx';
import { List, ChevronRight, ChevronDown } from 'lucide-react';
import { useTocObserver } from './hooks/useTocObserver';
import { useTocScroll } from './hooks/useTocScroll';
import { TocMobileDrawer } from './components/TocMobileDrawer';

export const TableOfContents = ({
	items,
	className,
	visibilityClass = 'hidden xl:block',
	mobileToggleClass = 'xl:hidden',
}) => {
	const [isOpen, setIsOpen] = useState(false);
	const [expandedIds, setExpandedIds] = useState(new Set());

	// NAV LOCK
	const isNavigating = useRef(false);
	const scrollTimeout = useRef(null);

	const itemIds = useMemo(() => items?.map((i) => i.id) || [], [items]);
	const activeId = useTocObserver(itemIds);
	const { scrollToId: originalScrollTo } = useTocScroll(() => setIsOpen(false));

	// 1. Parent Map
	const parents = useMemo(() => {
		const parentMap = new Map();
		for (let i = 0; i < items.length - 1; i++) {
			const current = items[i];
			const next = items[i + 1];
			if (current.depth === 2 && next.depth === 3) {
				const children = [];
				for (let j = i + 1; j < items.length; j++) {
					if (items[j].depth <= current.depth) break;
					children.push(items[j].id);
				}
				parentMap.set(current.id, children);
			}
		}
		return parentMap;
	}, [items]);

	// 2. Scroll Handler
	const handleScrollTo = (id) => {
		isNavigating.current = true;
		if (scrollTimeout.current) clearTimeout(scrollTimeout.current);

		let targetParentId = null;
		if (parents.has(id)) targetParentId = id;
		else {
			for (const [pId, children] of parents.entries()) {
				if (children.includes(id)) {
					targetParentId = pId;
					break;
				}
			}
		}

		if (targetParentId) setExpandedIds(new Set([targetParentId]));
		originalScrollTo(id);

		scrollTimeout.current = setTimeout(() => {
			isNavigating.current = false;
		}, 1000);
	};

	// 3. Auto-Expand
	useEffect(() => {
		if (isNavigating.current || !activeId) return;

		let activeParentId = null;
		if (parents.has(activeId)) activeParentId = activeId;
		else {
			for (const [pId, children] of parents.entries()) {
				if (children.includes(activeId)) {
					activeParentId = pId;
					break;
				}
			}
		}

		setExpandedIds((prev) => {
			if (activeParentId) {
				if (prev.size === 1 && prev.has(activeParentId)) return prev;
				return new Set([activeParentId]);
			}
			if (prev.size === 0) return prev;
			return new Set();
		});
	}, [activeId, parents]);

	// Toggle Handler
	const toggleExpand = (e, id) => {
		e.preventDefault();
		e.stopPropagation();
		setExpandedIds((prev) => {
			const newSet = new Set(prev);
			if (newSet.has(id)) newSet.delete(id);
			else newSet.add(id);
			return newSet;
		});
	};

	if (!items || items.length === 0) return null;

	return (
		<>
			{/* --- DESKTOP RAIL --- */}
			<aside
				className={clsx(
					visibilityClass,
					'sticky top-24 max-h-[calc(100vh-6rem)] w-64 shrink-0 self-start overflow-y-auto custom-scrollbar py-4 pr-2',
					className
				)}>
				<div className='flex flex-col'>
					<nav className='relative ml-4 flex flex-col border-l border-border/60'>
						<div className='mb-2 pl-4 text-sm font-semibold tracking-tight text-foreground/90'>On this page</div>
						{items.map((item) => {
							const hasChildren = parents.has(item.id);
							const isExpanded = expandedIds.has(item.id);

							let isHidden = false;
							if (item.depth === 3) {
								const parentIndex = items.slice(0, items.indexOf(item)).findLastIndex((i) => i.depth === 2);
								if (parentIndex !== -1) {
									const parent = items[parentIndex];
									if (parents.has(parent.id) && !expandedIds.has(parent.id)) isHidden = true;
								}
							}

							if (isHidden) return null;

							return (
								<div
									key={item.id}
									className={clsx('relative flex items-center', item.depth === 1 ? 'mb-1 mt-3' : 'mt-0')}>
									<div
										className={clsx(
											'absolute left-0 -ml-[1px] h-full w-[2px] transition-colors duration-200',
											activeId === item.id ? 'bg-primary' : 'bg-transparent'
										)}
									/>
									<div className='group flex w-full items-center justify-between'>
										<a
											href={`#${item.id}`}
											onClick={(e) => {
												e.preventDefault();
												handleScrollTo(item.id);
											}}
											className={clsx(
												'block w-full truncate py-1 pr-2 transition-colors',
												'text-[13px] leading-snug',
												activeId === item.id
													? 'font-medium text-primary'
													: 'text-muted-foreground hover:text-foreground',
												item.depth === 1 && 'pl-4 text-xs font-bold uppercase tracking-wider text-foreground/80',
												item.depth === 2 && 'pl-4',
												item.depth === 3 && 'pl-8 text-muted-foreground/80'
											)}>
											{item.text}
										</a>
										{hasChildren && (
											<button
												onClick={(e) => toggleExpand(e, item.id)}
												className='mr-1 shrink-0 rounded-sm p-0.5 text-muted-foreground transition-colors hover:bg-accent hover:text-foreground'
												aria-label={isExpanded ? 'Collapse' : 'Expand'}>
												{isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
											</button>
										)}
									</div>
								</div>
							);
						})}
					</nav>
				</div>
			</aside>

			{/* --- MOBILE TOGGLE --- */}
			<div className={clsx('fixed bottom-6 right-6 z-40', mobileToggleClass)}>
				<button
					onClick={() => setIsOpen(true)}
					className='flex h-12 w-12 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-xl transition-transform hover:bg-primary/90 active:scale-95'>
					<List size={20} />
				</button>
			</div>

			{/* --- MOBILE DRAWER (Now receiving state) --- */}
			<TocMobileDrawer
				isOpen={isOpen}
				items={items}
				activeId={activeId}
				parents={parents}
				expandedIds={expandedIds}
				toggleExpand={toggleExpand}
				onClose={() => setIsOpen(false)}
				onScrollTo={handleScrollTo}
			/>
		</>
	);
};

--- END OF features\table-of-contents\TableOfContents.jsx ---

--- FILE: features\table-of-contents\components\TocItem.jsx ---
import { clsx } from 'clsx';

export const TocItem = ({ item, isActive, onClick }) => {
	return (
		<a
			href={`#${item.id}`}
			onClick={(e) => {
				e.preventDefault();
				onClick(item.id);
			}}
			className={clsx(
				'group flex w-full items-center py-2 transition-all duration-200',
				// THE LUCIDE TRICK:
				// 1. -ml-px pulls this item 1px to the left, exactly on top of the parent's border.
				// 2. border-l-2 gives us the colored bar.
				'-ml-px border-l-2 pl-4',

				// Depth Indentation (Lucide flattens depth usually, but we keep indentation)
				item.depth === 2 ? 'pl-4' : item.depth === 3 ? 'pl-8' : '',

				isActive
					? 'border-primary text-primary font-medium'
					: 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground/50'
			)}>
			<span className='text-sm truncate'>{item.text}</span>
		</a>
	);
};

--- END OF features\table-of-contents\components\TocItem.jsx ---

--- FILE: features\table-of-contents\components\TocMobileDrawer.jsx ---
import { Drawer } from '@/shared/components/ui/Drawer';
import { clsx } from 'clsx';
import { ChevronRight, ChevronDown } from 'lucide-react';

export const TocMobileDrawer = ({
	isOpen,
	items,
	activeId,
	parents, // passed from parent
	expandedIds, // passed from parent
	toggleExpand, // passed from parent
	onClose,
	onScrollTo,
}) => {
	return (
		<Drawer isOpen={isOpen} onClose={onClose} title='Table of Contents' position='right'>
			<div className='flex flex-col py-4'>
				<nav className='relative flex flex-col'>
					{items.map((item) => {
						const hasChildren = parents.has(item.id);
						const isExpanded = expandedIds.has(item.id);

						// Hiding Logic (Same as Desktop)
						let isHidden = false;
						if (item.depth === 3) {
							const parentIndex = items.slice(0, items.indexOf(item)).findLastIndex((i) => i.depth === 2);
							if (parentIndex !== -1) {
								const parent = items[parentIndex];
								if (parents.has(parent.id) && !expandedIds.has(parent.id)) {
									isHidden = true;
								}
							}
						}

						if (isHidden) return null;

						return (
							<div
								key={item.id}
								className={clsx('relative flex items-center', item.depth === 1 ? 'mb-2 mt-4' : 'mt-0')}>
								{/* Active Indicator Line (Thicker for Mobile) */}
								<div
									className={clsx(
										'absolute left-0 -ml-[2px] h-full w-[4px] rounded-r-sm transition-colors duration-200',
										activeId === item.id ? 'bg-primary' : 'bg-transparent'
									)}
								/>

								<div className='flex w-full items-center justify-between'>
									<button
										onClick={() => {
											onScrollTo(item.id);
											onClose(); // Close drawer on selection
										}}
										className={clsx(
											'flex h-full w-full items-center py-2 pr-4 text-left transition-colors',
											'text-[13px] leading-snug', // Slightly larger font than desktop
											activeId === item.id
												? 'text-[14px] text-primary'
												: 'text-muted-foreground active:text-foreground',
											item.depth === 1 && 'pl-5 text-xs font-bold uppercase tracking-wider text-foreground/80',
											item.depth === 2 && 'pl-5',
											item.depth === 3 && 'pl-9 text-muted-foreground/80'
										)}>
										{item.text}
									</button>

									{/* Toggle Button for Parents */}
									{hasChildren && (
										<button
											onClick={(e) => toggleExpand(e, item.id)}
											className='mr-2 flex h-10 w-10 items-center justify-center rounded-md text-muted-foreground active:bg-accent active:text-foreground'
											aria-label={isExpanded ? 'Collapse' : 'Expand'}>
											{isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}
										</button>
									)}
								</div>
							</div>
						);
					})}
				</nav>
			</div>
		</Drawer>
	);
};

--- END OF features\table-of-contents\components\TocMobileDrawer.jsx ---

--- FILE: features\table-of-contents\hooks\useTocObserver.js ---
import { useState, useEffect } from 'react';

export function useTocObserver(itemIds) {
	const [activeId, setActiveId] = useState(null);

	useEffect(() => {
		if (!itemIds?.length) return;

		const handleScroll = () => {
			// The "reading line" is 100px down from the top of the viewport.
			// We want to highlight the last header that is ABOVE this line.
			const offset = 120;

			let newActiveId = null;

			// We iterate in REVERSE order.
			// The first header we encounter that is "above the line" (rect.top < offset)
			// is effectively the section we are currently reading.
			for (let i = itemIds.length - 1; i >= 0; i--) {
				const id = itemIds[i];
				const element = document.getElementById(id);

				if (element) {
					const rect = element.getBoundingClientRect();

					// if rect.top is less than 120px, the header has scrolled up past our "eye level"
					if (rect.top < offset) {
						newActiveId = id;
						break; // Stop looking, we found the deepest active header
					}
				}
			}

			setActiveId(newActiveId);
		};

		// 'capture: true' is CRITICAL here.
		// It allows us to detect scroll events on nested divs (like <main>)
		// that don't bubble up to window normally.
		window.addEventListener('scroll', handleScroll, { capture: true, passive: true });

		// Run once on mount to set initial state
		handleScroll();

		return () => {
			window.removeEventListener('scroll', handleScroll, { capture: true });
		};
	}, [itemIds]);

	return activeId;
}

--- END OF features\table-of-contents\hooks\useTocObserver.js ---

--- FILE: features\table-of-contents\hooks\useTocScroll.js ---
import { useCallback } from 'react';

export function useTocScroll(callback) {
	const scrollToId = useCallback(
		(id) => {
			const element = document.getElementById(id);

			if (element) {
				// CSS 'scroll-margin-top' handles the offset (sticky header)
				element.scrollIntoView({ behavior: 'smooth', block: 'start' });

				// Optional callback (e.g., to close mobile drawer)
				if (callback) callback();
			} else {
				console.warn(`[ToC] Target element not found: #${id}`);
			}
		},
		[callback]
	);

	return { scrollToId };
}

--- END OF features\table-of-contents\hooks\useTocScroll.js ---

--- FILE: features\timeline\TimelinePage.jsx ---
import { useTimelineViewModel } from './useTimelineView';
import { TimelineSession } from './components/TimelineSession';
import { TimelineArcHeader } from './components/TimelineArcHeader';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { useMemo } from 'react';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { Search, ChevronsUp, ChevronsDown, X } from 'lucide-react';

export default function TimelineView() {
	const { timelineItems, isLoading, searchQuery, setSearchQuery, toggleSession, expandAll, collapseAll } =
		useTimelineViewModel();

	const tocItems = useMemo(() => {
		if (!timelineItems) return [];

		return timelineItems.flatMap((item) => {
			if (item.type === 'arc_header') {
				return [
					{
						id: `arc-marker-${item.id}`,
						text: item.title,
						depth: 1,
					},
				];
			}
			if (item.type === 'session') {
				const sessionNode = {
					id: `session-marker-${item.number}`,
					text: item.title,
					depth: 2,
				};
				if (!item.isExpanded) return [sessionNode];

				const eventNodes = (item.events || []).map((event) => ({
					id: event.id,
					text: event.title,
					depth: 3,
				}));
				return [sessionNode, ...eventNodes];
			}
			return [];
		});
	}, [timelineItems]);

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text='Loading Timeline...' fullScreen />;

	return (
		<div className='h-full overflow-hidden flex flex-col'>
			<div className='flex-1 overflow-y-auto bg-background custom-scrollbar'>
				<div className='max-w-7xl mx-auto p-4 md:p-12'>
					<div className='flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10'>
						<h1 className='text-3xl font-serif font-bold text-foreground'>Campaign History</h1>

						{/* --- TOOLBAR --- */}
						<div className='flex flex-col sm:flex-row gap-3 w-full md:w-auto'>
							{/* Search Input */}
							<div className='relative w-full sm:w-64'>
								<Search className='absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground' />
								<input
									type='text'
									placeholder='Filter events...'
									value={searchQuery}
									onChange={(e) => setSearchQuery(e.target.value)}
									className='w-full h-9 pl-9 pr-8 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring'
								/>
								{searchQuery && (
									<button
										onClick={() => setSearchQuery('')}
										className='absolute right-2 top-2.5 text-muted-foreground hover:text-foreground'>
										<X size={14} />
									</button>
								)}
							</div>

							{/* Toggle Buttons */}
							<div className='flex items-center rounded-md border border-input bg-background shadow-sm h-9'>
								<button
									onClick={expandAll}
									className='flex-1 sm:flex-none px-3 h-full flex items-center gap-2 hover:bg-muted/50 transition-colors border-r border-input text-xs font-medium'
									title='Expand All'>
									<ChevronsDown size={14} /> <span className='sm:hidden lg:inline'>Expand</span>
								</button>
								<button
									onClick={collapseAll}
									className='flex-1 sm:flex-none px-3 h-full flex items-center gap-2 hover:bg-muted/50 transition-colors text-xs font-medium'
									title='Collapse All'>
									<ChevronsUp size={14} /> <span className='sm:hidden lg:inline'>Collapse</span>
								</button>
							</div>
						</div>
					</div>

					<div className='grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-12 relative'>
						{/* 
                           Timeline Container 
                           FIX: Reduced mobile margin to ml-6 (24px) to give content more width.
                           The Arc Icon overhangs -21px. ml-6 + p-4 = 40px space. Safe.
                        */}
						<div className='relative border-l-2 border-border ml-3 md:ml-10 space-y-8 pb-20'>
							{timelineItems.length === 0 ? (
								<div className='py-20 text-center text-muted-foreground'>No events found matching "{searchQuery}"</div>
							) : (
								timelineItems.map((item) => {
									if (item.type === 'arc_header') {
										return (
											<div key={item.id} id={`arc-marker-${item.id}`} className='scroll-mt-12'>
												<TimelineArcHeader arc={item} id={`arc-${item.id}`} />
											</div>
										);
									}
									return (
										<div key={item.id} id={`session-marker-${item.number}`} className='scroll-mt-24'>
											<TimelineSession
												session={item}
												id={`session-${item.number}`}
												onToggle={() => toggleSession(item.id)}
											/>
										</div>
									);
								})
							)}
						</div>

						<TableOfContents items={tocItems} visibilityClass='hidden xl:block' mobileToggleClass='xl:hidden' />
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\timeline\TimelinePage.jsx ---

--- FILE: features\timeline\useTimelineView.js ---
import { useMemo, useState, useCallback } from 'react';
import { useQuery } from '@tanstack/react-query';
import { getTimeline } from '@/features/timeline/api/timelineService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getEventStyle } from './utils/eventStyles';

export function useTimelineViewModel() {
	const { campaignId } = useCampaign();
	const [searchQuery, setSearchQuery] = useState('');
	const [collapsedSessions, setCollapsedSessions] = useState(new Set());

	const { data, isLoading } = useQuery({
		queryKey: ['timeline', campaignId],
		queryFn: () => getTimeline(campaignId),
		enabled: !!campaignId,
	});

	// --- Actions ---

	const toggleSession = useCallback((sessionId) => {
		setCollapsedSessions((prev) => {
			const next = new Set(prev);
			if (next.has(sessionId)) {
				next.delete(sessionId);
			} else {
				next.add(sessionId);
			}
			return next;
		});
	}, []);

	const collapseAll = useCallback(() => {
		if (!data) return;
		const allIds = data.map((s) => s.session_id);
		setCollapsedSessions(new Set(allIds));
	}, [data]);

	const expandAll = useCallback(() => {
		setCollapsedSessions(new Set());
	}, []);

	// --- Filtering & Processing ---

	const timelineItems = useMemo(() => {
		if (!data) return [];

		const items = [];
		let currentArcId = null;

		// Normalize Search
		const query = searchQuery.toLowerCase().trim();
		const isSearching = query.length > 0;

		// Process each session from the DB
		data.forEach((session) => {
			// 1. Filter Logic
			let matchingEvents = [];
			const sessionMatches = session.session_title.toLowerCase().includes(query);

			// Map events to view model first
			const allEvents = (session.events || []).map((event) => ({
				id: event.id,
				title: event.title,
				typeLabel: event.type?.replace(/_/g, ' ') || 'Event',
				description: event.description,
				tags: event.tags || [],
				style: getEventStyle(event.type),
			}));

			if (isSearching) {
				if (sessionMatches) {
					// Match on Session Title -> Show all events
					matchingEvents = allEvents;
				} else {
					// Match on Event Content -> Show only matching events
					matchingEvents = allEvents.filter(
						(e) =>
							e.title.toLowerCase().includes(query) ||
							(e.description && e.description.toLowerCase().includes(query)) ||
							e.tags.some((t) => t.name.toLowerCase().includes(query))
					);
				}
			} else {
				matchingEvents = allEvents;
			}

			// If searching and nothing matches, skip this session entirely
			if (isSearching && !sessionMatches && matchingEvents.length === 0) {
				return;
			}

			// 2. Arc Logic (Only add Arc header if we are adding a session under it)
			if (session.arc_id && session.arc_id !== currentArcId) {
				items.push({
					type: 'arc_header',
					id: `arc-${session.arc_id}`,
					title: session.arc_title,
					description: session.arc_description,
					color: session.arc_attributes?.color || 'amber',
				});
				currentArcId = session.arc_id;
			} else if (!session.arc_id && currentArcId !== null) {
				currentArcId = null;
			}

			// 3. Determine Expansion State
			// If searching, always expand. Otherwise, check state.
			const isExpanded = isSearching ? true : !collapsedSessions.has(session.session_id);

			items.push({
				type: 'session',
				id: session.session_id,
				number: session.session_number ?? 999,
				dateLabel: session.session_date || 'Unknown Date',
				title: session.session_title,
				events: matchingEvents,
				synopsis: session?.attributes?.synopsis || null,
				isExpanded,
				hasActiveSearch: isSearching, // Pass this down to disable toggles during search if desired
			});
		});

		return items;
	}, [data, searchQuery, collapsedSessions]);

	return {
		timelineItems,
		isLoading,
		searchQuery,
		setSearchQuery,
		toggleSession,
		expandAll,
		collapseAll,
	};
}

--- END OF features\timeline\useTimelineView.js ---

--- FILE: features\timeline\api\timelineService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getTimeline = async (campaignId) => {
	// The view handles all aggregation, casting, and ordering efficiently.
	const { data, error } = await supabase
		.from('view_campaign_timeline')
		.select('*')
		.eq('campaign_id', campaignId)
		.order('session_number', { ascending: true }); // Postgres handles the casting/sorting

	if (error) throw error;
	return data || [];
};

--- END OF features\timeline\api\timelineService.js ---

--- FILE: features\timeline\components\TimelineArcHeader.jsx ---
import { BookOpen } from 'lucide-react';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const TimelineArcHeader = ({ arc }) => {
	return (
		// Container sits inside the border-l-2 parent.
		// pt-10: Space from previous session.
		// pb-1: Reduced space to the next session (tight coupling).
		<div className='relative pl-8 md:pl-12 pt-10 pb-1'>
			{/* 
                FIX: "Chapter Marker" Alignment
                - Width 40px (w-10). Center is 20px.
                - Border is 2px. Center is 1px relative to parent.
                - Content starts at 2px.
                - To align centers: Left = -21px (was -19px)
            */}
			<div className='absolute -left-[21px] top-10 flex items-center justify-center w-10 h-10 rounded-full bg-background border-4 border-primary/10 shadow-sm z-10 text-primary'>
				<BookOpen size={20} strokeWidth={2.5} />
			</div>

			{/* Content */}
			<div className='mb-2'>
				<span className='inline-block text-[10px] font-bold uppercase tracking-widest text-primary mb-2 border-b-2 border-primary/50 pb-1'>
					Narrative Arc
				</span>

				<h2 className='text-3xl md:text-4xl font-serif font-bold text-foreground mb-3'>{arc.title}</h2>

				{arc.description && (
					<div className='text-muted-foreground prose prose-sm prose-p:my-1 max-w-none text-pretty'>
						<SmartMarkdown>{arc.description}</SmartMarkdown>
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\timeline\components\TimelineArcHeader.jsx ---

--- FILE: features\timeline\components\TimelineEvent.jsx ---
import { useMemo, memo } from 'react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { Diamond } from 'lucide-react';

export const TimelineEvent = memo(({ event, id }) => {
	const { Icon, container } = event.style;

	const groupedTags = useMemo(() => {
		if (!event.tags || event.tags.length === 0) return [];
		const groups = {};
		event.tags.forEach((tag) => {
			const type = tag.type || 'default';
			if (!groups[type]) groups[type] = [];
			groups[type].push(tag);
		});
		return Object.values(groups);
	}, [event.tags]);

	return (
		// FIX: Reduced gap on mobile (gap-2.5) to gap-4 on desktop
		<div className='relative flex gap-2.5 md:gap-4 group'>
			{/* Icon Bubble - Slightly smaller on mobile (w-7) */}
			<div
				className={clsx(
					'shrink-0 w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center shadow-sm border-2 z-10 transition-transform group-hover:scale-110 bg-background',
					container
				)}>
				<Icon className='w-3.5 h-3.5 md:w-4 md:h-4' strokeWidth={2.5} />
			</div>

			{/* Content */}
			<div id={id} className='flex-1 -mt-1 pb-2 min-w-0'>
				<h4 className='text-sm font-bold text-foreground/80 mb-1 flex flex-wrap items-center gap-2'>
					<span className='mr-auto'>{event.title}</span>
					{/* <span className='text-[9px] font-normal uppercase tracking-wider text-foreground border border-border px-1.5 rounded-sm bg-muted whitespace-nowrap'>
						{event.typeLabel}
					</span> */}
				</h4>

				{event.description && (
					<div className='text-sm text-muted-foreground leading-relaxed text-pretty text-left'>
						<SmartMarkdown>{event.description}</SmartMarkdown>
					</div>
				)}

				{groupedTags.length > 0 && (
					<div className='flex flex-wrap items-center gap-2 mt-2 p-1 bg-card'>
						{groupedTags.map((group, groupIndex) => (
							<div key={groupIndex} className='flex items-center gap-2'>
								<div className='flex flex-wrap gap-2 text-[12px]'>
									<SmartMarkdown inline>{group.map((tag) => tag.name).join(' ')}</SmartMarkdown>
								</div>
								{groupIndex < groupedTags.length - 1 && (
									<Diamond size={6} className='text-gray-300 fill-gray-300 shrink-0' />
								)}
							</div>
						))}
					</div>
				)}
			</div>
		</div>
	);
});

TimelineEvent.displayName = 'TimelineEvent';

--- END OF features\timeline\components\TimelineEvent.jsx ---

--- FILE: features\timeline\components\TimelineSession.jsx ---
import { Calendar, ChevronDown } from 'lucide-react';
import { TimelineEvent } from './TimelineEvent';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { useState, useEffect, useRef, useMemo, memo } from 'react';
import { clsx } from 'clsx';

// Estimated height of an event card to prevent massive layout shifts
const ESTIMATED_EVENT_HEIGHT = 120;

export const TimelineSession = memo(({ session, id, onToggle }) => {
	const [isVisible, setIsVisible] = useState(false);
	const containerRef = useRef(null);
	const { isExpanded, hasActiveSearch } = session;

	useEffect(() => {
		if (!containerRef.current) return;
		if (!isExpanded) return;

		const observer = new IntersectionObserver(
			([entry]) => {
				if (entry.isIntersecting) {
					setIsVisible(true);
					observer.disconnect();
				}
			},
			{
				rootMargin: '600px 0px',
				threshold: 0,
			}
		);

		observer.observe(containerRef.current);

		return () => {
			observer.disconnect();
		};
	}, [isExpanded]);

	const eventList = useMemo(() => {
		if (!isVisible) return null;
		return session.events.map((event) => <TimelineEvent key={event.id} event={event} id={event.id} />);
	}, [session.events, isVisible]);

	const placeholderHeight = session.events.length * ESTIMATED_EVENT_HEIGHT;

	return (
		<div id={id} ref={containerRef} className='relative pl-3 md:pl-12'>
			{/* Session Marker */}
			<div className='absolute -left-[11px] top-0 flex items-center justify-center w-5 h-5 rounded-full bg-background border-2 border-border shadow-sm z-10'>
				<div className='w-2 h-2 rounded-full bg-gray-400' />
			</div>

			{/* 
               FIX: Header Layout
               Removed flex-row columns. The chevron is now inline with the title.
            */}
			<div className='mb-6 cursor-pointer group pl-5 md:pl-0'>
				{/* Metadata Row */}
				<div className='flex flex-wrap items-center gap-x-3 gap-y-1 mb-2'>
					<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground bg-muted px-2 py-0.5 rounded border border-border'>
						Session {session.number - 1}
					</span>
					<time className='text-xs text-muted-foreground/70 flex items-center gap-1 font-medium'>
						<Calendar size={12} /> {session.dateLabel}
					</time>
				</div>

				{/* Title Row with Inline Chevron */}
				<h2 className='text-xl md:text-2xl font-serif font-bold text-foreground group-hover:text-primary transition-colors leading-tight'>
					{/* align-middle ensures text aligns with icon */}
					<span className='align-middle'>{session.title}</span>

					{!hasActiveSearch && (
						<span
							onClick={!hasActiveSearch ? onToggle : undefined}
							className={clsx(
								'inline-flex items-center justify-center align-middle ml-2 p-1 rounded-full text-muted-foreground/50 group-hover:bg-muted group-hover:text-foreground transition-all',
								isExpanded ? 'rotate-0' : '-rotate-90'
							)}>
							<ChevronDown size={20} />
						</span>
					)}
				</h2>

				{session.synopsis && (
					<div className='text-muted-foreground prose prose-sm prose-p:my-1 max-w-none text-pretty'>
						<SmartMarkdown>{session.synopsis}</SmartMarkdown>
					</div>
				)}
			</div>

			{/* Events List */}
			{isExpanded && (
				<div className='space-y-6 relative min-h-[50px] animate-in fade-in slide-in-from-top-2 duration-300'>
					{isVisible ? (
						eventList
					) : (
						<div
							style={{ height: placeholderHeight }}
							className='w-full rounded-lg border border-dashed border-border/50 bg-muted/20 flex items-center justify-center'>
							<span className='text-xs text-muted-foreground/50'>Loading {session.events.length} events...</span>
						</div>
					)}
				</div>
			)}
		</div>
	);
});

TimelineSession.displayName = 'TimelineSession';

--- END OF features\timeline\components\TimelineSession.jsx ---

--- FILE: features\timeline\utils\eventStyles.js ---
import { getEntityStyles } from '@/domain/entity/config/entityStyles';
import {
	Sword,
	Skull,
	MessageSquare,
	Scroll,
	CheckCircle2,
	Footprints,
	Map,
	MapPin,
	User,
	Flag,
	Search,
	BookOpen,
	Sparkles,
	Eye,
	ShoppingBag,
	Star,
	Tent,
} from 'lucide-react';

export const getEventStyle = (eventType) => {
	const type = eventType?.toLowerCase() || '';

	let entityType = 'default';
	let Icon = Star;

	switch (type) {
		case 'combat':
			entityType = 'encounter'; // Orange
			Icon = Skull;
			break;
		case 'social':
			entityType = 'npc'; // Amber
			Icon = MessageSquare;
			break;
		case 'quest_started':
			entityType = 'quest'; // Blue
			Icon = Scroll;
			break;
		case 'quest_progressed':
			entityType = 'quest'; // Blue
			Icon = CheckCircle2;
			break;
		case 'travel':
			entityType = 'location'; // Emerald
			Icon = Footprints; // Journeys
			break;
		case 'location_discovered':
			entityType = 'location'; // Emerald
			Icon = Map; // Finding new places
			break;
		case 'location_visited':
			entityType = 'location'; // Emerald
			Icon = MapPin; // Arriving at known places
			break;
		case 'npc_encountered':
			entityType = 'npc'; // Amber
			Icon = User;
			break;
		case 'faction_discovered':
			entityType = 'faction'; // Purple
			Icon = Flag;
			break;
		case 'investigation':
			entityType = 'default'; // Gray (Neutral/Mechanics)
			Icon = Search;
			break;
		case 'backstory':
			entityType = 'character'; // Red (Personal)
			Icon = BookOpen;
			break;
		case 'discovery':
			entityType = 'encounter'; // Orange (Loot/Items/Secrets)
			Icon = Sparkles;
			break;
		case 'vision':
			entityType = 'faction'; // Purple (Magic/Mystical)
			Icon = Eye;
			break;
		case 'shopping':
			entityType = 'npc'; // Amber (Trade/Commerce)
			Icon = ShoppingBag;
			break;
		case 'special_event':
			entityType = 'session'; // Slate (Meta/Unique)
			Icon = Star;
			break;
		// Fallbacks for legacy types or fuzzy matches
		default:
			if (type.match(/combat|fight|kill/)) {
				entityType = 'encounter';
				Icon = Sword;
			} else if (type.match(/npc|social|meet/)) {
				entityType = 'npc';
				Icon = MessageSquare;
			} else if (type.match(/location|visit|arrive/)) {
				entityType = 'location';
				Icon = MapPin;
			} else if (type.match(/quest|mission/)) {
				entityType = 'quest';
				Icon = Scroll;
			} else if (type.match(/camp|rest/)) {
				entityType = 'location';
				Icon = Tent;
			} else {
				entityType = 'default';
				Icon = Star;
			}
	}

	// Use centralized styles
	const styles = getEntityStyles(entityType);

	return {
		Icon,
		// Map standard styles to timeline specific class structure
		container: `${styles.border} ${styles.bg} ${styles.text}`,
		// Heuristic for line color (usually 200 or 300 shade) based on bg class
		// line: styles.bg.replace('-50', '-200'),
	};
};

--- END OF features\timeline\utils\eventStyles.js ---

--- FILE: features\wiki\useEntityView.js ---
import { useMemo } from 'react';
import { parseAttributes } from '@/shared/utils/imageUtils';
import { transformAttributes } from '@/features/wiki/utils/attributeMapper';
import { useEntityHeader } from './hooks/useEntityHeader';
import { useEntityContent } from './hooks/useEntityContent';
import { useEntitySidebar } from './hooks/useEntitySidebar';

export function useEntityViewModel(entity) {
	const attributes = useMemo(() => {
		return parseAttributes(entity?.attributes);
	}, [entity]);

	const { traits, sections } = useMemo(() => {
		if (!entity) return { traits: [], sections: [] };
		return transformAttributes(attributes, entity.description);
	}, [entity, attributes]);

	const header = useEntityHeader(entity, attributes);
	const sidebar = useEntitySidebar(entity, traits);
	const content = useEntityContent(entity, attributes, sections);

	const layoutMode = useMemo(() => {
		if (entity?.type === 'session') return 'tabs';
		if (entity?.type === 'character') return 'character';
		return 'standard';
	}, [entity]);

	return useMemo(() => {
		if (!entity) return null;

		return {
			layoutMode,
			header,
			sidebar,
			content,
			raw: { ...entity, attributes },
		};
	}, [entity, layoutMode, header, sidebar, content, attributes]);
}

--- END OF features\wiki\useEntityView.js ---

--- FILE: features\wiki\useWikiNavigation.js ---
import { useState } from 'react';
import { useParams } from 'react-router-dom';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { useEntityFetching } from './hooks/useEntityFetching';
import { useEntityGrouping } from './hooks/useEntityGrouping';

export function useWikiNavigation() {
	const { type } = useParams();
	const [search, setSearch] = useState('');

	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Fetch entities AND context (Arcs, Relationships)
	// FIX: Destructure 'context' here
	const { entities, context, isLoading } = useEntityFetching(normalizedType);

	// 2. Group and filter entities
	// FIX: Pass 'context' to the grouping hook so it can map Session -> Arc
	const groups = useEntityGrouping(entities, normalizedType, search, context);

	// 3. Build UI config
	const entityConfig = getEntityConfig(normalizedType);

	// Guard clause in case config isn't found (e.g. invalid URL)
	if (!entityConfig) {
		return { isLoading: true, groups: [], config: { label: 'Loading...', textClass: '' } };
	}

	const config = {
		label: `${entityConfig.label}s`,
		Icon: entityConfig.icon,
		textClass: entityConfig.tailwind.text,
	};

	return {
		config,
		isLoading,
		hasItems: groups.length > 0 && groups.some((g) => g.items.length > 0),
		groups,
		search,
		setSearch,
	};
}

--- END OF features\wiki\useWikiNavigation.js ---

--- FILE: features\wiki\WikiLayout.jsx ---
import { Outlet } from 'react-router-dom';
import { useWikiNavigation } from './useWikiNavigation';
import { WikiSidebar } from '@/features/wiki/components/navigation/WikiSidebar';

export default function WikiLayout() {
	const navigation = useWikiNavigation();

	return (
		<div className='relative flex flex-col lg:flex-row h-full bg-background overflow-hidden'>
			{/* Sidebar - First in DOM for Mobile Top position, Ordered 2nd for Desktop Right position */}
			<WikiSidebar navigation={navigation} className='lg:order-2 lg:border-l lg:border-border lg:h-full z-30' />

			{/* Main Content */}
			<div className='flex-1 lg:order-1 overflow-y-auto bg-background relative z-0 custom-scrollbar'>
				<Outlet />
			</div>
		</div>
	);
}

--- END OF features\wiki\WikiLayout.jsx ---

--- FILE: features\wiki\api\wikiService.js ---
// features/wiki/api/wikiService.js
import { supabase } from '@/shared/api/supabaseClient';

export const getWikiEntry = async (id, type) => {
	// STRATEGY: Session
	// Uses view_campaign_timeline to get the session + aggregated events + relationship tags
	if (type === 'session') {
		const { data: timelineData, error } = await supabase
			.from('view_campaign_timeline')
			.select('*')
			.eq('session_id', id)
			.single();

		if (error) throw error;

		// Fetch direct (non-event) relationships for the "Mentions" tab
		const { data: directRels } = await supabase
			.from('entity_relationships')
			.select(`target:entities!to_entity_id ( id, name, type ), relationship_type`)
			.eq('from_entity_id', id);

		const sessionRelationships = (directRels || []).map((rel) => ({
			entity_id: rel.target.id,
			entity_name: rel.target.name,
			entity_type: rel.target.type,
			type: rel.relationship_type,
		}));

		// Transform Tags (from View) into EventRelMap format for the Mapper
		const eventRelMap = new Map();
		(timelineData.events || []).forEach((event) => {
			if (event.tags && event.tags.length > 0) {
				eventRelMap.set(
					event.id,
					event.tags.map((tag) => ({
						entity_id: tag.entity_id,
						entity_name: tag.name,
						entity_type: tag.type,
						type: 'mention',
					}))
				);
			}
		});

		return {
			data: {
				id: timelineData.session_id,
				title: timelineData.session_title,
				narrative: timelineData.session_narrative,
				events: timelineData.events,
				attributes: {
					...timelineData.attributes,
					session_number: timelineData.session_number,
					session_date: timelineData.session_date,
				},
			},
			type: 'session',
			additional: { eventRelMap, sessionRelationships },
		};
	}

	// STRATEGY: Standard Entity (Core Data)
	// Uses the optimized entity_complete_view (JSONB source)
	const { data, error } = await supabase.from('entity_complete_view').select('*').eq('id', id).single();

	if (error) throw error;

	const additional = {};

	// STRATEGY: Quest Objectives
	// Single query with nested session attributes
	if (type === 'quest') {
		const { data: objectives } = await supabase
			.from('quest_objectives')
			.select(
				`
                *,
                session:sessions ( id, title, attributes )
            `
			)
			.eq('quest_id', id)
			.order('order_index', { ascending: true });

		additional.objectives = objectives || [];
	}

	// STRATEGY: Encounter Actions
	// Uses the hydrated view to avoid N+1 attribute lookups
	if (type === 'encounter') {
		const { data: actions } = await supabase
			.from('view_encounter_actions_hydrated')
			.select('*')
			.eq('encounter_id', id)
			.order('round_number', { ascending: true })
			.order('action_order', { ascending: true });

		additional.encounterActions = actions || [];
	}

	// STRATEGY: Event Session Resolution
	// (Only needed if the entity has historical events)
	// We optimize this by fetching only the needed session attributes
	if (data.events && Object.keys(data.events).length > 0) {
		const flatEvents = Object.values(data.events).flat();
		const sessionIds = [...new Set(flatEvents.map((e) => e.session_id).filter(Boolean))];

		if (sessionIds.length > 0) {
			const { data: sessions } = await supabase.from('sessions').select('id, attributes').in('id', sessionIds);

			const sessionMap = new Map();
			(sessions || []).forEach((s) => {
				// Access JSONB column directly
				const num = s.attributes?.session_number || s.attributes?.session;
				sessionMap.set(s.id, num ? Number(num) : null);
			});
			additional.sessionMap = sessionMap;
		}
	}

	return { data, type, additional };
};

--- END OF features\wiki\api\wikiService.js ---

--- FILE: features\wiki\components\EncounterTimeline.jsx ---
import React from 'react';
import {
	Swords,
	Shield,
	Zap,
	Skull,
	Footprints,
	MessageSquare,
	Hand,
	Dices,
	Target,
	Activity,
	ArrowRight,
	CornerDownRight,
} from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityLink from '@/domain/entity/components/EntityLink';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { useTheme } from '@/shared/hooks/useTheme'; // FIX: Import theme hook

// ... (getActionIcon helper remains the same) ...
const getActionIcon = (type) => {
	switch (type?.toLowerCase()) {
		case 'attack':
			return Swords;
		case 'spell':
			return Zap;
		case 'move':
			return Footprints;
		case 'check':
			return Dices;
		case 'save':
			return Shield;
		case 'item':
			return Hand;
		case 'legendary':
			return Skull;
		case 'social':
			return MessageSquare;
		default:
			return Activity;
	}
};

const CombatLogEntry = ({ action }) => {
	const { isFriendly, actor, target, description, result, effect, type } = action;
	const ActionIcon = getActionIcon(type);
	const { theme } = useTheme(); // FIX: Use app theme state

	// FIX: Logic based on explicit App Theme, ignoring System Preference
	const isDark = theme === 'dark';

	// Background:
	// - Friendly: None
	// - Hostile:
	//    - Dark: Red-900 at 10% (Visible on black)
	//    - Light/DND: Red-500 at 5% (Subtle on parchment/white)
	const rowBg = isFriendly ? '' : isDark ? 'bg-red-900/5' : 'bg-red-500/2';

	// Text Colors:
	// - Dark: Lighter shades (400)
	// - Light/DND: Darker shades (700)
	const manualActorColor = isFriendly
		? isDark
			? 'text-emerald-400'
			: 'text-emerald-700'
		: isDark
		? 'text-red-400'
		: 'text-red-700';

	const effectIconColor = isDark ? 'text-amber-500' : 'text-amber-600';

	return (
		<div
			className={clsx(
				'flex items-start gap-2.5 p-2.5 border-b border-border last:border-0 text-sm transition-colors group',
				'hover:bg-muted/50',
				rowBg
			)}>
			{/* 1. Large Sidebar Icon */}
			<div className='shrink-0 mt-0.5'>
				<EntityIcon type={actor.type} customIconUrl={actor.iconUrl} size={28} className='rounded opacity-90' />
			</div>

			{/* 2. Content */}
			<div className='flex-1 min-w-0'>
				{/* Header Line */}
				<div className='flex flex-wrap items-center gap-1 mb-1 leading-snug'>
					{/* Actor Name */}
					{actor.id ? (
						<EntityLink
							id={actor.id}
							type={actor.type}
							inline={true}
							showIcon={true}
							customIconUrl={actor.iconUrl}
							className='font-serif font-bold text-sm !no-underline hover:underline'>
							{actor.name}
						</EntityLink>
					) : (
						// Manual Entry
						<span
							className={clsx(
								'font-serif font-bold text-sm flex items-center gap-1.5 cursor-default',
								manualActorColor
							)}>
							<EntityIcon type={actor.type} size={14} inline />
							{actor.name}
						</span>
					)}

					{/* Action Badge */}
					<span className='text-[10px] uppercase font-bold text-muted-foreground/70 tracking-wider flex border border-border items-center gap-1 rounded-sm px-1.5 bg-background/50'>
						<ActionIcon size={10} />
						{type}
					</span>

					{/* Target */}
					{target && (
						<div className='flex items-center gap-1.5 text-muted-foreground'>
							<ArrowRight size={10} className='opacity-50' />

							{target.id ? (
								<EntityLink
									id={target.id}
									type={target.type}
									inline={true}
									showIcon={true}
									customIconUrl={target.iconUrl}
									className='font-serif font-semibold text-sm !no-underline hover:underline'>
									{target.name}
								</EntityLink>
							) : (
								<span className='font-serif font-semibold text-foreground text-sm flex items-center gap-1.5 cursor-default'>
									<EntityIcon type={target.type} size={14} inline />
									{target.name}
								</span>
							)}
						</div>
					)}

					{/* Result Badge */}
					{result && (
						<span className='ml-auto text-[10px] font-bold text-foreground/80 bg-background/80 px-1.5 py-0.5 rounded border border-border whitespace-nowrap'>
							{result}
						</span>
					)}
				</div>

				{/* Description */}
				{description && (
					<div className='text-xs text-muted-foreground leading-relaxed pl-0.5'>
						<SmartMarkdown components={{ p: 'span' }}>{description}</SmartMarkdown>
					</div>
				)}

				{/* Effect */}
				{effect && (
					<div className='mt-1 flex items-center gap-1.5 text-xs font-medium text-muted-foreground w-fit px-1.5 py-0.5 rounded -ml-1'>
						<CornerDownRight size={10} className={effectIconColor} />
						<span className='italic opacity-90'>
							<SmartMarkdown components={{ p: 'span' }}>{effect}</SmartMarkdown>
						</span>
					</div>
				)}
			</div>
		</div>
	);
};

export const EncounterTimeline = ({ rounds }) => {
	if (!rounds || Object.keys(rounds).length === 0) return null;

	return (
		<div className='my-6'>
			<h3 className='text-sm font-bold text-muted-foreground uppercase tracking-widest mb-3 flex items-center gap-2'>
				<Swords size={14} className='text-primary' /> Combat Log
			</h3>

			<div className='border border-border rounded-lg overflow-hidden bg-background'>
				{Object.entries(rounds).map(([roundNum, actions]) => (
					<div key={roundNum}>
						{/* Round Header */}
						<div className='bg-muted/80 border-b border-border px-3 py-1.5 flex items-center justify-between'>
							<span className='text-xs font-serif font-bold text-foreground'>Round {roundNum}</span>
							<span className='text-[9px] font-bold uppercase text-muted-foreground tracking-wider'>
								{actions.length} Turns
							</span>
						</div>

						{/* Actions Group */}
						<div
							className={clsx(
								'bg-background',
								Number(roundNum) !== Object.keys(rounds).length && 'border-b border-border'
							)}>
							{actions.map((action) => (
								<CombatLogEntry key={action.id} action={action} />
							))}
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EncounterTimeline.jsx ---

--- FILE: features\wiki\components\EntityBody.jsx ---
import { History, Diamond } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { EntityHistory } from './EntityHistory';
import { QuestObjectives } from './QuestObjectives';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';
import { EncounterTimeline } from './EncounterTimeline';
import { EntityMiniMap } from '@/features/wiki/components/EntityMiniMap';

// Re-exporting History for use in tabs if needed by parent
export { EntityHistory } from './EntityHistory';

const LevelUpBanner = ({ level }) => {
	const logoPath = `${import.meta.env.BASE_URL}logo_detailed.png`;

	return (
		<div className='mt-4 mb-6 w-full'>
			{/* Full Width, Fixed Height (~64px) Banner */}
			<div className='flex items-center h-16 bg-muted/60 border-y border-r border-border border-l-2 border-l-primary rounded-lg shadow-sm w-full overflow-hidden'>
				{/* Logo Section - Vertical Center */}
				<div className='shrink-0 h-full flex items-center px-5 bg-amber-500/10/50 border-r border-border/40'>
					<img src={logoPath} alt='Campaign Logo' className='h-12 w-auto object-contain opacity-80 drop-shadow-sm' />
				</div>

				{/* Text Content */}
				<div className='flex-1 flex flex-col justify-center px-4'>
					<h3 className='text-xs font-serif font-bold text-primary uppercase tracking-[0.15em] leading-none m-0! p-0!'>
						Level Up
					</h3>
					<p className='font-serif text-sm text-card-foreground leading-none p-0! m-0!'>
						The party has reached <span className='font-bold text-foreground'>Level {level}</span>.
					</p>
				</div>
			</div>
		</div>
	);
};

export const EntityBody = ({
	summary,
	sections,
	history,
	objectives,
	combatRounds,
	levelUp,
	mapImageUrl,
	mapMarkers,
}) => {
	return (
		<div className='prose max-w-none prose-headings:font-serif prose-headings:font-bold prose-headings:text-foreground prose-p:text-[11pt] prose-p:leading-relaxed prose-p:my-2 prose-strong:text-foreground prose-strong:font-bold prose-li:marker:text-amber-600 prose-li:text-sm prose-li:my-0.5 prose-p:text-justify'>
			{summary && (
				<div className='mb-4 text-muted-foreground'>
					<SmartMarkdown>{summary}</SmartMarkdown>
				</div>
			)}
			{/* Quest Objectives */}
			{objectives && objectives.length > 0 && (
				<>
					<SectionDivider />
					<QuestObjectives objectives={objectives} />
				</>
			)}
			{mapImageUrl && mapImageUrl.length > 0 && (
				<>
					<SectionDivider />
					<EntityMiniMap imageUrl={mapImageUrl} markers={mapMarkers} />
				</>
			)}

			{/* Combat Timeline */}
			{combatRounds && Object.keys(combatRounds).length > 0 && (
				<>
					<SectionDivider />
					<EncounterTimeline rounds={combatRounds} />
				</>
			)}
			{/* Narrative Sections */}
			{sections.map((prop) => {
				if (prop.displayType === 'list' && Array.isArray(prop.value)) {
					return (
						<div key={prop.key}>
							<SectionDivider />
							<h3 className='capitalize text-lg mt-0 font-serif text-amber-900 dark:text-foreground mb-2 font-bold'>
								{prop.key}
							</h3>
							<ul className='grid grid-cols-1 gap-1.5 pl-1 list-none my-0'>
								{prop.value.map((item, idx) => (
									<li key={idx} className='flex items-start gap-3 m-0 p-0 text-foreground group'>
										<div className='mt-[0.45rem] shrink-0 text-accent/60 group-hover:text-accent transition-colors'>
											<Diamond size={8} fill='currentColor' />
										</div>
										<span className='text-[11pt] leading-snug'>
											<SmartMarkdown components={{ p: 'span' }}>{item}</SmartMarkdown>
										</span>
									</li>
								))}
							</ul>
						</div>
					);
				}
				return (
					<div key={prop.key}>
						<SectionDivider />
						<h3 className='capitalize text-lg font-serif text-amber-900 dark:text-foreground mb-1 mt-0 inline-block pb-0.5'>
							{prop.key}
						</h3>
						<div className='mt-0.5'>
							<SmartMarkdown>{prop.value}</SmartMarkdown>
						</div>
					</div>
				);
			})}
			{history && history.length > 0 && (
				<div className='mt-2'>
					<SectionDivider />
					<h3 className='font-serif text-lg mt-0 font-bold text-foreground mb-3 flex items-center gap-2'>
						<History size={16} className='text-amber-900/70 dark:text-muted-foreground' /> Events
					</h3>
					<EntityHistory events={history} fullHeight />
				</div>
			)}
			{/* Level Up Banner */}
			{levelUp && <LevelUpBanner level={levelUp} />}
		</div>
	);
};

--- END OF features\wiki\components\EntityBody.jsx ---

--- FILE: features\wiki\components\EntityHeader.jsx ---
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Link, useParams } from 'react-router-dom';
import { Edit3, X, Maximize2 } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import { getPriorityStyles } from '@/domain/entity/config/entityStyles';

const ImageLightbox = ({ src, alt, onClose }) => {
	useEffect(() => {
		document.body.style.overflow = 'hidden';
		const handleEsc = (e) => {
			if (e.key === 'Escape') onClose();
		};
		window.addEventListener('keydown', handleEsc);
		return () => {
			document.body.style.overflow = 'unset';
			window.removeEventListener('keydown', handleEsc);
		};
	}, [onClose]);

	return createPortal(
		<div
			className='fixed inset-0 z-[9999] flex items-center justify-center p-8 bg-background/30 backdrop-blur-md animate-in fade-in duration-200'
			onClick={onClose}>
			<div
				className='relative inline-block shadow-2xl rounded-lg overflow-hidden bg-black/5 ring-1 ring-black/10'
				onClick={(e) => e.stopPropagation()}>
				<img src={src} alt={alt} className='max-w-[85vw] max-h-[85vh] object-contain block select-none' />
				<button
					onClick={onClose}
					className='absolute top-3 right-3 p-1.5 bg-black/50 hover:bg-black/70 text-white/90 hover:text-white rounded-full transition-all duration-200 backdrop-blur-sm shadow-sm'>
					<X size={18} strokeWidth={2.5} />
				</button>
			</div>
		</div>,
		document.body
	);
};

export const EntityHeader = ({ data }) => {
	const { title, subtitle, typeLabel, imageUrl, avatarUrl, status, priority, extraTags, type } = data;
	const { entityId } = useParams();
	const [isLightboxOpen, setIsLightboxOpen] = useState(false);
	const isDev = import.meta.env.DEV;

	const noImageStyle = !imageUrl
		? {
				background: `radial-gradient(80% 100% at 50% -20%, var(--muted) 0%, var(--background) 100%)`,
		  }
		: {};

	return (
		<>
			<div
				className={clsx(
					'h-48 md:h-64 relative group overflow-hidden select-none',
					imageUrl ? 'cursor-pointer' : 'border-b border-border/40'
				)}
				style={noImageStyle}
				onClick={() => imageUrl && setIsLightboxOpen(true)}>
				{imageUrl && (
					<>
						<img
							src={imageUrl}
							alt={title}
							className={clsx(
								'absolute inset-0 w-full h-full object-cover transition-all duration-[2000ms] ease-in-out',
								'object-[center_30%] group-hover:object-[center_50%] group-hover:scale-105'
							)}
						/>
						<div className='absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10'>
							<div className='bg-black/30 backdrop-blur-md p-2 rounded-full text-white/80 border border-white/10 shadow-lg'>
								<Maximize2 size={16} />
							</div>
						</div>
						<div className='absolute inset-0 bg-gradient-to-t from-[var(--background)] from-0% via-[var(--background)]/80 via-10% via-[var(--background)]/20 via-20% to-transparent pointer-events-none' />
					</>
				)}

				{isDev && entityId && (
					<div
						className='absolute top-4 right-4 z-30 animate-in fade-in slide-in-from-right-2 duration-500'
						onClick={(e) => e.stopPropagation()}>
						<Link
							to={`/dm/manage/${typeLabel.toLowerCase()}/${entityId}`}
							className='flex items-center gap-2 px-3 py-1.5 bg-background/80 backdrop-blur-md border border-border rounded-full shadow-lg text-muted-foreground hover:text-primary hover:border-primary transition-all group/edit'>
							<Edit3 size={14} className='group-hover/edit:scale-110 transition-transform' />
							<span className='text-[10px] font-bold uppercase tracking-tight'>Quick Edit</span>
						</Link>
					</div>
				)}

				<div
					className={clsx(
						'absolute bottom-0 left-0 w-full pointer-events-none',
						type === 'character' ? 'p-4 md:p-6 md:pb-0!' : 'p-4 md:p-6 '
					)}>
					<div className='max-w-6xl mx-auto flex items-end gap-5'>
						<div className='hidden md:flex md:items-end pointer-events-auto mb-1'>
							<EntityIcon
								type={typeLabel.toLowerCase()}
								customIconUrl={avatarUrl}
								size={64}
								showBackground
								className='w-[84px] h-[84px] shadow-xl border-2 border-background/50 object-cover bg-background'
							/>
						</div>

						<div className='flex-1 pb-1 min-w-0'>
							<div className='flex items-center flex-wrap gap-2 mb-2'>
								<EntityBadge
									type={typeLabel.toLowerCase()}
									size='sm'
									variant='solid'
									className='bg-background/80 backdrop-blur-sm border-border/50 text-foreground shadow-sm'
								/>
								{status.hasStatus && (
									<span
										className={clsx(
											'px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm backdrop-blur-sm',
											status.isDead ? 'badge-dead' : 'badge-alive'
										)}>
										{status.label}
									</span>
								)}
								{priority && (
									<span
										className={clsx(
											'px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm backdrop-blur-sm',
											getPriorityStyles(priority)
										)}>
										{priority} Priority
									</span>
								)}
								{extraTags &&
									extraTags.map((tag, i) => (
										<span
											key={i}
											className='px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm bg-card/80 backdrop-blur-sm border-slate-300 text-slate-700 dark:text-slate-300 dark:border-slate-700'>
											{tag}
										</span>
									))}
							</div>

							<h1 className='text-3xl md:text-5xl font-serif font-bold text-foreground leading-none drop-shadow-sm tracking-tight break-words'>
								{title}
							</h1>

							{/* --- NEW: Subtitle (Race/Class/Level) --- */}
							{subtitle && (
								<div className='text-sm font-semibold text-muted-foreground opacity-90 drop-shadow-md'>{subtitle}</div>
							)}
						</div>
					</div>
				</div>
			</div>
			{isLightboxOpen && imageUrl && (
				<ImageLightbox src={imageUrl} alt={title} onClose={() => setIsLightboxOpen(false)} />
			)}
		</>
	);
};

--- END OF features\wiki\components\EntityHeader.jsx ---

--- FILE: features\wiki\components\EntityHistory.jsx ---
import { Calendar } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const EntityHistory = ({ events, showSession = true, fullHeight = true }) => {
	if (!events || events.length === 0) return null;

	return (
		// 1. Container Logic
		// If fullHeight is true, we allow the div to expand naturally.
		// If false, we clamp it to 600px with a scrollbar.
		<div className={clsx(!fullHeight && 'max-h-[600px] overflow-y-auto custom-scrollbar pr-2')}>
			{/* 2. Timeline Container */}
			{/* ml-5 pushes the border line right, creating a safe gutter for the dots (-left-[19px]) 
                so they don't get clipped by overflow:hidden or scroll containers */}
			<div className='border-l-2 border-border ml-2 pl-3 space-y-6 relative my-2'>
				{events.map((evt, idx) => (
					<div key={evt.id || idx} className='relative group'>
						{/* Timeline Dot */}
						<div
							className={clsx(
								'absolute -left-[19px] top-1.5 w-3 h-3 rounded-full border border-background',
								'bg-stone-300 ring-1 ring-border',
								'group-hover:bg-accent group-hover:ring-accent/40 transition-colors shadow-sm'
							)}
						/>

						{/* Title Row with Session Badge */}
						<div className='flex items-center gap-2 mb-1 flex-wrap'>
							<h4 className='font-bold text-foreground text-sm mt-0.5'>{evt.title}</h4>
							{showSession && evt.session_number != null && (
								<span className='inline-flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ml-auto max-w-[45%] truncate bg-muted text-muted-foreground border-border/60'>
									<Calendar size={9} />
									Session {evt.session_number}
								</span>
							)}
						</div>

						{/* Description */}
						<div className='text-sm text-muted-foreground leading-relaxed text-justify'>
							<SmartMarkdown>{evt.description}</SmartMarkdown>
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityHistory.jsx ---

--- FILE: features\wiki\components\EntityLocalGraph.jsx ---
import React, { useMemo, useCallback, useState, useRef, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Network, Maximize, Minimize } from 'lucide-react';
import { clsx } from 'clsx';
import { CytoscapeCanvas } from '@/features/graph/components/CytoscapeCanvas';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { useTheme } from '@/shared/hooks/useTheme';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';

// --- LOCAL GRAPH CONFIGURATION ---
const LOCAL_LAYOUT = {
	name: 'fcose',
	quality: 'default',
	randomize: true,
	animate: true,
	animationDuration: 800,
	fit: true,
	padding: 30,
	nodeDimensionsIncludeLabels: true,
	nodeRepulsion: 8000,
	idealEdgeLength: 80,
	edgeElasticity: 0.45,
	gravity: 0.3,
	numIter: 2500,
	tilingPaddingVertical: 10,
	tilingPaddingHorizontal: 10,
	initialEnergyOnIncremental: 0.3,
};

const getLocalStyles = (isDark) => {
	const colors = {
		text: isDark ? '#e5e5e5' : '#171717',
		border: isDark ? '#404040' : '#d4d4d4',
		halo: isDark ? '#000000' : '#ffffff',
		edge: isDark ? '#525252' : '#a3a3a3',
	};

	return [
		{
			selector: 'node',
			style: {
				width: 16,
				height: 16,
				label: 'data(label)',
				'background-image': 'data(image)',
				'background-fit': 'cover',
				'border-width': 1,
				'border-color': 'data(borderColor)',
				'background-color': 'data(bgColor)',
				'font-family': 'Inter, sans-serif',
				'font-size': '8px',
				'font-weight': '600',
				'text-valign': 'bottom',
				'text-margin-y': 4,
				'text-outline-color': colors.halo,
				'text-outline-width': 2,
				color: colors.text,
				'transition-property': 'width, height, border-width',
				'transition-duration': '0.2s',
			},
		},
		{
			selector: 'node[?isCenter]',
			style: {
				width: 28,
				height: 28,
				'border-width': 2,
				'font-size': '10px',
				'z-index': 10,
			},
		},
		{
			selector: 'edge[type != "virtual"]',
			style: {
				width: 1,
				'curve-style': 'bezier',
				'line-color': colors.edge,
				'target-arrow-shape': 'none',
				opacity: 0.5,
			},
		},
		{
			selector: 'edge[type = "virtual"]',
			style: {
				width: 0,
				opacity: 0,
				'curve-style': 'straight',
				events: 'no',
			},
		},
	];
};

export const EntityLocalGraph = ({ entity, relationships, className, height = 'h-64', headerShown = true }) => {
	const navigate = useNavigate();
	const { theme } = useTheme();
	const { map: entityIndex } = useEntityIndex();
	const isDark = theme === 'dark';

	// FULLSCREEN STATE
	const containerRef = useRef(null);
	const [isFullscreen, setIsFullscreen] = useState(false);
	const [isPseudoFullscreen, setIsPseudoFullscreen] = useState(false);

	// Combine native and pseudo states
	const activeFullscreen = isFullscreen || isPseudoFullscreen;

	// Handle Native Fullscreen Changes
	useEffect(() => {
		const handler = () => setIsFullscreen(!!document.fullscreenElement);
		document.addEventListener('fullscreenchange', handler);
		return () => document.removeEventListener('fullscreenchange', handler);
	}, []);

	// Handle Escape Key for Pseudo Fullscreen
	useEffect(() => {
		const handleEsc = (e) => {
			if (e.key === 'Escape' && isPseudoFullscreen) setIsPseudoFullscreen(false);
		};
		window.addEventListener('keydown', handleEsc);
		return () => window.removeEventListener('keydown', handleEsc);
	}, [isPseudoFullscreen]);

	// Toggle Function
	const toggleFullscreen = useCallback(
		(e) => {
			e.stopPropagation();
			if (!containerRef.current) return;

			const supportsNative = document.fullscreenEnabled || containerRef.current.requestFullscreen;

			// Prefer native, fallback to pseudo (iOS)
			if (supportsNative) {
				if (!document.fullscreenElement) {
					containerRef.current.requestFullscreen().catch(() => setIsPseudoFullscreen(true));
				} else {
					document.exitFullscreen();
				}
			} else {
				setIsPseudoFullscreen(!isPseudoFullscreen);
			}
		},
		[isPseudoFullscreen]
	);

	// --- DATA TRANSFORMATION ---
	const elements = useMemo(() => {
		if (!entity) return [];
		const nodes = [];
		const edges = [];
		const addedIds = new Set();
		const typeGroups = {};
		const FALLBACK_ICON_ROOT = 'images/icons';

		const resolveNodeIcon = (type, attributes, id) => {
			let url = resolveImageUrl(attributes, 'icon');
			if (!url && id && entityIndex.has(id)) {
				const cached = entityIndex.get(id);
				if (cached.iconUrl) url = cached.iconUrl;
			}
			if (!url) {
				const safeType = (type || 'default').toLowerCase().replace(/\s+/g, '_');
				url = `${FALLBACK_ICON_ROOT}/${safeType}.webp`;
			}
			return url;
		};

		const addNode = (id, name, type, attributes = {}, isCenter = false) => {
			if (!id || addedIds.has(id)) return;
			addedIds.add(id);

			if (!isCenter) {
				if (!typeGroups[type]) typeGroups[type] = [];
				typeGroups[type].push(id);
			}

			const config = getEntityConfig(type);
			const finalImage = resolveNodeIcon(type, attributes, id);

			// Apply Colors
			const borderColor = config.color || (isDark ? '#404040' : '#d4d4d4');
			const nodeBgColor = config.color || (isDark ? '#262626' : '#f5f5f5');

			nodes.push({
				data: {
					id,
					label: name,
					image: finalImage,
					type,
					bgColor: nodeBgColor,
					borderColor,
					isCenter,
				},
				classes: isCenter ? 'center' : '',
			});
		};

		addNode(entity.id, entity.name, entity.type, entity.attributes, true);

		if (relationships) {
			relationships.forEach((rel) => {
				const targetId = rel.id || rel.entity_id || rel.target;
				const targetName = rel.name || rel.entity_name;
				const targetType = rel.typeLabel || rel.entity_type || rel.type || 'default';

				if (targetId) {
					addNode(targetId, targetName, targetType, {});
					edges.push({
						data: {
							source: entity.id,
							target: targetId,
							type: 'standard',
						},
					});
				}
			});
		}

		Object.keys(typeGroups).forEach((type) => {
			const groupIds = typeGroups[type];
			if (groupIds.length > 1 && groupIds.length < 15) {
				for (let i = 0; i < groupIds.length; i++) {
					edges.push({
						data: { source: groupIds[i], target: groupIds[(i + 1) % groupIds.length], type: 'virtual' },
					});
				}
			}
		});

		return [...nodes, ...edges];
	}, [entity, relationships, isDark, entityIndex]);

	const handleNodeClick = useCallback(
		(data) => {
			if (activeFullscreen && document.fullscreenElement) {
				document.exitFullscreen();
			}
			if (isPseudoFullscreen) setIsPseudoFullscreen(false);

			if (data.id && data.type && data.id !== entity.id) {
				navigate(`/wiki/${data.type}/${data.id}`);
			}
		},
		[navigate, entity.id, activeFullscreen, isPseudoFullscreen]
	);

	if (elements.length <= 1) return null;

	return (
		<div className={clsx('w-full flex flex-col', className)}>
			{!activeFullscreen && headerShown && (
				<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-2 px-1'>
					<Network size={10} /> Local Graph
				</h3>
			)}

			<div
				ref={containerRef}
				className={clsx(
					'w-full relative bg-muted/20 border border-border rounded-lg overflow-hidden group transition-all duration-300',
					// Fullscreen Styles
					activeFullscreen ? 'fixed inset-0 z-[9999] h-screen w-screen m-0 rounded-none bg-background' : height
				)}>
				{/* Graph Background */}
				<div
					className='absolute inset-0 z-0 opacity-50'
					style={{
						backgroundImage: 'radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
						backgroundSize: '20px 20px',
						backgroundPosition: '10px 10px',
					}}
				/>

				{/* Fullscreen Toggle Button */}
				<button
					onClick={toggleFullscreen}
					className={clsx(
						'absolute z-50 p-2 rounded-full border border-border shadow-sm transition-all active:scale-95',
						'bg-background/90 backdrop-blur text-muted-foreground hover:text-primary hover:bg-background',
						// Positioning Logic
						activeFullscreen
							? 'top-1/2 right-4 -translate-y-1/2 lg:top-6 lg:right-6 lg:translate-y-0' // Middle-Right Mobile, Top-Right Desktop
							: 'top-2 right-2' // Normal State
					)}
					title={activeFullscreen ? 'Exit Fullscreen' : 'Fullscreen'}>
					{activeFullscreen ? <Minimize size={18} /> : <Maximize size={16} />}
				</button>

				<CytoscapeCanvas
					elements={elements}
					layoutConfig={LOCAL_LAYOUT}
					stylesheet={getLocalStyles(isDark)}
					onNodeClick={handleNodeClick}
					interactive={true}
				/>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityLocalGraph.jsx ---

--- FILE: features\wiki\components\EntityMiniMap.jsx ---
import React, { useEffect, useState, useRef } from 'react';
import { MapContainer, ImageOverlay, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import { Map as MapIcon, Maximize, Minimize, BookOpen, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import { resolveMarkerIcon } from '@/features/atlas/utils/markerUtils';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

const MapController = ({ bounds, activeFullscreen }) => {
	const map = useMap();
	useEffect(() => {
		if (bounds && map) {
			const timer = setTimeout(() => {
				map.invalidateSize({ animate: true });
				map.fitBounds(bounds, { padding: [20, 20] });
			}, 100);
			return () => clearTimeout(timer);
		}
	}, [map, bounds, activeFullscreen]);
	return null;
};

export const EntityMiniMap = ({ imageUrl, markers = [] }) => {
	const [dimensions, setDimensions] = useState(null);
	const [loading, setLoading] = useState(true);
	const [isFullscreen, setIsFullscreen] = useState(false);
	const [isPseudoFullscreen, setIsPseudoFullscreen] = useState(false);
	const containerRef = useRef(null);
	const navigate = useNavigate();
	const { map: entityMap } = useEntityIndex();

	const activeFullscreen = isFullscreen || isPseudoFullscreen;

	useEffect(() => {
		const handler = () => setIsFullscreen(!!document.fullscreenElement);
		document.addEventListener('fullscreenchange', handler);
		return () => document.removeEventListener('fullscreenchange', handler);
	}, []);

	useEffect(() => {
		const handleEsc = (e) => {
			if (e.key === 'Escape' && isPseudoFullscreen) setIsPseudoFullscreen(false);
		};
		window.addEventListener('keydown', handleEsc);
		return () => window.removeEventListener('keydown', handleEsc);
	}, [isPseudoFullscreen]);

	useEffect(() => {
		const img = new Image();
		img.src = imageUrl;
		img.onload = () => {
			const w = img.width;
			const h = img.height;
			const southWest = [-h, 0];
			const northEast = [0, w];
			setDimensions(L.latLngBounds(southWest, northEast));
			setLoading(false);
		};
	}, [imageUrl]);

	const toggleFullscreen = (e) => {
		e.stopPropagation();
		if (!containerRef.current) return;
		const supportsNative =
			document.fullscreenEnabled || document.webkitFullscreenEnabled || containerRef.current.requestFullscreen;
		if (supportsNative) {
			if (!document.fullscreenElement) {
				containerRef.current.requestFullscreen().catch(() => setIsPseudoFullscreen(true));
			} else {
				document.exitFullscreen();
			}
		} else {
			setIsPseudoFullscreen(!isPseudoFullscreen);
		}
	};

	if (loading)
		return (
			<div className='h-64 w-full bg-muted rounded-xl flex items-center justify-center border border-border mb-8'>
				<LoadingSpinner text='Generating tactical view...' size='sm' />
			</div>
		);

	return (
		<div
			className={clsx('mb-10 space-y-3 group', isPseudoFullscreen && 'fixed inset-0 z-[9999] m-0! bg-background')}
			ref={containerRef}>
			{!activeFullscreen && (
				<div className='flex items-center justify-between px-1'>
					<h3 className='font-serif text-lg mt-0 font-bold text-foreground mb-3 flex items-center gap-2'>
						<MapIcon size={16} className='text-primary' /> Map
					</h3>
				</div>
			)}

			<div
				className={clsx(
					'w-full overflow-hidden relative z-0 transition-all duration-300',
					activeFullscreen ? 'h-screen rounded-none border-0' : 'h-96 rounded-xl border border-border shadow-sm'
				)}>
				<MapContainer
					crs={L.CRS.Simple}
					bounds={dimensions}
					zoom={-2}
					minZoom={-3}
					scrollWheelZoom={true}
					attributionControl={false}
					style={{
						height: '100%',
						width: '100%',
						backgroundColor: 'var(--background)',
						backgroundImage:
							'radial-gradient(circle at center, var(--border) 1px, transparent 1px), radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
						backgroundSize: '40px 40px, 20px 20px',
						backgroundPosition: '0 0, 20px 20px',
					}}>
					<MapController bounds={dimensions} activeFullscreen={activeFullscreen} />
					<ImageOverlay url={imageUrl} bounds={dimensions} />

					{markers.map((marker, idx) => {
						const entityMatch = Array.from(entityMap.values()).find(
							(e) => e.name.toLowerCase() === marker.label.toLowerCase()
						);
						const entityAttrs = entityMatch ? parseAttributes(entityMatch.attributes) : {};

						const displayData = {
							title: marker.label,
							category:
								marker.category && marker.category !== 'default'
									? marker.category
									: entityMatch
									? entityMatch.type
									: 'Point of Interest',
							description: marker.description
								? marker.description
								: entityMatch
								? getAttributeValue(entityAttrs, ['summary', 'narrative']) || entityMatch.description
								: null,
							image: entityMatch ? resolveImageUrl(entityAttrs, 'background') : null,
						};

						const entityConfig = entityMatch ? getEntityConfig(entityMatch.type) : null;

						const handleWikiNav = (e) => {
							e.stopPropagation();
							if (entityMatch) {
								navigate(`/wiki/${entityMatch.type}/${entityMatch.id}`);
							}
						};

						return (
							<Marker
								key={`${marker.label}-${idx}`}
								position={[marker.lat, marker.lng]}
								icon={resolveMarkerIcon(marker)}>
								{marker.label && (
									<Popup className='custom-popup-clean' closeButton={false}>
										<div className='flex flex-col w-full font-sans bg-background rounded-lg overflow-hidden border border-border shadow-sm'>
											{displayData.image && (
												<div className='h-24 w-full relative bg-muted'>
													<img
														src={displayData.image}
														alt={displayData.title}
														className='w-full h-full object-cover m-0!'
													/>
													{/* FIX: Improved Gradient */}
													<div className='absolute inset-0 bg-gradient-to-t from-[var(--background)] via-[var(--background)]/80 via-30% to-transparent pointer-events-none' />
												</div>
											)}

											<div className={clsx('px-4 pb-3', displayData.image ? 'pt-2 -mt-8 relative z-10' : 'pt-4')}>
												<div className='flex items-start justify-between gap-2'>
													<div>
														<span
															className={clsx(
																'text-[10px] font-bold uppercase tracking-wider block mb-0.5',
																entityConfig ? entityConfig.tailwind.text : 'text-muted-foreground'
															)}>
															{displayData.category}
														</span>
														<h3 className='font-serif font-bold text-lg leading-tight text-foreground drop-shadow-sm m-0!'>
															{displayData.title}
														</h3>
													</div>
													{entityConfig && (
														<div
															className={clsx(
																'p-1.5 rounded-md border shrink-0 bg-background/80 backdrop-blur-sm',
																entityConfig.tailwind.border,
																entityConfig.tailwind.text
															)}>
															<entityConfig.icon size={14} />
														</div>
													)}
												</div>

												<div className='h-px w-full bg-border/50 my-3' />

												<div className='text-xs text-muted-foreground leading-relaxed max-h-32 overflow-y-auto custom-scrollbar'>
													{displayData.description || <span className='italic opacity-70'>No details available.</span>}
												</div>
											</div>

											{entityMatch && (
												<div className='bg-muted/50 p-2 border-t border-border'>
													<button
														onClick={handleWikiNav}
														className='w-full flex items-center justify-between px-3 py-1.5 rounded hover:bg-background text-muted-foreground hover:text-foreground transition-colors text-xs font-semibold group'>
														<span className='flex items-center gap-2'>
															<BookOpen size={12} /> View Encyclopedia
														</span>
														<ArrowRight size={12} className='opacity-0 group-hover:opacity-100 transition-opacity' />
													</button>
												</div>
											)}
										</div>
									</Popup>
								)}
							</Marker>
						);
					})}
				</MapContainer>

				<div
					className={clsx(
						'absolute z-[10060] transition-all duration-300',
						activeFullscreen ? 'top-[50%] right-4 lg:top-6 lg:right-6 pr-safe pt-safe' : 'top-4 right-4'
					)}>
					<button
						onClick={toggleFullscreen}
						className={clsx(
							'p-3 rounded-full border border-border shadow-2xl transition-all active:scale-90',
							'bg-background/95 backdrop-blur-md text-foreground hover:bg-primary hover:text-white'
						)}
						title={activeFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen'}>
						{activeFullscreen ? <Minimize size={20} strokeWidth={2.5} /> : <Maximize size={20} strokeWidth={2.5} />}
					</button>
				</div>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityMiniMap.jsx ---

--- FILE: features\wiki\components\EntitySidebar.jsx ---
import { useMemo } from 'react';
import { Tag, Network, Shield, Activity } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityLink from '@/domain/entity/components/EntityLink';
import { capitalize, toTitleCase } from '@/shared/utils/textUtils';
import { EntityLocalGraph } from './EntityLocalGraph'; // Import new component

// --- SUB-COMPONENTS ---
const AbilityGrid = ({ stats }) => (
	<div className='grid grid-cols-3 gap-2 mt-2 mb-4'>
		{stats.map((stat, i) => (
			<div
				key={i}
				className='bg-card/60 border border-border/80 rounded p-1.5 text-center flex flex-col items-center shadow-sm backdrop-blur-sm'>
				<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-widest leading-none'>
					{stat.name}
				</span>
				<span className='text-lg font-bold text-foreground leading-none my-1 font-serif'>{stat.score}</span>
				<span className='text-[10px] font-medium text-muted-foreground bg-muted px-1.5 rounded-full'>{stat.mod}</span>
			</div>
		))}
	</div>
);

const TagList = ({ tags }) => (
	<div className='flex flex-wrap gap-1.5 mt-1 mb-3'>
		{tags.map((item, i) => (
			<span
				key={i}
				className='inline-flex items-center px-2 py-0.5 rounded text-[11px] font-semibold bg-muted text-card-foreground border border-border/60 shadow-sm'>
				{toTitleCase(item)}
			</span>
		))}
	</div>
);

const StandardTrait = ({ label, value, index }) => (
	<div
		className={clsx(
			'flex justify-between items-baseline px-3 py-2 border-b border-border/40 last:border-0',
			index % 2 === 0 ? 'bg-card/40' : 'bg-transparent'
		)}>
		<span className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground/90 shrink-0 mr-4'>
			{label}
		</span>
		<span className='text-[13px] font-semibold text-foreground text-right leading-snug break-words'>
			{typeof value === 'string' ? toTitleCase(value) : value}
		</span>
	</div>
);

// --- HELPER: Connection Badge Colors ---
const getRoleStyle = (roleStr) => {
	// FIX: Standardized to generic style for all roles to ensure readability
	return 'bg-muted text-muted-foreground border-border/60';
};

// --- NEW COMPONENT: Type Divider ---
const TypeDivider = ({ label }) => (
	<div className='flex items-center gap-2 my-3'>
		<div className='h-px bg-muted flex-1' />
		<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-widest'>{label}</span>
		<div className='h-px bg-muted flex-1' />
	</div>
);

// --- MAIN COMPONENT ---
export const EntitySidebar = ({ entity, traits, connections }) => {
	const textTraits = traits.filter((t) => t.displayType === 'text');
	const specialTraits = traits.filter((t) => t.displayType !== 'text');

	// Group connections by Type Label
	const groupedConnections = useMemo(() => {
		if (!connections || connections.length === 0) return [];

		// 1. Sort by Type, then Name
		const sorted = [...connections].sort((a, b) => {
			const typeA = a.typeLabel || 'Other';
			const typeB = b.typeLabel || 'Other';
			const compareType = typeA.localeCompare(typeB);
			if (compareType !== 0) return compareType;
			return (a.name || '').localeCompare(b.name || '');
		});

		// 2. Group for rendering
		const groups = [];
		let currentType = null;
		let currentGroup = null;

		sorted.forEach((item) => {
			const type = item.typeLabel || 'Other';
			if (type !== currentType) {
				currentType = type;
				currentGroup = { type, items: [] };
				groups.push(currentGroup);
			}
			currentGroup.items.push(item);
		});

		return groups;
	}, [connections]);

	return (
		<div className='space-y-6 font-sans'>
			{/* 1. Standard Traits Table */}
			{textTraits.length > 0 && (
				<div className='bg-muted/30/50 border border-border/70 rounded-lg overflow-hidden'>
					{/* Header */}
					<div className='px-3 py-2 border-b border-border bg-muted/40 flex items-center gap-2'>
						<Tag size={12} className='text-primary-muted' />
						<h3 className='text-[11px] font-bold text-primary-muted uppercase tracking-widest'>Attributes</h3>
					</div>

					{/* Content */}
					<div className='flex flex-col'>
						{textTraits.map((prop, idx) => (
							<StandardTrait key={prop.key} label={prop.key} value={prop.value} index={idx} />
						))}
					</div>
				</div>
			)}

			{/* 2. Special Visual Blocks */}
			{specialTraits.length > 0 && (
				<div className='space-y-4 px-1'>
					{specialTraits.map((prop) => {
						if (prop.displayType === 'stat-grid') {
							return (
								<div key={prop.key}>
									<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1 flex items-center gap-2 ml-1'>
										<Activity size={10} /> {prop.key}
									</h3>
									<AbilityGrid stats={prop.value} />
								</div>
							);
						}
						if (prop.displayType === 'tags') {
							return (
								<div key={prop.key}>
									<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1 flex items-center gap-2 ml-1'>
										<Shield size={10} /> {prop.key}
									</h3>
									<TagList tags={prop.value} />
								</div>
							);
						}
						return null;
					})}
				</div>
			)}

			{/* 3. Connections (Grouped with Dividers) */}
			{groupedConnections.length > 0 && (
				<div>
					<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-2 px-1'>
						<Network size={10} /> Connections
					</h3>

					{/* 4. Local Graph (NEW) */}
					{connections && connections.length > 0 && entity && (
						<div className='pt-4 border-t border-border/50'>
							<EntityLocalGraph entity={entity} relationships={connections} height='h-70' headerShown={false} />
						</div>
					)}

					<div className='space-y-1'>
						{groupedConnections.map((group, gIdx) => (
							<div key={group.type}>
								<TypeDivider label={group.type} />

								<div className='space-y-2'>
									{group.items.map((rel, i) => (
										<EntityLink
											key={rel.id}
											id={rel.id}
											type={rel.typeLabel}
											inline={true}
											showIcon={false}
											className={clsx(
												'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline',
												'!border-border hover:!border-amber-300 hover:!shadow-sm hover:!bg-card',
												rel.theme.hover
											)}>
											<div className='flex items-center gap-2.5 flex-1 min-w-0'>
												<EntityIcon type={rel.typeLabel} size={14} className='opacity-80 group-hover:opacity-100' />
												<span className='text-sm font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
													{rel.name}
												</span>
											</div>
											<span
												className={clsx(
													'shrink-0 text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ml-2 max-w-[45%] truncate',
													getRoleStyle(rel.role)
												)}>
												{rel.role}
											</span>
										</EntityLink>
									))}
								</div>
							</div>
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\EntitySidebar.jsx ---

--- FILE: features\wiki\components\QuestObjectives.jsx ---
import { useState } from 'react';
import {
	CheckCircle2,
	Circle,
	XCircle,
	Target,
	Calendar,
	ChevronDown,
	ChevronRight,
	CornerDownRight,
} from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import EntityLink from '@/domain/entity/components/EntityLink';

const QuestObjectiveItem = ({ obj }) => {
	const [isOpen, setIsOpen] = useState(false);

	const isCompleted = obj.status === 'completed';
	const isFailed = obj.status === 'failed';

	const hasUpdate = !!obj.objective_update;
	const hasSession = isCompleted && obj.completed_session_number;
	const hasContent = hasUpdate || (hasSession && obj.completed_session_title);

	const toggle = () => hasContent && setIsOpen(!isOpen);

	return (
		<div
			className={clsx(
				'transition-colors border-b border-border/40 last:border-0',
				isCompleted ? 'bg-emerald-500/10/10' : isFailed ? 'bg-red-500/10/10' : 'hover:bg-muted/30'
			)}>
			{/* --- MAIN ROW --- */}
			<div
				className={clsx(
					'flex items-start gap-3 px-3 py-2 cursor-pointer group',
					hasContent ? 'hover:bg-black/5' : 'cursor-default'
				)}
				onClick={toggle}>
				{/* Status Icon */}
				<div className='mt-1.5 shrink-0'>
					{isCompleted ? (
						<CheckCircle2 size={16} className='text-emerald-600' />
					) : isFailed ? (
						<XCircle size={16} className='text-red-500' />
					) : (
						<Circle size={16} className='text-muted-foreground/40' strokeWidth={2} />
					)}
				</div>

				{/* Text Content */}
				<div className='flex-1 min-w-0 pt-0.5'>
					<div className='flex items-center justify-between gap-2 mb-0.5'>
						{obj.objective_name && (
							<div className='text-[10px] font-bold text-muted-foreground/70 uppercase tracking-wide'>
								{obj.objective_name}
							</div>
						)}

						{/* Session Indicator Badge (Inline) */}
						{hasSession && (
							<div
								className='flex items-center gap-1 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider bg-muted text-muted-foreground border border-border/60'
								title={`Completed in Session ${obj.completed_session_number - 1}`}>
								<Calendar size={10} />
								<span className='hidden sm:inline'>Session</span> {obj.completed_session_number - 1}
							</div>
						)}
					</div>

					<div
						className={clsx(
							'text-[13px] leading-snug font-medium transition-colors',
							isCompleted ? 'text-muted-foreground' : isFailed ? 'text-red-800/80' : 'text-foreground'
						)}>
						<SmartMarkdown components={{ p: 'span' }}>{obj.description}</SmartMarkdown>
					</div>
				</div>

				{/* Toggle Chevron */}
				{hasContent && (
					<button
						className={clsx(
							'shrink-0 text-muted-foreground/70 group-hover:text-foreground transition-colors mt-0.5',
							isOpen && 'text-foreground'
						)}>
						{isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
					</button>
				)}
			</div>

			{/* --- DROPDOWN CONTENT --- */}
			{isOpen && hasContent && (
				<div className='pl-9 pr-3 pb-2 -mt-1 animate-in slide-in-from-top-1 fade-in duration-200'>
					<div className='flex flex-col gap-1.5'>
						{/* Update Text */}
						{hasUpdate && (
							<div className='flex gap-2 items-start'>
								<CornerDownRight size={12} className='shrink-0 mt-1 text-primary opacity-60' />
								<span className='text-xs text-muted-foreground italic leading-relaxed'>
									<SmartMarkdown>{obj.objective_update}</SmartMarkdown>
								</span>
							</div>
						)}
					</div>
				</div>
			)}
		</div>
	);
};

export const QuestObjectives = ({ objectives }) => {
	if (!objectives || objectives.length === 0) return null;

	return (
		<div className='mb-8 not-prose border border-border rounded-lg overflow-hidden bg-muted/30/20'>
			<div className='px-3 py-2 border-b border-border bg-muted/50 flex items-center gap-2'>
				<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider flex items-center gap-2 m-0'>
					<Target size={12} className='text-primary' /> Quest Objectives
				</h3>
				<span className='ml-auto text-[9px] font-bold bg-muted/80 px-1.5 py-0.5 rounded text-muted-foreground'>
					{objectives.filter((o) => o.status === 'completed').length} / {objectives.length}
				</span>
			</div>

			<div className='bg-background'>
				{objectives.map((obj, idx) => (
					<QuestObjectiveItem key={obj.id || idx} obj={obj} />
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\QuestObjectives.jsx ---

--- FILE: features\wiki\components\SessionMentions.jsx ---
import { clsx } from 'clsx';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';

const MentionGroup = ({ type, items }) => {
	const config = getEntityConfig(type);
	const Icon = config.icon;

	return (
		<div className='break-inside-avoid mb-4 border border-border rounded-lg overflow-hidden bg-muted/30/30 flex flex-col'>
			{/* Header */}
			<div className='px-3 py-2 border-b border-border bg-muted/50 flex items-center justify-between shrink-0'>
				<div className='flex items-center gap-2'>
					<Icon size={12} className='text-muted-foreground' />
					<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-widest m-0'>
						{config.labelPlural}
					</h3>
				</div>
				<span className='text-[9px] font-bold text-muted-foreground bg-muted/60 px-1.5 py-0.5 rounded-full'>
					{items.length}
				</span>
			</div>

			{/* List Container */}
			<div className='p-2'>
				<div className='flex flex-col gap-1'>
					{items.map((item) => (
						<EntityLink
							key={item.id}
							id={item.id}
							type={item.type}
							inline={true}
							showIcon={false}
							className={clsx(
								// Matches CharacterSidebar styling exactly
								'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline',
								'!border-border hover:!border-primary/40 hover:!shadow-sm hover:!bg-card group'
							)}>
							<div className='flex items-center gap-2.5 flex-1 min-w-0'>
								<EntityIcon
									type={item.type}
									size={16}
									className='opacity-80 group-hover:opacity-100 transition-opacity'
								/>
								<span className='text-xs font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
									{item.name}
								</span>
							</div>
						</EntityLink>
					))}
				</div>
			</div>
		</div>
	);
};

export const SessionMentions = ({ mentions }) => {
	if (!mentions || Object.keys(mentions).length === 0) {
		return (
			<div className='p-12 text-center text-muted-foreground italic border border-dashed border-border rounded-lg'>
				No linked entities found in this session.
			</div>
		);
	}

	const order = ['character', 'npc', 'location', 'faction', 'quest', 'encounter'];
	const orderedKeys = order.filter((k) => mentions[k]).concat(Object.keys(mentions).filter((k) => !order.includes(k)));

	return (
		<div className='columns-1 md:columns-2 xl:columns-3 gap-4 animate-in fade-in duration-500'>
			{orderedKeys.map((key) => (
				<MentionGroup key={key} type={key} items={mentions[key]} />
			))}
		</div>
	);
};

--- END OF features\wiki\components\SessionMentions.jsx ---

--- FILE: features\wiki\components\WikiEntryView.jsx ---
import { useEntityViewModel } from '@/features/wiki/useEntityView';
import { EntityHeader } from '@/features/wiki/components/EntityHeader';
import StandardLayout from '@/features/wiki/layouts/StandardLayout';
import SessionLayout from '@/features/wiki/layouts/SessionLayout';
import CharacterLayout from '@/features/wiki/layouts/CharacterLayout'; // Import New Layout

export default function WikiEntityView({ entity }) {
	const viewModel = useEntityViewModel(entity);

	if (!viewModel) return null;

	let LayoutComponent;
	if (viewModel.layoutMode === 'tabs') {
		LayoutComponent = SessionLayout;
	} else if (viewModel.layoutMode === 'character') {
		LayoutComponent = CharacterLayout;
	} else {
		LayoutComponent = StandardLayout;
	}

	return (
		<div className='pb-16 animate-in fade-in duration-300 min-h-full'>
			<EntityHeader data={viewModel.header} />
			<LayoutComponent viewModel={viewModel} />
		</div>
	);
}

--- END OF features\wiki\components\WikiEntryView.jsx ---

--- FILE: features\wiki\components\character\CharacterSidebar.jsx ---
import { Tag, Shield, Gem, Scroll, Save, Eye, Swords, Activity } from 'lucide-react';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { clsx } from 'clsx';

// Helper: Split string by comma and trim
const parseTags = (str) => {
	if (!str) return [];
	if (Array.isArray(str)) return str;
	return String(str)
		.split(',')
		.map((s) => s.trim())
		.filter(Boolean);
};

const SidebarHeader = ({ title, icon: Icon }) => (
	<h4 className='flex items-center gap-2 text-[10px] font-bold uppercase text-muted-foreground tracking-widest mb-3 mt-5 border-b border-border/40 pb-1'>
		{Icon && <Icon size={12} />} {title}
	</h4>
);

const TagPill = ({ text }) => (
	<span className='inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-muted/30 text-muted-foreground border border-border/50'>
		{text}
	</span>
);

const StatRowItem = ({ label, value }) => (
	<div className='flex flex-col items-center justify-center p-2 bg-muted/20 rounded border border-border/30'>
		<span className='text-[9px] font-bold uppercase text-muted-foreground/70 tracking-wider mb-0.5'>{label}</span>
		<span className='text-sm font-bold text-foreground font-serif'>{value}</span>
	</div>
);

const SkillItem = ({ text }) => {
	// split "Acrobatics (+1)" into name and val
	const match = text.match(/^(.*)\s(\([+-]?\d+\))$/);
	const name = match ? match[1] : text;
	const val = match ? match[2] : '';

	return (
		<div className='flex justify-between items-center text-[11px] py-0.5 px-1 border-b border-border/20 last:border-0'>
			<span className='text-muted-foreground'>{name}</span>
			<span className='font-mono text-foreground opacity-80 text-[10px]'>{val}</span>
		</div>
	);
};

const SidebarLink = ({ entity }) => (
	<EntityLink
		id={entity.entity_id}
		type={entity.entity_type}
		inline={true}
		showIcon={false}
		className={clsx(
			'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline !mb-2',
			'!border-border hover:!border-primary/40 hover:!shadow-sm hover:!bg-card'
		)}>
		<div className='flex items-center gap-2.5 flex-1 min-w-0'>
			<EntityIcon type={entity.entity_type} size={16} className='opacity-80 group-hover:opacity-100' />
			<span className='text-xs font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
				{entity.entity_name}
			</span>
		</div>
	</EntityLink>
);

export const CharacterSidebar = ({ attributes, gear, quests }) => {
	const proficiencies = parseTags(attributes.proficiencies || attributes.tools);
	const languages = parseTags(attributes.languages);
	const saves = attributes['saving throw'] || attributes['saves'] || [];
	const saveList = Array.isArray(saves) ? saves : [];

	// Extract special stats manually
	const initiative = attributes.initiative;
	const proficiencyBonus = attributes.proficiency || attributes.proficiency_bonus;
	const skills = parseTags(attributes.skills);
	const senses = parseTags(attributes['additional senses'] || attributes.senses);

	// Filter keys that we handle explicitly
	const ignoredKeys = new Set([
		// Header
		'class',
		'race',
		'level',
		// Stats Bar
		'ability score',
		'stats',
		'saving throw',
		'saves',
		'armor class',
		'ac',
		'hit points',
		'hp',
		'speed',
		'passive_perception',
		'passive',
		// Explicit Sections
		'languages',
		'proficiencies',
		'tools',
		'skills',
		'initiative',
		'proficiency',
		'proficiency_bonus',
		'additional senses',
		'senses',
		// System
		'icon',
		'background_image',
		'is_active',
		'campaign_id',
	]);

	// Get any remaining attributes (Alignment, Faith, etc.)
	const otherAttributes = Object.entries(attributes).filter(([key, val]) => {
		const k = key.toLowerCase();
		if (ignoredKeys.has(k)) return false;
		if (!val || (typeof val === 'object' && !Array.isArray(val))) return false;
		return true;
	});

	return (
		<div className='font-sans'>
			{/* 1. Combat Vitals Row (Initiative / Proficiency) */}
			{(initiative || proficiencyBonus) && (
				<div className='grid grid-cols-2 gap-2 mb-4'>
					{initiative && <StatRowItem label='Initiative' value={initiative} />}
					{proficiencyBonus && <StatRowItem label='Proficiency' value={proficiencyBonus} />}
				</div>
			)}

			{/* 2. Saving Throws */}
			{saveList.length > 0 && (
				<div>
					<SidebarHeader title='Saving Throws' icon={Save} />
					<div className='flex flex-wrap gap-1.5'>
						{saveList.map((save, i) => (
							<TagPill key={i} text={save} />
						))}
					</div>
				</div>
			)}

			{/* 3. Skills (Compact Grid) */}
			{skills.length > 0 && (
				<div>
					<SidebarHeader title='Skills' icon={Activity} />
					<div className='grid grid-cols-2 gap-x-4 gap-y-0.5'>
						{skills.map((skill, i) => (
							<SkillItem key={i} text={skill} />
						))}
					</div>
				</div>
			)}

			{/* 4. Senses */}
			{senses.length > 0 && (
				<div>
					<SidebarHeader title='Senses' icon={Eye} />
					<div className='flex flex-col gap-1'>
						{senses.map((sense, i) => (
							<div key={i} className='text-xs text-muted-foreground border-l-2 border-border pl-2 py-0.5'>
								{sense}
							</div>
						))}
					</div>
				</div>
			)}

			{/* 5. Languages */}
			{languages.length > 0 && (
				<div>
					<SidebarHeader title='Languages' icon={Tag} />
					<div className='flex flex-wrap gap-1.5'>
						{languages.map((lang, i) => (
							<TagPill key={i} text={lang} />
						))}
					</div>
				</div>
			)}

			{/* 6. Dynamic Attributes */}
			{otherAttributes.map(([key, val]) => {
				const tags = parseTags(val);
				return (
					<div key={key}>
						<SidebarHeader title={key.replace(/_/g, ' ')} icon={Swords} />
						<div className='flex flex-wrap gap-1.5'>
							{tags.map((t, i) => (
								<TagPill key={i} text={t} />
							))}
						</div>
					</div>
				);
			})}

			{/* 7. Personal Quests */}
			{quests && quests.length > 0 && (
				<div>
					<SidebarHeader title='Personal Quests' icon={Scroll} />
					<div>
						{quests.map((quest) => (
							<SidebarLink key={quest.entity_id} entity={quest} />
						))}
					</div>
				</div>
			)}

			{/* 8. Signature Gear */}
			{gear && gear.length > 0 && (
				<div>
					<SidebarHeader title='Signature Gear' icon={Gem} />
					<div>
						{gear.map((item) => (
							<SidebarLink key={item.entity_id} entity={item} />
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\character\CharacterSidebar.jsx ---

--- FILE: features\wiki\components\character\CharacterStats.jsx ---
import { Shield, Heart, Wind } from 'lucide-react';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';

const parseStat = (str) => {
	if (!str) return { label: '???', value: '-' };
	const match = str.match(/^([A-Z]{3})\s+(.*)$/);
	if (!match) return { label: str.substring(0, 3), value: str };
	return { label: match[1], value: match[2] };
};

const StatPill = ({ raw }) => {
	const { label, value } = parseStat(raw);
	return (
		<div className='flex flex-col items-center justify-center bg-muted/20 border border-border/50 rounded-md py-1.5 px-3 min-w-[70px]'>
			<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-wider mb-0.5'>{label}</span>
			<span className='text-sm font-bold text-foreground font-serif leading-none'>{value}</span>
		</div>
	);
};

const VitalPill = ({ label, value, icon: Icon, color }) => (
	<div className='flex flex-col items-center justify-center bg-muted/20 border border-border/50 rounded-md py-1.5 px-4 min-w-[80px]'>
		<div className='flex items-center gap-1.5 mb-0.5 opacity-80'>
			<Icon size={10} className={color} />
			<span className='text-[9px] font-bold uppercase text-muted-foreground tracking-wider'>{label}</span>
		</div>
		<span className='text-base font-serif font-bold text-foreground leading-none'>{value || '-'}</span>
	</div>
);

export const CharacterStats = ({ attributes }) => {
	const stats = attributes['ability score'] || attributes['stats'] || [];
	const ac = attributes['armor class'] || attributes['ac'];
	const hp = attributes['hit points'] || attributes['hp'];
	const speed = attributes['speed'];

	return (
		<div>
			<div className='flex flex-wrap items-center justify-center gap-6'>
				{/* 1. Ability Scores */}
				<div className='flex flex-wrap justify-center gap-2'>
					{stats.map((s, i) => (
						<StatPill key={i} raw={s} />
					))}
				</div>

				{/* Vertical Divider (Hidden on small mobile) */}
				<div className='hidden sm:block w-px h-8 bg-border/40' />

				{/* 2. Vitals */}
				<div className='flex flex-wrap justify-center gap-2'>
					<VitalPill label='AC' value={ac} icon={Shield} color='text-emerald-500' />
					<VitalPill label='HP' value={hp} icon={Heart} color='text-red-500' />
					<VitalPill label='Speed' value={speed} icon={Wind} color='text-blue-500' />
				</div>
			</div>
			<SectionDivider />
		</div>
	);
};

--- END OF features\wiki\components\character\CharacterStats.jsx ---

--- FILE: features\wiki\components\character\RelationshipNetwork.jsx ---
import { clsx } from 'clsx';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';

const NetworkGroup = ({ type, items }) => {
	if (!items || items.length === 0) return null;

	const config = getEntityConfig(type);
	const Icon = config.icon;

	return (
		<div className='break-inside-avoid mb-6 bg-card/40 border border-border/40 rounded-lg overflow-hidden'>
			{/* Group Header */}
			<div className='px-3 py-2 border-b border-border/40 bg-muted/30 flex items-center justify-between'>
				<div
					className={clsx('flex items-center gap-2 text-xs font-bold uppercase tracking-widest', config.tailwind.text)}>
					<Icon size={14} /> {config.labelPlural}
				</div>
				<span className='text-[9px] font-bold bg-background border border-border/50 px-1.5 py-0.5 rounded text-muted-foreground'>
					{items.length}
				</span>
			</div>

			{/* List of Connections */}
			<div className='p-2 space-y-1.5'>
				{items.map((rel) => (
					<EntityLink
						key={rel.entity_id}
						id={rel.entity_id}
						type={rel.entity_type}
						inline={true}
						showIcon={true}
						className={clsx(
							'!flex !w-full !items-center !justify-between !p-2 !rounded-md !border !bg-card !transition-all !cursor-pointer !no-underline',
							'!border-border hover:!border-primary/50 hover:!shadow-sm hover:!bg-muted/20 group'
						)}>
						{/* Left: Icon + Name */}
						<div className='flex items-center gap-2.5 flex-1 min-w-0'>
							{/* <EntityIcon type={rel.entity_type} size={18} className='opacity-80 group-hover:opacity-100 shrink-0' /> */}
							<span className='text-xs font-bold text-foreground truncate group-hover:text-primary transition-colors'>
								{rel.entity_name}
							</span>
						</div>

						{/* Right: Relationship Label */}
						<span className='shrink-0 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground/70 bg-muted/50 px-1.5 py-0.5 rounded ml-2 max-w-[40%] truncate'>
							{rel.type ? rel.type.replace(/_/g, ' ') : 'Related'}
						</span>
					</EntityLink>
				))}
			</div>
		</div>
	);
};

export const RelationshipNetwork = ({ relationships }) => {
	if (!relationships || relationships.length === 0) {
		return (
			<div className='p-8 text-center text-muted-foreground italic border border-dashed border-border rounded-lg bg-muted/20'>
				No connections recorded.
			</div>
		);
	}

	// 1. Group by Entity Type
	const groups = relationships.reduce((acc, rel) => {
		const type = rel.entity_type || 'default';
		if (!acc[type]) acc[type] = [];
		acc[type].push(rel);
		return acc;
	}, {});

	// 2. Define Display Order (Narrative Priority)
	const order = ['character', 'npc', 'faction', 'location', 'quest', 'encounter', 'item'];
	const orderedKeys = order.filter((k) => groups[k]).concat(Object.keys(groups).filter((k) => !order.includes(k)));

	// 3. Render Masonry Layout
	return (
		<div className='columns-1 md:columns-2 xl:columns-3 gap-6 animate-in fade-in duration-500'>
			{orderedKeys.map((type) => (
				<NetworkGroup key={type} type={type} items={groups[type]} />
			))}
		</div>
	);
};

--- END OF features\wiki\components\character\RelationshipNetwork.jsx ---

--- FILE: features\wiki\components\landing\EntityGridCard.jsx ---
import { Link } from 'react-router-dom';
import { clsx } from 'clsx';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getStatusInfo } from '@/domain/entity/utils/statusUtils';

export const EntityGridCard = ({ entity, config }) => {
	const attributes = parseAttributes(entity.attributes);
	const imageUrl = resolveImageUrl(attributes, 'background') || resolveImageUrl(attributes, 'icon');
	const status = getStatusInfo(entity);

	const isActorOrQuest = ['npc', 'character', 'faction', 'quest'].includes(entity.type);
	const hasMeaningfulStatus = status.isDead || status.isFailed || status.rank === 1 || status.rank === 3;
	const showStatus = isActorOrQuest && hasMeaningfulStatus;

	let statusBorderClass = 'border-l-transparent';
	if (showStatus) {
		if (status.isDead || status.isFailed) statusBorderClass = 'border-l-red-500';
		else if (status.rank === 3) statusBorderClass = 'border-l-red-600';
		else if (status.rank === 1) statusBorderClass = 'border-l-emerald-500';
	}

	return (
		<Link
			to={`/wiki/${entity.type}/${entity.id}`}
			className={clsx(
				'group flex bg-background border border-border rounded-lg overflow-hidden transition-all duration-200',
				entity.footerLabel ? 'h-28' : 'h-24',
				'hover:shadow-md hover:bg-muted/10',
				showStatus ? `border-l-[3px] ${statusBorderClass}` : 'border-l'
			)}>
			{/* Left: Image */}
			<div className='w-24 shrink-0 relative bg-muted/30 border-r border-border/50'>
				{imageUrl ? (
					<>
						<img
							src={imageUrl}
							alt={entity.name}
							className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
						/>
						<div className='absolute inset-0 bg-black/5 group-hover:bg-transparent transition-colors' />
					</>
				) : (
					<div className='w-full h-full flex items-center justify-center bg-muted'>
						<config.icon size={28} className='text-muted-foreground/70' strokeWidth={1.5} />
					</div>
				)}
			</div>

			{/* Right: Content */}
			<div
				className={clsx(
					'flex-1 px-3 py-2 flex flex-col min-w-0',
					// FIX: If footer exists, space between. If not, center vertically.
					entity.footerLabel ? 'justify-between' : 'justify-center'
				)}>
				<div>
					<div className='flex items-center justify-between gap-2'>
						<h3 className='font-serif font-bold text-sm text-foreground group-hover:text-primary transition-colors truncate'>
							{entity.name}
						</h3>
					</div>

					<div className='text-[11px] text-muted-foreground/80 leading-snug mt-1 line-clamp-3'>
						{entity.description || <span className='opacity-50 italic'>No details available.</span>}
					</div>
				</div>

				{entity.footerLabel && (
					<div className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/60 mt-auto pt-2 truncate border-t border-border/40'>
						{entity.footerLabel}
					</div>
				)}
			</div>
		</Link>
	);
};

--- END OF features\wiki\components\landing\EntityGridCard.jsx ---

--- FILE: features\wiki\components\landing\EntityPosterCard.jsx ---
import { Link } from 'react-router-dom';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser'; // Added missing import

export const EntityPosterCard = ({ entity, config }) => {
	const attributes = parseAttributes(entity.attributes);

	const imageUrl =
		resolveImageUrl(attributes, ['portrait', 'image']) ||
		resolveImageUrl(attributes, 'background') ||
		resolveImageUrl(attributes, 'icon');

	// Fallback Description Logic
	const description =
		entity.description ||
		getAttributeValue(attributes, ['summary', 'narrative', 'background', 'bio']) ||
		'No description available.';

	// Smart Subtitle for Characters
	const role = getAttributeValue(attributes, ['class', 'role', 'occupation', 'type']);
	const level = getAttributeValue(attributes, ['level']);

	let subtitle = role || entity.type;
	if (level && role) {
		subtitle = `Lvl ${level} ${role}`;
	} else if (level) {
		subtitle = `Level ${level}`;
	}

	// FIX: Changed outer wrapper from <Link> to <div> to prevent <a> nesting errors
	return (
		<div className='group relative flex flex-col bg-card border border-border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 h-[380px]'>
			{/* FIX: Stretched Link - This makes the whole card clickable without nesting tags */}
			<Link
				to={`/wiki/${entity.type}/${entity.id}`}
				className='absolute inset-0 z-0'
				aria-label={`View ${entity.name}`}
			/>

			{/* 1. Image Area */}
			{/* Added pointer-events-none so clicks fall through to the link, or you can leave it interactive if needed */}
			<div className='relative h-[60%] bg-muted overflow-hidden'>
				{imageUrl ? (
					<>
						<img
							src={imageUrl}
							alt={entity.name}
							className='w-full h-full object-cover object-top transition-transform duration-700 group-hover:scale-105'
							loading='lazy'
						/>
						<div className='absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-40 transition-opacity duration-300' />
					</>
				) : (
					<div className='w-full h-full flex flex-col items-center justify-center bg-muted/50 p-6 text-center'>
						<config.icon size={48} className='text-muted-foreground/30 mb-2' strokeWidth={1} />
						<span className='text-xs font-serif text-muted-foreground/50 uppercase tracking-widest'>No Image</span>
					</div>
				)}

				{/* Floating Badge */}
				<div className='absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300'>
					<EntityBadge type={entity.type} size='sm' variant='solid' className='shadow-lg' />
				</div>
			</div>

			{/* 2. Content Area */}
			{/* Relative z-10 places text above the stretched link if you want text selection, 
                but usually for a card link we want the click to work everywhere. 
                Using pointer-events-none on the container allows clicks to pass to the Link below. */}
			<div className='flex-1 p-4 flex flex-col bg-card relative z-10 border-t border-border/50 pointer-events-none'>
				<div className='mb-2'>
					<h3 className='font-serif font-bold text-lg text-foreground leading-tight group-hover:text-primary transition-colors line-clamp-1'>
						{entity.name}
					</h3>
					<p className='text-[10px] font-bold text-muted-foreground uppercase tracking-widest truncate mt-1'>
						{subtitle}
					</p>
				</div>

				<div className='text-xs text-muted-foreground/80 leading-relaxed line-clamp-4 overflow-hidden text-ellipsis'>
					{/* SmartMarkdown can now safely render links because we are inside a div, not an <a> */}
					<SmartMarkdown components={{ p: 'span' }}>{description}</SmartMarkdown>
				</div>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\landing\EntityPosterCard.jsx ---

--- FILE: features\wiki\components\landing\EntityTableGroup.jsx ---
import { Link } from 'react-router-dom';
import { clsx } from 'clsx';
import { ArrowRight, CornerDownRight, Activity } from 'lucide-react';
import { getStatusInfo } from '@/domain/entity/utils/statusUtils';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import { parseAttributes } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

/**
 * CONFIGURATION: Table Definitions
 * Defines columns, widths, and RENDER logic in one place.
 */
const TABLE_DEFINITIONS = {
	session: [
		{
			header: 'Session Title',
			width: '45%',
			render: (e, attr) => (
				<Link
					to={`/wiki/session/${e.id}`}
					className='font-serif font-bold text-foreground hover:text-primary transition-colors text-sm'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Date',
			width: '20%',
			render: (e, attr) => <span className='text-xs text-muted-foreground'>{attr.session_date || '-'}</span>,
		},
	],
	quest: [
		{
			header: 'Quest',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/quest/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Status',
			width: '20%',
			render: (e) => {
				const s = getStatusInfo(e);
				if (!s.display) return <span className='text-muted-foreground'>-</span>;
				return (
					<span
						className={clsx(
							'px-2 py-0.5 rounded text-[10px] font-bold uppercase',
							s.isCompleted
								? 'bg-emerald-500/10 text-emerald-600'
								: s.isFailed
								? 'bg-red-500/10 text-red-600'
								: 'bg-amber-500/10 text-amber-600'
						)}>
						{s.display}
					</span>
				);
			},
		},
		{
			header: 'Priority',
			width: '20%',
			render: (e) => <span className='text-xs font-semibold text-muted-foreground'>{e.meta.priority || '-'}</span>,
		},
	],
	location: [
		{
			header: 'Location',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/location/${e.id}`}
					className='font-serif font-bold text-sm text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Type',
			width: '30%',
			hiddenOnMobile: true,
			render: (e, attr) => <EntityBadge type='location' label={attr.type} variant='subtle' />,
		},
	],
	npc: [
		{
			header: 'Name',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/npc/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Affinity',
			width: '20%',
			render: (e) => {
				const s = getStatusInfo(e);
				if (!s.display) return <span className='text-muted-foreground'>-</span>;
				return (
					<span
						className={clsx(
							'px-2 py-0.5 rounded text-[10px] font-bold uppercase',
							s.rank === 1
								? 'bg-emerald-500/10 text-emerald-600'
								: s.rank === 3
								? 'bg-red-500/10 text-red-600'
								: 'bg-muted text-muted-foreground'
						)}>
						{s.display}
					</span>
				);
			},
		},
		{
			header: 'Role',
			width: '40%',
			hiddenOnMobile: true,
			render: (e, attr) => (
				<span className='text-sm text-muted-foreground'>
					{getAttributeValue(attr, ['role', 'class', 'occupation']) || '-'}
				</span>
			),
		},
	],
	item: [
		// <--- ADDED
		{
			header: 'Item Name',
			width: '45%',
			render: (e) => (
				<Link
					to={`/wiki/item/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Rarity',
			width: '25%',
			render: (e, attr) => {
				const rarity = getAttributeValue(attr, ['rarity']) || '-';
				return <span className='text-xs font-medium text-muted-foreground capitalize'>{rarity}</span>;
			},
		},
		{
			header: 'Type',
			width: '30%',
			hiddenOnMobile: true,
			render: (e, attr) => {
				const type = getAttributeValue(attr, ['type', 'item_type']) || 'Item';
				return <EntityBadge type='item' label={type} variant='subtle' size='sm' />;
			},
		},
	],
	// Fallback for others
	default: [
		{
			header: 'Name',
			width: '60%',
			render: (e) => (
				<Link to={`/wiki/${e.type}/${e.id}`} className='font-serif font-bold text-sm text-foreground'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Type',
			width: '40%',
			render: (e) => <EntityBadge type={e.type} variant='outline' size='sm' />,
		},
	],
};

const getColumns = (type) => TABLE_DEFINITIONS[type] || TABLE_DEFINITIONS[type === 'faction' ? 'npc' : 'default'];

export const EntityTableGroup = ({ title, description, parentTitle, link, items }) => {
	if (!items || items.length === 0) return null;

	const type = items[0].type;
	const columns = getColumns(type);

	return (
		<div className='mb-10 animate-in fade-in duration-500'>
			{/* Header */}
			<div className='mb-3'>
				<div className='flex items-center gap-2 border-b border-border/60 pb-2'>
					{parentTitle && (
						<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground/80 uppercase tracking-widest'>
							{parentTitle}
							<CornerDownRight size={10} className='translate-y-px text-muted-foreground' />
						</div>
					)}
					<h2 className='text-lg font-bold font-serif text-foreground flex items-center gap-2'>
						{title}
						{link && (
							<Link to={link} className='text-muted-foreground/50 hover:text-primary transition-colors'>
								<ArrowRight size={14} />
							</Link>
						)}
					</h2>
					<span className='text-[10px] font-bold bg-muted px-2 py-0.5 rounded-full text-muted-foreground ml-auto'>
						{items.length}
					</span>
				</div>
				{description && (
					<div className='mt-2 text-sm text-muted-foreground/80 leading-relaxed pl-2 border-l-2 border-primary/20'>
						<SmartMarkdown>{description.substring(0, 300) + '...'}</SmartMarkdown>
					</div>
				)}
			</div>

			{/* The Table */}
			<div className='border border-border rounded-lg overflow-hidden shadow-sm'>
				<table className='w-full text-left border-collapse'>
					<thead className='bg-muted/50 text-[10px] uppercase font-bold text-muted-foreground tracking-wider'>
						<tr>
							{columns.map((col, i) => (
								<th
									key={i}
									className={clsx(
										'px-4 py-2.5 font-semibold',
										col.hiddenOnMobile && 'hidden md:table-cell',
										col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'
									)}
									style={{ width: col.width }}>
									{col.header}
								</th>
							))}
						</tr>
					</thead>
					<tbody className='divide-y divide-border/40'>
						{items.map((entity) => {
							const attributes = parseAttributes(entity.attributes);
							return (
								<tr key={entity.id} className='group hover:bg-muted/30 transition-colors'>
									{columns.map((col, i) => (
										<td
											key={i}
											className={clsx(
												'px-4 py-2.5',
												col.hiddenOnMobile && 'hidden md:table-cell',
												col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'
											)}>
											{col.render(entity, attributes)}
										</td>
									))}
								</tr>
							);
						})}
					</tbody>
				</table>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\landing\EntityTableGroup.jsx ---

--- FILE: features\wiki\components\landing\Swimlane.jsx ---
import { useState } from 'react';
import { Link } from 'react-router-dom';
import { ArrowRight, CornerDownRight, Users, MapPin, Scroll, Swords, Hash, ChevronDown, ChevronUp } from 'lucide-react';
import { EntityGridCard } from './EntityGridCard';
import { EntityPosterCard } from './EntityPosterCard';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';
import { HighlightBadge } from '@/shared/components/ui/HighlightBadge';
import { clsx } from 'clsx';

// --- SUB-COMPONENT: ARC HERO ---
const ArcHero = ({ title, description, type, order, stats, isSessionGroup }) => {
	const [isExpanded, setIsExpanded] = useState(false);
	const formattedOrder = order && order < 999 ? `Arc ${String(order).padStart(2, '0')}` : null;

	// LOGIC:
	// 1. If it's a Session Group, NEVER truncate (always show full narrative context).
	// 2. If it's NOT a Session Group (e.g. Locations folder), check if > 300 chars.
	const shouldTruncate = !isSessionGroup && description && description.length > 300;

	return (
		<div className='flex flex-col gap-3 mb-8 items-center'>
			{/* 1. Arc Number / Arc Type */}
			<div className='flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-muted-foreground/60'>
				{formattedOrder && (
					<span className='flex items-center gap-1'>
						<Hash size={10} />
						{formattedOrder}
					</span>
				)}
				{formattedOrder && type && <span></span>}
				{type && <span className='text-primary/80'>{type}</span>}
			</div>

			{/* 2. Arc Name */}
			<h2 className='text-3xl md:text-4xl font-serif font-bold text-foreground text-center max-w-4xl'>{title}</h2>

			{/* 3. Arc Description */}
			<div className='max-w-3xl text-center mx-auto'>
				<div
					className={clsx(
						'text-sm text-muted-foreground leading-relaxed',
						// Only apply line-clamp if we are allowed to truncate and haven't expanded yet
						shouldTruncate && !isExpanded ? 'line-clamp-3 overflow-hidden' : ''
					)}>
					<SmartMarkdown components={{ p: 'span' }}>{description || 'No description available.'}</SmartMarkdown>
				</div>

				{/* Toggle Button (Only shows for non-sessions with long text) */}
				{shouldTruncate && (
					<button
						onClick={() => setIsExpanded(!isExpanded)}
						className='inline-flex items-center gap-1 mt-2 text-[10px] font-bold uppercase tracking-widest text-primary/80 hover:text-primary transition-colors'>
						{isExpanded ? (
							<>
								Read Less <ChevronUp size={12} />
							</>
						) : (
							<>
								Read More <ChevronDown size={12} />
							</>
						)}
					</button>
				)}
			</div>

			{/* 4. Arc Highlights */}
			{stats && (stats.npcs > 0 || stats.locations > 0 || stats.quests > 0 || stats.encounters > 0) && (
				<div className='flex flex-wrap justify-center gap-4 mt-2'>
					<HighlightBadge icon={Users} count={stats.npcs} label='NPCs' />
					<HighlightBadge icon={MapPin} count={stats.locations} label='Locations' />
					<HighlightBadge icon={Scroll} count={stats.quests} label='Quests' />
					<HighlightBadge icon={Swords} count={stats.encounters} label='Encounters' />
				</div>
			)}
		</div>
	);
};

// --- SUB-COMPONENT: STANDARD HEADER ---
const StandardHeader = ({ title, parentTitle, link, count }) => (
	<div className='mb-4'>
		<div className='flex items-center gap-2 border-b border-border/60 pb-2'>
			{parentTitle && (
				<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground/80 uppercase tracking-widest'>
					{parentTitle}
					<CornerDownRight size={10} className='translate-y-px text-muted-foreground' />
				</div>
			)}

			<h2 className='text-lg font-bold font-serif text-foreground flex items-center gap-2'>
				{title || 'General'}
				{link && (
					<Link
						to={link}
						className='text-muted-foreground/50 hover:text-primary transition-colors'
						title={`View ${title}`}>
						<ArrowRight size={14} />
					</Link>
				)}
			</h2>

			<span className='text-[10px] font-bold bg-muted px-2 py-0.5 rounded-full text-muted-foreground ml-auto'>
				{count}
			</span>
		</div>
	</div>
);

// --- MAIN COMPONENT ---
export const Swimlane = ({ title, description, items, config, context, type, stats, order, parentTitle, link }) => {
	if (!items || items.length === 0) return null;

	const visualTypes = ['character'];
	const usePoster = items.length > 0 && visualTypes.includes(items[0].type);

	const isArc = !!description || !!type;

	// Determine if this is a Session Group (e.g. Narrative Arc) vs a Category Group (e.g. Locations)
	const isSessionGroup = items[0].type === 'session';

	return (
		<div className='animate-in fade-in slide-in-from-bottom-3 duration-500'>
			{/* HEADER SECTION */}
			{isArc ? (
				<ArcHero
					title={title}
					description={description} // Pass full description
					type={type}
					order={order}
					stats={stats}
					isSessionGroup={isSessionGroup} // Pass flag to control truncation
				/>
			) : (
				<StandardHeader title={title} parentTitle={parentTitle} link={link} count={items.length} />
			)}

			{/* CONTENT SECTION */}
			<div className='max-w-7xl mx-auto pb-4'>
				<div className='flex flex-wrap justify-center gap-4'>
					{items.map((entity) => (
						<div
							key={entity.id}
							className={clsx(
								'w-full',
								// Adjust width: Posters are narrower but taller, Grid cards are wider
								usePoster ? 'sm:w-[240px]' : 'sm:w-[320px]',
								'grow-0 shrink-0'
							)}>
							{usePoster ? (
								<EntityPosterCard entity={entity} config={config} />
							) : (
								<EntityGridCard entity={entity} config={config} context={context} />
							)}
						</div>
					))}
				</div>
			</div>

			{/* SEPARATOR */}
			{isArc && <SectionDivider />}
		</div>
	);
};

--- END OF features\wiki\components\landing\Swimlane.jsx ---

--- FILE: features\wiki\components\navigation\SidebarEmptyState.jsx ---
import { BookOpen } from 'lucide-react';
import EmptyState from '@/shared/components/ui/EmptyState'; // Adjust path

export const SidebarEmptyState = ({ label }) => {
	// Remove 's' from end for singular usage if needed, or just use as is
	const singular = label.endsWith('s') ? label.slice(0, -1) : label;

	return (
		<EmptyState
			icon={BookOpen}
			title={`No ${label} Yet`}
			description={`Create your first ${singular.toLowerCase()} to get started.`}
			className='py-8'
		/>
	);
};

--- END OF features\wiki\components\navigation\SidebarEmptyState.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebar.jsx ---
import { useState } from 'react';
import { clsx } from 'clsx';
import { PanelLeftClose, PanelLeftOpen } from 'lucide-react';
import { WikiSidebarHeader } from './WikiSidebarHeader';
import { WikiSidebarList } from './WikiSidebarList';

export const WikiSidebar = ({ navigation, className }) => {
	const [mobileOpen, setMobileOpen] = useState(false);
	const [desktopCollapsed, setDesktopCollapsed] = useState(false);

	return (
		<>
			{/* COLLAPSED STATE (Slim Bar) */}
			{desktopCollapsed && (
				<div className='hidden lg:flex flex-col h-full border-l border-border bg-muted/50 w-10 shrink-0 z-30 transition-all duration-300 lg:order-2 items-center'>
					<div className='h-14 w-full flex items-center justify-center border-b border-border/50'>
						<button
							onClick={(e) => {
								e.stopPropagation();
								setDesktopCollapsed(false);
							}}
							className='p-1.5 text-muted-foreground hover:text-primary hover:bg-background rounded-md transition-colors'
							title='Expand Sidebar'>
							<PanelLeftClose size={18} />
						</button>
					</div>
				</div>
			)}

			{/* FULL SIDEBAR */}
			<div
				className={clsx(
					'flex flex-col bg-muted border-b border-border',
					'sticky top-0 w-full z-30', // Mobile
					'lg:static lg:border-b-0 lg:h-full lg:transition-all lg:duration-300', // Desktop
					desktopCollapsed
						? 'lg:w-0 lg:border-l-0 lg:overflow-hidden opacity-0 lg:opacity-100'
						: 'lg:w-72 lg:border-l lg:border-border',
					className
				)}>
				<WikiSidebarHeader
					config={navigation.config}
					search={navigation.search}
					onSearchChange={navigation.setSearch}
					onToggle={() => setMobileOpen(!mobileOpen)}
					isOpen={mobileOpen}
					renderDesktopToggle={() => (
						<button
							onClick={(e) => {
								// FIX: Stop propagation to prevent header click logic
								e.stopPropagation();
								setDesktopCollapsed(true);
							}}
							className='text-muted-foreground hover:text-primary transition-colors p-0.5 rounded'
							title='Collapse Sidebar'>
							<PanelLeftOpen size={18} />
						</button>
					)}
				/>

				{/* Content Wrapper */}
				<div
					className={clsx(
						'grid transition-[grid-template-rows] duration-300 ease-[cubic-bezier(0.32,0.72,0,1)]',
						'lg:flex lg:flex-col lg:flex-1 lg:min-h-0',
						mobileOpen ? 'grid-rows-[1fr] border-b border-border shadow-xl' : 'grid-rows-[0fr]'
					)}>
					<div className={clsx('overflow-hidden', 'lg:flex lg:flex-col lg:flex-1 lg:h-auto')}>
						<div
							className={clsx(
								'lg:flex-1 lg:min-h-0 lg:overflow-y-auto custom-scrollbar',
								mobileOpen && 'max-h-[70dvh] overflow-y-auto custom-scrollbar'
							)}>
							<WikiSidebarList
								groups={navigation.groups}
								isLoading={navigation.isLoading}
								hasItems={navigation.hasItems}
								config={navigation.config}
								onItemClick={() => setMobileOpen(false)}
							/>
						</div>
					</div>
				</div>

				{/* Mobile Backdrop */}
				<div
					className={clsx(
						'fixed inset-0 top-[110px] bg-black/40 z-[-1] lg:hidden backdrop-blur-[1px] transition-opacity duration-300',
						mobileOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'
					)}
					onClick={() => setMobileOpen(false)}
					style={{ touchAction: 'none' }}
				/>
			</div>
		</>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebar.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebarHeader.jsx ---
import { Search, ChevronDown, ChevronUp } from 'lucide-react';
import { clsx } from 'clsx';

export const WikiSidebarHeader = ({ config, search, onSearchChange, onToggle, isOpen, renderDesktopToggle }) => {
	const { Icon, label, textClass } = config;

	return (
		<div className='p-3 lg:p-4 bg-muted border-b border-border/50'>
			{/* Title Row */}
			<div
				className={clsx(
					'flex items-center justify-between h-8 select-none',
					// FIX: Pointer cursor only on mobile. Default on desktop to indicate non-clickable.
					'cursor-pointer lg:cursor-default'
				)}
				onClick={(e) => {
					// FIX: Only allow toggle on mobile (width < 1024px)
					if (window.innerWidth < 1024) {
						onToggle();
					}
				}}>
				<div className='flex items-center gap-3 min-w-0 w-full'>
					{Icon && <Icon size={18} className={clsx(textClass, 'shrink-0')} />}
					<h1 className='text-sm font-serif font-bold text-foreground capitalize tracking-wide truncate'>{label}</h1>
					{/* Desktop Toggle Button */}
					{renderDesktopToggle && (
						<div
							className='hidden lg:block shrink-0 ml-auto'
							// FIX: Stop propagation to prevent any parent click handlers
							onClick={(e) => e.stopPropagation()}>
							{renderDesktopToggle()}
						</div>
					)}
				</div>

				{/* Mobile Toggle Button */}
				<button
					className='lg:hidden text-muted-foreground hover:text-foreground active:bg-black/10 p-2 -mr-2 rounded-md transition-colors'
					aria-label={isOpen ? 'Collapse' : 'Expand'}>
					{isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
				</button>
			</div>

			{/* Search Bar */}
			<div className={clsx('mt-3 relative', !isOpen && 'hidden lg:block')}>
				<Search className='absolute left-3 top-2.5 text-muted-foreground/70' size={14} />
				<input
					type='text'
					placeholder='Filter list...'
					value={search}
					onChange={(e) => onSearchChange(e.target.value)}
					onClick={(e) => e.stopPropagation()}
					className='w-full bg-background border border-border rounded-md pl-9 pr-3 py-2 text-base lg:text-xs focus:ring-1 focus:ring-primary/50 focus:border-primary outline-none transition-shadow shadow-sm'
				/>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebarHeader.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebarList.jsx ---
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { SidebarEmptyState } from './SidebarEmptyState';
import { CollapsibleGroup } from './sidebar/CollapsibleGroup';
import { EntityListItem } from './sidebar/EntityListItem';
import { SidebarTreeItem } from './sidebar/SidebarTreeItem';

export const WikiSidebarList = ({ groups, isLoading, hasItems, config, onItemClick }) => {
	if (isLoading) {
		return (
			<div className='p-8 flex justify-center'>
				<LoadingSpinner size='sm' text='Loading...' />
			</div>
		);
	}

	if (!hasItems) {
		return <SidebarEmptyState label={config.label} />;
	}

	const totalItems = groups.reduce((acc, g) => acc + g.items.length, 0);
	if (totalItems === 0) {
		return <div className='p-6 text-center text-xs text-muted-foreground/70 italic'>No matches found.</div>;
	}

	const isGrouped = !groups[0].isTree && (groups.length > 1 || (groups.length === 1 && groups[0].title !== null));

	return (
		// FIX: Removed 'pb-10'. The parent flex container handles the scroll bounds now.
		// Added 'pb-2' just for a tiny bit of visual breathing room at the very end.
		<div className='bg-muted py-1 pb-2'>
			{/* MODE 1: TREE (Recursive) */}
			{groups[0].isTree ? (
				<div className='px-1 space-y-0.5'>
					{groups[0].items.map((item) => (
						<SidebarTreeItem key={item.id} item={item} onItemClick={onItemClick} />
					))}
				</div>
			) : /* MODE 2: GROUPED (Collapsible Categories) */
			isGrouped ? (
				<div className='space-y-1'>
					{groups.map((group) => (
						<CollapsibleGroup key={group.id} group={group} onItemClick={onItemClick} />
					))}
				</div>
			) : (
				/* MODE 3: FLAT LIST */
				<div className='px-2 space-y-0.5'>
					{groups[0].items.map((item) => {
						const showStatus = ['npc', 'faction', 'quest'].includes(item.type);
						return <EntityListItem key={item.id} item={item} showStatus={showStatus} onItemClick={onItemClick} />;
					})}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebarList.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\CollapsibleGroup.jsx ---
import { useState } from 'react';
import { ChevronRight, ChevronDown } from 'lucide-react';
import { EntityListItem } from './EntityListItem';

export const CollapsibleGroup = ({ group, onItemClick }) => {
	const [isOpen, setIsOpen] = useState(true);

	// Determine if we should show status icons
	const showStatus = group.items.some((item) => ['npc', 'faction', 'quest'].includes(item.type));

	return (
		<div className='select-none'>
			{/* Group Header - Collapsible */}
			<button
				onClick={() => setIsOpen(!isOpen)}
				className='w-full flex items-center gap-1.5 px-2 py-1 text-[11px] font-semibold uppercase tracking-wider text-muted-foreground hover:text-foreground/80 hover:bg-black/5 transition-colors'>
				{isOpen ? <ChevronDown size={12} /> : <ChevronRight size={12} />}
				<span className='truncate'>{group.title}</span>
				<span className='ml-auto text-[10px] font-normal text-muted-foreground/70'>{group.items.length}</span>
			</button>

			{/* Items */}
			{isOpen && (
				<div className='space-y-0.5 pb-1'>
					{group.items.map((item) => (
						<EntityListItem key={item.id} item={item} showStatus={showStatus} onItemClick={onItemClick} />
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\sidebar\CollapsibleGroup.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\EntityListItem.jsx ---
import { NavLink } from 'react-router-dom';
import { clsx } from 'clsx';
import { StatusIcon } from './StatusIcon';
import { PriorityIcon } from './PriorityIcon';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { resolveEntityIcon } from '@/domain/entity/config/entityIcons'; // Import Central Config

export const EntityListItem = ({ item, showStatus, onItemClick }) => {
	const isQuest = item.type === 'quest';
	const hasPriority = isQuest && item.meta.priority;

	const iconUrl = resolveImageUrl(item.attributes, 'icon');
	const hasCustomIcon = !!iconUrl;

	// Use Centralized Resolver
	const ResolvedIcon = resolveEntityIcon({ type: item.type, attributes: item.attributes });

	// Determine if we show the icon.
	const shouldShowIcon = hasCustomIcon || !['quest', 'faction'].includes(item.type);

	return (
		<NavLink
			to={item.path}
			onClick={onItemClick}
			className={({ isActive }) =>
				clsx(
					'group flex items-center w-full text-left pl-6 pr-2 py-1 text-[13px] transition-colors',
					// FIX: Replaced 'bg-accent/10' with 'bg-primary/10' and text color for visibility
					isActive
						? 'bg-primary/10 text-primary font-bold'
						: 'text-foreground/80 hover:bg-black/5 hover:text-foreground'
				)
			}>
			{shouldShowIcon && (
				<span
					className={clsx(
						'shrink-0 flex items-center justify-center mr-2',
						!hasCustomIcon && 'opacity-70 text-muted-foreground',
						// Ensure icon inherits color when active
						hasCustomIcon ? '' : 'group-[.active]:text-primary'
					)}>
					{hasCustomIcon ? (
						<EntityIcon type={item.type} customIconUrl={iconUrl} size={16} className='rounded-full object-cover' />
					) : (
						<ResolvedIcon size={14} />
					)}
				</span>
			)}

			{showStatus && (
				<span
					className={clsx(
						'flex-shrink-0 flex items-center justify-center opacity-70',
						hasPriority ? 'mr-1' : 'mr-2',
						!shouldShowIcon && 'ml-[-2px]'
					)}>
					<StatusIcon entity={item} />
				</span>
			)}

			{hasPriority && (
				<span className='mr-2 flex-shrink-0 flex items-center justify-center opacity-90'>
					<PriorityIcon priority={item.meta.priority} />
				</span>
			)}

			<span className='truncate flex-1'>{item.name}</span>
		</NavLink>
	);
};

--- END OF features\wiki\components\navigation\sidebar\EntityListItem.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\PriorityIcon.jsx ---
import { ChevronUp, ChevronsUp, ChevronsDown, Minus, AlertCircle } from 'lucide-react';

export const PriorityIcon = ({ priority }) => {
	if (!priority) return null;
	const p = priority.toLowerCase();

	// Critical
	if (p.includes('critical')) {
		return <ChevronsUp size={14} className='text-orange-600' strokeWidth={3} />;
	}

	// High / Urgent
	if (p.includes('high')) {
		return <ChevronUp size={14} className='text-orange-600' strokeWidth={3} />;
	}

	// Low
	if (p.includes('low')) {
		return <ChevronsDown size={14} className='text-slate-400' strokeWidth={3} />;
	}

	// Medium / Normal
	if (p.includes('medium') || p.includes('normal')) {
		return <Minus size={14} className='text-blue-400' strokeWidth={3} />;
	}

	return null;
};

--- END OF features\wiki\components\navigation\sidebar\PriorityIcon.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\SidebarTreeItem.jsx ---
import { useState } from 'react';
import { NavLink } from 'react-router-dom';
import { ChevronRight, ChevronDown } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { StatusIcon } from './StatusIcon';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { resolveEntityIcon } from '@/domain/entity/config/entityIcons'; // Import

export const SidebarTreeItem = ({ item, onItemClick }) => {
	const [isExpanded, setIsExpanded] = useState(true);
	const hasChildren = item.children && item.children.length > 0;
	const showStatus = ['npc', 'faction', 'quest'].includes(item.type);

	const iconUrl = resolveImageUrl(item.attributes, 'icon');
	const hasCustomIcon = !!iconUrl;

	// Use centralized resolver
	const ResolvedIcon = resolveEntityIcon({ type: item.type, attributes: item.attributes });

	return (
		<div className='select-none font-sans'>
			<div className='flex items-center w-full group py-0.5 hover:bg-black/5 rounded-sm transition-colors'>
				<button
					onClick={(e) => {
						e.preventDefault();
						e.stopPropagation();
						if (hasChildren) setIsExpanded(!isExpanded);
					}}
					className={clsx(
						'w-5 h-6 flex items-center justify-center shrink-0 text-muted-foreground/70 hover:text-foreground transition-colors cursor-pointer',
						!hasChildren && 'invisible pointer-events-none'
					)}>
					{isExpanded ? <ChevronDown size={10} /> : <ChevronRight size={10} />}
				</button>

				<NavLink
					to={item.path}
					onClick={onItemClick}
					className={({ isActive }) =>
						clsx(
							'flex-1 flex items-center gap-1.5 pr-2 text-[13px] truncate transition-colors rounded-r-sm',
							isActive ? 'text-primary font-bold bg-primary/10' : 'text-foreground/80'
						)
					}>
					<span
						className={clsx(
							'shrink-0 flex items-center justify-center',
							!hasCustomIcon && 'opacity-100',
							// Ensure icon inherits color when active
							!hasCustomIcon && (item.type === 'location' ? 'text-muted-foreground' : 'text-muted-foreground')
						)}>
						{hasCustomIcon ? (
							<EntityIcon type={item.type} customIconUrl={iconUrl} size={14} />
						) : (
							<ResolvedIcon size={14} strokeWidth={2} />
						)}
					</span>

					<span className='truncate'>{item.name}</span>
					{showStatus && (
						<span className='ml-auto opacity-70 flex items-center'>
							<StatusIcon entity={item} />
						</span>
					)}
				</NavLink>
			</div>
			{isExpanded && hasChildren && (
				<div className='ml-[9px] border-l border-border/60 pl-1'>
					{item.children.map((child) => (
						<SidebarTreeItem key={child.id} item={child} onItemClick={onItemClick} />
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\sidebar\SidebarTreeItem.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\StatusIcon.jsx ---
import { getStatusIcon } from '@/domain/entity/utils/statusUtils';

/**
 * StatusIcon Component
 * Displays status/affinity icon for entities in sidebar
 *
 * @param {Object} entity - Entity with status/affinity
 */
export const StatusIcon = ({ entity }) => {
	// Prioritize affinity over status for NPCs/Factions
	const statusValue = entity.affinity && entity.affinity !== 'unknown' ? entity.affinity : entity.status;

	const { Icon, className } = getStatusIcon(statusValue, entity.type);

	return <Icon size={12} className={className} strokeWidth={2.5} />;
};

--- END OF features\wiki\components\navigation\sidebar\StatusIcon.jsx ---

--- FILE: features\wiki\config\groupingConfig.js ---
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const GROUPING_CONFIG = {
	location: {
		mode: 'tree',
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
	encounter: {
		mode: 'tree',
		sortItems: (a, b) => {
			if (a.type !== b.type) {
				if (a.type === 'location') return -1;
				if (b.type === 'location') return 1;
			}
			return a.name.localeCompare(b.name);
		},
	},
	npc: {
		mode: 'tree',
		sortItems: (a, b) => {
			if (a.type !== b.type) {
				if (a.type === 'location') return -1;
				if (b.type === 'location') return 1;
			}
			if (a.type === 'npc' && b.type === 'npc') {
				const rankDiff = a.meta.affinityRank - b.meta.affinityRank;
				if (rankDiff !== 0) return rankDiff;
			}
			return a.name.localeCompare(b.name);
		},
	},
	session: {
		// Group by Arc ID
		groupBy: (item, context) => {
			if (context?.sessionArcMap) {
				const arcId = context.sessionArcMap.get(item.id);
				if (arcId) return arcId;
			}
			return 'ungrouped';
		},

		// Map View Data to UI Props
		getGroupMeta: (arcId, context) => {
			if (arcId === 'ungrouped') return { title: 'Uncharted / Side Adventures', order: 9999 };

			const arc = context?.arcs?.find((a) => a.id === arcId);
			if (!arc) return { title: 'Unknown Arc', order: 9998 };

			return {
				title: arc.title,
				description: arc.description,
				order: arc.order,
				type: arc.arc_type, // Maps SQL 'arc_type'
				stats: {
					npcs: arc.npc_count,
					locations: arc.location_count,
					quests: arc.quest_count,
					encounters: arc.encounter_count,
				},
			};
		},

		sortGroups: (ids, context) => {
			return ids.sort((a, b) => {
				if (a === 'ungrouped') return 1;
				if (b === 'ungrouped') return -1;
				const arcA = context?.arcs?.find((x) => x.id === a);
				const arcB = context?.arcs?.find((x) => x.id === b);
				return (arcA?.order || 999) - (arcB?.order || 999);
			});
		},

		sortItems: (a, b) => {
			const numA = Number(a.attributes?.session_number || 0);
			const numB = Number(b.attributes?.session_number || 0);
			if (numA !== 0 || numB !== 0) return numA - numB;
			return a.name.localeCompare(b.name);
		},
	},
	faction: {
		groupBy: (item) => {
			const rank = item.meta.affinityRank;
			if (rank === 1) return 'Allies';
			if (rank === 2) return 'Neutral';
			if (rank === 3) return 'Enemies';
			return 'Unknown';
		},
		sortGroups: ['Allies', 'Neutral', 'Enemies', 'Unknown'],
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
	quest: {
		groupBy: (item) => {
			const t = item.meta.questType.toLowerCase();
			if (t.includes('main')) return 'Main Quest';
			if (t.includes('personal')) return 'Personal Quest';
			return 'Side Quest';
		},
		sortGroups: ['Main Quest', 'Personal Quest', 'Side Quest'],
		sortItems: (a, b) => {
			const statusOrder = ['active', 'in progress', 'pending', 'completed', 'success', 'failed', 'abandoned'];
			const idxA = statusOrder.indexOf(a.meta.status);
			const idxB = statusOrder.indexOf(b.meta.status);
			const valA = idxA === -1 ? 99 : idxA;
			const valB = idxB === -1 ? 99 : idxB;
			if (valA !== valB) return valA - valB;
			return a.name.localeCompare(b.name);
		},
	},
	item: {
		// <--- ADDED
		// Group items by their 'type' attribute (e.g. Weapon, Armor), or 'General' if missing
		groupBy: (item) => {
			const type = getAttributeValue(item.attributes, ['type', 'item_type', 'category']);
			return type ? type.charAt(0).toUpperCase() + type.slice(1) : 'General';
		},
		sortGroups: (keys) => keys.sort(), // Alphabetical groups
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
};

--- END OF features\wiki\config\groupingConfig.js ---

--- FILE: features\wiki\config\viewStrategies.js ---
import { MapPin, Flag, Circle, Swords, Users, Archive, LayoutGrid, Folder } from 'lucide-react';

export const VIEW_STRATEGIES = {
	location: { mode: 'geo' },
	encounter: { mode: 'geo' },
	npc: { mode: 'geo' },
	faction: { mode: 'category' },
	quest: { mode: 'category' },
	character: { mode: 'flat' },
	item: { mode: 'flat' },
	session: { mode: 'category' },
};

// Recursive Flattening
const flattenGeoTree = (nodes, targetType, parentName = 'Uncharted', visitedIds) => {
	let lanes = [];
	const directItems = [];

	nodes.forEach((node) => {
		if (node.children && node.children.length > 0) {
			const childLanes = flattenGeoTree(node.children, targetType, node.name, visitedIds);
			const myContent = childLanes.find((l) => l.title === null);

			if (myContent && myContent.items.length > 0) {
				lanes.push({
					id: node.id,
					title: node.name,
					parentTitle: parentName,
					link: `/wiki/${node.type}/${node.id}`,
					items: myContent.items,
					description: node.fullDescription || node.description,
				});
			}
			lanes = [...lanes, ...childLanes.filter((l) => l.title !== null)];
		}

		if (node.type === targetType) {
			if (!visitedIds.has(node.id)) {
				visitedIds.add(node.id);
				directItems.push(node);
			}
		}
	});

	if (directItems.length > 0) {
		lanes.push({ id: `misc-${parentName}`, title: null, parentTitle: parentName, link: null, items: directItems });
	}
	return lanes;
};

export const getSwimlanes = (groups, normalizedType) => {
	if (groups.length === 0) return [];

	const strategy = VIEW_STRATEGIES[normalizedType] || VIEW_STRATEGIES.location;

	// STRATEGY 1: GEOGRAPHICAL
	if (strategy.mode === 'geo' && groups[0].isTree) {
		const rootItems = groups[0].items;
		const visitedIds = new Set();
		const rawLanes = flattenGeoTree(rootItems, normalizedType, null, visitedIds);
		const rootLane = rawLanes.find((l) => l.title === null);
		const otherLanes = rawLanes.filter((l) => l.title !== null);

		if (rootLane) {
			otherLanes.push({ ...rootLane, title: 'Uncharted entries', id: 'root-ungrouped' });
		}
		return otherLanes;
	}

	// STRATEGY 2: CATEGORICAL
	if (strategy.mode === 'category') {
		return groups.map((g) => ({
			id: g.id,
			title: g.title || 'Other',
			link: null,
			items: g.items,
			description: g.description,
			type: g.type,
			stats: g.stats,
			order: g.order,
		}));
	}

	// STRATEGY 3: FLAT
	if (strategy.mode === 'flat') {
		const allItems = groups.flatMap((g) => g.items).sort((a, b) => a.name.localeCompare(b.name));
		return [
			{
				id: 'all',
				title: 'All Entries',
				link: null,
				items: allItems,
			},
		];
	}

	return [];
};

export const getStrategyMode = (type) => {
	return VIEW_STRATEGIES[type]?.mode || 'flat';
};

--- END OF features\wiki\config\viewStrategies.js ---

--- FILE: features\wiki\hooks\useEntityContent.js ---
import { useMemo } from 'react';
import { isSession } from '@/domain/entity/utils/entityUtils';
import { transformEvents } from '@/features/wiki/utils/eventMapper';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const useEntityContent = (entity, attributes, sections) => {
	return useMemo(() => {
		if (!entity) return null;

		const entityIsSession = isSession(entity);
		const entityIsQuest = entity.type === 'quest';
		const entityIsEncounter = entity.type === 'encounter';

		// Determine main summary
		let mainSummary = attributes.Summary || entity.summary;
		if (!mainSummary && !entityIsSession) {
			mainSummary = entity.description;
		}

		// --- MAP RESOLUTION FIX ---
		// 1. Look ONLY for specific map keys. Do not fallback to 'icon' or 'background'.
		const specificMapPath = getAttributeValue(attributes, ['map_image', 'tactical_map', 'map']);

		// 2. Construct URL if path exists
		const finalMapUrl = specificMapPath ? `${import.meta.env.BASE_URL}${specificMapPath.replace(/^\//, '')}` : null;

		// Transform Events
		const events = transformEvents(entity.events);

		// Extract Mentions (Sessions only)
		const mentions =
			entityIsSession && entity.relationships
				? entity.relationships.reduce((acc, rel) => {
						const type = rel.entity_type?.toLowerCase() || 'other';
						if (!acc[type]) acc[type] = [];
						acc[type].push({
							id: rel.entity_id,
							name: rel.entity_name,
							type: rel.entity_type,
						});
						return acc;
				  }, {})
				: null;

		const levelUp = getAttributeValue(attributes, ['level_up', 'Level Up']);

		return {
			objectives: entityIsQuest ? entity.objectives || [] : null,
			combatRounds: entityIsEncounter ? entity.combatRounds : null,
			narrative: entityIsSession ? entity.description || '' : null,
			summary: mainSummary || '',
			sections: sections || [],
			history: events,
			mentions,
			levelUp,
			mapImageUrl: finalMapUrl,
			mapMarkers: attributes?.map_markers,
		};
	}, [entity, attributes, sections]);
};

--- END OF features\wiki\hooks\useEntityContent.js ---

--- FILE: features\wiki\hooks\useEntityFetching.js ---
import { useQuery } from '@tanstack/react-query';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getEntities, getCampaignArcs } from '@/domain/entity/api/entityService';
import { supabase } from '@/shared/api/supabaseClient'; // Import Supabase directly
import { useMemo } from 'react';

export function useEntityFetching(type) {
	const { campaignId } = useCampaign();
	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Primary Query
	const mainQuery = useQuery({
		queryKey: ['entities', campaignId, normalizedType],
		queryFn: async () => {
			// FIX: If fetching sessions, query the sessions table directly
			// to ensure we get the 'narrative' (mapped to description)
			if (normalizedType === 'session') {
				const { data, error } = await supabase
					.from('sessions')
					.select('id, title, narrative, attributes, created_at')
					.eq('campaign_id', campaignId);

				if (error) throw error;

				// Normalize to Entity shape
				return data.map((s) => ({
					id: s.id,
					type: 'session',
					name: s.title,
					description: s.narrative, // Map narrative to description
					attributes: s.attributes,
					created_at: s.created_at,
				}));
			}

			// Otherwise use the standard service
			return getEntities(campaignId, normalizedType);
		},
		enabled: !!campaignId && !!normalizedType,
		staleTime: 1000 * 60 * 5,
	});

	// 2. Locations (for hierarchy)
	const needsLocations = normalizedType === 'npc' || normalizedType === 'encounter';
	const locationQuery = useQuery({
		queryKey: ['entities', campaignId, 'location'],
		queryFn: () => getEntities(campaignId, 'location'),
		enabled: !!campaignId && needsLocations,
		staleTime: 1000 * 60 * 5,
	});

	// 3. Narrative Arcs
	const needsArcs = normalizedType === 'session';
	const arcQuery = useQuery({
		queryKey: ['entities', campaignId, 'narrative_arc_context'],
		queryFn: () => getCampaignArcs(campaignId),
		enabled: !!campaignId && needsArcs,
		staleTime: 1000 * 60 * 5,
	});

	// 4. Merge
	const { entities, context } = useMemo(() => {
		if (mainQuery.isLoading) return { entities: [], context: {} };

		let data = mainQuery.data || [];

		if (needsLocations && locationQuery.data) {
			const existingIds = new Set(data.map((e) => e.id));
			const newLocations = locationQuery.data.filter((l) => !existingIds.has(l.id));
			data = [...data, ...newLocations];
		}

		const context = {};
		if (needsArcs && arcQuery.data) {
			context.arcs = arcQuery.data.arcs;
			const sessionArcMap = new Map();
			(arcQuery.data.rels || []).forEach((r) => {
				sessionArcMap.set(r.from_entity_id, r.to_entity_id);
			});
			context.sessionArcMap = sessionArcMap;
		}

		return { entities: data, context };
	}, [mainQuery.data, locationQuery.data, arcQuery.data, needsLocations, needsArcs, mainQuery.isLoading]);

	return {
		entities,
		context,
		isLoading: mainQuery.isLoading || (needsLocations && locationQuery.isLoading) || (needsArcs && arcQuery.isLoading),
		error: mainQuery.error || locationQuery.error,
	};
}

--- END OF features\wiki\hooks\useEntityFetching.js ---

--- FILE: features\wiki\hooks\useEntityGrouping.js ---
import { useMemo } from 'react';
import { GROUPING_CONFIG } from '@/features/wiki/config/groupingConfig';
import { transformEntityToViewModel } from '@/features/wiki/utils/wikiUtils';

// Helper to build hierarchy trees (unchanged)
const buildTree = (items, sortFn) => {
	const idMap = new Map();
	const roots = [];
	items.forEach((item) => idMap.set(item.id, { ...item, children: [] }));
	items.forEach((item) => {
		const node = idMap.get(item.id);
		const parentId = item.meta.parentId;
		if (parentId && idMap.has(parentId)) {
			idMap.get(parentId).children.push(node);
		} else {
			roots.push(node);
		}
	});

	const prune = (nodes) => {
		const hasMixedTypes = items.some((i) => i.type !== 'location');
		if (!hasMixedTypes) return nodes;

		return nodes.filter((node) => {
			if (node.children.length > 0) {
				node.children = prune(node.children);
			}
			if (node.type === 'location' && node.children.length === 0) {
				return false;
			}
			return true;
		});
	};

	let finalRoots = prune(roots);

	const sortRecursive = (nodes) => {
		if (sortFn) nodes.sort(sortFn);
		nodes.forEach((node) => {
			if (node.children.length > 0) {
				sortRecursive(node.children);
			}
		});
	};

	sortRecursive(finalRoots);
	return finalRoots;
};

export function useEntityGrouping(entities, type, searchQuery = '', context = {}) {
	return useMemo(() => {
		if (!entities || entities.length === 0) return [];

		const filtered = searchQuery
			? entities.filter((e) => e.name.toLowerCase().includes(searchQuery.toLowerCase()))
			: entities;

		const items = filtered.map((entity) => transformEntityToViewModel(entity, type));
		const strategy = GROUPING_CONFIG[type];

		// TREE STRATEGY
		if (strategy?.mode === 'tree') {
			const treeRoots = buildTree(items, strategy.sortItems);
			return [
				{
					id: 'root',
					title: null,
					items: treeRoots,
					isTree: true,
				},
			];
		}

		// CATEGORY STRATEGY
		if (strategy && strategy.groupBy) {
			const grouped = {};
			const metadataMap = new Map(); // Store metadata for the group keys

			items.forEach((item) => {
				const groupKey = strategy.groupBy(item, context) || 'General';

				if (!grouped[groupKey]) {
					grouped[groupKey] = [];
					// If the strategy provides a way to get metadata for this key, fetch it
					if (strategy.getGroupMeta) {
						metadataMap.set(groupKey, strategy.getGroupMeta(groupKey, context));
					}
				}
				grouped[groupKey].push(item);
			});

			let groupKeys = Object.keys(grouped);

			// Handle Sorting Groups
			if (typeof strategy.sortGroups === 'function') {
				groupKeys = strategy.sortGroups(groupKeys, context);
			} else if (Array.isArray(strategy.sortGroups)) {
				groupKeys.sort((a, b) => {
					const idxA = strategy.sortGroups.indexOf(a);
					const idxB = strategy.sortGroups.indexOf(b);
					const valA = idxA === -1 ? 999 : idxA;
					const valB = idxB === -1 ? 999 : idxB;
					return valA - valB || a.localeCompare(b);
				});
			} else {
				groupKeys.sort();
			}

			return groupKeys.map((key) => {
				const groupItems = grouped[key];
				const meta = metadataMap.get(key) || {};

				if (typeof strategy.sortItems === 'function') {
					groupItems.sort(strategy.sortItems);
				} else {
					groupItems.sort((a, b) => a.name.localeCompare(b.name));
				}

				return {
					id: key,
					title: meta.title || key,
					description: meta.description || null,
					order: meta.order || 999,
					type: meta.type || null,
					stats: meta.stats || null,
					items: groupItems,
				};
			});
		}

		// FLAT STRATEGY
		return [
			{
				id: 'all',
				title: null,
				items: items.sort((a, b) => a.name.localeCompare(b.name)),
			},
		];
	}, [entities, type, searchQuery, context]);
}

--- END OF features\wiki\hooks\useEntityGrouping.js ---

--- FILE: features\wiki\hooks\useEntityHeader.js ---
import { useMemo } from 'react';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import { extractHeaderTags } from '@/features/wiki/utils/attributeMapper';
import { capitalize } from '@/shared/utils/textUtils';

export const useEntityHeader = (entity, attributes) => {
	return useMemo(() => {
		if (!entity) return null;

		const config = getEntityConfig(entity.type);
		const headerBackgroundUrl = resolveImageUrl(attributes, 'background');
		const avatarUrl = resolveImageUrl(attributes, 'icon');

		// Status
		let statusRaw = entity.status || getAttributeValue(attributes, ['status']);
		if (Array.isArray(statusRaw)) statusRaw = statusRaw.join(', ');

		// Priority
		const priorityRaw = getAttributeValue(attributes, ['priority', 'Priority']);

		// Extra Tags
		const extraTags = extractHeaderTags(attributes, entity.type);

		// --- NEW: Character Subtitle Logic ---
		let subtitle = null;
		if (entity.type === 'character') {
			const race = attributes.race || 'Unknown Race';
			const cls = attributes.class || 'Unknown Class';
			const level = attributes.level ? `Level ${attributes.level}` : '';
			// Format: "Earth Genasi  Fighter Echo Knight  Level 8"
			subtitle = [race, cls, level].filter(Boolean).join('  ');
		}

		return {
			title: entity.name,
			subtitle, // Pass the new subtitle
			typeLabel: entity.type?.toUpperCase(),
			imageUrl: headerBackgroundUrl,
			avatarUrl: avatarUrl,
			status: {
				hasStatus: !!statusRaw,
				label: statusRaw ? capitalize(String(statusRaw)) : '',
				isDead: statusRaw?.toLowerCase() === 'dead' || statusRaw?.toLowerCase() === 'failed',
			},
			priority: priorityRaw ? capitalize(priorityRaw) : null,
			extraTags,
			type: entity.type,
			theme: {
				...config.tailwind,
				Icon: config.icon,
			},
		};
	}, [entity, attributes]);
};

--- END OF features\wiki\hooks\useEntityHeader.js ---

--- FILE: features\wiki\hooks\useEntitySidebar.js ---
/**
 * useEntitySidebar Hook
 * Builds sidebar view model from entity data
 */

import { useMemo } from 'react';
import { transformRelationships } from '@/features/wiki/utils/relationshipMapper';

/**
 * Build sidebar view model
 * @param {Object} entity - Raw entity data
 * @param {Array} traits - Traits from attribute transform
 * @returns {Object} Sidebar view model
 */
export const useEntitySidebar = (entity, traits) => {
	return useMemo(() => {
		if (!entity) return null;

		const connections = transformRelationships(entity.relationships, 50);

		return {
			traits: traits || [],
			connections,
		};
	}, [entity, traits]);
};

--- END OF features\wiki\hooks\useEntitySidebar.js ---

--- FILE: features\wiki\layouts\CharacterLayout.jsx ---
import { useState, useMemo } from 'react';
import { User, Network, History as HistoryIcon, BookOpen, Info, X } from 'lucide-react';
import { Drawer } from 'vaul';
import TabContainer from '@/shared/components/layout/TabContainer';
import { EntityBody, EntityHistory } from '@/features/wiki/components/EntityBody';
import { CharacterSidebar } from '@/features/wiki/components/character/CharacterSidebar';
import { CharacterStats } from '@/features/wiki/components/character/CharacterStats';
import { RelationshipNetwork } from '@/features/wiki/components/character/RelationshipNetwork';
import { extractHeaders } from '@/shared/utils/markdownUtils';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { EntityLocalGraph } from '@/features/wiki/components/EntityLocalGraph'; // Import

export default function CharacterLayout({ viewModel }) {
	const { raw } = viewModel;
	const [activeTab, setActiveTab] = useState('bio');

	const gear = useMemo(() => (raw.relationships || []).filter((r) => r.entity_type === 'item'), [raw.relationships]);
	const personalQuests = useMemo(
		() =>
			(raw.relationships || []).filter(
				(r) => r.entity_type === 'quest' && ['quest_giver', 'quest_participant'].includes(r.type)
			),
		[raw.relationships]
	);

	// TOC for Bio
	const tocItems = useMemo(() => {
		if (activeTab === 'bio' && viewModel.content.summary) {
			return extractHeaders(viewModel.content.summary);
		}
		return [];
	}, [activeTab, viewModel.content.summary]);

	// --- TAB 1: BIOGRAPHY ---
	const renderBio = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-6xl mx-auto'>
				{/* 1. HERO STATS (Bio Exclusive) */}
				<CharacterStats attributes={raw.attributes} />

				{/* 2. SPLIT LAYOUT */}
				<div className='grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-8 xl:gap-12'>
					{/* Desktop Sidebar (Hidden on Mobile) */}
					<div className='hidden lg:block lg:order-first min-w-0'>
						<CharacterSidebar attributes={raw.attributes} gear={gear} quests={personalQuests} />
					</div>

					{/* Content */}
					<div className='min-w-0 flex gap-8'>
						<div className='flex-1 min-w-0'>
							<EntityBody summary={viewModel.content.summary} sections={viewModel.content.sections} history={null} />
						</div>
						{tocItems.length > 0 && (
							<div className='hidden xl:block w-56 shrink-0 sticky top-4 border-l border-border pl-4 h-fit'>
								<TableOfContents items={tocItems} />
							</div>
						)}
					</div>
				</div>
			</div>
		</div>
	);

	// --- TAB 2: NETWORK ---
	const renderNetwork = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-6xl mx-auto'>
				{/* NEW: Graph Section */}
				{raw.relationships && raw.relationships.length > 0 && (
					<div className='mb-10'>
						<EntityLocalGraph entity={raw} relationships={raw.relationships} height='h-[400px]' className='mb-8' />
					</div>
				)}
				<RelationshipNetwork relationships={raw.relationships} />
			</div>
		</div>
	);

	// --- TAB 3: CHRONICLE ---
	const renderChronicle = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-4xl mx-auto space-y-10'>
				{personalQuests.length > 0 && (
					<div>
						<h3 className='text-xs font-bold font-sans uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2 border-b border-border pb-2'>
							<BookOpen size={14} /> Personal Quests
						</h3>
						<div className='grid gap-2'>
							{personalQuests.map((q) => (
								<div
									key={q.entity_id}
									className='p-3 border border-border rounded bg-card flex justify-between items-center'>
									<span className='font-bold text-sm text-foreground'>{q.entity_name}</span>
									<span className='text-[10px] uppercase font-bold text-muted-foreground bg-muted px-2 py-0.5 rounded'>
										{q.type.replace(/_/g, ' ')}
									</span>
								</div>
							))}
						</div>
					</div>
				)}
				<div>
					<h3 className='text-xs font-bold font-sans uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2 border-b border-border pb-2'>
						<HistoryIcon size={14} /> Timeline
					</h3>
					<EntityHistory events={viewModel.content.history} fullHeight />
				</div>
			</div>
		</div>
	);

	// --- ROOT RENDER ---
	return (
		<div className='w-full bg-background min-h-screen relative'>
			<TabContainer
				tabs={[
					{ id: 'bio', label: 'Biography', icon: User, content: renderBio() },
					{ id: 'network', label: 'Network', icon: Network, content: renderNetwork() },
					{ id: 'chronicle', label: 'Chronicle', icon: HistoryIcon, content: renderChronicle() },
				]}
				defaultTab={activeTab}
				onChange={setActiveTab}
			/>

			{/* MOBILE INFO DRAWER */}
			<div className='lg:hidden'>
				<Drawer.Root shouldScaleBackground>
					<Drawer.Trigger asChild>
						<button className='fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 bg-background text-foreground border border-border rounded-full shadow-2xl font-bold text-xs uppercase tracking-wider active:scale-95 transition-transform hover:border-primary/50'>
							<Info size={18} />
							<span>Info</span>
						</button>
					</Drawer.Trigger>

					<Drawer.Portal>
						<Drawer.Overlay className='fixed inset-0 bg-black/60 z-[60] backdrop-blur-[2px]' />
						<Drawer.Content className='bg-background flex flex-col rounded-t-[10px] h-[85vh] mt-24 fixed bottom-0 left-0 right-0 z-[60] focus:outline-none border-t border-border'>
							{/* Drag Handle & Header */}
							<div className='p-4 bg-muted/30 rounded-t-[10px] flex-shrink-0 border-b border-border'>
								<div className='mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-muted-foreground/30 mb-4' />
								<div className='flex justify-between items-center'>
									<Drawer.Title className='font-serif font-bold text-xl text-foreground'>
										Character Details
									</Drawer.Title>
									<Drawer.Close className='p-2 bg-muted/50 hover:bg-muted rounded-full text-muted-foreground transition-colors'>
										<X size={18} />
									</Drawer.Close>
								</div>
							</div>

							{/* Content */}
							<div className='p-4 overflow-y-auto custom-scrollbar flex-1'>
								<CharacterSidebar attributes={raw.attributes} gear={gear} quests={personalQuests} />
							</div>
						</Drawer.Content>
					</Drawer.Portal>
				</Drawer.Root>
			</div>
		</div>
	);
}

--- END OF features\wiki\layouts\CharacterLayout.jsx ---

--- FILE: features\wiki\layouts\SessionLayout.jsx ---
import { useMemo } from 'react';
import { useSearchParams } from 'react-router-dom';
import { BookOpen, History, Network } from 'lucide-react';
import TabContainer from '@/shared/components/layout/TabContainer';
import { EntityBody, EntityHistory } from '@/features/wiki/components/EntityBody';
import { SessionMentions } from '@/features/wiki/components/SessionMentions';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { extractHeaders } from '@/shared/utils/markdownUtils';
import { ThreeColumnLayout } from '@/shared/components/layout/SplitView';
import { EntityLocalGraph } from '@/features/wiki/components/EntityLocalGraph'; // Import

export default function SessionLayout({ viewModel }) {
	const [searchParams, setSearchParams] = useSearchParams();
	const activeTab = searchParams.get('tab') || 'narrative';

	const setActiveTab = (tabId) => {
		setSearchParams(
			(prev) => {
				prev.set('tab', tabId);
				return prev;
			},
			{ replace: true }
		);
	};

	const tocItems = useMemo(() => {
		if (viewModel.content.narrative) {
			return extractHeaders(viewModel.content.narrative);
		}
		return [];
	}, [viewModel.content.narrative]);

	if (!viewModel) return null;

	const renderNarrative = () => (
		<ThreeColumnLayout
			left={null}
			center={
				<div className='max-w-3xl mx-auto px-4 sm:px-6 py-10'>
					<EntityBody
						summary={viewModel.content.narrative}
						sections={[]}
						history={null}
						levelUp={viewModel.content.levelUp}
					/>
				</div>
			}
			right={
				tocItems.length > 0 ? (
					<TableOfContents
						items={tocItems}
						className='ml-4'
						visibilityClass='hidden min-[1650px]:block'
						mobileToggleClass='min-[1650px]:hidden'
					/>
				) : null
			}
		/>
	);

	const renderMentions = () => (
		<div className='max-w-6xl mx-auto px-4 sm:px-6 py-10'>
			{/* NEW: Graph Section */}
			{viewModel.raw.relationships && viewModel.raw.relationships.length > 0 && (
				<div className='mb-10 max-w-6xl mx-auto'>
					<EntityLocalGraph entity={viewModel.raw} relationships={viewModel.raw.relationships} height='h-[350px]' />
				</div>
			)}
			<SessionMentions mentions={viewModel.content.mentions} />
		</div>
	);

	const renderTimeline = () => (
		<div className='max-w-3xl mx-auto px-4 sm:px-6 py-10'>
			<EntityHistory events={viewModel.content.history} fullHeight={true} />
		</div>
	);

	return (
		<>
			<TabContainer
				tabs={[
					{
						id: 'narrative',
						label: 'Narrative',
						icon: BookOpen,
						content: renderNarrative(),
					},
					{
						id: 'mentions',
						label: 'Mentions',
						icon: Network,
						content: renderMentions(),
					},
					{
						id: 'events',
						label: 'Timeline',
						icon: History,
						content: renderTimeline(),
					},
				]}
				defaultTab={activeTab}
				sticky
				onChange={setActiveTab}
			/>

			{tocItems.length > 0 && activeTab === 'narrative' && (
				<div className='xl:hidden'>
					<TableOfContents items={tocItems} />
				</div>
			)}
		</>
	);
}

--- END OF features\wiki\layouts\SessionLayout.jsx ---

--- FILE: features\wiki\layouts\StandardLayout.jsx ---
import { Drawer } from 'vaul';
import { Info, X } from 'lucide-react';
import { EntitySidebar } from '@/features/wiki/components/EntitySidebar';
import { EntityBody } from '@/features/wiki/components/EntityBody';

export default function StandardLayout({ viewModel }) {
	if (!viewModel) return null;

	return (
		<div className='w-full px-4 sm:px-6 py-10'>
			<div className='max-w-6xl mx-auto'>
				<div className='grid grid-cols-1 lg:grid-cols-[260px_1fr] xl:grid-cols-[280px_1fr] gap-4 lg:gap-6 xl:gap-8'>
					{/* --- DESKTOP SIDEBAR (Hidden on Mobile) --- */}
					<div className='hidden lg:block lg:order-first min-w-0'>
						<EntitySidebar
							entity={viewModel.raw}
							traits={viewModel.sidebar.traits}
							connections={viewModel.sidebar.connections}
						/>
					</div>

					{/* --- MAIN CONTENT --- */}
					<div className='min-w-0 pb-20'>
						<EntityBody
							summary={viewModel.content.summary}
							sections={viewModel.content.sections}
							history={viewModel.content.history}
							objectives={viewModel.content.objectives}
							combatRounds={viewModel.content.combatRounds}
							mapImageUrl={viewModel.content.mapImageUrl}
							mapMarkers={viewModel.content.mapMarkers}
						/>
					</div>
				</div>
			</div>

			{/* --- MOBILE BOTTOM SHEET --- */}
			<div className='lg:hidden'>
				<Drawer.Root shouldScaleBackground>
					<Drawer.Trigger asChild>
						<button className='fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 bg-background text-foreground border border-border rounded-full shadow-2xl font-bold text-xs uppercase tracking-wider active:scale-95 transition-transform'>
							<Info size={18} />
							<span>Info</span>
						</button>
					</Drawer.Trigger>

					<Drawer.Portal>
						<Drawer.Overlay className='fixed inset-0 bg-black/40 z-50 backdrop-blur-[2px]' />
						<Drawer.Content className='bg-background flex flex-col rounded-t-[10px] h-[85vh] mt-24 fixed bottom-0 left-0 right-0 z-50 focus:outline-none border-t border-border'>
							{/* Drag Handle */}
							<div className='p-4 bg-muted/50 rounded-t-[10px] flex-shrink-0'>
								<div className='mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-gray-300 mb-4' />
								<div className='flex justify-between items-center'>
									<Drawer.Title className='font-serif font-bold text-xl'>Details & Stats</Drawer.Title>
									<Drawer.Close className='p-2 bg-muted rounded-full text-muted-foreground'>
										<X size={16} />
									</Drawer.Close>
								</div>
							</div>

							{/* Content */}
							<div className='p-4 bg-background flex-1 overflow-y-auto custom-scrollbar'>
								<EntitySidebar
									entity={viewModel.raw}
									traits={viewModel.sidebar.traits}
									connections={viewModel.sidebar.connections}
								/>
							</div>
						</Drawer.Content>
					</Drawer.Portal>
				</Drawer.Root>
			</div>
		</div>
	);
}

--- END OF features\wiki\layouts\StandardLayout.jsx ---

--- FILE: features\wiki\pages\WikiDetailPage.jsx ---
import { useParams } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { getWikiEntry } from '@/features/wiki/api/wikiService';
import { transformWikiEntry } from '@/features/wiki/utils/wikiEntryMapper'; // Import transform
import WikiEntityView from '@/features/wiki/components/WikiEntryView';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export default function WikiEntryPage() {
	const { type, entityId } = useParams();
	const normalizedType = type === 'sessions' ? 'session' : type;

	const {
		data: entity,
		isLoading,
		error,
	} = useQuery({
		queryKey: ['entry', normalizedType, entityId],
		queryFn: () => getWikiEntry(entityId, normalizedType),
		select: (res) => transformWikiEntry(res.data, res.type, res.additional),
		enabled: !!entityId && !!normalizedType,
		retry: 1,
	});

	if (isLoading) return <LoadingSpinner className='h-full min-h-[50vh]' text='Loading Entry...' />;
	if (error)
		return (
			<div className='p-8 text-center text-red-600'>
				<p>Failed to load entry</p>
			</div>
		);

	return <WikiEntityView entity={entity} />;
}

--- END OF features\wiki\pages\WikiDetailPage.jsx ---

--- FILE: features\wiki\pages\WikiLandingPage.jsx ---
import { useParams } from 'react-router-dom';
import { Search, Folder, LayoutGrid, List } from 'lucide-react';
import { useState, useMemo } from 'react';
import { useEntityFetching } from '@/features/wiki/hooks/useEntityFetching';
import { useEntityGrouping } from '@/features/wiki/hooks/useEntityGrouping';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { getSwimlanes, getStrategyMode } from '@/features/wiki/config/viewStrategies';
import { Swimlane } from '../components/landing/Swimlane';
import { EntityTableGroup } from '../components/landing/EntityTableGroup';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { clsx } from 'clsx';

export default function WikiLandingPage() {
	const { type } = useParams();
	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Fetch Entities & Context (Arcs)
	const { entities, context, isLoading } = useEntityFetching(normalizedType);
	const [viewMode, setViewMode] = useState('grid');
	const [search, setSearch] = useState('');

	const config = getEntityConfig(normalizedType);
	const mode = getStrategyMode(normalizedType);

	// 2. Grouping
	const groups = useEntityGrouping(entities, normalizedType, search, context);
	const swimlanes = useMemo(() => getSwimlanes(groups, normalizedType), [groups, normalizedType]);

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text={`Loading ${config.labelPlural}...`} />;

	const totalCount = swimlanes.reduce((acc, lane) => acc + lane.items.length, 0);

	return (
		<div className='p-4 md:p-8 lg:p-12 max-w-[1920px] mx-auto min-h-full pb-safe'>
			{/* Header */}
			<div className='flex flex-col gap-6 mb-8 border-b border-border pb-6'>
				<div className='flex items-center justify-between sm:justify-center gap-2'>
					<div className='flex items-center gap-4'>
						<div
							className={clsx(
								'p-3 rounded-xl border shadow-sm bg-background hidden md:block',
								config.tailwind.border,
								config.tailwind.text
							)}>
							<config.icon size={32} strokeWidth={1.5} />
						</div>
						<div>
							<h1 className='text-3xl font-serif font-bold text-foreground capitalize leading-none mb-1'>
								{config.labelPlural}
							</h1>
							<p className='hidden sm:block text-sm text-muted-foreground font-medium'>{totalCount} entries found</p>
						</div>
					</div>
					{/* Search Bar */}
					<div className='relative max-w-2xl md:ml-auto'>
						<Search size={16} className='absolute left-3 top-3 text-muted-foreground' />
						<input
							type='text'
							placeholder={`Search ${config.labelPlural}...`}
							value={search}
							onChange={(e) => setSearch(e.target.value)}
							className='w-full pl-10 pr-4 py-2 bg-background border border-border rounded-lg focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none shadow-sm transition-all'
						/>
					</div>
					{/* View Toggle */}
					<div className='flex bg-muted p-1 rounded-lg border border-border/50'>
						<button
							onClick={() => setViewMode('grid')}
							className={clsx(
								'p-1.5 rounded-md transition-all',
								viewMode === 'grid'
									? 'bg-background text-foreground shadow-sm ring-1 ring-black/5'
									: 'text-muted-foreground hover:text-foreground'
							)}
							title='Grid View'>
							<LayoutGrid size={18} />
						</button>
						<button
							onClick={() => setViewMode('table')}
							className={clsx(
								'p-1.5 rounded-md transition-all',
								viewMode === 'table'
									? 'bg-background text-foreground shadow-sm ring-1 ring-black/5'
									: 'text-muted-foreground hover:text-foreground'
							)}
							title='Table View'>
							<List size={18} />
						</button>
					</div>
				</div>
			</div>

			{/* CONTENT */}
			<div className='pb-20'>
				{viewMode === 'grid' ? (
					swimlanes.map((lane) => (
						<Swimlane
							key={lane.id}
							title={lane.title}
							description={lane.description}
							parentTitle={lane.parentTitle}
							link={lane.link}
							items={lane.items}
							config={config}
							context={mode}
							type={lane.type}
							stats={lane.stats}
							order={lane.order} // <--- Added this
						/>
					))
				) : (
					<div className='max-w-6xl mx-auto'>
						{swimlanes.map((lane) => (
							<EntityTableGroup
								key={lane.id}
								title={lane.title}
								description={lane.description}
								parentTitle={lane.parentTitle}
								link={lane.link}
								items={lane.items}
							/>
						))}
					</div>
				)}
			</div>
		</div>
	);
}

--- END OF features\wiki\pages\WikiLandingPage.jsx ---

--- FILE: features\wiki\utils\attributeMapper.js ---
/**
 * Attribute Transform Functions
 * Pure functions for processing entity attributes into view model format
 */

import {
	parseAttributeValue,
	parseAbilityScores,
	parseTagList,
	isIgnoredAttribute,
	isNarrativeAttribute,
	isListAttribute,
} from '@/domain/entity/utils/attributeParser';

/**
 * Determine if an attribute should go to sidebar or main content
 * @param {string} key - Attribute key
 * @param {*} value - Attribute value
 * @returns {'sidebar'|'main'|'ignore'}
 */
const getAttributeDestination = (key, value) => {
	const normalizedKey = key.toLowerCase();

	if (isIgnoredAttribute(normalizedKey)) {
		return 'ignore';
	}

	// Special widgets always go to sidebar
	if (
		['abilities', 'stats', 'ability score', 'saving throw', 'saves', 'skills', 'languages', 'proficiencies'].includes(
			normalizedKey
		)
	) {
		return 'sidebar';
	}

	// Lists always go to main content
	if (isListAttribute(normalizedKey) && Array.isArray(value)) {
		return 'main';
	}

	// Narrative text goes to main
	if (isNarrativeAttribute(normalizedKey)) {
		return 'main';
	}

	// Long text goes to main
	if (typeof value === 'string' && value.length > 100) {
		return 'main';
	}

	// Everything else to sidebar
	return 'sidebar';
};

/**
 * Process special widget attributes (ability scores, tags)
 * @param {string} key - Attribute key
 * @param {*} value - Raw attribute value
 * @returns {Object|null} Processed trait or null
 */
const processSpecialWidget = (key, value) => {
	const normalizedKey = key.toLowerCase();

	// Ability scores / stats
	if (['abilities', 'stats'].includes(normalizedKey)) {
		const strVal = parseAttributeValue(value);
		return {
			key,
			value: parseAbilityScores(strVal),
			displayType: 'stat-grid',
		};
	}

	// Tag lists
	if (['ability score', 'saving throw', 'saves', 'skills', 'languages', 'proficiencies'].includes(normalizedKey)) {
		const strVal = parseAttributeValue(value);
		return {
			key,
			value: parseTagList(strVal),
			displayType: 'tags',
		};
	}

	return null;
};

/**
 * Transform attributes into sidebar traits and main content sections
 * @param {Object} attributes - Parsed attributes object
 * @param {string} entityDescription - Entity description (to avoid duplication)
 * @returns {{traits: Array, sections: Array}}
 */
export const transformAttributes = (attributes, entityDescription = '') => {
	const traits = [];
	const sections = [];

	Object.entries(attributes).forEach(([key, rawVal]) => {
		// 1. Check for special widgets first
		const widget = processSpecialWidget(key, rawVal);
		if (widget) {
			traits.push(widget);
			return;
		}

		// 2. Parse value
		const displayVal = parseAttributeValue(rawVal, key);
		if (!displayVal) return;

		// 3. Skip if it's the same as description
		const normalizedKey = key.toLowerCase();
		if (normalizedKey === 'description' && displayVal === entityDescription) {
			return;
		}

		// 4. Determine destination
		const destination = getAttributeDestination(key, displayVal);
		if (destination === 'ignore') return;

		// 5. Route to appropriate collection
		if (destination === 'main') {
			// Lists stay as arrays
			if (isListAttribute(normalizedKey) && Array.isArray(displayVal)) {
				sections.push({
					key,
					value: displayVal,
					displayType: 'list',
				});
			} else {
				// Join arrays into text for narrative
				const textValue = Array.isArray(displayVal) ? displayVal.join('\n\n') : displayVal;
				sections.push({
					key,
					value: textValue,
					displayType: 'narrative',
				});
			}
		} else {
			// Sidebar trait
			const textValue = Array.isArray(displayVal) ? displayVal.join(', ') : displayVal;
			traits.push({
				key,
				value: textValue,
				displayType: 'text',
			});
		}
	});

	return { traits, sections };
};

/**
 * Extract extra tags for entity header (session-specific)
 * @param {Object} attributes - Parsed attributes
 * @param {string} entityType - Entity type
 * @returns {string[]}
 */
export const extractHeaderTags = (attributes, entityType) => {
	const tags = [];

	if (entityType === 'session') {
		if (attributes.Session) {
			tags.push(`Session ${attributes.Session}`);
		}
		if (attributes.Date) {
			tags.push(attributes.Date);
		}
	}

	return tags;
};

--- END OF features\wiki\utils\attributeMapper.js ---

--- FILE: features\wiki\utils\eventMapper.js ---
/**
 * Event Transform Functions
 * Pure functions for processing entity events/history into view model format
 */

/**
 * Parse events from various formats
 * @param {Array|Object} events - Raw events data
 * @returns {Array}
 */
export const parseEvents = (events) => {
	if (!events) return [];

	// Already an array
	if (Array.isArray(events)) {
		return events;
	}

	// Object grouped by type (flatten it)
	if (typeof events === 'object') {
		return Object.values(events).flat();
	}

	return [];
};

/**
 * Transform events into history view model
 * Includes deduplication to prevent React key errors
 * @param {Array|Object} events - Raw events
 * @returns {Array}
 */
export const transformEvents = (events) => {
	const parsed = parseEvents(events);

	// 1. Deduplicate by ID using a Map
	const uniqueEventsMap = new Map();
	parsed.forEach((evt) => {
		if (evt && evt.id) {
			uniqueEventsMap.set(evt.id, evt);
		} else if (evt) {
			// Handle events without IDs (fallback)
			uniqueEventsMap.set(Math.random().toString(), evt);
		}
	});

	// 2. Transform values
	return Array.from(uniqueEventsMap.values()).map((event) => ({
		id: event.id || Math.random().toString(),
		title: event.title || 'Untitled Event',
		description: event.description || '',
		session_number: event.session_number,
		order: event.order || event.event_order || 0,
	}));
};

--- END OF features\wiki\utils\eventMapper.js ---

--- FILE: features\wiki\utils\relationshipMapper.js ---
/**
 * Relationship Transform Functions
 * Pure functions for processing entity relationships into view model format
 */

import { getEntityConfig } from '@/domain/entity/config/entityConfig';

/**
 * Parse relationships from various formats
 * @param {string|Array|Object} relationships - Raw relationships data
 * @returns {Array}
 */
export const parseRelationships = (relationships) => {
	if (!relationships) return [];

	// Already an array
	if (Array.isArray(relationships)) {
		return relationships;
	}

	// String (JSON)
	if (typeof relationships === 'string') {
		try {
			return JSON.parse(relationships);
		} catch {
			return [];
		}
	}

	// Object (convert to array)
	if (typeof relationships === 'object') {
		return Object.values(relationships);
	}

	return [];
};

/**
 * Transform relationships into connection view models
 * @param {Array} relationships - Parsed relationships
 * @param {number} maxConnections - Maximum connections to show (default 8)
 * @returns {Array}
 */
export const transformRelationships = (relationships, maxConnections = 8) => {
	const parsed = parseRelationships(relationships);

	return parsed
		.map((rel) => {
			const config = getEntityConfig(rel.entity_type);

			return {
				id: rel.entity_id || Math.random().toString(),
				name: rel.entity_name,
				typeLabel: rel.entity_type,
				role: formatRelationshipType(rel.type),
				theme: {
					...config.tailwind,
					Icon: config.icon,
				},
			};
		})
		.slice(0, maxConnections);
};

/**
 * Format relationship type for display
 * @param {string} type - Raw relationship type
 * @returns {string}
 */
const formatRelationshipType = (type) => {
	if (!type) return 'related';
	return type.toLowerCase().replace(/_/g, ' ');
};

--- END OF features\wiki\utils\relationshipMapper.js ---

--- FILE: features\wiki\utils\wikiEntryMapper.js ---
// features/wiki/utils/wikiEntryMapper.js
import { resolveImageUrl } from '@/shared/utils/imageUtils';

export const transformWikiEntry = (data, type, additionalData = {}) => {
	// --- SESSION ---
	if (type === 'session') {
		// Data comes from view_campaign_timeline
		const sortedEvents = (data.events || []).sort((a, b) => (a.order || 0) - (b.order || 0));

		const eventRelMap = additionalData.eventRelMap || new Map();

		// 1. Attach tags to specific events
		sortedEvents.forEach((evt) => {
			evt.relationships = eventRelMap.get(evt.id) || [];
		});

		// 2. Aggregate ALL unique entities from events to show in the Session Graph
		const allRelationships = [...(additionalData.sessionRelationships || [])];
		const seenIds = new Set(allRelationships.map((r) => r.entity_id));

		// Iterate all events and their tags
		eventRelMap.forEach((tags) => {
			tags.forEach((tag) => {
				if (!seenIds.has(tag.entity_id)) {
					seenIds.add(tag.entity_id);
					allRelationships.push({
						entity_id: tag.entity_id,
						entity_name: tag.entity_name,
						entity_type: tag.entity_type,
						type: 'mention', // Label for the edge
					});
				}
			});
		});

		return {
			id: data.id,
			name: data.name || data.title,
			type: 'session',
			description: data.description || data.narrative,
			attributes: data.attributes || {},
			relationships: allRelationships, // Now includes event mentions
			events: sortedEvents,
		};
	}

	// --- STANDARD ENTITY ---
	let entity = { ...data };

	// Quest Objectives
	if (type === 'quest' && additionalData.objectives) {
		entity.objectives = additionalData.objectives.map((obj) => {
			const sessionAttrs = obj.session?.attributes || {};
			return {
				...obj,
				completed_session_number: sessionAttrs.session_number,
				completed_session_title: obj.session?.title,
			};
		});
	}

	// Encounter Actions
	if (type === 'encounter' && additionalData.encounterActions) {
		const actions = additionalData.encounterActions.map((action) => {
			const actorAttrs = action.actor?.attributes || {};
			const targetAttrs = action.target?.attributes || {};

			return {
				id: action.id,
				round: action.round_number,
				order: action.action_order,
				type: action.action_type,
				isFriendly: action.result === 'SUCCESS',
				description: action.action_description,
				result: action.result,
				effect: action.effect,
				actor: {
					id: action.actor?.id,
					name: action.actor?.name || 'Unknown',
					type: action.actor?.type || 'default',
					iconUrl: resolveImageUrl(actorAttrs, 'icon'),
				},
				target: action.target?.id
					? {
							id: action.target.id,
							name: action.target.name,
							type: action.target.type,
							iconUrl: resolveImageUrl(targetAttrs, 'icon'),
					  }
					: null,
			};
		});

		const rounds = {};
		actions.forEach((action) => {
			if (!rounds[action.round]) rounds[action.round] = [];
			rounds[action.round].push(action);
		});

		entity.combatRounds = rounds;
	}

	// Event Session Mapping
	let events = entity.events;
	if (events && typeof events === 'object' && !Array.isArray(events)) {
		events = Object.values(events).flat();
	}

	if (events && Array.isArray(events) && events.length > 0 && additionalData.sessionMap) {
		events = events.map((event) => ({
			...event,
			session_number:
				event.session_id && additionalData.sessionMap.has(event.session_id)
					? additionalData.sessionMap.get(event.session_id) - 1
					: null,
		}));

		events.sort((a, b) => {
			if (a.session_number !== b.session_number) {
				if (a.session_number == null) return 1;
				if (b.session_number == null) return -1;
				return a.session_number - b.session_number;
			}
			return (a.order || 0) - (b.order || 0);
		});
		entity.events = events;
	}

	return entity;
};

--- END OF features\wiki\utils\wikiEntryMapper.js ---

--- FILE: features\wiki\utils\wikiUtils.js ---
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import { getAffinityRank } from '@/domain/entity/utils/statusUtils';
import { getParentId } from '@/domain/entity/utils/entityUtils';

// Helper: Strip Markdown
const stripMarkdown = (text) => {
	if (!text) return '';
	return text
		.replace(/^#+\s+/gm, '')
		.replace(/(\*\*|__)(.*?)\1/g, '$2')
		.replace(/(\*|_)(.*?)\1/g, '$2')
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
		.replace(/`{1,3}[^`]+`{1,3}/g, '')
		.replace(/\n/g, ' ')
		.trim();
};

export function transformEntityToViewModel(entity, type) {
	const contextType = type === 'sessions' ? 'session' : type;
	const actualType = entity.type || contextType;
	const attributes = entity.attributes || {};

	// 1. Resolve Status
	const statusRaw = getAttributeValue(attributes, ['status', 'Quest Status']) || entity.status || 'unknown';
	const affinityRaw = getAttributeValue(attributes, ['affinity', 'disposition']);
	const status = statusRaw.toLowerCase();
	const affinity = affinityRaw ? affinityRaw.toLowerCase() : 'unknown';
	const affinityRank = getAffinityRank(affinity !== 'unknown' ? affinity : status);

	// 2. Resolve Meta Fields
	const questType = getAttributeValue(attributes, ['Quest Type', 'Type']) || 'Side Quest';
	const region = getAttributeValue(attributes, ['region', 'parent location']) || null;
	const priority = getAttributeValue(attributes, ['Priority', 'priority']) || null;
	const parentId = getParentId(entity);
	const campaignArc = getAttributeValue(attributes, ['campaign_arc', 'arc']);

	// 3. Resolve Description
	// We need two versions:
	// - One for the Card (short, plain text)
	// - One for the Header (long, markdown preserved)
	let rawDescription = entity.description;

	if (actualType === 'session') {
		rawDescription = entity.description || getAttributeValue(attributes, ['narrative', 'summary']);
	} else {
		rawDescription =
			getAttributeValue(attributes, ['synopsis', 'summary', 'short_description', 'hook']) || entity.description;
	}

	// Version A: For Grid Cards (Stripped & Truncated)
	const description = rawDescription
		? stripMarkdown(rawDescription).substring(0, 140) + (rawDescription.length > 140 ? '...' : '')
		: null;

	// Version B: For Hero Headers (Full & Rich)
	// FIX: Passing the raw string so Swimlane.jsx can handle the truncation logic itself
	const fullDescription = rawDescription || null;

	// 4. Resolve Footer Label
	let footerLabel = null;
	if (actualType === 'session') {
		footerLabel = attributes.session_date || attributes.Date || `Session ${attributes.session_number || '#'}`;
	} else if (actualType === 'npc') {
		footerLabel = getAttributeValue(attributes, ['role', 'occupation', 'class', 'title']);
	} else if (actualType === 'location') {
		footerLabel = getAttributeValue(attributes, ['type']) || region;
	} else if (actualType === 'encounter') {
		footerLabel = getAttributeValue(attributes, ['status']) || 'Encounter';
	} else if (actualType === 'quest') {
		footerLabel = questType;
	} else if (actualType === 'item') {
		const rarity = getAttributeValue(attributes, ['rarity']);
		const type = getAttributeValue(attributes, ['type', 'item_type']) || 'Item';
		footerLabel = rarity ? `${rarity} ${type}` : type;
	}

	if (!footerLabel) {
		footerLabel = region || getAttributeValue(attributes, ['type', 'subtype']);
	}

	// 5. Resolve Hero Subtitle
	let heroSubtitle = footerLabel;
	if (actualType === 'character') {
		const role = getAttributeValue(attributes, ['class', 'role', 'occupation']);
		const level = getAttributeValue(attributes, ['level']);
		if (level && role) heroSubtitle = `Lvl ${level} ${role}`;
		else if (level) heroSubtitle = `Level ${level}`;
		else heroSubtitle = role;
	}

	return {
		id: entity.id,
		name: entity.name,
		path: `/wiki/${contextType}/${entity.id}`,
		type: actualType,

		// UI Props
		description, // Short (Cards)
		fullDescription, // New: Long (Headers)
		footerLabel,
		heroSubtitle,

		status,
		affinity,
		attributes,
		relationships: entity.relationships,

		meta: {
			status,
			affinity,
			affinityRank,
			questType,
			region,
			priority,
			parentId,
			campaignArc,
		},
	};
}

--- END OF features\wiki\utils\wikiUtils.js ---

--- FILE: shared\api\supabaseClient.js ---
import { createClient } from '@supabase/supabase-js';

// 1. Load variables from .env
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

// 2. Safety Check (Helps debug if .env is missing)
if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
	console.error(
		' Supabase Critical Error: Missing environment variables.\n' +
			'Please check that your .env file exists and contains VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY.'
	);
}

// 3. Initialize and Export the Client
export const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

--- END OF shared\api\supabaseClient.js ---

--- FILE: shared\components\ErrorBoundary.jsx ---
import { Component } from 'react';
import { AlertTriangle, RefreshCw } from 'lucide-react';
import Button from './ui/Button';

class ErrorBoundary extends Component {
	constructor(props) {
		super(props);
		this.state = { hasError: false, error: null };
	}

	static getDerivedStateFromError(error) {
		return { hasError: true, error };
	}

	componentDidCatch(error, errorInfo) {
		console.error('Error caught by boundary:', error, errorInfo);
	}

	handleReset = () => {
		this.setState({ hasError: false, error: null });
		window.location.reload();
	};

	render() {
		if (this.state.hasError) {
			return (
				<div className='min-h-screen flex items-center justify-center bg-muted p-4'>
					<div className='max-w-md w-full text-center'>
						<div className='mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100'>
							<AlertTriangle className='w-8 h-8 text-red-600' />
						</div>
						<h1 className='text-2xl font-serif font-bold text-foreground mb-3'>Something went wrong</h1>
						<p className='text-muted-foreground mb-6'>Don't worry, your data is safe. Try refreshing the page to continue.</p>
						{process.env.NODE_ENV === 'development' && this.state.error && (
							<details className='mb-6 text-left bg-red-500/10 border border-red-200 rounded-lg p-4'>
								<summary className='cursor-pointer font-semibold text-red-900 mb-2'>Error Details</summary>
								<pre className='text-xs text-red-800 overflow-auto'>{this.state.error.toString()}</pre>
							</details>
						)}
						<Button onClick={this.handleReset} icon={RefreshCw}>
							Reload Application
						</Button>
					</div>
				</div>
			);
		}

		return this.props.children;
	}
}

export default ErrorBoundary;

--- END OF shared\components\ErrorBoundary.jsx ---

--- FILE: shared\components\layout\CollapsibleSection.jsx ---
import { useState } from 'react';
import { ChevronDown, ChevronRight } from 'lucide-react';
import { clsx } from 'clsx';

/**
 * CollapsibleSection Component
 * Expandable/collapsible content section
 *
 * @param {string} title - Section title
 * @param {React.ReactNode} children - Section content
 * @param {boolean} defaultOpen - Initial state (default true)
 * @param {React.Component} icon - Optional icon component
 * @param {string} size - Title size: 'sm', 'md', 'lg' (default 'md')
 * @param {string} variant - Style variant: 'default', 'bordered', 'card' (default 'default')
 * @param {string} className - Additional classes
 */
export default function CollapsibleSection({
	title,
	children,
	defaultOpen = true,
	icon: Icon = null,
	size = 'md',
	variant = 'default',
	className = '',
	...props
}) {
	const [isOpen, setIsOpen] = useState(defaultOpen);

	const sizeClasses = {
		sm: 'text-xs',
		md: 'text-sm',
		lg: 'text-base',
	};

	const variantClasses = {
		default: '',
		bordered: 'border border-border rounded-lg p-3',
		card: 'bg-background border border-border rounded-lg shadow-sm',
	};

	const headerPadding = variant === 'card' ? 'p-3' : '';
	const contentPadding = variant === 'card' ? 'p-3 pt-0' : '';

	return (
		<div className={clsx(variantClasses[variant], className)} {...props}>
			{/* Header */}
			<button
				onClick={() => setIsOpen(!isOpen)}
				className={clsx(
					'w-full flex items-center gap-2 font-semibold uppercase tracking-wider text-muted-foreground',
					'hover:text-foreground/80 transition-colors select-none',
					sizeClasses[size],
					headerPadding
				)}>
				{isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
				{Icon && <Icon size={14} className='opacity-70' />}
				<span className='flex-1 text-left truncate'>{title}</span>
			</button>

			{/* Content */}
			{isOpen && <div className={contentPadding}>{children}</div>}
		</div>
	);
}

/**
 * CollapsibleList Component
 * List of collapsible sections with consistent styling
 *
 * @param {Array<{title: string, content: ReactNode, icon?: Component}>} sections - Section definitions
 * @param {string} variant - Style variant (default 'default')
 * @param {string} className - Additional classes
 */
export function CollapsibleList({ sections, variant = 'default', className = '', ...props }) {
	return (
		<div className={clsx('space-y-2', className)} {...props}>
			{sections.map((section, index) => (
				<CollapsibleSection
					key={section.id || index}
					title={section.title}
					icon={section.icon}
					variant={variant}
					defaultOpen={section.defaultOpen !== false}>
					{section.content}
				</CollapsibleSection>
			))}
		</div>
	);
}

--- END OF shared\components\layout\CollapsibleSection.jsx ---

--- FILE: shared\components\layout\SplitView.jsx ---
import { clsx } from 'clsx';

/**
 * SplitView Component
 * Responsive 2-column layout pattern
 *
 * @param {React.ReactNode} sidebar - Sidebar content
 * @param {React.ReactNode} main - Main content
 * @param {string} sidebarPosition - 'left' or 'right' (default 'left')
 * @param {string} sidebarWidth - Sidebar width class (default 'lg:w-64')
 * @param {boolean} stickyHeader - Make sidebar sticky (default false)
 * @param {string} className - Additional container classes
 */
export default function SplitView({
	sidebar,
	main,
	sidebarPosition = 'left',
	sidebarWidth = 'lg:w-64',
	stickyHeader = false,
	className = '',
	...props
}) {
	const sidebarClasses = clsx(
		'min-w-0',
		sidebarWidth,
		stickyHeader && 'lg:sticky lg:top-0 lg:self-start lg:max-h-screen lg:overflow-y-auto'
	);

	const mainClasses = 'flex-1 min-w-0';

	return (
		<div className={clsx('flex flex-col lg:flex-row gap-4 lg:gap-6', className)} {...props}>
			{sidebarPosition === 'left' && <aside className={sidebarClasses}>{sidebar}</aside>}

			<main className={mainClasses}>{main}</main>

			{sidebarPosition === 'right' && <aside className={clsx(sidebarClasses, 'lg:order-2')}>{sidebar}</aside>}
		</div>
	);
}

/**
 * ThreeColumnLayout Component
 * For pages with sidebar, main content, and ToC/meta panel
 *
 * @param {React.ReactNode} left - Left sidebar
 * @param {React.ReactNode} center - Main content
 * @param {React.ReactNode} right - Right panel (ToC, etc.)
 * @param {string} className - Additional container classes
 */
export function ThreeColumnLayout({ left, center, right, className = '', ...props }) {
	return (
		<div
			className={clsx('grid grid-cols-1 xl:grid-cols-[1fr_48rem_1fr] gap-6 max-w-[1920px] mx-auto', className)}
			{...props}>
			{/* Left Gutter (Hidden on smaller screens) */}
			<div className='hidden xl:block' aria-hidden='true'>
				{left}
			</div>

			{/* Center Content */}
			<div className='min-w-0'>{center}</div>

			{/* Right Panel */}
			<div className='hidden xl:block'>{right}</div>
		</div>
	);
}

--- END OF shared\components\layout\SplitView.jsx ---

--- FILE: shared\components\layout\TabContainer.jsx ---
import { useState } from 'react';
import { clsx } from 'clsx';

/**
 * TabButton Component
 * Individual tab button
 */
function TabButton({ active, label, onClick, icon: Icon }) {
	return (
		<button
			onClick={onClick}
			className={clsx(
				'px-4 py-2 text-sm font-medium transition-all border-b-2 cursor-pointer',
				active
					? 'border-primary text-primary bg-amber-500/10/30'
					: 'border-transparent text-muted-foreground hover:text-foreground/80 hover:bg-muted/30'
			)}>
			<span className='flex items-center gap-2'>
				{Icon && <Icon size={14} />}
				{label}
			</span>
		</button>
	);
}

/**
 * TabContainer Component
 * Reusable tab navigation system
 *
 * @param {Array<{id: string, label: string, icon?: Component, content: ReactNode}>} tabs - Tab definitions
 * @param {string} defaultTab - Default active tab ID
 * @param {string} className - Additional container classes
 * @param {boolean} sticky - Make tab bar sticky (default true)
 * @param {Function} onChange - Callback when tab changes
 */
export default function TabContainer({
	tabs,
	defaultTab = null,
	className = '',
	sticky = true,
	onChange = null,
	...props
}) {
	const [activeTab, setActiveTab] = useState(defaultTab || tabs[0]?.id);

	const handleTabChange = (tabId) => {
		setActiveTab(tabId);
		if (onChange) onChange(tabId);
	};

	const activeTabContent = tabs.find((t) => t.id === activeTab)?.content;

	return (
		<div className={clsx('flex flex-col', className)} {...props}>
			{/* Tab Bar */}
			<div
				className={clsx(
					'bg-background/95 backdrop-blur shadow-sm border-b border-border z-20',
					sticky && 'sticky top-0'
				)}>
				<div className='max-w-screen-2xl mx-auto px-6 flex justify-center'>
					{tabs.map((tab) => (
						<TabButton
							key={tab.id}
							active={activeTab === tab.id}
							label={tab.label}
							icon={tab.icon}
							onClick={() => handleTabChange(tab.id)}
						/>
					))}
				</div>
			</div>

			{/* Tab Content */}
			<div className='flex-1 min-h-0'>{activeTabContent}</div>
		</div>
	);
}

/**
 * TabPanel Component
 * Wrapper for individual tab content
 *
 * @param {React.ReactNode} children - Panel content
 * @param {string} className - Additional classes
 */
export function TabPanel({ children, className = '', ...props }) {
	return (
		<div className={clsx('p-6', className)} {...props}>
			{children}
		</div>
	);
}

--- END OF shared\components\layout\TabContainer.jsx ---

--- FILE: shared\components\markdown\MarkdownRenderer.jsx ---
import ReactMarkdown from 'react-markdown';
import { generateId, extractText } from '@/shared/utils/textUtils';

/**
 * HeadingRenderer Component
 * Automatically adds IDs to headings for anchor links
 */
function HeadingRenderer({ level, children }) {
	const text = extractText(children);
	const id = generateId(text);
	const Tag = `h${level}`;
	return <Tag id={id}>{children}</Tag>;
}

/**
 * MarkdownRenderer Component
 * Pre-configured ReactMarkdown with sensible defaults
 *
 * @param {string} children - Markdown text
 * @param {Object} components - Custom component overrides
 * @param {boolean} addHeadingIds - Auto-generate heading IDs (default true)
 * @param {string} className - Additional CSS classes
 */
export default function MarkdownRenderer({
	children,
	components = {},
	addHeadingIds = true,
	className = '',
	...props
}) {
	// Safety check
	let safeText = children;
	if (Array.isArray(children)) {
		safeText = children.join('');
	} else if (typeof children !== 'string' && children !== null && children !== undefined) {
		safeText = String(children);
	}

	// Build component overrides
	const defaultComponents = {
		// Auto-add IDs to headings
		...(addHeadingIds && {
			h1: (props) => <HeadingRenderer level={1} {...props} />,
			h2: (props) => <HeadingRenderer level={2} {...props} />,
			h3: (props) => <HeadingRenderer level={3} {...props} />,
		}),
		// External links open in new tab
		a: ({ href, children }) => {
			if (href && !href.startsWith('#') && !href.startsWith('/')) {
				return (
					<a href={href} target='_blank' rel='noopener noreferrer'>
						{children}
					</a>
				);
			}
			return <a href={href}>{children}</a>;
		},
	};

	return (
		<ReactMarkdown className={className} components={{ ...defaultComponents, ...components }} {...props}>
			{safeText}
		</ReactMarkdown>
	);
}

/**
 * InlineMarkdown Component
 * For rendering markdown inside inline contexts (no block elements)
 *
 * @param {string} children - Markdown text
 */
export function InlineMarkdown({ children, ...props }) {
	return (
		<MarkdownRenderer
			components={{
				p: 'span',
				h1: 'strong',
				h2: 'strong',
				h3: 'strong',
				ul: 'span',
				ol: 'span',
				li: 'span',
			}}
			addHeadingIds={false}
			{...props}>
			{children}
		</MarkdownRenderer>
	);
}

--- END OF shared\components\markdown\MarkdownRenderer.jsx ---

--- FILE: shared\components\markdown\MarkdownWithToC.jsx ---
import { useMemo } from 'react';
import { extractHeaders } from '@/shared/utils/markdownUtils';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import MarkdownRenderer from './MarkdownRenderer';

/**
 * MarkdownWithToC Component
 * Renders markdown with automatic Table of Contents generation
 *
 * @param {string} children - Markdown text
 * @param {boolean} showToC - Show table of contents (default true)
 * @param {number} tocMaxDepth - Maximum heading depth for ToC (default 3)
 * @param {string} layout - Layout mode: 'split' or 'top' (default 'split')
 * @param {string} className - Additional classes for markdown container
 */
export default function MarkdownWithToC({
	children,
	showToC = true,
	tocMaxDepth = 3,
	layout = 'split',
	className = '',
	components = {},
	...props
}) {
	// Extract headers for ToC
	const tocItems = useMemo(() => {
		if (!showToC || !children) return [];
		const headers = extractHeaders(children);
		return headers.filter((h) => h.depth <= tocMaxDepth);
	}, [children, showToC, tocMaxDepth]);

	// No ToC needed
	if (!showToC || tocItems.length === 0) {
		return (
			<MarkdownRenderer className={className} components={components} {...props}>
				{children}
			</MarkdownRenderer>
		);
	}

	// Top layout: ToC above content
	if (layout === 'top') {
		return (
			<div>
				<div className='mb-6'>
					<TableOfContents items={tocItems} />
				</div>
				<MarkdownRenderer className={className} components={components} {...props}>
					{children}
				</MarkdownRenderer>
			</div>
		);
	}

	// Split layout: ToC on side
	return (
		<div className='grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-8'>
			{/* Content */}
			<div className='min-w-0'>
				<MarkdownRenderer className={className} components={components} {...props}>
					{children}
				</MarkdownRenderer>
			</div>

			{/* ToC Sidebar */}
			<div className='hidden xl:block'>
				<TableOfContents items={tocItems} />
			</div>

			{/* Mobile ToC */}
			<div className='xl:hidden'>
				<TableOfContents items={tocItems} />
			</div>
		</div>
	);
}

--- END OF shared\components\markdown\MarkdownWithToC.jsx ---

--- FILE: shared\components\ui\Breadcrumbs.jsx ---
import React from 'react';
import { Link, useLocation } from 'react-router-dom'; // Added useLocation
import { ChevronRight, Home } from 'lucide-react';
import { clsx } from 'clsx';
import { useBreadcrumbs } from '@/shared/hooks/useBreadcrumbs';

export default function Breadcrumbs({ className }) {
	const crumbs = useBreadcrumbs();
	const location = useLocation();

	// 1. Explicitly exclude full-screen "World" views where overlays distract
	const BLACKLISTED_ROUTES = ['/timeline', '/relationships', '/atlas'];
	const isBlacklisted = BLACKLISTED_ROUTES.some((route) => location.pathname.startsWith(route));

	if (isBlacklisted) return null;

	// 2. Hide on "Landing Pages" (Depth check)
	// If we only have "Home > [Category]", the Page Title serves as the breadcrumb.
	// We only want to show this when deep navigating (e.g., "Home > Locations > Brindol")
	if (crumbs.length <= 2) return null;

	return (
		<nav
			className={clsx(
				'inline-flex items-center gap-1 px-3 py-1.5 rounded-full',
				'bg-background/60 backdrop-blur-md border border-border/50 shadow-sm',
				'text-xs font-medium text-muted-foreground',
				'transition-all hover:bg-background/90 hover:shadow-md hover:border-border',
				className
			)}
			aria-label='Breadcrumb'>
			<ol className='flex items-center gap-1.5'>
				{crumbs.map((crumb, index) => {
					const Icon = crumb.icon;
					const isFirst = index === 0;

					return (
						<li key={crumb.path} className='flex items-center'>
							{!isFirst && <ChevronRight size={10} className='text-muted-foreground/60 mx-0.5 shrink-0' />}

							{crumb.isCurrent ? (
								<span
									className={clsx('flex items-center gap-1.5 truncate max-w-[200px]', 'text-foreground font-semibold')}>
									{Icon && <Icon size={12} />}
									{crumb.label}
								</span>
							) : (
								<Link
									to={crumb.path}
									className='flex items-center gap-1.5 hover:text-primary transition-colors truncate max-w-[150px]'>
									{isFirst ? <Home size={12} /> : Icon && <Icon size={12} />}
									<span className={isFirst ? 'sr-only' : ''}>{crumb.label}</span>
								</Link>
							)}
						</li>
					);
				})}
			</ol>
		</nav>
	);
}

--- END OF shared\components\ui\Breadcrumbs.jsx ---

--- FILE: shared\components\ui\Button.jsx ---
import { clsx } from 'clsx';

export default function Button({
	children,
	variant = 'primary',
	size = 'md',
	icon: Icon,
	fullWidth = false,
	disabled = false,
	className,
	...props
}) {
	const baseStyles =
		'inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed';

	const variants = {
		primary: 'bg-amber-600 text-white hover:bg-amber-700 focus:ring-amber-500',
		secondary: 'bg-muted text-foreground hover:bg-gray-200 focus:ring-gray-500',
		ghost: 'bg-transparent text-foreground/80 hover:bg-muted focus:ring-gray-500',
		danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
	};

	const sizes = {
		sm: 'px-3 py-1.5 text-sm',
		md: 'px-4 py-2 text-sm',
		lg: 'px-6 py-3 text-base',
	};

	return (
		<button
			className={clsx(baseStyles, variants[variant], sizes[size], fullWidth && 'w-full', className)}
			disabled={disabled}
			{...props}>
			{Icon && <Icon size={16} />}
			{children}
		</button>
	);
}

--- END OF shared\components\ui\Button.jsx ---

--- FILE: shared\components\ui\Card.jsx ---
import { clsx } from 'clsx';

export function Card({ children, className, padding = true, hover = false, ...props }) {
	return (
		<div
			className={clsx(
				// Use semantic variable --card instead of hardcoded white
				'bg-card text-foreground border border-border rounded-lg shadow-sm',
				padding && 'p-4',
				hover && 'transition-shadow hover:shadow-md',
				className
			)}
			{...props}>
			{children}
		</div>
	);
}

export function CardHeader({ children, className }) {
	return <div className={clsx('border-b border-border pb-3 mb-3', className)}>{children}</div>;
}

export function CardTitle({ children, className }) {
	return <h3 className={clsx('text-lg font-serif font-semibold text-foreground', className)}>{children}</h3>;
}

export function CardContent({ children, className }) {
	return <div className={className}>{children}</div>;
}

--- END OF shared\components\ui\Card.jsx ---

--- FILE: shared\components\ui\DevAdminButton.jsx ---
import React from 'react';
import { Link } from 'react-router-dom';
import { Database, Wrench } from 'lucide-react';

export default function DevAdminButton() {
	// CRITICAL: This ensures it never renders in Production (GitHub Pages)
	if (!import.meta.env.DEV) return null;

	return (
		<Link
			to='/dm'
			className='fixed bottom-6 left-6 lg:left-[unset] lg:right-6 z-50 flex items-center gap-2 px-4 py-1 bg-muted  rounded-full shadow-xl hover:bg-background hover:scale-105 transition-all border border-stone-300'
			title='Open DM Console (Dev Mode Only)'>
			<Wrench size={14} />
			<span className='hidden md:inline'>Dev</span>
		</Link>
	);
}

--- END OF shared\components\ui\DevAdminButton.jsx ---

--- FILE: shared\components\ui\Drawer.jsx ---
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';
import { clsx } from 'clsx';
import { useEffect, useState } from 'react';

/**
 * Reusable Mobile Drawer with 60fps hardware-accelerated transitions
 */
export const Drawer = ({ isOpen, onClose, title, children, position = 'right', className }) => {
	const [isVisible, setIsVisible] = useState(false);

	useEffect(() => {
		if (isOpen) {
			setIsVisible(true);
			document.body.classList.add('drawer-open');
		} else {
			// Wait for animation to finish before unmounting DOM
			const timer = setTimeout(() => {
				setIsVisible(false);
				document.body.classList.remove('drawer-open');
			}, 350); // Slightly longer than CSS duration to ensure completion
			return () => clearTimeout(timer);
		}
		return () => document.body.classList.remove('drawer-open');
	}, [isOpen]);

	if (!isVisible && !isOpen) return null;

	// Slide directions
	const positionClasses = {
		right: 'right-0 top-0 bottom-0 border-l',
		left: 'left-0 top-0 bottom-0 border-r',
	};

	// Transform values
	const transforms = {
		right: isOpen ? 'translate-x-0' : 'translate-x-full',
		left: isOpen ? 'translate-x-0' : '-translate-x-full',
	};

	return createPortal(
		<div className='fixed inset-0 z-[10050] isolate'>
			{/* Backdrop - Fades in/out */}
			<div
				className={clsx(
					'absolute inset-0 bg-black/20 backdrop-blur-[2px] transition-opacity duration-300 ease-in-out',
					isOpen ? 'opacity-100' : 'opacity-0'
				)}
				onClick={onClose}
				aria-hidden='true'
			/>

			{/* Panel - Slides with Physics Easing */}
			<div
				className={clsx(
					'absolute w-80 bg-background shadow-2xl border-border flex flex-col pb-safe',
					// Hardware acceleration hints
					'will-change-transform transition-transform duration-300',
					// iOS-like spring easing (cubic-bezier)
					'ease-[cubic-bezier(0.32,0.72,0,1)]',
					positionClasses[position],
					transforms[position],
					className
				)}>
				{/* Header */}
				<div className='p-4 pt-[calc(1rem+env(safe-area-inset-top))] border-b border-border flex items-center justify-between bg-muted shrink-0'>
					<span className='text-sm font-serif font-bold text-foreground'>{title}</span>
					<button
						onClick={onClose}
						className='p-2 -mr-2 hover:bg-background/50 rounded-full transition-colors active:scale-95 text-muted-foreground'
						aria-label='Close Sidebar'>
						<X size={20} />
					</button>
				</div>

				{/* Content */}
				<div className='flex-1 overflow-y-auto custom-scrollbar p-0'>{children}</div>
			</div>
		</div>,
		document.body
	);
};

--- END OF shared\components\ui\Drawer.jsx ---

--- FILE: shared\components\ui\EmptyState.jsx ---
import { clsx } from 'clsx';

export default function EmptyState({ icon: Icon, title, description, action, className }) {
	return (
		<div className={clsx('flex flex-col items-center justify-center p-8 text-center', className)}>
			{Icon && (
				<div className='mb-4 rounded-full bg-muted p-4'>
					<Icon className='w-8 h-8 text-muted-foreground/70' strokeWidth={1.5} />
				</div>
			)}
			{title && <h3 className='text-lg font-serif font-semibold text-foreground mb-2'>{title}</h3>}
			{description && <p className='text-sm text-muted-foreground max-w-sm mb-6'>{description}</p>}
			{action && <div>{action}</div>}
		</div>
	);
}

--- END OF shared\components\ui\EmptyState.jsx ---

--- FILE: shared\components\ui\HighlightBadge.jsx ---
export const HighlightBadge = ({ icon: Icon, count, label }) => {
	if (!count) return null;
	return (
		<div className='flex items-center gap-1.5 text-[12px] font-bold uppercase tracking-wider text-muted-foreground'>
			<Icon size={12} className='text-primary/70' />
			<span>
				{count} {label}
			</span>
		</div>
	);
};

--- END OF shared\components\ui\HighlightBadge.jsx ---

--- FILE: shared\components\ui\LoadingSpinner.jsx ---
import { Loader2 } from 'lucide-react';
import { clsx } from 'clsx';

export default function LoadingSpinner({ size = 'md', text = 'Loading...', className }) {
	const sizes = {
		sm: 'w-4 h-4',
		md: 'w-8 h-8',
		lg: 'w-12 h-12',
	};

	return (
		<div className={clsx('flex flex-col items-center justify-center gap-3', className)}>
			<Loader2 className={clsx(sizes[size], 'animate-spin text-primary')} />
			{text && <p className='text-sm text-muted-foreground font-medium'>{text}</p>}
		</div>
	);
}

--- END OF shared\components\ui\LoadingSpinner.jsx ---

--- FILE: shared\components\ui\SectionDivider.jsx ---
import { Diamond } from 'lucide-react';
import { clsx } from 'clsx';

export const SectionDivider = ({ className = 'my-6' }) => (
	<div className={clsx('flex items-center gap-4 opacity-80 select-none', className)}>
		<div className='h-px bg-border flex-1' />
		<div className='flex-shrink-0 text-primary/40'>
			<Diamond size={10} fill='currentColor' />
		</div>
		<div className='h-px bg-border flex-1' />
	</div>
);

export const SectionDividerVertical = ({ className = 'mx-6 h-full min-h-[50px]' }) => (
	<div className={clsx('flex flex-col items-center gap-4 opacity-80 select-none', className)}>
		<div className='w-px bg-border flex-1' />
		<div className='flex-shrink-0 text-primary/40'>
			<Diamond size={10} fill='currentColor' />
		</div>
		<div className='w-px bg-border flex-1' />
	</div>
);

--- END OF shared\components\ui\SectionDivider.jsx ---

--- FILE: shared\hooks\useBreadcrumbs.js ---
import { useLocation } from 'react-router-dom';
import { useMemo } from 'react';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { capitalize } from '@/shared/utils/textUtils';

const ROUTE_LABELS = {
	dm: 'DM Console',
	manage: 'Manage',
	atlas: 'Atlas',
	timeline: 'Timeline',
	relationships: 'Graph',
	wiki: 'Wiki',
};

export function useBreadcrumbs() {
	const location = useLocation();
	const { map: entityMap } = useEntityIndex(); // DESTRUCTURED: Use Map

	const breadcrumbs = useMemo(() => {
		const pathnames = location.pathname.split('/').filter((x) => x);
		const crumbs = [];

		crumbs.push({
			label: 'Home',
			path: '/',
			isCurrent: pathnames.length === 0,
		});

		const isWiki = pathnames[0] === 'wiki';
		const SKIP_SEGMENTS = ['manage', 'wiki'];

		let currentPath = '';

		for (let i = 0; i < pathnames.length; i++) {
			const segment = pathnames[i];
			currentPath += `/${segment}`;

			if (SKIP_SEGMENTS.includes(segment)) continue;

			const isLast = i === pathnames.length - 1;
			const isUUID = /^[0-9a-fA-F-]{36}$/.test(segment);

			if (isWiki && isUUID) {
				// OPTIMIZATION: O(1) Lookup
				const targetEntity = entityMap.get(segment);

				if (targetEntity) {
					const hierarchyStack = [];
					let current = targetEntity;
					const visited = new Set([current.id]);

					// Fast recursive climb using Map
					while (current.parentId) {
						const parent = entityMap.get(current.parentId);
						if (!parent || visited.has(parent.id)) break;

						visited.add(parent.id);
						hierarchyStack.unshift(parent);
						current = parent;
					}

					hierarchyStack.forEach((ancestor) => {
						crumbs.push({
							label: ancestor.name,
							path: `/wiki/${ancestor.type}/${ancestor.id}`,
							isCurrent: false,
							icon: null,
						});
					});

					crumbs.push({
						label: targetEntity.name,
						path: currentPath,
						isCurrent: isLast,
					});
				} else {
					crumbs.push({ label: 'Unknown Entity', path: currentPath, isCurrent: isLast });
				}
			} else if (segment === 'new') {
				crumbs.push({ label: 'Create New', path: currentPath, isCurrent: isLast });
			} else if (getEntityConfig(segment).type !== 'default') {
				const config = getEntityConfig(segment);
				crumbs.push({
					label: config.labelPlural,
					path: currentPath,
					isCurrent: isLast,
					icon: config.icon,
				});
			} else {
				const label = ROUTE_LABELS[segment] || capitalize(segment.replace(/_/g, ' '));
				crumbs.push({ label, path: currentPath, isCurrent: isLast });
			}
		}

		return crumbs;
	}, [location.pathname, entityMap]);

	return breadcrumbs;
}

--- END OF shared\hooks\useBreadcrumbs.js ---

--- FILE: shared\hooks\useTheme.js ---
import { useState, useEffect } from 'react';

export const THEMES = {
	// LIGHT: 'light',
	DARK: 'dark', // RE-ENABLED
	DND: 'dnd',
};

export function useTheme() {
	const [theme, setTheme] = useState(() => {
		const stored = localStorage.getItem('app-theme');
		return stored || THEMES.LIGHT;
	});

	useEffect(() => {
		const root = window.document.documentElement;
		Object.values(THEMES).forEach((t) => root.removeAttribute('data-theme'));

		if (theme !== THEMES.LIGHT) {
			root.setAttribute('data-theme', theme);
		}

		localStorage.setItem('app-theme', theme);
	}, [theme]);

	const cycleTheme = () => {
		const themes = Object.values(THEMES);
		const currentIndex = themes.indexOf(theme);
		const nextIndex = (currentIndex + 1) % themes.length;
		setTheme(themes[nextIndex]);
	};

	return { theme, setTheme, cycleTheme };
}

--- END OF shared\hooks\useTheme.js ---

--- FILE: shared\utils\imageUtils.js ---
/**
 * Centralized image URL resolution
 * Used by: EntityViewModel, EntityIndex, TooltipCard
 */

const IMAGE_KEYS = {
	background: ['background_image', 'background', 'Background', 'Background_image'],
	icon: ['icon', 'Icon', 'token', 'Token', 'portrait', 'Portrait'],
	any: ['background_image', 'background', 'image', 'Image', 'portrait', 'Portrait', 'icon', 'Icon'],
};

/**
 * Extract value from nested attribute structure
 */
const extractValue = (val) => {
	if (!val) return null;
	if (typeof val === 'string') return val;
	if (Array.isArray(val)) return val[0]?.value || val[0];
	if (typeof val === 'object' && val.value) return val.value;
	return null;
};

/**
 * Resolve image URL from attributes object
 * @param {Object} attributes - Entity attributes
 * @param {'background' | 'icon' | 'any'} type - Type of image to find
 * @returns {string|null} - Resolved URL or null
 */
export const resolveImageUrl = (attributes, type = 'any') => {
	if (!attributes) return null;

	const keys = IMAGE_KEYS[type] || IMAGE_KEYS.any;

	for (const key of keys) {
		const val = attributes[key] || attributes[key.toLowerCase()];
		const rawUrl = extractValue(val);

		if (rawUrl) {
			// Clean path and prepend base URL
			const cleanPath = rawUrl
				.trim()
				.replace(/(\.\.\/)+/g, '')
				.replace(/^\//, '');

			return `${import.meta.env.BASE_URL}${cleanPath}`;
		}
	}

	return null;
};

/**
 * Safe attribute parser
 */
export const parseAttributes = (attrs) => {
	if (!attrs) return {};
	if (typeof attrs === 'object') return attrs;
	try {
		return JSON.parse(attrs);
	} catch {
		return {};
	}
};

--- END OF shared\utils\imageUtils.js ---

--- FILE: shared\utils\markdownUtils.js ---
/**
 * Markdown-specific Utilities
 * Header extraction, ToC generation, etc.
 */

import { generateId } from '@/shared/utils/textUtils';

/**
 * Extract headers from markdown text and normalize their depth.
 * Finds the shallowest header level (e.g., h3) and resets it to a baseline (Depth 2),
 * ensuring the ToC hierarchy always starts at a readable level.
 *
 * @param {string} markdown - Markdown text
 * @returns {Array<{depth: number, text: string, id: string}>}
 */
export const extractHeaders = (markdown) => {
	if (!markdown) return [];

	const regex = /^(#{1,4})\s+(.+)$/gm;
	const rawHeaders = [];
	let match;

	// 1. First Pass: Capture all headers and their raw Markdown depth (1-6)
	while ((match = regex.exec(markdown)) !== null) {
		rawHeaders.push({
			rawDepth: match[1].length,
			text: match[2].trim(),
			id: generateId(match[2]),
		});
	}

	if (rawHeaders.length === 0) return [];

	// 2. Find the minimum depth used in this specific document
	//    (e.g., if the user only used ### and ####, min is 3)
	const minDepth = Math.min(...rawHeaders.map((h) => h.rawDepth));

	// 3. Normalization Constant
	//    We map minDepth to this value.
	//    Depth 2 = Standard ToC Link (No chevron, standard padding).
	const TARGET_BASE_DEPTH = 2;

	return rawHeaders.map((header) => ({
		...header,
		// Example: If raw is 3 and min is 3, result is 2. If raw is 4, result is 3.
		depth: header.rawDepth - minDepth + TARGET_BASE_DEPTH,
	}));
};

/**
 * Generate Table of Contents from markdown
 * @param {string} markdown - Markdown text
 * @param {number} maxDepth - Maximum heading depth (default 3)
 * @returns {Array<{depth: number, text: string, id: string}>}
 */
export const generateToC = (markdown, maxDepth = 3) => {
	const headers = extractHeaders(markdown);
	return headers.filter((h) => h.depth <= maxDepth);
};

/**
 * Convert markdown to plain text (strips formatting)
 * @param {string} markdown - Markdown text
 * @returns {string}
 */
export const markdownToText = (markdown) => {
	if (!markdown) return '';

	return markdown
		.replace(/#{1,6}\s+/g, '') // Headers
		.replace(/\*\*(.+?)\*\*/g, '$1') // Bold
		.replace(/\*(.+?)\*/g, '$1') // Italic
		.replace(/\[(.+?)\]\(.+?\)/g, '$1') // Links
		.replace(/`(.+?)`/g, '$1') // Code
		.replace(/^>\s+/gm, '') // Blockquotes
		.replace(/^[-*+]\s+/gm, '') // Lists
		.replace(/^\d+\.\s+/gm, '') // Ordered lists
		.trim();
};

/**
 * Extract excerpt from markdown (first paragraph)
 * @param {string} markdown - Markdown text
 * @param {number} maxLength - Maximum length (default 200)
 * @returns {string}
 */
export const extractExcerpt = (markdown, maxLength = 200) => {
	if (!markdown) return '';

	// Remove headers
	const withoutHeaders = markdown.replace(/^#{1,6}\s+.+$/gm, '');

	// Get first paragraph
	const paragraphs = withoutHeaders
		.split(/\n\n+/)
		.map((p) => p.trim())
		.filter(Boolean);

	if (paragraphs.length === 0) return '';

	const firstPara = markdownToText(paragraphs[0]);

	if (firstPara.length <= maxLength) return firstPara;
	return firstPara.slice(0, maxLength).trim() + '...';
};

/**
 * Count words in markdown (excluding formatting)
 * @param {string} markdown - Markdown text
 * @returns {number}
 */
export const countMarkdownWords = (markdown) => {
	const plainText = markdownToText(markdown);
	if (!plainText) return 0;
	return plainText.trim().split(/\s+/).length;
};

/**
 * Parse markdown frontmatter (YAML at start of document)
 * @param {string} markdown - Markdown with frontmatter
 * @returns {{frontmatter: Object, content: string}}
 */
export const parseFrontmatter = (markdown) => {
	if (!markdown) return { frontmatter: {}, content: '' };

	const frontmatterRegex = /^---\n([\s\S]*?)\n---\n([\s\S]*)$/;
	const match = markdown.match(frontmatterRegex);

	if (!match) {
		return { frontmatter: {}, content: markdown };
	}

	// Simple YAML parser (key: value pairs only)
	const frontmatterText = match[1];
	const frontmatter = {};

	frontmatterText.split('\n').forEach((line) => {
		const colonIndex = line.indexOf(':');
		if (colonIndex > 0) {
			const key = line.slice(0, colonIndex).trim();
			const value = line.slice(colonIndex + 1).trim();
			frontmatter[key] = value;
		}
	});

	return {
		frontmatter,
		content: match[2],
	};
};

/**
 * Add IDs to headers in markdown (for anchor links)
 * @param {string} markdown - Original markdown
 * @returns {string} Markdown with header IDs
 */
export const addHeaderIds = (markdown) => {
	if (!markdown) return '';

	return markdown.replace(/^(#{1,6})\s+(.+)$/gm, (match, hashes, text) => {
		const id = generateId(text);
		return `${hashes} ${text} {#${id}}`;
	});
};

--- END OF shared\utils\markdownUtils.js ---

--- FILE: shared\utils\textUtils.js ---
/**
 * Text Processing Utilities
 * String manipulation, sanitization, and formatting
 */

/**
 * Truncate text to a maximum length with ellipsis
 * @param {string} text - Text to truncate
 * @param {number} maxLength - Maximum length
 * @returns {string}
 */
export const truncate = (text, maxLength = 100) => {
	if (!text || text.length <= maxLength) return text;
	return text.slice(0, maxLength).trim() + '...';
};

/**
 * Sanitize text for safe display
 * @param {string} text - Text to sanitize
 * @returns {string}
 */
export const sanitizeText = (text) => {
	if (!text) return '';
	return String(text).trim();
};

/**
 * Convert text to URL-safe slug
 * @param {string} text - Text to convert
 * @returns {string}
 */
export const slugify = (text) => {
	if (!text) return '';

	return text
		.toString()
		.toLowerCase()
		.trim()
		.replace(/\s+/g, '-') // Replace spaces with -
		.replace(/[^\w-]+/g, '') // Remove non-word chars
		.replace(/--+/g, '-') // Replace multiple - with single -
		.replace(/^-+/, '') // Trim - from start
		.replace(/-+$/, ''); // Trim - from end
};

/**
 * Generate a unique ID from text (for headings, anchors)
 * @param {string} text - Text to convert
 * @returns {string}
 */
export const generateId = (text) => {
	if (!text) return '';

	return text
		.toString()
		.toLowerCase()
		.trim()
		.replace(/\s+/g, '-')
		.replace(/[^\w-]+/g, '')
		.replace(/--+/g, '-');
};

/**
 * Extract plain text from children (for React components)
 * @param {*} children - React children
 * @returns {string}
 */
export const extractText = (children) => {
	if (typeof children === 'string') return children;
	if (Array.isArray(children)) return children.map(extractText).join('');
	if (children?.props?.children) return extractText(children.props.children);
	return '';
};

/**
 * Capitalize first letter of string
 * @param {string} text - Text to capitalize
 * @returns {string}
 */
export const capitalize = (text) => {
	if (!text) return '';
	return text.charAt(0).toUpperCase() + text.slice(1);
};

/**
 * Convert snake_case or kebab-case to Title Case
 * @param {string} text - Text to convert
 * @returns {string}
 */
export const toTitleCase = (text) => {
	if (!text) return '';

	return text
		.replace(/[_-]/g, ' ')
		.split(' ')
		.map((word) => capitalize(word))
		.join(' ');
};

/**
 * Count words in text
 * @param {string} text - Text to count
 * @returns {number}
 */
export const wordCount = (text) => {
	if (!text) return 0;
	return text.trim().split(/\s+/).length;
};

/**
 * Estimate reading time in minutes
 * @param {string} text - Text to analyze
 * @param {number} wordsPerMinute - Reading speed (default 200)
 * @returns {number}
 */
export const estimateReadingTime = (text, wordsPerMinute = 200) => {
	const words = wordCount(text);
	return Math.ceil(words / wordsPerMinute);
};

/**
 * Escape special regex characters
 * @param {string} str - String to escape
 * @returns {string}
 */
export const escapeRegex = (str) => {
	return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
};

/**
 * Strip markdown formatting (basic)
 * @param {string} text - Markdown text
 * @returns {string} Plain text
 */
export const stripMarkdown = (text) => {
	if (!text) return '';

	return text
		.replace(/#{1,6}\s+/g, '') // Headers
		.replace(/\*\*(.+?)\*\*/g, '$1') // Bold
		.replace(/\*(.+?)\*/g, '$1') // Italic
		.replace(/\[(.+?)\]\(.+?\)/g, '$1') // Links
		.replace(/`(.+?)`/g, '$1') // Code
		.replace(/^>\s+/gm, '') // Blockquotes
		.trim();
};

/**
 * Check if text contains markdown formatting
 * @param {string} text - Text to check
 * @returns {boolean}
 */
export const hasMarkdown = (text) => {
	if (!text) return false;

	const markdownPatterns = [
		/#{1,6}\s+/, // Headers
		/\*\*.*?\*\*/, // Bold
		/\*.*?\*/, // Italic
		/\[.*?\]\(.*?\)/, // Links
		/`.*?`/, // Code
		/^>\s+/m, // Blockquotes
		/^[-*+]\s+/m, // Lists
		/^\d+\.\s+/m, // Ordered lists
	];

	return markdownPatterns.some((pattern) => pattern.test(text));
};

/**
 * Formats a YYYY-MM-DD string into a readable date (e.g., "Dec 06, 2025")
 */
export const formatDate = (dateString) => {
	if (!dateString) return '';
	const options = { year: 'numeric', month: 'short', day: '2-digit' };
	try {
		return new Date(dateString).toLocaleDateString('en-US', options);
	} catch (e) {
		return dateString;
	}
};

--- END OF shared\utils\textUtils.js ---

--- FILE: shared\utils\theme\colorUtils.js ---
/**
 * Color and Theme Utilities
 * Color manipulation, hex/rgb conversion, opacity
 */

/**
 * Convert hex color to RGB
 * @param {string} hex - Hex color (e.g., "#ff0000" or "ff0000")
 * @returns {{r: number, g: number, b: number}|null}
 */
export const hexToRgb = (hex) => {
	if (!hex) return null;

	// Remove # if present
	const cleanHex = hex.replace('#', '');

	// Validate hex
	if (!/^[0-9A-F]{6}$/i.test(cleanHex)) return null;

	return {
		r: parseInt(cleanHex.slice(0, 2), 16),
		g: parseInt(cleanHex.slice(2, 4), 16),
		b: parseInt(cleanHex.slice(4, 6), 16),
	};
};

/**
 * Convert RGB to hex
 * @param {number} r - Red (0-255)
 * @param {number} g - Green (0-255)
 * @param {number} b - Blue (0-255)
 * @returns {string} Hex color
 */
export const rgbToHex = (r, g, b) => {
	const toHex = (n) => {
		const hex = Math.max(0, Math.min(255, Math.round(n))).toString(16);
		return hex.length === 1 ? '0' + hex : hex;
	};

	return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
};

/**
 * Add opacity to hex color
 * @param {string} hex - Hex color
 * @param {number} opacity - Opacity (0-1)
 * @returns {string} rgba() string
 */
export const hexWithOpacity = (hex, opacity) => {
	const rgb = hexToRgb(hex);
	if (!rgb) return hex;

	return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity})`;
};

/**
 * Lighten a hex color by percentage
 * @param {string} hex - Hex color
 * @param {number} percent - Percentage to lighten (0-100)
 * @returns {string} New hex color
 */
export const lightenColor = (hex, percent) => {
	const rgb = hexToRgb(hex);
	if (!rgb) return hex;

	const amount = (percent / 100) * 255;

	return rgbToHex(rgb.r + amount, rgb.g + amount, rgb.b + amount);
};

/**
 * Darken a hex color by percentage
 * @param {string} hex - Hex color
 * @param {number} percent - Percentage to darken (0-100)
 * @returns {string} New hex color
 */
export const darkenColor = (hex, percent) => {
	const rgb = hexToRgb(hex);
	if (!rgb) return hex;

	const amount = (percent / 100) * 255;

	return rgbToHex(rgb.r - amount, rgb.g - amount, rgb.b - amount);
};

/**
 * Get contrasting text color (black or white) for background
 * @param {string} hex - Background hex color
 * @returns {string} '#000000' or '#ffffff'
 */
export const getContrastColor = (hex) => {
	const rgb = hexToRgb(hex);
	if (!rgb) return '#000000';

	// Calculate relative luminance
	const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;

	return luminance > 0.5 ? '#000000' : '#ffffff';
};

/**
 * Check if a color is light or dark
 * @param {string} hex - Hex color
 * @returns {'light'|'dark'}
 */
export const getColorBrightness = (hex) => {
	return getContrastColor(hex) === '#000000' ? 'light' : 'dark';
};

/**
 * Generate color palette from base color
 * @param {string} hex - Base hex color
 * @returns {Object} Palette with shades
 */
export const generatePalette = (hex) => {
	return {
		50: lightenColor(hex, 45),
		100: lightenColor(hex, 40),
		200: lightenColor(hex, 30),
		300: lightenColor(hex, 20),
		400: lightenColor(hex, 10),
		500: hex,
		600: darkenColor(hex, 10),
		700: darkenColor(hex, 20),
		800: darkenColor(hex, 30),
		900: darkenColor(hex, 40),
	};
};

/**
 * Parse CSS color value (hex, rgb, rgba)
 * @param {string} color - CSS color string
 * @returns {{r: number, g: number, b: number, a: number}|null}
 */
export const parseColor = (color) => {
	if (!color) return null;

	// Hex
	if (color.startsWith('#')) {
		const rgb = hexToRgb(color);
		return rgb ? { ...rgb, a: 1 } : null;
	}

	// RGB/RGBA
	const rgbaMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
	if (rgbaMatch) {
		return {
			r: parseInt(rgbaMatch[1]),
			g: parseInt(rgbaMatch[2]),
			b: parseInt(rgbaMatch[3]),
			a: rgbaMatch[4] ? parseFloat(rgbaMatch[4]) : 1,
		};
	}

	return null;
};

--- END OF shared\utils\theme\colorUtils.js ---

--- FILE: shared\utils\theme\cssUtils.js ---
/**
 * CSS Variable Utilities
 * Read and write CSS custom properties
 */

/**
 * Get CSS variable value from document root
 * @param {string} name - Variable name (with or without --)
 * @returns {string} Variable value
 */
export const getCSSVariable = (name) => {
	const varName = name.startsWith('--') ? name : `--${name}`;
	return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
};

/**
 * Set CSS variable on document root
 * @param {string} name - Variable name (with or without --)
 * @param {string} value - Variable value
 */
export const setCSSVariable = (name, value) => {
	const varName = name.startsWith('--') ? name : `--${name}`;
	document.documentElement.style.setProperty(varName, value);
};

/**
 * Get all theme CSS variables
 * @returns {Object} Theme variables
 */
export const getThemeVariables = () => {
	return {
		background: getCSSVariable('--background'),
		foreground: getCSSVariable('--foreground'),
		muted: getCSSVariable('--muted'),
		mutedForeground: getCSSVariable('--muted-foreground'),
		border: getCSSVariable('--border'),
		accent: getCSSVariable('--accent'),
		accentForeground: getCSSVariable('--accent-foreground'),
	};
};

/**
 * Apply theme variables
 * @param {Object} theme - Theme variable object
 */
export const applyTheme = (theme) => {
	Object.entries(theme).forEach(([key, value]) => {
		// Convert camelCase to kebab-case
		const cssKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();
		setCSSVariable(cssKey, value);
	});
};

/**
 * Get current theme mode (light/dark/dnd)
 * @returns {string} Theme mode
 */
export const getCurrentTheme = () => {
	return document.documentElement.getAttribute('data-theme') || 'light';
};

/**
 * Set theme mode
 * @param {string} theme - Theme name (light/dark/dnd)
 */
export const setTheme = (theme) => {
	if (theme === 'light') {
		document.documentElement.removeAttribute('data-theme');
	} else {
		document.documentElement.setAttribute('data-theme', theme);
	}
	localStorage.setItem('app-theme', theme);
};

/**
 * Get stored theme preference
 * @returns {string} Stored theme or 'light'
 */
export const getStoredTheme = () => {
	return localStorage.getItem('app-theme') || 'light';
};

/**
 * Check if system prefers dark mode
 * @returns {boolean}
 */
export const prefersDarkMode = () => {
	return window.matchMedia('(prefers-color-scheme: dark)').matches;
};

/**
 * Get optimal theme based on preference and system
 * @returns {string} Theme name
 */
export const getOptimalTheme = () => {
	const stored = getStoredTheme();
	if (stored !== 'auto') return stored;

	return prefersDarkMode() ? 'dark' : 'light';
};

--- END OF shared\utils\theme\cssUtils.js ---

