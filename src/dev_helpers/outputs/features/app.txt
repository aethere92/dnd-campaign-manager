================================================================
PARTIAL BUNDLE: APP
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        AdvancedFilter.jsx
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
      utils/
        filterUtils.js
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: app\App.jsx ---
import { useEffect } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { TooltipProvider } from '@/features/smart-tooltip/TooltipContext';
import { CampaignProvider, useCampaign } from '@/features/campaign/CampaignContext';
import ErrorBoundary from '@/shared/components/ErrorBoundary';
import { AppRoutes } from './AppRoutes';

function AppContent() {
	const { campaignId } = useCampaign();
	const queryClient = useQueryClient();

	// 1. Set global texture
	useEffect(() => {
		const texturePath = `${import.meta.env.BASE_URL}images/global/backgrounds/background_texture.webp`;
		document.documentElement.style.setProperty('--bg-texture', `url('${texturePath}')`);
	}, []);

	// 2. Set Default App Title
	useEffect(() => {
		document.title = 'D&D Campaign Manager';
	}, []);

	// 3. Clear cache when campaign changes
	useEffect(() => {
		if (campaignId) {
			queryClient.invalidateQueries({
				predicate: (query) => {
					const key = query.queryKey[0];
					return ['entities', 'entry', 'timeline', 'graph', 'entityIndex', 'globalSearch'].includes(key);
				},
			});
		}
	}, [campaignId, queryClient]);

	return (
		<TooltipProvider>
			<AppRoutes />
		</TooltipProvider>
	);
}

export default function App() {
	return (
		<ErrorBoundary>
			<CampaignProvider>
				<AppContent />
			</CampaignProvider>
		</ErrorBoundary>
	);
}

--- END OF app\App.jsx ---

--- FILE: app\AppRoutes.jsx ---
import { Routes, Route, Navigate } from 'react-router-dom';
import { Suspense, lazy } from 'react';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { RouteLoading } from './components/RouteLoading';

const CampaignSelect = lazy(() => import('@/features/campaign/components/CampaignSelect'));
const MainLayout = lazy(() => import('@/features/navigation/MainLayout'));
const DashboardPage = lazy(() => import('@/features/dashboard/DashboardPage'));
const MapPage = lazy(() => import('@/features/atlas/MapPage'));
const TimelinePage = lazy(() => import('@/features/timeline/TimelinePage'));
const GraphPage = lazy(() => import('@/features/graph/GraphPage'));
const WikiLayout = lazy(() => import('@/features/wiki/WikiLayout'));
const WikiDetailPage = lazy(() => import('@/features/wiki/pages/WikiDetailPage'));
const WikiLandingPage = lazy(() => import('@/features/wiki/pages/WikiLandingPage'));

// Admin Features
const AdminLayout = lazy(() => import('@/features/admin/layouts/AdminLayout'));
const SplitPaneManager = lazy(() => import('@/features/admin/pages/SplitPaneManager'));
const BulkReplaceTool = lazy(() => import('@/features/admin/pages/BulkReplaceTool'));

export const AppRoutes = () => {
	const { campaignId } = useCampaign();
	const isDev = import.meta.env.DEV;

	return (
		<Suspense fallback={<RouteLoading text='Loading Application...' />}>
			<Routes>
				{/* Admin Console */}
				{isDev && (
					<Route path='/dm' element={<AdminLayout />}>
						<Route index element={<Navigate to='/dm/manage/campaign' replace />} />
						<Route path='manage/:type/:id?' element={<SplitPaneManager />} />
						<Route path='tools/replace' element={<BulkReplaceTool />} />
					</Route>
				)}

				{/* Campaign Selection */}
				<Route path='/select-campaign' element={<CampaignSelect />} />

				{/* Main App */}
				{campaignId ? (
					<Route path='/' element={<MainLayout />}>
						<Route index element={<DashboardPage />} />

						<Route path='atlas/:mapId' element={<MapPage />} />
						<Route path='atlas' element={<Navigate to='/atlas/world_map' replace />} />
						<Route path='timeline' element={<TimelinePage />} />
						<Route path='relationships' element={<GraphPage />} />

						<Route path='wiki/:type' element={<WikiLayout />}>
							<Route index element={<WikiLandingPage />} />
							<Route path=':entityId' element={<WikiDetailPage />} />
						</Route>

						<Route path='*' element={<Navigate to='/' replace />} />
					</Route>
				) : (
					<Route path='*' element={<Navigate to='/select-campaign' replace />} />
				)}
			</Routes>
		</Suspense>
	);
};

--- END OF app\AppRoutes.jsx ---

--- FILE: app\components\RouteLoading.jsx ---
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export const RouteLoading = ({ text }) => (
	<div className='flex items-center justify-center h-full min-h-screen bg-muted'>
		<LoadingSpinner size='lg' text={text} />
	</div>
);

--- END OF app\components\RouteLoading.jsx ---

--- FILE: app\styles\global.css ---
@import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&family=Spectral:wght@400;500;600;700&display=swap');
@import 'tailwindcss';
@plugin "@tailwindcss/typography";

@theme {
	--font-sans: 'Inter', sans-serif;
	--font-serif: 'Inter', serif;
	--font-display: 'Crimson Text', serif;

	/* Semantic Color Mapping */
	--color-background: var(--background);
	--color-foreground: var(--foreground);
	--color-card: var(--card);
	--color-card-foreground: var(--card-foreground);
	--color-popover: var(--popover);
	--color-popover-foreground: var(--popover-foreground);
	--color-primary: var(--primary);
	--color-primary-foreground: var(--primary-foreground);
	--color-secondary: var(--secondary);
	--color-secondary-foreground: var(--secondary-foreground);
	--color-muted: var(--muted);
	--color-muted-foreground: var(--muted-foreground);
	--color-accent: var(--accent);
	--color-accent-foreground: var(--accent-foreground);
	--color-destructive: var(--destructive);
	--color-destructive-foreground: var(--destructive-foreground);
	--color-border: var(--border);
	--color-input: var(--input);
	--color-ring: var(--ring);
}

@layer base {
	* {
		@apply border-border;
	}
	html,
	body,
	#root {
		height: 100%;
		height: 100dvh;
		overflow: hidden;
		overscroll-behavior: none;
		-webkit-tap-highlight-color: transparent;
	}
	body {
		@apply bg-background text-foreground antialiased font-sans;
	}
	/* Heading Defaults */
	h1,
	h2,
	h3,
	h4,
	h5,
	h6 {
		@apply font-serif font-bold text-foreground;
	}
}

/* --- THEME DEFINITIONS --- */

/* LIGHT MODE */
:root {
	--background: #ffffff;
	--foreground: #09090b;
	--card: #ffffff;
	--card-foreground: #09090b;
	--popover: #ffffff;
	--popover-foreground: #09090b;
	--primary: #d97706;
	--primary-foreground: #ffffff;
	--secondary: #f4f4f5;
	--secondary-foreground: #18181b;
	--muted: #f4f4f5;
	--muted-foreground: #71717a;
	--accent: #f4f4f5;
	--accent-foreground: #18181b;
	--destructive: #ef4444;
	--destructive-foreground: #fafafa;
	--border: #e4e4e7;
	--input: #e4e4e7;
	--ring: #d97706;
	--radius: 0.5rem;
}

/* DARK MODE (Zinc) */
[data-theme='dark'] {
	--background: rgb(17 17 17);
	--foreground: #eee;
	--card: #18181b;
	--card-foreground: #fafafa;
	--popover: #18181b;
	--popover-foreground: #fafafa;
	--primary: #f59e0b;
	--primary-foreground: #09090b;
	--secondary: #27272a;
	--secondary-foreground: #fafafa;
	--muted: #1c1c1f;
	--muted-foreground: #a1a1aa;
	--accent: #27272a;
	--accent-foreground: #fafafa;
	--destructive: #ef4444;
	--destructive-foreground: #fafafa;
	--border: #27272a;
	--input: #27272a;
	--ring: #f59e0b;
}

/* D&D MODE (Parchment) */
[data-theme='dnd'] {
	--background: #fdfbf7;
	--foreground: #2c1a11;
	--card: #fdfbf7;
	--card-foreground: #1b1b1b;
	--popover: #fdfbf7;
	--popover-foreground: #1b1b1b;
	--primary: #d97706; /* Amber-600 */
	--primary-foreground: #ffffff;
	--secondary: #f2efe9;
	--secondary-foreground: #1b1b1b;
	--muted: #f2efe9;
	--muted-foreground: #5f5a52;
	--accent: #f2efe9;
	--accent-foreground: #1b1b1b;
	--destructive: #991b1b;
	--destructive-foreground: #ffffff;
	--border: #cecece;
	--input: #c9c2b8;
	--ring: #8b1e1e;

	--entity-session: #5f5a52;
	--entity-character: #c10007; /* Deep blood red */
	--entity-npc: #bb4d00; /* Burnt Sienna */
	--entity-location: #007a55; /* Deep Forest/Moss green */
	--entity-quest: #1447e6; /* Deep Navy ink */
	--entity-faction: #8200db; /* Royal Plum ink */
	--entity-encounter: #ca3500; /* Iron Oxide */

	text-rendering: optimizeLegibility;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;
}

[data-theme='dnd'] .prose,
[data-theme='dnd'] body {
	text-shadow: 0 0 0.15px rgba(44, 26, 17, 0.1);
}

/* D&D Mode Texture */
[data-theme='dnd'] .bg-background {
	background-color: var(--background);
	background-image: var(--bg-texture, none);
	background-repeat: repeat;
}

[data-theme='dnd'] .bg-muted {
	background-color: var(--muted);
	border-right-color: #c9c2b8;
}

/* --- TYPOGRAPHY (Prose) --- */
.prose {
	--tw-prose-body: var(--foreground);
	--tw-prose-headings: var(--foreground);
	--tw-prose-lead: var(--muted-foreground);
	--tw-prose-links: var(--primary);
	--tw-prose-bold: var(--foreground);
	--tw-prose-counters: var(--muted-foreground);
	--tw-prose-bullets: var(--primary);
	--tw-prose-hr: var(--border);
	--tw-prose-quotes: var(--foreground);
	--tw-prose-quote-borders: var(--primary);
	--tw-prose-captions: var(--muted-foreground);
	--tw-prose-code: var(--foreground);
	--tw-prose-pre-code: var(--foreground);
	--tw-prose-pre-bg: var(--muted);
	--tw-prose-th-borders: var(--border);
	--tw-prose-td-borders: var(--border);

	font-family: var(--font-sans);
	max-width: none;
}

/* Prose Dark Mode Overrides */
[data-theme='dark'] .prose {
	--tw-prose-body: var(--foreground);
	--tw-prose-headings: var(--foreground);
	--tw-prose-lead: var(--muted-foreground);
	--tw-prose-links: var(--primary);
	--tw-prose-bold: var(--foreground);
	--tw-prose-counters: var(--muted-foreground);
	--tw-prose-bullets: var(--primary);
	--tw-prose-hr: var(--border);
	--tw-prose-quotes: var(--muted-foreground);
	--tw-prose-quote-borders: var(--primary);
	--tw-prose-captions: var(--muted-foreground);
	--tw-prose-code: var(--accent-foreground);
	--tw-prose-pre-code: var(--accent-foreground);
	--tw-prose-pre-bg: var(--card);
	--tw-prose-th-borders: var(--border);
	--tw-prose-td-borders: var(--border);
}

/* D&D Mode Prose Styling */
[data-theme='dnd'] .prose h1,
[data-theme='dnd'] .prose h2,
[data-theme='dnd'] .prose h3 {
	font-family: var(--font-serif);
	color: var(--foreground);
	border-bottom-color: var(--border);
}

.prose h3:first-of-type {
	margin-top: 0 !important;
}

/* --- SCROLLBAR --- */
.custom-scrollbar::-webkit-scrollbar {
	width: 6px;
	height: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
	background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
	background: var(--border);
	border-radius: 99px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
	background: var(--muted-foreground);
}

/* --- SAFE AREA INSETS --- */
.pt-safe {
	padding-top: env(safe-area-inset-top, 20px);
}
.pb-safe {
	padding-bottom: env(safe-area-inset-bottom, 20px);
}
.pl-safe {
	padding-left: env(safe-area-inset-left, 0px);
}
.pr-safe {
	padding-right: env(safe-area-inset-right, 0px);
}

/* --- COMPREHENSIVE COMPATIBILITY OVERRIDES --- */

/* Background Colors */
.bg-white {
	background-color: var(--card) !important;
}
.bg-gray-50,
.bg-slate-50,
.bg-stone-50,
.bg-zinc-50 {
	background-color: var(--muted) !important;
}
.bg-gray-100,
.bg-slate-100,
.bg-stone-100,
.bg-zinc-100 {
	background-color: var(--muted) !important;
}
.bg-gray-200,
.bg-slate-200,
.bg-stone-200,
.bg-zinc-200 {
	background-color: var(--border) !important;
}

/* Text Colors - Foreground */
.text-gray-900,
.text-slate-900,
.text-stone-900,
.text-zinc-900 {
	color: var(--foreground) !important;
}
.text-gray-800,
.text-slate-800,
.text-stone-800,
.text-zinc-800 {
	color: var(--foreground) !important;
}
.text-gray-700,
.text-slate-700,
.text-stone-700,
.text-zinc-700 {
	color: var(--card-foreground) !important;
}

/* Text Colors - Muted */
.text-gray-600,
.text-slate-600,
.text-stone-600,
.text-zinc-600 {
	color: var(--muted-foreground) !important;
}
.text-gray-500,
.text-slate-500,
.text-stone-500,
.text-zinc-500 {
	color: var(--muted-foreground) !important;
}
.text-gray-400,
.text-slate-400,
.text-stone-400,
.text-zinc-400 {
	color: var(--muted-foreground) !important;
}

/* Border Colors */
.border-gray-200,
.border-slate-200,
.border-stone-200,
.border-zinc-200 {
	border-color: var(--border) !important;
}
.border-gray-300,
.border-slate-300,
.border-stone-300,
.border-zinc-300 {
	border-color: var(--border) !important;
}

/* Divide Colors */
.divide-gray-200,
.divide-slate-200,
.divide-stone-200,
.divide-zinc-200 {
	border-color: var(--border) !important;
}

/* Ring Colors */
.ring-gray-200,
.ring-slate-200,
.ring-stone-200,
.ring-zinc-200 {
	--tw-ring-color: var(--border) !important;
}

/* Opacity Variants */
.bg-black\/5 {
	background-color: color-mix(in srgb, var(--foreground) 5%, transparent) !important;
}
.bg-black\/10 {
	background-color: color-mix(in srgb, var(--foreground) 10%, transparent) !important;
}
.bg-white\/5 {
	background-color: color-mix(in srgb, var(--background) 5%, transparent) !important;
}
.bg-white\/10 {
	background-color: color-mix(in srgb, var(--background) 10%, transparent) !important;
}

/* Hover States */
.hover\:bg-black\/5:hover {
	background-color: color-mix(in srgb, var(--foreground) 5%, transparent) !important;
}
.hover\:bg-black\/10:hover {
	background-color: color-mix(in srgb, var(--foreground) 10%, transparent) !important;
}

/* Special fallback for header background */
.header-bg-fallback {
	background: linear-gradient(to bottom, color-mix(in srgb, var(--primary) 10%, var(--muted)), var(--background));
}

/* Leaflet Map Fixes for Dark Mode AND D&D Mode */
.leaflet-container {
	/* background-color: var(--background) !important; */
	font-family: var(--font-sans) !important;
}

/* Ensure popups use theme colors */
.leaflet-popup-content-wrapper {
	background-color: var(--card) !important;
	color: var(--card-foreground) !important;
	border-radius: 0.5rem !important; /* rounded-lg */
	box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1) !important; /* shadow-lg */
	padding: 0 !important;
	margin: 0 !important;
}

.leaflet-popup-tip {
	background-color: var(--card) !important;
}

/* Marker Popup Cards */
.marker-popup-card {
	@apply bg-card border-0; /* Remove border since wrapper has shadow */
}

.marker-popup-header {
	@apply bg-muted px-3 py-2 border-b border-border;
}

.marker-popup-category {
	@apply text-xs font-bold uppercase tracking-wider text-muted-foreground;
}

.marker-popup-title {
	@apply font-serif font-bold text-foreground text-sm;
}

.marker-popup-body {
	@apply p-3 text-sm text-muted-foreground;
}

/* FIX: Status Badge Semantic Colors */
.badge-alive {
	@apply border-emerald-600/50 bg-emerald-500/20 text-emerald-700;
}
.badge-dead {
	@apply border-red-600/50 bg-red-500/20 text-red-700;
}

/* Dark Mode Overrides */
[data-theme='dark'] .badge-alive {
	@apply text-emerald-400;
}
[data-theme='dark'] .badge-dead {
	@apply text-red-400;
}

/* Custom Clean Popup - Zero padding for custom cards */
.custom-popup-clean .leaflet-popup-content-wrapper {
	padding: 0 !important;
	overflow: hidden !important;
	background: transparent !important; /* Let the card handle bg */
	border: none !important;
	box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1) !important;
	margin: 0 !important;
}

.custom-popup-clean .leaflet-popup-content {
	margin: 0 !important;
	width: 300px !important; /* Fixed width for consistency */
	line-height: 1.5 !important;
	padding: 0 !important;
}

/* Ensure the tip matches the theme card color */
.custom-popup-clean .leaflet-popup-tip {
	background-color: var(--card) !important;
}

.leaflet-popup-content {
	padding: 0 !important;
	margin: 0 !important;
}

--- END OF app\styles\global.css ---

