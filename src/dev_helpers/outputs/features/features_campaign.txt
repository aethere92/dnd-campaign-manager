================================================================
PARTIAL BUNDLE: FEATURES CAMPAIGN
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        AdvancedFilter.jsx
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
      utils/
        filterUtils.js
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
        campaign_02/
          index.js
          faerun/
            index.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignData.js
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\campaign\CampaignContext.jsx ---
import { createContext, useContext, useMemo } from 'react';
import { useCampaignPersistence } from './useCampaignPersistence';
import { useCampaignData } from './useCampaignData'; // Import the new hook

const CampaignContext = createContext(null);

export const CampaignProvider = ({ children }) => {
	// 1. Manage ID Persistence
	const { campaignId, setCampaignId } = useCampaignPersistence();

	// 2. Fetch Data based on ID
	const { campaignRow, campaignData, isLoading } = useCampaignData(campaignId);

	// 3. Combine into a single context value
	const value = useMemo(
		() => ({
			campaignId,
			setCampaignId,
			campaignRow, // The DB metadata
			campaignData, // The Resolved JS Map Config
			isLoading,
		}),
		[campaignId, setCampaignId, campaignRow, campaignData, isLoading]
	);

	return <CampaignContext.Provider value={value}>{children}</CampaignContext.Provider>;
};

export const useCampaign = () => {
	const context = useContext(CampaignContext);
	if (!context) {
		throw new Error('useCampaign must be used within CampaignProvider');
	}
	return context;
};

--- END OF features\campaign\CampaignContext.jsx ---

--- FILE: features\campaign\useCampaignData.js ---
import { useState, useEffect } from 'react';
import { supabase } from '@/shared/api/supabaseClient';
import { CAMPAIGN_REGISTRY } from '@/features/atlas/utils/mapNavigation';

export function useCampaignData(campaignId) {
	const [campaignRow, setCampaignRow] = useState(null);
	const [campaignData, setCampaignData] = useState(null);
	const [isLoading, setIsLoading] = useState(false);
	const [error, setError] = useState(null);

	useEffect(() => {
		// If no ID is selected, reset everything
		if (!campaignId) {
			setCampaignRow(null);
			setCampaignData(null);
			return;
		}

		const fetchCampaign = async () => {
			setIsLoading(true);
			try {
				// 1. Fetch the specific campaign row
				const { data, error } = await supabase.from('campaigns').select('*').eq('id', campaignId).single();

				if (error) throw error;

				setCampaignRow(data);

				// 2. Resolve the Map Config Object
				// The DB attribute "map_data" holds the string key (e.g. "campaign_002_map_data")
				const mapDataKey = data?.attributes?.map_data;

				if (mapDataKey && CAMPAIGN_REGISTRY[mapDataKey]) {
					setCampaignData(CAMPAIGN_REGISTRY[mapDataKey]);
				} else {
					console.warn(`[useCampaignData] Registry key not found or empty: ${mapDataKey}`);
					setCampaignData(null);
				}
			} catch (err) {
				console.error('[useCampaignData] Error loading campaign:', err);
				setError(err);
			} finally {
				setIsLoading(false);
			}
		};

		fetchCampaign();
	}, [campaignId]);

	return { campaignRow, campaignData, isLoading, error };
}

--- END OF features\campaign\useCampaignData.js ---

--- FILE: features\campaign\useCampaignPersistence.js ---
import { useState, useCallback } from 'react';

const STORAGE_KEY = 'campaignId';

// Safe wrapper for environments where localStorage might fail
const storage = {
	getItem: (key) => {
		try {
			return localStorage.getItem(key) || sessionStorage.getItem(key);
		} catch {
			return null;
		}
	},
	setItem: (key, value) => {
		try {
			localStorage.setItem(key, value);
		} catch {
			sessionStorage.setItem(key, value);
		}
	},
	removeItem: (key) => {
		try {
			localStorage.removeItem(key);
			sessionStorage.removeItem(key);
		} catch {
			// ignore
		}
	},
};

export function useCampaignPersistence() {
	const [campaignId, setCampaignIdState] = useState(() => {
		return storage.getItem(STORAGE_KEY) || null;
	});

	const setCampaignId = useCallback((id) => {
		setCampaignIdState(id);
		if (id) {
			storage.setItem(STORAGE_KEY, id);
		} else {
			storage.removeItem(STORAGE_KEY);
		}
	}, []);

	return { campaignId, setCampaignId };
}

--- END OF features\campaign\useCampaignPersistence.js ---

--- FILE: features\campaign\useCampaignSelection.js ---
import { useQuery } from '@tanstack/react-query';
import { useNavigate } from 'react-router-dom';
import { getCampaigns } from '@/features/campaign/api/campaignService';
import { useCampaign } from './CampaignContext';
// import './types';

export function useCampaignSelection() {
	const { setCampaignId } = useCampaign();
	const navigate = useNavigate(); // 2. Initialize hook

	const { data: campaigns, isLoading } = useQuery({
		queryKey: ['campaigns'],
		queryFn: getCampaigns,
	});

	// Sort by ID
	const sortedCampaigns = (campaigns || []).sort((a, b) => String(a.campaign_id).localeCompare(String(b.campaign_id)));

	const selectCampaign = (id) => {
		setCampaignId(id);
		navigate('/'); // 3. Force navigation to the main app route
	};

	return {
		isLoading,
		campaigns: sortedCampaigns,
		selectCampaign,
	};
}

--- END OF features\campaign\useCampaignSelection.js ---

--- FILE: features\campaign\api\campaignService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getCampaigns = async () => {
	/**
	 * OPTIMIZATION:
	 * Instead of fetching all entities and filtering in JS or via multiple query params,
	 * we join 'view_active_party'. This SQL view already filters for:
	 * (attributes->>'is_active')::boolean = true
	 */
	const { data, error } = await supabase.from('campaigns').select(`
            id,
            campaign_id,
            name, 
            description,
            attributes,
            active_characters:view_active_party(name)
        `);

	if (error) {
		console.error('[campaignService] Error fetching campaigns:', error);
		throw error;
	}

	// Clean up the nested structure
	return data.map((campaign) => ({
		...campaign,
		// Map the view results to the characterNames array used by the UI
		characterNames: campaign.active_characters?.map((c) => c.name) || [],
	}));
};

--- END OF features\campaign\api\campaignService.js ---

--- FILE: features\campaign\components\CampaignCard.jsx ---
import { ArrowRight, Users, Map, BookOpen } from 'lucide-react';
import Button from '@/shared/components/ui/Button';
import { clsx } from 'clsx';

export const CampaignCard = ({ campaign, onSelect }) => {
	const initial = (campaign.name?.[0] || 'C').toUpperCase();
	const bgImage = campaign.attributes?.background_image;
	const campaignIcon = campaign.attributes?.icon; // Check for icon in attributes
	const mapData = campaign.attributes?.map_data ? 'Atlas active' : 'No Atlas';

	// Fallback pattern if no image is provided
	const hasBg = !!bgImage;

	return (
		<div className='group relative flex flex-col h-full bg-card rounded-xl border border-border hover:border-primary shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden'>
			{/* Banner / Header Image */}
			<div className={clsx('relative h-32 w-full shrink-0 overflow-hidden', !hasBg && 'bg-muted')}>
				{hasBg ? (
					<img
						src={bgImage}
						alt='Campaign Cover'
						className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
					/>
				) : (
					<div
						className='absolute inset-0 opacity-10'
						style={{
							backgroundImage: 'radial-gradient(circle at 2px 2px, currentColor 1px, transparent 0)',
							backgroundSize: '16px 16px',
						}}
					/>
				)}

				{/* Gradient Overlay for Text Readability/Transition */}
				<div className='absolute inset-0 bg-gradient-to-t from-card via-card/20 to-transparent' />
			</div>

			{/* Card Content */}
			<div className='flex flex-col flex-1 px-6 pb-6 relative'>
				{/* Avatar Badge (Icon or Initial) */}
				<div className='-mt-12 mb-6'>
					<div className='w-20 h-20 border-border rounded-xl bg-background border hover:shadow-md flex items-center justify-center overflow-hidden transition-colors'>
						{campaignIcon ? (
							<img src={campaignIcon} alt={`${campaign.name} icon`} className='w-full h-full object-cover' />
						) : (
							<span className='text-4xl font-serif font-bold text-primary/80 group-hover:text-primary'>{initial}</span>
						)}
					</div>
				</div>

				{/* Title & Description */}
				<div className='mb-6'>
					<h3 className='text-[clamp(1rem,5vw,1.2rem)] font-bold font-serif text-foreground leading-tight mb-2 group-hover:text-primary transition-colors'>
						{campaign.name}
					</h3>
					<p className='text-sm text-muted-foreground line-clamp-5 leading-relaxed'>
						{campaign.description || 'A journey into the unknown.'}
					</p>
				</div>

				{/* Metadata / Stats Row */}
				<div className='mt-auto pt-4 border-t border-border/50 grid grid-cols-2 gap-4 mb-6'>
					<div className='flex flex-col'>
						<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/70 mb-1 flex items-center gap-1.5'>
							<Users size={10} /> Party Size
						</span>
						<span className='text-sm font-medium text-foreground'>{campaign.characterNames?.length || 0} Heroes</span>
					</div>
					<div className='flex flex-col'>
						<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/70 mb-1 flex items-center gap-1.5'>
							<Map size={10} /> Setting
						</span>
						<span className='text-sm font-medium text-foreground'>{mapData}</span>
					</div>
				</div>

				{/* Action Button */}
				<Button
					onClick={() => onSelect(campaign.id)}
					fullWidth
					variant='outline'
					className='bg-primary text-primary-foreground border-primary transition-colors'
					icon={ArrowRight}>
					Enter Campaign
				</Button>
			</div>
		</div>
	);
};

--- END OF features\campaign\components\CampaignCard.jsx ---

--- FILE: features\campaign\components\CampaignSelect.jsx ---
import { useCampaignSelection } from '@/features/campaign/useCampaignSelection';
import { CampaignCard } from './CampaignCard';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { useTheme } from '@/shared/hooks/useTheme';
import { useMemo } from 'react';

export default function CampaignSelect() {
	// 1. Initialize Theme to ensure dark mode works on full-page reload
	const { theme } = useTheme();
	const isDark = theme === 'dark';

	const { campaigns, isLoading, selectCampaign } = useCampaignSelection();
	const logoPath = `${import.meta.env.BASE_URL}logo_detailed.png`;

	const backgroundStyle = useMemo(() => {
		if (isDark) {
			return {
				backgroundImage:
					'radial-gradient(circle at center, rgba(255,255,255,0.05) 1px, transparent 1px), radial-gradient(circle at center, rgba(255,255,255,0.03) 1px, transparent 1px)',
				backgroundSize: '40px 40px, 20px 20px',
				backgroundPosition: '0 0, 20px 20px',
				backgroundColor: 'var(--background)',
			};
		}
		return {
			backgroundColor: 'var(--background)',
			opacity: 0.9,
		};
	}, [isDark]);

	if (isLoading) {
		return (
			<div className='h-full w-full bg-muted flex flex-col items-center justify-center'>
				<LoadingSpinner size='lg' text='Consulting the Archives...' />
			</div>
		);
	}

	return (
		<div
			className='h-full w-full overflow-y-auto custom-scrollbar font-sans bg-background text-foreground'
			style={backgroundStyle}>
			<div className='min-h-full w-full flex items-center justify-center p-6 md:p-12'>
				<div className='max-w-6xl w-full mx-auto'>
					{/* Header Section */}
					<div className='text-center mb-12 animate-in fade-in slide-in-from-top-4 duration-700'>
						<img src={logoPath} alt='Logo' className='h-32 md:h-40 mx-auto mb-8 drop-shadow-2xl' />
						<h1 className='text-4xl md:text-5xl font-serif font-bold text-foreground mb-4'>Select Campaign</h1>
						<p className='text-muted-foreground text-lg max-w-xl mx-auto'>
							Choose a world to enter. Your adventures, characters, and chronicles await.
						</p>
					</div>

					{/* Grid Section */}
					<div className='flex flex-wrap justify-center gap-8 pb-8'>
						{campaigns.map((campaign) => (
							<div key={campaign.id} className='w-full md:w-[calc(50%-1rem)] lg:w-[calc(33.33%-1.5rem)] max-w-sm'>
								<CampaignCard campaign={campaign} onSelect={selectCampaign} />
							</div>
						))}

						{campaigns.length === 0 && (
							<div className='w-full py-20 text-center border-2 border-dashed border-border rounded-xl bg-card/50 backdrop-blur-sm shadow-sm'>
								<p className='text-muted-foreground/70 font-serif text-xl'>No campaigns found in the library.</p>
							</div>
						)}
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\campaign\components\CampaignSelect.jsx ---

