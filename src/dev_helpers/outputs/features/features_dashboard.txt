================================================================
PARTIAL BUNDLE: FEATURES DASHBOARD
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageLibrary.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\dashboard\DashboardPage.jsx ---
import { useQuery } from '@tanstack/react-query';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getDashboardData } from '@/features/dashboard/api/dashboardService';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { SectionDivider, SectionDividerVertical } from '@/shared/components/ui/SectionDivider';

import { CampaignHeader } from './components/CampaignHeader';
import { CurrentArcMetadata } from './components/CurrentArcMetadata';
import { CurrentStoryStack } from './components/CurrentStoryStack';
import { ArchiveTree } from './components/ArchiveTree';
import { InsightsGrid } from './components/InsightsGrid';
import { PartyWidget } from './components/PartyWidget';
import { ActiveThreads } from './components/ActiveThreads';

export default function DashboardView() {
	const { campaignId } = useCampaign();

	const { data, isLoading } = useQuery({
		queryKey: ['dashboard_final', campaignId],
		queryFn: () => getDashboardData(campaignId),
		enabled: !!campaignId,
		staleTime: 1000 * 60 * 5,
	});

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text='Opening chronicle...' fullScreen />;

	const { campaign, counts, currentArc, otherArcs, activeParty, activeThreads, stats } = data || {};

	const currentSessions = currentArc?.sessions || [];
	const latestSession = currentArc?.latestSession;
	const otherCurrentSessions = currentSessions.filter((s) => s.id !== latestSession?.id);

	return (
		<div className='h-full overflow-y-auto bg-background custom-scrollbar'>
			<div className='p-6 pb-12'>
				<div className='max-w-[1600px] mx-auto space-y-12'>
					{/* ROW 1: Campaign Hero */}
					<div className='w-full'>
						<CampaignHeader campaign={campaign} counts={counts} />
					</div>

					{/* ROW 2: Main Story Area */}
					<div className='grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch lg:min-h-[600px]'>
						{/* Left: Metadata */}
						<div className='lg:col-span-3'>
							<CurrentArcMetadata arc={currentArc?.data} />
						</div>

						{/* Middle: Unified Story Stack */}
						<div className='lg:col-span-6'>
							<CurrentStoryStack latestSession={latestSession} previousSessions={otherCurrentSessions} />
						</div>

						{/* Right: Archive */}
						<div className='lg:col-span-3'>
							<ArchiveTree arcs={otherArcs} />
						</div>
					</div>

					<SectionDivider className='my-6 mb-12' />

					{/* ROW 3: Status Panel */}
					<div className='bg-card/30 border border-border rounded-xl p-8 relative overflow-hidden min-h-[500px]'>
						<div
							className='absolute inset-0 opacity-[0.03] pointer-events-none'
							style={{ backgroundImage: 'radial-gradient(#fff 1px, transparent 1px)', backgroundSize: '24px 24px' }}
						/>

						<div className='grid grid-cols-1 lg:grid-cols-12 gap-12 relative z-10 h-full'>
							{/* Insights */}
							<div className='lg:col-span-5 h-full'>
								<InsightsGrid stats={stats} counts={counts} />
							</div>

							{/* Party */}
							<div className='lg:col-span-4 h-full'>
								<PartyWidget party={activeParty} />
							</div>

							{/* Threads (Simple List) */}
							<div className='lg:col-span-3 h-full'>
								<ActiveThreads quests={activeThreads} />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\dashboard\DashboardPage.jsx ---

--- FILE: features\dashboard\api\dashboardService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getDashboardData = async (campaignId) => {
	const [{ data: campaign }, { data: stats }, { data: activeParty }, { data: activeThreads }, { data: sessions }] =
		await Promise.all([
			supabase.from('campaigns').select('*').eq('id', campaignId).single(),
			supabase.from('view_dashboard_stats').select('*').eq('campaign_id', campaignId).single(),
			supabase.from('view_active_party').select('*').eq('campaign_id', campaignId),
			supabase.from('view_active_quests').select('*').eq('campaign_id', campaignId),
			supabase
				.from('view_session_arcs')
				.select('*')
				.eq('campaign_id', campaignId)
				.order('session_number', { ascending: false }),
		]);

	const allSessions = sessions || [];
	const latestSession = allSessions[0];

	// 1. Sort Threads (Quests)
	// Order: Main > Personal > Side, then by Priority
	const sortedThreads = sortThreads(activeThreads || []);

	// 2. Identify Current Arc
	const currentArcId = latestSession?.arc_id;

	// 3. Group Sessions into Arcs
	const arcMap = new Map();

	allSessions.forEach((session) => {
		if (!session.arc_id) return;

		if (!arcMap.has(session.arc_id)) {
			arcMap.set(session.arc_id, {
				id: session.arc_id,
				title: session.arc_title,
				description: session.arc_description,
				order: session.arc_order,
				attributes: session.arc_attributes,
				sessions: [],
			});
		}
		arcMap.get(session.arc_id).sessions.push(session);
	});

	// 4. Format Arcs
	const fullTimeline = Array.from(arcMap.values()).sort((a, b) => (b.order || 0) - (a.order || 0));
	const currentArcData = fullTimeline.find((a) => a.id === currentArcId);
	const otherArcs = fullTimeline.filter((a) => a.id !== currentArcId);

	const counts = {
		sessions: allSessions.length,
		arcs: fullTimeline.length,
		quests: sortedThreads.length,
		npcs: stats?.unique_npcs || 0,
		locations: stats?.unique_locations || 0,
		encounters: stats?.total_encounters || 0,
	};

	return {
		campaign,
		stats,
		activeParty: activeParty || [],
		activeThreads: sortedThreads, // Return the sorted list
		currentArc: {
			data: currentArcData,
			latestSession,
			sessions: currentArcData?.sessions || [],
		},
		otherArcs,
		progression: allSessions,
		counts,
	};
};

// --- Helper: Sorting Logic ---
function sortThreads(quests) {
	// Lower number = Higher importance
	const typeWeights = {
		'main quest': 1,
		'personal quest': 2,
		'side quest': 3,
	};

	const priorityWeights = {
		critical: 1,
		high: 2,
		medium: 3,
		normal: 4,
		low: 5,
	};

	return [...quests].sort((a, b) => {
		const typeA = (a.attributes?.type || '').toLowerCase();
		const typeB = (b.attributes?.type || '').toLowerCase();

		// 1. Primary Sort: Type
		// Default to 4 (bottom) if type is unknown
		const wA = typeWeights[typeA] || 4;
		const wB = typeWeights[typeB] || 4;

		if (wA !== wB) return wA - wB;

		// 2. Secondary Sort: Priority
		const prioA = (a.attributes?.priority || '').toLowerCase();
		const prioB = (b.attributes?.priority || '').toLowerCase();

		const pA = priorityWeights[prioA] || 4; // Default to Normal
		const pB = priorityWeights[prioB] || 4;

		return pA - pB;
	});
}

--- END OF features\dashboard\api\dashboardService.js ---

--- FILE: features\dashboard\components\ActiveThreads.jsx ---
import { useNavigate } from 'react-router-dom';
import { Scroll } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const ActiveThreads = ({ quests }) => {
	const navigate = useNavigate();
	// Show more quests now that we have height
	const displayQuests = quests?.slice(0, 12) || [];

	const handleRowClick = (id, e) => {
		// If the user clicked a link inside SmartMarkdown, don't trigger the row click
		if (e.target.tagName === 'A' || e.target.closest('a')) {
			return;
		}
		navigate(`/wiki/quest/${id}`);
	};

	return (
		<div className='h-full flex flex-col'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-6 shrink-0'>
				Active Threads
			</h4>

			<div className='space-y-3 overflow-y-auto custom-scrollbar flex-1 min-h-0 pr-2'>
				{displayQuests.map((quest) => {
					const priority = (quest.attributes?.priority || 'normal').toLowerCase();
					const isMain = (quest.attributes?.type || '').toLowerCase() === 'main quest';

					let prioColor = 'text-muted-foreground/50';
					if (priority === 'critical') prioColor = 'text-red-500';
					else if (priority === 'high') prioColor = 'text-orange-500';
					else if (isMain) prioColor = 'text-amber-500';

					return (
						<div
							key={quest.id}
							onClick={(e) => handleRowClick(quest.id, e)}
							className='block group py-1 cursor-pointer relative'>
							<div className='flex gap-1 min-w-0 justify-between'>
								<div
									className={clsx(
										'text-sm font-serif font-medium leading-snug group-hover:text-primary transition-colors line-clamp-1 truncate',
										isMain ? 'text-foreground font-bold' : 'text-foreground/80'
									)}>
									{/* Now safe to use because parent is a div, not an <a> */}
									<SmartMarkdown>{quest.title || quest.name}</SmartMarkdown>
								</div>

								<div className='flex items-center justify-between'>
									<span />
									{priority !== 'normal' && priority !== 'low' && (
										<span className={clsx('text-[9px] uppercase font-bold tracking-wider', prioColor)}>{priority}</span>
									)}
								</div>
							</div>
						</div>
					);
				})}

				{quests?.length === 0 && (
					<div className='text-center py-6 text-muted-foreground'>
						<Scroll size={24} className='mx-auto mb-2 opacity-20' />
						<p className='text-xs italic'>No active threads recorded.</p>
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\ActiveThreads.jsx ---

--- FILE: features\dashboard\components\ArchiveTree.jsx ---
import { Link } from 'react-router-dom';
import { ChevronRight, Folder } from 'lucide-react';
import { useState } from 'react';

export const ArchiveTree = ({ arcs }) => {
	return (
		<div className='bg-card border border-border rounded-xl p-6 h-full overflow-hidden flex flex-col'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2'>
				<Folder size={12} /> Campaign Archive
			</h4>

			<div className='flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4'>
				{arcs.map((arc) => (
					<ArchiveArcItem key={arc.id} arc={arc} />
				))}
				{arcs.length === 0 && (
					<div className='text-xs text-muted-foreground italic opacity-50 text-center py-8'>
						No archived arcs found.
					</div>
				)}
			</div>
		</div>
	);
};

const ArchiveArcItem = ({ arc }) => {
	// MODIFICATION: Default to true
	const [isOpen, setIsOpen] = useState(true);

	return (
		<div>
			<button
				onClick={() => setIsOpen(!isOpen)}
				className='w-full flex items-center justify-between text-left group mb-1 hover:bg-muted/50 p-1 rounded transition-colors'>
				<div className='min-w-0'>
					<div className='text-[10px] font-bold uppercase text-muted-foreground group-hover:text-primary'>
						Arc {arc.order}
					</div>
					<div className='text-sm font-serif font-bold truncate text-foreground'>{arc.title}</div>
				</div>
				<ChevronRight size={14} className={`text-muted-foreground transition-transform ${isOpen ? 'rotate-90' : ''}`} />
			</button>

			{isOpen && (
				<div className='pl-3 ml-1 border-l border-border mt-1 space-y-1 mb-3 animate-in slide-in-from-top-1 duration-200'>
					{arc.sessions.map((session) => (
						<Link
							key={session.id}
							to={`/wiki/session/${session.id}`}
							className='block text-xs py-1.5 px-2 rounded text-muted-foreground hover:text-foreground hover:bg-muted/50 truncate transition-colors'>
							<span className='font-bold mr-2 opacity-50'>#{session.session_number}</span>
							{session.title}
						</Link>
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\dashboard\components\ArchiveTree.jsx ---

--- FILE: features\dashboard\components\CampaignHeader.jsx ---
import { Layers, Scroll, MapPin, Users, Swords, Crown, Box } from 'lucide-react';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { HighlightBadge } from '@/shared/components/ui/HighlightBadge';

export const CampaignHeader = ({ campaign, counts }) => {
	return (
		<div className='flex flex-col gap-4 mb-12 items-center text-center max-w-4xl mx-auto'>
			{/* 1. Meta Label */}
			<div className='flex items-center gap-2 text-xs font-bold uppercase tracking-[0.2em] text-primary/70'>
				<Crown size={12} />
				Campaign Chronicle
			</div>

			{/* 2. Title */}
			<h1 className='text-5xl md:text-7xl font-serif font-bold text-foreground tracking-tight leading-none'>
				{campaign?.name}
			</h1>

			{/* 3. Description (Limited width for readability) */}
			<div className='max-w-2xl text-base text-muted-foreground leading-relaxed font-serif'>
				<SmartMarkdown components={{ p: 'span' }}>{campaign?.description || 'No description available.'}</SmartMarkdown>
			</div>

			{/* 4. Stats Row (Using Swimlane Badge Style) */}
			<div className='flex flex-wrap justify-center gap-6 mt-4'>
				<HighlightBadge icon={Layers} count={counts?.sessions} label='Sessions' />
				<HighlightBadge icon={Crown} count={counts?.arcs} label='Story Arcs' />
				<HighlightBadge icon={Users} count={counts?.npcs} label='NPCs' />
				<HighlightBadge icon={MapPin} count={counts?.locations} label='Locations' />
				<HighlightBadge icon={Swords} count={counts?.encounters} label='Encounters' />
				<HighlightBadge icon={Scroll} count={counts?.quests} label='Quests' />
			</div>

			<div className='w-24 h-px bg-border mt-6' />
		</div>
	);
};

--- END OF features\dashboard\components\CampaignHeader.jsx ---

--- FILE: features\dashboard\components\CurrentArcMetadata.jsx ---
import { Map, Crown } from 'lucide-react'; // Swapped icons
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const CurrentArcMetadata = ({ arc }) => {
	return (
		<div className='bg-card border border-border rounded-xl p-8 h-full flex flex-col shadow-sm relative overflow-hidden group'>
			{/* Subtle background decoration - Moved to bottom right and changed to Map for adventure feel */}
			<div className='absolute -right-10 -bottom-10 text-muted-foreground/5 pointer-events-none group-hover:scale-110 transition-transform duration-1000'>
				<Map size={180} />
			</div>

			{/* Metadata Header */}
			<div className='relative z-10 flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-primary mb-6'>
				<span className='flex items-center gap-1.5'>
					{/* Changed Hash to Layers for a "Story Layer" feel */}
					{arc?.order ? `# Arc ${arc.order}` : 'Current Arc'}
				</span>
				<span className='text-muted-foreground/30'>|</span>
				<span className='text-muted-foreground'>{arc?.attributes?.type || 'Major Arc'}</span>
			</div>

			{/* Title */}
			<h2 className='relative z-10 text-4xl font-serif font-bold text-foreground mb-6 leading-tight'>
				{arc?.title || 'Uncategorized Stories'}
			</h2>

			{/* Description */}
			<div className='relative z-10 text-sm text-muted-foreground leading-relaxed font-serif prose prose-invert max-w-none'>
				<SmartMarkdown components={{ p: 'span' }}>
					{arc?.description || 'No description available for this narrative arc.'}
				</SmartMarkdown>
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\CurrentArcMetadata.jsx ---

--- FILE: features\dashboard\components\CurrentStoryStack.jsx ---
import { Link } from 'react-router-dom';
import { ArrowRight, Calendar, BookOpen, Clock, History } from 'lucide-react';
import { formatDate } from '@/shared/utils/textUtils';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { clsx } from 'clsx';

export const CurrentStoryStack = ({ latestSession, previousSessions }) => {
	if (!latestSession) return null;

	const bgImage = latestSession.image;
	// If no previous sessions, the list section is hidden and hero takes full height
	const hasHistory = previousSessions && previousSessions.length > 0;

	return (
		<div className='flex flex-col h-full bg-card border border-border rounded-xl overflow-hidden transition-all duration-500 group'>
			{/* --- TOP SECTION: LATEST SESSION (HERO) --- */}
			{/* flex-1 ensures it fills all available space not taken by the list */}
			<div className='relative flex-1 min-h-[300px] flex flex-col overflow-hidden'>
				{/* Background Image Layer */}
				<div className='absolute inset-0 z-0'>
					{bgImage ? (
						<img
							src={bgImage}
							alt='Session Background'
							className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
						/>
					) : (
						<div className='w-full h-full bg-muted/20 flex items-center justify-center'>
							<BookOpen size={64} className='text-muted-foreground/10' />
						</div>
					)}
					{/* Gradient: Darkens text area, fades to transparent at top */}
					<div className='absolute inset-0 bg-gradient-to-t from-background via-background/90 to-transparent opacity-90' />
				</div>

				{/* Content Layer */}
				<div className='relative z-10 p-8 flex flex-col h-full'>
					{/* Badge */}
					<div className='flex justify-between items-start mb-auto'>
						<div className='bg-primary/90 text-primary-foreground backdrop-blur-md px-3 py-1 rounded text-[10px] font-bold uppercase tracking-widest hover:shadow-sm'>
							Latest Session
						</div>
						{/* Date */}
						<div className='text-[10px] font-bold text-muted-foreground bg-background/50 backdrop-blur px-2 py-1 rounded border border-white/10 flex items-center gap-1'>
							<Calendar size={10} />
							{formatDate(latestSession.session_date)}
						</div>
					</div>

					{/* Text Content */}
					<div className='mt-8'>
						<span className='text-xs font-bold text-primary mb-1 block uppercase tracking-wider'>
							Session {latestSession.session_number}
						</span>

						<h3 className='text-3xl md:text-4xl font-serif font-bold text-foreground mb-4 leading-tight group-hover:text-primary transition-colors'>
							{latestSession.title}
						</h3>

						<div className='text-sm text-muted-foreground line-clamp-6 mb-6 prose prose-invert max-w-none leading-relaxed'>
							<SmartMarkdown components={{ p: 'span' }}>
								{latestSession.narrative || 'No summary recorded.'}
							</SmartMarkdown>
						</div>

						<Link
							to={`/wiki/session/${latestSession.id}`}
							className='inline-flex items-center gap-2 px-5 py-2.5 bg-primary text-primary-foreground text-xs font-bold uppercase tracking-wider rounded-lg hover:bg-primary/90 transition-all shadow-lg shadow-primary/20'>
							Read Full Log <ArrowRight size={14} />
						</Link>
					</div>
				</div>
			</div>

			{/* --- BOTTOM SECTION: PREVIOUS CHAPTERS (LIST) --- */}
			{/* flex-none ensures it only takes the space it needs */}
			{hasHistory && (
				<div className='flex-none bg-muted/30 border-t border-border p-6'>
					<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-3 flex items-center gap-2'>
						<History size={12} /> Previous Chapters
					</h4>

					<div className='space-y-1'>
						{previousSessions.map((session) => (
							<Link
								key={session.id}
								to={`/wiki/session/${session.id}`}
								className='flex items-center gap-3 p-2 rounded hover:bg-background/80 hover:shadow-sm border border-transparent hover:border-border transition-all group/item'>
								<span className='text-xs font-bold text-muted-foreground group-hover/item:text-primary w-8 text-center shrink-0 bg-background border border-border rounded px-1 py-0.5'>
									#{session.session_number}
								</span>
								<span className='text-sm font-medium truncate text-foreground/80 group-hover/item:text-foreground flex-1'>
									{session.title}
								</span>
								<span className='text-[10px] text-muted-foreground/50 whitespace-nowrap'>
									{formatDate(session.session_date)}
								</span>
							</Link>
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\dashboard\components\CurrentStoryStack.jsx ---

--- FILE: features\dashboard\components\InsightsGrid.jsx ---
import { Trophy, Map, Users, Swords, Skull, Crown } from 'lucide-react';

export const InsightsGrid = ({ stats, counts }) => {
	// Helper to safely get data
	const getVal = (obj, key) => obj?.[key];

	const insights = [
		{
			label: 'Most Active Session',
			value: getVal(stats?.most_active_session, 'title'),
			sub: `${getVal(stats?.most_active_session, 'event_count') || 0} Events`,
			icon: Trophy,
			color: 'text-yellow-500',
		},
		{
			label: 'Top Location',
			value: getVal(stats?.top_location, 'name'),
			sub: `${getVal(stats?.top_location, 'visits') || 0} Visits`,
			icon: Map,
			color: 'text-emerald-500',
		},
		{
			label: 'Most Met NPC',
			value: getVal(stats?.top_npc, 'name'),
			sub: `${getVal(stats?.top_npc, 'mentions') || 0} Mentions`,
			icon: Users,
			color: 'text-blue-500',
		},
		{
			label: 'Campaign Duration',
			value: `${counts?.sessions || 0} Sessions`,
			sub: 'Total Playtime',
			icon: Crown,
			color: 'text-purple-500',
		},
		{
			label: 'Battles Fought',
			value: stats?.total_encounters || 0,
			sub: 'Total Encounters',
			icon: Swords,
			color: 'text-red-500',
		},
	];

	return (
		<div className='h-full'>
			<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground mb-6 flex items-center gap-2'>
				Campaign Insights
			</h4>
			<div className='grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-8'>
				{insights.map((item, idx) => (
					<div key={idx} className='flex items-start gap-4 group'>
						<div className={`mt-1 p-2 rounded-lg bg-muted/30 group-hover:bg-muted/50 transition-colors ${item.color}`}>
							<item.icon size={18} />
						</div>
						<div className='min-w-0 flex-1'>
							<p className='text-xl font-serif font-bold text-foreground truncate leading-none mb-1'>
								{item.value || 'N/A'}
							</p>
							<p className='text-[10px] font-bold uppercase text-muted-foreground/60'>{item.label}</p>
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\InsightsGrid.jsx ---

--- FILE: features\dashboard\components\PartyWidget.jsx ---
import { useNavigate } from 'react-router-dom';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
export const PartyWidget = ({ party }) => {
	const navigate = useNavigate();
	if (!party || party.length === 0) return null;

	const handleRowClick = (id, e) => {
		// Integrity Check:
		// If the user clicked an actual link inside the SmartMarkdown (e.g. the name),
		// we stop the row click so we don't navigate twice or conflict.
		if (e.target.closest('a')) return;

		navigate(`/wiki/character/${id}`);
	};

	return (
		<div className='h-full flex flex-col'>
			<div className='flex items-center justify-between mb-6 shrink-0'>
				<h4 className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground'>The Party</h4>
			</div>

			<div className='space-y-4 overflow-y-auto custom-scrollbar flex-1 min-h-0 pr-2'>
				{party.map((char) => (
					<div
						key={char.id}
						onClick={(e) => handleRowClick(char.id, e)}
						className='flex items-center gap-3 group cursor-pointer'>
						<div className='w-10 h-10 rounded-full bg-muted border border-border overflow-hidden shrink-0 group-hover:border-primary/50 transition-colors shadow-sm'>
							{char.icon ? (
								<img src={char.icon} alt={char.name} className='w-full h-full object-cover' />
							) : (
								<div className='w-full h-full flex items-center justify-center text-sm font-serif font-bold text-muted-foreground'>
									{char.name[0]}
								</div>
							)}
						</div>

						<div className='min-w-0'>
							<div className='font-serif font-bold text-sm text-foreground group-hover:text-primary transition-colors truncate'>
								{/* SmartMarkdown is now safe here because parent is a div */}
								<SmartMarkdown>{char.name}</SmartMarkdown>
							</div>
							<div className='text-[10px] uppercase font-bold tracking-wider text-muted-foreground truncate opacity-60 group-hover:opacity-100 transition-opacity'>
								{char.race} • {char.class} • Lvl {char.level}
							</div>
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\PartyWidget.jsx ---

--- FILE: features\dashboard\components\QuickInsights.jsx ---
import { TrendingUp, Trophy, Map, Users } from 'lucide-react';
import { clsx } from 'clsx';

export const QuickInsights = ({ stats, sessions }) => {
	const insights = [
		{
			icon: TrendingUp,
			label: 'Most Active Session',
			value: stats?.mostActiveSession?.title || 'N/A',
			subtitle: `${stats?.mostActiveSession?.eventCount || 0} events`,
			color: 'text-blue-600',
			bg: 'bg-blue-500/10',
			border: 'border-blue-500/30',
		},
		{
			icon: Map,
			label: 'Most Visited Location',
			value: stats?.topLocation?.name || 'N/A',
			subtitle: `${stats?.topLocation?.visits || 0} visits`,
			color: 'text-emerald-600',
			bg: 'bg-emerald-500/10',
			border: 'border-emerald-500/30',
		},
		{
			icon: Users,
			label: 'Most Encountered NPC',
			value: stats?.topNPC?.name || 'N/A',
			subtitle: `${stats?.topNPC?.mentions || 0} mentions`,
			color: 'text-amber-600',
			bg: 'bg-amber-500/10',
			border: 'border-amber-500/30',
		},
		{
			icon: Trophy,
			label: 'Quests Completed',
			value: stats?.completedQuests || 0,
			subtitle: `${stats?.activeQuests || 0} still active`,
			color: 'text-purple-600',
			bg: 'bg-purple-500/10',
			border: 'border-purple-500/30',
		},
	];

	return (
		<div>
			<h2 className='text-xl font-serif font-bold text-foreground mb-4'>Campaign Insights</h2>
			<div className='grid grid-cols-1 md:grid-cols-2 gap-4'>
				{insights.map((insight, idx) => {
					const Icon = insight.icon;
					return (
						<div
							key={idx}
							className={clsx('bg-background border rounded-lg p-4 hover:shadow-md transition-all', insight.border)}>
							<div className='flex items-start gap-3'>
								<div className={clsx('p-2 rounded-lg shrink-0', insight.bg)}>
									<Icon size={20} className={insight.color} strokeWidth={2.5} />
								</div>
								<div className='flex-1 min-w-0'>
									<p className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground mb-1'>
										{insight.label}
									</p>
									<p className='text-lg font-serif font-bold text-foreground truncate mb-0.5'>{insight.value}</p>
									<p className='text-xs text-muted-foreground'>{insight.subtitle}</p>
								</div>
							</div>
						</div>
					);
				})}
			</div>
		</div>
	);
};

--- END OF features\dashboard\components\QuickInsights.jsx ---

