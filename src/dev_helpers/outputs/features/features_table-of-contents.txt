================================================================
PARTIAL BUNDLE: FEATURES TABLE-OF-CONTENTS
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        AdvancedFilter.jsx
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartColorPicker.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
        atlas/
          AtlasForms.jsx
          editor/
            AtlasEditor.jsx
            AtlasEditorContext.jsx
            components/
              EditorLayerList.jsx
              EditorMapEvents.jsx
              EditorSidebar.jsx
              EditorToolbar.jsx
              VertexHandle.jsx
            layers/
              EditAreasLayer.jsx
              EditMarkersLayer.jsx
              EditOverlaysLayer.jsx
              EditPathsLayer.jsx
      config/
        adminStrategies.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        MapManagerPage.jsx
        MapMigrationTool.jsx
        SplitPaneManager.jsx
      utils/
        filterUtils.js
    atlas/
      MapPage.jsx
      useMapData.js
      api/
        mapService.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        MapZoomHandler.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
        campaign_02/
          index.js
          faerun/
            index.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignData.js
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\table-of-contents\TableOfContents.jsx ---
import { useState, useEffect, useMemo, useRef } from 'react';
import { clsx } from 'clsx';
import { List, ChevronRight, ChevronDown } from 'lucide-react';
import { useTocObserver } from './hooks/useTocObserver';
import { useTocScroll } from './hooks/useTocScroll';
import { TocMobileDrawer } from './components/TocMobileDrawer';

export const TableOfContents = ({
	items,
	className,
	visibilityClass = 'hidden xl:block',
	mobileToggleClass = 'xl:hidden',
}) => {
	const [isOpen, setIsOpen] = useState(false);
	const [expandedIds, setExpandedIds] = useState(new Set());

	// NAV LOCK
	const isNavigating = useRef(false);
	const scrollTimeout = useRef(null);

	const itemIds = useMemo(() => items?.map((i) => i.id) || [], [items]);
	const activeId = useTocObserver(itemIds);
	const { scrollToId: originalScrollTo } = useTocScroll(() => setIsOpen(false));

	// 1. Parent Map
	const parents = useMemo(() => {
		const parentMap = new Map();
		for (let i = 0; i < items.length - 1; i++) {
			const current = items[i];
			const next = items[i + 1];
			if (current.depth === 2 && next.depth === 3) {
				const children = [];
				for (let j = i + 1; j < items.length; j++) {
					if (items[j].depth <= current.depth) break;
					children.push(items[j].id);
				}
				parentMap.set(current.id, children);
			}
		}
		return parentMap;
	}, [items]);

	// 2. Scroll Handler
	const handleScrollTo = (id) => {
		isNavigating.current = true;
		if (scrollTimeout.current) clearTimeout(scrollTimeout.current);

		let targetParentId = null;
		if (parents.has(id)) targetParentId = id;
		else {
			for (const [pId, children] of parents.entries()) {
				if (children.includes(id)) {
					targetParentId = pId;
					break;
				}
			}
		}

		if (targetParentId) setExpandedIds(new Set([targetParentId]));
		originalScrollTo(id);

		scrollTimeout.current = setTimeout(() => {
			isNavigating.current = false;
		}, 1000);
	};

	// 3. Auto-Expand
	useEffect(() => {
		if (isNavigating.current || !activeId) return;

		let activeParentId = null;
		if (parents.has(activeId)) activeParentId = activeId;
		else {
			for (const [pId, children] of parents.entries()) {
				if (children.includes(activeId)) {
					activeParentId = pId;
					break;
				}
			}
		}

		setExpandedIds((prev) => {
			if (activeParentId) {
				if (prev.size === 1 && prev.has(activeParentId)) return prev;
				return new Set([activeParentId]);
			}
			if (prev.size === 0) return prev;
			return new Set();
		});
	}, [activeId, parents]);

	// Toggle Handler
	const toggleExpand = (e, id) => {
		e.preventDefault();
		e.stopPropagation();
		setExpandedIds((prev) => {
			const newSet = new Set(prev);
			if (newSet.has(id)) newSet.delete(id);
			else newSet.add(id);
			return newSet;
		});
	};

	if (!items || items.length === 0) return null;

	return (
		<>
			{/* --- DESKTOP RAIL --- */}
			<aside
				className={clsx(
					visibilityClass,
					'sticky top-24 max-h-[calc(100vh-6rem)] w-64 shrink-0 self-start overflow-y-auto custom-scrollbar py-4 pr-2',
					className
				)}>
				<div className='flex flex-col'>
					<nav className='relative ml-4 flex flex-col border-l border-border/60'>
						<div className='mb-2 pl-4 text-sm font-semibold tracking-tight text-foreground/90'>On this page</div>
						{items.map((item) => {
							const hasChildren = parents.has(item.id);
							const isExpanded = expandedIds.has(item.id);

							let isHidden = false;
							if (item.depth === 3) {
								const parentIndex = items.slice(0, items.indexOf(item)).findLastIndex((i) => i.depth === 2);
								if (parentIndex !== -1) {
									const parent = items[parentIndex];
									if (parents.has(parent.id) && !expandedIds.has(parent.id)) isHidden = true;
								}
							}

							if (isHidden) return null;

							return (
								<div
									key={item.id}
									className={clsx('relative flex items-center', item.depth === 1 ? 'mb-1 mt-3' : 'mt-0')}>
									<div
										className={clsx(
											'absolute left-0 -ml-[1px] h-full w-[2px] transition-colors duration-200',
											activeId === item.id ? 'bg-primary' : 'bg-transparent'
										)}
									/>
									<div className='group flex w-full items-center justify-between'>
										<a
											href={`#${item.id}`}
											onClick={(e) => {
												e.preventDefault();
												handleScrollTo(item.id);
											}}
											className={clsx(
												'block w-full truncate py-1 pr-2 transition-colors',
												'text-[13px] leading-snug',
												activeId === item.id
													? 'font-medium text-primary'
													: 'text-muted-foreground hover:text-foreground',
												item.depth === 1 && 'pl-4 text-xs font-bold uppercase tracking-wider text-foreground/80',
												item.depth === 2 && 'pl-4',
												item.depth === 3 && 'pl-8 text-muted-foreground/80'
											)}>
											{item.text}
										</a>
										{hasChildren && (
											<button
												onClick={(e) => toggleExpand(e, item.id)}
												className='mr-1 shrink-0 rounded-sm p-0.5 text-muted-foreground transition-colors hover:bg-accent hover:text-foreground'
												aria-label={isExpanded ? 'Collapse' : 'Expand'}>
												{isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
											</button>
										)}
									</div>
								</div>
							);
						})}
					</nav>
				</div>
			</aside>

			{/* --- MOBILE TOGGLE --- */}
			<div className={clsx('fixed bottom-6 right-6 z-40', mobileToggleClass)}>
				<button
					onClick={() => setIsOpen(true)}
					className='flex h-12 w-12 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-xl transition-transform hover:bg-primary/90 active:scale-95'>
					<List size={20} />
				</button>
			</div>

			{/* --- MOBILE DRAWER (Now receiving state) --- */}
			<TocMobileDrawer
				isOpen={isOpen}
				items={items}
				activeId={activeId}
				parents={parents}
				expandedIds={expandedIds}
				toggleExpand={toggleExpand}
				onClose={() => setIsOpen(false)}
				onScrollTo={handleScrollTo}
			/>
		</>
	);
};

--- END OF features\table-of-contents\TableOfContents.jsx ---

--- FILE: features\table-of-contents\components\TocItem.jsx ---
import { clsx } from 'clsx';

export const TocItem = ({ item, isActive, onClick }) => {
	return (
		<a
			href={`#${item.id}`}
			onClick={(e) => {
				e.preventDefault();
				onClick(item.id);
			}}
			className={clsx(
				'group flex w-full items-center py-2 transition-all duration-200',
				// THE LUCIDE TRICK:
				// 1. -ml-px pulls this item 1px to the left, exactly on top of the parent's border.
				// 2. border-l-2 gives us the colored bar.
				'-ml-px border-l-2 pl-4',

				// Depth Indentation (Lucide flattens depth usually, but we keep indentation)
				item.depth === 2 ? 'pl-4' : item.depth === 3 ? 'pl-8' : '',

				isActive
					? 'border-primary text-primary font-medium'
					: 'border-transparent text-muted-foreground hover:text-foreground hover:border-muted-foreground/50'
			)}>
			<span className='text-sm truncate'>{item.text}</span>
		</a>
	);
};

--- END OF features\table-of-contents\components\TocItem.jsx ---

--- FILE: features\table-of-contents\components\TocMobileDrawer.jsx ---
import { Drawer } from '@/shared/components/ui/Drawer';
import { clsx } from 'clsx';
import { ChevronRight, ChevronDown } from 'lucide-react';

export const TocMobileDrawer = ({
	isOpen,
	items,
	activeId,
	parents, // passed from parent
	expandedIds, // passed from parent
	toggleExpand, // passed from parent
	onClose,
	onScrollTo,
}) => {
	return (
		<Drawer isOpen={isOpen} onClose={onClose} title='Table of Contents' position='right'>
			<div className='flex flex-col py-4'>
				<nav className='relative flex flex-col'>
					{items.map((item) => {
						const hasChildren = parents.has(item.id);
						const isExpanded = expandedIds.has(item.id);

						// Hiding Logic (Same as Desktop)
						let isHidden = false;
						if (item.depth === 3) {
							const parentIndex = items.slice(0, items.indexOf(item)).findLastIndex((i) => i.depth === 2);
							if (parentIndex !== -1) {
								const parent = items[parentIndex];
								if (parents.has(parent.id) && !expandedIds.has(parent.id)) {
									isHidden = true;
								}
							}
						}

						if (isHidden) return null;

						return (
							<div
								key={item.id}
								className={clsx('relative flex items-center', item.depth === 1 ? 'mb-2 mt-4' : 'mt-0')}>
								{/* Active Indicator Line (Thicker for Mobile) */}
								<div
									className={clsx(
										'absolute left-0 -ml-[2px] h-full w-[4px] rounded-r-sm transition-colors duration-200',
										activeId === item.id ? 'bg-primary' : 'bg-transparent'
									)}
								/>

								<div className='flex w-full items-center justify-between'>
									<button
										onClick={() => {
											onScrollTo(item.id);
											onClose(); // Close drawer on selection
										}}
										className={clsx(
											'flex h-full w-full items-center py-2 pr-4 text-left transition-colors',
											'text-[13px] leading-snug', // Slightly larger font than desktop
											activeId === item.id
												? 'text-[14px] text-primary'
												: 'text-muted-foreground active:text-foreground',
											item.depth === 1 && 'pl-5 text-xs font-bold uppercase tracking-wider text-foreground/80',
											item.depth === 2 && 'pl-5',
											item.depth === 3 && 'pl-9 text-muted-foreground/80'
										)}>
										{item.text}
									</button>

									{/* Toggle Button for Parents */}
									{hasChildren && (
										<button
											onClick={(e) => toggleExpand(e, item.id)}
											className='mr-2 flex h-10 w-10 items-center justify-center rounded-md text-muted-foreground active:bg-accent active:text-foreground'
											aria-label={isExpanded ? 'Collapse' : 'Expand'}>
											{isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}
										</button>
									)}
								</div>
							</div>
						);
					})}
				</nav>
			</div>
		</Drawer>
	);
};

--- END OF features\table-of-contents\components\TocMobileDrawer.jsx ---

--- FILE: features\table-of-contents\hooks\useTocObserver.js ---
import { useState, useEffect } from 'react';

export function useTocObserver(itemIds) {
	const [activeId, setActiveId] = useState(null);

	useEffect(() => {
		if (!itemIds?.length) return;

		const handleScroll = () => {
			// The "reading line" is 100px down from the top of the viewport.
			// We want to highlight the last header that is ABOVE this line.
			const offset = 120;

			let newActiveId = null;

			// We iterate in REVERSE order.
			// The first header we encounter that is "above the line" (rect.top < offset)
			// is effectively the section we are currently reading.
			for (let i = itemIds.length - 1; i >= 0; i--) {
				const id = itemIds[i];
				const element = document.getElementById(id);

				if (element) {
					const rect = element.getBoundingClientRect();

					// if rect.top is less than 120px, the header has scrolled up past our "eye level"
					if (rect.top < offset) {
						newActiveId = id;
						break; // Stop looking, we found the deepest active header
					}
				}
			}

			setActiveId(newActiveId);
		};

		// 'capture: true' is CRITICAL here.
		// It allows us to detect scroll events on nested divs (like <main>)
		// that don't bubble up to window normally.
		window.addEventListener('scroll', handleScroll, { capture: true, passive: true });

		// Run once on mount to set initial state
		handleScroll();

		return () => {
			window.removeEventListener('scroll', handleScroll, { capture: true });
		};
	}, [itemIds]);

	return activeId;
}

--- END OF features\table-of-contents\hooks\useTocObserver.js ---

--- FILE: features\table-of-contents\hooks\useTocScroll.js ---
import { useCallback } from 'react';

export function useTocScroll(callback) {
	const scrollToId = useCallback(
		(id) => {
			const element = document.getElementById(id);

			if (element) {
				// CSS 'scroll-margin-top' handles the offset (sticky header)
				element.scrollIntoView({ behavior: 'smooth', block: 'start' });

				// Optional callback (e.g., to close mobile drawer)
				if (callback) callback();
			} else {
				console.warn(`[ToC] Target element not found: #${id}`);
			}
		},
		[callback]
	);

	return { scrollToId };
}

--- END OF features\table-of-contents\hooks\useTocScroll.js ---

