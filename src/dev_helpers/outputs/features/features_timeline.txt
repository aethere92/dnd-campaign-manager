================================================================
PARTIAL BUNDLE: FEATURES TIMELINE
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageLibrary.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveQuestsWidget.jsx
        CampaignHero.jsx
        LatestSessionCard.jsx
        NpcsOfTheMoment.jsx
        QuickInsights.jsx
        RecentEncountersWidget.jsx
        RecentSessionsList.jsx
        SessionRecapCard.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\timeline\TimelinePage.jsx ---
import { useTimelineViewModel } from './useTimelineView';
import { TimelineSession } from './components/TimelineSession';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';

export default function TimelineView() {
	const { sessions, isLoading } = useTimelineViewModel();

	if (isLoading) return <div className='p-8 text-center text-muted-foreground/70'>Loading timeline...</div>;

	// Construct ToC items manually for the timeline sessions
	const tocItems = sessions.map((s) => ({
		id: `session-marker-${s.number}`,
		text: `${s.title}`,
		depth: 1,
	}));

	return (
		<div className='h-full overflow-hidden flex flex-col'>
			<div className='flex-1 overflow-y-auto bg-background custom-scrollbar'>
				{/* OPTIMIZATION: Reduced padding on mobile (p-4 vs p-12) */}
				<div className='max-w-7xl mx-auto p-4 md:p-12'>
					<h1 className='text-3xl font-serif font-bold text-foreground mb-10'>Campaign History</h1>

					<div className='grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-12 relative'>
						{/* Column 1: Timeline Content */}
						{/* OPTIMIZATION: Reduced margin-left (ml-3) for more width */}
						<div className='relative border-l-2 border-border ml-3 md:ml-4 space-y-16 pb-20'>
							{sessions.map((session) => (
								<div key={session.id} id={`session-marker-${session.number}`} className='scroll-mt-24'>
									<TimelineSession session={session} />
								</div>
							))}
						</div>

						{/* Column 2: ToC */}
						<TableOfContents items={tocItems} visibilityClass='hidden xl:block' mobileToggleClass='xl:hidden' />
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\timeline\TimelinePage.jsx ---

--- FILE: features\timeline\useTimelineView.js ---
import { useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { getTimeline } from '@/features/timeline/api/timelineService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getEventStyle } from './utils/eventStyles';

/**
 * @returns {{ sessions: import('./types').TimelineSessionModel[], isLoading: boolean }}
 */
export function useTimelineViewModel() {
	const { campaignId } = useCampaign();

	const { data, isLoading } = useQuery({
		queryKey: ['timeline', campaignId],
		queryFn: () => getTimeline(campaignId),
		enabled: !!campaignId,
	});

	const sessions = useMemo(() => {
		return (data || []).map((session) => {
			// Events are already sorted by the SQL View
			const events = (session.events || []).map((event) => {
				return {
					id: event.id,
					title: event.title,
					typeLabel: event.type?.replace(/_/g, ' ') || 'Event',
					description: event.description,
					// View returns 'tags' directly with { name, type }
					tags: event.tags || [],
					style: getEventStyle(event.type),
				};
			});

			return {
				id: session.session_id,
				number: session.session_number ?? 999,
				dateLabel: session.session_date || 'Unknown Date',
				title: session.session_title,
				events,
			};
		});
	}, [data]);

	return { sessions, isLoading };
}

--- END OF features\timeline\useTimelineView.js ---

--- FILE: features\timeline\api\timelineService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getTimeline = async (campaignId) => {
	// The view handles all aggregation, casting, and ordering efficiently.
	const { data, error } = await supabase
		.from('view_campaign_timeline')
		.select('*')
		.eq('campaign_id', campaignId)
		.order('session_number', { ascending: true }); // Postgres handles the casting/sorting

	if (error) throw error;
	return data || [];
};

--- END OF features\timeline\api\timelineService.js ---

--- FILE: features\timeline\components\TimelineEvent.jsx ---
import { useMemo } from 'react';
import { clsx } from 'clsx';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { Diamond } from 'lucide-react';

export const TimelineEvent = ({ event }) => {
	const { Icon, container } = event.style;

	// Group tags by entity type
	const groupedTags = useMemo(() => {
		if (!event.tags || event.tags.length === 0) return [];

		const groups = {};
		event.tags.forEach((tag) => {
			const type = tag.type || 'default';
			if (!groups[type]) {
				groups[type] = [];
			}
			groups[type].push(tag);
		});

		// Convert to array of groups
		return Object.values(groups);
	}, [event.tags]);

	return (
		<div className='relative flex gap-3 md:gap-4 group'>
			{/* Icon Bubble */}
			<div
				className={clsx(
					'shrink-0 w-8 h-8 rounded-full flex items-center justify-center shadow-sm border-2 z-10 transition-transform group-hover:scale-110 bg-background',
					container
				)}>
				<Icon size={14} strokeWidth={2.5} />
			</div>

			{/* Content */}
			<div className='flex-1 -mt-1 pb-2 min-w-0'>
				{/* FIX: Title color muted to text-foreground/80 */}
				<h4 className='text-sm font-bold text-foreground/80 mb-1 flex flex-wrap items-center gap-2'>
					<span className='mr-auto'>{event.title}</span>
					<span className='text-[9px] font-normal uppercase tracking-wider text-foreground border border-border px-1.5 rounded-sm bg-muted whitespace-nowrap'>
						{event.typeLabel}
					</span>
				</h4>

				{event.description && (
					<div className='text-sm text-muted-foreground leading-relaxed text-pretty text-left'>
						<SmartMarkdown>{event.description}</SmartMarkdown>
					</div>
				)}

				{/* Grouped Tags */}
				{groupedTags.length > 0 && (
					<div className='flex flex-wrap items-center gap-2 mt-2'>
						{groupedTags.map((group, groupIndex) => (
							<div key={groupIndex} className='flex items-center gap-2'>
								{/* Tags in this group */}
								<div className='flex flex-wrap gap-1.5'>
									{group.map((tag, idx) => {
										const config = getEntityConfig(tag.type);
										const TagIcon = config.icon;
										const styles = config.tailwind;

										return (
											<span
												key={`${tag.name}-${idx}`}
												className={clsx(
													// FIX: Changed font-bold to font-semibold for better legibility
													'inline-flex items-center gap-1 text-[10px] uppercase font-semibold px-1.5 py-0.5 rounded border cursor-default whitespace-nowrap',
													styles.bg,
													styles.text,
													styles.border
												)}>
												<TagIcon size={10} /> {tag.name}
											</span>
										);
									})}
								</div>

								{/* Separator */}
								{groupIndex < groupedTags.length - 1 && (
									<Diamond size={6} className='text-gray-300 fill-gray-300 shrink-0' />
								)}
							</div>
						))}
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\timeline\components\TimelineEvent.jsx ---

--- FILE: features\timeline\components\TimelineSession.jsx ---
import { Calendar } from 'lucide-react';
import { TimelineEvent } from './TimelineEvent';

export const TimelineSession = ({ session }) => {
	return (
		// OPTIMIZATION: Reduced padding (pl-4) on mobile to maximize text width
		<div className='relative pl-4 md:pl-12'>
			{/* Session Marker (Circle on the main line) */}
			<div className='absolute -left-[9px] top-0 flex items-center justify-center w-5 h-5 rounded-full bg-background border-2 border-border shadow-sm z-10'>
				<div className='w-2 h-2 rounded-full bg-gray-400' />
			</div>

			{/* Session Header */}
			<div className='mb-8'>
				<div className='flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mb-2'>
					<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground bg-muted px-2 py-0.5 rounded self-start border border-border'>
						Session {session.number - 1}
					</span>
					<time className='text-xs text-muted-foreground/70 flex items-center gap-1 font-medium'>
						<Calendar size={12} /> {session.dateLabel}
					</time>
				</div>
				<h2 className='text-2xl font-serif font-bold text-foreground mb-3'>{session.title}</h2>
			</div>

			{/* Events List */}
			<div className='space-y-6 relative'>
				{/* Connector Line for events */}
				{/* Adjusted left position slightly to align with tighter padding if needed, 
                    but 15px centers it nicely within the w-8 icon (16px center) roughly */}
				<div className='absolute left-[15px] top-4 bottom-4 w-0.5 bg-muted -z-10' />

				{session.events.map((event) => (
					<TimelineEvent key={event.id} event={event} />
				))}
			</div>
		</div>
	);
};

--- END OF features\timeline\components\TimelineSession.jsx ---

--- FILE: features\timeline\utils\eventStyles.js ---
import { getEntityStyles } from '@/domain/entity/config/entityStyles';
import {
	Sword,
	Skull,
	MessageSquare,
	Scroll,
	CheckCircle2,
	Footprints,
	Map,
	MapPin,
	User,
	Flag,
	Search,
	BookOpen,
	Sparkles,
	Eye,
	ShoppingBag,
	Star,
	Tent,
} from 'lucide-react';

export const getEventStyle = (eventType) => {
	const type = eventType?.toLowerCase() || '';

	let entityType = 'default';
	let Icon = Star;

	switch (type) {
		case 'combat':
			entityType = 'encounter'; // Orange
			Icon = Skull;
			break;
		case 'social':
			entityType = 'npc'; // Amber
			Icon = MessageSquare;
			break;
		case 'quest_started':
			entityType = 'quest'; // Blue
			Icon = Scroll;
			break;
		case 'quest_progressed':
			entityType = 'quest'; // Blue
			Icon = CheckCircle2;
			break;
		case 'travel':
			entityType = 'location'; // Emerald
			Icon = Footprints; // Journeys
			break;
		case 'location_discovered':
			entityType = 'location'; // Emerald
			Icon = Map; // Finding new places
			break;
		case 'location_visited':
			entityType = 'location'; // Emerald
			Icon = MapPin; // Arriving at known places
			break;
		case 'npc_encountered':
			entityType = 'npc'; // Amber
			Icon = User;
			break;
		case 'faction_discovered':
			entityType = 'faction'; // Purple
			Icon = Flag;
			break;
		case 'investigation':
			entityType = 'default'; // Gray (Neutral/Mechanics)
			Icon = Search;
			break;
		case 'backstory':
			entityType = 'character'; // Red (Personal)
			Icon = BookOpen;
			break;
		case 'discovery':
			entityType = 'encounter'; // Orange (Loot/Items/Secrets)
			Icon = Sparkles;
			break;
		case 'vision':
			entityType = 'faction'; // Purple (Magic/Mystical)
			Icon = Eye;
			break;
		case 'shopping':
			entityType = 'npc'; // Amber (Trade/Commerce)
			Icon = ShoppingBag;
			break;
		case 'special_event':
			entityType = 'session'; // Slate (Meta/Unique)
			Icon = Star;
			break;
		// Fallbacks for legacy types or fuzzy matches
		default:
			if (type.match(/combat|fight|kill/)) {
				entityType = 'encounter';
				Icon = Sword;
			} else if (type.match(/npc|social|meet/)) {
				entityType = 'npc';
				Icon = MessageSquare;
			} else if (type.match(/location|visit|arrive/)) {
				entityType = 'location';
				Icon = MapPin;
			} else if (type.match(/quest|mission/)) {
				entityType = 'quest';
				Icon = Scroll;
			} else if (type.match(/camp|rest/)) {
				entityType = 'location';
				Icon = Tent;
			} else {
				entityType = 'default';
				Icon = Star;
			}
	}

	// Use centralized styles
	const styles = getEntityStyles(entityType);

	return {
		Icon,
		// Map standard styles to timeline specific class structure
		container: `${styles.border} ${styles.bg} ${styles.text}`,
		// Heuristic for line color (usually 200 or 300 shade) based on bg class
		// line: styles.bg.replace('-50', '-200'),
	};
};

--- END OF features\timeline\utils\eventStyles.js ---

