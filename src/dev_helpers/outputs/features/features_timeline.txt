================================================================
PARTIAL BUNDLE: FEATURES TIMELINE
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        AdvancedFilter.jsx
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartColorPicker.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
        atlas/
          AtlasForms.jsx
          editor/
            AtlasEditor.jsx
            AtlasEditorContext.jsx
            components/
              EditorLayerList.jsx
              EditorMapEvents.jsx
              EditorSidebar.jsx
              EditorToolbar.jsx
              VertexHandle.jsx
            layers/
              EditAreasLayer.jsx
              EditMarkersLayer.jsx
              EditOverlaysLayer.jsx
              EditPathsLayer.jsx
      config/
        adminStrategies.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        MapManagerPage.jsx
        MapMigrationTool.jsx
        SplitPaneManager.jsx
      utils/
        filterUtils.js
    atlas/
      MapPage.jsx
      useMapData.js
      api/
        mapService.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        MapZoomHandler.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      context/
        AtlasContext.jsx
      data/
        modularize.js
        refactor.js
        campaign_02/
          index.js
          faerun/
            index.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignData.js
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\timeline\TimelinePage.jsx ---
import { useTimelineViewModel } from './useTimelineView';
import { TimelineSession } from './components/TimelineSession';
import { TimelineArcHeader } from './components/TimelineArcHeader';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { useMemo } from 'react';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { Search, ChevronsUp, ChevronsDown, X } from 'lucide-react';

export default function TimelineView() {
	const { timelineItems, isLoading, searchQuery, setSearchQuery, toggleSession, expandAll, collapseAll } =
		useTimelineViewModel();

	const tocItems = useMemo(() => {
		if (!timelineItems) return [];

		return timelineItems.flatMap((item) => {
			if (item.type === 'arc_header') {
				return [
					{
						id: `arc-marker-${item.id}`,
						text: item.title,
						depth: 1,
					},
				];
			}
			if (item.type === 'session') {
				const sessionNode = {
					id: `session-marker-${item.number}`,
					text: item.title,
					depth: 2,
				};
				if (!item.isExpanded) return [sessionNode];

				const eventNodes = (item.events || []).map((event) => ({
					id: event.id,
					text: event.title,
					depth: 3,
				}));
				return [sessionNode, ...eventNodes];
			}
			return [];
		});
	}, [timelineItems]);

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text='Loading Timeline...' fullScreen />;

	return (
		<div className='h-full overflow-hidden flex flex-col'>
			<div className='flex-1 overflow-y-auto bg-background custom-scrollbar'>
				<div className='max-w-7xl mx-auto p-4 md:p-12'>
					<div className='flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10'>
						<h1 className='text-3xl font-serif font-bold text-foreground'>Campaign History</h1>

						{/* --- TOOLBAR --- */}
						<div className='flex flex-col sm:flex-row gap-3 w-full md:w-auto'>
							{/* Search Input */}
							<div className='relative w-full sm:w-64'>
								<Search className='absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground' />
								<input
									type='text'
									placeholder='Filter events...'
									value={searchQuery}
									onChange={(e) => setSearchQuery(e.target.value)}
									className='w-full h-9 pl-9 pr-8 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring'
								/>
								{searchQuery && (
									<button
										onClick={() => setSearchQuery('')}
										className='absolute right-2 top-2.5 text-muted-foreground hover:text-foreground'>
										<X size={14} />
									</button>
								)}
							</div>

							{/* Toggle Buttons */}
							<div className='flex items-center rounded-md border border-input bg-background shadow-sm h-9'>
								<button
									onClick={expandAll}
									className='flex-1 sm:flex-none px-3 h-full flex items-center gap-2 hover:bg-muted/50 transition-colors border-r border-input text-xs font-medium'
									title='Expand All'>
									<ChevronsDown size={14} /> <span className='sm:hidden lg:inline'>Expand</span>
								</button>
								<button
									onClick={collapseAll}
									className='flex-1 sm:flex-none px-3 h-full flex items-center gap-2 hover:bg-muted/50 transition-colors text-xs font-medium'
									title='Collapse All'>
									<ChevronsUp size={14} /> <span className='sm:hidden lg:inline'>Collapse</span>
								</button>
							</div>
						</div>
					</div>

					<div className='grid grid-cols-1 xl:grid-cols-[1fr_240px] gap-12 relative'>
						{/* 
                           Timeline Container 
                           FIX: Reduced mobile margin to ml-6 (24px) to give content more width.
                           The Arc Icon overhangs -21px. ml-6 + p-4 = 40px space. Safe.
                        */}
						<div className='relative border-l-2 border-border ml-3 md:ml-10 space-y-8 pb-20'>
							{timelineItems.length === 0 ? (
								<div className='py-20 text-center text-muted-foreground'>No events found matching "{searchQuery}"</div>
							) : (
								timelineItems.map((item) => {
									if (item.type === 'arc_header') {
										return (
											<div key={item.id} id={`arc-marker-${item.id}`} className='scroll-mt-12'>
												<TimelineArcHeader arc={item} id={`arc-${item.id}`} />
											</div>
										);
									}
									return (
										<div key={item.id} id={`session-marker-${item.number}`} className='scroll-mt-24'>
											<TimelineSession
												session={item}
												id={`session-${item.number}`}
												onToggle={() => toggleSession(item.id)}
											/>
										</div>
									);
								})
							)}
						</div>

						<TableOfContents items={tocItems} visibilityClass='hidden xl:block' mobileToggleClass='xl:hidden' />
					</div>
				</div>
			</div>
		</div>
	);
}

--- END OF features\timeline\TimelinePage.jsx ---

--- FILE: features\timeline\useTimelineView.js ---
import { useMemo, useState, useCallback } from 'react';
import { useQuery } from '@tanstack/react-query';
import { getTimeline } from '@/features/timeline/api/timelineService';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getEventStyle } from './utils/eventStyles';

export function useTimelineViewModel() {
	const { campaignId } = useCampaign();
	const [searchQuery, setSearchQuery] = useState('');
	const [collapsedSessions, setCollapsedSessions] = useState(new Set());

	const { data, isLoading } = useQuery({
		queryKey: ['timeline', campaignId],
		queryFn: () => getTimeline(campaignId),
		enabled: !!campaignId,
	});

	// --- Actions ---

	const toggleSession = useCallback((sessionId) => {
		setCollapsedSessions((prev) => {
			const next = new Set(prev);
			if (next.has(sessionId)) {
				next.delete(sessionId);
			} else {
				next.add(sessionId);
			}
			return next;
		});
	}, []);

	const collapseAll = useCallback(() => {
		if (!data) return;
		const allIds = data.map((s) => s.session_id);
		setCollapsedSessions(new Set(allIds));
	}, [data]);

	const expandAll = useCallback(() => {
		setCollapsedSessions(new Set());
	}, []);

	// --- Filtering & Processing ---

	const timelineItems = useMemo(() => {
		if (!data) return [];

		const items = [];
		let currentArcId = null;

		// Normalize Search
		const query = searchQuery.toLowerCase().trim();
		const isSearching = query.length > 0;

		// Process each session from the DB
		data.forEach((session) => {
			// 1. Filter Logic
			let matchingEvents = [];
			const sessionMatches = session.session_title.toLowerCase().includes(query);

			// Map events to view model first
			const allEvents = (session.events || []).map((event) => ({
				id: event.id,
				title: event.title,
				typeLabel: event.type?.replace(/_/g, ' ') || 'Event',
				description: event.description,
				tags: event.tags || [],
				style: getEventStyle(event.type),
			}));

			if (isSearching) {
				if (sessionMatches) {
					// Match on Session Title -> Show all events
					matchingEvents = allEvents;
				} else {
					// Match on Event Content -> Show only matching events
					matchingEvents = allEvents.filter(
						(e) =>
							e.title.toLowerCase().includes(query) ||
							(e.description && e.description.toLowerCase().includes(query)) ||
							e.tags.some((t) => t.name.toLowerCase().includes(query))
					);
				}
			} else {
				matchingEvents = allEvents;
			}

			// If searching and nothing matches, skip this session entirely
			if (isSearching && !sessionMatches && matchingEvents.length === 0) {
				return;
			}

			// 2. Arc Logic (Only add Arc header if we are adding a session under it)
			if (session.arc_id && session.arc_id !== currentArcId) {
				items.push({
					type: 'arc_header',
					id: `arc-${session.arc_id}`,
					title: session.arc_title,
					description: session.arc_description,
					color: session.arc_attributes?.color || 'amber',
				});
				currentArcId = session.arc_id;
			} else if (!session.arc_id && currentArcId !== null) {
				currentArcId = null;
			}

			// 3. Determine Expansion State
			// If searching, always expand. Otherwise, check state.
			const isExpanded = isSearching ? true : !collapsedSessions.has(session.session_id);

			items.push({
				type: 'session',
				id: session.session_id,
				number: session.session_number ?? 999,
				dateLabel: session.session_date || 'Unknown Date',
				title: session.session_title,
				events: matchingEvents,
				synopsis: session?.attributes?.synopsis || null,
				isExpanded,
				hasActiveSearch: isSearching, // Pass this down to disable toggles during search if desired
			});
		});

		return items;
	}, [data, searchQuery, collapsedSessions]);

	return {
		timelineItems,
		isLoading,
		searchQuery,
		setSearchQuery,
		toggleSession,
		expandAll,
		collapseAll,
	};
}

--- END OF features\timeline\useTimelineView.js ---

--- FILE: features\timeline\api\timelineService.js ---
import { supabase } from '@/shared/api/supabaseClient';

export const getTimeline = async (campaignId) => {
	// The view handles all aggregation, casting, and ordering efficiently.
	const { data, error } = await supabase
		.from('view_campaign_timeline')
		.select('*')
		.eq('campaign_id', campaignId)
		.order('session_number', { ascending: true }); // Postgres handles the casting/sorting

	if (error) throw error;
	return data || [];
};

--- END OF features\timeline\api\timelineService.js ---

--- FILE: features\timeline\components\TimelineArcHeader.jsx ---
import { BookOpen } from 'lucide-react';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const TimelineArcHeader = ({ arc }) => {
	return (
		// Container sits inside the border-l-2 parent.
		// pt-10: Space from previous session.
		// pb-1: Reduced space to the next session (tight coupling).
		<div className='relative pl-8 md:pl-12 pt-10 pb-1'>
			{/* 
                FIX: "Chapter Marker" Alignment
                - Width 40px (w-10). Center is 20px.
                - Border is 2px. Center is 1px relative to parent.
                - Content starts at 2px.
                - To align centers: Left = -21px (was -19px)
            */}
			<div className='absolute -left-[21px] top-10 flex items-center justify-center w-10 h-10 rounded-full bg-background border-4 border-primary/10 shadow-sm z-10 text-primary'>
				<BookOpen size={20} strokeWidth={2.5} />
			</div>

			{/* Content */}
			<div className='mb-2'>
				<span className='inline-block text-[10px] font-bold uppercase tracking-widest text-primary mb-2 border-b-2 border-primary/50 pb-1'>
					Narrative Arc
				</span>

				<h2 className='text-3xl md:text-4xl font-serif font-bold text-foreground mb-3'>{arc.title}</h2>

				{arc.description && (
					<div className='text-muted-foreground prose prose-sm prose-p:my-1 max-w-none text-pretty'>
						<SmartMarkdown>{arc.description}</SmartMarkdown>
					</div>
				)}
			</div>
		</div>
	);
};

--- END OF features\timeline\components\TimelineArcHeader.jsx ---

--- FILE: features\timeline\components\TimelineEvent.jsx ---
import { useMemo, memo } from 'react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { Diamond } from 'lucide-react';

export const TimelineEvent = memo(({ event, id }) => {
	const { Icon, container } = event.style;

	const groupedTags = useMemo(() => {
		if (!event.tags || event.tags.length === 0) return [];
		const groups = {};
		event.tags.forEach((tag) => {
			const type = tag.type || 'default';
			if (!groups[type]) groups[type] = [];
			groups[type].push(tag);
		});
		return Object.values(groups);
	}, [event.tags]);

	return (
		// FIX: Reduced gap on mobile (gap-2.5) to gap-4 on desktop
		<div className='relative flex gap-2.5 md:gap-4 group'>
			{/* Icon Bubble - Slightly smaller on mobile (w-7) */}
			<div
				className={clsx(
					'shrink-0 w-7 h-7 md:w-8 md:h-8 rounded-full flex items-center justify-center shadow-sm border-2 z-10 transition-transform group-hover:scale-110 bg-background',
					container
				)}>
				<Icon className='w-3.5 h-3.5 md:w-4 md:h-4' strokeWidth={2.5} />
			</div>

			{/* Content */}
			<div id={id} className='flex-1 -mt-1 pb-2 min-w-0'>
				<h4 className='text-sm font-bold text-foreground/80 mb-1 flex flex-wrap items-center gap-2'>
					<span className='mr-auto'>{event.title}</span>
					{/* <span className='text-[9px] font-normal uppercase tracking-wider text-foreground border border-border px-1.5 rounded-sm bg-muted whitespace-nowrap'>
						{event.typeLabel}
					</span> */}
				</h4>

				{event.description && (
					<div className='text-sm text-muted-foreground leading-relaxed text-pretty text-left'>
						<SmartMarkdown>{event.description}</SmartMarkdown>
					</div>
				)}

				{groupedTags.length > 0 && (
					<div className='flex flex-wrap items-center gap-2 mt-2 px-2 py-1 bg-muted/60 rounded-sm w-fit max-w-full'>
						{groupedTags.map((group, groupIndex) => (
							<div key={groupIndex} className='flex items-center gap-2'>
								<div className='flex flex-wrap gap-2 text-[12px] text-muted-foreground/10'>
									<SmartMarkdown inline>{group.map((tag) => tag.name).join(' ')}</SmartMarkdown>
								</div>
								{groupIndex < groupedTags.length - 1 && (
									<Diamond size={6} className='text-muted-foreground fill-muted-foreground shrink-0' />
								)}
							</div>
						))}
					</div>
				)}
			</div>
		</div>
	);
});

TimelineEvent.displayName = 'TimelineEvent';

--- END OF features\timeline\components\TimelineEvent.jsx ---

--- FILE: features\timeline\components\TimelineSession.jsx ---
import { Calendar, ChevronDown } from 'lucide-react';
import { TimelineEvent } from './TimelineEvent';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { useState, useEffect, useRef, useMemo, memo } from 'react';
import { clsx } from 'clsx';

// Estimated height of an event card to prevent massive layout shifts
const ESTIMATED_EVENT_HEIGHT = 120;

export const TimelineSession = memo(({ session, id, onToggle }) => {
	const [isVisible, setIsVisible] = useState(false);
	const containerRef = useRef(null);
	const { isExpanded, hasActiveSearch } = session;

	useEffect(() => {
		if (!containerRef.current) return;
		if (!isExpanded) return;

		const observer = new IntersectionObserver(
			([entry]) => {
				if (entry.isIntersecting) {
					setIsVisible(true);
					observer.disconnect();
				}
			},
			{
				rootMargin: '600px 0px',
				threshold: 0,
			}
		);

		observer.observe(containerRef.current);

		return () => {
			observer.disconnect();
		};
	}, [isExpanded]);

	const eventList = useMemo(() => {
		if (!isVisible) return null;
		return session.events.map((event) => <TimelineEvent key={event.id} event={event} id={event.id} />);
	}, [session.events, isVisible]);

	const placeholderHeight = session.events.length * ESTIMATED_EVENT_HEIGHT;

	return (
		<div id={id} ref={containerRef} className='relative pl-3 md:pl-12'>
			{/* Session Marker */}
			<div className='absolute -left-[11px] top-0 flex items-center justify-center w-5 h-5 rounded-full bg-background border-2 border-border shadow-sm z-10'>
				<div className='w-2 h-2 rounded-full bg-gray-400' />
			</div>

			{/* 
               FIX: Header Layout
               Removed flex-row columns. The chevron is now inline with the title.
            */}
			<div className='mb-6 group pl-5 md:pl-0'>
				{/* Metadata Row */}
				<div className='flex flex-wrap items-center gap-x-3 gap-y-1 mb-2'>
					<span className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground bg-muted px-2 py-0.5 rounded border border-border'>
						Session {session.number - 1}
					</span>
					<time className='text-xs text-muted-foreground/70 flex items-center gap-1 font-medium'>
						<Calendar size={12} /> {session.dateLabel}
					</time>
				</div>

				{/* Title Row with Inline Chevron */}
				<h2 className='text-xl md:text-2xl font-serif font-bold text-foreground group-hover:text-primary transition-colors leading-tight cursor-pointer'>
					{/* align-middle ensures text aligns with icon */}
					<span className='align-middle'>{session.title}</span>

					{!hasActiveSearch && (
						<span
							onClick={!hasActiveSearch ? onToggle : undefined}
							className={clsx(
								'inline-flex items-center justify-center align-middle ml-2 p-1 rounded-full text-muted-foreground/50 group-hover:bg-muted group-hover:text-foreground transition-all',
								isExpanded ? 'rotate-0' : '-rotate-90'
							)}>
							<ChevronDown size={20} />
						</span>
					)}
				</h2>

				{session.synopsis && (
					<div className='text-muted-foreground prose prose-sm prose-p:my-1 max-w-none text-pretty'>
						<SmartMarkdown>{session.synopsis}</SmartMarkdown>
					</div>
				)}
			</div>

			{/* Events List */}
			{isExpanded && (
				<div className='space-y-6 relative min-h-[50px] animate-in fade-in slide-in-from-top-2 duration-300'>
					{isVisible ? (
						eventList
					) : (
						<div
							style={{ height: placeholderHeight }}
							className='w-full rounded-lg border border-dashed border-border/50 bg-muted/20 flex items-center justify-center'>
							<span className='text-xs text-muted-foreground/50'>Loading {session.events.length} events...</span>
						</div>
					)}
				</div>
			)}
		</div>
	);
});

TimelineSession.displayName = 'TimelineSession';

--- END OF features\timeline\components\TimelineSession.jsx ---

--- FILE: features\timeline\utils\eventStyles.js ---
import { getEntityStyles } from '@/domain/entity/config/entityStyles';
import {
	Sword,
	Skull,
	MessageSquare,
	Scroll,
	CheckCircle2,
	Footprints,
	Map,
	MapPin,
	User,
	Flag,
	Search,
	BookOpen,
	Sparkles,
	Eye,
	ShoppingBag,
	Star,
	Tent,
} from 'lucide-react';

export const getEventStyle = (eventType) => {
	const type = eventType?.toLowerCase() || '';

	let entityType = 'default';
	let Icon = Star;

	switch (type) {
		case 'combat':
			entityType = 'encounter'; // Orange
			Icon = Skull;
			break;
		case 'social':
			entityType = 'npc'; // Amber
			Icon = MessageSquare;
			break;
		case 'quest_started':
			entityType = 'quest'; // Blue
			Icon = Scroll;
			break;
		case 'quest_progressed':
			entityType = 'quest'; // Blue
			Icon = CheckCircle2;
			break;
		case 'travel':
			entityType = 'location'; // Emerald
			Icon = Footprints; // Journeys
			break;
		case 'location_discovered':
			entityType = 'location'; // Emerald
			Icon = Map; // Finding new places
			break;
		case 'location_visited':
			entityType = 'location'; // Emerald
			Icon = MapPin; // Arriving at known places
			break;
		case 'npc_encountered':
			entityType = 'npc'; // Amber
			Icon = User;
			break;
		case 'faction_discovered':
			entityType = 'faction'; // Purple
			Icon = Flag;
			break;
		case 'investigation':
			entityType = 'default'; // Gray (Neutral/Mechanics)
			Icon = Search;
			break;
		case 'backstory':
			entityType = 'character'; // Red (Personal)
			Icon = BookOpen;
			break;
		case 'discovery':
			entityType = 'encounter'; // Orange (Loot/Items/Secrets)
			Icon = Sparkles;
			break;
		case 'vision':
			entityType = 'faction'; // Purple (Magic/Mystical)
			Icon = Eye;
			break;
		case 'shopping':
			entityType = 'npc'; // Amber (Trade/Commerce)
			Icon = ShoppingBag;
			break;
		case 'special_event':
			entityType = 'session'; // Slate (Meta/Unique)
			Icon = Star;
			break;
		// Fallbacks for legacy types or fuzzy matches
		default:
			if (type.match(/combat|fight|kill/)) {
				entityType = 'encounter';
				Icon = Sword;
			} else if (type.match(/npc|social|meet/)) {
				entityType = 'npc';
				Icon = MessageSquare;
			} else if (type.match(/location|visit|arrive/)) {
				entityType = 'location';
				Icon = MapPin;
			} else if (type.match(/quest|mission/)) {
				entityType = 'quest';
				Icon = Scroll;
			} else if (type.match(/camp|rest/)) {
				entityType = 'location';
				Icon = Tent;
			} else {
				entityType = 'default';
				Icon = Star;
			}
	}

	// Use centralized styles
	const styles = getEntityStyles(entityType);

	return {
		Icon,
		// Map standard styles to timeline specific class structure
		container: `${styles.border} ${styles.bg} ${styles.text}`,
		// Heuristic for line color (usually 200 or 300 shade) based on bg class
		// line: styles.bg.replace('-50', '-200'),
	};
};

--- END OF features\timeline\utils\eventStyles.js ---

