================================================================
PARTIAL BUNDLE: FEATURES WIKI
================================================================

### PROJECT MAP (FILE STRUCTURE)
./
  main.jsx
  todo.md
  app/
    App.jsx
    AppRoutes.jsx
    components/
      RouteLoading.jsx
    styles/
      global.css
  domain/
    entity/
      api/
        entityService.js
      components/
        EntityBadge.jsx
        EntityIcon.jsx
        EntityLink.jsx
        EntityStatusIcon.jsx
      config/
        entityColors.js
        entityConfig.js
        entityIcons.js
        entityStyles.js
        entityTypes.js
      utils/
        attributeParser.js
        entityUtils.js
        statusUtils.js
  features/
    admin/
      api/
        adminService.js
      components/
        AdminForm.jsx
        AdminFormStyles.js
        EncounterManager.jsx
        EntitySearch.jsx
        EventTagger.jsx
        ImageLibraryModal.jsx
        MarkdownEditor.jsx
        MarkdownEditorImpl.jsx
        QuestObjectiveManager.jsx
        RelationshipManager.jsx
        SessionEventManager.jsx
        SmartImageInput.jsx
        TacticalMapManager.jsx
      config/
        adminStrategies.js
        imageLibrary.js
        imageManifest.json
      layouts/
        AdminLayout.jsx
      pages/
        BulkReplaceTool.jsx
        EntityEditorPage.jsx
        EntityListPage.jsx
        SplitPaneManager.jsx
    atlas/
      MapPage.jsx
      useMapData.js
      components/
        AtlasSidebar.jsx
        MapCanvas.jsx
        MapTools.jsx
        useMapCanvasViewModel.js
        __MapLayerControl.jsx
        layers/
          MapAreas.jsx
          MapMarkers.jsx
          MapOverlays.jsx
          MapRecaps.jsx
      config/
        mapConfig.js
      data/
        modularize.js
        refactor.js
      utils/
        mapNavigation.js
        markerUtils.js
    campaign/
      CampaignContext.jsx
      useCampaignPersistence.js
      useCampaignSelection.js
      api/
        campaignService.js
      components/
        CampaignCard.jsx
        CampaignSelect.jsx
    dashboard/
      DashboardPage.jsx
      api/
        dashboardService.js
      components/
        ActiveThreads.jsx
        ArchiveTree.jsx
        CampaignHeader.jsx
        CurrentArcMetadata.jsx
        CurrentStoryStack.jsx
        InsightsGrid.jsx
        PartyWidget.jsx
        QuickInsights.jsx
    graph/
      GraphPage.jsx
      useGraphView.js
      api/
        graphService.js
      components/
        CytoscapeCanvas.jsx
        GraphLegend.jsx
      config/
        graphStyles.js
      utils/
        graphMapper.js
    navigation/
      MainLayout.jsx
      useNavigation.js
      components/
        Sidebar.jsx
        SidebarFooter.jsx
        SidebarHeader.jsx
        SidebarNav.jsx
      config/
        navConfig.js
    search/
      GlobalSearch.jsx
      SearchContext.jsx
      useGlobalSearch.js
      api/
        searchService.js
      components/
        SearchFooter.jsx
        SearchModal.jsx
        SearchResultItem.jsx
        SearchResults.jsx
        SearchTrigger.jsx
      utils/
        searchMapper.js
    smart-text/
      SmartMarkdown.jsx
      useEntityIndex.js
      useSmartText.js
      components/
        EntityEmbed.jsx
        SmartEntityLink.jsx
    smart-tooltip/
      TooltipContainer.jsx
      TooltipContext.jsx
      useSmartPosition.js
      useTooltipState.js
      components/
        TooltipCard.jsx
      config/
        tooltipProfiles.js
    table-of-contents/
      TableOfContents.jsx
      components/
        TocItem.jsx
        TocMobileDrawer.jsx
      hooks/
        useTocObserver.js
        useTocScroll.js
    timeline/
      TimelinePage.jsx
      useTimelineView.js
      api/
        timelineService.js
      components/
        TimelineArcHeader.jsx
        TimelineEvent.jsx
        TimelineSession.jsx
      utils/
        eventStyles.js
    wiki/
      useEntityView.js
      useWikiNavigation.js
      WikiLayout.jsx
      api/
        wikiService.js
      components/
        EncounterTimeline.jsx
        EntityBody.jsx
        EntityHeader.jsx
        EntityHistory.jsx
        EntityLocalGraph.jsx
        EntityMiniMap.jsx
        EntitySidebar.jsx
        QuestObjectives.jsx
        SessionMentions.jsx
        WikiEntryView.jsx
        character/
          CharacterSidebar.jsx
          CharacterStats.jsx
          RelationshipNetwork.jsx
        landing/
          EntityGridCard.jsx
          EntityPosterCard.jsx
          EntityTableGroup.jsx
          Swimlane.jsx
        navigation/
          SidebarEmptyState.jsx
          WikiSidebar.jsx
          WikiSidebarHeader.jsx
          WikiSidebarList.jsx
          sidebar/
            CollapsibleGroup.jsx
            EntityListItem.jsx
            PriorityIcon.jsx
            SidebarTreeItem.jsx
            StatusIcon.jsx
      config/
        groupingConfig.js
        viewStrategies.js
      hooks/
        useEntityContent.js
        useEntityFetching.js
        useEntityGrouping.js
        useEntityHeader.js
        useEntitySidebar.js
      layouts/
        CharacterLayout.jsx
        SessionLayout.jsx
        StandardLayout.jsx
      pages/
        WikiDetailPage.jsx
        WikiLandingPage.jsx
      utils/
        attributeMapper.js
        eventMapper.js
        relationshipMapper.js
        wikiEntryMapper.js
        wikiUtils.js
  shared/
    api/
      supabaseClient.js
    components/
      ErrorBoundary.jsx
      layout/
        CollapsibleSection.jsx
        SplitView.jsx
        TabContainer.jsx
      markdown/
        MarkdownRenderer.jsx
        MarkdownWithToC.jsx
      ui/
        Breadcrumbs.jsx
        Button.jsx
        Card.jsx
        DevAdminButton.jsx
        Drawer.jsx
        EmptyState.jsx
        HighlightBadge.jsx
        LoadingSpinner.jsx
        SectionDivider.jsx
    hooks/
      useBreadcrumbs.js
      useTheme.js
    utils/
      imageUtils.js
      markdownUtils.js
      textUtils.js
      theme/
        colorUtils.js
        cssUtils.js

================================================================
### SOURCE CODE
================================================================

--- FILE: features\wiki\useEntityView.js ---
import { useMemo } from 'react';
import { parseAttributes } from '@/shared/utils/imageUtils';
import { transformAttributes } from '@/features/wiki/utils/attributeMapper';
import { useEntityHeader } from './hooks/useEntityHeader';
import { useEntityContent } from './hooks/useEntityContent';
import { useEntitySidebar } from './hooks/useEntitySidebar';

export function useEntityViewModel(entity) {
	const attributes = useMemo(() => {
		return parseAttributes(entity?.attributes);
	}, [entity]);

	const { traits, sections } = useMemo(() => {
		if (!entity) return { traits: [], sections: [] };
		return transformAttributes(attributes, entity.description);
	}, [entity, attributes]);

	const header = useEntityHeader(entity, attributes);
	const sidebar = useEntitySidebar(entity, traits);
	const content = useEntityContent(entity, attributes, sections);

	const layoutMode = useMemo(() => {
		if (entity?.type === 'session') return 'tabs';
		if (entity?.type === 'character') return 'character';
		return 'standard';
	}, [entity]);

	return useMemo(() => {
		if (!entity) return null;

		return {
			layoutMode,
			header,
			sidebar,
			content,
			raw: { ...entity, attributes },
		};
	}, [entity, layoutMode, header, sidebar, content, attributes]);
}

--- END OF features\wiki\useEntityView.js ---

--- FILE: features\wiki\useWikiNavigation.js ---
import { useState } from 'react';
import { useParams } from 'react-router-dom';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { useEntityFetching } from './hooks/useEntityFetching';
import { useEntityGrouping } from './hooks/useEntityGrouping';

export function useWikiNavigation() {
	const { type } = useParams();
	const [search, setSearch] = useState('');

	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Fetch entities AND context (Arcs, Relationships)
	// FIX: Destructure 'context' here
	const { entities, context, isLoading } = useEntityFetching(normalizedType);

	// 2. Group and filter entities
	// FIX: Pass 'context' to the grouping hook so it can map Session -> Arc
	const groups = useEntityGrouping(entities, normalizedType, search, context);

	// 3. Build UI config
	const entityConfig = getEntityConfig(normalizedType);

	// Guard clause in case config isn't found (e.g. invalid URL)
	if (!entityConfig) {
		return { isLoading: true, groups: [], config: { label: 'Loading...', textClass: '' } };
	}

	const config = {
		label: `${entityConfig.label}s`,
		Icon: entityConfig.icon,
		textClass: entityConfig.tailwind.text,
	};

	return {
		config,
		isLoading,
		hasItems: groups.length > 0 && groups.some((g) => g.items.length > 0),
		groups,
		search,
		setSearch,
	};
}

--- END OF features\wiki\useWikiNavigation.js ---

--- FILE: features\wiki\WikiLayout.jsx ---
import { Outlet } from 'react-router-dom';
import { useWikiNavigation } from './useWikiNavigation';
import { WikiSidebar } from '@/features/wiki/components/navigation/WikiSidebar';

export default function WikiLayout() {
	const navigation = useWikiNavigation();

	return (
		<div className='relative flex flex-col lg:flex-row h-full bg-background overflow-hidden'>
			{/* Sidebar - First in DOM for Mobile Top position, Ordered 2nd for Desktop Right position */}
			<WikiSidebar navigation={navigation} className='lg:order-2 lg:border-l lg:border-border lg:h-full z-30' />

			{/* Main Content */}
			<div className='flex-1 lg:order-1 overflow-y-auto bg-background relative z-0 custom-scrollbar'>
				<Outlet />
			</div>
		</div>
	);
}

--- END OF features\wiki\WikiLayout.jsx ---

--- FILE: features\wiki\api\wikiService.js ---
// features/wiki/api/wikiService.js
import { supabase } from '@/shared/api/supabaseClient';

export const getWikiEntry = async (id, type) => {
	// STRATEGY: Session
	// Uses view_campaign_timeline to get the session + aggregated events + relationship tags
	if (type === 'session') {
		const { data: timelineData, error } = await supabase
			.from('view_campaign_timeline')
			.select('*')
			.eq('session_id', id)
			.single();

		if (error) throw error;

		// Fetch direct (non-event) relationships for the "Mentions" tab
		const { data: directRels } = await supabase
			.from('entity_relationships')
			.select(`target:entities!to_entity_id ( id, name, type ), relationship_type`)
			.eq('from_entity_id', id);

		const sessionRelationships = (directRels || []).map((rel) => ({
			entity_id: rel.target.id,
			entity_name: rel.target.name,
			entity_type: rel.target.type,
			type: rel.relationship_type,
		}));

		// Transform Tags (from View) into EventRelMap format for the Mapper
		const eventRelMap = new Map();
		(timelineData.events || []).forEach((event) => {
			if (event.tags && event.tags.length > 0) {
				eventRelMap.set(
					event.id,
					event.tags.map((tag) => ({
						entity_id: tag.entity_id,
						entity_name: tag.name,
						entity_type: tag.type,
						type: 'mention',
					}))
				);
			}
		});

		return {
			data: {
				id: timelineData.session_id,
				title: timelineData.session_title,
				narrative: timelineData.session_narrative,
				events: timelineData.events,
				attributes: {
					...timelineData.attributes,
					session_number: timelineData.session_number,
					session_date: timelineData.session_date,
				},
			},
			type: 'session',
			additional: { eventRelMap, sessionRelationships },
		};
	}

	// STRATEGY: Standard Entity (Core Data)
	// Uses the optimized entity_complete_view (JSONB source)
	const { data, error } = await supabase.from('entity_complete_view').select('*').eq('id', id).single();

	if (error) throw error;

	const additional = {};

	// STRATEGY: Quest Objectives
	// Single query with nested session attributes
	if (type === 'quest') {
		const { data: objectives } = await supabase
			.from('quest_objectives')
			.select(
				`
                *,
                session:sessions ( id, title, attributes )
            `
			)
			.eq('quest_id', id)
			.order('order_index', { ascending: true });

		additional.objectives = objectives || [];
	}

	// STRATEGY: Encounter Actions
	// Uses the hydrated view to avoid N+1 attribute lookups
	if (type === 'encounter') {
		const { data: actions } = await supabase
			.from('view_encounter_actions_hydrated')
			.select('*')
			.eq('encounter_id', id)
			.order('round_number', { ascending: true })
			.order('action_order', { ascending: true });

		additional.encounterActions = actions || [];
	}

	// STRATEGY: Event Session Resolution
	// (Only needed if the entity has historical events)
	// We optimize this by fetching only the needed session attributes
	if (data.events && Object.keys(data.events).length > 0) {
		const flatEvents = Object.values(data.events).flat();
		const sessionIds = [...new Set(flatEvents.map((e) => e.session_id).filter(Boolean))];

		if (sessionIds.length > 0) {
			const { data: sessions } = await supabase.from('sessions').select('id, attributes').in('id', sessionIds);

			const sessionMap = new Map();
			(sessions || []).forEach((s) => {
				// Access JSONB column directly
				const num = s.attributes?.session_number || s.attributes?.session;
				sessionMap.set(s.id, num ? Number(num) : null);
			});
			additional.sessionMap = sessionMap;
		}
	}

	return { data, type, additional };
};

--- END OF features\wiki\api\wikiService.js ---

--- FILE: features\wiki\components\EncounterTimeline.jsx ---
import React from 'react';
import {
	Swords,
	Shield,
	Zap,
	Skull,
	Footprints,
	MessageSquare,
	Hand,
	Dices,
	Target,
	Activity,
	ArrowRight,
	CornerDownRight,
} from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityLink from '@/domain/entity/components/EntityLink';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { useTheme } from '@/shared/hooks/useTheme'; // FIX: Import theme hook

// ... (getActionIcon helper remains the same) ...
const getActionIcon = (type) => {
	switch (type?.toLowerCase()) {
		case 'attack':
			return Swords;
		case 'spell':
			return Zap;
		case 'move':
			return Footprints;
		case 'check':
			return Dices;
		case 'save':
			return Shield;
		case 'item':
			return Hand;
		case 'legendary':
			return Skull;
		case 'social':
			return MessageSquare;
		default:
			return Activity;
	}
};

const CombatLogEntry = ({ action }) => {
	const { isFriendly, actor, target, description, result, effect, type } = action;
	const ActionIcon = getActionIcon(type);
	const { theme } = useTheme(); // FIX: Use app theme state

	// FIX: Logic based on explicit App Theme, ignoring System Preference
	const isDark = theme === 'dark';

	// Background:
	// - Friendly: None
	// - Hostile:
	//    - Dark: Red-900 at 10% (Visible on black)
	//    - Light/DND: Red-500 at 5% (Subtle on parchment/white)
	const rowBg = isFriendly ? '' : isDark ? 'bg-red-900/5' : 'bg-red-500/2';

	// Text Colors:
	// - Dark: Lighter shades (400)
	// - Light/DND: Darker shades (700)
	const manualActorColor = isFriendly
		? isDark
			? 'text-emerald-400'
			: 'text-emerald-700'
		: isDark
		? 'text-red-400'
		: 'text-red-700';

	const effectIconColor = isDark ? 'text-amber-500' : 'text-amber-600';

	return (
		<div
			className={clsx(
				'flex items-start gap-2.5 p-2.5 border-b border-border last:border-0 text-sm transition-colors group',
				'hover:bg-muted/50',
				rowBg
			)}>
			{/* 1. Large Sidebar Icon */}
			<div className='shrink-0 mt-0.5'>
				<EntityIcon type={actor.type} customIconUrl={actor.iconUrl} size={28} className='rounded opacity-90' />
			</div>

			{/* 2. Content */}
			<div className='flex-1 min-w-0'>
				{/* Header Line */}
				<div className='flex flex-wrap items-center gap-1 mb-1 leading-snug'>
					{/* Actor Name */}
					{actor.id ? (
						<EntityLink
							id={actor.id}
							type={actor.type}
							inline={true}
							showIcon={true}
							customIconUrl={actor.iconUrl}
							className='font-serif font-bold text-sm !no-underline hover:underline'>
							{actor.name}
						</EntityLink>
					) : (
						// Manual Entry
						<span
							className={clsx(
								'font-serif font-bold text-sm flex items-center gap-1.5 cursor-default',
								manualActorColor
							)}>
							<EntityIcon type={actor.type} size={14} inline />
							{actor.name}
						</span>
					)}

					{/* Action Badge */}
					<span className='text-[10px] uppercase font-bold text-muted-foreground/70 tracking-wider flex border border-border items-center gap-1 rounded-sm px-1.5 bg-background/50'>
						<ActionIcon size={10} />
						{type}
					</span>

					{/* Target */}
					{target && (
						<div className='flex items-center gap-1.5 text-muted-foreground'>
							<ArrowRight size={10} className='opacity-50' />

							{target.id ? (
								<EntityLink
									id={target.id}
									type={target.type}
									inline={true}
									showIcon={true}
									customIconUrl={target.iconUrl}
									className='font-serif font-semibold text-sm !no-underline hover:underline'>
									{target.name}
								</EntityLink>
							) : (
								<span className='font-serif font-semibold text-foreground text-sm flex items-center gap-1.5 cursor-default'>
									<EntityIcon type={target.type} size={14} inline />
									{target.name}
								</span>
							)}
						</div>
					)}

					{/* Result Badge */}
					{result && (
						<span className='ml-auto text-[10px] font-bold text-foreground/80 bg-background/80 px-1.5 py-0.5 rounded border border-border whitespace-nowrap'>
							{result}
						</span>
					)}
				</div>

				{/* Description */}
				{description && (
					<div className='text-xs text-muted-foreground leading-relaxed pl-0.5'>
						<SmartMarkdown components={{ p: 'span' }}>{description}</SmartMarkdown>
					</div>
				)}

				{/* Effect */}
				{effect && (
					<div className='mt-1 flex items-center gap-1.5 text-xs font-medium text-muted-foreground w-fit px-1.5 py-0.5 rounded -ml-1'>
						<CornerDownRight size={10} className={effectIconColor} />
						<span className='italic opacity-90'>
							<SmartMarkdown components={{ p: 'span' }}>{effect}</SmartMarkdown>
						</span>
					</div>
				)}
			</div>
		</div>
	);
};

export const EncounterTimeline = ({ rounds }) => {
	if (!rounds || Object.keys(rounds).length === 0) return null;

	return (
		<div className='my-6'>
			<h3 className='text-sm font-bold text-muted-foreground uppercase tracking-widest mb-3 flex items-center gap-2'>
				<Swords size={14} className='text-primary' /> Combat Log
			</h3>

			<div className='border border-border rounded-lg overflow-hidden bg-background'>
				{Object.entries(rounds).map(([roundNum, actions]) => (
					<div key={roundNum}>
						{/* Round Header */}
						<div className='bg-muted/80 border-b border-border px-3 py-1.5 flex items-center justify-between'>
							<span className='text-xs font-serif font-bold text-foreground'>Round {roundNum}</span>
							<span className='text-[9px] font-bold uppercase text-muted-foreground tracking-wider'>
								{actions.length} Turns
							</span>
						</div>

						{/* Actions Group */}
						<div
							className={clsx(
								'bg-background',
								Number(roundNum) !== Object.keys(rounds).length && 'border-b border-border'
							)}>
							{actions.map((action) => (
								<CombatLogEntry key={action.id} action={action} />
							))}
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EncounterTimeline.jsx ---

--- FILE: features\wiki\components\EntityBody.jsx ---
import { History, Diamond } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { EntityHistory } from './EntityHistory';
import { QuestObjectives } from './QuestObjectives';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';
import { EncounterTimeline } from './EncounterTimeline';
import { EntityMiniMap } from '@/features/wiki/components/EntityMiniMap';

// Re-exporting History for use in tabs if needed by parent
export { EntityHistory } from './EntityHistory';

const LevelUpBanner = ({ level }) => {
	const logoPath = `${import.meta.env.BASE_URL}logo_detailed.png`;

	return (
		<div className='mt-4 mb-6 w-full'>
			{/* Full Width, Fixed Height (~64px) Banner */}
			<div className='flex items-center h-16 bg-muted/60 border-y border-r border-border border-l-2 border-l-primary rounded-lg shadow-sm w-full overflow-hidden'>
				{/* Logo Section - Vertical Center */}
				<div className='shrink-0 h-full flex items-center px-5 bg-amber-500/10/50 border-r border-border/40'>
					<img src={logoPath} alt='Campaign Logo' className='h-12 w-auto object-contain opacity-80 drop-shadow-sm' />
				</div>

				{/* Text Content */}
				<div className='flex-1 flex flex-col justify-center px-4'>
					<h3 className='text-xs font-serif font-bold text-primary uppercase tracking-[0.15em] leading-none m-0! p-0!'>
						Level Up
					</h3>
					<p className='font-serif text-sm text-card-foreground leading-none p-0! m-0!'>
						The party has reached <span className='font-bold text-foreground'>Level {level}</span>.
					</p>
				</div>
			</div>
		</div>
	);
};

export const EntityBody = ({
	summary,
	sections,
	history,
	objectives,
	combatRounds,
	levelUp,
	mapImageUrl,
	mapMarkers,
}) => {
	return (
		<div className='prose max-w-none prose-headings:font-serif prose-headings:font-bold prose-headings:text-foreground prose-p:text-[11pt] prose-p:leading-relaxed prose-p:my-2 prose-strong:text-foreground prose-strong:font-bold prose-li:marker:text-amber-600 prose-li:text-sm prose-li:my-0.5 prose-p:text-justify'>
			{summary && (
				<div className='mb-4 text-muted-foreground'>
					<SmartMarkdown>{summary}</SmartMarkdown>
				</div>
			)}
			{/* Quest Objectives */}
			{objectives && objectives.length > 0 && (
				<>
					<SectionDivider />
					<QuestObjectives objectives={objectives} />
				</>
			)}
			{mapImageUrl && mapImageUrl.length > 0 && (
				<>
					<SectionDivider />
					<EntityMiniMap imageUrl={mapImageUrl} markers={mapMarkers} />
				</>
			)}

			{/* Combat Timeline */}
			{combatRounds && Object.keys(combatRounds).length > 0 && (
				<>
					<SectionDivider />
					<EncounterTimeline rounds={combatRounds} />
				</>
			)}
			{/* Narrative Sections */}
			{sections.map((prop) => {
				if (prop.displayType === 'list' && Array.isArray(prop.value)) {
					return (
						<div key={prop.key}>
							<SectionDivider />
							<h3 className='capitalize text-lg mt-0 font-serif text-amber-900 dark:text-foreground mb-2 font-bold'>
								{prop.key}
							</h3>
							<ul className='grid grid-cols-1 gap-1.5 pl-1 list-none my-0'>
								{prop.value.map((item, idx) => (
									<li key={idx} className='flex items-start gap-3 m-0 p-0 text-foreground group'>
										<div className='mt-[0.45rem] shrink-0 text-accent/60 group-hover:text-accent transition-colors'>
											<Diamond size={8} fill='currentColor' />
										</div>
										<span className='text-[11pt] leading-snug'>
											<SmartMarkdown components={{ p: 'span' }}>{item}</SmartMarkdown>
										</span>
									</li>
								))}
							</ul>
						</div>
					);
				}
				return (
					<div key={prop.key}>
						<SectionDivider />
						<h3 className='capitalize text-lg font-serif text-amber-900 dark:text-foreground mb-1 mt-0 inline-block pb-0.5'>
							{prop.key}
						</h3>
						<div className='mt-0.5'>
							<SmartMarkdown>{prop.value}</SmartMarkdown>
						</div>
					</div>
				);
			})}
			{history && history.length > 0 && (
				<div className='mt-2'>
					<SectionDivider />
					<h3 className='font-serif text-lg mt-0 font-bold text-foreground mb-3 flex items-center gap-2'>
						<History size={16} className='text-amber-900/70 dark:text-muted-foreground' /> Events
					</h3>
					<EntityHistory events={history} fullHeight />
				</div>
			)}
			{/* Level Up Banner */}
			{levelUp && <LevelUpBanner level={levelUp} />}
		</div>
	);
};

--- END OF features\wiki\components\EntityBody.jsx ---

--- FILE: features\wiki\components\EntityHeader.jsx ---
import { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { Link, useParams } from 'react-router-dom';
import { Edit3, X, Maximize2 } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import { getPriorityStyles } from '@/domain/entity/config/entityStyles';

const ImageLightbox = ({ src, alt, onClose }) => {
	useEffect(() => {
		document.body.style.overflow = 'hidden';
		const handleEsc = (e) => {
			if (e.key === 'Escape') onClose();
		};
		window.addEventListener('keydown', handleEsc);
		return () => {
			document.body.style.overflow = 'unset';
			window.removeEventListener('keydown', handleEsc);
		};
	}, [onClose]);

	return createPortal(
		<div
			className='fixed inset-0 z-[9999] flex items-center justify-center p-8 bg-background/30 backdrop-blur-md animate-in fade-in duration-200'
			onClick={onClose}>
			<div
				className='relative inline-block shadow-2xl rounded-lg overflow-hidden bg-black/5 ring-1 ring-black/10'
				onClick={(e) => e.stopPropagation()}>
				<img src={src} alt={alt} className='max-w-[85vw] max-h-[85vh] object-contain block select-none' />
				<button
					onClick={onClose}
					className='absolute top-3 right-3 p-1.5 bg-black/50 hover:bg-black/70 text-white/90 hover:text-white rounded-full transition-all duration-200 backdrop-blur-sm shadow-sm'>
					<X size={18} strokeWidth={2.5} />
				</button>
			</div>
		</div>,
		document.body
	);
};

export const EntityHeader = ({ data }) => {
	const { title, subtitle, typeLabel, imageUrl, avatarUrl, status, priority, extraTags, type } = data;
	const { entityId } = useParams();
	const [isLightboxOpen, setIsLightboxOpen] = useState(false);
	const isDev = import.meta.env.DEV;

	const noImageStyle = !imageUrl
		? {
				background: `radial-gradient(80% 100% at 50% -20%, var(--muted) 0%, var(--background) 100%)`,
		  }
		: {};

	return (
		<>
			<div
				className={clsx(
					'h-48 md:h-64 relative group overflow-hidden select-none',
					imageUrl ? 'cursor-pointer' : 'border-b border-border/40'
				)}
				style={noImageStyle}
				onClick={() => imageUrl && setIsLightboxOpen(true)}>
				{imageUrl && (
					<>
						<img
							src={imageUrl}
							alt={title}
							className={clsx(
								'absolute inset-0 w-full h-full object-cover transition-all duration-[2000ms] ease-in-out',
								'object-[center_30%] group-hover:object-[center_50%] group-hover:scale-105'
							)}
						/>
						<div className='absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10'>
							<div className='bg-black/30 backdrop-blur-md p-2 rounded-full text-white/80 border border-white/10 shadow-lg'>
								<Maximize2 size={16} />
							</div>
						</div>
						<div className='absolute inset-0 bg-gradient-to-t from-[var(--background)] from-0% via-[var(--background)]/80 via-10% via-[var(--background)]/20 via-20% to-transparent pointer-events-none' />
					</>
				)}

				{isDev && entityId && (
					<div
						className='absolute top-4 right-4 z-30 animate-in fade-in slide-in-from-right-2 duration-500'
						onClick={(e) => e.stopPropagation()}>
						<Link
							to={`/dm/manage/${typeLabel.toLowerCase()}/${entityId}`}
							className='flex items-center gap-2 px-3 py-1.5 bg-background/80 backdrop-blur-md border border-border rounded-full shadow-lg text-muted-foreground hover:text-primary hover:border-primary transition-all group/edit'>
							<Edit3 size={14} className='group-hover/edit:scale-110 transition-transform' />
							<span className='text-[10px] font-bold uppercase tracking-tight'>Quick Edit</span>
						</Link>
					</div>
				)}

				<div
					className={clsx(
						'absolute bottom-0 left-0 w-full pointer-events-none',
						type === 'character' ? 'p-4 md:p-6 md:pb-0!' : 'p-4 md:p-6 '
					)}>
					<div className='max-w-6xl mx-auto flex items-end gap-5'>
						<div className='hidden md:flex md:items-end pointer-events-auto mb-1'>
							<EntityIcon
								type={typeLabel.toLowerCase()}
								customIconUrl={avatarUrl}
								size={64}
								showBackground
								className='w-[84px] h-[84px] shadow-xl border-2 border-background/50 object-cover bg-background'
							/>
						</div>

						<div className='flex-1 pb-1 min-w-0'>
							<div className='flex items-center flex-wrap gap-2 mb-2'>
								<EntityBadge
									type={typeLabel.toLowerCase()}
									size='sm'
									variant='solid'
									className='bg-background/80 backdrop-blur-sm border-border/50 text-foreground shadow-sm'
								/>
								{status.hasStatus && (
									<span
										className={clsx(
											'px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm backdrop-blur-sm',
											status.isDead ? 'badge-dead' : 'badge-alive'
										)}>
										{status.label}
									</span>
								)}
								{priority && (
									<span
										className={clsx(
											'px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm backdrop-blur-sm',
											getPriorityStyles(priority)
										)}>
										{priority} Priority
									</span>
								)}
								{extraTags &&
									extraTags.map((tag, i) => (
										<span
											key={i}
											className='px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border shadow-sm bg-card/80 backdrop-blur-sm border-slate-300 text-slate-700 dark:text-slate-300 dark:border-slate-700'>
											{tag}
										</span>
									))}
							</div>

							<h1 className='text-3xl md:text-5xl font-serif font-bold text-foreground leading-none drop-shadow-sm tracking-tight break-words'>
								{title}
							</h1>

							{/* --- NEW: Subtitle (Race/Class/Level) --- */}
							{subtitle && (
								<div className='text-sm font-semibold text-muted-foreground opacity-90 drop-shadow-md'>{subtitle}</div>
							)}
						</div>
					</div>
				</div>
			</div>
			{isLightboxOpen && imageUrl && (
				<ImageLightbox src={imageUrl} alt={title} onClose={() => setIsLightboxOpen(false)} />
			)}
		</>
	);
};

--- END OF features\wiki\components\EntityHeader.jsx ---

--- FILE: features\wiki\components\EntityHistory.jsx ---
import { Calendar } from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

export const EntityHistory = ({ events, showSession = true, fullHeight = true }) => {
	if (!events || events.length === 0) return null;

	return (
		// 1. Container Logic
		// If fullHeight is true, we allow the div to expand naturally.
		// If false, we clamp it to 600px with a scrollbar.
		<div className={clsx(!fullHeight && 'max-h-[600px] overflow-y-auto custom-scrollbar pr-2')}>
			{/* 2. Timeline Container */}
			{/* ml-5 pushes the border line right, creating a safe gutter for the dots (-left-[19px]) 
                so they don't get clipped by overflow:hidden or scroll containers */}
			<div className='border-l-2 border-border ml-2 pl-3 space-y-6 relative my-2'>
				{events.map((evt, idx) => (
					<div key={evt.id || idx} className='relative group'>
						{/* Timeline Dot */}
						<div
							className={clsx(
								'absolute -left-[19px] top-1.5 w-3 h-3 rounded-full border border-background',
								'bg-stone-300 ring-1 ring-border',
								'group-hover:bg-accent group-hover:ring-accent/40 transition-colors shadow-sm'
							)}
						/>

						{/* Title Row with Session Badge */}
						<div className='flex items-center gap-2 mb-1 flex-wrap'>
							<h4 className='font-bold text-foreground text-sm mt-0.5'>{evt.title}</h4>
							{showSession && evt.session_number != null && (
								<span className='inline-flex items-center gap-1 text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ml-auto max-w-[45%] truncate bg-muted text-muted-foreground border-border/60'>
									<Calendar size={9} />
									Session {evt.session_number}
								</span>
							)}
						</div>

						{/* Description */}
						<div className='text-sm text-muted-foreground leading-relaxed text-justify'>
							<SmartMarkdown>{evt.description}</SmartMarkdown>
						</div>
					</div>
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityHistory.jsx ---

--- FILE: features\wiki\components\EntityLocalGraph.jsx ---
import React, { useMemo, useCallback, useState, useRef, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Network, Maximize, Minimize } from 'lucide-react';
import { clsx } from 'clsx';
import { CytoscapeCanvas } from '@/features/graph/components/CytoscapeCanvas';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { useTheme } from '@/shared/hooks/useTheme';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';

// --- LOCAL GRAPH CONFIGURATION ---
const LOCAL_LAYOUT = {
	name: 'fcose',
	quality: 'default',
	randomize: true,
	animate: false,
	animationDuration: 800,
	fit: true,
	padding: 30,
	nodeDimensionsIncludeLabels: true,
	nodeRepulsion: 8000,
	idealEdgeLength: 80,
	edgeElasticity: 0.45,
	gravity: 0.3,
	numIter: 2500,
	tilingPaddingVertical: 10,
	tilingPaddingHorizontal: 10,
	initialEnergyOnIncremental: 0.3,
};

const getLocalStyles = (isDark) => {
	const colors = {
		text: isDark ? '#e5e5e5' : '#171717',
		border: isDark ? '#404040' : '#d4d4d4',
		halo: isDark ? '#000000' : '#ffffff',
		edge: isDark ? '#525252' : '#a3a3a3',
	};

	return [
		{
			selector: 'node',
			style: {
				width: 16,
				height: 16,
				label: 'data(label)',
				'background-image': 'data(image)',
				'background-fit': 'cover',
				'border-width': 1,
				'border-color': 'data(borderColor)',
				'background-color': 'data(bgColor)',
				'font-family': 'Inter, sans-serif',
				'font-size': '8px',
				'font-weight': '600',
				'text-valign': 'bottom',
				'text-margin-y': 4,
				'text-outline-color': colors.halo,
				'text-outline-width': 2,
				color: colors.text,
				'transition-property': 'width, height, border-width',
				'transition-duration': '0.2s',
			},
		},
		{
			selector: 'node[?isCenter]',
			style: {
				width: 28,
				height: 28,
				'border-width': 2,
				'font-size': '10px',
				'z-index': 10,
			},
		},
		{
			selector: 'edge[type != "virtual"]',
			style: {
				width: 1,
				'curve-style': 'bezier',
				'line-color': colors.edge,
				'target-arrow-shape': 'none',
				opacity: 0.5,
			},
		},
		{
			selector: 'edge[type = "virtual"]',
			style: {
				width: 0,
				opacity: 0,
				'curve-style': 'straight',
				events: 'no',
			},
		},
	];
};

export const EntityLocalGraph = ({ entity, relationships, className, height = 'h-64', headerShown = true }) => {
	const navigate = useNavigate();
	const { theme } = useTheme();
	const { map: entityIndex } = useEntityIndex();
	const isDark = theme === 'dark';

	// FULLSCREEN STATE
	const containerRef = useRef(null);
	const [isFullscreen, setIsFullscreen] = useState(false);
	const [isPseudoFullscreen, setIsPseudoFullscreen] = useState(false);

	// Combine native and pseudo states
	const activeFullscreen = isFullscreen || isPseudoFullscreen;

	// Handle Native Fullscreen Changes
	useEffect(() => {
		const handler = () => setIsFullscreen(!!document.fullscreenElement);
		document.addEventListener('fullscreenchange', handler);
		return () => document.removeEventListener('fullscreenchange', handler);
	}, []);

	// Handle Escape Key for Pseudo Fullscreen
	useEffect(() => {
		const handleEsc = (e) => {
			if (e.key === 'Escape' && isPseudoFullscreen) setIsPseudoFullscreen(false);
		};
		window.addEventListener('keydown', handleEsc);
		return () => window.removeEventListener('keydown', handleEsc);
	}, [isPseudoFullscreen]);

	// Toggle Function
	const toggleFullscreen = useCallback(
		(e) => {
			e.stopPropagation();
			if (!containerRef.current) return;

			const supportsNative = document.fullscreenEnabled || containerRef.current.requestFullscreen;

			// Prefer native, fallback to pseudo (iOS)
			if (supportsNative) {
				if (!document.fullscreenElement) {
					containerRef.current.requestFullscreen().catch(() => setIsPseudoFullscreen(true));
				} else {
					document.exitFullscreen();
				}
			} else {
				setIsPseudoFullscreen(!isPseudoFullscreen);
			}
		},
		[isPseudoFullscreen]
	);

	// --- DATA TRANSFORMATION ---
	const elements = useMemo(() => {
		if (!entity) return [];
		const nodes = [];
		const edges = [];
		const addedIds = new Set();
		const typeGroups = {};
		const FALLBACK_ICON_ROOT = 'images/icons';

		const resolveNodeIcon = (type, attributes, id) => {
			let url = resolveImageUrl(attributes, 'icon');
			if (!url && id && entityIndex.has(id)) {
				const cached = entityIndex.get(id);
				if (cached.iconUrl) url = cached.iconUrl;
			}
			if (!url) {
				const safeType = (type || 'default').toLowerCase().replace(/\s+/g, '_');
				url = `${FALLBACK_ICON_ROOT}/${safeType}.webp`;
			}
			return url;
		};

		const addNode = (id, name, type, attributes = {}, isCenter = false) => {
			if (!id || addedIds.has(id)) return;
			addedIds.add(id);

			if (!isCenter) {
				if (!typeGroups[type]) typeGroups[type] = [];
				typeGroups[type].push(id);
			}

			const config = getEntityConfig(type);
			const finalImage = resolveNodeIcon(type, attributes, id);

			// Apply Colors
			const borderColor = config.color || (isDark ? '#404040' : '#d4d4d4');
			const nodeBgColor = config.color || (isDark ? '#262626' : '#f5f5f5');

			nodes.push({
				data: {
					id,
					label: name,
					image: finalImage,
					type,
					bgColor: nodeBgColor,
					borderColor,
					isCenter,
				},
				classes: isCenter ? 'center' : '',
			});
		};

		addNode(entity.id, entity.name, entity.type, entity.attributes, true);

		if (relationships) {
			relationships.forEach((rel) => {
				const targetId = rel.id || rel.entity_id || rel.target;
				const targetName = rel.name || rel.entity_name;
				const targetType = rel.typeLabel || rel.entity_type || rel.type || 'default';

				if (targetId) {
					addNode(targetId, targetName, targetType, {});
					edges.push({
						data: {
							source: entity.id,
							target: targetId,
							type: 'standard',
						},
					});
				}
			});
		}

		Object.keys(typeGroups).forEach((type) => {
			const groupIds = typeGroups[type];
			if (groupIds.length > 1 && groupIds.length < 15) {
				for (let i = 0; i < groupIds.length; i++) {
					edges.push({
						data: { source: groupIds[i], target: groupIds[(i + 1) % groupIds.length], type: 'virtual' },
					});
				}
			}
		});

		return [...nodes, ...edges];
	}, [entity, relationships, isDark, entityIndex]);

	const handleNodeClick = useCallback(
		(data) => {
			if (activeFullscreen && document.fullscreenElement) {
				document.exitFullscreen();
			}
			if (isPseudoFullscreen) setIsPseudoFullscreen(false);

			if (data.id && data.type && data.id !== entity.id) {
				navigate(`/wiki/${data.type}/${data.id}`);
			}
		},
		[navigate, entity.id, activeFullscreen, isPseudoFullscreen]
	);

	if (elements.length <= 1) return null;

	return (
		<div className={clsx('w-full flex flex-col', className)}>
			{!activeFullscreen && headerShown && (
				<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-2 px-1'>
					<Network size={10} /> Local Graph
				</h3>
			)}

			<div
				ref={containerRef}
				className={clsx(
					'w-full relative bg-muted/20 border border-border rounded-lg overflow-hidden group transition-all duration-300',
					// Fullscreen Styles
					activeFullscreen ? 'fixed inset-0 z-[9999] h-screen w-screen m-0 rounded-none bg-background' : height
				)}>
				{/* Graph Background */}
				<div
					className='absolute inset-0 z-0 opacity-50'
					style={{
						backgroundImage: 'radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
						backgroundSize: '20px 20px',
						backgroundPosition: '10px 10px',
					}}
				/>

				{/* Fullscreen Toggle Button */}
				<button
					onClick={toggleFullscreen}
					className={clsx(
						'absolute z-50 p-2 rounded-full border border-border shadow-sm transition-all active:scale-95',
						'bg-background/90 backdrop-blur text-muted-foreground hover:text-primary hover:bg-background',
						// Positioning Logic
						activeFullscreen
							? 'top-1/2 right-4 -translate-y-1/2 lg:top-6 lg:right-6 lg:translate-y-0' // Middle-Right Mobile, Top-Right Desktop
							: 'top-2 right-2' // Normal State
					)}
					title={activeFullscreen ? 'Exit Fullscreen' : 'Fullscreen'}>
					{activeFullscreen ? <Minimize size={18} /> : <Maximize size={16} />}
				</button>

				<CytoscapeCanvas
					elements={elements}
					layoutConfig={LOCAL_LAYOUT}
					stylesheet={getLocalStyles(isDark)}
					onNodeClick={handleNodeClick}
					interactive={true}
				/>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityLocalGraph.jsx ---

--- FILE: features\wiki\components\EntityMiniMap.jsx ---
import React, { useEffect, useState, useRef } from 'react';
import { MapContainer, ImageOverlay, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import { Map as MapIcon, Maximize, Minimize, BookOpen, ArrowRight } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { clsx } from 'clsx';
import { resolveMarkerIcon } from '@/features/atlas/utils/markerUtils';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { useEntityIndex } from '@/features/smart-text/useEntityIndex';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

const MapController = ({ bounds, activeFullscreen }) => {
	const map = useMap();
	useEffect(() => {
		if (bounds && map) {
			const timer = setTimeout(() => {
				map.invalidateSize({ animate: true });
				map.fitBounds(bounds, { padding: [20, 20] });
			}, 100);
			return () => clearTimeout(timer);
		}
	}, [map, bounds, activeFullscreen]);
	return null;
};

export const EntityMiniMap = ({ imageUrl, markers = [] }) => {
	const [dimensions, setDimensions] = useState(null);
	const [loading, setLoading] = useState(true);
	const [isFullscreen, setIsFullscreen] = useState(false);
	const [isPseudoFullscreen, setIsPseudoFullscreen] = useState(false);
	const containerRef = useRef(null);
	const navigate = useNavigate();
	const { map: entityMap } = useEntityIndex();

	const activeFullscreen = isFullscreen || isPseudoFullscreen;

	useEffect(() => {
		const handler = () => setIsFullscreen(!!document.fullscreenElement);
		document.addEventListener('fullscreenchange', handler);
		return () => document.removeEventListener('fullscreenchange', handler);
	}, []);

	useEffect(() => {
		const handleEsc = (e) => {
			if (e.key === 'Escape' && isPseudoFullscreen) setIsPseudoFullscreen(false);
		};
		window.addEventListener('keydown', handleEsc);
		return () => window.removeEventListener('keydown', handleEsc);
	}, [isPseudoFullscreen]);

	useEffect(() => {
		const img = new Image();
		img.src = imageUrl;
		img.onload = () => {
			const w = img.width;
			const h = img.height;
			const southWest = [-h, 0];
			const northEast = [0, w];
			setDimensions(L.latLngBounds(southWest, northEast));
			setLoading(false);
		};
	}, [imageUrl]);

	const toggleFullscreen = (e) => {
		e.stopPropagation();
		if (!containerRef.current) return;
		const supportsNative =
			document.fullscreenEnabled || document.webkitFullscreenEnabled || containerRef.current.requestFullscreen;
		if (supportsNative) {
			if (!document.fullscreenElement) {
				containerRef.current.requestFullscreen().catch(() => setIsPseudoFullscreen(true));
			} else {
				document.exitFullscreen();
			}
		} else {
			setIsPseudoFullscreen(!isPseudoFullscreen);
		}
	};

	if (loading)
		return (
			<div className='h-64 w-full bg-muted rounded-xl flex items-center justify-center border border-border mb-8'>
				<LoadingSpinner text='Generating tactical view...' size='sm' />
			</div>
		);

	return (
		<div
			className={clsx('mb-10 space-y-3 group', isPseudoFullscreen && 'fixed inset-0 z-[9999] m-0! bg-background')}
			ref={containerRef}>
			{!activeFullscreen && (
				<div className='flex items-center justify-between px-1'>
					<h3 className='font-serif text-lg mt-0 font-bold text-foreground mb-3 flex items-center gap-2'>
						<MapIcon size={16} className='text-primary' /> Map
					</h3>
				</div>
			)}

			<div
				className={clsx(
					'w-full overflow-hidden relative z-0 transition-all duration-300',
					activeFullscreen ? 'h-screen rounded-none border-0' : 'h-96 rounded-xl border border-border shadow-sm'
				)}>
				<MapContainer
					crs={L.CRS.Simple}
					bounds={dimensions}
					zoom={-2}
					minZoom={-3}
					scrollWheelZoom={true}
					attributionControl={false}
					style={{
						height: '100%',
						width: '100%',
						backgroundColor: 'var(--background)',
						backgroundImage:
							'radial-gradient(circle at center, var(--border) 1px, transparent 1px), radial-gradient(circle at center, var(--border) 1px, transparent 1px)',
						backgroundSize: '40px 40px, 20px 20px',
						backgroundPosition: '0 0, 20px 20px',
					}}>
					<MapController bounds={dimensions} activeFullscreen={activeFullscreen} />
					<ImageOverlay url={imageUrl} bounds={dimensions} />

					{markers.map((marker, idx) => {
						const entityMatch = Array.from(entityMap.values()).find(
							(e) => e.name.toLowerCase() === marker.label.toLowerCase()
						);
						const entityAttrs = entityMatch ? parseAttributes(entityMatch.attributes) : {};

						const displayData = {
							title: marker.label,
							category:
								marker.category && marker.category !== 'default'
									? marker.category
									: entityMatch
									? entityMatch.type
									: 'Point of Interest',
							description: marker.description
								? marker.description
								: entityMatch
								? getAttributeValue(entityAttrs, ['summary', 'narrative']) || entityMatch.description
								: null,
							image: entityMatch ? resolveImageUrl(entityAttrs, 'background') : null,
						};

						const entityConfig = entityMatch ? getEntityConfig(entityMatch.type) : null;

						const handleWikiNav = (e) => {
							e.stopPropagation();
							if (entityMatch) {
								navigate(`/wiki/${entityMatch.type}/${entityMatch.id}`);
							}
						};

						return (
							<Marker
								key={`${marker.label}-${idx}`}
								position={[marker.lat, marker.lng]}
								icon={resolveMarkerIcon(marker)}>
								{marker.label && (
									<Popup className='custom-popup-clean' closeButton={false}>
										<div className='flex flex-col w-full font-sans bg-background rounded-lg overflow-hidden border border-border shadow-sm'>
											{displayData.image && (
												<div className='h-24 w-full relative bg-muted'>
													<img
														src={displayData.image}
														alt={displayData.title}
														className='w-full h-full object-cover m-0!'
													/>
													{/* FIX: Improved Gradient */}
													<div className='absolute inset-0 bg-gradient-to-t from-[var(--background)] via-[var(--background)]/80 via-30% to-transparent pointer-events-none' />
												</div>
											)}

											<div className={clsx('px-4 pb-3', displayData.image ? 'pt-2 -mt-8 relative z-10' : 'pt-4')}>
												<div className='flex items-start justify-between gap-2'>
													<div>
														<span
															className={clsx(
																'text-[10px] font-bold uppercase tracking-wider block mb-0.5',
																entityConfig ? entityConfig.tailwind.text : 'text-muted-foreground'
															)}>
															{displayData.category}
														</span>
														<h3 className='font-serif font-bold text-lg leading-tight text-foreground drop-shadow-sm m-0!'>
															{displayData.title}
														</h3>
													</div>
													{entityConfig && (
														<div
															className={clsx(
																'p-1.5 rounded-md border shrink-0 bg-background/80 backdrop-blur-sm',
																entityConfig.tailwind.border,
																entityConfig.tailwind.text
															)}>
															<entityConfig.icon size={14} />
														</div>
													)}
												</div>

												<div className='h-px w-full bg-border/50 my-3' />

												<div className='text-xs text-muted-foreground leading-relaxed max-h-32 overflow-y-auto custom-scrollbar'>
													{displayData.description || <span className='italic opacity-70'>No details available.</span>}
												</div>
											</div>

											{entityMatch && (
												<div className='bg-muted/50 p-2 border-t border-border'>
													<button
														onClick={handleWikiNav}
														className='w-full flex items-center justify-between px-3 py-1.5 rounded hover:bg-background text-muted-foreground hover:text-foreground transition-colors text-xs font-semibold group'>
														<span className='flex items-center gap-2'>
															<BookOpen size={12} /> View Encyclopedia
														</span>
														<ArrowRight size={12} className='opacity-0 group-hover:opacity-100 transition-opacity' />
													</button>
												</div>
											)}
										</div>
									</Popup>
								)}
							</Marker>
						);
					})}
				</MapContainer>

				<div
					className={clsx(
						'absolute z-[10060] transition-all duration-300',
						activeFullscreen ? 'top-[50%] right-4 lg:top-6 lg:right-6 pr-safe pt-safe' : 'top-4 right-4'
					)}>
					<button
						onClick={toggleFullscreen}
						className={clsx(
							'p-3 rounded-full border border-border shadow-2xl transition-all active:scale-90',
							'bg-background/95 backdrop-blur-md text-foreground hover:bg-primary hover:text-white'
						)}
						title={activeFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen'}>
						{activeFullscreen ? <Minimize size={20} strokeWidth={2.5} /> : <Maximize size={20} strokeWidth={2.5} />}
					</button>
				</div>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\EntityMiniMap.jsx ---

--- FILE: features\wiki\components\EntitySidebar.jsx ---
import { useMemo } from 'react';
import { Tag, Network, Shield, Activity } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import EntityLink from '@/domain/entity/components/EntityLink';
import { capitalize, toTitleCase } from '@/shared/utils/textUtils';
import { EntityLocalGraph } from './EntityLocalGraph'; // Import new component

// --- SUB-COMPONENTS ---
const AbilityGrid = ({ stats }) => (
	<div className='grid grid-cols-3 gap-2 mt-2 mb-4'>
		{stats.map((stat, i) => (
			<div
				key={i}
				className='bg-card/60 border border-border/80 rounded p-1.5 text-center flex flex-col items-center shadow-sm backdrop-blur-sm'>
				<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-widest leading-none'>
					{stat.name}
				</span>
				<span className='text-lg font-bold text-foreground leading-none my-1 font-serif'>{stat.score}</span>
				<span className='text-[10px] font-medium text-muted-foreground bg-muted px-1.5 rounded-full'>{stat.mod}</span>
			</div>
		))}
	</div>
);

const TagList = ({ tags }) => (
	<div className='flex flex-wrap gap-1.5 mt-1 mb-3'>
		{tags.map((item, i) => (
			<span
				key={i}
				className='inline-flex items-center px-2 py-0.5 rounded text-[11px] font-semibold bg-muted text-card-foreground border border-border/60 shadow-sm'>
				{toTitleCase(item)}
			</span>
		))}
	</div>
);

const StandardTrait = ({ label, value, index }) => (
	<div
		className={clsx(
			'flex justify-between items-baseline px-3 py-2 border-b border-border/40 last:border-0',
			index % 2 === 0 ? 'bg-card/40' : 'bg-transparent'
		)}>
		<span className='text-[10px] font-bold uppercase tracking-widest text-muted-foreground/90 shrink-0 mr-4'>
			{label}
		</span>
		<span className='text-[13px] font-semibold text-foreground text-right leading-snug break-words'>
			{typeof value === 'string' ? toTitleCase(value) : value}
		</span>
	</div>
);

// --- HELPER: Connection Badge Colors ---
const getRoleStyle = (roleStr) => {
	// FIX: Standardized to generic style for all roles to ensure readability
	return 'bg-muted text-muted-foreground border-border/60';
};

// --- NEW COMPONENT: Type Divider ---
const TypeDivider = ({ label }) => (
	<div className='flex items-center gap-2 my-3'>
		<div className='h-px bg-muted flex-1' />
		<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-widest'>{label}</span>
		<div className='h-px bg-muted flex-1' />
	</div>
);

// --- MAIN COMPONENT ---
export const EntitySidebar = ({ entity, traits, connections }) => {
	const textTraits = traits.filter((t) => t.displayType === 'text');
	const specialTraits = traits.filter((t) => t.displayType !== 'text');

	// Group connections by Type Label
	const groupedConnections = useMemo(() => {
		if (!connections || connections.length === 0) return [];

		// 1. Sort by Type, then Name
		const sorted = [...connections].sort((a, b) => {
			const typeA = a.typeLabel || 'Other';
			const typeB = b.typeLabel || 'Other';
			const compareType = typeA.localeCompare(typeB);
			if (compareType !== 0) return compareType;
			return (a.name || '').localeCompare(b.name || '');
		});

		// 2. Group for rendering
		const groups = [];
		let currentType = null;
		let currentGroup = null;

		sorted.forEach((item) => {
			const type = item.typeLabel || 'Other';
			if (type !== currentType) {
				currentType = type;
				currentGroup = { type, items: [] };
				groups.push(currentGroup);
			}
			currentGroup.items.push(item);
		});

		return groups;
	}, [connections]);

	return (
		<div className='space-y-6 font-sans'>
			{/* 1. Standard Traits Table */}
			{textTraits.length > 0 && (
				<div className='bg-muted/30/50 border border-border/70 rounded-lg overflow-hidden'>
					{/* Header */}
					<div className='px-3 py-2 border-b border-border bg-muted/40 flex items-center gap-2'>
						<Tag size={12} className='text-primary-muted' />
						<h3 className='text-[11px] font-bold text-primary-muted uppercase tracking-widest'>Attributes</h3>
					</div>

					{/* Content */}
					<div className='flex flex-col'>
						{textTraits.map((prop, idx) => (
							<StandardTrait key={prop.key} label={prop.key} value={prop.value} index={idx} />
						))}
					</div>
				</div>
			)}

			{/* 2. Special Visual Blocks */}
			{specialTraits.length > 0 && (
				<div className='space-y-4 px-1'>
					{specialTraits.map((prop) => {
						if (prop.displayType === 'stat-grid') {
							return (
								<div key={prop.key}>
									<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1 flex items-center gap-2 ml-1'>
										<Activity size={10} /> {prop.key}
									</h3>
									<AbilityGrid stats={prop.value} />
								</div>
							);
						}
						if (prop.displayType === 'tags') {
							return (
								<div key={prop.key}>
									<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1 flex items-center gap-2 ml-1'>
										<Shield size={10} /> {prop.key}
									</h3>
									<TagList tags={prop.value} />
								</div>
							);
						}
						return null;
					})}
				</div>
			)}

			{/* 3. Connections (Grouped with Dividers) */}
			{groupedConnections.length > 0 && (
				<div>
					<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-2 px-1'>
						<Network size={10} /> Connections
					</h3>

					{/* 4. Local Graph (NEW) */}
					{connections && connections.length > 0 && entity && (
						<div className='pt-4 border-t border-border/50'>
							<EntityLocalGraph entity={entity} relationships={connections} height='h-70' headerShown={false} />
						</div>
					)}

					<div className='space-y-1'>
						{groupedConnections.map((group, gIdx) => (
							<div key={group.type}>
								<TypeDivider label={group.type} />

								<div className='space-y-2'>
									{group.items.map((rel, i) => (
										<EntityLink
											key={rel.id}
											id={rel.id}
											type={rel.typeLabel}
											inline={true}
											showIcon={false}
											className={clsx(
												'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline',
												'!border-border hover:!border-amber-300 hover:!shadow-sm hover:!bg-card',
												rel.theme.hover
											)}>
											<div className='flex items-center gap-2.5 flex-1 min-w-0'>
												<EntityIcon type={rel.typeLabel} size={14} className='opacity-80 group-hover:opacity-100' />
												<span className='text-sm font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
													{rel.name}
												</span>
											</div>
											<span
												className={clsx(
													'shrink-0 text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ml-2 max-w-[45%] truncate',
													getRoleStyle(rel.role)
												)}>
												{rel.role}
											</span>
										</EntityLink>
									))}
								</div>
							</div>
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\EntitySidebar.jsx ---

--- FILE: features\wiki\components\QuestObjectives.jsx ---
import { useState } from 'react';
import {
	CheckCircle2,
	Circle,
	XCircle,
	Target,
	Calendar,
	ChevronDown,
	ChevronRight,
	CornerDownRight,
} from 'lucide-react';
import { clsx } from 'clsx';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import EntityLink from '@/domain/entity/components/EntityLink';

const QuestObjectiveItem = ({ obj }) => {
	const [isOpen, setIsOpen] = useState(false);

	const isCompleted = obj.status === 'completed';
	const isFailed = obj.status === 'failed';

	const hasUpdate = !!obj.objective_update;
	const hasSession = isCompleted && obj.completed_session_number;
	const hasContent = hasUpdate || (hasSession && obj.completed_session_title);

	const toggle = () => hasContent && setIsOpen(!isOpen);

	return (
		<div
			className={clsx(
				'transition-colors border-b border-border/40 last:border-0',
				isCompleted ? 'bg-emerald-500/10/10' : isFailed ? 'bg-red-500/10/10' : 'hover:bg-muted/30'
			)}>
			{/* --- MAIN ROW --- */}
			<div
				className={clsx(
					'flex items-start gap-3 px-3 py-2 cursor-pointer group',
					hasContent ? 'hover:bg-black/5' : 'cursor-default'
				)}
				onClick={toggle}>
				{/* Status Icon */}
				<div className='mt-1.5 shrink-0'>
					{isCompleted ? (
						<CheckCircle2 size={16} className='text-emerald-600' />
					) : isFailed ? (
						<XCircle size={16} className='text-red-500' />
					) : (
						<Circle size={16} className='text-muted-foreground/40' strokeWidth={2} />
					)}
				</div>

				{/* Text Content */}
				<div className='flex-1 min-w-0 pt-0.5'>
					<div className='flex items-center justify-between gap-2 mb-0.5'>
						{obj.objective_name && (
							<div className='text-[10px] font-bold text-muted-foreground/70 uppercase tracking-wide'>
								{obj.objective_name}
							</div>
						)}

						{/* Session Indicator Badge (Inline) */}
						{hasSession && (
							<div
								className='flex items-center gap-1 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider bg-muted text-muted-foreground border border-border/60'
								title={`Completed in Session ${obj.completed_session_number - 1}`}>
								<Calendar size={10} />
								<span className='hidden sm:inline'>Session</span> {obj.completed_session_number - 1}
							</div>
						)}
					</div>

					<div
						className={clsx(
							'text-[13px] leading-snug font-medium transition-colors',
							isCompleted ? 'text-muted-foreground' : isFailed ? 'text-red-800/80' : 'text-foreground'
						)}>
						<SmartMarkdown components={{ p: 'span' }}>{obj.description}</SmartMarkdown>
					</div>
				</div>

				{/* Toggle Chevron */}
				{hasContent && (
					<button
						className={clsx(
							'shrink-0 text-muted-foreground/70 group-hover:text-foreground transition-colors mt-0.5',
							isOpen && 'text-foreground'
						)}>
						{isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
					</button>
				)}
			</div>

			{/* --- DROPDOWN CONTENT --- */}
			{isOpen && hasContent && (
				<div className='pl-9 pr-3 pb-2 -mt-1 animate-in slide-in-from-top-1 fade-in duration-200'>
					<div className='flex flex-col gap-1.5'>
						{/* Update Text */}
						{hasUpdate && (
							<div className='flex gap-2 items-start'>
								<CornerDownRight size={12} className='shrink-0 mt-1 text-primary opacity-60' />
								<span className='text-xs text-muted-foreground italic leading-relaxed'>
									<SmartMarkdown>{obj.objective_update}</SmartMarkdown>
								</span>
							</div>
						)}
					</div>
				</div>
			)}
		</div>
	);
};

export const QuestObjectives = ({ objectives }) => {
	if (!objectives || objectives.length === 0) return null;

	return (
		<div className='mb-8 not-prose border border-border rounded-lg overflow-hidden bg-muted/30/20'>
			<div className='px-3 py-2 border-b border-border bg-muted/50 flex items-center gap-2'>
				<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-wider flex items-center gap-2 m-0'>
					<Target size={12} className='text-primary' /> Quest Objectives
				</h3>
				<span className='ml-auto text-[9px] font-bold bg-muted/80 px-1.5 py-0.5 rounded text-muted-foreground'>
					{objectives.filter((o) => o.status === 'completed').length} / {objectives.length}
				</span>
			</div>

			<div className='bg-background'>
				{objectives.map((obj, idx) => (
					<QuestObjectiveItem key={obj.id || idx} obj={obj} />
				))}
			</div>
		</div>
	);
};

--- END OF features\wiki\components\QuestObjectives.jsx ---

--- FILE: features\wiki\components\SessionMentions.jsx ---
import { clsx } from 'clsx';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';

const MentionGroup = ({ type, items }) => {
	const config = getEntityConfig(type);
	const Icon = config.icon;

	return (
		<div className='break-inside-avoid mb-4 border border-border rounded-lg overflow-hidden bg-muted/30/30 flex flex-col'>
			{/* Header */}
			<div className='px-3 py-2 border-b border-border bg-muted/50 flex items-center justify-between shrink-0'>
				<div className='flex items-center gap-2'>
					<Icon size={12} className='text-muted-foreground' />
					<h3 className='text-[10px] font-bold text-muted-foreground uppercase tracking-widest m-0'>
						{config.labelPlural}
					</h3>
				</div>
				<span className='text-[9px] font-bold text-muted-foreground bg-muted/60 px-1.5 py-0.5 rounded-full'>
					{items.length}
				</span>
			</div>

			{/* List Container */}
			<div className='p-2'>
				<div className='flex flex-col gap-1'>
					{items.map((item) => (
						<EntityLink
							key={item.id}
							id={item.id}
							type={item.type}
							inline={true}
							showIcon={false}
							className={clsx(
								// Matches CharacterSidebar styling exactly
								'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline',
								'!border-border hover:!border-primary/40 hover:!shadow-sm hover:!bg-card group'
							)}>
							<div className='flex items-center gap-2.5 flex-1 min-w-0'>
								<EntityIcon
									type={item.type}
									size={16}
									className='opacity-80 group-hover:opacity-100 transition-opacity'
								/>
								<span className='text-xs font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
									{item.name}
								</span>
							</div>
						</EntityLink>
					))}
				</div>
			</div>
		</div>
	);
};

export const SessionMentions = ({ mentions }) => {
	if (!mentions || Object.keys(mentions).length === 0) {
		return (
			<div className='p-12 text-center text-muted-foreground italic border border-dashed border-border rounded-lg'>
				No linked entities found in this session.
			</div>
		);
	}

	const order = ['character', 'npc', 'location', 'faction', 'quest', 'encounter'];
	const orderedKeys = order.filter((k) => mentions[k]).concat(Object.keys(mentions).filter((k) => !order.includes(k)));

	return (
		<div className='columns-1 md:columns-2 xl:columns-3 gap-4 animate-in fade-in duration-500'>
			{orderedKeys.map((key) => (
				<MentionGroup key={key} type={key} items={mentions[key]} />
			))}
		</div>
	);
};

--- END OF features\wiki\components\SessionMentions.jsx ---

--- FILE: features\wiki\components\WikiEntryView.jsx ---
import { useEntityViewModel } from '@/features/wiki/useEntityView';
import { EntityHeader } from '@/features/wiki/components/EntityHeader';
import StandardLayout from '@/features/wiki/layouts/StandardLayout';
import SessionLayout from '@/features/wiki/layouts/SessionLayout';
import CharacterLayout from '@/features/wiki/layouts/CharacterLayout'; // Import New Layout

export default function WikiEntityView({ entity }) {
	const viewModel = useEntityViewModel(entity);

	if (!viewModel) return null;

	let LayoutComponent;
	if (viewModel.layoutMode === 'tabs') {
		LayoutComponent = SessionLayout;
	} else if (viewModel.layoutMode === 'character') {
		LayoutComponent = CharacterLayout;
	} else {
		LayoutComponent = StandardLayout;
	}

	return (
		<div className='pb-16 animate-in fade-in duration-300 min-h-full'>
			<EntityHeader data={viewModel.header} />
			<LayoutComponent viewModel={viewModel} />
		</div>
	);
}

--- END OF features\wiki\components\WikiEntryView.jsx ---

--- FILE: features\wiki\components\character\CharacterSidebar.jsx ---
import { Tag, Shield, Gem, Scroll, Save, Eye, Swords, Activity } from 'lucide-react';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { clsx } from 'clsx';

// Helper: Split string by comma and trim
const parseTags = (str) => {
	if (!str) return [];
	if (Array.isArray(str)) return str;
	return String(str)
		.split(',')
		.map((s) => s.trim())
		.filter(Boolean);
};

const SidebarHeader = ({ title, icon: Icon }) => (
	<h4 className='flex items-center gap-2 text-[10px] font-bold uppercase text-muted-foreground tracking-widest mb-3 mt-5 border-b border-border/40 pb-1'>
		{Icon && <Icon size={12} />} {title}
	</h4>
);

const TagPill = ({ text }) => (
	<span className='inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-muted/30 text-muted-foreground border border-border/50'>
		{text}
	</span>
);

const StatRowItem = ({ label, value }) => (
	<div className='flex flex-col items-center justify-center p-2 bg-muted/20 rounded border border-border/30'>
		<span className='text-[9px] font-bold uppercase text-muted-foreground/70 tracking-wider mb-0.5'>{label}</span>
		<span className='text-sm font-bold text-foreground font-serif'>{value}</span>
	</div>
);

const SkillItem = ({ text }) => {
	// split "Acrobatics (+1)" into name and val
	const match = text.match(/^(.*)\s(\([+-]?\d+\))$/);
	const name = match ? match[1] : text;
	const val = match ? match[2] : '';

	return (
		<div className='flex justify-between items-center text-[11px] py-0.5 px-1 border-b border-border/20 last:border-0'>
			<span className='text-muted-foreground'>{name}</span>
			<span className='font-mono text-foreground opacity-80 text-[10px]'>{val}</span>
		</div>
	);
};

const SidebarLink = ({ entity }) => (
	<EntityLink
		id={entity.entity_id}
		type={entity.entity_type}
		inline={true}
		showIcon={false}
		className={clsx(
			'!flex !w-full !items-center !justify-between !p-2 !rounded-lg !border !bg-card/60 !transition-all !cursor-pointer !no-underline !mb-2',
			'!border-border hover:!border-primary/40 hover:!shadow-sm hover:!bg-card'
		)}>
		<div className='flex items-center gap-2.5 flex-1 min-w-0'>
			<EntityIcon type={entity.entity_type} size={16} className='opacity-80 group-hover:opacity-100' />
			<span className='text-xs font-semibold text-card-foreground truncate group-hover:text-foreground transition-colors'>
				{entity.entity_name}
			</span>
		</div>
	</EntityLink>
);

export const CharacterSidebar = ({ attributes, gear, quests }) => {
	const proficiencies = parseTags(attributes.proficiencies || attributes.tools);
	const languages = parseTags(attributes.languages);
	const saves = attributes['saving throw'] || attributes['saves'] || [];
	const saveList = Array.isArray(saves) ? saves : [];

	// Extract special stats manually
	const initiative = attributes.initiative;
	const proficiencyBonus = attributes.proficiency || attributes.proficiency_bonus;
	const skills = parseTags(attributes.skills);
	const senses = parseTags(attributes['additional senses'] || attributes.senses);

	// Filter keys that we handle explicitly
	const ignoredKeys = new Set([
		// Header
		'class',
		'race',
		'level',
		// Stats Bar
		'ability score',
		'stats',
		'saving throw',
		'saves',
		'armor class',
		'ac',
		'hit points',
		'hp',
		'speed',
		'passive_perception',
		'passive',
		// Explicit Sections
		'languages',
		'proficiencies',
		'tools',
		'skills',
		'initiative',
		'proficiency',
		'proficiency_bonus',
		'additional senses',
		'senses',
		// System
		'icon',
		'background_image',
		'is_active',
		'campaign_id',
	]);

	// Get any remaining attributes (Alignment, Faith, etc.)
	const otherAttributes = Object.entries(attributes).filter(([key, val]) => {
		const k = key.toLowerCase();
		if (ignoredKeys.has(k)) return false;
		if (!val || (typeof val === 'object' && !Array.isArray(val))) return false;
		return true;
	});

	return (
		<div className='font-sans'>
			{/* 1. Combat Vitals Row (Initiative / Proficiency) */}
			{(initiative || proficiencyBonus) && (
				<div className='grid grid-cols-2 gap-2 mb-4'>
					{initiative && <StatRowItem label='Initiative' value={initiative} />}
					{proficiencyBonus && <StatRowItem label='Proficiency' value={proficiencyBonus} />}
				</div>
			)}

			{/* 2. Saving Throws */}
			{saveList.length > 0 && (
				<div>
					<SidebarHeader title='Saving Throws' icon={Save} />
					<div className='flex flex-wrap gap-1.5'>
						{saveList.map((save, i) => (
							<TagPill key={i} text={save} />
						))}
					</div>
				</div>
			)}

			{/* 3. Skills (Compact Grid) */}
			{skills.length > 0 && (
				<div>
					<SidebarHeader title='Skills' icon={Activity} />
					<div className='grid grid-cols-2 gap-x-4 gap-y-0.5'>
						{skills.map((skill, i) => (
							<SkillItem key={i} text={skill} />
						))}
					</div>
				</div>
			)}

			{/* 4. Senses */}
			{senses.length > 0 && (
				<div>
					<SidebarHeader title='Senses' icon={Eye} />
					<div className='flex flex-col gap-1'>
						{senses.map((sense, i) => (
							<div key={i} className='text-xs text-muted-foreground border-l-2 border-border pl-2 py-0.5'>
								{sense}
							</div>
						))}
					</div>
				</div>
			)}

			{/* 5. Languages */}
			{languages.length > 0 && (
				<div>
					<SidebarHeader title='Languages' icon={Tag} />
					<div className='flex flex-wrap gap-1.5'>
						{languages.map((lang, i) => (
							<TagPill key={i} text={lang} />
						))}
					</div>
				</div>
			)}

			{/* 6. Dynamic Attributes */}
			{otherAttributes.map(([key, val]) => {
				const tags = parseTags(val);
				return (
					<div key={key}>
						<SidebarHeader title={key.replace(/_/g, ' ')} icon={Swords} />
						<div className='flex flex-wrap gap-1.5'>
							{tags.map((t, i) => (
								<TagPill key={i} text={t} />
							))}
						</div>
					</div>
				);
			})}

			{/* 7. Personal Quests */}
			{quests && quests.length > 0 && (
				<div>
					<SidebarHeader title='Personal Quests' icon={Scroll} />
					<div>
						{quests.map((quest) => (
							<SidebarLink key={quest.entity_id} entity={quest} />
						))}
					</div>
				</div>
			)}

			{/* 8. Signature Gear */}
			{gear && gear.length > 0 && (
				<div>
					<SidebarHeader title='Signature Gear' icon={Gem} />
					<div>
						{gear.map((item) => (
							<SidebarLink key={item.entity_id} entity={item} />
						))}
					</div>
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\character\CharacterSidebar.jsx ---

--- FILE: features\wiki\components\character\CharacterStats.jsx ---
import { Shield, Heart, Wind } from 'lucide-react';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';

const parseStat = (str) => {
	if (!str) return { label: '???', value: '-' };
	const match = str.match(/^([A-Z]{3})\s+(.*)$/);
	if (!match) return { label: str.substring(0, 3), value: str };
	return { label: match[1], value: match[2] };
};

const StatPill = ({ raw }) => {
	const { label, value } = parseStat(raw);
	return (
		<div className='flex flex-col items-center justify-center bg-muted/20 border border-border/50 rounded-md py-1.5 px-3 min-w-[70px]'>
			<span className='text-[9px] font-bold text-muted-foreground uppercase tracking-wider mb-0.5'>{label}</span>
			<span className='text-sm font-bold text-foreground font-serif leading-none'>{value}</span>
		</div>
	);
};

const VitalPill = ({ label, value, icon: Icon, color }) => (
	<div className='flex flex-col items-center justify-center bg-muted/20 border border-border/50 rounded-md py-1.5 px-4 min-w-[80px]'>
		<div className='flex items-center gap-1.5 mb-0.5 opacity-80'>
			<Icon size={10} className={color} />
			<span className='text-[9px] font-bold uppercase text-muted-foreground tracking-wider'>{label}</span>
		</div>
		<span className='text-base font-serif font-bold text-foreground leading-none'>{value || '-'}</span>
	</div>
);

export const CharacterStats = ({ attributes }) => {
	const stats = attributes['ability score'] || attributes['stats'] || [];
	const ac = attributes['armor class'] || attributes['ac'];
	const hp = attributes['hit points'] || attributes['hp'];
	const speed = attributes['speed'];

	return (
		<div>
			<div className='flex flex-wrap items-center justify-center gap-6'>
				{/* 1. Ability Scores */}
				<div className='flex flex-wrap justify-center gap-2'>
					{stats.map((s, i) => (
						<StatPill key={i} raw={s} />
					))}
				</div>

				{/* Vertical Divider (Hidden on small mobile) */}
				<div className='hidden sm:block w-px h-8 bg-border/40' />

				{/* 2. Vitals */}
				<div className='flex flex-wrap justify-center gap-2'>
					<VitalPill label='AC' value={ac} icon={Shield} color='text-emerald-500' />
					<VitalPill label='HP' value={hp} icon={Heart} color='text-red-500' />
					<VitalPill label='Speed' value={speed} icon={Wind} color='text-blue-500' />
				</div>
			</div>
			<SectionDivider />
		</div>
	);
};

--- END OF features\wiki\components\character\CharacterStats.jsx ---

--- FILE: features\wiki\components\character\RelationshipNetwork.jsx ---
import { clsx } from 'clsx';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import EntityLink from '@/domain/entity/components/EntityLink';
import EntityIcon from '@/domain/entity/components/EntityIcon';

const NetworkGroup = ({ type, items }) => {
	if (!items || items.length === 0) return null;

	const config = getEntityConfig(type);
	const Icon = config.icon;

	return (
		<div className='break-inside-avoid mb-6 bg-card/40 border border-border/40 rounded-lg overflow-hidden'>
			{/* Group Header */}
			<div className='px-3 py-2 border-b border-border/40 bg-muted/30 flex items-center justify-between'>
				<div
					className={clsx('flex items-center gap-2 text-xs font-bold uppercase tracking-widest', config.tailwind.text)}>
					<Icon size={14} /> {config.labelPlural}
				</div>
				<span className='text-[9px] font-bold bg-background border border-border/50 px-1.5 py-0.5 rounded text-muted-foreground'>
					{items.length}
				</span>
			</div>

			{/* List of Connections */}
			<div className='p-2 space-y-1.5'>
				{items.map((rel) => (
					<EntityLink
						key={rel.entity_id}
						id={rel.entity_id}
						type={rel.entity_type}
						inline={true}
						showIcon={true}
						className={clsx(
							'!flex !w-full !items-center !justify-between !p-2 !rounded-md !border !bg-card !transition-all !cursor-pointer !no-underline',
							'!border-border hover:!border-primary/50 hover:!shadow-sm hover:!bg-muted/20 group'
						)}>
						{/* Left: Icon + Name */}
						<div className='flex items-center gap-2.5 flex-1 min-w-0'>
							{/* <EntityIcon type={rel.entity_type} size={18} className='opacity-80 group-hover:opacity-100 shrink-0' /> */}
							<span className='text-xs font-bold text-foreground truncate group-hover:text-primary transition-colors'>
								{rel.entity_name}
							</span>
						</div>

						{/* Right: Relationship Label */}
						<span className='shrink-0 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground/70 bg-muted/50 px-1.5 py-0.5 rounded ml-2 max-w-[40%] truncate'>
							{rel.type ? rel.type.replace(/_/g, ' ') : 'Related'}
						</span>
					</EntityLink>
				))}
			</div>
		</div>
	);
};

export const RelationshipNetwork = ({ relationships }) => {
	if (!relationships || relationships.length === 0) {
		return (
			<div className='p-8 text-center text-muted-foreground italic border border-dashed border-border rounded-lg bg-muted/20'>
				No connections recorded.
			</div>
		);
	}

	// 1. Group by Entity Type
	const groups = relationships.reduce((acc, rel) => {
		const type = rel.entity_type || 'default';
		if (!acc[type]) acc[type] = [];
		acc[type].push(rel);
		return acc;
	}, {});

	// 2. Define Display Order (Narrative Priority)
	const order = ['character', 'npc', 'faction', 'location', 'quest', 'encounter', 'item'];
	const orderedKeys = order.filter((k) => groups[k]).concat(Object.keys(groups).filter((k) => !order.includes(k)));

	// 3. Render Masonry Layout
	return (
		<div className='columns-1 md:columns-2 xl:columns-3 gap-6 animate-in fade-in duration-500'>
			{orderedKeys.map((type) => (
				<NetworkGroup key={type} type={type} items={groups[type]} />
			))}
		</div>
	);
};

--- END OF features\wiki\components\character\RelationshipNetwork.jsx ---

--- FILE: features\wiki\components\landing\EntityGridCard.jsx ---
import { Link } from 'react-router-dom';
import { clsx } from 'clsx';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import { getStatusInfo } from '@/domain/entity/utils/statusUtils';

export const EntityGridCard = ({ entity, config }) => {
	const attributes = parseAttributes(entity.attributes);
	const imageUrl = resolveImageUrl(attributes, 'background') || resolveImageUrl(attributes, 'icon');
	const status = getStatusInfo(entity);

	const isActorOrQuest = ['npc', 'character', 'faction', 'quest'].includes(entity.type);
	const hasMeaningfulStatus = status.isDead || status.isFailed || status.rank === 1 || status.rank === 3;
	const showStatus = isActorOrQuest && hasMeaningfulStatus;

	let statusBorderClass = 'border-l-transparent';
	if (showStatus) {
		if (status.isDead || status.isFailed) statusBorderClass = 'border-l-red-500';
		else if (status.rank === 3) statusBorderClass = 'border-l-red-600';
		else if (status.rank === 1) statusBorderClass = 'border-l-emerald-500';
	}

	return (
		<Link
			to={`/wiki/${entity.type}/${entity.id}`}
			className={clsx(
				'group flex bg-background border border-border rounded-lg overflow-hidden transition-all duration-200',
				entity.footerLabel ? 'h-28' : 'h-24',
				'hover:shadow-md hover:bg-muted/10',
				showStatus ? `border-l-[3px] ${statusBorderClass}` : 'border-l'
			)}>
			{/* Left: Image */}
			<div className='w-24 shrink-0 relative bg-muted/30 border-r border-border/50'>
				{imageUrl ? (
					<>
						<img
							src={imageUrl}
							alt={entity.name}
							className='w-full h-full object-cover transition-transform duration-700 group-hover:scale-105'
						/>
						<div className='absolute inset-0 bg-black/5 group-hover:bg-transparent transition-colors' />
					</>
				) : (
					<div className='w-full h-full flex items-center justify-center bg-muted'>
						<config.icon size={28} className='text-muted-foreground/70' strokeWidth={1.5} />
					</div>
				)}
			</div>

			{/* Right: Content */}
			<div
				className={clsx(
					'flex-1 px-3 py-2 flex flex-col min-w-0',
					// FIX: If footer exists, space between. If not, center vertically.
					entity.footerLabel ? 'justify-between' : 'justify-center'
				)}>
				<div>
					<div className='flex items-center justify-between gap-2'>
						<h3 className='font-serif font-bold text-sm text-foreground group-hover:text-primary transition-colors truncate'>
							{entity.name}
						</h3>
					</div>

					<div className='text-[11px] text-muted-foreground/80 leading-snug mt-1 line-clamp-3'>
						{entity.description || <span className='opacity-50 italic'>No details available.</span>}
					</div>
				</div>

				{entity.footerLabel && (
					<div className='text-[10px] font-bold uppercase tracking-wider text-muted-foreground/60 mt-auto pt-2 truncate border-t border-border/40'>
						{entity.footerLabel}
					</div>
				)}
			</div>
		</Link>
	);
};

--- END OF features\wiki\components\landing\EntityGridCard.jsx ---

--- FILE: features\wiki\components\landing\EntityPosterCard.jsx ---
import { Link } from 'react-router-dom';
import { resolveImageUrl, parseAttributes } from '@/shared/utils/imageUtils';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser'; // Added missing import

export const EntityPosterCard = ({ entity, config }) => {
	const attributes = parseAttributes(entity.attributes);

	const imageUrl =
		resolveImageUrl(attributes, ['portrait', 'image']) ||
		resolveImageUrl(attributes, 'background') ||
		resolveImageUrl(attributes, 'icon');

	// Fallback Description Logic
	const description =
		entity.description ||
		getAttributeValue(attributes, ['summary', 'narrative', 'background', 'bio']) ||
		'No description available.';

	// Smart Subtitle for Characters
	const role = getAttributeValue(attributes, ['class', 'role', 'occupation', 'type']);
	const level = getAttributeValue(attributes, ['level']);

	let subtitle = role || entity.type;
	if (level && role) {
		subtitle = `Lvl ${level} ${role}`;
	} else if (level) {
		subtitle = `Level ${level}`;
	}

	// FIX: Changed outer wrapper from <Link> to <div> to prevent <a> nesting errors
	return (
		<div className='group relative flex flex-col bg-card border border-border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 h-[380px]'>
			{/* FIX: Stretched Link - This makes the whole card clickable without nesting tags */}
			<Link
				to={`/wiki/${entity.type}/${entity.id}`}
				className='absolute inset-0 z-0'
				aria-label={`View ${entity.name}`}
			/>

			{/* 1. Image Area */}
			{/* Added pointer-events-none so clicks fall through to the link, or you can leave it interactive if needed */}
			<div className='relative h-[60%] bg-muted overflow-hidden'>
				{imageUrl ? (
					<>
						<img
							src={imageUrl}
							alt={entity.name}
							className='w-full h-full object-cover object-top transition-transform duration-700 group-hover:scale-105'
							loading='lazy'
						/>
						<div className='absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-40 transition-opacity duration-300' />
					</>
				) : (
					<div className='w-full h-full flex flex-col items-center justify-center bg-muted/50 p-6 text-center'>
						<config.icon size={48} className='text-muted-foreground/30 mb-2' strokeWidth={1} />
						<span className='text-xs font-serif text-muted-foreground/50 uppercase tracking-widest'>No Image</span>
					</div>
				)}

				{/* Floating Badge */}
				<div className='absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300'>
					<EntityBadge type={entity.type} size='sm' variant='solid' className='shadow-lg' />
				</div>
			</div>

			{/* 2. Content Area */}
			{/* Relative z-10 places text above the stretched link if you want text selection, 
                but usually for a card link we want the click to work everywhere. 
                Using pointer-events-none on the container allows clicks to pass to the Link below. */}
			<div className='flex-1 p-4 flex flex-col bg-card relative z-10 border-t border-border/50 pointer-events-none'>
				<div className='mb-2'>
					<h3 className='font-serif font-bold text-lg text-foreground leading-tight group-hover:text-primary transition-colors line-clamp-1'>
						{entity.name}
					</h3>
					<p className='text-[10px] font-bold text-muted-foreground uppercase tracking-widest truncate mt-1'>
						{subtitle}
					</p>
				</div>

				<div className='text-xs text-muted-foreground/80 leading-relaxed line-clamp-4 overflow-hidden text-ellipsis'>
					{/* SmartMarkdown can now safely render links because we are inside a div, not an <a> */}
					<SmartMarkdown components={{ p: 'span' }}>{description}</SmartMarkdown>
				</div>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\landing\EntityPosterCard.jsx ---

--- FILE: features\wiki\components\landing\EntityTableGroup.jsx ---
import { Link } from 'react-router-dom';
import { clsx } from 'clsx';
import { ArrowRight, CornerDownRight, Activity } from 'lucide-react';
import { getStatusInfo } from '@/domain/entity/utils/statusUtils';
import EntityBadge from '@/domain/entity/components/EntityBadge';
import { parseAttributes } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';

/**
 * CONFIGURATION: Table Definitions
 * Defines columns, widths, and RENDER logic in one place.
 */
const TABLE_DEFINITIONS = {
	session: [
		{
			header: 'Session Title',
			width: '45%',
			render: (e, attr) => (
				<Link
					to={`/wiki/session/${e.id}`}
					className='font-serif font-bold text-foreground hover:text-primary transition-colors text-sm'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Date',
			width: '20%',
			render: (e, attr) => <span className='text-xs text-muted-foreground'>{attr.session_date || '-'}</span>,
		},
	],
	quest: [
		{
			header: 'Quest',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/quest/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Status',
			width: '20%',
			render: (e) => {
				const s = getStatusInfo(e);
				if (!s.display) return <span className='text-muted-foreground'>-</span>;
				return (
					<span
						className={clsx(
							'px-2 py-0.5 rounded text-[10px] font-bold uppercase',
							s.isCompleted
								? 'bg-emerald-500/10 text-emerald-600'
								: s.isFailed
								? 'bg-red-500/10 text-red-600'
								: 'bg-amber-500/10 text-amber-600'
						)}>
						{s.display}
					</span>
				);
			},
		},
		{
			header: 'Priority',
			width: '20%',
			render: (e) => <span className='text-xs font-semibold text-muted-foreground'>{e.meta.priority || '-'}</span>,
		},
	],
	location: [
		{
			header: 'Location',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/location/${e.id}`}
					className='font-serif font-bold text-sm text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Type',
			width: '30%',
			hiddenOnMobile: true,
			render: (e, attr) => <EntityBadge type='location' label={attr.type} variant='subtle' />,
		},
	],
	npc: [
		{
			header: 'Name',
			width: '40%',
			render: (e) => (
				<Link
					to={`/wiki/npc/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Affinity',
			width: '20%',
			render: (e) => {
				const s = getStatusInfo(e);
				if (!s.display) return <span className='text-muted-foreground'>-</span>;
				return (
					<span
						className={clsx(
							'px-2 py-0.5 rounded text-[10px] font-bold uppercase',
							s.rank === 1
								? 'bg-emerald-500/10 text-emerald-600'
								: s.rank === 3
								? 'bg-red-500/10 text-red-600'
								: 'bg-muted text-muted-foreground'
						)}>
						{s.display}
					</span>
				);
			},
		},
		{
			header: 'Role',
			width: '40%',
			hiddenOnMobile: true,
			render: (e, attr) => (
				<span className='text-sm text-muted-foreground'>
					{getAttributeValue(attr, ['role', 'class', 'occupation']) || '-'}
				</span>
			),
		},
	],
	item: [
		// <--- ADDED
		{
			header: 'Item Name',
			width: '45%',
			render: (e) => (
				<Link
					to={`/wiki/item/${e.id}`}
					className='font-serif text-sm font-bold text-foreground hover:text-primary transition-colors'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Rarity',
			width: '25%',
			render: (e, attr) => {
				const rarity = getAttributeValue(attr, ['rarity']) || '-';
				return <span className='text-xs font-medium text-muted-foreground capitalize'>{rarity}</span>;
			},
		},
		{
			header: 'Type',
			width: '30%',
			hiddenOnMobile: true,
			render: (e, attr) => {
				const type = getAttributeValue(attr, ['type', 'item_type']) || 'Item';
				return <EntityBadge type='item' label={type} variant='subtle' size='sm' />;
			},
		},
	],
	// Fallback for others
	default: [
		{
			header: 'Name',
			width: '60%',
			render: (e) => (
				<Link to={`/wiki/${e.type}/${e.id}`} className='font-serif font-bold text-sm text-foreground'>
					{e.name}
				</Link>
			),
		},
		{
			header: 'Type',
			width: '40%',
			render: (e) => <EntityBadge type={e.type} variant='outline' size='sm' />,
		},
	],
};

const getColumns = (type) => TABLE_DEFINITIONS[type] || TABLE_DEFINITIONS[type === 'faction' ? 'npc' : 'default'];

export const EntityTableGroup = ({ title, description, parentTitle, link, items }) => {
	if (!items || items.length === 0) return null;

	const type = items[0].type;
	const columns = getColumns(type);

	return (
		<div className='mb-10 animate-in fade-in duration-500'>
			{/* Header */}
			<div className='mb-3'>
				<div className='flex items-center gap-2 border-b border-border/60 pb-2'>
					{parentTitle && (
						<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground/80 uppercase tracking-widest'>
							{parentTitle}
							<CornerDownRight size={10} className='translate-y-px text-muted-foreground' />
						</div>
					)}
					<h2 className='text-lg font-bold font-serif text-foreground flex items-center gap-2'>
						{title}
						{link && (
							<Link to={link} className='text-muted-foreground/50 hover:text-primary transition-colors'>
								<ArrowRight size={14} />
							</Link>
						)}
					</h2>
					<span className='text-[10px] font-bold bg-muted px-2 py-0.5 rounded-full text-muted-foreground ml-auto'>
						{items.length}
					</span>
				</div>
				{description && (
					<div className='mt-2 text-sm text-muted-foreground/80 leading-relaxed pl-2 border-l-2 border-primary/20'>
						<SmartMarkdown>{description.substring(0, 300) + '...'}</SmartMarkdown>
					</div>
				)}
			</div>

			{/* The Table */}
			<div className='border border-border rounded-lg overflow-hidden shadow-sm'>
				<table className='w-full text-left border-collapse'>
					<thead className='bg-muted/50 text-[10px] uppercase font-bold text-muted-foreground tracking-wider'>
						<tr>
							{columns.map((col, i) => (
								<th
									key={i}
									className={clsx(
										'px-4 py-2.5 font-semibold',
										col.hiddenOnMobile && 'hidden md:table-cell',
										col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'
									)}
									style={{ width: col.width }}>
									{col.header}
								</th>
							))}
						</tr>
					</thead>
					<tbody className='divide-y divide-border/40'>
						{items.map((entity) => {
							const attributes = parseAttributes(entity.attributes);
							return (
								<tr key={entity.id} className='group hover:bg-muted/30 transition-colors'>
									{columns.map((col, i) => (
										<td
											key={i}
											className={clsx(
												'px-4 py-2.5',
												col.hiddenOnMobile && 'hidden md:table-cell',
												col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'
											)}>
											{col.render(entity, attributes)}
										</td>
									))}
								</tr>
							);
						})}
					</tbody>
				</table>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\landing\EntityTableGroup.jsx ---

--- FILE: features\wiki\components\landing\Swimlane.jsx ---
import { useState } from 'react';
import { Link } from 'react-router-dom';
import { ArrowRight, CornerDownRight, Users, MapPin, Scroll, Swords, Hash, ChevronDown, ChevronUp } from 'lucide-react';
import { EntityGridCard } from './EntityGridCard';
import { EntityPosterCard } from './EntityPosterCard';
import SmartMarkdown from '@/features/smart-text/SmartMarkdown';
import { SectionDivider } from '@/shared/components/ui/SectionDivider';
import { HighlightBadge } from '@/shared/components/ui/HighlightBadge';
import { clsx } from 'clsx';

// --- SUB-COMPONENT: ARC HERO ---
const ArcHero = ({ title, description, type, order, stats, isSessionGroup }) => {
	const [isExpanded, setIsExpanded] = useState(false);
	const formattedOrder = order && order < 999 ? `Arc ${String(order).padStart(2, '0')}` : null;

	// LOGIC:
	// 1. If it's a Session Group, NEVER truncate (always show full narrative context).
	// 2. If it's NOT a Session Group (e.g. Locations folder), check if > 300 chars.
	const shouldTruncate = !isSessionGroup && description && description.length > 300;

	return (
		<div className='flex flex-col gap-3 mb-8 items-center'>
			{/* 1. Arc Number / Arc Type */}
			<div className='flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-muted-foreground/60'>
				{formattedOrder && (
					<span className='flex items-center gap-1'>
						<Hash size={10} />
						{formattedOrder}
					</span>
				)}
				{formattedOrder && type && <span></span>}
				{type && <span className='text-primary/80'>{type}</span>}
			</div>

			{/* 2. Arc Name */}
			<h2 className='text-3xl md:text-4xl font-serif font-bold text-foreground text-center max-w-4xl'>{title}</h2>

			{/* 3. Arc Description */}
			<div className='max-w-3xl text-center mx-auto'>
				<div
					className={clsx(
						'text-sm text-muted-foreground leading-relaxed',
						// Only apply line-clamp if we are allowed to truncate and haven't expanded yet
						shouldTruncate && !isExpanded ? 'line-clamp-3 overflow-hidden' : ''
					)}>
					<SmartMarkdown components={{ p: 'span' }}>{description || 'No description available.'}</SmartMarkdown>
				</div>

				{/* Toggle Button (Only shows for non-sessions with long text) */}
				{shouldTruncate && (
					<button
						onClick={() => setIsExpanded(!isExpanded)}
						className='inline-flex items-center gap-1 mt-2 text-[10px] font-bold uppercase tracking-widest text-primary/80 hover:text-primary transition-colors'>
						{isExpanded ? (
							<>
								Read Less <ChevronUp size={12} />
							</>
						) : (
							<>
								Read More <ChevronDown size={12} />
							</>
						)}
					</button>
				)}
			</div>

			{/* 4. Arc Highlights */}
			{stats && (stats.npcs > 0 || stats.locations > 0 || stats.quests > 0 || stats.encounters > 0) && (
				<div className='flex flex-wrap justify-center gap-4 mt-2'>
					<HighlightBadge icon={Users} count={stats.npcs} label='NPCs' />
					<HighlightBadge icon={MapPin} count={stats.locations} label='Locations' />
					<HighlightBadge icon={Scroll} count={stats.quests} label='Quests' />
					<HighlightBadge icon={Swords} count={stats.encounters} label='Encounters' />
				</div>
			)}
		</div>
	);
};

// --- SUB-COMPONENT: STANDARD HEADER ---
const StandardHeader = ({ title, parentTitle, link, count }) => (
	<div className='mb-4'>
		<div className='flex items-center gap-2 border-b border-border/60 pb-2'>
			{parentTitle && (
				<div className='flex items-center gap-1 text-[10px] font-bold text-muted-foreground/80 uppercase tracking-widest'>
					{parentTitle}
					<CornerDownRight size={10} className='translate-y-px text-muted-foreground' />
				</div>
			)}

			<h2 className='text-lg font-bold font-serif text-foreground flex items-center gap-2'>
				{title || 'General'}
				{link && (
					<Link
						to={link}
						className='text-muted-foreground/50 hover:text-primary transition-colors'
						title={`View ${title}`}>
						<ArrowRight size={14} />
					</Link>
				)}
			</h2>

			<span className='text-[10px] font-bold bg-muted px-2 py-0.5 rounded-full text-muted-foreground ml-auto'>
				{count}
			</span>
		</div>
	</div>
);

// --- MAIN COMPONENT ---
export const Swimlane = ({ title, description, items, config, context, type, stats, order, parentTitle, link }) => {
	if (!items || items.length === 0) return null;

	const visualTypes = ['character'];
	const usePoster = items.length > 0 && visualTypes.includes(items[0].type);

	const isArc = !!description || !!type;

	// Determine if this is a Session Group (e.g. Narrative Arc) vs a Category Group (e.g. Locations)
	const isSessionGroup = items[0].type === 'session';

	return (
		<div className='animate-in fade-in slide-in-from-bottom-3 duration-500'>
			{/* HEADER SECTION */}
			{isArc ? (
				<ArcHero
					title={title}
					description={description} // Pass full description
					type={type}
					order={order}
					stats={stats}
					isSessionGroup={isSessionGroup} // Pass flag to control truncation
				/>
			) : (
				<StandardHeader title={title} parentTitle={parentTitle} link={link} count={items.length} />
			)}

			{/* CONTENT SECTION */}
			<div className='max-w-7xl mx-auto pb-4'>
				<div className='flex flex-wrap justify-center gap-4'>
					{items.map((entity) => (
						<div
							key={entity.id}
							className={clsx(
								'w-full',
								// Adjust width: Posters are narrower but taller, Grid cards are wider
								usePoster ? 'sm:w-[240px]' : 'sm:w-[320px]',
								'grow-0 shrink-0'
							)}>
							{usePoster ? (
								<EntityPosterCard entity={entity} config={config} />
							) : (
								<EntityGridCard entity={entity} config={config} context={context} />
							)}
						</div>
					))}
				</div>
			</div>

			{/* SEPARATOR */}
			{isArc && <SectionDivider />}
		</div>
	);
};

--- END OF features\wiki\components\landing\Swimlane.jsx ---

--- FILE: features\wiki\components\navigation\SidebarEmptyState.jsx ---
import { BookOpen } from 'lucide-react';
import EmptyState from '@/shared/components/ui/EmptyState'; // Adjust path

export const SidebarEmptyState = ({ label }) => {
	// Remove 's' from end for singular usage if needed, or just use as is
	const singular = label.endsWith('s') ? label.slice(0, -1) : label;

	return (
		<EmptyState
			icon={BookOpen}
			title={`No ${label} Yet`}
			description={`Create your first ${singular.toLowerCase()} to get started.`}
			className='py-8'
		/>
	);
};

--- END OF features\wiki\components\navigation\SidebarEmptyState.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebar.jsx ---
import { useState } from 'react';
import { clsx } from 'clsx';
import { PanelLeftClose, PanelLeftOpen } from 'lucide-react';
import { WikiSidebarHeader } from './WikiSidebarHeader';
import { WikiSidebarList } from './WikiSidebarList';

export const WikiSidebar = ({ navigation, className }) => {
	const [mobileOpen, setMobileOpen] = useState(false);
	const [desktopCollapsed, setDesktopCollapsed] = useState(false);

	return (
		<>
			{/* COLLAPSED STATE (Slim Bar) */}
			{desktopCollapsed && (
				<div className='hidden lg:flex flex-col h-full border-l border-border bg-muted/50 w-10 shrink-0 z-30 transition-all duration-300 lg:order-2 items-center'>
					<div className='h-14 w-full flex items-center justify-center border-b border-border/50'>
						<button
							onClick={(e) => {
								e.stopPropagation();
								setDesktopCollapsed(false);
							}}
							className='p-1.5 text-muted-foreground hover:text-primary hover:bg-background rounded-md transition-colors'
							title='Expand Sidebar'>
							<PanelLeftClose size={18} />
						</button>
					</div>
				</div>
			)}

			{/* FULL SIDEBAR */}
			<div
				className={clsx(
					'flex flex-col bg-muted border-b border-border',
					'sticky top-0 w-full z-30', // Mobile
					'lg:static lg:border-b-0 lg:h-full lg:transition-all lg:duration-300', // Desktop
					desktopCollapsed
						? 'lg:w-0 lg:border-l-0 lg:overflow-hidden opacity-0 lg:opacity-100'
						: 'lg:w-72 lg:border-l lg:border-border',
					className
				)}>
				<WikiSidebarHeader
					config={navigation.config}
					search={navigation.search}
					onSearchChange={navigation.setSearch}
					onToggle={() => setMobileOpen(!mobileOpen)}
					isOpen={mobileOpen}
					renderDesktopToggle={() => (
						<button
							onClick={(e) => {
								// FIX: Stop propagation to prevent header click logic
								e.stopPropagation();
								setDesktopCollapsed(true);
							}}
							className='text-muted-foreground hover:text-primary transition-colors p-0.5 rounded'
							title='Collapse Sidebar'>
							<PanelLeftOpen size={18} />
						</button>
					)}
				/>

				{/* Content Wrapper */}
				<div
					className={clsx(
						'grid transition-[grid-template-rows] duration-300 ease-[cubic-bezier(0.32,0.72,0,1)]',
						'lg:flex lg:flex-col lg:flex-1 lg:min-h-0',
						mobileOpen ? 'grid-rows-[1fr] border-b border-border shadow-xl' : 'grid-rows-[0fr]'
					)}>
					<div className={clsx('overflow-hidden', 'lg:flex lg:flex-col lg:flex-1 lg:h-auto')}>
						<div
							className={clsx(
								'lg:flex-1 lg:min-h-0 lg:overflow-y-auto custom-scrollbar',
								mobileOpen && 'max-h-[70dvh] overflow-y-auto custom-scrollbar'
							)}>
							<WikiSidebarList
								groups={navigation.groups}
								isLoading={navigation.isLoading}
								hasItems={navigation.hasItems}
								config={navigation.config}
								onItemClick={() => setMobileOpen(false)}
							/>
						</div>
					</div>
				</div>

				{/* Mobile Backdrop */}
				<div
					className={clsx(
						'fixed inset-0 top-[110px] bg-black/40 z-[-1] lg:hidden backdrop-blur-[1px] transition-opacity duration-300',
						mobileOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'
					)}
					onClick={() => setMobileOpen(false)}
					style={{ touchAction: 'none' }}
				/>
			</div>
		</>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebar.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebarHeader.jsx ---
import { Search, ChevronDown, ChevronUp } from 'lucide-react';
import { clsx } from 'clsx';

export const WikiSidebarHeader = ({ config, search, onSearchChange, onToggle, isOpen, renderDesktopToggle }) => {
	const { Icon, label, textClass } = config;

	return (
		<div className='p-3 lg:p-4 bg-muted border-b border-border/50'>
			{/* Title Row */}
			<div
				className={clsx(
					'flex items-center justify-between h-8 select-none',
					// FIX: Pointer cursor only on mobile. Default on desktop to indicate non-clickable.
					'cursor-pointer lg:cursor-default'
				)}
				onClick={(e) => {
					// FIX: Only allow toggle on mobile (width < 1024px)
					if (window.innerWidth < 1024) {
						onToggle();
					}
				}}>
				<div className='flex items-center gap-3 min-w-0 w-full'>
					{Icon && <Icon size={18} className={clsx(textClass, 'shrink-0')} />}
					<h1 className='text-sm font-serif font-bold text-foreground capitalize tracking-wide truncate'>{label}</h1>
					{/* Desktop Toggle Button */}
					{renderDesktopToggle && (
						<div
							className='hidden lg:block shrink-0 ml-auto'
							// FIX: Stop propagation to prevent any parent click handlers
							onClick={(e) => e.stopPropagation()}>
							{renderDesktopToggle()}
						</div>
					)}
				</div>

				{/* Mobile Toggle Button */}
				<button
					className='lg:hidden text-muted-foreground hover:text-foreground active:bg-black/10 p-2 -mr-2 rounded-md transition-colors'
					aria-label={isOpen ? 'Collapse' : 'Expand'}>
					{isOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
				</button>
			</div>

			{/* Search Bar */}
			<div className={clsx('mt-3 relative', !isOpen && 'hidden lg:block')}>
				<Search className='absolute left-3 top-2.5 text-muted-foreground/70' size={14} />
				<input
					type='text'
					placeholder='Filter list...'
					value={search}
					onChange={(e) => onSearchChange(e.target.value)}
					onClick={(e) => e.stopPropagation()}
					className='w-full bg-background border border-border rounded-md pl-9 pr-3 py-2 text-base lg:text-xs focus:ring-1 focus:ring-primary/50 focus:border-primary outline-none transition-shadow shadow-sm'
				/>
			</div>
		</div>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebarHeader.jsx ---

--- FILE: features\wiki\components\navigation\WikiSidebarList.jsx ---
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { SidebarEmptyState } from './SidebarEmptyState';
import { CollapsibleGroup } from './sidebar/CollapsibleGroup';
import { EntityListItem } from './sidebar/EntityListItem';
import { SidebarTreeItem } from './sidebar/SidebarTreeItem';

export const WikiSidebarList = ({ groups, isLoading, hasItems, config, onItemClick }) => {
	if (isLoading) {
		return (
			<div className='p-8 flex justify-center'>
				<LoadingSpinner size='sm' text='Loading...' />
			</div>
		);
	}

	if (!hasItems) {
		return <SidebarEmptyState label={config.label} />;
	}

	const totalItems = groups.reduce((acc, g) => acc + g.items.length, 0);
	if (totalItems === 0) {
		return <div className='p-6 text-center text-xs text-muted-foreground/70 italic'>No matches found.</div>;
	}

	const isGrouped = !groups[0].isTree && (groups.length > 1 || (groups.length === 1 && groups[0].title !== null));

	return (
		// FIX: Removed 'pb-10'. The parent flex container handles the scroll bounds now.
		// Added 'pb-2' just for a tiny bit of visual breathing room at the very end.
		<div className='bg-muted py-1 pb-2'>
			{/* MODE 1: TREE (Recursive) */}
			{groups[0].isTree ? (
				<div className='px-1 space-y-0.5'>
					{groups[0].items.map((item) => (
						<SidebarTreeItem key={item.id} item={item} onItemClick={onItemClick} />
					))}
				</div>
			) : /* MODE 2: GROUPED (Collapsible Categories) */
			isGrouped ? (
				<div className='space-y-1'>
					{groups.map((group) => (
						<CollapsibleGroup key={group.id} group={group} onItemClick={onItemClick} />
					))}
				</div>
			) : (
				/* MODE 3: FLAT LIST */
				<div className='px-2 space-y-0.5'>
					{groups[0].items.map((item) => {
						const showStatus = ['npc', 'faction', 'quest'].includes(item.type);
						return <EntityListItem key={item.id} item={item} showStatus={showStatus} onItemClick={onItemClick} />;
					})}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\WikiSidebarList.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\CollapsibleGroup.jsx ---
import { useState } from 'react';
import { ChevronRight, ChevronDown } from 'lucide-react';
import { EntityListItem } from './EntityListItem';

export const CollapsibleGroup = ({ group, onItemClick }) => {
	const [isOpen, setIsOpen] = useState(true);

	// Determine if we should show status icons
	const showStatus = group.items.some((item) => ['npc', 'faction', 'quest'].includes(item.type));

	return (
		<div className='select-none'>
			{/* Group Header - Collapsible */}
			<button
				onClick={() => setIsOpen(!isOpen)}
				className='w-full flex items-center gap-1.5 px-2 py-1 text-[11px] font-semibold uppercase tracking-wider text-muted-foreground hover:text-foreground/80 hover:bg-black/5 transition-colors'>
				{isOpen ? <ChevronDown size={12} /> : <ChevronRight size={12} />}
				<span className='truncate'>{group.title}</span>
				<span className='ml-auto text-[10px] font-normal text-muted-foreground/70'>{group.items.length}</span>
			</button>

			{/* Items */}
			{isOpen && (
				<div className='space-y-0.5 pb-1'>
					{group.items.map((item) => (
						<EntityListItem key={item.id} item={item} showStatus={showStatus} onItemClick={onItemClick} />
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\sidebar\CollapsibleGroup.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\EntityListItem.jsx ---
import { NavLink } from 'react-router-dom';
import { clsx } from 'clsx';
import { StatusIcon } from './StatusIcon';
import { PriorityIcon } from './PriorityIcon';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { resolveEntityIcon } from '@/domain/entity/config/entityIcons'; // Import Central Config

export const EntityListItem = ({ item, showStatus, onItemClick }) => {
	const isQuest = item.type === 'quest';
	const hasPriority = isQuest && item.meta.priority;

	const iconUrl = resolveImageUrl(item.attributes, 'icon');
	const hasCustomIcon = !!iconUrl;

	// Use Centralized Resolver
	const ResolvedIcon = resolveEntityIcon({ type: item.type, attributes: item.attributes });

	// Determine if we show the icon.
	const shouldShowIcon = hasCustomIcon || !['quest', 'faction'].includes(item.type);

	return (
		<NavLink
			to={item.path}
			onClick={onItemClick}
			className={({ isActive }) =>
				clsx(
					'group flex items-center w-full text-left pl-6 pr-2 py-1 text-[13px] transition-colors',
					// FIX: Replaced 'bg-accent/10' with 'bg-primary/10' and text color for visibility
					isActive
						? 'bg-primary/10 text-primary font-bold'
						: 'text-foreground/80 hover:bg-black/5 hover:text-foreground'
				)
			}>
			{shouldShowIcon && (
				<span
					className={clsx(
						'shrink-0 flex items-center justify-center mr-2',
						!hasCustomIcon && 'opacity-70 text-muted-foreground',
						// Ensure icon inherits color when active
						hasCustomIcon ? '' : 'group-[.active]:text-primary'
					)}>
					{hasCustomIcon ? (
						<EntityIcon type={item.type} customIconUrl={iconUrl} size={16} className='rounded-full object-cover' />
					) : (
						<ResolvedIcon size={14} />
					)}
				</span>
			)}

			{showStatus && (
				<span
					className={clsx(
						'flex-shrink-0 flex items-center justify-center opacity-70',
						hasPriority ? 'mr-1' : 'mr-2',
						!shouldShowIcon && 'ml-[-2px]'
					)}>
					<StatusIcon entity={item} />
				</span>
			)}

			{hasPriority && (
				<span className='mr-2 flex-shrink-0 flex items-center justify-center opacity-90'>
					<PriorityIcon priority={item.meta.priority} />
				</span>
			)}

			<span className='truncate flex-1'>{item.name}</span>
		</NavLink>
	);
};

--- END OF features\wiki\components\navigation\sidebar\EntityListItem.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\PriorityIcon.jsx ---
import { ChevronUp, ChevronsUp, ChevronsDown, Minus, AlertCircle } from 'lucide-react';

export const PriorityIcon = ({ priority }) => {
	if (!priority) return null;
	const p = priority.toLowerCase();

	// Critical
	if (p.includes('critical')) {
		return <ChevronsUp size={14} className='text-orange-600' strokeWidth={3} />;
	}

	// High / Urgent
	if (p.includes('high')) {
		return <ChevronUp size={14} className='text-orange-600' strokeWidth={3} />;
	}

	// Low
	if (p.includes('low')) {
		return <ChevronsDown size={14} className='text-slate-400' strokeWidth={3} />;
	}

	// Medium / Normal
	if (p.includes('medium') || p.includes('normal')) {
		return <Minus size={14} className='text-blue-400' strokeWidth={3} />;
	}

	return null;
};

--- END OF features\wiki\components\navigation\sidebar\PriorityIcon.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\SidebarTreeItem.jsx ---
import { useState } from 'react';
import { NavLink } from 'react-router-dom';
import { ChevronRight, ChevronDown } from 'lucide-react';
import { clsx } from 'clsx';
import EntityIcon from '@/domain/entity/components/EntityIcon';
import { StatusIcon } from './StatusIcon';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { resolveEntityIcon } from '@/domain/entity/config/entityIcons'; // Import

export const SidebarTreeItem = ({ item, onItemClick }) => {
	const [isExpanded, setIsExpanded] = useState(true);
	const hasChildren = item.children && item.children.length > 0;
	const showStatus = ['npc', 'faction', 'quest'].includes(item.type);

	const iconUrl = resolveImageUrl(item.attributes, 'icon');
	const hasCustomIcon = !!iconUrl;

	// Use centralized resolver
	const ResolvedIcon = resolveEntityIcon({ type: item.type, attributes: item.attributes });

	return (
		<div className='select-none font-sans'>
			<div className='flex items-center w-full group py-0.5 hover:bg-black/5 rounded-sm transition-colors'>
				<button
					onClick={(e) => {
						e.preventDefault();
						e.stopPropagation();
						if (hasChildren) setIsExpanded(!isExpanded);
					}}
					className={clsx(
						'w-5 h-6 flex items-center justify-center shrink-0 text-muted-foreground/70 hover:text-foreground transition-colors cursor-pointer',
						!hasChildren && 'invisible pointer-events-none'
					)}>
					{isExpanded ? <ChevronDown size={10} /> : <ChevronRight size={10} />}
				</button>

				<NavLink
					to={item.path}
					onClick={onItemClick}
					className={({ isActive }) =>
						clsx(
							'flex-1 flex items-center gap-1.5 pr-2 text-[13px] truncate transition-colors rounded-r-sm',
							isActive ? 'text-primary font-bold bg-primary/10' : 'text-foreground/80'
						)
					}>
					<span
						className={clsx(
							'shrink-0 flex items-center justify-center',
							!hasCustomIcon && 'opacity-100',
							// Ensure icon inherits color when active
							!hasCustomIcon && (item.type === 'location' ? 'text-muted-foreground' : 'text-muted-foreground')
						)}>
						{hasCustomIcon ? (
							<EntityIcon type={item.type} customIconUrl={iconUrl} size={14} />
						) : (
							<ResolvedIcon size={14} strokeWidth={2} />
						)}
					</span>

					<span className='truncate'>{item.name}</span>
					{showStatus && (
						<span className='ml-auto opacity-70 flex items-center'>
							<StatusIcon entity={item} />
						</span>
					)}
				</NavLink>
			</div>
			{isExpanded && hasChildren && (
				<div className='ml-[9px] border-l border-border/60 pl-1'>
					{item.children.map((child) => (
						<SidebarTreeItem key={child.id} item={child} onItemClick={onItemClick} />
					))}
				</div>
			)}
		</div>
	);
};

--- END OF features\wiki\components\navigation\sidebar\SidebarTreeItem.jsx ---

--- FILE: features\wiki\components\navigation\sidebar\StatusIcon.jsx ---
import { getStatusIcon } from '@/domain/entity/utils/statusUtils';

/**
 * StatusIcon Component
 * Displays status/affinity icon for entities in sidebar
 *
 * @param {Object} entity - Entity with status/affinity
 */
export const StatusIcon = ({ entity }) => {
	// Prioritize affinity over status for NPCs/Factions
	const statusValue = entity.affinity && entity.affinity !== 'unknown' ? entity.affinity : entity.status;

	const { Icon, className } = getStatusIcon(statusValue, entity.type);

	return <Icon size={12} className={className} strokeWidth={2.5} />;
};

--- END OF features\wiki\components\navigation\sidebar\StatusIcon.jsx ---

--- FILE: features\wiki\config\groupingConfig.js ---
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const GROUPING_CONFIG = {
	location: {
		mode: 'tree',
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
	encounter: {
		mode: 'tree',
		sortItems: (a, b) => {
			if (a.type !== b.type) {
				if (a.type === 'location') return -1;
				if (b.type === 'location') return 1;
			}
			return a.name.localeCompare(b.name);
		},
	},
	npc: {
		mode: 'tree',
		sortItems: (a, b) => {
			if (a.type !== b.type) {
				if (a.type === 'location') return -1;
				if (b.type === 'location') return 1;
			}
			if (a.type === 'npc' && b.type === 'npc') {
				const rankDiff = a.meta.affinityRank - b.meta.affinityRank;
				if (rankDiff !== 0) return rankDiff;
			}
			return a.name.localeCompare(b.name);
		},
	},
	session: {
		// Group by Arc ID
		groupBy: (item, context) => {
			if (context?.sessionArcMap) {
				const arcId = context.sessionArcMap.get(item.id);
				if (arcId) return arcId;
			}
			return 'ungrouped';
		},

		// Map View Data to UI Props
		getGroupMeta: (arcId, context) => {
			if (arcId === 'ungrouped') return { title: 'Uncharted / Side Adventures', order: 9999 };

			const arc = context?.arcs?.find((a) => a.id === arcId);
			if (!arc) return { title: 'Unknown Arc', order: 9998 };

			return {
				title: arc.title,
				description: arc.description,
				order: arc.order,
				type: arc.arc_type, // Maps SQL 'arc_type'
				stats: {
					npcs: arc.npc_count,
					locations: arc.location_count,
					quests: arc.quest_count,
					encounters: arc.encounter_count,
				},
			};
		},

		sortGroups: (ids, context) => {
			return ids.sort((a, b) => {
				if (a === 'ungrouped') return 1;
				if (b === 'ungrouped') return -1;
				const arcA = context?.arcs?.find((x) => x.id === a);
				const arcB = context?.arcs?.find((x) => x.id === b);
				return (arcA?.order || 999) - (arcB?.order || 999);
			});
		},

		sortItems: (a, b) => {
			const numA = Number(a.attributes?.session_number || 0);
			const numB = Number(b.attributes?.session_number || 0);
			if (numA !== 0 || numB !== 0) return numA - numB;
			return a.name.localeCompare(b.name);
		},
	},
	faction: {
		groupBy: (item) => {
			const rank = item.meta.affinityRank;
			if (rank === 1) return 'Allies';
			if (rank === 2) return 'Neutral';
			if (rank === 3) return 'Enemies';
			return 'Unknown';
		},
		sortGroups: ['Allies', 'Neutral', 'Enemies', 'Unknown'],
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
	quest: {
		groupBy: (item) => {
			const t = item.meta.questType.toLowerCase();
			if (t.includes('main')) return 'Main Quest';
			if (t.includes('personal')) return 'Personal Quest';
			return 'Side Quest';
		},
		sortGroups: ['Main Quest', 'Personal Quest', 'Side Quest'],
		sortItems: (a, b) => {
			const statusOrder = ['active', 'in progress', 'pending', 'completed', 'success', 'failed', 'abandoned'];
			const idxA = statusOrder.indexOf(a.meta.status);
			const idxB = statusOrder.indexOf(b.meta.status);
			const valA = idxA === -1 ? 99 : idxA;
			const valB = idxB === -1 ? 99 : idxB;
			if (valA !== valB) return valA - valB;
			return a.name.localeCompare(b.name);
		},
	},
	item: {
		// <--- ADDED
		// Group items by their 'type' attribute (e.g. Weapon, Armor), or 'General' if missing
		groupBy: (item) => {
			const type = getAttributeValue(item.attributes, ['type', 'item_type', 'category']);
			return type ? type.charAt(0).toUpperCase() + type.slice(1) : 'General';
		},
		sortGroups: (keys) => keys.sort(), // Alphabetical groups
		sortItems: (a, b) => a.name.localeCompare(b.name),
	},
};

--- END OF features\wiki\config\groupingConfig.js ---

--- FILE: features\wiki\config\viewStrategies.js ---
import { MapPin, Flag, Circle, Swords, Users, Archive, LayoutGrid, Folder } from 'lucide-react';

export const VIEW_STRATEGIES = {
	location: { mode: 'geo' },
	encounter: { mode: 'geo' },
	npc: { mode: 'geo' },
	faction: { mode: 'category' },
	quest: { mode: 'category' },
	character: { mode: 'flat' },
	item: { mode: 'flat' },
	session: { mode: 'category' },
};

// Recursive Flattening
const flattenGeoTree = (nodes, targetType, parentName = 'Uncharted', visitedIds) => {
	let lanes = [];
	const directItems = [];

	nodes.forEach((node) => {
		if (node.children && node.children.length > 0) {
			const childLanes = flattenGeoTree(node.children, targetType, node.name, visitedIds);
			const myContent = childLanes.find((l) => l.title === null);

			if (myContent && myContent.items.length > 0) {
				lanes.push({
					id: node.id,
					title: node.name,
					parentTitle: parentName,
					link: `/wiki/${node.type}/${node.id}`,
					items: myContent.items,
					description: node.fullDescription || node.description,
				});
			}
			lanes = [...lanes, ...childLanes.filter((l) => l.title !== null)];
		}

		if (node.type === targetType) {
			if (!visitedIds.has(node.id)) {
				visitedIds.add(node.id);
				directItems.push(node);
			}
		}
	});

	if (directItems.length > 0) {
		lanes.push({ id: `misc-${parentName}`, title: null, parentTitle: parentName, link: null, items: directItems });
	}
	return lanes;
};

export const getSwimlanes = (groups, normalizedType) => {
	if (groups.length === 0) return [];

	const strategy = VIEW_STRATEGIES[normalizedType] || VIEW_STRATEGIES.location;

	// STRATEGY 1: GEOGRAPHICAL
	if (strategy.mode === 'geo' && groups[0].isTree) {
		const rootItems = groups[0].items;
		const visitedIds = new Set();
		const rawLanes = flattenGeoTree(rootItems, normalizedType, null, visitedIds);
		const rootLane = rawLanes.find((l) => l.title === null);
		const otherLanes = rawLanes.filter((l) => l.title !== null);

		if (rootLane) {
			otherLanes.push({ ...rootLane, title: 'Uncharted entries', id: 'root-ungrouped' });
		}
		return otherLanes;
	}

	// STRATEGY 2: CATEGORICAL
	if (strategy.mode === 'category') {
		return groups.map((g) => ({
			id: g.id,
			title: g.title || 'Other',
			link: null,
			items: g.items,
			description: g.description,
			type: g.type,
			stats: g.stats,
			order: g.order,
		}));
	}

	// STRATEGY 3: FLAT
	if (strategy.mode === 'flat') {
		const allItems = groups.flatMap((g) => g.items).sort((a, b) => a.name.localeCompare(b.name));
		return [
			{
				id: 'all',
				title: 'All Entries',
				link: null,
				items: allItems,
			},
		];
	}

	return [];
};

export const getStrategyMode = (type) => {
	return VIEW_STRATEGIES[type]?.mode || 'flat';
};

--- END OF features\wiki\config\viewStrategies.js ---

--- FILE: features\wiki\hooks\useEntityContent.js ---
import { useMemo } from 'react';
import { isSession } from '@/domain/entity/utils/entityUtils';
import { transformEvents } from '@/features/wiki/utils/eventMapper';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';

export const useEntityContent = (entity, attributes, sections) => {
	return useMemo(() => {
		if (!entity) return null;

		const entityIsSession = isSession(entity);
		const entityIsQuest = entity.type === 'quest';
		const entityIsEncounter = entity.type === 'encounter';

		// Determine main summary
		let mainSummary = attributes.Summary || entity.summary;
		if (!mainSummary && !entityIsSession) {
			mainSummary = entity.description;
		}

		// --- MAP RESOLUTION FIX ---
		// 1. Look ONLY for specific map keys. Do not fallback to 'icon' or 'background'.
		const specificMapPath = getAttributeValue(attributes, ['map_image', 'tactical_map', 'map']);

		// 2. Construct URL if path exists
		const finalMapUrl = specificMapPath ? `${import.meta.env.BASE_URL}${specificMapPath.replace(/^\//, '')}` : null;

		// Transform Events
		const events = transformEvents(entity.events);

		// Extract Mentions (Sessions only)
		const mentions =
			entityIsSession && entity.relationships
				? entity.relationships.reduce((acc, rel) => {
						const type = rel.entity_type?.toLowerCase() || 'other';
						if (!acc[type]) acc[type] = [];
						acc[type].push({
							id: rel.entity_id,
							name: rel.entity_name,
							type: rel.entity_type,
						});
						return acc;
				  }, {})
				: null;

		const levelUp = getAttributeValue(attributes, ['level_up', 'Level Up']);

		return {
			objectives: entityIsQuest ? entity.objectives || [] : null,
			combatRounds: entityIsEncounter ? entity.combatRounds : null,
			narrative: entityIsSession ? entity.description || '' : null,
			summary: mainSummary || '',
			sections: sections || [],
			history: events,
			mentions,
			levelUp,
			mapImageUrl: finalMapUrl,
			mapMarkers: attributes?.map_markers,
		};
	}, [entity, attributes, sections]);
};

--- END OF features\wiki\hooks\useEntityContent.js ---

--- FILE: features\wiki\hooks\useEntityFetching.js ---
import { useQuery } from '@tanstack/react-query';
import { useCampaign } from '@/features/campaign/CampaignContext';
import { getEntities, getCampaignArcs } from '@/domain/entity/api/entityService';
import { supabase } from '@/shared/api/supabaseClient'; // Import Supabase directly
import { useMemo } from 'react';

export function useEntityFetching(type) {
	const { campaignId } = useCampaign();
	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Primary Query
	const mainQuery = useQuery({
		queryKey: ['entities', campaignId, normalizedType],
		queryFn: async () => {
			// FIX: If fetching sessions, query the sessions table directly
			// to ensure we get the 'narrative' (mapped to description)
			if (normalizedType === 'session') {
				const { data, error } = await supabase
					.from('sessions')
					.select('id, title, narrative, attributes, created_at')
					.eq('campaign_id', campaignId);

				if (error) throw error;

				// Normalize to Entity shape
				return data.map((s) => ({
					id: s.id,
					type: 'session',
					name: s.title,
					description: s.narrative, // Map narrative to description
					attributes: s.attributes,
					created_at: s.created_at,
				}));
			}

			// Otherwise use the standard service
			return getEntities(campaignId, normalizedType);
		},
		enabled: !!campaignId && !!normalizedType,
		staleTime: 1000 * 60 * 5,
	});

	// 2. Locations (for hierarchy)
	const needsLocations = normalizedType === 'npc' || normalizedType === 'encounter';
	const locationQuery = useQuery({
		queryKey: ['entities', campaignId, 'location'],
		queryFn: () => getEntities(campaignId, 'location'),
		enabled: !!campaignId && needsLocations,
		staleTime: 1000 * 60 * 5,
	});

	// 3. Narrative Arcs
	const needsArcs = normalizedType === 'session';
	const arcQuery = useQuery({
		queryKey: ['entities', campaignId, 'narrative_arc_context'],
		queryFn: () => getCampaignArcs(campaignId),
		enabled: !!campaignId && needsArcs,
		staleTime: 1000 * 60 * 5,
	});

	// 4. Merge
	const { entities, context } = useMemo(() => {
		if (mainQuery.isLoading) return { entities: [], context: {} };

		let data = mainQuery.data || [];

		if (needsLocations && locationQuery.data) {
			const existingIds = new Set(data.map((e) => e.id));
			const newLocations = locationQuery.data.filter((l) => !existingIds.has(l.id));
			data = [...data, ...newLocations];
		}

		const context = {};
		if (needsArcs && arcQuery.data) {
			context.arcs = arcQuery.data.arcs;
			const sessionArcMap = new Map();
			(arcQuery.data.rels || []).forEach((r) => {
				sessionArcMap.set(r.from_entity_id, r.to_entity_id);
			});
			context.sessionArcMap = sessionArcMap;
		}

		return { entities: data, context };
	}, [mainQuery.data, locationQuery.data, arcQuery.data, needsLocations, needsArcs, mainQuery.isLoading]);

	return {
		entities,
		context,
		isLoading: mainQuery.isLoading || (needsLocations && locationQuery.isLoading) || (needsArcs && arcQuery.isLoading),
		error: mainQuery.error || locationQuery.error,
	};
}

--- END OF features\wiki\hooks\useEntityFetching.js ---

--- FILE: features\wiki\hooks\useEntityGrouping.js ---
import { useMemo } from 'react';
import { GROUPING_CONFIG } from '@/features/wiki/config/groupingConfig';
import { transformEntityToViewModel } from '@/features/wiki/utils/wikiUtils';

// Helper to build hierarchy trees (unchanged)
const buildTree = (items, sortFn) => {
	const idMap = new Map();
	const roots = [];
	items.forEach((item) => idMap.set(item.id, { ...item, children: [] }));
	items.forEach((item) => {
		const node = idMap.get(item.id);
		const parentId = item.meta.parentId;
		if (parentId && idMap.has(parentId)) {
			idMap.get(parentId).children.push(node);
		} else {
			roots.push(node);
		}
	});

	const prune = (nodes) => {
		const hasMixedTypes = items.some((i) => i.type !== 'location');
		if (!hasMixedTypes) return nodes;

		return nodes.filter((node) => {
			if (node.children.length > 0) {
				node.children = prune(node.children);
			}
			if (node.type === 'location' && node.children.length === 0) {
				return false;
			}
			return true;
		});
	};

	let finalRoots = prune(roots);

	const sortRecursive = (nodes) => {
		if (sortFn) nodes.sort(sortFn);
		nodes.forEach((node) => {
			if (node.children.length > 0) {
				sortRecursive(node.children);
			}
		});
	};

	sortRecursive(finalRoots);
	return finalRoots;
};

export function useEntityGrouping(entities, type, searchQuery = '', context = {}) {
	return useMemo(() => {
		if (!entities || entities.length === 0) return [];

		const filtered = searchQuery
			? entities.filter((e) => e.name.toLowerCase().includes(searchQuery.toLowerCase()))
			: entities;

		const items = filtered.map((entity) => transformEntityToViewModel(entity, type));
		const strategy = GROUPING_CONFIG[type];

		// TREE STRATEGY
		if (strategy?.mode === 'tree') {
			const treeRoots = buildTree(items, strategy.sortItems);
			return [
				{
					id: 'root',
					title: null,
					items: treeRoots,
					isTree: true,
				},
			];
		}

		// CATEGORY STRATEGY
		if (strategy && strategy.groupBy) {
			const grouped = {};
			const metadataMap = new Map(); // Store metadata for the group keys

			items.forEach((item) => {
				const groupKey = strategy.groupBy(item, context) || 'General';

				if (!grouped[groupKey]) {
					grouped[groupKey] = [];
					// If the strategy provides a way to get metadata for this key, fetch it
					if (strategy.getGroupMeta) {
						metadataMap.set(groupKey, strategy.getGroupMeta(groupKey, context));
					}
				}
				grouped[groupKey].push(item);
			});

			let groupKeys = Object.keys(grouped);

			// Handle Sorting Groups
			if (typeof strategy.sortGroups === 'function') {
				groupKeys = strategy.sortGroups(groupKeys, context);
			} else if (Array.isArray(strategy.sortGroups)) {
				groupKeys.sort((a, b) => {
					const idxA = strategy.sortGroups.indexOf(a);
					const idxB = strategy.sortGroups.indexOf(b);
					const valA = idxA === -1 ? 999 : idxA;
					const valB = idxB === -1 ? 999 : idxB;
					return valA - valB || a.localeCompare(b);
				});
			} else {
				groupKeys.sort();
			}

			return groupKeys.map((key) => {
				const groupItems = grouped[key];
				const meta = metadataMap.get(key) || {};

				if (typeof strategy.sortItems === 'function') {
					groupItems.sort(strategy.sortItems);
				} else {
					groupItems.sort((a, b) => a.name.localeCompare(b.name));
				}

				return {
					id: key,
					title: meta.title || key,
					description: meta.description || null,
					order: meta.order || 999,
					type: meta.type || null,
					stats: meta.stats || null,
					items: groupItems,
				};
			});
		}

		// FLAT STRATEGY
		return [
			{
				id: 'all',
				title: null,
				items: items.sort((a, b) => a.name.localeCompare(b.name)),
			},
		];
	}, [entities, type, searchQuery, context]);
}

--- END OF features\wiki\hooks\useEntityGrouping.js ---

--- FILE: features\wiki\hooks\useEntityHeader.js ---
import { useMemo } from 'react';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { resolveImageUrl } from '@/shared/utils/imageUtils';
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import { extractHeaderTags } from '@/features/wiki/utils/attributeMapper';
import { capitalize } from '@/shared/utils/textUtils';

export const useEntityHeader = (entity, attributes) => {
	return useMemo(() => {
		if (!entity) return null;

		const config = getEntityConfig(entity.type);
		const headerBackgroundUrl = resolveImageUrl(attributes, 'background');
		const avatarUrl = resolveImageUrl(attributes, 'icon');

		// Status
		let statusRaw = entity.status || getAttributeValue(attributes, ['status']);
		if (Array.isArray(statusRaw)) statusRaw = statusRaw.join(', ');

		// Priority
		const priorityRaw = getAttributeValue(attributes, ['priority', 'Priority']);

		// Extra Tags
		const extraTags = extractHeaderTags(attributes, entity.type);

		// --- NEW: Character Subtitle Logic ---
		let subtitle = null;
		if (entity.type === 'character') {
			const race = attributes.race || 'Unknown Race';
			const cls = attributes.class || 'Unknown Class';
			const level = attributes.level ? `Level ${attributes.level}` : '';
			// Format: "Earth Genasi  Fighter Echo Knight  Level 8"
			subtitle = [race, cls, level].filter(Boolean).join('  ');
		}

		return {
			title: entity.name,
			subtitle, // Pass the new subtitle
			typeLabel: entity.type?.toUpperCase(),
			imageUrl: headerBackgroundUrl,
			avatarUrl: avatarUrl,
			status: {
				hasStatus: !!statusRaw,
				label: statusRaw ? capitalize(String(statusRaw)) : '',
				isDead: statusRaw?.toLowerCase() === 'dead' || statusRaw?.toLowerCase() === 'failed',
			},
			priority: priorityRaw ? capitalize(priorityRaw) : null,
			extraTags,
			type: entity.type,
			theme: {
				...config.tailwind,
				Icon: config.icon,
			},
		};
	}, [entity, attributes]);
};

--- END OF features\wiki\hooks\useEntityHeader.js ---

--- FILE: features\wiki\hooks\useEntitySidebar.js ---
/**
 * useEntitySidebar Hook
 * Builds sidebar view model from entity data
 */

import { useMemo } from 'react';
import { transformRelationships } from '@/features/wiki/utils/relationshipMapper';

/**
 * Build sidebar view model
 * @param {Object} entity - Raw entity data
 * @param {Array} traits - Traits from attribute transform
 * @returns {Object} Sidebar view model
 */
export const useEntitySidebar = (entity, traits) => {
	return useMemo(() => {
		if (!entity) return null;

		const connections = transformRelationships(entity.relationships, 50);

		return {
			traits: traits || [],
			connections,
		};
	}, [entity, traits]);
};

--- END OF features\wiki\hooks\useEntitySidebar.js ---

--- FILE: features\wiki\layouts\CharacterLayout.jsx ---
import { useState, useMemo } from 'react';
import { User, Network, History as HistoryIcon, BookOpen, Info, X } from 'lucide-react';
import { Drawer } from 'vaul';
import TabContainer from '@/shared/components/layout/TabContainer';
import { EntityBody, EntityHistory } from '@/features/wiki/components/EntityBody';
import { CharacterSidebar } from '@/features/wiki/components/character/CharacterSidebar';
import { CharacterStats } from '@/features/wiki/components/character/CharacterStats';
import { RelationshipNetwork } from '@/features/wiki/components/character/RelationshipNetwork';
import { extractHeaders } from '@/shared/utils/markdownUtils';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { EntityLocalGraph } from '@/features/wiki/components/EntityLocalGraph'; // Import

export default function CharacterLayout({ viewModel }) {
	const { raw } = viewModel;
	const [activeTab, setActiveTab] = useState('bio');

	const gear = useMemo(() => (raw.relationships || []).filter((r) => r.entity_type === 'item'), [raw.relationships]);
	const personalQuests = useMemo(
		() =>
			(raw.relationships || []).filter(
				(r) => r.entity_type === 'quest' && ['quest_giver', 'quest_participant'].includes(r.type)
			),
		[raw.relationships]
	);

	// TOC for Bio
	const tocItems = useMemo(() => {
		if (activeTab === 'bio' && viewModel.content.summary) {
			return extractHeaders(viewModel.content.summary);
		}
		return [];
	}, [activeTab, viewModel.content.summary]);

	// --- TAB 1: BIOGRAPHY ---
	const renderBio = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-6xl mx-auto'>
				{/* 1. HERO STATS (Bio Exclusive) */}
				<CharacterStats attributes={raw.attributes} />

				{/* 2. SPLIT LAYOUT */}
				<div className='grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-8 xl:gap-12'>
					{/* Desktop Sidebar (Hidden on Mobile) */}
					<div className='hidden lg:block lg:order-first min-w-0'>
						<CharacterSidebar attributes={raw.attributes} gear={gear} quests={personalQuests} />
					</div>

					{/* Content */}
					<div className='min-w-0 flex gap-8'>
						<div className='flex-1 min-w-0'>
							<EntityBody summary={viewModel.content.summary} sections={viewModel.content.sections} history={null} />
						</div>
						{tocItems.length > 0 && (
							<div className='hidden xl:block w-56 shrink-0 sticky top-4 border-l border-border pl-4 h-fit'>
								<TableOfContents items={tocItems} />
							</div>
						)}
					</div>
				</div>
			</div>
		</div>
	);

	// --- TAB 2: NETWORK ---
	const renderNetwork = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-6xl mx-auto'>
				{/* NEW: Graph Section */}
				{raw.relationships && raw.relationships.length > 0 && (
					<div className='mb-10'>
						<EntityLocalGraph entity={raw} relationships={raw.relationships} height='h-[400px]' className='mb-8' />
					</div>
				)}
				<RelationshipNetwork relationships={raw.relationships} />
			</div>
		</div>
	);

	// --- TAB 3: CHRONICLE ---
	const renderChronicle = () => (
		<div className='w-full px-4 sm:px-6 py-8'>
			<div className='max-w-4xl mx-auto space-y-10'>
				{personalQuests.length > 0 && (
					<div>
						<h3 className='text-xs font-bold font-sans uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2 border-b border-border pb-2'>
							<BookOpen size={14} /> Personal Quests
						</h3>
						<div className='grid gap-2'>
							{personalQuests.map((q) => (
								<div
									key={q.entity_id}
									className='p-3 border border-border rounded bg-card flex justify-between items-center'>
									<span className='font-bold text-sm text-foreground'>{q.entity_name}</span>
									<span className='text-[10px] uppercase font-bold text-muted-foreground bg-muted px-2 py-0.5 rounded'>
										{q.type.replace(/_/g, ' ')}
									</span>
								</div>
							))}
						</div>
					</div>
				)}
				<div>
					<h3 className='text-xs font-bold font-sans uppercase tracking-widest text-muted-foreground mb-4 flex items-center gap-2 border-b border-border pb-2'>
						<HistoryIcon size={14} /> Timeline
					</h3>
					<EntityHistory events={viewModel.content.history} fullHeight />
				</div>
			</div>
		</div>
	);

	// --- ROOT RENDER ---
	return (
		<div className='w-full bg-background min-h-screen relative'>
			<TabContainer
				tabs={[
					{ id: 'bio', label: 'Biography', icon: User, content: renderBio() },
					{ id: 'network', label: 'Network', icon: Network, content: renderNetwork() },
					{ id: 'chronicle', label: 'Chronicle', icon: HistoryIcon, content: renderChronicle() },
				]}
				defaultTab={activeTab}
				onChange={setActiveTab}
			/>

			{/* MOBILE INFO DRAWER */}
			<div className='lg:hidden'>
				<Drawer.Root shouldScaleBackground>
					<Drawer.Trigger asChild>
						<button className='fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 bg-background text-foreground border border-border rounded-full shadow-2xl font-bold text-xs uppercase tracking-wider active:scale-95 transition-transform hover:border-primary/50'>
							<Info size={18} />
							<span>Info</span>
						</button>
					</Drawer.Trigger>

					<Drawer.Portal>
						<Drawer.Overlay className='fixed inset-0 bg-black/60 z-[60] backdrop-blur-[2px]' />
						<Drawer.Content className='bg-background flex flex-col rounded-t-[10px] h-[85vh] mt-24 fixed bottom-0 left-0 right-0 z-[60] focus:outline-none border-t border-border'>
							{/* Drag Handle & Header */}
							<div className='p-4 bg-muted/30 rounded-t-[10px] flex-shrink-0 border-b border-border'>
								<div className='mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-muted-foreground/30 mb-4' />
								<div className='flex justify-between items-center'>
									<Drawer.Title className='font-serif font-bold text-xl text-foreground'>
										Character Details
									</Drawer.Title>
									<Drawer.Close className='p-2 bg-muted/50 hover:bg-muted rounded-full text-muted-foreground transition-colors'>
										<X size={18} />
									</Drawer.Close>
								</div>
							</div>

							{/* Content */}
							<div className='p-4 overflow-y-auto custom-scrollbar flex-1'>
								<CharacterSidebar attributes={raw.attributes} gear={gear} quests={personalQuests} />
							</div>
						</Drawer.Content>
					</Drawer.Portal>
				</Drawer.Root>
			</div>
		</div>
	);
}

--- END OF features\wiki\layouts\CharacterLayout.jsx ---

--- FILE: features\wiki\layouts\SessionLayout.jsx ---
import { useMemo } from 'react';
import { useSearchParams } from 'react-router-dom';
import { BookOpen, History, Network } from 'lucide-react';
import TabContainer from '@/shared/components/layout/TabContainer';
import { EntityBody, EntityHistory } from '@/features/wiki/components/EntityBody';
import { SessionMentions } from '@/features/wiki/components/SessionMentions';
import { TableOfContents } from '@/features/table-of-contents/TableOfContents';
import { extractHeaders } from '@/shared/utils/markdownUtils';
import { ThreeColumnLayout } from '@/shared/components/layout/SplitView';
import { EntityLocalGraph } from '@/features/wiki/components/EntityLocalGraph'; // Import

export default function SessionLayout({ viewModel }) {
	const [searchParams, setSearchParams] = useSearchParams();
	const activeTab = searchParams.get('tab') || 'narrative';

	const setActiveTab = (tabId) => {
		setSearchParams(
			(prev) => {
				prev.set('tab', tabId);
				return prev;
			},
			{ replace: true }
		);
	};

	const tocItems = useMemo(() => {
		if (viewModel.content.narrative) {
			return extractHeaders(viewModel.content.narrative);
		}
		return [];
	}, [viewModel.content.narrative]);

	if (!viewModel) return null;

	const renderNarrative = () => (
		<ThreeColumnLayout
			left={null}
			center={
				<div className='max-w-3xl mx-auto px-4 sm:px-6 py-10'>
					<EntityBody
						summary={viewModel.content.narrative}
						sections={[]}
						history={null}
						levelUp={viewModel.content.levelUp}
					/>
				</div>
			}
			right={
				tocItems.length > 0 ? (
					<TableOfContents
						items={tocItems}
						className='ml-4'
						visibilityClass='hidden min-[1650px]:block'
						mobileToggleClass='min-[1650px]:hidden'
					/>
				) : null
			}
		/>
	);

	const renderMentions = () => (
		<div className='max-w-6xl mx-auto px-4 sm:px-6 py-10'>
			{/* NEW: Graph Section */}
			{viewModel.raw.relationships && viewModel.raw.relationships.length > 0 && (
				<div className='mb-10 max-w-6xl mx-auto'>
					<EntityLocalGraph entity={viewModel.raw} relationships={viewModel.raw.relationships} height='h-[350px]' />
				</div>
			)}
			<SessionMentions mentions={viewModel.content.mentions} />
		</div>
	);

	const renderTimeline = () => (
		<div className='max-w-3xl mx-auto px-4 sm:px-6 py-10'>
			<EntityHistory events={viewModel.content.history} fullHeight={true} />
		</div>
	);

	return (
		<>
			<TabContainer
				tabs={[
					{
						id: 'narrative',
						label: 'Narrative',
						icon: BookOpen,
						content: renderNarrative(),
					},
					{
						id: 'mentions',
						label: 'Mentions',
						icon: Network,
						content: renderMentions(),
					},
					{
						id: 'events',
						label: 'Timeline',
						icon: History,
						content: renderTimeline(),
					},
				]}
				defaultTab={activeTab}
				sticky
				onChange={setActiveTab}
			/>

			{tocItems.length > 0 && activeTab === 'narrative' && (
				<div className='xl:hidden'>
					<TableOfContents items={tocItems} />
				</div>
			)}
		</>
	);
}

--- END OF features\wiki\layouts\SessionLayout.jsx ---

--- FILE: features\wiki\layouts\StandardLayout.jsx ---
import { Drawer } from 'vaul';
import { Info, X } from 'lucide-react';
import { EntitySidebar } from '@/features/wiki/components/EntitySidebar';
import { EntityBody } from '@/features/wiki/components/EntityBody';

export default function StandardLayout({ viewModel }) {
	if (!viewModel) return null;

	return (
		<div className='w-full px-4 sm:px-6 py-10'>
			<div className='max-w-6xl mx-auto'>
				<div className='grid grid-cols-1 lg:grid-cols-[260px_1fr] xl:grid-cols-[280px_1fr] gap-4 lg:gap-6 xl:gap-8'>
					{/* --- DESKTOP SIDEBAR (Hidden on Mobile) --- */}
					<div className='hidden lg:block lg:order-first min-w-0'>
						<EntitySidebar
							entity={viewModel.raw}
							traits={viewModel.sidebar.traits}
							connections={viewModel.sidebar.connections}
						/>
					</div>

					{/* --- MAIN CONTENT --- */}
					<div className='min-w-0 pb-20'>
						<EntityBody
							summary={viewModel.content.summary}
							sections={viewModel.content.sections}
							history={viewModel.content.history}
							objectives={viewModel.content.objectives}
							combatRounds={viewModel.content.combatRounds}
							mapImageUrl={viewModel.content.mapImageUrl}
							mapMarkers={viewModel.content.mapMarkers}
						/>
					</div>
				</div>
			</div>

			{/* --- MOBILE BOTTOM SHEET --- */}
			<div className='lg:hidden'>
				<Drawer.Root shouldScaleBackground>
					<Drawer.Trigger asChild>
						<button className='fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 bg-background text-foreground border border-border rounded-full shadow-2xl font-bold text-xs uppercase tracking-wider active:scale-95 transition-transform'>
							<Info size={18} />
							<span>Info</span>
						</button>
					</Drawer.Trigger>

					<Drawer.Portal>
						<Drawer.Overlay className='fixed inset-0 bg-black/40 z-50 backdrop-blur-[2px]' />
						<Drawer.Content className='bg-background flex flex-col rounded-t-[10px] h-[85vh] mt-24 fixed bottom-0 left-0 right-0 z-50 focus:outline-none border-t border-border'>
							{/* Drag Handle */}
							<div className='p-4 bg-muted/50 rounded-t-[10px] flex-shrink-0'>
								<div className='mx-auto w-12 h-1.5 flex-shrink-0 rounded-full bg-gray-300 mb-4' />
								<div className='flex justify-between items-center'>
									<Drawer.Title className='font-serif font-bold text-xl'>Details & Stats</Drawer.Title>
									<Drawer.Close className='p-2 bg-muted rounded-full text-muted-foreground'>
										<X size={16} />
									</Drawer.Close>
								</div>
							</div>

							{/* Content */}
							<div className='p-4 bg-background flex-1 overflow-y-auto custom-scrollbar'>
								<EntitySidebar
									entity={viewModel.raw}
									traits={viewModel.sidebar.traits}
									connections={viewModel.sidebar.connections}
								/>
							</div>
						</Drawer.Content>
					</Drawer.Portal>
				</Drawer.Root>
			</div>
		</div>
	);
}

--- END OF features\wiki\layouts\StandardLayout.jsx ---

--- FILE: features\wiki\pages\WikiDetailPage.jsx ---
import { useParams } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { getWikiEntry } from '@/features/wiki/api/wikiService';
import { transformWikiEntry } from '@/features/wiki/utils/wikiEntryMapper'; // Import transform
import WikiEntityView from '@/features/wiki/components/WikiEntryView';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';

export default function WikiEntryPage() {
	const { type, entityId } = useParams();
	const normalizedType = type === 'sessions' ? 'session' : type;

	const {
		data: entity,
		isLoading,
		error,
	} = useQuery({
		queryKey: ['entry', normalizedType, entityId],
		queryFn: () => getWikiEntry(entityId, normalizedType),
		select: (res) => transformWikiEntry(res.data, res.type, res.additional),
		enabled: !!entityId && !!normalizedType,
		retry: 1,
	});

	if (isLoading) return <LoadingSpinner className='h-full min-h-[50vh]' text='Loading Entry...' />;
	if (error)
		return (
			<div className='p-8 text-center text-red-600'>
				<p>Failed to load entry</p>
			</div>
		);

	return <WikiEntityView entity={entity} />;
}

--- END OF features\wiki\pages\WikiDetailPage.jsx ---

--- FILE: features\wiki\pages\WikiLandingPage.jsx ---
import { useParams } from 'react-router-dom';
import { Search, Folder, LayoutGrid, List } from 'lucide-react';
import { useState, useMemo } from 'react';
import { useEntityFetching } from '@/features/wiki/hooks/useEntityFetching';
import { useEntityGrouping } from '@/features/wiki/hooks/useEntityGrouping';
import { getEntityConfig } from '@/domain/entity/config/entityConfig';
import { getSwimlanes, getStrategyMode } from '@/features/wiki/config/viewStrategies';
import { Swimlane } from '../components/landing/Swimlane';
import { EntityTableGroup } from '../components/landing/EntityTableGroup';
import LoadingSpinner from '@/shared/components/ui/LoadingSpinner';
import { clsx } from 'clsx';

export default function WikiLandingPage() {
	const { type } = useParams();
	const normalizedType = type === 'sessions' ? 'session' : type;

	// 1. Fetch Entities & Context (Arcs)
	const { entities, context, isLoading } = useEntityFetching(normalizedType);
	const [viewMode, setViewMode] = useState('grid');
	const [search, setSearch] = useState('');

	const config = getEntityConfig(normalizedType);
	const mode = getStrategyMode(normalizedType);

	// 2. Grouping
	const groups = useEntityGrouping(entities, normalizedType, search, context);
	const swimlanes = useMemo(() => getSwimlanes(groups, normalizedType), [groups, normalizedType]);

	if (isLoading) return <LoadingSpinner className={`h-full min-h-[50vh]`} text={`Loading ${config.labelPlural}...`} />;

	const totalCount = swimlanes.reduce((acc, lane) => acc + lane.items.length, 0);

	return (
		<div className='p-4 md:p-8 lg:p-12 max-w-[1920px] mx-auto min-h-full pb-safe'>
			{/* Header */}
			<div className='flex flex-col gap-6 mb-8 border-b border-border pb-6'>
				<div className='flex items-center justify-between sm:justify-center gap-2'>
					<div className='flex items-center gap-4'>
						<div
							className={clsx(
								'p-3 rounded-xl border shadow-sm bg-background hidden md:block',
								config.tailwind.border,
								config.tailwind.text
							)}>
							<config.icon size={32} strokeWidth={1.5} />
						</div>
						<div>
							<h1 className='text-3xl font-serif font-bold text-foreground capitalize leading-none mb-1'>
								{config.labelPlural}
							</h1>
							<p className='hidden sm:block text-sm text-muted-foreground font-medium'>{totalCount} entries found</p>
						</div>
					</div>
					{/* Search Bar */}
					<div className='relative max-w-2xl md:ml-auto'>
						<Search size={16} className='absolute left-3 top-3 text-muted-foreground' />
						<input
							type='text'
							placeholder={`Search ${config.labelPlural}...`}
							value={search}
							onChange={(e) => setSearch(e.target.value)}
							className='w-full pl-10 pr-4 py-2 bg-background border border-border rounded-lg focus:ring-2 focus:ring-accent/20 focus:border-accent outline-none shadow-sm transition-all'
						/>
					</div>
					{/* View Toggle */}
					<div className='flex bg-muted p-1 rounded-lg border border-border/50'>
						<button
							onClick={() => setViewMode('grid')}
							className={clsx(
								'p-1.5 rounded-md transition-all',
								viewMode === 'grid'
									? 'bg-background text-foreground shadow-sm ring-1 ring-black/5'
									: 'text-muted-foreground hover:text-foreground'
							)}
							title='Grid View'>
							<LayoutGrid size={18} />
						</button>
						<button
							onClick={() => setViewMode('table')}
							className={clsx(
								'p-1.5 rounded-md transition-all',
								viewMode === 'table'
									? 'bg-background text-foreground shadow-sm ring-1 ring-black/5'
									: 'text-muted-foreground hover:text-foreground'
							)}
							title='Table View'>
							<List size={18} />
						</button>
					</div>
				</div>
			</div>

			{/* CONTENT */}
			<div className='pb-20'>
				{viewMode === 'grid' ? (
					swimlanes.map((lane) => (
						<Swimlane
							key={lane.id}
							title={lane.title}
							description={lane.description}
							parentTitle={lane.parentTitle}
							link={lane.link}
							items={lane.items}
							config={config}
							context={mode}
							type={lane.type}
							stats={lane.stats}
							order={lane.order} // <--- Added this
						/>
					))
				) : (
					<div className='max-w-6xl mx-auto'>
						{swimlanes.map((lane) => (
							<EntityTableGroup
								key={lane.id}
								title={lane.title}
								description={lane.description}
								parentTitle={lane.parentTitle}
								link={lane.link}
								items={lane.items}
							/>
						))}
					</div>
				)}
			</div>
		</div>
	);
}

--- END OF features\wiki\pages\WikiLandingPage.jsx ---

--- FILE: features\wiki\utils\attributeMapper.js ---
/**
 * Attribute Transform Functions
 * Pure functions for processing entity attributes into view model format
 */

import {
	parseAttributeValue,
	parseAbilityScores,
	parseTagList,
	isIgnoredAttribute,
	isNarrativeAttribute,
	isListAttribute,
} from '@/domain/entity/utils/attributeParser';

/**
 * Determine if an attribute should go to sidebar or main content
 * @param {string} key - Attribute key
 * @param {*} value - Attribute value
 * @returns {'sidebar'|'main'|'ignore'}
 */
const getAttributeDestination = (key, value) => {
	const normalizedKey = key.toLowerCase();

	if (isIgnoredAttribute(normalizedKey)) {
		return 'ignore';
	}

	// Special widgets always go to sidebar
	if (
		['abilities', 'stats', 'ability score', 'saving throw', 'saves', 'skills', 'languages', 'proficiencies'].includes(
			normalizedKey
		)
	) {
		return 'sidebar';
	}

	// Lists always go to main content
	if (isListAttribute(normalizedKey) && Array.isArray(value)) {
		return 'main';
	}

	// Narrative text goes to main
	if (isNarrativeAttribute(normalizedKey)) {
		return 'main';
	}

	// Long text goes to main
	if (typeof value === 'string' && value.length > 100) {
		return 'main';
	}

	// Everything else to sidebar
	return 'sidebar';
};

/**
 * Process special widget attributes (ability scores, tags)
 * @param {string} key - Attribute key
 * @param {*} value - Raw attribute value
 * @returns {Object|null} Processed trait or null
 */
const processSpecialWidget = (key, value) => {
	const normalizedKey = key.toLowerCase();

	// Ability scores / stats
	if (['abilities', 'stats'].includes(normalizedKey)) {
		const strVal = parseAttributeValue(value);
		return {
			key,
			value: parseAbilityScores(strVal),
			displayType: 'stat-grid',
		};
	}

	// Tag lists
	if (['ability score', 'saving throw', 'saves', 'skills', 'languages', 'proficiencies'].includes(normalizedKey)) {
		const strVal = parseAttributeValue(value);
		return {
			key,
			value: parseTagList(strVal),
			displayType: 'tags',
		};
	}

	return null;
};

/**
 * Transform attributes into sidebar traits and main content sections
 * @param {Object} attributes - Parsed attributes object
 * @param {string} entityDescription - Entity description (to avoid duplication)
 * @returns {{traits: Array, sections: Array}}
 */
export const transformAttributes = (attributes, entityDescription = '') => {
	const traits = [];
	const sections = [];

	Object.entries(attributes).forEach(([key, rawVal]) => {
		// 1. Check for special widgets first
		const widget = processSpecialWidget(key, rawVal);
		if (widget) {
			traits.push(widget);
			return;
		}

		// 2. Parse value
		const displayVal = parseAttributeValue(rawVal, key);
		if (!displayVal) return;

		// 3. Skip if it's the same as description
		const normalizedKey = key.toLowerCase();
		if (normalizedKey === 'description' && displayVal === entityDescription) {
			return;
		}

		// 4. Determine destination
		const destination = getAttributeDestination(key, displayVal);
		if (destination === 'ignore') return;

		// 5. Route to appropriate collection
		if (destination === 'main') {
			// Lists stay as arrays
			if (isListAttribute(normalizedKey) && Array.isArray(displayVal)) {
				sections.push({
					key,
					value: displayVal,
					displayType: 'list',
				});
			} else {
				// Join arrays into text for narrative
				const textValue = Array.isArray(displayVal) ? displayVal.join('\n\n') : displayVal;
				sections.push({
					key,
					value: textValue,
					displayType: 'narrative',
				});
			}
		} else {
			// Sidebar trait
			const textValue = Array.isArray(displayVal) ? displayVal.join(', ') : displayVal;
			traits.push({
				key,
				value: textValue,
				displayType: 'text',
			});
		}
	});

	return { traits, sections };
};

/**
 * Extract extra tags for entity header (session-specific)
 * @param {Object} attributes - Parsed attributes
 * @param {string} entityType - Entity type
 * @returns {string[]}
 */
export const extractHeaderTags = (attributes, entityType) => {
	const tags = [];

	if (entityType === 'session') {
		if (attributes.Session) {
			tags.push(`Session ${attributes.Session}`);
		}
		if (attributes.Date) {
			tags.push(attributes.Date);
		}
	}

	return tags;
};

--- END OF features\wiki\utils\attributeMapper.js ---

--- FILE: features\wiki\utils\eventMapper.js ---
/**
 * Event Transform Functions
 * Pure functions for processing entity events/history into view model format
 */

/**
 * Parse events from various formats
 * @param {Array|Object} events - Raw events data
 * @returns {Array}
 */
export const parseEvents = (events) => {
	if (!events) return [];

	// Already an array
	if (Array.isArray(events)) {
		return events;
	}

	// Object grouped by type (flatten it)
	if (typeof events === 'object') {
		return Object.values(events).flat();
	}

	return [];
};

/**
 * Transform events into history view model
 * Includes deduplication to prevent React key errors
 * @param {Array|Object} events - Raw events
 * @returns {Array}
 */
export const transformEvents = (events) => {
	const parsed = parseEvents(events);

	// 1. Deduplicate by ID using a Map
	const uniqueEventsMap = new Map();
	parsed.forEach((evt) => {
		if (evt && evt.id) {
			uniqueEventsMap.set(evt.id, evt);
		} else if (evt) {
			// Handle events without IDs (fallback)
			uniqueEventsMap.set(Math.random().toString(), evt);
		}
	});

	// 2. Transform values
	return Array.from(uniqueEventsMap.values()).map((event) => ({
		id: event.id || Math.random().toString(),
		title: event.title || 'Untitled Event',
		description: event.description || '',
		session_number: event.session_number,
		order: event.order || event.event_order || 0,
	}));
};

--- END OF features\wiki\utils\eventMapper.js ---

--- FILE: features\wiki\utils\relationshipMapper.js ---
/**
 * Relationship Transform Functions
 * Pure functions for processing entity relationships into view model format
 */

import { getEntityConfig } from '@/domain/entity/config/entityConfig';

/**
 * Parse relationships from various formats
 * @param {string|Array|Object} relationships - Raw relationships data
 * @returns {Array}
 */
export const parseRelationships = (relationships) => {
	if (!relationships) return [];

	// Already an array
	if (Array.isArray(relationships)) {
		return relationships;
	}

	// String (JSON)
	if (typeof relationships === 'string') {
		try {
			return JSON.parse(relationships);
		} catch {
			return [];
		}
	}

	// Object (convert to array)
	if (typeof relationships === 'object') {
		return Object.values(relationships);
	}

	return [];
};

/**
 * Transform relationships into connection view models
 * @param {Array} relationships - Parsed relationships
 * @param {number} maxConnections - Maximum connections to show (default 8)
 * @returns {Array}
 */
export const transformRelationships = (relationships, maxConnections = 8) => {
	const parsed = parseRelationships(relationships);

	return parsed
		.map((rel) => {
			const config = getEntityConfig(rel.entity_type);

			return {
				id: rel.entity_id || Math.random().toString(),
				name: rel.entity_name,
				typeLabel: rel.entity_type,
				role: formatRelationshipType(rel.type),
				theme: {
					...config.tailwind,
					Icon: config.icon,
				},
			};
		})
		.slice(0, maxConnections);
};

/**
 * Format relationship type for display
 * @param {string} type - Raw relationship type
 * @returns {string}
 */
const formatRelationshipType = (type) => {
	if (!type) return 'related';
	return type.toLowerCase().replace(/_/g, ' ');
};

--- END OF features\wiki\utils\relationshipMapper.js ---

--- FILE: features\wiki\utils\wikiEntryMapper.js ---
// features/wiki/utils/wikiEntryMapper.js
import { resolveImageUrl } from '@/shared/utils/imageUtils';

export const transformWikiEntry = (data, type, additionalData = {}) => {
	// --- SESSION ---
	if (type === 'session') {
		// Data comes from view_campaign_timeline
		const sortedEvents = (data.events || []).sort((a, b) => (a.order || 0) - (b.order || 0));

		const eventRelMap = additionalData.eventRelMap || new Map();

		// 1. Attach tags to specific events
		sortedEvents.forEach((evt) => {
			evt.relationships = eventRelMap.get(evt.id) || [];
		});

		// 2. Aggregate ALL unique entities from events to show in the Session Graph
		const allRelationships = [...(additionalData.sessionRelationships || [])];
		const seenIds = new Set(allRelationships.map((r) => r.entity_id));

		// Iterate all events and their tags
		eventRelMap.forEach((tags) => {
			tags.forEach((tag) => {
				if (!seenIds.has(tag.entity_id)) {
					seenIds.add(tag.entity_id);
					allRelationships.push({
						entity_id: tag.entity_id,
						entity_name: tag.entity_name,
						entity_type: tag.entity_type,
						type: 'mention', // Label for the edge
					});
				}
			});
		});

		return {
			id: data.id,
			name: data.name || data.title,
			type: 'session',
			description: data.description || data.narrative,
			attributes: data.attributes || {},
			relationships: allRelationships, // Now includes event mentions
			events: sortedEvents,
		};
	}

	// --- STANDARD ENTITY ---
	let entity = { ...data };

	// Quest Objectives
	if (type === 'quest' && additionalData.objectives) {
		entity.objectives = additionalData.objectives.map((obj) => {
			const sessionAttrs = obj.session?.attributes || {};
			return {
				...obj,
				completed_session_number: sessionAttrs.session_number,
				completed_session_title: obj.session?.title,
			};
		});
	}

	// Encounter Actions
	if (type === 'encounter' && additionalData.encounterActions) {
		const actions = additionalData.encounterActions.map((action) => {
			const actorAttrs = action.actor?.attributes || {};
			const targetAttrs = action.target?.attributes || {};

			return {
				id: action.id,
				round: action.round_number,
				order: action.action_order,
				type: action.action_type,
				isFriendly: action.result === 'SUCCESS',
				description: action.action_description,
				result: action.result,
				effect: action.effect,
				actor: {
					id: action.actor?.id,
					name: action.actor?.name || 'Unknown',
					type: action.actor?.type || 'default',
					iconUrl: resolveImageUrl(actorAttrs, 'icon'),
				},
				target: action.target?.id
					? {
							id: action.target.id,
							name: action.target.name,
							type: action.target.type,
							iconUrl: resolveImageUrl(targetAttrs, 'icon'),
					  }
					: null,
			};
		});

		const rounds = {};
		actions.forEach((action) => {
			if (!rounds[action.round]) rounds[action.round] = [];
			rounds[action.round].push(action);
		});

		entity.combatRounds = rounds;
	}

	// Event Session Mapping
	let events = entity.events;
	if (events && typeof events === 'object' && !Array.isArray(events)) {
		events = Object.values(events).flat();
	}

	if (events && Array.isArray(events) && events.length > 0 && additionalData.sessionMap) {
		events = events.map((event) => ({
			...event,
			session_number:
				event.session_id && additionalData.sessionMap.has(event.session_id)
					? additionalData.sessionMap.get(event.session_id) - 1
					: null,
		}));

		events.sort((a, b) => {
			if (a.session_number !== b.session_number) {
				if (a.session_number == null) return 1;
				if (b.session_number == null) return -1;
				return a.session_number - b.session_number;
			}
			return (a.order || 0) - (b.order || 0);
		});
		entity.events = events;
	}

	return entity;
};

--- END OF features\wiki\utils\wikiEntryMapper.js ---

--- FILE: features\wiki\utils\wikiUtils.js ---
import { getAttributeValue } from '@/domain/entity/utils/attributeParser';
import { getAffinityRank } from '@/domain/entity/utils/statusUtils';
import { getParentId } from '@/domain/entity/utils/entityUtils';

// Helper: Strip Markdown
const stripMarkdown = (text) => {
	if (!text) return '';
	return text
		.replace(/^#+\s+/gm, '')
		.replace(/(\*\*|__)(.*?)\1/g, '$2')
		.replace(/(\*|_)(.*?)\1/g, '$2')
		.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
		.replace(/`{1,3}[^`]+`{1,3}/g, '')
		.replace(/\n/g, ' ')
		.trim();
};

export function transformEntityToViewModel(entity, type) {
	const contextType = type === 'sessions' ? 'session' : type;
	const actualType = entity.type || contextType;
	const attributes = entity.attributes || {};

	// 1. Resolve Status
	const statusRaw = getAttributeValue(attributes, ['status', 'Quest Status']) || entity.status || 'unknown';
	const affinityRaw = getAttributeValue(attributes, ['affinity', 'disposition']);
	const status = statusRaw.toLowerCase();
	const affinity = affinityRaw ? affinityRaw.toLowerCase() : 'unknown';
	const affinityRank = getAffinityRank(affinity !== 'unknown' ? affinity : status);

	// 2. Resolve Meta Fields
	const questType = getAttributeValue(attributes, ['Quest Type', 'Type']) || 'Side Quest';
	const region = getAttributeValue(attributes, ['region', 'parent location']) || null;
	const priority = getAttributeValue(attributes, ['Priority', 'priority']) || null;
	const parentId = getParentId(entity);
	const campaignArc = getAttributeValue(attributes, ['campaign_arc', 'arc']);

	// 3. Resolve Description
	// We need two versions:
	// - One for the Card (short, plain text)
	// - One for the Header (long, markdown preserved)
	let rawDescription = entity.description;

	if (actualType === 'session') {
		rawDescription = entity.description || getAttributeValue(attributes, ['narrative', 'summary']);
	} else {
		rawDescription =
			getAttributeValue(attributes, ['synopsis', 'summary', 'short_description', 'hook']) || entity.description;
	}

	// Version A: For Grid Cards (Stripped & Truncated)
	const description = rawDescription
		? stripMarkdown(rawDescription).substring(0, 140) + (rawDescription.length > 140 ? '...' : '')
		: null;

	// Version B: For Hero Headers (Full & Rich)
	// FIX: Passing the raw string so Swimlane.jsx can handle the truncation logic itself
	const fullDescription = rawDescription || null;

	// 4. Resolve Footer Label
	let footerLabel = null;
	if (actualType === 'session') {
		footerLabel = attributes.session_date || attributes.Date || `Session ${attributes.session_number || '#'}`;
	} else if (actualType === 'npc') {
		footerLabel = getAttributeValue(attributes, ['role', 'occupation', 'class', 'title']);
	} else if (actualType === 'location') {
		footerLabel = getAttributeValue(attributes, ['type']) || region;
	} else if (actualType === 'encounter') {
		footerLabel = getAttributeValue(attributes, ['status']) || 'Encounter';
	} else if (actualType === 'quest') {
		footerLabel = questType;
	} else if (actualType === 'item') {
		const rarity = getAttributeValue(attributes, ['rarity']);
		const type = getAttributeValue(attributes, ['type', 'item_type']) || 'Item';
		footerLabel = rarity ? `${rarity} ${type}` : type;
	}

	if (!footerLabel) {
		footerLabel = region || getAttributeValue(attributes, ['type', 'subtype']);
	}

	// 5. Resolve Hero Subtitle
	let heroSubtitle = footerLabel;
	if (actualType === 'character') {
		const role = getAttributeValue(attributes, ['class', 'role', 'occupation']);
		const level = getAttributeValue(attributes, ['level']);
		if (level && role) heroSubtitle = `Lvl ${level} ${role}`;
		else if (level) heroSubtitle = `Level ${level}`;
		else heroSubtitle = role;
	}

	return {
		id: entity.id,
		name: entity.name,
		path: `/wiki/${contextType}/${entity.id}`,
		type: actualType,

		// UI Props
		description, // Short (Cards)
		fullDescription, // New: Long (Headers)
		footerLabel,
		heroSubtitle,

		status,
		affinity,
		attributes,
		relationships: entity.relationships,

		meta: {
			status,
			affinity,
			affinityRank,
			questType,
			region,
			priority,
			parentId,
			campaignArc,
		},
	};
}

--- END OF features\wiki\utils\wikiUtils.js ---

