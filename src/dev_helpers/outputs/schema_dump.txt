=========================================
   SUPABASE FULL DIAGNOSTIC DUMP (V3)
   Generated: 1/4/2026, 10:39:29 PM
=========================================

-----------------------------------------
TABLE: attributes [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  entity_id                 uuid             
  name                      text             
  value                     text             
  is_private                boolean          DEFAULT false
  created_at                timestamp with time zone NOT NULL DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "51816d5f-7fed-4aea-83c9-300cbaddf6c0",
    "entity_id": "fa4737ee-f3b3-3298-3a4f-287442144513",
    "name": "affinity",
    "value": "Enemy",
    "is_private": false,
    "created_at": "2025-12-29T16:55:00.014Z",
    "updated_at": "2025-12-29T16:55:00.014Z"
  },
  {
    "id": "1a61137c-3438-4933-bc0c-8722335fc124",
    "entity_id": "fa4737ee-f3b3-3298-3a4f-287442144513",
    "name": "status",
    "value": "alive",
    "is_private": false,
    "created_at": "2025-12-29T16:55:00.014Z",
    "updated_at": "2025-12-29T16:55:00.014Z"
  }
]

-----------------------------------------
TABLE: campaigns [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               integer         NOT NULL 
  name                      text            NOT NULL 
  attributes                jsonb            DEFAULT '{}'::jsonb
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  description               text             

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "d147179e-fe98-47e4-84ea-b3bb2e4bc238",
    "campaign_id": 1,
    "name": "A quest, a questin' we shall go",
    "attributes": {
      "map_data": "CAMPAIGN_01",
      "defaultMap": "korinis_island"
    },
    "created_at": "2025-12-01T12:40:52.720Z",
    "updated_at": "2025-12-01T12:40:52.720Z",
    "description": "Six adventurers receive mysterious invitations to a strange, distant land. Teaming up with pirates, they battle monsters and navigate treacherous seas toward the enigmatic island of Korinis."
  },
  {
    "id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "campaign_id": 2,
    "name": "Red Hand of Doom",
    "attributes": {
      "campaign_id": 2,
      "background_image": "images/assets/character_backgrounds/campaign_002/party_bg_horizontal.webp"
    },
    "created_at": "2025-11-19T18:55:54.343Z",
    "updated_at": "2025-11-19T18:55:54.343Z",
    "description": "Five unlikely heroes journey through lush subtropical forests. Bound by shared purpose or hidden motives, their story begins on a wild path where camaraderie grows with each step.\n"
  }
]

-----------------------------------------
TABLE: characters [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  name                      text            NOT NULL 
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  description               text             
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "fd992811-d20d-4231-9a71-7dadedc7b82c",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Olek",
    "created_at": "2025-11-21T11:18:32.073Z",
    "updated_at": "2026-01-04T20:30:17.478Z",
    "description": "He is devotion given form - an angelic soul clad in armor, kind and just, friendly and ever ready for conversation. Olek is honorable to his very core, though humble in his ways, never one to boast or seek glory. His story is unlike any other. As a child, he and his sibling were raised not by kin of their own kind, but by wolves, deep within the forest. How they came to be there, he cannot say. The memory is lost to time or fate. But the pack was family, and he knew love in fur and fang. Then... [TRUNCATED AT 100 WORDS]",
    "attributes": {
      "icon": "images/assets/character_thumbnails/campaign_002/olek.webp",
      "race": "Aasimar",
      "class": "Paladin / Warlock",
      "level": "8",
      "speed": "40ft.",
      "is_active": "true",
      "hit points": "59",
      "armor class": "19",
      "saving throw": [
        "STR +6",
        "DEX +3",
        "CON +6",
        "INT +4",
        "WIS +8",
        "CHA +11"
      ],
      "ability score": [
        "STR 14 (+2)",
        "DEX 8 (-1)",
        "CON 14 (+2)",
        "INT 10 (+0)",
        "WIS 12 (+1)",
        "CHA 18 (+4)"
      ],
      "background_image": "images/assets/character_backgrounds/campaign_002/olek_bg_horizontal.webp"
    }
  },
  {
    "id": "a87b1f4d-421d-4064-827f-470a6e6d0574",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Loraine",
    "created_at": "2025-12-07T20:22:47.251Z",
    "updated_at": "2026-01-04T20:32:47.354Z",
    "description": "Work in progress, will be available later.",
    "attributes": {
      "race": "Vampire",
      "class": "Fighter Battlemaster",
      "level": "8",
      "speed": "30ft.",
      "is_active": "true",
      "hit points": "N/A",
      "armor class": "N/A"
    }
  }
]

-----------------------------------------
TABLE: encounter_actions [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  encounter_id              uuid            NOT NULL 
  round_number              integer         NOT NULL 
  action_order              integer         NOT NULL 
  actor_name                text            NOT NULL 
  actor_entity_id           uuid             
  is_friendly               boolean          
  action_type               text             
  action_description        text            NOT NULL 
  target_name               text             
  target_entity_id          uuid             
  result                    text             
  effect                    text             
  created_at                timestamp with time zone  DEFAULT now()

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "a1000000-0001-0000-0000-000000000001",
    "encounter_id": "e0548e36-026a-4566-9c80-c4e7b0e3b217",
    "round_number": 1,
    "action_order": 1,
    "actor_name": "Brotherhood Summoner",
    "actor_entity_id": null,
    "is_friendly": false,
    "action_type": "spell",
    "action_description": "Chanted in a guttural language to open a rift.",
    "target_name": null,
    "target_entity_id": null,
    "result": "SUCCESS",
    "effect": "Summoned 8 lesser demons into the alley.",
    "created_at": "2025-12-25T18:00:00.000Z"
  },
  {
    "id": "4d4d4d4d-0004-4000-a000-000000000003",
    "encounter_id": "77ab3aa0-dcae-46a3-9cc5-ae0e4b8c3773",
    "round_number": 4,
    "action_order": 3,
    "actor_name": "Kaedin",
    "actor_entity_id": "78700f6d-11a7-4ae0-ab50-a1a1b498c1d7",
    "is_friendly": true,
    "action_type": "action",
    "action_description": "Summoned an Echo and shouted a warning.",
    "target_name": "Party",
    "target_entity_id": "22de4109-6224-474a-9104-bc044c5562d2",
    "result": "SUCCESS",
    "effect": "Revealed that the pillars have Repulsion Wards protecting them.",
    "created_at": "2025-12-25T14:48:10.000Z"
  }
]

-----------------------------------------
TABLE: encounters [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  name                      text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "8e2cb244-6777-4910-af72-5538358efc14",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Reptile Battle",
    "description": null,
    "created_at": "2025-12-26T18:26:12.756Z",
    "updated_at": "2026-01-02T12:29:44.902Z",
    "attributes": {
      "status": "Completed"
    }
  },
  {
    "id": "e0548e36-026a-4566-9c80-c4e7b0e3b217",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Demonic Ambush",
    "description": "Pursuing thieves into a dark alley, the party fell into a trap set by Brotherhood agents. A hooded summoner conjured lesser demons while archers rained poison arrows from the rooftops. Kaedin and Loraine held the line against the demonic onslaught, utilizing echoes and vampiric blood magic, while Soshi and Bonnie provided devastating fire support and healing. Despite being poisoned and outnumbered, the party broke the summoner's defenses, killing the demons and forcing the surviving agents to flee.",
    "created_at": "2025-12-25T15:17:42.658Z",
    "updated_at": "2026-01-03T10:51:41.615Z",
    "attributes": {
      "status": "Completed",
      "map_image": "images/assets/map_backgrounds/campaign_002/demonic_ambush_map.webp",
      "background_image": "images/assets/encounter_backgrounds/campaign_002/demonic_ambush_bg.webp"
    }
  }
]

-----------------------------------------
TABLE: entities [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  type                      text            NOT NULL 
  name                      text            NOT NULL 
  created_at                timestamp with time zone  DEFAULT now()
  campaign_id               uuid            NOT NULL 
  description               text             

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "964c0ea9-838b-46b0-a606-8d109749624f",
    "type": "npc",
    "name": "Glass",
    "created_at": "2025-11-20T20:53:50.456Z",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "description": "Massive ice elemental who speaks agonizingly slowly except when conducting business.\n"
  },
  {
    "id": "0b5848ff-04c4-43a9-4b50-398553255624",
    "type": "npc",
    "name": "Kresimir",
    "created_at": "2025-11-23T17:09:23.293Z",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "description": "A resurrected deity who serves as the admiral and spiritual leader of the Angevin Fleet. He appeared in the shared vision of Olek and Norr, leading a devastating naval assault on the Paladin fortress of Bremen."
  }
]

-----------------------------------------
TABLE: entity_relationships [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  from_entity_id            uuid            NOT NULL 
  to_entity_id              uuid            NOT NULL 
  relationship_type         text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  is_bidirectional          boolean          
  is_hidden                 boolean          DEFAULT false

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "b33bb8e6-04e0-4762-b489-94ef3785d51b",
    "from_entity_id": "7510ae7d-9133-476e-902c-6aea36e82b46",
    "to_entity_id": "957b14a8-c53f-4237-a540-9d5c3474bc5f",
    "relationship_type": "mention",
    "description": null,
    "created_at": "2025-12-25T07:38:28.148Z",
    "is_bidirectional": false,
    "is_hidden": false
  },
  {
    "id": "fa54562e-21ad-4483-a292-797b1dd70a82",
    "from_entity_id": "7510ae7d-9133-476e-902c-6aea36e82b46",
    "to_entity_id": "8427e65e-de6e-4419-b404-73b9704d9543",
    "relationship_type": "mention",
    "description": null,
    "created_at": "2025-12-25T07:38:31.721Z",
    "is_bidirectional": false,
    "is_hidden": false
  }
]

-----------------------------------------
TABLE: factions [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  name                      text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "e24e62dd-c9d5-4c5d-87b0-18c09392dc09",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "The Harpers",
    "description": "A semi-secret organization dedicated to promoting good and preserving history. They have not yet made a direct appearance in the campaign, but their reputation as a network of spies and informants makes them a potential future ally against the widespread conspiracy of the Red Hand and Arcane Brotherhood.",
    "created_at": "2025-11-21T17:01:11.633Z",
    "updated_at": "2026-01-02T11:03:41.432Z",
    "attributes": {
      "affinity": "Neutral"
    }
  },
  {
    "id": "e09a7bfa-fde1-44a6-80f0-7b8f216deaf1",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "The Lion's Guard",
    "description": "The elite military force of the city of Brindol, commanded by Captain Hans Mariner. They are the \"big guns\" of the region, far better equipped and trained than the local militia.",
    "created_at": "2025-12-07T14:08:43.651Z",
    "updated_at": "2026-01-02T11:03:50.033Z",
    "attributes": {
      "affinity": "Neutral"
    }
  }
]

-----------------------------------------
TABLE: items [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  session_id                uuid             
  name                      text             
  description               text             
  created_at                timestamp with time zone NOT NULL DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb
  campaign_id               uuid             

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "133e7364-969c-4250-b878-145c817ea986",
    "session_id": "a76b7458-a291-4385-b6f0-bb7d72e0657b",
    "name": "Troll Hide Patch",
    "description": "A piece of regenerating leather that, when affixed to armor, allows the wearer to heal three times per day a 1d6.",
    "created_at": "2025-11-30T14:25:19.998Z",
    "updated_at": "2025-11-30T14:25:19.998Z",
    "attributes": {},
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a"
  },
  {
    "id": "322da049-3ada-475c-a89e-1af5a1990d63",
    "session_id": "a76b7458-a291-4385-b6f0-bb7d72e0657b",
    "name": "Rabbit's Foot",
    "description": "Marks your allegiance to the Black Crag Horde and, as a free action once per day, allows you to gain 1d4 temporary hp. ",
    "created_at": "2025-11-30T14:23:26.356Z",
    "updated_at": "2025-11-30T14:23:26.356Z",
    "attributes": {},
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a"
  }
]

-----------------------------------------
TABLE: locations [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  name                      text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "dcdb9c63-0211-4472-8632-acc5068e862f",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Brindol",
    "description": "A city with a dry dock and home to the Lion's Guard. Trade hub that has been raided by pirates. Brindol is a small city in the heart of Elsir Vale. One of the largest settlements in the Vale, Brindol is a prosperous farming community and caravan stopover located along the Dawn Way on the south bank of the Elsir River. Orchards of apple and pear trees follow the river's winding shores, while broad grain fields and farmlands surround the town for miles in all directions. Brindol is the home of Lord Aaron Jarmaath. His small keep and the city... [TRUNCATED AT 100 WORDS]",
    "created_at": "2025-11-21T16:51:32.713Z",
    "updated_at": "2026-01-03T10:51:00.809Z",
    "attributes": {
      "type": "city",
      "ruler": "Lord Aaron Jarmaath",
      "map_image": "images/assets/map_backgrounds/campaign_002/brindol_map.webp",
      "population": "6.700"
    }
  },
  {
    "id": "bb98adb9-4467-4e04-bb48-343102c0ce5a",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Lustria",
    "description": "A distant southern continent featuring deep jungles and lizardfolk populations. Home to Pelagos and the origin point of the Arcane Brotherhood operations that affected Norr and Soshi. The continent experienced sudden jungle regrowth that dramatically altered regional politics and warfare. Contains penal mining colonies where General Lee led slave revolts.",
    "created_at": "2025-11-21T06:39:21.788Z",
    "updated_at": "2026-01-02T07:53:19.600Z",
    "attributes": {
      "type": "region"
    }
  }
]

-----------------------------------------
TABLE: narrative_arcs [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL DEFAULT gen_random_uuid()
  title                     text             
  description               text             
  created_at                timestamp with time zone NOT NULL DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  order                     integer          
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "761b8691-c9a3-4a81-bd7b-1500200ad444",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "Thunder and Ash",
    "description": "With the enemy army mere days from Drellin's Ferry, the party makes a desperate gambit: allying with Dreshi, a zealous goblin follower of Lamashtu, to destroy the only bridge across the gorge. The sabotage succeeds spectacularly, buying precious time for the town's evacuation. As refugees flee westward, the party encounters Loraine Martinique, a vampire noble investigating fey portals, and receives troubling news of an alliance between the Archlich of Pahuax and the approaching horde. The arc closes with Drellin's Ferry emptied, its people scattered, and new mysteries beckoning the heroes toward darker conspiracies.",
    "created_at": "2026-01-01T08:15:08.410Z",
    "updated_at": "2026-01-01T08:15:08.410Z",
    "order": 5,
    "attributes": {
      "type": "primary"
    }
  },
  {
    "id": "a9f6e2ea-3fbd-44d4-abc0-c62f94405406",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "Shadows of the Witchwood",
    "description": "Delving into the cursed Witchwood and its flooded cave systems, the party uncovers a nightmare of transmutation experiments and breeding programs. The discovery of Kalistra's arena of horrors - where creatures are twisted and trained for war - reveals the Arcane Brotherhood's dark involvement. As they navigate illusion-shrouded forests and face hydras, megatheriums, and acid-spitting arthropods, the companions realize they've stumbled into something far more sinister than simple raiding parties.",
    "created_at": "2026-01-01T08:13:56.636Z",
    "updated_at": "2026-01-01T08:13:56.636Z",
    "order": 2,
    "attributes": {
      "type": "primary"
    }
  }
]

-----------------------------------------
TABLE: npcs [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  name                      text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "72e9b966-7c3b-5410-b2c7-40966436673b",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Clyde",
    "description": "Bonnie's best friend in Feywild. Saved from execution by Bonnie's sacrifice. Captured with Bonnie, sentenced to death. Bonnie chose banishment to spare Clyde's life.",
    "created_at": "2025-11-09T10:06:04.612Z",
    "updated_at": "2026-01-03T07:54:57.890Z",
    "attributes": {
      "icon": "../../images/icons/quickling.webp",
      "race": "Quickling",
      "role": "Friend",
      "gender": "Male",
      "status": "alive",
      "affinity": "Ally",
      "is_active": "true"
    }
  },
  {
    "id": "964c0ea9-838b-46b0-a606-8d109749624f",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "name": "Glass",
    "description": "Massive ice elemental who speaks agonizingly slowly except when conducting business.\n",
    "created_at": "2025-11-20T20:53:50.456Z",
    "updated_at": "2026-01-03T07:55:14.287Z",
    "attributes": {
      "icon": "../../images/icons/elemental.webp",
      "race": "Ice Elemental",
      "role": "Quartermaster",
      "gender": "male",
      "status": "alive",
      "affinity": "Neutral",
      "is_active": "true",
      "personality": "Loyal, methodical, all-business when negotiating."
    }
  }
]

-----------------------------------------
TABLE: quest_objectives [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  quest_id                  uuid            NOT NULL 
  description               text            NOT NULL 
  status                    text             DEFAULT 'pending'::text
  order_index               integer         NOT NULL 
  completed_session_id      uuid             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  objective_name            text             
  objective_update          text             

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "1feb6bfc-7071-4c57-ac29-5535a43213e9",
    "quest_id": "812a2b4c-3c16-4270-8a98-9e230331f2dd",
    "description": "Unlock the secrets of the treasure map stolen from the Arcane Brotherhood.",
    "status": "completed",
    "order_index": 1,
    "completed_session_id": "14230e1c-07ea-4fe8-9157-335fb1554508",
    "created_at": "2025-12-20T16:38:33.727Z",
    "updated_at": "2025-12-23T10:50:14.088Z",
    "objective_name": "Decipher the Map",
    "objective_update": "Location identified: Wrath Keep in the Witchwood."
  },
  {
    "id": "7316a460-cda0-4bcb-b991-11fb7d31a843",
    "quest_id": "95322ebe-f77e-4419-8528-d3cd19834750",
    "description": "Travel through the overgrown, subtropical forest road to the town of Drellin's Ferry.",
    "status": "completed",
    "order_index": 1,
    "completed_session_id": "b2f8c12f-b108-4c35-87d1-8ae0e6e98ce5",
    "created_at": "2025-12-20T16:38:33.727Z",
    "updated_at": "2025-12-20T16:39:25.659Z",
    "objective_name": "Reach Drellin's Ferry",
    "objective_update": null
  }
]

-----------------------------------------
TABLE: quests [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  title                     text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "6f3aa44b-9986-40c7-b33c-9176014d804b",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "The Shadow of Abuse",
    "description": "Olek discovered a woman suffering from domestic abuse after her son asked for help. He healed her wounds but promised to return to speak with the husband.",
    "created_at": "2025-12-20T19:30:42.129Z",
    "updated_at": "2026-01-02T07:53:19.600Z",
    "attributes": {
      "status": "Failed",
      "priority": "Low",
      "quest type": "Side Quest"
    }
  },
  {
    "id": "231a3f04-fbd5-4273-bb89-994a177f7792",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "The Missing Barmaid",
    "description": "Anya, a young barmaid at the Green Apple Inn, has gone missing. Her home shows signs of distress, and rumors suggest a troubled relationship with the town guard Lem.",
    "created_at": "2025-12-21T16:43:28.053Z",
    "updated_at": "2026-01-02T07:53:19.600Z",
    "attributes": {
      "status": "Completed",
      "priority": "Low",
      "quest type": "Side Quest"
    }
  }
]

-----------------------------------------
TABLE: session_events [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  session_id                uuid            NOT NULL 
  event_order               integer         NOT NULL 
  event_type                text            NOT NULL 
  title                     text            NOT NULL 
  description               text             
  created_at                timestamp with time zone  DEFAULT now()

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "0e5851e2-59b6-4bac-8462-15529735c7fe",
    "session_id": "513d48be-935f-4076-81a5-af859fc708be",
    "event_order": 2,
    "event_type": "backstory",
    "title": "Olek's Reflection",
    "description": "Olek reflected on his path. He recalled the wolves that raised him, the fire that took them, and the celestial pact that saved him. He walked not for glory, but to fulfill the charge given by Helm's servant: to save those in need. His armor shone as a beacon of his devotion, his mind set on the justice he brought to the road ahead.",
    "created_at": "2025-12-20T16:53:37.279Z"
  },
  {
    "id": "0b39202f-621b-4328-96d3-4b3484b2624a",
    "session_id": "513d48be-935f-4076-81a5-af859fc708be",
    "event_order": 1,
    "event_type": "travel",
    "title": "The Assembly on the Green Road",
    "description": "Five unlikely heroes gathered on a winding, overgrown road draped in subtropical greenery. Despite their differing origins—an Aasimar, a Sorcerer, an Eladrin, a Genasi, and a Pixie—they traveled in good spirits. The air was thick with the scent of growth and distant creature calls as they moved toward Drellin's Ferry, united by shared movement if not yet a shared destiny.",
    "created_at": "2025-12-20T16:53:18.468Z"
  }
]

-----------------------------------------
TABLE: sessions [⚠️ RLS DISABLED]
-----------------------------------------
  id                        uuid            NOT NULL DEFAULT gen_random_uuid()
  campaign_id               uuid            NOT NULL 
  title                     text            NOT NULL 
  narrative                 text             
  created_at                timestamp with time zone  DEFAULT now()
  updated_at                timestamp with time zone  DEFAULT now()
  attributes                jsonb            DEFAULT '{}'::jsonb

  -- EXAMPLE DATA (2 rows) --
[
  {
    "id": "ed49e6cd-f7aa-40f7-8723-8f4cc02d23d7",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "08 - The Shattered Artifact",
    "narrative": "### The Onslaught Begins The dust had barely settled from the explosion that had torn a hole in the chamber wall when a new threat emerged. Through the breach, the party could see the silhouettes of an approaching force, their numbers obscured by the gloom but their intent made terrifyingly clear by their steady advance. \"Guys, there is kind of an army coming towards us,\" Bonnie warned, her small voice tight with urgency. Olek, standing beside the ritualist they had come to confront, stared out at the encroaching soldiers. \"I have an idea,\" he declared, his voice ringing with grim... [TRUNCATED AT 100 WORDS]",
    "created_at": "2025-11-21T10:56:22.394Z",
    "updated_at": "2026-01-02T11:16:24.541Z",
    "attributes": {
      "level_up": "8",
      "session_date": "2025-10-18",
      "session_number": "9"
    }
  },
  {
    "id": "b2f8c12f-b108-4c35-87d1-8ae0e6e98ce5",
    "campaign_id": "415036c7-08cc-4832-bfec-6daca13e3f8a",
    "title": "01 - To Drellin's Ferry",
    "narrative": "### First encounter We begin on the fourth day of travel. Afternoon has settled in, the sun still burning, the air hot and still. The lands of Elsir Vale have blurred by now - every town looks the same, and our heroes can no longer tell one from the next. Drellin's Ferry lies just a few miles ahead - both their destination and their long-awaited respite from the arduous road. Conversation has grown scarce. After four days on the road, there's little left to say, and even less to want beyond a soft bed and a hot meal. A small... [TRUNCATED AT 100 WORDS]",
    "created_at": "2025-11-19T20:57:25.759Z",
    "updated_at": "2026-01-03T07:53:20.970Z",
    "attributes": {
      "session_date": "2025-04-12",
      "session_number": "2",
      "background_image": "images/assets/session_backgrounds/campaign_002/session_01_bg.webp"
    }
  }
]

=========================================
   PERFORMANCE INDEXES
=========================================

TABLE: attributes
  CREATE UNIQUE INDEX attributes_pkey ON public.attributes USING btree (id)

TABLE: attributes
  CREATE INDEX idx_attributes_entity_name ON public.attributes USING btree (entity_id, name)

TABLE: campaigns
  CREATE UNIQUE INDEX campaigns_campaign_id_key ON public.campaigns USING btree (campaign_id)

TABLE: campaigns
  CREATE UNIQUE INDEX campaigns_pkey ON public.campaigns USING btree (id)

TABLE: characters
  CREATE UNIQUE INDEX characters_pkey ON public.characters USING btree (id)

TABLE: characters
  CREATE INDEX idx_characters_campaign ON public.characters USING btree (campaign_id)

TABLE: encounter_actions
  CREATE UNIQUE INDEX encounter_actions_pkey ON public.encounter_actions USING btree (id)

TABLE: encounters
  CREATE UNIQUE INDEX encounters_pkey ON public.encounters USING btree (id)

TABLE: encounters
  CREATE INDEX idx_encounters_campaign ON public.encounters USING btree (campaign_id)

TABLE: entities
  CREATE UNIQUE INDEX entities_pkey ON public.entities USING btree (id)

TABLE: entity_relationships
  CREATE UNIQUE INDEX entity_relationships_pkey ON public.entity_relationships USING btree (id)

TABLE: entity_relationships
  CREATE INDEX idx_entity_relationships_bidirectional ON public.entity_relationships USING btree (to_entity_id, from_entity_id) WHERE (is_bidirectional = true)

TABLE: entity_relationships
  CREATE INDEX idx_entity_relationships_composite ON public.entity_relationships USING btree (from_entity_id, to_entity_id)

TABLE: entity_relationships
  CREATE INDEX idx_entity_relationships_to ON public.entity_relationships USING btree (to_entity_id)

TABLE: entity_relationships
  CREATE UNIQUE INDEX unique_relationship ON public.entity_relationships USING btree (from_entity_id, to_entity_id, relationship_type)

TABLE: factions
  CREATE UNIQUE INDEX factions_campaign_name_unique ON public.factions USING btree (campaign_id, name)

TABLE: factions
  CREATE UNIQUE INDEX factions_pkey ON public.factions USING btree (id)

TABLE: factions
  CREATE INDEX idx_factions_campaign ON public.factions USING btree (campaign_id)

TABLE: factions
  CREATE INDEX idx_factions_name ON public.factions USING btree (name)

TABLE: items
  CREATE UNIQUE INDEX items_pkey ON public.items USING btree (id)

TABLE: locations
  CREATE INDEX idx_locations_campaign ON public.locations USING btree (campaign_id)

TABLE: locations
  CREATE INDEX idx_locations_name ON public.locations USING btree (name)

TABLE: locations
  CREATE UNIQUE INDEX locations_pkey ON public.locations USING btree (id)

TABLE: narrative_arcs
  CREATE UNIQUE INDEX narrative_arcs_pkey ON public.narrative_arcs USING btree (id)

TABLE: npcs
  CREATE INDEX idx_npcs_campaign ON public.npcs USING btree (campaign_id)

TABLE: npcs
  CREATE INDEX idx_npcs_name ON public.npcs USING btree (name)

TABLE: npcs
  CREATE UNIQUE INDEX npcs_pkey ON public.npcs USING btree (id)

TABLE: quest_objectives
  CREATE INDEX idx_quest_objectives_quest ON public.quest_objectives USING btree (quest_id)

TABLE: quest_objectives
  CREATE UNIQUE INDEX quest_objectives_pkey ON public.quest_objectives USING btree (id)

TABLE: quests
  CREATE INDEX idx_quests_campaign ON public.quests USING btree (campaign_id)

TABLE: quests
  CREATE INDEX idx_quests_status ON public.quests USING gin (((attributes -> 'status'::text)))

TABLE: quests
  CREATE INDEX idx_quests_status_jsonb ON public.quests USING gin (((attributes -> 'status'::text)))

TABLE: quests
  CREATE UNIQUE INDEX quests_pkey ON public.quests USING btree (id)

TABLE: session_events
  CREATE INDEX idx_session_events_session ON public.session_events USING btree (session_id, event_order)

TABLE: session_events
  CREATE UNIQUE INDEX session_events_order_unique ON public.session_events USING btree (session_id, event_order)

TABLE: session_events
  CREATE UNIQUE INDEX session_events_pkey ON public.session_events USING btree (id)

TABLE: sessions
  CREATE INDEX idx_sessions_campaign_id ON public.sessions USING btree (campaign_id)

TABLE: sessions
  CREATE INDEX idx_sessions_number ON public.sessions USING gin (((attributes -> 'session_number'::text)))

TABLE: sessions
  CREATE INDEX idx_sessions_number_jsonb ON public.sessions USING gin (((attributes -> 'session_number'::text)))

TABLE: sessions
  CREATE UNIQUE INDEX sessions_pkey ON public.sessions USING btree (id)

=========================================
   SECURITY POLICIES (RLS)
=========================================

No RLS Policies found.

=========================================
   VIEWS
=========================================

VIEW: view_campaign_graph
-----------------------------------------
 SELECT e.id,
  e.campaign_id,
  e.name,
  e.type,
  (attr.attributes ->> 'icon'::text) AS icon,
  ( SELECT count(*) AS count
  FROM entity_relationships er
  WHERE ((er.from_entity_id = e.id) OR (er.to_entity_id = e.id))) AS degree,
  COALESCE(( SELECT jsonb_agg(jsonb_build_object('target', er.to_entity_id, 'type', er.relationship_type)) AS jsonb_agg
  FROM entity_relationships er
  WHERE (er.from_entity_id = e.id)), '[]'::jsonb) AS relationships
  FROM (entities e
  LEFT JOIN view_entity_attributes_source attr ON ((e.id = attr.id)))
  WHERE (e.type <> ALL (ARRAY['event'::text, 'session_event'::text]));

VIEW: view_encounter_actions_hydrated
-----------------------------------------
 SELECT ea.id,
  ea.encounter_id,
  ea.round_number,
  ea.action_order,
  ea.action_description,
  ea.result,
  ea.effect,
  ea.action_type,
  jsonb_build_object('id', ea.actor_entity_id, 'name', COALESCE(e_actor.name, ea.actor_name), 'type', COALESCE(e_actor.type, 'unknown'::text), 'attributes', COALESCE(attr_actor.attributes, '{}'::jsonb)) AS actor,
  jsonb_build_object('id', ea.target_entity_id, 'name', COALESCE(e_target.name, ea.target_name), 'type', COALESCE(e_target.type, 'unknown'::text), 'attributes', COALESCE(attr_target.attributes, '{}'::jsonb)) AS target
  FROM ((((encounter_actions ea
  LEFT JOIN entities e_actor ON ((ea.actor_entity_id = e_actor.id)))
  LEFT JOIN view_entity_attributes_source attr_actor ON ((ea.actor_entity_id = attr_actor.id)))
  LEFT JOIN entities e_target ON ((ea.target_entity_id = e_target.id)))
  LEFT JOIN view_entity_attributes_source attr_target ON ((ea.target_entity_id = attr_target.id)));

VIEW: view_entity_attributes_source
-----------------------------------------
 SELECT npcs.id,
  npcs.attributes
  FROM npcs
UNION ALL
  SELECT characters.id,
  characters.attributes
  FROM characters
UNION ALL
  SELECT factions.id,
  factions.attributes
  FROM factions
UNION ALL
  SELECT locations.id,
  locations.attributes
  FROM locations
UNION ALL
  SELECT quests.id,
  quests.attributes
  FROM quests
UNION ALL
  SELECT encounters.id,
  encounters.attributes
  FROM encounters
UNION ALL
  SELECT items.id,
  items.attributes
  FROM items
UNION ALL
  SELECT sessions.id,
  sessions.attributes
  FROM sessions;

VIEW: view_active_party
-----------------------------------------
 SELECT id,
  campaign_id,
  name,
  (attributes ->> 'race'::text) AS race,
  (attributes ->> 'class'::text) AS class,
  (attributes ->> 'icon'::text) AS icon,
  (attributes ->> 'level'::text) AS level
  FROM characters c
  WHERE ((((attributes ->> 'is_active'::text))::boolean = true) OR ((attributes ->> 'is_active'::text) = 'true'::text));

VIEW: entity_complete_view
-----------------------------------------
 SELECT e.id,
  e.type,
  e.name,
  e.description,
  e.campaign_id,
  e.created_at,
  COALESCE(attr.attributes, '{}'::jsonb) AS attributes,
  COALESCE(rels.relationships, '[]'::jsonb) AS relationships,
  COALESCE(events.events, '{}'::jsonb) AS events
  FROM (((entities e
  LEFT JOIN view_entity_attributes_source attr ON ((e.id = attr.id)))
  LEFT JOIN LATERAL ( SELECT COALESCE(jsonb_agg(rel_combined.rel_obj), '[]'::jsonb) AS relationships
  FROM ( SELECT jsonb_build_object('relationship_id', er_out.id, 'direction', 'outgoing', 'type', er_out.relationship_type, 'entity_id', er_out.to_entity_id, 'entity_name', e_to.name, 'entity_type', e_to.type, 'description', er_out.description, 'is_bidirectional', false) AS rel_obj
  FROM (entity_relationships er_out
  JOIN entities e_to ON ((e_to.id = er_out.to_entity_id)))
  WHERE ((er_out.from_entity_id = e.id) AND (er_out.is_bidirectional = false) AND (e_to.type <> 'event'::text))
  UNION ALL
  SELECT jsonb_build_object('relationship_id', er_out.id, 'direction', 'bidirectional', 'type', er_out.relationship_type, 'entity_id', er_out.to_entity_id, 'entity_name', e_to.name, 'entity_type', e_to.type, 'description', er_out.description, 'is_bidirectional', true) AS rel_obj
  FROM (entity_relationships er_out
  JOIN entities e_to ON ((e_to.id = er_out.to_entity_id)))
  WHERE ((er_out.from_entity_id = e.id) AND (er_out.is_bidirectional = true) AND (e_to.type <> 'event'::text))
  UNION ALL
  SELECT jsonb_build_object('relationship_id', er_in.id, 'direction', 'incoming', 'type', er_in.relationship_type, 'entity_id', er_in.from_entity_id, 'entity_name', e_from.name, 'entity_type', e_from.type, 'description', er_in.description, 'is_bidirectional', false) AS rel_obj
  FROM (entity_relationships er_in
  JOIN entities e_from ON ((e_from.id = er_in.from_entity_id)))
  WHERE ((er_in.to_entity_id = e.id) AND (er_in.is_bidirectional = false) AND (e_from.type <> 'event'::text))) rel_combined) rels ON (true))
  LEFT JOIN LATERAL ( SELECT COALESCE(jsonb_object_agg(macro_events.macro_type, macro_events.events_array), '{}'::jsonb) AS events
  FROM ( SELECT macro_events_inner.macro_type,
  jsonb_agg(macro_events_inner.event_obj ORDER BY macro_events_inner.event_order, macro_events_inner.id) AS events_array
  FROM ( SELECT 'event'::text AS macro_type,
  e_event.id,
  se_out.event_order,
  jsonb_build_object('id', e_event.id, 'event_type', COALESCE(se_out.event_type, ('relationship_'::text || er_event.relationship_type)), 'title', e_event.name, 'description', e_event.description, 'order', se_out.event_order, 'session_id', se_out.session_id, 'created_at', e_event.created_at, 'relationship_id', er_event.id, 'relationship_type', er_event.relationship_type, 'relationship_direction', 'outgoing') AS event_obj
  FROM ((entity_relationships er_event
  JOIN entities e_event ON ((e_event.id = er_event.to_entity_id)))
  LEFT JOIN session_events se_out ON ((se_out.id = e_event.id)))
  WHERE ((er_event.from_entity_id = e.id) AND (e_event.type = 'event'::text))
  UNION ALL
  SELECT 'event'::text AS macro_type,
  e_event.id,
  se_in.event_order,
  jsonb_build_object('id', e_event.id, 'event_type', COALESCE(se_in.event_type, ('relationship_'::text || er_event_in.relationship_type)), 'title', e_event.name, 'description', e_event.description, 'order', se_in.event_order, 'session_id', se_in.session_id, 'created_at', e_event.created_at, 'relationship_id', er_event_in.id, 'relationship_type', er_event_in.relationship_type, 'relationship_direction', 'incoming') AS event_obj
  FROM ((entity_relationships er_event_in
  JOIN entities e_event ON ((e_event.id = er_event_in.from_entity_id)))
  LEFT JOIN session_events se_in ON ((se_in.id = e_event.id)))
  WHERE ((er_event_in.to_entity_id = e.id) AND (e_event.type = 'event'::text) AND (er_event_in.is_bidirectional = false))) macro_events_inner
  GROUP BY macro_events_inner.macro_type) macro_events
  WHERE (macro_events.macro_type IS NOT NULL)) events ON (true));

VIEW: view_session_arcs
-----------------------------------------
 SELECT s.id,
  s.campaign_id,
  s.title,
  s.narrative,
  s.created_at,
  ((s.attributes ->> 'session_number'::text))::integer AS session_number,
  (s.attributes ->> 'session_date'::text) AS session_date,
  (s.attributes ->> 'background_image'::text) AS image,
  na.id AS arc_id,
  na.title AS arc_title,
  na.description AS arc_description,
  na."order" AS arc_order,
  na.attributes AS arc_attributes
  FROM ((sessions s
  LEFT JOIN entity_relationships er ON (((er.from_entity_id = s.id) AND (er.relationship_type = 'part_of'::text))))
  LEFT JOIN narrative_arcs na ON ((er.to_entity_id = na.id)));

VIEW: view_campaign_timeline
-----------------------------------------
 SELECT s.id AS session_id,
  s.campaign_id,
  s.title AS session_title,
  s.narrative AS session_narrative,
  s.created_at,
  ((s.attributes ->> 'session_number'::text))::integer AS session_number,
  (s.attributes ->> 'session_date'::text) AS session_date,
  s.attributes,
  COALESCE(events_data.event_list, '[]'::jsonb) AS events
  FROM (sessions s
  LEFT JOIN LATERAL ( SELECT jsonb_agg(jsonb_build_object('id', se.id, 'title', se.title, 'description', se.description, 'type', se.event_type, 'order', se.event_order, 'tags', COALESCE(tags_data.tag_list, '[]'::jsonb)) ORDER BY se.event_order) AS event_list
  FROM (session_events se
  LEFT JOIN LATERAL ( SELECT jsonb_agg(jsonb_build_object('name', e.name, 'type', e.type, 'entity_id', e.id)) AS tag_list
  FROM (entity_relationships er
  JOIN entities e ON ((er.to_entity_id = e.id)))
  WHERE (er.from_entity_id = se.id)) tags_data ON (true))
  WHERE (se.session_id = s.id)) events_data ON (true));

VIEW: view_recent_sessions
-----------------------------------------
 SELECT id,
  campaign_id,
  title,
  narrative AS description,
  created_at,
  attributes,
  ( SELECT count(*) AS count
  FROM session_events se
  WHERE (se.session_id = s.id)) AS event_count,
  COALESCE(( SELECT jsonb_agg(DISTINCT jsonb_build_object('id', e.id, 'name', e.name, 'type', e.type)) AS jsonb_agg
  FROM (entity_relationships er
  JOIN entities e ON ((er.to_entity_id = e.id)))
  WHERE ((er.from_entity_id = s.id) OR (er.from_entity_id IN ( SELECT session_events.id
  FROM session_events
  WHERE (session_events.session_id = s.id))))), '[]'::jsonb) AS mentions
  FROM sessions s;

VIEW: view_active_quests
-----------------------------------------
 SELECT id,
  campaign_id,
  title,
  attributes,
  updated_at,
  COALESCE(( SELECT jsonb_agg(qo.* ORDER BY qo.order_index) AS jsonb_agg
  FROM quest_objectives qo
  WHERE (qo.quest_id = q.id)), '[]'::jsonb) AS objectives
  FROM quests q
  WHERE (((attributes ->> 'status'::text) ~~* '%active%'::text) OR ((attributes ->> 'status'::text) = 'pending'::text) OR ((attributes ->> 'status'::text) IS NULL));

VIEW: view_dashboard_stats
-----------------------------------------
 WITH top_loc AS (
  SELECT l.campaign_id,
  l.name,
  count(er.id) AS visit_count
  FROM (locations l
  JOIN entity_relationships er ON ((l.id = er.to_entity_id)))
  GROUP BY l.campaign_id, l.name
  ORDER BY (count(er.id)) DESC
  ), top_npc_mentioned AS (
  SELECT n.campaign_id,
  n.name,
  count(er.id) AS mention_count
  FROM (npcs n
  JOIN entity_relationships er ON ((n.id = er.to_entity_id)))
  GROUP BY n.campaign_id, n.name
  ORDER BY (count(er.id)) DESC
  ), active_sess AS (
  SELECT s.campaign_id,
  s.id,
  s.title,
  count(se.id) AS event_count
  FROM (sessions s
  JOIN session_events se ON ((s.id = se.session_id)))
  GROUP BY s.campaign_id, s.id, s.title
  ORDER BY (count(se.id)) DESC
  )
  SELECT id AS campaign_id,
  ( SELECT count(*) AS count
  FROM sessions
  WHERE (sessions.campaign_id = c.id)) AS total_sessions,
  ( SELECT count(*) AS count
  FROM encounters
  WHERE (encounters.campaign_id = c.id)) AS total_encounters,
  ( SELECT count(*) AS count
  FROM npcs
  WHERE (npcs.campaign_id = c.id)) AS unique_npcs,
  ( SELECT count(*) AS count
  FROM locations
  WHERE (locations.campaign_id = c.id)) AS unique_locations,
  ( SELECT count(*) AS count
  FROM quests q
  WHERE ((q.campaign_id = c.id) AND (((q.attributes ->> 'status'::text) ~~* '%active%'::text) OR ((q.attributes ->> 'status'::text) = 'pending'::text) OR ((q.attributes ->> 'status'::text) IS NULL)))) AS active_quests,
  ( SELECT count(*) AS count
  FROM quests q
  WHERE ((q.campaign_id = c.id) AND (((q.attributes ->> 'status'::text) ~~* '%completed%'::text) OR ((q.attributes ->> 'status'::text) ~~* '%success%'::text)))) AS completed_quests,
  ( SELECT row_to_json(tl.*) AS row_to_json
  FROM ( SELECT top_loc.name,
  top_loc.visit_count AS visits
  FROM top_loc
  WHERE (top_loc.campaign_id = c.id)
  LIMIT 1) tl) AS top_location,
  ( SELECT row_to_json(tn.*) AS row_to_json
  FROM ( SELECT top_npc_mentioned.name,
  top_npc_mentioned.mention_count AS mentions
  FROM top_npc_mentioned
  WHERE (top_npc_mentioned.campaign_id = c.id)
  LIMIT 1) tn) AS top_npc,
  ( SELECT row_to_json(asess.*) AS row_to_json
  FROM ( SELECT active_sess.id,
  active_sess.title,
  active_sess.event_count
  FROM active_sess
  WHERE (active_sess.campaign_id = c.id)
  LIMIT 1) asess) AS most_active_session
  FROM campaigns c;

VIEW: view_entity_index
-----------------------------------------
 SELECT e.id,
  e.name,
  e.type,
  e.description,
  e.campaign_id,
  (attr.attributes ->> 'icon'::text) AS icon_url,
  (attr.attributes ->> 'status'::text) AS status,
  (attr.attributes ->> 'affinity'::text) AS affinity,
  (attr.attributes ->> 'background_image'::text) AS background_image
  FROM (entities e
  LEFT JOIN view_entity_attributes_source attr ON ((e.id = attr.id)))
  WHERE (e.type <> ALL (ARRAY['event'::text, 'session_event'::text]));

VIEW: view_narrative_arc_summary
-----------------------------------------
 SELECT arc.id,
  arc.campaign_id,
  arc.title,
  arc.description,
  arc."order",
  COALESCE((arc.attributes ->> 'type'::text), 'Primary'::text) AS arc_type,
  count(DISTINCT s.id) AS session_count,
  count(DISTINCT
  CASE
  WHEN (e_target.type = 'npc'::text) THEN e_target.id
  ELSE NULL::uuid
  END) AS npc_count,
  count(DISTINCT
  CASE
  WHEN (e_target.type = 'location'::text) THEN e_target.id
  ELSE NULL::uuid
  END) AS location_count,
  count(DISTINCT
  CASE
  WHEN (e_target.type = 'quest'::text) THEN e_target.id
  ELSE NULL::uuid
  END) AS quest_count,
  count(DISTINCT
  CASE
  WHEN (e_target.type = 'encounter'::text) THEN e_target.id
  ELSE NULL::uuid
  END) AS encounter_count
  FROM ((((narrative_arcs arc
  LEFT JOIN entity_relationships er_sess ON (((er_sess.to_entity_id = arc.id) AND (er_sess.relationship_type = 'part_of'::text))))
  LEFT JOIN sessions s ON ((er_sess.from_entity_id = s.id)))
  LEFT JOIN LATERAL ( SELECT entity_relationships.to_entity_id
  FROM entity_relationships
  WHERE (entity_relationships.from_entity_id = s.id)
  UNION ALL
  SELECT er.to_entity_id
  FROM (session_events se
  JOIN entity_relationships er ON ((er.from_entity_id = se.id)))
  WHERE (se.session_id = s.id)) all_mentions ON (true))
  LEFT JOIN entities e_target ON ((all_mentions.to_entity_id = e_target.id)))
  GROUP BY arc.id, arc.campaign_id, arc.title, arc.description, arc."order", arc.attributes;

=========================================
   FUNCTIONS
=========================================

FUNCTION: api_search_entities(p_campaign_id uuid, p_search_term text)
-----------------------------------------

BEGIN
  RETURN QUERY
  -- Search generic Entities
  SELECT e.id, e.name, e.type, e.description
  FROM entities e
  WHERE e.campaign_id = p_campaign_id
    AND (e.name ILIKE '%' || p_search_term || '%')
  
  UNION ALL
  
  -- Search Sessions (normalized)
  SELECT s.id, s.title as name, 'session' as type, s.narrative as description
  FROM sessions s
  WHERE s.campaign_id = p_campaign_id
    AND (s.title ILIKE '%' || p_search_term || '%')
  
  LIMIT 20;
END;


FUNCTION: sync_event_to_entity()
-----------------------------------------

BEGIN
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, type, name, campaign_id, description)
    VALUES (NEW.id, 'event', NEW.title, (SELECT campaign_id FROM sessions WHERE id = NEW.session_id), NEW.description);
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities
    SET name = NEW.title, description = NEW.description
    WHERE id = NEW.id;
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  RETURN NULL;
END;


FUNCTION: api_scan_campaign_text(p_campaign_id uuid, p_term text)
-----------------------------------------

DECLARE
  search_pattern TEXT := '%' || p_term || '%';
BEGIN
  RETURN QUERY
  
  -- 1. Entities (Name & Description)
  SELECT 'entities'::TEXT, e.id, 'name'::TEXT, (e.type || ': ' || e.name)::TEXT, e.name
  FROM entities e WHERE e.campaign_id = p_campaign_id AND e.name ILIKE search_pattern
  UNION ALL
  SELECT 'entities'::TEXT, e.id, 'description'::TEXT, (e.type || ': ' || e.name)::TEXT, e.description
  FROM entities e WHERE e.campaign_id = p_campaign_id AND e.description ILIKE search_pattern
  
  UNION ALL

  -- 2. Sessions (Title & Narrative)
  SELECT 'sessions'::TEXT, s.id, 'title'::TEXT, ('Session: ' || s.title)::TEXT, s.title
  FROM sessions s WHERE s.campaign_id = p_campaign_id AND s.title ILIKE search_pattern
  UNION ALL
  SELECT 'sessions'::TEXT, s.id, 'narrative'::TEXT, ('Session: ' || s.title)::TEXT, s.narrative
  FROM sessions s WHERE s.campaign_id = p_campaign_id AND s.narrative ILIKE search_pattern

  UNION ALL

  -- 3. Session Events (Title & Description)
  SELECT 'session_events'::TEXT, se.id, 'title'::TEXT, ('Event in: ' || s.title)::TEXT, se.title
  FROM session_events se
  JOIN sessions s ON se.session_id = s.id
  WHERE s.campaign_id = p_campaign_id AND se.title ILIKE search_pattern
  UNION ALL
  SELECT 'session_events'::TEXT, se.id, 'description'::TEXT, ('Event in: ' || s.title)::TEXT, se.description
  FROM session_events se
  JOIN sessions s ON se.session_id = s.id
  WHERE s.campaign_id = p_campaign_id AND se.description ILIKE search_pattern

  UNION ALL

  -- 4. Quest Objectives
  SELECT 'quest_objectives'::TEXT, qo.id, 'description'::TEXT, ('Objective in: ' || e.name)::TEXT, qo.description
  FROM quest_objectives qo
  JOIN entities e ON qo.quest_id = e.id
  WHERE e.campaign_id = p_campaign_id AND qo.description ILIKE search_pattern;

END;


FUNCTION: create_reverse_relationship()
-----------------------------------------

BEGIN
  -- Only proceed if is_bidirectional is true
  IF NEW.is_bidirectional = true THEN
    -- Check if reverse relationship already exists to avoid infinite loop
    IF NOT EXISTS (
      SELECT 1 FROM entity_relationships
      WHERE from_entity_id = NEW.to_entity_id
        AND to_entity_id = NEW.from_entity_id
        AND relationship_type = NEW.relationship_type
    ) THEN
      -- Insert the reverse relationship
      INSERT INTO entity_relationships (
        from_entity_id,
        to_entity_id,
        relationship_type,
        description,
        is_bidirectional,
        is_hidden
      ) VALUES (
        NEW.to_entity_id,           -- Swap: to becomes from
        NEW.from_entity_id,          -- Swap: from becomes to
        NEW.relationship_type,
        NEW.description,
        NEW.is_bidirectional,
        NEW.is_hidden
      );
    END IF;
  END IF;
  
  RETURN NEW;
END;


FUNCTION: sync_to_entities()
-----------------------------------------
DECLARE
  entity_type text := TG_ARGV[0];
  entity_name text;
  entity_desc text;
BEGIN
  -- 1. Determine Name and Description based on table type
  IF entity_type = 'quest' OR entity_type = 'narrative_arc' THEN
    entity_name := NEW.title;         
    entity_desc := NEW.description;
  ELSIF entity_type = 'character' THEN
    entity_name := NEW.name;
    entity_desc := NEW.description;
  ELSIF entity_type = 'session' THEN
    entity_name := NEW.title;
    entity_desc := null;
  ELSE
    entity_name := NEW.name;          -- NPCs, Factions, Locations use 'name'
    entity_desc := NEW.description;  
  END IF;

  -- 2. Perform the Sync
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, campaign_id, type, name, description)
    VALUES (NEW.id, NEW.campaign_id, entity_type, entity_name, entity_desc)
    ON CONFLICT (id) DO UPDATE 
    SET 
      name = EXCLUDED.name,
      description = EXCLUDED.description;
      
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities 
    SET 
      name = entity_name,
      description = entity_desc
    WHERE id = NEW.id;
    
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  
  RETURN NULL;
END;

FUNCTION: update_updated_at()
-----------------------------------------

BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;


=========================================
   TRIGGERS
=========================================

TRIGGER: characters_updated_at ON characters
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_characters_to_entities ON characters
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('character')

TRIGGER: tr_sync_characters_to_entities ON characters
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('character')

TRIGGER: tr_sync_characters_to_entities ON characters
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('character')

TRIGGER: encounters_updated_at ON encounters
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_factions_to_entities ON encounters
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('encounter')

TRIGGER: tr_sync_factions_to_entities ON encounters
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('encounter')

TRIGGER: tr_sync_factions_to_entities ON encounters
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('encounter')

TRIGGER: create_bidirectional_relationship ON entity_relationships
AFTER INSERT
EXECUTE: EXECUTE FUNCTION create_reverse_relationship()

TRIGGER: factions_updated_at ON factions
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_factions_to_entities ON factions
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('faction')

TRIGGER: tr_sync_factions_to_entities ON factions
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('faction')

TRIGGER: tr_sync_factions_to_entities ON factions
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('faction')

TRIGGER: sync_to_entities ON items
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('item')

TRIGGER: sync_to_entities ON items
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('item')

TRIGGER: sync_to_entities ON items
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('item')

TRIGGER: locations_updated_at ON locations
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_locations_to_entities ON locations
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('location')

TRIGGER: tr_sync_locations_to_entities ON locations
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('location')

TRIGGER: tr_sync_locations_to_entities ON locations
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('location')

TRIGGER: sync_to_entities ON narrative_arcs
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('narrative_arc')

TRIGGER: sync_to_entities ON narrative_arcs
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('narrative_arc')

TRIGGER: sync_to_entities ON narrative_arcs
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('narrative_arc')

TRIGGER: npcs_updated_at ON npcs
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_npcs_to_entities ON npcs
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('npc')

TRIGGER: tr_sync_npcs_to_entities ON npcs
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('npc')

TRIGGER: tr_sync_npcs_to_entities ON npcs
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('npc')

TRIGGER: quest_objectives_updated_at ON quest_objectives
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: quests_updated_at ON quests
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: tr_sync_quests_to_entities ON quests
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('quest')

TRIGGER: tr_sync_quests_to_entities ON quests
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('quest')

TRIGGER: tr_sync_quests_to_entities ON quests
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('quest')

TRIGGER: trigger_sync_event_entity ON session_events
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_event_to_entity()

TRIGGER: trigger_sync_event_entity ON session_events
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_event_to_entity()

TRIGGER: trigger_sync_event_entity ON session_events
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_event_to_entity()

TRIGGER: sessions_updated_at ON sessions
BEFORE UPDATE
EXECUTE: EXECUTE FUNCTION update_updated_at()

TRIGGER: sync_to_entities ON sessions
AFTER DELETE
EXECUTE: EXECUTE FUNCTION sync_to_entities('session')

TRIGGER: sync_to_entities ON sessions
AFTER INSERT
EXECUTE: EXECUTE FUNCTION sync_to_entities('session')

TRIGGER: sync_to_entities ON sessions
AFTER UPDATE
EXECUTE: EXECUTE FUNCTION sync_to_entities('session')

