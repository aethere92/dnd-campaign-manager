--- sync_to_entities ---
DECLARE
  entity_type text := TG_ARGV[0];
  entity_name text;
  entity_desc text;
BEGIN
  -- 1. Determine Name and Description based on table type
  IF entity_type = 'quest' THEN
    entity_name := NEW.title;         
    entity_desc := NEW.description;
  ELSIF entity_type = 'character' THEN
    entity_name := NEW.name;
    entity_desc := NEW.background;
  ELSIF entity_type = 'session' THEN
    entity_name := NEW.title;
    entity_desc := null;
  ELSE
    entity_name := NEW.name;          -- NPCs, Factions, Locations use 'name'
    entity_desc := NEW.description;  
  END IF;

  -- 2. Perform the Sync
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, campaign_id, type, name, description)
    VALUES (NEW.id, NEW.campaign_id, entity_type, entity_name, entity_desc)
    ON CONFLICT (id) DO UPDATE 
    SET 
      name = EXCLUDED.name,
      description = EXCLUDED.description;
      
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities 
    SET 
      name = entity_name,
      description = entity_desc
    WHERE id = NEW.id;
    
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  
  RETURN NULL;
END;

--- sync_event_to_entity ---

BEGIN
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, type, name, campaign_id, description)
    VALUES (NEW.id, 'event', NEW.title, (SELECT campaign_id FROM sessions WHERE id = NEW.session_id), NEW.description);
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities
    SET name = NEW.title, description = NEW.description
    WHERE id = NEW.id;
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  RETURN NULL;
END;

--- Entity Complete View --- 

CREATE OR REPLACE VIEW entity_complete_view AS
SELECT 
  -- Core entity info
  e.id,
  e.type,
  e.name,
  e.description,
  e.campaign_id,
  e.created_at,
  
  -- Aggregate attributes (ONLY regular attributes now)
  COALESCE(attr.attributes, '{}'::jsonb) AS attributes,
  
  -- All relationships (both outgoing and incoming)
  COALESCE(rels.relationships, '[]'::jsonb) AS relationships,
  
  -- Session events grouped by macro event type
  COALESCE(events.events, '{}'::jsonb) AS events

FROM entities e

-- Regular attributes aggregated by name
LEFT JOIN LATERAL (
  SELECT 
    COALESCE(
      jsonb_object_agg(
        attr_grouped.name,
        attr_grouped.values
      ),
      '{}'::jsonb
    ) AS attributes
  FROM (
    SELECT 
      a.name,
      jsonb_agg(
        jsonb_build_object(
          'id', a.id,
          'value', a.value,
          'type', a.type,
          'is_private', a.is_private,
          'description', a.description,
          'order', a.default_order
        )
        ORDER BY a.default_order, a.id
      ) AS values
    FROM attributes a
    WHERE a.entity_id = e.id
    GROUP BY a.name
  ) AS attr_grouped
  WHERE attr_grouped.name IS NOT NULL
) AS attr ON true

-- Relationships (both outgoing and incoming) - PRE-AGGREGATED
LEFT JOIN LATERAL (
  SELECT 
    COALESCE(
      jsonb_agg(rel_combined.rel_obj),
      '[]'::jsonb
    ) AS relationships
  FROM (
    -- Outgoing relationships
    SELECT 
      jsonb_build_object(
        'relationship_id', er_out.id,
        'direction', 'outgoing',
        'type', er_out.relationship_type,
        'entity_id', er_out.to_entity_id,
        'entity_name', e_to.name,
        'entity_type', e_to.type,
        'description', er_out.description,
        'strength', er_out.strength,
        'is_bidirectional', er_out.is_bidirectional,
        'metadata', er_out.metadata,
        'icon', er_out.target_entity_icon
        'is_hidden', er_out.is_hidden
      ) AS rel_obj
    FROM entity_relationships er_out
    JOIN entities e_to ON e_to.id = er_out.to_entity_id
    WHERE er_out.from_entity_id = e.id
    
    UNION ALL
    
    -- Incoming relationships
    SELECT 
      jsonb_build_object(
        'relationship_id', er_in.id,
        'direction', 'incoming',
        'type', er_in.relationship_type,
        'entity_id', er_in.from_entity_id,
        'entity_name', e_from.name,
        'entity_type', e_from.type,
        'description', er_in.description,
        'strength', er_in.strength,
        'is_bidirectional', er_in.is_bidirectional,
        'metadata', er_in.metadata,
        'icon', er_in.source_entity_icon,
        'is_hidden', er_in.is_hidden
      ) AS rel_obj
    FROM entity_relationships er_in
    JOIN entities e_from ON e_from.id = er_in.from_entity_id
    WHERE er_in.to_entity_id = e.id
  ) AS rel_combined
) AS rels ON true

-- Session events grouped by macro type (based on event_type prefix)
LEFT JOIN LATERAL (
  SELECT 
    COALESCE(
      jsonb_object_agg(
        macro_events.macro_type,
        macro_events.events_array
      ),
      '{}'::jsonb
    ) AS events
  FROM (
    SELECT 
      macro_events_inner.macro_type,
      jsonb_agg(
        macro_events_inner.event_obj
        ORDER BY macro_events_inner.event_order, macro_events_inner.id
      ) AS events_array
    FROM (
      SELECT 
        -- Extract macro type from event_type prefix (before first underscore)
        CASE 
          WHEN se.event_type LIKE 'npc_%' THEN 'npc'
          WHEN se.event_type LIKE 'location_%' THEN 'location'
          WHEN se.event_type LIKE 'quest_%' THEN 'quest'
          WHEN se.event_type LIKE 'encounter_%' THEN 'encounter'
          WHEN se.event_type LIKE 'faction_%' THEN 'faction'
          WHEN se.event_type LIKE 'session_%' THEN 'session'
          WHEN se.event_type LIKE 'character_%' THEN 'character'
          ELSE split_part(se.event_type, '_', 1)
        END AS macro_type,
        se.id,
        se.event_order,
        jsonb_build_object(
          'id', se.id,
          'event_type', se.event_type,
          'title', se.title,
          'description', se.description,
          'order', se.event_order,
          'session_id', se.session_id,
          'created_at', se.created_at
        ) AS event_obj
      FROM session_events se
      WHERE se.npc_id = e.id
         OR se.location_id = e.id
         OR se.quest_id = e.id
         OR se.encounter_id = e.id
         OR se.faction_id = e.id
         OR se.session_id = e.id
         OR se.character_id = e.id
    ) AS macro_events_inner
    GROUP BY macro_events_inner.macro_type
  ) AS macro_events
  WHERE macro_events.macro_type IS NOT NULL
) AS events ON true;