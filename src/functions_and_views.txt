--- sync_to_entities ---
DECLARE
  entity_type text := TG_ARGV[0];
  entity_name text;
  entity_desc text;
BEGIN
  -- 1. Determine Name and Description based on table type
  IF entity_type = 'quest' THEN
    entity_name := NEW.title;         
    entity_desc := NEW.description;
  ELSIF entity_type = 'character' THEN
    entity_name := NEW.name;
    entity_desc := NEW.background;
  ELSIF entity_type = 'session' THEN
    entity_name := NEW.title;
    entity_desc := null;
  ELSE
    entity_name := NEW.name;          -- NPCs, Factions, Locations use 'name'
    entity_desc := NEW.description;  
  END IF;

  -- 2. Perform the Sync
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, campaign_id, type, name, description)
    VALUES (NEW.id, NEW.campaign_id, entity_type, entity_name, entity_desc)
    ON CONFLICT (id) DO UPDATE 
    SET 
      name = EXCLUDED.name,
      description = EXCLUDED.description;
      
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities 
    SET 
      name = entity_name,
      description = entity_desc
    WHERE id = NEW.id;
    
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  
  RETURN NULL;
END;

--- sync_event_to_entity ---

BEGIN
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO public.entities (id, type, name, campaign_id, description)
    VALUES (NEW.id, 'event', NEW.title, (SELECT campaign_id FROM sessions WHERE id = NEW.session_id), NEW.description);
  ELSIF (TG_OP = 'UPDATE') THEN
    UPDATE public.entities
    SET name = NEW.title, description = NEW.description
    WHERE id = NEW.id;
  ELSIF (TG_OP = 'DELETE') THEN
    DELETE FROM public.entities WHERE id = OLD.id;
  END IF;
  RETURN NULL;
END;

--- Entity Complete View --- 

create view public.entity_complete_view as
select
  e.id,
  e.type,
  e.name,
  e.description,
  e.campaign_id,
  e.created_at,
  COALESCE(attr.attributes, '{}'::jsonb) as attributes,
  COALESCE(rels.relationships, '[]'::jsonb) as relationships,
  COALESCE(events.events, '{}'::jsonb) as events
from
  entities e
  left join lateral (
    select
      COALESCE(
        jsonb_object_agg(attr_grouped.name, attr_grouped."values"),
        '{}'::jsonb
      ) as attributes
    from
      (
        select
          a.name,
          jsonb_agg(
            jsonb_build_object(
              'id',
              a.id,
              'value',
              a.value,
              'is_private',
              a.is_private
            )
            order by
              a.id
          ) as "values"
        from
          attributes a
        where
          a.entity_id = e.id
        group by
          a.name
      ) attr_grouped
    where
      attr_grouped.name is not null
  ) attr on true
  left join lateral (
    select
      COALESCE(jsonb_agg(rel_combined.rel_obj), '[]'::jsonb) as relationships
    from
      (
        select
          jsonb_build_object(
            'relationship_id',
            er_out.id,
            'direction',
            'outgoing',
            'type',
            er_out.relationship_type,
            'entity_id',
            er_out.to_entity_id,
            'entity_name',
            e_to.name,
            'entity_type',
            e_to.type,
            'description',
            er_out.description,
            'is_bidirectional',
            false
          ) as rel_obj
        from
          entity_relationships er_out
          join entities e_to on e_to.id = er_out.to_entity_id
        where
          er_out.from_entity_id = e.id
          and er_out.is_bidirectional = false
          and e_to.type <> 'event'::text
        union all
        select
          jsonb_build_object(
            'relationship_id',
            er_out.id,
            'direction',
            'bidirectional',
            'type',
            er_out.relationship_type,
            'entity_id',
            er_out.to_entity_id,
            'entity_name',
            e_to.name,
            'entity_type',
            e_to.type,
            'description',
            er_out.description,
            'is_bidirectional',
            true
          ) as rel_obj
        from
          entity_relationships er_out
          join entities e_to on e_to.id = er_out.to_entity_id
        where
          er_out.from_entity_id = e.id
          and er_out.is_bidirectional = true
          and e_to.type <> 'event'::text
        union all
        select
          jsonb_build_object(
            'relationship_id',
            er_in.id,
            'direction',
            'incoming',
            'type',
            er_in.relationship_type,
            'entity_id',
            er_in.from_entity_id,
            'entity_name',
            e_from.name,
            'entity_type',
            e_from.type,
            'description',
            er_in.description,
            'is_bidirectional',
            false
          ) as rel_obj
        from
          entity_relationships er_in
          join entities e_from on e_from.id = er_in.from_entity_id
        where
          er_in.to_entity_id = e.id
          and er_in.is_bidirectional = false
          and e_from.type <> 'event'::text
      ) rel_combined
  ) rels on true
  left join lateral (
    select
      COALESCE(
        jsonb_object_agg(
          macro_events.macro_type,
          macro_events.events_array
        ),
        '{}'::jsonb
      ) as events
    from
      (
        select
          macro_events_inner.macro_type,
          jsonb_agg(
            macro_events_inner.event_obj
            order by
              macro_events_inner.event_order,
              macro_events_inner.id
          ) as events_array
        from
          (
            select
              'event'::text as macro_type,
              e_event.id,
              se_out.event_order,
              jsonb_build_object(
                'id',
                e_event.id,
                'event_type',
                COALESCE(
                  se_out.event_type,
                  'relationship_'::text || er_event.relationship_type
                ),
                'title',
                e_event.name,
                'description',
                e_event.description,
                'order',
                se_out.event_order,
                'session_id',
                se_out.session_id,
                'created_at',
                e_event.created_at,
                'relationship_id',
                er_event.id,
                'relationship_type',
                er_event.relationship_type,
                'relationship_direction',
                'outgoing'
              ) as event_obj
            from
              entity_relationships er_event
              join entities e_event on e_event.id = er_event.to_entity_id
              left join session_events se_out on se_out.id = e_event.id
            where
              er_event.from_entity_id = e.id
              and e_event.type = 'event'::text
            union all
            select
              'event'::text as macro_type,
              e_event.id,
              se_in.event_order,
              jsonb_build_object(
                'id',
                e_event.id,
                'event_type',
                COALESCE(
                  se_in.event_type,
                  'relationship_'::text || er_event_in.relationship_type
                ),
                'title',
                e_event.name,
                'description',
                e_event.description,
                'order',
                se_in.event_order,
                'session_id',
                se_in.session_id,
                'created_at',
                e_event.created_at,
                'relationship_id',
                er_event_in.id,
                'relationship_type',
                er_event_in.relationship_type,
                'relationship_direction',
                'incoming'
              ) as event_obj
            from
              entity_relationships er_event_in
              join entities e_event on e_event.id = er_event_in.from_entity_id
              left join session_events se_in on se_in.id = e_event.id
            where
              er_event_in.to_entity_id = e.id
              and e_event.type = 'event'::text
              and er_event_in.is_bidirectional = false
          ) macro_events_inner
        group by
          macro_events_inner.macro_type
      ) macro_events
    where
      macro_events.macro_type is not null
  ) events on true;